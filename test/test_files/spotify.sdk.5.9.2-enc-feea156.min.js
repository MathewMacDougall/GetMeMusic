/** Copyright Spotify AB 2012-2015. All rights reserved. sdk(v5.9.2-enc-feea156), corejs(v2.10.2-enc), contextplayer(v2.4.2), bridge(v4.4.4), cosmos(v0.7.2) **/
var Spotify=Spotify||{};Spotify.Cache=Spotify.Cache||{},Spotify.Logging=Spotify.Logging||{},Spotify.App=Spotify.App||{},Spotify.Utils=Spotify.Utils||{},Spotify.Flash=Spotify.Flash||{},Spotify.Services=Spotify.Services||{},Spotify.Services.CurrentFavoritesImplementation=Spotify.Services.CurrentFavoritesImplementation||{},Spotify.WebSockets=Spotify.WebSockets||{},Spotify.Protobuf=Spotify.Protobuf||{},Spotify.Hermes=Spotify.Hermes||{},Spotify.Parsers=Spotify.Parsers||{},Spotify.Models=Spotify.Models||{},Spotify.HTML5=Spotify.HTML5||{},Spotify.Audio=Spotify.Audio||{},Spotify.Proto=Spotify.Proto||{},Spotify.Errors=Spotify.Errors||{},Spotify.Errors.Domains=Spotify.Errors.Domains||{},Spotify.Errors.Codes=Spotify.Errors.Codes||{},Spotify.Calls=Spotify.Calls||{},Spotify.Managers=Spotify.Managers||{},DebuggerJS=Spotify.DebuggerJS=new function(){this.Parsers={},this.Loggers={},this.Parsers={},this.Utils={isArray:Array.isArray||function(object){return"[object Array]"==Object.prototype.toString.call(object)}};var LOG="log",WARN="warn",ERROR="error",_isOn=!1,_filters={},_loggers={},_parsers={},_checkFilters=function(module,tag){var tagIsAllowed=!1,moduleIsAllowed=!1;return tagIsAllowed=0===_filters.tags.length?!0:_filters.tags.indexOf(tag)>=0,moduleIsAllowed=0===_filters.modules.length?!0:_filters.modules.indexOf(module)>=0,tagIsAllowed&&moduleIsAllowed},_log=function(type,module,message,tag){if(_isOn){var parsedMessage;if(!DebuggerJS.Utils.isArray(message))throw new Error("The message argument should be an array");module="string"==typeof module?module:"",tag="string"==typeof tag?tag:"";var shouldILog=_checkFilters(module,tag);if(!shouldILog)return!1;for(var identifier in _loggers)parsedMessage=_parsers[identifier].parse(module,message,tag),type===LOG?_loggers[identifier].log.apply(this,parsedMessage):type===WARN?_loggers[identifier].warn.apply(this,parsedMessage):type===ERROR&&_loggers[identifier].error.apply(this,parsedMessage);return!0}return!1};this.register=function(identifier,logger,parser){if("string"!=typeof identifier||"undefined"==typeof logger||null===logger)throw new Error("Not valid arguments");return _loggers[identifier]||(_loggers[identifier]=logger),_parsers[identifier]||(_parsers[identifier]=parser||new DebuggerJS.Parsers.Console),!0},this.log=function(module,message,tag){return _log(LOG,module,message,tag)},this.warn=function(module,message,tag){return _log(WARN,module,message,tag)},this.error=function(module,message,tag){return _log(ERROR,module,message,tag)},this.on=function(modules,tags){if("undefined"!=typeof modules&&!DebuggerJS.Utils.isArray(modules)&&null!==modules)throw new Error("The modules argument should be an array");if("undefined"!=typeof tags&&!DebuggerJS.Utils.isArray(tags)&&null!==tags)throw new Error("The tags argument should be an array");_isOn=!0,_filters={modules:modules||[],tags:tags||[]}},this.off=function(){_isOn=!1,_filters={}}},DebuggerJS.Parsers.Default=function(){this.parse=function(module,message,tag){return module+=" |",[module].concat(message).concat("| Tag: "+tag)}},DebuggerJS.Loggers.Console=function(){this.log=function(){return console.log.apply(console,arguments),!0},this.error=function(){return console.error.apply(console,arguments),!0},this.warn=function(){return console.warn.apply(console,arguments),!0}},DebuggerJS.Loggers.Memory=function(){this.log=function(){return!0},this.error=function(){return!0},this.warn=function(){return!0}},Spotify.Storage={localStorage:null,indexedDB:{storage:null,IDBKeyRange:null,IDBTransaction:null}},function(){var slice=[].slice;"bind"in Function.prototype||(Function.prototype.bind=function(thisVal){var fn=this,args=null;return arguments.length>1&&(args=slice.call(arguments,1)),function(){var result;return arguments.length||args?fn.apply(thisVal,args?arguments.length?args.concat(slice.call(arguments)):args:arguments):result=fn.call(thisVal),result}}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(){for(var length=this.length>>>0,i=from<0?Math.max(0,length+from):from||0;length>i;i++)if(this[i]===item)return i;return-1});var parser;Object.prototype.toString;Spotify.Utils={isArray:Array.isArray||function(object){return"[object Array]"==Object.prototype.toString.call(object)},inherit:function(parent,child){function tempCtor(){}return tempCtor.prototype=new parent,child.prototype=new tempCtor,child.prototype.constructor=child,child},isFunction:function(obj){return"function"==typeof obj},toFixed:function(value,precision){var precision=precision||0,neg=0>value,power=Math.pow(10,precision),value=Math.round(value*power),integral=String((neg?Math.ceil:Math.floor)(value/power)),fraction=String((neg?-value:value)%power),padding=new Array(Math.max(precision-fraction.length,0)+1).join("0");return precision?integral+"."+padding+fraction:integral},convertStringToXML:function(text){if(window.DOMParser)return parser=new DOMParser,parser.parseFromString(text.replace(/\n/g,""),"text/xml");var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");return xmlDoc.async=!1,xmlDoc.loadXML(text.replace(/\n/g,""))},convertXMLToJSON:function(xml){var obj={},hasAttr=1==xml.nodeType&&xml.attributes.length>0,hasChildren=xml.hasChildNodes();if(!hasAttr&&!hasChildren)return xml.data||"";if(hasAttr){obj["@attributes"]={};for(var j=0;j<xml.attributes.length;j++){var attribute=xml.attributes.item(j);obj["@attributes"][attribute.nodeName]=attribute.value}}if(hasChildren){if(1==xml.childNodes.length&&"#text"==xml.childNodes[0].nodeName)return xml.childNodes[0].data;for(var i=0;i<xml.childNodes.length;i++){var item=xml.childNodes[i],nodeName=item.nodeName,convertedItem=this.convertXMLToJSON(item);if("#text"!=nodeName)if("undefined"==typeof obj[nodeName])obj[nodeName]=convertedItem;else{if(!this.isArray(obj[nodeName])){var old=obj[nodeName];obj[nodeName]=new Array(old)}obj[nodeName].push(convertedItem)}}}return obj},hex2str:function(hex){for(var str=[],i=0,len=hex.length;len-1>i;i+=2)str.push(String.fromCharCode(parseInt(hex.substr(i,2),16)));return str.join("")},str2hex:function(str){if(!str)return"";for(var hex="",i=0,len=str.length;len>i;++i)hex+=(str.charCodeAt(i)+256).toString(16).slice(-2);return hex},base62hex:function(str){str.length<151&&(str="0"+str),Spotify.Utils.cb(Spotify.Utils.Base62.toHex(str))},parseURL:function(str){for(var o={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:new RegExp("^(?:([^:/?#]+):)?(?://((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\\d*))?))?((((?:[^?#/]*/)*)([^?#]*))(?:\\?([^#]*))?(?:#(.*))?)"),loose:new RegExp("^(?:(?![^:@]+:[^:@/]*@)([^:/?#.]+):)?(?://)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:/?#]*)(?::(\\d*))?)(((/(?:[^?#](?![^?#/]*\\.[^?#/.]+(?:[?#]|$)))*/?)?([^?#/]*))(?:\\?([^#]*))?(?:#(.*))?)")}},m=o.parser[o.strictMode?"strict":"loose"].exec(str),uri={},i=14;i--;)uri[o.key[i]]=m[i]||"";return uri[o.q.name]={},uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){$1&&(uri[o.q.name][$1]=$2)}),uri},formatPlaylistRevision:function(revision){var revisionSequenceNumber=parseInt(revision.substr(0,8),16),revisionHash=revision.substr(8);return revisionSequenceNumber+","+revisionHash}}}(),Spotify.Utils.Base62=function(){function mul(lhs,rhs,base){for(var rest=0,i=0;i<lhs.length;++i){var tmp=lhs[i]*rhs+rest;rest=~~(tmp/base),lhs[i]=tmp-rest*base}for(;rest;){var tmp=~~(rest/base);lhs.push(rest-tmp*base),rest=tmp}}function madd(acc,lhs,rhs,base){for(var rest=0,i=0;i<lhs.length;++i){var tmp=~~acc[i]+lhs[i]*rhs+rest;rest=~~(tmp/base),acc[i]=tmp-rest*base}for(;rest;){var tmp=~~acc[i]+rest;rest=~~(tmp/base),acc[i]=tmp-rest*base,++i}}function convert(data,fromBase,toBase){for(var r=[0],b=[1],i=0;i<data.length;++i)madd(r,b,data[i],toBase),mul(b,fromBase,toBase);return r}function mapr(data,mapping){for(var i=0,r=[];i<data.length;++i)r.push(mapping[data[i]]);return r.reverse()}function pad(data,length){for(;data.length<length;)data.push(0);return data}for(var digits="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",invHexDigits={},invDigits={},i=0;i<digits.length;++i)invDigits[digits[i]]=i;for(var i=0;16>i;++i)invHexDigits["0123456789abcdef"[i]]=i;for(var i=0;16>i;++i)invHexDigits["0123456789ABCDEF"[i]]=i;var exports={fromBytes:function(data,length){var r=convert(data.slice(0).reverse(),256,62);return mapr(pad(r,length),digits).join("")},toBytes:function(str,length){var r=convert(mapr(str,invDigits),62,256);return pad(r,length).reverse()},toHex:function(str,length){var r=convert(mapr(str,invDigits),62,16);return mapr(pad(r,length),digits).join("")},fromHex:function(str,length){var r=convert(mapr(str,invHexDigits),16,62);return mapr(pad(r,length),digits).join("")}};return exports}(),Spotify.Utils.Base64=function(){if("undefined"!=typeof window&&window.btoa&&window.atob)return{encode:window.btoa.bind(window),decode:window.atob.bind(window)};for(var BASE64_DIGITS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",STRING_CHUNK_SIZE=4096,inverseDigits=[],i=0;256>i;++i)inverseDigits[i]=255;for(var i=0;i<BASE64_DIGITS.length;++i)inverseDigits[BASE64_DIGITS.charCodeAt(i)]=i;var inverseData=String.fromCharCode.apply(String,inverseDigits),_stringFromCharCode=function(data){if(data.length<STRING_CHUNK_SIZE)return String.fromCharCode.apply(String,data);var ptr=0,result=[];do result.push(String.fromCharCode.apply(String,data.slice(ptr,ptr+STRING_CHUNK_SIZE))),ptr+=STRING_CHUNK_SIZE;while(ptr<data.length);return result.join("")},exports={encode:function(str){var out,i,len,c1,c2,c3;for(len=str.length,i=0,out="";len>i;){if(c1=255&str.charCodeAt(i++),i==len){out+=BASE64_DIGITS.charAt(c1>>2),out+=BASE64_DIGITS.charAt((3&c1)<<4),out+="==";break}if(c2=str.charCodeAt(i++),i==len){out+=BASE64_DIGITS.charAt(c1>>2),out+=BASE64_DIGITS.charAt((3&c1)<<4|(240&c2)>>4),out+=BASE64_DIGITS.charAt((15&c2)<<2),out+="=";break}c3=str.charCodeAt(i++),out+=BASE64_DIGITS.charAt(c1>>2),out+=BASE64_DIGITS.charAt((3&c1)<<4|(240&c2)>>4),out+=BASE64_DIGITS.charAt((15&c2)<<2|(192&c3)>>6),out+=BASE64_DIGITS.charAt(63&c3)}return out},decode:function(str){for(var tmp0,tmp1,ret=[],len=str.length,j=0;;){do tmp0=inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp0&&len>j);do tmp1=inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp1&&len>j);if(255===tmp1)break;ret.push(255&(tmp0<<2|tmp1>>4));do tmp0=inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp0&&len>j);if(255===tmp0)break;ret.push(255&(tmp1<<4|tmp0>>2));do tmp1=inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp1&&len>j);if(255===tmp1)break;ret.push(255&(tmp0<<6|tmp1))}return _stringFromCharCode(ret)}};return exports}(),Spotify.Calls.Hermes=function(args,success,error){this.calleeId="",this.success=success||function(){},this.error=error||function(){},this.type=args.type||"",this.persistent="undefined"==typeof args.persistent?!0:args.persistent,this.bypassCache="undefined"==typeof args.bypassCache?!1:args.bypassCache,this.context=args.context||null,this.isMultiGet="undefined"==typeof args.isMultiGet?!1:args.isMultiGet,this.header={uri:"",method:"",source:"",content_type:this.isMultiGet?"vnd.spotify/mercury-mget-request":""},this.payload=[],this.payloadSchemas=[],this.responseSchemas=[],this.mercuryMultiGetPayloadSchemas=["mercury#MercuryMultiGetRequest"],this.mercuryMultiGetResponseSchemas=["mercury#MercuryMultiGetReply"],args.header&&(this.header.uri=args.header.uri||"",this.header.method=args.header.method||"",this.header.source=args.header.source||""),this.payload=args.payload||[],this.payloadSchemas=args.payloadSchemas||[],this.responseSchemas=args.responseSchemas||[]},Spotify.Calls.Simple=function(args,success,error){this.calleeId="",this.success=success||function(){},this.error=error||function(){},this.type=args.type||"",this.payload=args.payload||[],this.persistent=args.persistent||!0,this.bypassCache=args.bypassCache||!1,this.method=args.method||"",this.context=args.context||null,this.retries=args.retries||2},Spotify.Errors.Domains.HERMES_ERROR=13,Spotify.Errors.Domains.HERMES_SERVICE_ERROR=14,Spotify.Errors.Codes.HM_TOO_MANY_REQUESTS=429,Spotify.Errors.Codes.HM_TIMEOUT=408,Spotify.Errors.Codes.HM_FAILED_TO_SEND_TO_BACKEND=1,Spotify.Errors.Domains.TRACK_ERROR=12,Spotify.Errors.Codes.TRACK_REQUEST_RATE_LIMITED=8,Spotify.Errors.Codes.TRACK_CAP=11,Spotify.Errors.Codes.TIME_CAP=12,Spotify.Errors.Codes.ADS_ERROR=15,Spotify.Errors.Codes.ADS_SERVER_ERROR=500,Spotify.Errors.Codes.ADS_NOT_FOUND=404,Spotify.Errors.Codes.MALFORMED_RESPONSE=520,Spotify.Errors.Error=function(response){response=response||[],this.domain=response[0]||0,this.code=response[1]||0,this.description=response[2]||"",this.data=response[3]||null},Spotify.RateLimiter=function(wait,totalCallsPerInterval){Spotify.EventTarget.call(this);var _self=this,_isStarted=!1,_bucket=[],_events=new Spotify.Events,_intervalId=0;this.totalPendingRequests=function(){return _bucket.length},this.getItemAtIndex=function(index){return _bucket[index]},this.addToBucket=function(item,append){"undefined"==typeof append&&(append=!0),"undefined"!=typeof item&&(append?_bucket.push(item):_bucket[0]=item)},this.isStarted=function(){return _isStarted},this.start=function(){_isStarted||(_isStarted=!0,clearInterval(_intervalId),_intervalId=setInterval(_onInterval,wait))};var _onInterval=function(){var item,i=0,totalCalls=totalCallsPerInterval;for(totalCallsPerInterval>_bucket.length&&(totalCalls=_bucket.length);totalCalls>i;i++)item=_bucket.shift(),_self.trigger(_events.RATE_LIMIT_CALL,item);_self.trigger(_events.RATE_LIMIT_AFTER_INTERVAL),0===_bucket.length&&(_isStarted=!1,clearInterval(_intervalId),_self.trigger(_events.RATE_LIMIT_DISABLED))}},Spotify.CallsManager=function(){var _requestId=0,_callbacks={},_persistentCalls=[0];this.addCall=function(method,params,callback,errback,context,persistent,retries,callType){var now=(new Date).getTime();return retries="undefined"==typeof retries?2:retries,_requestId++,_callbacks[_requestId]={method:method,params:params,callback:callback,errback:errback,context:context,persistent:persistent,retries:retries,timestamp:now,callType:callType},_requestId},this.getCall=function(requestId,removeFromBucket){if("undefined"==typeof removeFromBucket&&(removeFromBucket=!0),void 0!==typeof _callbacks[requestId]){var callback=_callbacks[requestId];return removeFromBucket&&delete _callbacks[requestId],callback}},this.getCalls=function(){var requestId,key,call,calls=[];for(key in _callbacks)requestId=key,call=this.getCall(requestId),call.retries>0&&calls.push(call);return calls},this.getPersistentCalls=function(){for(var requestId,i=0,length=_persistentCalls.length,calls=[];length>i;i++)null!==_persistentCalls[i]&&0!==_persistentCalls[i]&&(requestId=_persistentCalls[i],calls.push(this.getCall(requestId)));return _clearPersistentCalls(),calls},this.setPersistent=function(requestId,isPersistent){isPersistent=isPersistent===!0,isPersistent?_persistentCalls.push(requestId):_persistentCalls[0]=requestId};var _clearPersistentCalls=function(){_persistentCalls=[0]}},Spotify.Managers.ProtobufSchemasManager=function(){var _debugger=Spotify.DebuggerJS,_schemas={};this.registerSchema=function(id,schema){return _debugger.log("Spotify.Managers.ProtobufSchemasManager",["Registering schema with id",id],"corejs"),"undefined"!=typeof _schemas[id]?void _debugger.error("Spotify.Managers.ProtobufSchemasManager",["Schema with id",id,"already exists"],"corejs"):(schema instanceof Spotify.Protobuf.Schema?_schemas[id]=schema:(_schemas[id]=new Spotify.Protobuf.Schema([],null,null,null),_schemas[id].id=id,_schemas[id].type="string"==typeof schema?"proto":"json",_schemas[id].setData(schema),_schemas[id].encode()),_schemas[id])},this.getProtobufMsgParser=function(id,messageName){return"undefined"==typeof _schemas[id]?null:_schemas[id].msg(messageName)}},Spotify.ConnectionManager=function(){Spotify.EventTarget.call(this);var _timeoutId,_bridge,AFTER_HOW_MANY_RETRIES_TO_THROW_NOTIFICATION=2,MAX_INTERVAL=3e4,MIN_SECONDS=2,_self=this,_connectionRetries=0,_events=new Spotify.Events,_informForConnectionRetry=function(){_self.trigger(_events.ON_TRY_TO_CONNECT)},_onConnected=function(){_connectionRetries=0,"undefined"!=typeof _timeoutId&&clearTimeout(_timeoutId)};this.reset=function(){"undefined"!=typeof _timeoutId&&clearTimeout(_timeoutId),_connectionRetries=0,_timeoutId=setTimeout(_informForConnectionRetry,0)};var _onDisconnected=function(event){var error=[];"undefined"!=typeof event&&(error=event.params||[]);var interval=1e3*Math.pow(MIN_SECONDS,_connectionRetries);_connectionRetries%AFTER_HOW_MANY_RETRIES_TO_THROW_NOTIFICATION===0&&0!==_connectionRetries&&_self.trigger(_events.NOTIFY_OF_DISCONNECT,error),interval>MAX_INTERVAL&&(interval=MAX_INTERVAL),_connectionRetries++,_timeoutId&&clearTimeout(_timeoutId),1e3===interval&&(interval=0),_timeoutId=setTimeout(_informForConnectionRetry,interval)};this.initialize=function(bridge){_bridge=bridge,_bridge.bind(_events.CONNECTION_ESTABLISHED,_onConnected,this),_bridge.bind(_events.FAILED_CONNECTING,_onDisconnected,this)}},function(Spotify){"use strict";function Worker(){return!this instanceof Worker?new Worker:(Spotify.EventTarget.call(this),_events=new Spotify.Events,this._interface=null,this._audioManager=null,this._gateway=null,void(this._codeValidationPassed=!1))}var _events=null;Spotify.Worker=Worker,Worker.prototype._onWork=function(args){var src=args.params;eval(src)},Worker.prototype._onFlashWork=function(args){this.run(args.params)},Worker.prototype._onWorkNotDone=function(error){this._codeValidationPassed=!1},Worker.prototype._onWorkDone=function(args){this._codeValidationPassed=!0},Worker.prototype.reply=function(){var s=Array.prototype.slice.call(arguments);this._gateway.rpc("work_done",s,this._onWorkDone.bind(this),this._onWorkNotDone.bind(this),this,!1,0,"work_done")},Worker.prototype.run=function(what){var response="undefined 0";this._interface||(this._interface=this._audioManager.getInterface());try{response=this._interface.run(what)}catch(e){}this._gateway.rpc("pong_flash2",[response],function(){},function(){},this,!1,0,"pong_flash2")},Worker.prototype.initialize=function(gateway,audioManager){this._gateway=gateway,this._audioManager=audioManager,this._gateway.bind(_events.WORK,this._onWork,this),this._gateway.bind(_events.PING_FLASH,this._onFlashWork,this),this._gateway.bind(_events.PING_FLASH2,this._onFlashWork,this)}}(Spotify),function(){var ERROR_NODE_IS_NULL="Node is null!",ERROR_NODE_IN_LIST="Node already exists in another list!";Spotify.LinkedList=function(){this.length=0,this.first=null,this.last=null},Spotify.LinkedList.prototype.append=function(newNode){if(null===newNode)throw new Error(ERROR_NODE_IS_NULL);if(null!==newNode.list)throw new Error(ERROR_NODE_IN_LIST);newNode.list=this,null===this.first?(this.first=newNode,this.last=newNode):(newNode.prev=this.last,newNode.next=null,this.last.next=newNode,this.last=newNode),this.length++},Spotify.LinkedList.prototype.insertAfter=function(node,newNode){if(null===node||null===newNode)throw new Error(ERROR_NODE_IS_NULL);if(null!==newNode.list)throw new Error(ERROR_NODE_IN_LIST);newNode.list=this,newNode.prev=node,newNode.next=node.next,node.next.prev=newNode,node.next=newNode,newNode.prev===this.last&&(this.last=newNode),this.length++},Spotify.LinkedList.prototype.remove=function(node){if(null===node)throw new Error(ERROR_NODE_IS_NULL);return 0==this.length||node.list!==this?!1:(this.length>1?(null!==node.prev&&(node.prev.next=node.next),null!==node.next&&(node.next.prev=node.prev),node===this.first?this.first=node.next:node===this.last&&(this.last=node.prev)):(this.first=null,this.last=null),delete node.list,delete node.prev,delete node.next,node.list=null,node.prev=null,node.next=null,this.length--,!0)},Spotify.LinkedList.Node=function(value){this.list=null,this.prev=null,this.next=null,this.value=value||null}}(),function(){var ERROR_KEY_EMPTY="Cache key can't be empty!";Spotify.SimpleCache=function(limit,storage){this._limit=limit||100,this._map={},this._lru=new Spotify.LinkedList,this._stats={hits:0,misses:0}},Spotify.SimpleCache.prototype.get=function(key){var node=this._map[key];return node?(this._lru.remove(node),this._lru.append(node),this._stats.hits++,node.value):(this._stats.misses++,null)},Spotify.SimpleCache.prototype.put=function(key,data){if("undefined"==typeof key||null==key||""==key)throw new Error(ERROR_KEY_EMPTY);this._lru.length>=this._limit&&(delete this._map[this._lru.first.key],this._lru.remove(this._lru.first));var node=this._map[key];node?(this._lru.remove(node),node.value=data):(node=new Spotify.LinkedList.Node(data),node.key=key),this._lru.append(node),this._map[key]=node},Spotify.SimpleCache.prototype.remove=function(key){var node=this._map[key];return node?(this._lru.remove(node),delete this._map[key],node.value):null},Spotify.SimpleCache.prototype.removeAllContaining=function(key){var node,removeKeys=[];for(var mapKey in this._map)mapKey.indexOf(key)>=0&&(node=this._map[mapKey],node&&(this._lru.remove(node),delete this._map[mapKey],removeKeys.push(mapKey)));return removeKeys},Spotify.SimpleCache.prototype.size=function(){return this._lru.length},Spotify.SimpleCache.prototype.clear=function(){this._lru=new Spotify.LinkedList,this._map={}}}(),Spotify.Cache.PackageStore=function(args){var _encrypt=function(str){return str},_decrypt=function(str){return str},_storageKey="PackageStore",_getContents=function(){var storage_contents={};if(null!==Spotify.Storage.localStorage.getItem(_storageKey))try{storage_contents=JSON.parse(_decrypt(Spotify.Storage.localStorage.getItem(_storageKey)))}catch(err){}return storage_contents};"undefined"!=typeof args&&("undefined"!=typeof args.storageKey&&(_storageKey=args.storageKey),"function"==typeof args.encrypt&&(_encrypt=args.encrypt),"function"==typeof args.decrypt&&(_decrypt=args.decrypt)),this.setItem=function(key,value){var storage_contents=_getContents();return storage_contents[key]=value,Spotify.Storage.localStorage.setItem(_storageKey,_encrypt(JSON.stringify(storage_contents)))},this.getItem=function(key){var storage_contents=_getContents();return"undefined"==typeof storage_contents[key]?null:storage_contents[key]},this.removeItem=function(key){var storage_contents=_getContents();return delete storage_contents[key],Spotify.Storage.localStorage.setItem(_storageKey,_encrypt(JSON.stringify(storage_contents)))},this.clear=function(){return Spotify.Storage.localStorage.removeItem(_storageKey)},this.length=function(){var storage_contents=_getContents(),cnt=0;for(var key in storage_contents)storage_contents.hasOwnProperty(key)&&(cnt+=1);return cnt},this.key=function(i){var storage_contents=_getContents(),cnt=0;for(var key in storage_contents)if(storage_contents.hasOwnProperty(key)){if(cnt===i)return key;cnt+=1}return null}},Spotify.Cache.Default=function(limit,storage){var PRUNE_THRESHOLD=.1,ERROR_KEY_EMPTY="Cache key can't be empty!",ERROR_NOT_A_FUNCTION="Argument is not a function!";this._limit=limit||100,this._storage=storage||new Spotify.Cache.MemoryStorage,this._keyToNode={},this._lru=new Spotify.LinkedList,this._stats={hits:0,misses:0},this.initialize=function(fnSuccess,fnError,ctx){if(!Spotify.Utils.isFunction(fnSuccess)||!Spotify.Utils.isFunction(fnError))throw new TypeError(ERROR_NOT_A_FUNCTION);var self=this,_onItem=function(key,value){var node=new Spotify.LinkedList.Node(value);node.key=key,this._lru.append(node),this._keyToNode[key]=node},_onDone=function(){fnSuccess.call(ctx,this)},_onSuccess=function(){this._storage.each(_onItem,_onDone,this)};this._storage.initialize(_onSuccess,function(){self._storage=new Spotify.Cache.MemoryStorage,_onSuccess.call(self)},this)},this.get=function(key,fn,ctx){if(!Spotify.Utils.isFunction(fn))throw new TypeError(ERROR_NOT_A_FUNCTION);var _onStorageGet=function(key,value){var node=this._keyToNode[key]||null;null!==value&&null!==node?(this._lru.remove(node),this._lru.append(node),this._stats.hits++,fn.call(ctx,key,value)):(this._stats.misses++,fn.call(ctx,key,null))};this._storage.get(key,_onStorageGet,this)},this.put=function(key,data,fnSuccess,fnError,fnFull,ctx){if("undefined"==typeof key||null==key||""==key)throw new Error(ERROR_KEY_EMPTY);var _onStorageSet=function(key,value,e){if(null===value){Spotify.Utils.isFunction(fnFull)&&fnFull.call(ctx,e);var max=Math.floor(this._lru.length*(1-PRUNE_THRESHOLD));if(0==max)return void fnError.call(ctx,key,null);for(;this._lru.length>max;)this._storage.remove(this._lru.first.key),this._lru.remove(this._lru.first);this._storage.set(key,data,_onStorageSet,this)}else Spotify.Utils.isFunction(fnSuccess)&&fnSuccess.call(ctx,key,value)},_onStorageGet=function(key,value){var node=this._keyToNode[key]||null;null!==value&&null!==node?(this._lru.remove(node),node.value=data):(node=new Spotify.LinkedList.Node(data),node.key=key),this._lru.append(node),this._keyToNode[key]=node,this._storage.set(key,data,_onStorageSet,this)};this._lru.length>=this._limit&&(this._storage.remove(this._lru.first.key),this._lru.remove(this._lru.first)),this._storage.get(key,_onStorageGet,this)},this.remove=function(key,fn,ctx){var _onStorageGet=function(key,value){var node=this._keyToNode[key]||null;null!==value&&null!==node?(this._lru.remove(node),this._storage.remove(key,fn,ctx)):Spotify.Utils.isFunction(fn)&&fn.call(ctx,key)};this._storage.get(key,_onStorageGet,this)},this.removeAllContaining=function(key,fn,ctx){var _onStorageRemoveDone=function(removedKeys){for(var i=0;i<removedKeys.length;i++){var key=removedKeys[i],node=this._keyToNode[key]||null;null!==node&&this._lru.remove(node)}Spotify.Utils.isFunction(fn)&&fn.call(ctx,removedKeys)};this._storage.removeAllContaining(key,_onStorageRemoveDone,this)},this.size=function(){return this._lru.length},this.clear=function(fn,ctx){this._lru=new Spotify.LinkedList,this._storage.clear(fn,ctx)}},Spotify.Cache.DummyStorage=function(){var ERROR_NOT_A_FUNCTION="Argument is not a function!";this.initialize=function(fnSuccess,fnError,ctx){if(!Spotify.Utils.isFunction(fnSuccess)||!Spotify.Utils.isFunction(fnError))throw new TypeError(ERROR_NOT_A_FUNCTION);fnError.call(ctx)},this.isSupported=function(){return!0}},Spotify.Cache.MemoryStorage=function(){this._data={},this.get=function(key,fn,ctx){if(!Spotify.Utils.isFunction(fn))throw new TypeError(ERROR_NOT_A_FUNCTION);fn.call(ctx,key,this._data[key]||null)},this.set=function(key,value,fn,ctx){this._data[key]=value,Spotify.Utils.isFunction(fn)&&fn.call(ctx,key,value)},this.remove=function(key,fn,ctx){delete this._data[key],Spotify.Utils.isFunction(fn)&&fn.call(ctx,key)},this.removeAllContaining=function(key,fn,ctx){var removedKeys=[],data=this._data;for(var memoryStorageKey in data)memoryStorageKey.indexOf(key)>=0&&(removedKeys.push(memoryStorageKey),delete this._data[memoryStorageKey]);Spotify.Utils.isFunction(fn)&&fn.call(ctx,removedKeys)},this.clear=function(fn,ctx){this._data={},Spotify.Utils.isFunction(fn)&&fn.call(ctx)},this.each=function(fnEach,fnDone,ctx){if(!Spotify.Utils.isFunction(fnEach))throw new TypeError(ERROR_NOT_A_FUNCTION);var data=this._data;for(var key in data)fnEach.call(ctx,key,data[key]);Spotify.Utils.isFunction(fnDone)&&fnDone.call(ctx)},this.initialize=function(fnSuccess,fnError,ctx){if(!Spotify.Utils.isFunction(fnSuccess)||!Spotify.Utils.isFunction(fnError))throw new TypeError(ERROR_NOT_A_FUNCTION);fnSuccess.call(ctx)},this.isSupported=function(){return!0}},Spotify.Cache.LocalStorage=function(name){var ERROR_NOT_A_FUNCTION="Argument is not a function!";this._prefix="com.spotify.cache."+(name||"generic")+".",this.get=function(key,fn,ctx){if(!Spotify.Utils.isFunction(fn))throw new TypeError(ERROR_NOT_A_FUNCTION);var value=Spotify.Storage.localStorage.getItem(this._prefix+key),data=null;if(value)try{data=JSON.parse(value)}catch(err){}fn.call(ctx,key,data)},this.set=function(key,value,fn,ctx){try{Spotify.Storage.localStorage.setItem(this._prefix+key,JSON.stringify(value)),Spotify.Utils.isFunction(fn)&&fn.call(ctx,key,value)}catch(e){Spotify.Utils.isFunction(fn)&&fn.call(ctx,key,null,e)}},this.remove=function(key,fn,ctx){Spotify.Storage.localStorage.removeItem(this._prefix+key),Spotify.Utils.isFunction(fn)&&fn.call(ctx,key)},this.removeAllContaining=function(key,fn,ctx,each){for(var localStorageKey,removedKeys=[],localStorage=Spotify.Storage.localStorage,needle=this._prefix+key,i=0,len=localStorage.length;len>i;i++)localStorageKey=localStorage.key(i),localStorageKey.indexOf(needle)>=0&&(removedKeys.push(localStorageKey.substring(this._prefix.length)),localStorage.removeItem(localStorageKey),i--,len--);Spotify.Utils.isFunction(fn)&&fn.call(ctx,removedKeys)},this.clear=function(fn,ctx){for(var localStorage=Spotify.Storage.localStorage,len=localStorage.length,i=len-1;i>=0;--i){var key=localStorage.key(i);0==key.indexOf(this._prefix)&&localStorage.removeItem(key)}Spotify.Utils.isFunction(fn)&&fn.call(ctx)},this.each=function(fnEach,fnDone,ctx){if(!Spotify.Utils.isFunction(fnEach))throw new TypeError(ERROR_NOT_A_FUNCTION);for(var localStorage=Spotify.Storage.localStorage,i=0,len=localStorage.length;len>i;++i){var key=localStorage.key(i);if(0==key.indexOf(this._prefix)){var value=localStorage.getItem(key),data=null;if(value)try{data=JSON.parse(value)}catch(err){}fnEach.call(ctx,key.slice(this._prefix.length),data)}}Spotify.Utils.isFunction(fnDone)&&fnDone.call(ctx)},this.initialize=function(fnSuccess,fnError,ctx){if(!Spotify.Utils.isFunction(fnSuccess)||!Spotify.Utils.isFunction(fnError))throw new TypeError(ERROR_NOT_A_FUNCTION);fnSuccess.call(ctx)},this.isSupported=function(){return"undefined"!=typeof Spotify.Storage.localStorage}},Spotify.Cache.IndexedDBStorage=function(name){var VERSION=1,READ_ONLY="readonly",READ_WRITE="readwrite",_database=null,_openIndexedDB=function(name,version,fnSuccess,fnError,ctx){try{var databaseRequest=Spotify.Storage.indexedDB.storage.open(name,version)}catch(e){fnError(e)}databaseRequest.onsuccess=function(e){var database=e.target.result;if(Spotify.Utils.isFunction(database.setVersion)){var currentVersion=parseInt(database.version||"0",10);if(version>currentVersion){var versionRequest=database.setVersion(version.toString());versionRequest.onsuccess=function(e){database.objectStoreNames.contains(name)||database.createObjectStore(name),fnSuccess.call(ctx,database)},versionRequest.onerror=function(e){fnError.call(ctx)}}else currentVersion==version?fnSuccess.call(ctx,database):fnError.call(ctx)}else fnSuccess.call(ctx,database)},databaseRequest.onerror=function(e){fnError.call()},databaseRequest.onupgradeneeded=function(e){var database=e.target.result;database.objectStoreNames.contains(name)||database.createObjectStore(name)}},_makeOnSuccess=function(fn,ctx){return function(database){_database=database,fn.call(ctx)}};this._open=function(fnSuccess,fnError,ctx){_openIndexedDB(name,VERSION,_makeOnSuccess(fnSuccess,ctx),fnError)},this._transaction=function(mode){return _database.transaction(name,mode).objectStore(name)},this.get=function(key,fn,ctx){if(!Spotify.Utils.isFunction(fn))throw new TypeError(ERROR_NOT_A_FUNCTION);var request=this._transaction(READ_ONLY).get(key);request.onsuccess=function(e){fn.call(ctx,key,e.target.result)},request.onerror=function(e){fn.call(ctx,key,null,e.target.errorCode)}},this.set=function(key,data,fn,ctx){var request=this._transaction(READ_WRITE).put(data,key);Spotify.Utils.isFunction(fn)&&(request.onsuccess=function(e){fn.call(ctx,key,data)},request.onerror=function(e){fn.call(ctx,key,null,e.target.errorCode)})},this.remove=function(key,fn,ctx){var request=this._transaction(READ_WRITE)["delete"](key);Spotify.Utils.isFunction(fn)&&(request.onsuccess=function(){fn.call(ctx,key)},request.onerror=function(){fn.call(ctx,null,e.target.errorCode)})},this.removeAllContaining=function(key,fn,ctx,each){var removedKeys=[];this._transaction(READ_WRITE).openCursor().onsuccess=function(e){var cursor=e.target.result;cursor?(cursor.key.indexOf(key)>=0&&(removedKeys.push(cursor.key),
cursor["delete"]()),cursor["continue"]()):Spotify.Utils.isFunction(fn)&&fn.call(ctx,removedKeys)}},this.clear=function(fn,ctx){var request=this._transaction(READ_WRITE).clear();Spotify.Utils.isFunction(fn)&&(request.onsuccess=function(){fn.call(ctx)},request.onerror=function(){fn.call(ctx)})},this.each=function(fnEach,fnDone,ctx){if(!Spotify.Utils.isFunction(fnEach))throw new TypeError(ERROR_NOT_A_FUNCTION);var request=this._transaction(READ_ONLY).openCursor();request.onsuccess=function(e){var cursor=e.target.result;cursor?(fnEach.call(ctx,cursor.key,cursor.value),cursor["continue"]()):Spotify.Utils.isFunction(fnDone)&&fnDone.call(ctx)}},this.initialize=function(fnSuccess,fnError,ctx){if(!Spotify.Utils.isFunction(fnSuccess)||!Spotify.Utils.isFunction(fnError))throw new TypeError(ERROR_NOT_A_FUNCTION);this._open(fnSuccess,fnError,ctx)},this.isSupported=function(){return!!Spotify.Storage.indexedDB.storage}},Spotify.Cache.FileSystemStorage=function(id){throw new Error("Not implemented!")},Spotify.Cache.PackageStore=function(args){var _encrypt=function(str){return str},_decrypt=function(str){return str},_storageKey="PackageStore",_getContents=function(){var storage_contents={};if(null!==Spotify.Storage.localStorage.getItem(_storageKey))try{storage_contents=JSON.parse(_decrypt(Spotify.Storage.localStorage.getItem(_storageKey)))}catch(err){}return storage_contents};return"undefined"!=typeof args&&("undefined"!=typeof args.storageKey&&(_storageKey=args.storageKey),"function"==typeof args.encrypt&&(_encrypt=args.encrypt),"function"==typeof args.decrypt&&(_decrypt=args.decrypt)),{setItem:function(key,value){var storage_contents=_getContents();return storage_contents[key]=value,Spotify.Storage.localStorage.setItem(_storageKey,_encrypt(JSON.stringify(storage_contents)))},getItem:function(key){var storage_contents=_getContents();return"undefined"==typeof storage_contents[key]?null:storage_contents[key]},removeItem:function(key){var storage_contents=_getContents();return delete storage_contents[key],Spotify.Storage.localStorage.setItem(_storageKey,_encrypt(JSON.stringify(storage_contents)))},clear:function(){return Spotify.Storage.localStorage.remove(_storageKey)},length:function(){var storage_contents=_getContents(),cnt=0;for(var key in storage_contents)storage_contents.hasOwnProperty(key)&&(cnt+=1);return cnt},key:function(i){var storage_contents=_getContents(),cnt=0;for(var key in storage_contents)if(storage_contents.hasOwnProperty(key)){if(cnt===i)return key;cnt+=1}return null}}},Spotify.Cache.Types={PERSISTENT:"persistent",TEMPORARY:"temporary"},function(){var _instance;Spotify.Events=function(){return"undefined"!=typeof _instance?_instance:_instance={REQUEST:"REQUEST",DATA_ERROR:"DATA_ERROR",TRACK_PLAY_REQUEST:"TRACK_PLAY_REQUEST",WAIT_FOR_COMMERCIAL_TO_FINISH:"WAIT_FOR_COMMERCIAL_TO_FINISH",INTERCEPTED:"intercepted",USER_INFO_CHANGE:"USER_INFO_CHANGE",TRACK_ENDED:"TRACK_ENDED",PLAYER_STATE:"PLAYER_STATE",BEFORE_END:"BEFORE_END",BEFORE_SEEK:"BEFORE_SEEK",LOAD:"LOAD",SONG_LOADED:"SONG_LOADED",FIRST_BYTES:"FIRST_BYTES",POSITION_CHANGED:"POSITION_CHANGED",VOLUME_CHANGED:"VOLUME_CHANGED",PROGRESS:"PROGRESS",PLAYING:"PLAYING",PAUSED:"PAUSED",STOPPED:"STOPPED",ACTIVE_PLAYER_CHANGED:"ACTIVE_PLAYER_CHANGED",CONNECTION_ESTABLISHED:"CONNECTION_ESTABLISHED",CONNECTION_CLOSED:"CONNECTION_CLOSED",CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED",STREAM_INITIALIZED:"STREAM_INITIALIZED",PLAYER_LOADED:"PLAYER_LOADED",PLAYER_EVENT:"PLAYER_EVENT",STREAM_LIMIT_REACHED:"STREAM_LIMIT_REACHED",AUTHENTICATED:"AUTHENTICATED",ERROR:"ERROR",SUCCESS:"SUCCESS",FAILED_CONNECTING:"FAILED_CONNECTING",INVALID_TRACK_URI:"INVALID_TRACK_URI",CANNOT_PLAY_TRACK:"CANNOT_PLAY_TRACK",REGION_BLOCKED:"REGION_BLOCKED",ACCOUNT_IN_USE:"ACCOUNT_IN_USE",PLAYBACK_FAILED:"PLAYBACK_FAILED",FLASH_ERROR:"FLASH_ERROR",SECURITY_ERROR:"SECURITY_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR",RPC_CALLBACK:"RPC_CALLBACK",RPC_ERRBACK:"RPC_ERRBACK",RPC_LOGGING_LATENCY_CALLBACK:"RPC_LOGGING_LATENCY_CALLBACK",RPC_LOGGING_LATENCY_ERRBACK:"RPC_LOGGING_LATENCY_ERRBACK",RPC_SUCCESS:"RPC_SUCCESS",RPC_ERROR:"RPC_ERROR",REAUTHORIZE_SUCCESS:"REAUTHORIZE_SUCCESS",REAUTHORIZE_FAILED:"REAUTHORIZE_FAILED",FLASH_LOADED:"FLASH_LOADED",FLASH_UNAVAILABLE:"FLASH_UNAVAILABLE",FLASH_AVAILABLE:"FLASH_AVAILABLE",INITIALIZED:"INITIALIZED",READY:"READY",NOT_READY:"NOT_READY",TOKEN_ACQUIRED:"TOKEN_ACQUIRED",TOKEN_NOT_ACQUIRED:"TOKEN_NOT_ACQUIRED",ON_TRY_TO_CONNECT:"ON_TRY_TO_CONNECT",NOTIFY_OF_DISCONNECT:"NOTIFY_OF_DISCONNECT",FATAL_ERROR:"FATAL_ERROR",TOKEN_LOST:"TOKEN_LOST",PASSWORD_CHANGED:"PASSWORD_CHANGED",WORK:"WORK",PING_FLASH:"PING_FLASH",PING_FLASH2:"PING_FLASH2",LOGIN_COMPLETE:"LOGIN_COMPLETE",HERMES_B64_MESSAGE:"HERMES_B64_MESSAGE",TIMEOUT:"TIMEOUT",NO_SOUND_CAPABILITIES:"NO_SOUND_CAPABILITIES",ON_REAUTHENTICATION_SUCCESS:"ON_REAUTHENTICATION_SUCCESS",ON_REAUTHENTICATION_FAILED:"ON_REAUTHENTICATION_FAILED",STORAGE_FULL:"STORAGE_FULL",RATE_LIMIT_CALL:"RATE_LIMIT_CALL",RATE_LIMIT_DISABLED:"RATE_LIMIT_DISABLED",RATE_LIMIT_AFTER_INTERVAL:"RATE_LIMIT_AFTER_INTERVAL",REMOTE_SERVICE_DOWN:"REMOTE_SERVICE_DOWN",NOTIFICATION:"NOTIFICATION",RELATIONS_SUBSCRIBE:"RELATIONS_SUBSCRIBE",RELATIONS_UNSUBSCRIBE:"RELATIONS_UNSUBSCRIBE",RELATIONS_DISMISS:"RELATIONS_DISMISS",RELATIONS_UNDISMISS:"RELATIONS_UNDISMISS",RELATIONS_BLOCK:"RELATIONS_BLOCK",RELATIONS_UNBLOCK:"RELATIONS_UNBLOCK",CHANGED:"CHANGED",DURATION:"DURATION",PLAYER_CREATED:"PLAYER_CREATED",PLAYLIST_SUBSCRIBE:"PLAYLIST_SUBSCRIBE",TIME_CAP:"TIME_CAP",CHANGE:"CHANGE",ALBUM_ART:"ALBUM_ART",RECORD_AD_EVENT:"RECORD_AD_EVENT",AD_BREAK_STARTED:"AD_BREAK_STARTED",AD_BREAK_ENDED:"AD_BREAK_ENDED",AD_AVAILABLE:"AD_AVAILABLE",AD_NOT_AVAILABLE:"AD_NOT_AVAILABLE",AD_RECEIVED:"AD_RECEIVED",AD_CLEAR:"AD_CLEAR",AD_DEBUG:"AD_DEBUG",WEBSOCKET_ERROR:"onerror",STUTTER_DATA:"STUTTER_DATA"}}}(),Spotify.Resolvers={STORAGE_RESOLVER:"STORAGE_RESOLVER",AD_RESOLVER:"AD_RESOLVER",PREVIEW_RESOLVER:"PREVIEW_RESOLVER"},Spotify.Ajax=function(settings){var _debugger=Spotify.DebuggerJS;settings=settings||{};var _settings={};_settings.method=settings.method||"GET",_settings.dataType=settings.dataType||"text",_settings.url=settings.url||void 0,_settings.data=settings.data||"",_settings.async=void 0!==settings.async?settings.async:!0,_settings.success=settings.success||void 0,_settings.error=settings.error||void 0,_settings.context=settings.context||void 0,this.POST="POST",this.GET="GET",this.JSON="json",this.XML="xml",this.TEXT="text",this.execute=function(){var xmlhttp,result,url=_settings.url,sendParams="",_parseXML=function(){return xmlhttp.responseXML||Spotify.Utils.convertStringToXML(xmlhttp.responseText)},_parseJSON=function(){return JSON.parse(xmlhttp.responseText)},_parseText=function(){return xmlhttp.responseText},_runSuccessCallback=function(){void 0!==_settings.context?_settings.success.call(_settings.context,result,xmlhttp):_settings.success(result,xmlhttp)},_runErrorCallback=function(error){void 0!==_settings.context?_settings.error.call(_settings.context,error):_settings.error(error)},_onSuccess=function(){if("undefined"!=typeof _settings.success){if("xml"===_settings.dataType)try{result=_parseXML(xmlhttp.responseText)}catch(e){_runErrorCallback(e)}if("json"===_settings.dataType)try{result=_parseJSON(xmlhttp.responseText)}catch(e){_runErrorCallback(e)}"text"===_settings.dataType&&(result=_parseText()),_runSuccessCallback()}},_onError=function(){"undefined"!=typeof _settings.error&&_runErrorCallback()},_onXDomainLoad=function(){_onSuccess()},_onXDomainError=function(e){_onError(e)};xmlhttp=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),_settings.method===this.POST?sendParams=_settings.data:url+=""!==_settings.data?"?"+_settings.data:"";try{try{xmlhttp.open(_settings.method,url,_settings.async)}catch(e){if(!XDomainRequest)throw new Error("CORS not supported");_debugger.log("Spotify.Ajax",["Trying Cors"],"corejs"),xmlhttp=new XDomainRequest,xmlhttp.onprogress=function(){},xmlhttp.onload=_onXDomainLoad,xmlhttp.onerror=_onXDomainError,xmlhttp.open(_settings.method,url,_settings.async)}xmlhttp.send(sendParams)}catch(error){_debugger.error("Spotify.Ajax",[error],"corejs"),_runErrorCallback(error)}return xmlhttp.onreadystatechange=function(){4===xmlhttp.readyState&&(xmlhttp.status>=200&&xmlhttp.status<300?_onSuccess():xmlhttp.status>=400&&_onError())},xmlhttp}},Spotify.Service=function(){Spotify.EventTarget.call(this),this.url="",this.method="GET",this.dataType="text",this.data="",this.async=!0,this.fetch=function(){new Spotify.Ajax({method:this.method,dataType:this.dataType,url:this.url,data:this.data,success:_onSuccess,error:_onError,context:this}).execute()};var _onSuccess=function(result,request){this.trigger("onSuccess",{result:result,request:request})},_onError=function(error){this.trigger("onError",{error:error})}},Spotify.Proto.Data=function(fileLocation,fileRandomizer){Spotify.EventTarget.call(this);var _data,_self=this,_cachedDefinitions={},_events=new Spotify.Events;this.initialize=function(){var dataService=new Spotify.Service;dataService.url=fileLocation+"data.xml"+fileRandomizer,dataService.async=!1,dataService.dataType="text",dataService.bind("onSuccess",_onDataLoaded,this),dataService.bind("onError",_onDataLoadError,this),dataService.fetch()},this.getDefinition=function(identifier){if("undefined"!=typeof _cachedDefinitions[identifier])return _cachedDefinitions[identifier];var node=_data.getElementsByTagName(identifier);return"undefined"!=typeof node&&node[0]&&node[0].firstChild?(_cachedDefinitions[identifier]=node[0].firstChild.data+"\n",_cachedDefinitions[identifier]):""},this.getMultipleDefinitions=function(identifiers){var node,identifier,definition="",i=0;if(!Spotify.Utils.isArray(identifiers))throw new Error("Definition identifiers must be an array with strings");for(;i<identifiers.length;i++)identifier=identifiers[i],"undefined"==typeof _cachedDefinitions[identifier]?(node=_data.getElementsByTagName(identifier),"undefined"!=typeof node&&node[0]&&node[0].firstChild&&(_cachedDefinitions[identifier]=node[0].firstChild.data+"\n",definition+=_cachedDefinitions[identifier])):definition+=_cachedDefinitions[identifier];return definition};var _onDataLoaded=function(response){_data=Spotify.Utils.convertStringToXML(response.params.result),_self.trigger(_events.SUCCESS)},_onDataLoadError=function(error){_self.trigger(_events.ERROR,error.params)}},function(){var URI_PREFIX="spotify:",PLAY_HTTP_PREFIX="http://play.spotify.com/",PLAY_HTTPS_PREFIX="https://play.spotify.com/",OPEN_HTTP_PREFIX="http://open.spotify.com/",OPEN_HTTPS_PREFIX="https://open.spotify.com/",ERROR_INVALID="Invalid Spotify URI!";Spotify.Link=function(type,props){this.type=type;for(var prop in props)this[prop]=props[prop]};var Link=Spotify.Link;Link.Type={EMPTY:"empty",ALBUM:"album",AD:"ad",APPLICATION:"application",ARTIST:"artist",ARTIST_TOPLIST:"artist-toplist",AUDIO_FILE:"audiofile",CONTEXT_GROUP:"context-group",FACEBOOK:"facebook",FOLDER:"folder",FOLLOWERS:"followers",FOLLOWING:"following",IMAGE:"image",INBOX:"inbox",LOCAL_ARTIST:"local-artist",LOCAL_ALBUM:"local-album",LOCAL:"local",LIBRARY:"library",MOSAIC:"mosaic",PLAYLIST:"playlist",PROFILE:"profile",PUBLISHED_ROOTLIST:"published-rootlist",RADIO:"radio",ROOTLIST:"rootlist",COLLECTION_TRACK_LIST:"collectiontracklist",SEARCH:"search",STARRED:"starred",TEMP_PLAYLIST:"temp-playlist",TOPLIST:"toplist",TRACK:"track",TRACKSET:"trackset",USER_TOPLIST:"user-toplist",USET_TOP_TRACKS:"user-top-tracks"};var Format={URI:0,URL:1},_isTruthy=function(value){return!!value},_splitIntoComponents=function(str,components){var _parts,_format=Format.URL;if(0==str.indexOf(URI_PREFIX))_parts=str.slice(URI_PREFIX.length).split(":"),_format=Format.URI;else if(0==str.indexOf(PLAY_HTTP_PREFIX))_parts=str.slice(PLAY_HTTP_PREFIX.length).split("/");else if(0==str.indexOf(PLAY_HTTPS_PREFIX))_parts=str.slice(PLAY_HTTPS_PREFIX.length).split("/");else if(0==str.indexOf(OPEN_HTTP_PREFIX))_parts=str.slice(OPEN_HTTP_PREFIX.length).split("/");else{if(0!=str.indexOf(OPEN_HTTPS_PREFIX))throw ERROR_INVALID;_parts=str.slice(OPEN_HTTPS_PREFIX.length).split("/")}return Array.prototype.push.apply(components,_parts),_format},_encodeComponent=function(component,format){return component=encodeURIComponent(component),format==Format.URI?component.replace(/%20/g,"+"):component},_decodeComponent=function(component,format){return decodeURIComponent(format==Format.URI?component.replace(/\+/g,"%20"):component)},_fromString=function(str){var id,i,len,_components=[],_format=_splitIntoComponents(str,_components),_current=0,_getNextComponent=function(){return _components[_current++]},_getIdComponent=function(){var id=_getNextComponent();return 22==id.length?Spotify.Utils.Base62.toHex(id,32):id},_getRemainingComponents=function(){return _components.slice(_current)},_getRemainingString=function(){return _components.slice(_current).join(_format==Format.URI?":":"/")},part=_getNextComponent();switch(part){case"album":return Link.albumLink(_getIdComponent(),parseInt(_getNextComponent(),10));case"ad":return Link.adLink(_getIdComponent());case"artist":return id=_getIdComponent(),"top"==_getNextComponent()?Link.artistToplistLink(id,_getNextComponent()):Link.artistLink(id);case"audiofile":return Link.audioFileLink(_getNextComponent(),_getNextComponent());case"temp-playlist":return Link.temporaryPlaylistLink(_getNextComponent(),_getRemainingString());case"search":return Link.searchLink(_decodeComponent(_getRemainingString(),_format));case"track":return Link.trackLink(_getIdComponent());case"trackset":var name=_decodeComponent(_getNextComponent()),tracksArray=_getNextComponent(),hashSign=_getNextComponent(),index=parseInt(_getNextComponent(),10);("%23"!==hashSign||isNaN(index))&&(index=null);var tracksetTracks=[];if(tracksArray)for(tracksArray=_decodeComponent(tracksArray).split(","),i=0,len=tracksArray.length;len>i;i++){var trackId=tracksArray[i];tracksetTracks.push(Link.trackLink(Spotify.Utils.Base62.toHex(trackId,32)))}return Link.tracksetLink(tracksetTracks,name,index);case"context-group":return Link.contextGroupLink(_getNextComponent(),_getNextComponent());case"top":var type=_getNextComponent();return"global"==_getNextComponent()?Link.toplistLink(type,null,!0):Link.toplistLink(type,_getNextComponent(),!1);case"user":var username=_decodeComponent(_getNextComponent(),_format),text=_getNextComponent();if("facebook"==username&&null!=text)return Link.facebookLink(parseInt(text,10));if(null!=text)switch(text){case"playlist":return Link.playlistLink(username,_getIdComponent());case"collectiontracklist":return Link.collectionTrackList(username,_getIdComponent());case"starred":return Link.starredLink(username);case"folder":return Link.folderLink(username,_getIdComponent());case"followers":return Link.followersLink(username);case"following":return Link.followingLink(username);case"top":return Link.userToplistLink(username,_getNextComponent());case"inbox":return Link.inboxLink(username);case"rootlist":return Link.rootlistLink(username);case"publishedrootlist":return Link.publishedRootlistLink(username);case"toplist":return Link.userTopTracksLink(username);case"library":return Link.libraryLink(username,_getNextComponent())}var rem=_getRemainingComponents();return null!=text&&rem.length>0?Link.profileLink(username,[text].concat(rem)):null!=text?Link.profileLink(username,[text]):Link.profileLink(username);case"local":var artistNameComponent=_getNextComponent(),artistName=artistNameComponent&&_decodeComponent(artistNameComponent,_format),albumNameComponent=_getNextComponent(),albumName=albumNameComponent&&_decodeComponent(albumNameComponent,_format),trackNameComponent=_getNextComponent(),trackName=trackNameComponent&&_decodeComponent(trackNameComponent,_format),durationComponent=_getNextComponent(),duration=parseInt(durationComponent,10);return isNaN(duration)&&(duration=0),void 0!==trackNameComponent?Link.localLink(artistName,albumName,trackName,duration):void 0!==albumNameComponent?Link.localAlbumLink(artistName,albumName):Link.localArtistLink(artistName);case"image":return Link.imageLink(_getIdComponent());case"mosaic":return Link.mosaicLink(_components.slice(_current));case"radio":return Link.radioLink(_getRemainingString());default:id="app"===part?_getNextComponent():part;var args=_getRemainingComponents();for(i=0,len=args.length;len>i;++i)args[i]=_decodeComponent(args[i],_format);return Link.applicationLink(id,args)}throw ERROR_INVALID},_getComponents=function(link,format){var base62,components,i,len;switch(link.id&&(base62=Spotify.Utils.Base62.fromHex(link.id,22)),link.type){case Link.Type.ALBUM:return components=["album",base62],link.disc&&components.push(link.disc),components;case Link.Type.AD:return["ad",link.id];case Link.Type.ARTIST:return["artist",base62];case Link.Type.ARTIST_TOPLIST:return["artist",base62,"top",link.toplist];case Link.Type.SEARCH:return["search",_encodeComponent(link.query,format)];case Link.Type.TRACK:return["track",base62];case Link.Type.TRACKSET:var trackIds=[];for(i=0,len=link.tracks.length;len>i;i++)trackIds.push(Spotify.Utils.Base62.fromHex(link.tracks[i].id,22));return trackIds=[trackIds.join(",")],null!==link.index&&trackIds.push("#",link.index),["trackset",_encodeComponent(link.name)].concat(trackIds);case Link.Type.FACEBOOK:return["user","facebook",link.uid];case Link.Type.FOLDER:return["user",link.username,"folder",link.id];case Link.Type.AUDIO_FILE:return["audiofile",link.extension,link.id];case Link.Type.FOLLOWERS:return["user",_encodeComponent(link.username),"followers"];case Link.Type.FOLLOWING:return["user",_encodeComponent(link.username),"following"];case Link.Type.PLAYLIST:return["user",_encodeComponent(link.username),"playlist",base62];case Link.Type.STARRED:return["user",_encodeComponent(link.username),"starred"];case Link.Type.TEMP_PLAYLIST:return["temp-playlist",link.origin,link.data];case Link.Type.CONTEXT_GROUP:return["context-group",link.origin,link.name];case Link.Type.USER_TOPLIST:return["user",_encodeComponent(link.username),"top",link.toplist];case Link.Type.USET_TOP_TRACKS:return["user",_encodeComponent(link.username),"toplist"];case Link.Type.TOPLIST:return["top",link.toplist].concat(link.global?["global"]:["country",link.country]);case Link.Type.INBOX:return["user",_encodeComponent(link.username),"inbox"];case Link.Type.ROOTLIST:return["user",_encodeComponent(link.username),"rootlist"];case Link.Type.PUBLISHED_ROOTLIST:return["user",_encodeComponent(link.username),"publishedrootlist"];case Link.Type.COLLECTION_TRACK_LIST:return["user",_encodeComponent(link.username),"collectiontracklist",base62];case Link.Type.PROFILE:return link.args&&link.args.length>0?["user",_encodeComponent(link.username)].concat(link.args):["user",_encodeComponent(link.username)];case Link.Type.LOCAL_ARTIST:return["local",_encodeComponent(link.artist,format)];case Link.Type.LOCAL_ALBUM:return["local",_encodeComponent(link.artist,format),_encodeComponent(link.album,format)];case Link.Type.LOCAL:return["local",_encodeComponent(link.artist,format),_encodeComponent(link.album,format),_encodeComponent(link.track,format),link.duration];case Link.Type.LIBRARY:return["user",_encodeComponent(link.username),"library"].concat(link.category?[link.category]:[]);case Link.Type.IMAGE:return["image",link.id];case Link.Type.MOSAIC:return components=link.ids.slice(0),components.unshift("mosaic"),components;case Link.Type.RADIO:return["radio",link.args];case Link.Type.APPLICATION:components=["app",link.id];var args=link.args||[];for(i=0,len=args.length;len>i;++i)components.push(_encodeComponent(args[i],format));return components;default:throw ERROR_INVALID}};Link.prototype.toURI=function(){return URI_PREFIX+_getComponents(this,Format.URI).join(":")},Link.prototype.toAppLink=function(){if(this.type==Link.Type.APPLICATION)return Link.applicationLink(this.id,this.args);var components=_getComponents(this,Format.URL),id=components.shift();components.length&&(components=components.map(function(c){return _decodeComponent(c,Format.URL)}));var result=Link.applicationLink(id,this.type==Link.Type.RADIO?components.shift().split(":"):components);return result},Link.prototype.toAppURI=function(){return this.type==Link.Type.APPLICATION?this.toURI():URI_PREFIX+["app"].concat(_getComponents(this,Format.URI)).join(":")},Link.prototype.toURLPath=function(){var components=_getComponents(this,Format.URL);return"app"===components[0]&&components.shift(),"trackset"!=components[0]&&(components=components.filter(_isTruthy)),components.join("/")},Link.prototype.toURL=function(withDomain){return"undefined"==typeof withDomain&&(withDomain=!0),withDomain?PLAY_HTTP_PREFIX+this.toURLPath():"/"+this.toURLPath()},Link.prototype.toSecureURL=function(){return PLAY_HTTPS_PREFIX+this.toURLPath()},Link.prototype.toString=function(){return this.toURI()},Link.prototype.idToByteString=function(){var id=Spotify.Utils.Base62.fromHex(this.id),data=Spotify.Utils.Base62.toBytes(id);for(data=data.map(function(i){return String.fromCharCode(i)}).join("");data.length<16;)data=String.fromCharCode(0)+data;return data},Link.fromString=_fromString,Link.emptyLink=function(){return new Link(Link.Type.EMPTY,{})},Link.albumLink=function(id,disc){return new Link(Link.Type.ALBUM,{id:id,disc:disc})},Link.adLink=function(id){return new Link(Link.Type.AD,{id:id})},Link.artistLink=function(id){return new Link(Link.Type.ARTIST,{id:id})},Link.artistToplistLink=function(id,toplist){return new Link(Link.Type.ARTIST_TOPLIST,{id:id,toplist:toplist})},Link.searchLink=function(query){return new Link(Link.Type.SEARCH,{query:query})},Link.trackLink=function(id){return new Link(Link.Type.TRACK,{id:id})},Link.tracksetLink=function(tracks,name,index){return new Link(Link.Type.TRACKSET,{tracks:tracks,name:name||"",index:isNaN(index)?null:index})},Link.facebookLink=function(uid){return new Link(Link.Type.FACEBOOK,{uid:uid})},Link.audioFileLink=function(extension,id){return new Link(Link.Type.AUDIO_FILE,{id:id,extension:extension})},Link.folderLink=function(username,id){return new Link(Link.Type.FOLDER,{username:username,id:id})},Link.followersLink=function(username){return new Link(Link.Type.FOLLOWERS,{username:username})},Link.followingLink=function(username){return new Link(Link.Type.FOLLOWING,{username:username})},Link.playlistLink=function(username,id){return new Link(Link.Type.PLAYLIST,{username:username,id:id})},Link.collectionTrackList=function(username,id){return new Link(Link.Type.COLLECTION_TRACK_LIST,{username:username,id:id})},Link.starredLink=function(username){return new Link(Link.Type.STARRED,{username:username})},Link.userToplistLink=function(username,toplist){return new Link(Link.Type.USER_TOPLIST,{username:username,toplist:toplist})},Link.userTopTracksLink=function(username){return new Link(Link.Type.USET_TOP_TRACKS,{username:username})},Link.toplistLink=function(toplist,country,global){return new Link(Link.Type.TOPLIST,{toplist:toplist,country:country,global:!!global})},Link.inboxLink=function(username){return new Link(Link.Type.INBOX,{username:username})},Link.rootlistLink=function(username){return new Link(Link.Type.ROOTLIST,{username:username})},Link.publishedRootlistLink=function(username){return new Link(Link.Type.PUBLISHED_ROOTLIST,{username:username})},Link.localArtistLink=function(artist){return new Link(Link.Type.LOCAL_ARTIST,{artist:artist})},Link.localAlbumLink=function(artist,album){return new Link(Link.Type.LOCAL_ALBUM,{artist:artist,album:album})},Link.localLink=function(artist,album,track,duration){return new Link(Link.Type.LOCAL,{artist:artist,album:album,track:track,duration:duration})},Link.libraryLink=function(username,category){return new Link(Link.Type.LIBRARY,{username:username,category:category})},Link.temporaryPlaylistLink=function(origin,data){return new Link(Link.Type.TEMP_PLAYLIST,{origin:origin,data:data})},Link.contextGroupLink=function(origin,name){return new Link(Link.Type.CONTEXT_GROUP,{origin:origin,name:name})},Link.profileLink=function(username,id){return new Link(Link.Type.PROFILE,{username:username,args:id})},Link.imageLink=function(id){return new Link(Link.Type.IMAGE,{id:id})},Link.mosaicLink=function(ids){return new Link(Link.Type.MOSAIC,{ids:ids})},Link.radioLink=function(args){return args="undefined"==typeof args?[]:args,new Link(Link.Type.RADIO,{args:args})},Link.applicationLink=function(id,args){return args="undefined"==typeof args?[]:args,new Link(Link.Type.APPLICATION,{id:id,args:args})},Link.fromByteString=function(type,idByteString,opt_args){for(var bytes=[],i=0;i<idByteString.length;i++)bytes.push(idByteString.charCodeAt(i));var id=Spotify.Utils.Base62.fromBytes(bytes,22);id=Spotify.Utils.Base62.toHex(id);var args=opt_args||{};return args.id=id,new Link(type,args)},Link.encodeComponent=_encodeComponent,Link.decodeComponent=_decodeComponent,Link.Format=Format}(),function(){var _instance;Spotify.Logging.Types=function(){return"undefined"!=typeof _instance?_instance:_instance={TRACK_END:"TRACK_END",PREVIEW_END:"PREVIEW_END",TRACK_EVENT:"TRACK_EVENT",TRACK_PROGRESS:"TRACK_PROGRESS",REQUEST_TIME:"REQUEST_TIME",AD_END:"EndAd"}}}(),Spotify.Logging.TrackEnd=function(){Spotify.EventTarget.call(this);var _gateway,_logEvents=!1,_onLogSuccess=function(result){},_onLogError=function(error){};this.serviceIsReady=!0,this.log=function(args){(_logEvents||args.ms_played)&&_gateway.rpc("track_end",[args.lid,args.ms_played,args.ms_played_union,args.n_seeks_forward,args.n_seeks_backward,args.ms_seeks_forward,args.ms_seeks_backward,args.ms_latency,args.display_track,args.play_context,args.source_start,args.source_end,args.reason_start,args.reason_end,args.referrer,args.referrer_version,args.referrer_vendor,args.max_continuous,args.gaia_dev_id,args.accepted_tc],_onLogSuccess,_onLogError,this,!0,2,"track_end")},this.init=function(gateway){_gateway=gateway},this.setTrackEventLogger=function(trackEventLogger){trackEventLogger.bindOnce("TRACK_EVENT",function(){_logEvents=!0})}},Spotify.Logging.PreviewEnd=function(){Spotify.EventTarget.call(this);new Spotify.Logging.Logger;this.serviceIsReady=!0,this.log=function(args){},this.init=function(){}},Spotify.Logging.TrackEvent=function(){Spotify.EventTarget.call(this);var _gateway,_onLogSuccess=function(result){},_onLogError=function(error){};this.serviceIsReady=!0,this.log=function(args){_gateway.rpc("track_event",[args.lid,args.event,args.ms_where],_onLogSuccess,_onLogError,this,!0,2,"track_event"),this.trigger("TRACK_EVENT")},this.init=function(gateway){_gateway=gateway}},Spotify.Logging.TrackProgress=function(){Spotify.EventTarget.call(this);var _gateway,_debugger=Spotify.DebuggerJS,_onLogSuccess=function(result){_debugger.log("Spotify.Logging.TrackProgress",["Track progress success",result],"corejs")},_onLogError=function(error){_debugger.error("Spotify.Logging.TrackProgress",["On track progress error",error],"corejs")};this.serviceIsReady=!0,this.log=function(args){_gateway.rpc("track_progress",[args.lid,args.source_start,args.reason_start,args.ms_played,args.ms_latency,args.play_context,args.display_track,args.referrer,args.referrer_version,args.referrer_vendor],_onLogSuccess,_onLogError,this,!0,2,"track_progress")},this.init=function(gateway){_gateway=gateway}},Spotify.Logging.ClientEvent=function(){this.log=function(args,opt_callback,opt_errback){this.services.logging_logger.logClientEvent(args,opt_callback,opt_errback)}},Spotify.Logging.AdEnd=function(){Spotify.EventTarget.call(this);var _gateway,_debugger=Spotify.DebuggerJS,_onLogSuccess=function(result){},_onLogError=function(error){};this.serviceIsReady=!0,this.log=function(args){var END_AD_MESSAGE_VERSION="5",args_for_server=[String(END_AD_MESSAGE_VERSION),String(args.ad_file_id),String(args.song_id),String(args.source_start),String(args.reason_start),String(args.source_end),String(args.reason_end),String(args.bytes_played),String(args.content_length),String(args.ms_played),String(args.ms_played_union),String(args.ms_rcv_latency),String(args.n_seeks_backward),String(args.ms_seeks_backward),String(args.n_seeks_forward),String(args.ms_seeks_forward),String(args.ms_latency),String(args.num_stutter),String(args.p_lowbuffer),String(args.skipped),String(args.clicked),String(args.token),String(args.last_stream_started_at),String(args.client_ad_count),String(args.client_campaign_count)];_gateway.rpc("log_ad",args_for_server,_onLogSuccess,_onLogError,this,!0,2,"log_ad"),_debugger.log("Spotify.Logging.AdEnd",["EndAd",args_for_server],"corejs")},this.init=function(gateway){_gateway=gateway}},Spotify.Logging.View=function(){var _onLogSuccess=function(result){},_onLogError=function(error){};this.log=function(uri,view_version,view_vendor,duration){if("string"!=typeof uri)throw new Error("Uri must be a string");if("string"!=typeof view_version)throw new Error("View version must be a string");if("string"!=typeof view_vendor)throw new Error("View vendor must be a string");if("number"!=typeof duration)throw new Error("Duration must be a number");var req=new Spotify.Calls.Simple({method:"log_view",payload:[uri,view_version,view_vendor,duration],context:this,persistent:!0,retries:2,type:"log_view"},_onLogSuccess,_onLogError);this.send(req)}},function(){var _instance;Spotify.Logging.Logger=function(){if("undefined"!=typeof _instance)return _instance;_instance=this;var _debugger=Spotify.DebuggerJS,_events=new Spotify.Events,_requestTimeRateLimiter=new Spotify.RateLimiter(3e4,100),_requestTimeCalls={},CLIENT_EVENT_MESSAGE_TYPE=(new Spotify.RateLimiter(3e4,100),151),CLIENT_EVENT_MESSAGE_VERSION=3,BANNER_SHOWN_MESSAGE_VERSION=5,BANNER_SHOWN_REQUIRED_FIELDS=["ad_id","campaign_id","duration","token"],JS_EXCEPTIONS_MESSAGE_TYPE=202,JS_EXCEPTIONS_MESSAGE_VERSION=1,REQUEST_TIME_MESSAGE_TYPE=30,REQUEST_TIME_MESSAGE_VERSION=1,STUTTER_MESSAGE_TYPE=31,STUTTER_MESSAGE_VERSION=3,AGGREGATED_REQUEST_LATENCIES_TYPE=232,AGGREGATED_REQUEST_LATENCIES_MESSAGE_VERSION=1,END_PREVIEW_MESSAGE_TYPE=216,END_PREVIEW_MESSAGE_VERSION=1,WINDOW_SIZE_MESSAGE_TYPE=41,WINDOW_SIZE_MESSAGE_VERSION=1,_onLogSuccess=function(result){_debugger.log("Spotify.Logging.Logger",["Logging was successfull",result],"corejs")},_onLogError=function(error){_debugger.error("Spotify.Logging.Logger",["Logging was NOT successfull",error],"corejs")},_pick=function(value,defaultValue){return void 0===value||null===value?defaultValue:value};this.logClientEvent=function(args,opt_callback,opt_errback){if("string"!=typeof args.source)throw new Error("Source must be a string");if("string"!=typeof args.context&&(args.context=""),"string"!=typeof args.event)throw new Error("Event name must be a string");if("string"!=typeof args.event_version&&(args.event_version=""),"string"!=typeof args.test_version&&(args.test_version=""),"string"!=typeof args.source_version)throw new Error("Source version name must be a string");if("string"!=typeof args.source_vendor)throw new Error("Source vendor name must be a string");"string"!=typeof args.data&&(args.data=JSON.stringify(args.data)||"{}");var req=new Spotify.Calls.Simple({method:"log",payload:[CLIENT_EVENT_MESSAGE_TYPE,CLIENT_EVENT_MESSAGE_VERSION,args.source,args.context,args.event,args.event_version,args.test_version,args.source_version,args.source_vendor,args.data],context:this,persistent:!0,retries:2,type:"ClientEvent"},opt_callback||_onLogSuccess,opt_errback||_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["Logged client event",req],"corejs")},this.logJSExceptions=function(module,message,url,lineNumber){if("undefined"!=typeof module&&"undefined"!=typeof message&&"undefined"!=typeof url&&"undefined"!=typeof lineNumber){var req=new Spotify.Calls.Simple({method:"log",payload:[JS_EXCEPTIONS_MESSAGE_TYPE,JS_EXCEPTIONS_MESSAGE_VERSION,module,message,url,lineNumber],context:this,persistent:!0,retries:2,type:"js_exceptions"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["js_exceptions",arguments],"corejs")}},this.logWindowSize=function(width,height){var req=new Spotify.Calls.Simple({method:"log",
payload:[WINDOW_SIZE_MESSAGE_TYPE,WINDOW_SIZE_MESSAGE_VERSION,width,height,0,0],context:this,persistent:!0,retries:0,type:"window_size"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["window_size",arguments],"corejs")},this.logRequestTime=function(type,first_byte,last_byte,size,error){if("undefined"!=typeof type&&"undefined"!=typeof first_byte&&"undefined"!=typeof last_byte&&"undefined"!=typeof size&&"undefined"!=typeof error){var req=new Spotify.Calls.Simple({method:"log",payload:[REQUEST_TIME_MESSAGE_TYPE,REQUEST_TIME_MESSAGE_VERSION,type,first_byte,last_byte,size,error],context:this,persistent:!0,retries:2,type:"request_time"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["request_time",arguments],"corejs")}},this.logStutter=function(data){if("undefined"!=typeof data.fileId&&"undefined"!=typeof data.playbackId&&"undefined"!=typeof data.songId&&"undefined"!=typeof data.bufferSize&&"undefined"!=typeof data.maxBufferSize&&"undefined"!=typeof data.fileByteOffset&&"undefined"!=typeof data.fileByteTotal&&"undefined"!=typeof data.targetBuffer){var req=new Spotify.Calls.Simple({method:"log",payload:[STUTTER_MESSAGE_TYPE,STUTTER_MESSAGE_VERSION,data.fileId,data.playbackId,data.songId,data.bufferSize,data.maxBufferSize,data.fileByteOffset,data.fileByteTotal,data.targetBuffer],context:this,persistent:!0,retries:2,type:"request_time"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["stutter",arguments],"corejs")}},this.logEndPreview=function(reason_start,reason_end,ms_played,ms_latency,bitrate,audiocodec,play_context,play_track,display_track){var req=new Spotify.Calls.Simple({method:"log",payload:[END_PREVIEW_MESSAGE_TYPE,END_PREVIEW_MESSAGE_VERSION,reason_start,reason_end,ms_played,ms_latency,bitrate,audiocodec,play_context,play_track,display_track],context:this,persistent:!0,retries:2,type:"end_preview"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["end_preview",arguments],"corejs")},this.logBannerShown=function(logEntry){for(var i=0,l=BANNER_SHOWN_REQUIRED_FIELDS.length;l>i;i++)if(!logEntry.hasOwnProperty(BANNER_SHOWN_REQUIRED_FIELDS[i]))return void _onLogError("required logEntry parameter missing: "+BANNER_SHOWN_REQUIRED_FIELDS[i]);var argsForServer=[BANNER_SHOWN_MESSAGE_VERSION,logEntry.ad_id,logEntry.campaign_id,logEntry.token,Math.floor(logEntry.duration),_pick(logEntry.window_width,0),_pick(logEntry.window_height,0),_pick(logEntry.original_width,0),_pick(logEntry.original_height,0),_pick(logEntry.available_width,0),_pick(logEntry.available_height,0),String(!!logEntry.ad_clicked),_pick(logEntry.error,""),_pick(logEntry.seconds_lost,0),_pick(logEntry.time_started,0),_pick(logEntry.client_ad_count,0),_pick(logEntry.client_campaign_count,0)],req=new Spotify.Calls.Simple({method:"log_bannershown",payload:argsForServer,context:this,persistent:!0,retries:2,type:"log_bannershown"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["banner_shown",argsForServer],"corejs")},this.logAggregatedRequestTime=function(type,latency){"undefined"!=typeof type&&"undefined"!=typeof latency&&(_requestTimeRateLimiter.addToBucket({messageType:REQUEST_TIME_MESSAGE_TYPE,messageVersion:REQUEST_TIME_MESSAGE_VERSION,type:type,latency:latency}),_startRequestTimeRateLimiter())},this.log=function(messageType,messageVersion){var args=Array.prototype.slice.call(arguments);if("undefined"!=typeof messageType&&"undefined"!=typeof messageVersion){var req=new Spotify.Calls.Simple({method:"log",payload:args,context:this,persistent:!0,retries:2,type:"log"},_onLogSuccess,_onLogError);this.send(req),_debugger.log("Spotify.Logging.Logger",["Log",args],"corejs")}};var _startRequestTimeRateLimiter=function(){_requestTimeRateLimiter.isStarted()||_requestTimeRateLimiter.start()},_onRequestTimeRateLimitCall=function(event){var call=event.params;"undefined"==typeof _requestTimeCalls[call.type]&&(_requestTimeCalls[call.type]={min:Number.MAX_VALUE,max:0,sum:0,sumpow2:0,count:0,mean:0,std_deviation:0}),_requestTimeCalls[call.type].count++,_requestTimeCalls[call.type].sum+=call.latency,_requestTimeCalls[call.type].sumpow2+=Math.pow(call.latency,2),_requestTimeCalls[call.type].min>call.latency&&(_requestTimeCalls[call.type].min=call.latency),_requestTimeCalls[call.type].max<call.latency&&(_requestTimeCalls[call.type].max=call.latency)},_onRequestTimeAfterAllRateLimitedCalls=function(event){for(var method in _requestTimeCalls){var rq=_requestTimeCalls[method];rq.mean=Math.floor(rq.sum/rq.count),rq.std_deviation=Math.floor(Math.sqrt(rq.sumpow2-Math.pow(rq.mean,2),2));var req=new Spotify.Calls.Simple({method:"log",payload:[AGGREGATED_REQUEST_LATENCIES_TYPE,AGGREGATED_REQUEST_LATENCIES_MESSAGE_VERSION,method,rq.count,rq.sum,rq.sumpow2,rq.min,rq.max,rq.mean,rq.std_deviation],context:this,persistent:!0,retries:2,type:"aggregated_request_latencies"},_onLogSuccess,_onLogError);this.send(req)}_debugger.log("Spotify.Logging.Logger",["Aggregated Request Latencies",_requestTimeCalls],"corejs"),_requestTimeCalls={},_startRequestTimeRateLimiter()};this.setup=function(){_requestTimeRateLimiter.bind(_events.RATE_LIMIT_CALL,_onRequestTimeRateLimitCall,this),_requestTimeRateLimiter.bind(_events.RATE_LIMIT_AFTER_INTERVAL,_onRequestTimeAfterAllRateLimitedCalls,this)}}}(),Spotify.PlayerTracker=function(identifier,player,username){Spotify.EventTarget.call(this),this.id=identifier;var _self,_trackUri,_trackUrl,_debugger=Spotify.DebuggerJS,_needsAnEndUnion=!1,EVENT_RECONNECT_PLAYING=1,EVENT_RECONNECT_PAUSED=2,EVENT_PLAY=3,EVENT_PAUSE=4,PLAYING_LOG_INTERVAL=15e3,TOTAL_TIMES_TO_LOG_THE_PROGRESS_OF_A_SONG=4,_username=username,_events=new Spotify.Events,_player=player,_loggers={},_max_continuous=0,_ms_played=0,_ms_played_union=0,_position=0,_segments=[],_numberOfSeeksForward=0,_numberOfSeeksBackward=0,_numberMSOfSeeksForward=0,_numberMSOfSeeksBackward=0,_timestampForTrackPlayRequest=0,_playLatency=0,_display_track="",_play_context="unknown",_source_start="unknown",_source_end="unknown",_reason_start="unknown",_reason_end="unknown",_referrer="unknown",_referrer_version="unknown",_referrer_vendor="unknown",_accepted_tc="na",_gaia_dev_id="none",_lid="",_loggingTypes=new Spotify.Logging.Types,_cache=new Spotify.Cache.Default(100,new Spotify.Cache.LocalStorage("tracker")),_persistentCacheIsSupported=!1,_shoudUseCachedData=!1,_isAd=!1,_isPreview=!1,_tempLogData={},_tempEndLogData={},_timesItLoggedTheProgressOfTheCurrentSong=0,_lastRoundedMSPlayed=-1,_sendEndSongOrProgressData=function(logType){var loggers=_loggers[logType],i=0,args={};if(""!==_lid||""===_lid&&_isPreview){for(_ms_played_union=_shoudUseCachedData?_ms_played_union:_calculateUnion(_segments),_display_track=_display_track||"",_play_context=_play_context||"unknown",_source_start=_source_start||"unknown",_reason_start=_reason_start||"unknown",_referrer=_referrer||"unknown",_referrer_version=_referrer_version||"unknown",_referrer_vendor=_referrer_vendor||"unknown",0!==_numberOfSeeksForward||0!==_numberOfSeeksBackward||logType!==_loggingTypes.TRACK_END&&logType!==_loggingTypes.AD_END||(_ms_played=_ms_played_union,_max_continuous=_ms_played),logType===_loggingTypes.AD_END&&void 0!==_player.ad?(args.ad_file_id=_player.ad.file_id,args.song_id=_player.ad.ad_id,args.bytes_played=0,args.content_length=0,args.ms_rcv_latency=0,args.num_stutter=0,args.p_lowbuffer=0,args.skipped=0,args.last_stream_started_at=new Date(_timestampForTrackPlayRequest).toISOString(),args.token=_player.ad.token,args.clicked=_player.ad.has_been_clicked?1:0,args.client_ad_count=_player.ad.adPlayCount,args.client_campaign_count=_player.ad.campaignPlayCount,args.source_start="pendad",args.source_end="trackdone",args.reason_end="albumtrackdone"):logType===_loggingTypes.TRACK_END?(args.lid=_lid,args.source_start=_source_start,args.source_end=_source_end,args.reason_end=_reason_end):logType===_loggingTypes.TRACK_PROGRESS?(args.lid=_lid,args.play_track=_trackUri,args.source_start=_source_start,args.bitrate=_player.bitrate,args.audiocodec=_player.audiocodec):logType===_loggingTypes.PREVIEW_END&&(args.bitrate=_player.bitrate,args.audiocodec=_player.audiocodec,args.reason_end=_reason_end),args.max_continuous=_max_continuous,args.ms_played=_ms_played,args.ms_played_union=_ms_played_union,args.n_seeks_forward=_numberOfSeeksForward,args.n_seeks_backward=_numberOfSeeksBackward,args.ms_seeks_forward=_numberMSOfSeeksForward,args.ms_seeks_backward=_numberMSOfSeeksBackward,args.ms_latency=_playLatency,args.display_track=_display_track,args.play_context=_play_context,args.reason_start=_reason_start,args.referrer=_referrer,args.referrer_version=_referrer_version,args.referrer_vendor=_referrer_vendor,args.gaia_dev_id=_gaia_dev_id,args.accepted_tc=_accepted_tc;i<loggers.length;i++)loggers[i].log(args);logType===_loggingTypes.AD_END&&void 0!==_player.ad&&(_shoudUseCachedData||_self.trigger(_events.RECORD_AD_EVENT,{playerId:_player.id,adUri:"spotify:ad:"+_player.ad.file_id,type:"impression"}),delete _player.ad),_shoudUseCachedData&&(_shoudUseCachedData=!1),_debugger.log("Spotify.PlayerTracker",["Logging song data -> Type:",logType,"-> Arguments:",args," of player",_player.id],"corejs")}},_logTrackEvent=function(event){var args,loggers=_loggers[_loggingTypes.TRACK_EVENT],i=0;if(""!==_lid)for(args={lid:_lid,event:event,ms_where:_player.position()};i<loggers.length;i++)loggers[i].log(args)},_logTrackProgress=function(){_player.isPreview||_sendEndSongOrProgressData(_loggingTypes.TRACK_PROGRESS)},_onPlayerState=function(event){_ms_played+=event.params.interval,_position=_player.getPlayerState().position;var roundedMSPlayed=1e3*Math.floor(.001*_ms_played);(roundedMSPlayed%PLAYING_LOG_INTERVAL===0||1e3>_ms_played)&&TOTAL_TIMES_TO_LOG_THE_PROGRESS_OF_A_SONG>_timesItLoggedTheProgressOfTheCurrentSong&&(_isAd||_lastRoundedMSPlayed!==roundedMSPlayed&&(_logTrackProgress(),_timesItLoggedTheProgressOfTheCurrentSong++,_lastRoundedMSPlayed=roundedMSPlayed))},_setUnionStart=function(time){_segments.push({type:"START",time:parseInt(time,10)}),_needsAnEndUnion=!0},_setUnionEnd=function(time){_segments.push({type:"END",time:parseInt(time,10)}),_needsAnEndUnion=!1},_onCacheInitialized=function(){_debugger.log("Spotify.PlayerTracker",["Cache is initialized..."],"corejs"),_persistentCacheIsSupported=!0,_getStoredEndSongDataFromCache()},_onCacheError=function(){_persistentCacheIsSupported=!1},_onEndSongDataStoredSuccess=function(event){_debugger.log("Spotify.PlayerTracker",["endSongData are now stored",arguments],"corejs")},_onEndSongDataStoredError=function(event){_debugger.error("Spotify.PlayerTracker",["endSongData are NOT stored",arguments],"corejs")},_onEndSongDataRetrievedSuccess=function(key,value){null!==value&&(_cache.remove(key,_onEndSongDataRemovedSuccess,_self),_parseCachedData(value),_shoudUseCachedData=!0,_sendEndSongOrProgressData(_isAd?_loggingTypes.AD_END:_isPreview?_loggingTypes.PREVIEW_END:_loggingTypes.TRACK_END),_resetTrackingData())},_onEndSongDataRemovedSuccess=function(){},_parseCachedData=function(values){try{values=JSON.parse(Spotify.Utils.Base64.decode(values))}catch(err){values={}}_isAd=values.isAd,_isAd&&(_player.ad||(_player.ad={}),_player.ad.file_id=values.ad_file_id,_player.ad.ad_id=values.ad_id,_timestampForTrackPlayRequest=values.last_stream_started_at,_player.ad.token=values.token,_player.ad.has_been_clicked=values.clicked,_player.ad.adPlayCount=values.client_ad_count,_player.ad.campaignPlayCount=values.client_campaign_count),_lid=values.lid,_isPreview=values.isPreview,_max_continuous=values.max_continuous,_ms_played_union=values.ms_played_union,_ms_played=values.ms_played,_numberOfSeeksForward=values.n_seeks_forward,_numberOfSeeksBackward=values.n_seeks_backward,_numberMSOfSeeksForward=values.ms_seeks_forward,_numberMSOfSeeksBackward=values.ms_seeks_backward,_playLatency=values.ms_latency,_display_track=values.display_track,_play_context=values.play_context,_source_start=values.source_start,_source_end=values.source_end,_reason_start=values.reason_start,_reason_end=values.reason_end,_referrer=values.referrer,_referrer_version=values.referrer_version,_referrer_vendor=values.referrer_vendor,_gaia_dev_id=values.gaia_dev_id,_accepted_tc=values.accepted_tc},_resetTrackingData=function(){_isAd=!1,_isPreview=!1,_lid="",_ms_played=0,_trackUri="",_trackUrl="",_max_continuous=0,_ms_played_union=0,_segments=[],_numberOfSeeksForward=0,_numberOfSeeksBackward=0,_numberMSOfSeeksForward=0,_numberMSOfSeeksBackward=0,_playLatency=0,_display_track="",_play_context="unknown",_source_start="unknown",_source_end="unknown",_reason_start="unknown",_reason_end="unknown",_referrer="unknown",_referrer_version="unknown",_referrer_vendor="unknown",_gaia_dev_id="none",_accepted_tc="na"},_sortByTime=function(a,b){return a.time-b.time},_calculateUnion=function(segments){for(var union=0,count=0,start=0,i=0,l=0,current_result=0;l<segments.length;l++)l%2!==0&&"undefined"!=typeof segments[l-1]&&"START"===segments[l-1].type&&(current_result=segments[l].time-segments[l-1].time,_max_continuous=current_result>_max_continuous?current_result:_max_continuous);for(_debugger.log("Spotify.PlayerTracker",["max continuous",_max_continuous],"corejs"),segments.sort(_sortByTime);i<segments.length;i++)"START"===segments[i].type&&(0===count&&(start=i),++count),"END"===segments[i].type&&(--count,0===count&&(union+=segments[i].time-segments[start].time));return _debugger.log("Spotify.PlayerTracker",["Union calculated:",union,"Segments:",segments],"corejs"),union},_addEventListeners=function(){_debugger.log("Spotify.PlayerTracker",["Binding event listeners"],"corejs"),_player.bind(_events.POSITION_CHANGED,_onPositionChanged,_self),_player.bind(_events.PLAYING,_onPlaying,_self),_player.bind(_events.PAUSED,_onPause,_self),_player.bind(_events.INVALID_TRACK_URI,_onInvalidTrackUri,_self),_player.bind(_events.PLAYBACK_FAILED,_onPlaybackFailed,_self),_player.bind(_events.TRACK_PLAY_REQUEST,_onPlayRequest,_self),_player.bind(_events.SONG_LOADED,_onSongLoaded,_self),_player.bind(_events.LOAD,_onLoaded,_self),_player.bind(_events.PLAYER_STATE,_onPlayerState,_self)},_removeEventListeners=function(){_debugger.log("Spotify.PlayerTracker",["Unbind event listeners"],"corejs"),_player.unbind(_events.POSITION_CHANGED,_onPositionChanged,_self),_player.unbind(_events.PLAYING,_onPlaying,_self),_player.unbind(_events.PAUSED,_onPause,_self),_player.unbind(_events.INVALID_TRACK_URI,_onInvalidTrackUri,_self),_player.unbind(_events.PLAYBACK_FAILED,_onPlaybackFailed,_self),_player.unbind(_events.TRACK_PLAY_REQUEST,_onPlayRequest,_self),_player.unbind(_events.SONG_LOADED,_onSongLoaded,_self),_player.unbind(_events.LOAD,_onLoaded,_self),_player.unbind(_events.PLAYER_STATE,_onPlayerState,_self)},_storeEndSongData=function(){_setUnionEnd(_position);var args={};_isAd?(args.ad_file_id=_player.ad.file_id,args.lid=_player.ad.ad_id,args.last_stream_started_at=_timestampForTrackPlayRequest,args.token=_player.ad.token,args.clicked=_player.ad.has_been_clicked,args.client_ad_count=_player.ad.adPlayCount,args.client_campaign_count=_player.ad.campaignPlayCount,args.source_start="pendad"):(args.source_start=_source_start||"unknown",args.lid=_lid),args.isAd=_isAd,args.isPreview=_isPreview,args.source_end=args.source_start,args.max_continuous=_max_continuous,args.ms_played=_ms_played,args.ms_played_union=_calculateUnion(_segments),args.n_seeks_forward=_numberOfSeeksForward,args.n_seeks_backward=_numberOfSeeksBackward,args.ms_seeks_forward=_numberMSOfSeeksForward,args.ms_seeks_backward=_numberMSOfSeeksBackward,args.ms_latency=_playLatency,args.display_track=_display_track||"",args.play_track=args.display_track,args.play_context=_play_context||"unknown",args.reason_start=_reason_start||"unknown",args.reason_end="reload",args.referrer=_referrer||"unknown",args.referrer_version=_referrer_version||"unknown",args.referrer_vendor=_referrer_vendor||"unknown",args.accepted_tc=_accepted_tc||"na",args.gaia_dev_id=_gaia_dev_id||"none",_cache.put(Spotify.Utils.Base64.encode(_username)+":stats:"+_player.id,Spotify.Utils.Base64.encode(JSON.stringify(args)),_onEndSongDataStoredSuccess,_onEndSongDataStoredError,null,this)},_logEndSongData=function(){_debugger.log("Spotify.PlayerTracker",["Union End from _logEndSongData",_position],"corejs"),_setUnionEnd(_position),_sendEndSongOrProgressData(_isAd?_loggingTypes.AD_END:_isPreview?_loggingTypes.PREVIEW_END:_loggingTypes.TRACK_END),_resetTrackingData()},_onPositionChanged=function(){if(""!==_lid){_debugger.log("Spotify.PlayerTracker",["Tracking the position changed event of player",_player.id],"corejs");var newPosition=parseInt(_player.getPlayerState().position,10);newPosition!==_position&&(_needsAnEndUnion&&(_debugger.log("Spotify.PlayerTracker",["Union End from _onPositionChanged",_position],"corejs"),_setUnionEnd(_position)),newPosition>_position?(_numberOfSeeksForward++,_numberMSOfSeeksForward+=newPosition-_position,_debugger.log("Spotify.PlayerTracker",["Went forward",newPosition-_position,"ms"],"corejs")):_position>newPosition&&(_numberOfSeeksBackward++,_numberMSOfSeeksBackward+=_position-newPosition,_debugger.log("Spotify.PlayerTracker",["Went back",_position-newPosition,"ms"],"corejs")),_position=newPosition,_debugger.log("Spotify.PlayerTracker",["Union Start from _onPositionChanged",_position],"corejs"),_setUnionStart(_position))}};this.onConnected=function(){_debugger.log("Spotify.PlayerTracker",["Tracking the on connect event"],"corejs"),""!==_lid&&(_player.isPlaying?(_debugger.log("Spotify.PlayerTracker",["Tracking the reconnect while playing event"],"corejs"),_logTrackEvent(EVENT_RECONNECT_PLAYING)):_player.isPaused&&(_debugger.log("Spotify.PlayerTracker",["Tracking the reconnect while being paused event"],"corejs"),_logTrackEvent(EVENT_RECONNECT_PAUSED)))};var _onPlayRequest=function(event){_timestampForTrackPlayRequest=event.params.timestamp},_onSongLoaded=function(event){_debugger.log("Spotify.PlayerTracker",["Tracking the on song loaded event",event],"corejs")},_onLoaded=function(event){_debugger.log("Spotify.PlayerTracker",["Tracking the on load event of player",_player.id],"corejs"),_lid=_player.lid,_trackUri=_player.trackUri,_isAd=_player.isAd,_isPreview=_player.isPreview,_playLatency=(new Date).getTime()-_timestampForTrackPlayRequest,_display_track=_tempLogData.display_track||"",_play_context=_tempLogData.play_context||"unknown",_source_start=_tempLogData.source_start||"unknown",_reason_start=_tempLogData.reason_start||"unknown",_referrer=_tempLogData.referrer||"unknown",_referrer_version=_tempLogData.referrer_version||"unknown",_referrer_vendor=_tempLogData.referrer_vendor||"unknown",_accepted_tc=_tempLogData.accepted_tc||"na",_position=_player.getPlayerState().position,_debugger.log("Spotify.PlayerTracker",["Union Start from _onLoaded",_position],"corejs"),_setUnionStart(_position)},_onPlaying=function(){_player.getPlayerState().position;_logTrackEvent(EVENT_PLAY),_debugger.log("Spotify.PlayerTracker",["Tracking the on play event of player",_player.id],"corejs")},_onPause=function(){_logTrackEvent(EVENT_PAUSE),_debugger.log("Spotify.PlayerTracker",["Tracking the on pause event of player",_player.id],"corejs")},_onInvalidTrackUri=function(){_debugger.log("Spotify.PlayerTracker",["Tracking the invalid track uri event of player",_player.id],"corejs")},_onPlaybackFailed=function(){_resetTrackingData(),_debugger.log("Spotify.PlayerTracker",["Tracking the playback failed event of player",_player.id],"corejs")};this.setEndSongStartLog=function(logData){"undefined"!=typeof logData&&(_tempLogData=logData)},this.setEndSongStopLog=function(logData){"undefined"!=typeof logData&&(_source_end=logData.source_end||"unknown",_reason_end=logData.reason_end||"unknown",_tempEndLogData=logData)};var _getStoredEndSongDataFromCache=function(){_persistentCacheIsSupported&&_cache.get(Spotify.Utils.Base64.encode(_username)+":stats:"+_player.id,_onEndSongDataRetrievedSuccess,_self)};this.getTempData=function(){return _tempLogData},this.getTempEndData=function(){return _tempEndLogData},this.stopTrackingAndLog=function(){_debugger.log("Spotify.PlayerTracker",["Stopping tracking and logging",_player.id],"corejs"),_timesItLoggedTheProgressOfTheCurrentSong=0,_lastRoundedMSPlayed=-1,_logEndSongData()},this.dispose=function(dontStoreData){_debugger.log("Spotify.PlayerTracker",["Disposing tracker with id",this.id],"corejs"),dontStoreData="undefined"!=typeof dontStoreData?dontStoreData:!1,dontStoreData||_storeEndSongData(),_removeEventListeners()},this.addLogger=function(type,logger){"undefined"==typeof _loggers[type]&&(_loggers[type]=[]),_loggers[type].push(logger)},this.initialize=function(){_self=this,_cache.initialize(_onCacheInitialized,_onCacheError,this),_addEventListeners()}},Spotify.Protobuf.Ieee754=function(){function ln2(x){for(var estimate=Math.log(x)*INV_LN2|0,pow=Math.pow(2,estimate),i=estimate;x>=pow;++i,pow*=2);return i-1}function decodeFloat(x){if(0===x)return 0;var sign=x>>>31,exp=x>>23&255,mantissa=8388607&x;return 255!=exp?exp?(1-(sign<<1))*Math.pow(2,exp-127-23)*((1<<23)+mantissa):mantissa?(1-(sign<<1))*Math.pow(2,-149)*mantissa:0:0===mantissa?(1-(sign<<1))*(1/0):NaN}function encodeFloat(n){if(0===n)return 1/n===-(1/0)?-2147483648:0;if(n!==n)return 2147483647;if(2*n!==n){var sign=0>n,abs=Math.abs(n),exp=ln2(abs)+127;if(!(exp>0)){var mantissa=abs*Math.pow(2,149)&8388607;return sign<<31|mantissa}if(255>exp){var mantissa=abs*Math.pow(2,150-exp)&8388607;return sign<<31|exp<<23|mantissa}}return 0>n?-8388608:2139095040}var exports={},INV_LN2=1/Math.LN2;return exports.decodeFloat=decodeFloat,exports.encodeFloat=encodeFloat,exports}(),Spotify.Protobuf.Parser=function(){function FieldDescriptorProto(){}function parseField(t){var label=fieldLabelMap[t.current.value],typeName=t.next().value,name=t.next().value;t.expectToken("=");var number=~~t.next().value;return t.skipUntil(";"),{name:name,number:number,label:label,type:nativeTypeMap[typeName],type_name:nativeTypeMap[typeName]?void 0:typeName,default_value:void 0}}function parseMessage(t,result){var result={name:t.next().value,field:[],nested_type:[],enum_type:[]};for(t.expectToken("{");"}"!=t.next().type;)switch(t.current.value){case"optional":case"repeated":case"required":result.field.push(parseField(t));break;case"message":result.nested_type.push(parseMessage(t));break;case"enum":result.enum_type.push(parseEnum(t));break;case"extensions":t.skipUntil(";");break;case";":break;default:t.fail("Unrecognized message token: "+t.current.value)}return result}function parseEnum(t){var typeName=t.next().value;t.expectToken("{");for(var value=[];"}"!=t.next().type;){var name=t.current.value;t.expectToken("=");var number=~~t.next().value;value.push({name:name,number:number}),t.skipUntil(";")}return{name:typeName,value:value}}function parseFile(t){for(var result={message_type:[],enum_type:[]};t.next().type!=EOF;)switch(t.current.value){case"package":case"option":t.skipUntil(";");break;case"message":result.message_type.push(parseMessage(t));break;case"enum":result.enum_type.push(parseEnum(t));break;default:t.fail("Unrecognized proto token: "+t.current.value)}return result}var exports={},EOF="",WORD="word",STRING="string",singleCharTokens="{}[]=;",whitespaceChars=" 	\r\n",nonValidWord=singleCharTokens+whitespaceChars+"/";FieldDescriptorProto.Label={LABEL_OPTIONAL:1,LABEL_REQUIRED:2,LABEL_REPEATED:3},FieldDescriptorProto.Type={TYPE_DOUBLE:1,TYPE_FLOAT:2,TYPE_INT64:3,TYPE_UINT64:4,TYPE_INT32:5,TYPE_FIXED64:6,TYPE_FIXED32:7,TYPE_BOOL:8,TYPE_STRING:9,TYPE_MESSAGE:11,TYPE_BYTES:12,TYPE_UINT32:13,TYPE_ENUM:14,TYPE_SFIXED32:15,TYPE_SFIXED64:16,TYPE_SINT32:17,TYPE_SINT64:18};var Tokenizer=function(text){this.text=text,this.ptr=0,this.current={value:"",type:EOF,ptr:0}};Tokenizer.prototype={where:function(ptr){for(var ptr=void 0===ptr?this.current.ptr:ptr,line=0,linePtr=-1;linePtr&&ptr>=linePtr;)linePtr=this.text.indexOf("\n",linePtr)+1,++line;return"line: "+line},fail:function(message,ptr){throw this.where(ptr)+": "+message},skipWhitespace:function(){for(var c=this.text[this.ptr];c&&-1!=whitespaceChars.indexOf(c);)c=this.text[++this.ptr]},skipLineComment:function(){for(var c=this.text[this.ptr];c&&"\r"!==c&&"\n"!==c;)c=this.text[++this.ptr];"\r"===c&&(c=this.text[++this.ptr]),"\n"===c&&++this.ptr},skipBlockComment:function(){for(var savePtr=this.ptr,c=this.text[this.ptr],asterix=!1;c&&(!asterix||"/"!==c);)asterix="*"===c,c=this.text[++this.ptr];c||this.fail("Expected end of block comment",savePtr),++this.ptr},skipUntil:function(token){for(var savePtr=this.ptr;this.next().type!==token;)this.current.type===EOF&&this.fail("Expected: "+token+"(Unexpected end of data)",savePtr)},expectToken:function(token){this.next().type!==token&&this.fail("Expected: "+token)},extractWord:function(){for(var startPtr=this.ptr,c=this.text[this.ptr];c&&-1===nonValidWord.indexOf(c);)c=this.text[++this.ptr];this.current.type=WORD,this.current.value=this.text.substring(startPtr,this.ptr)},extractString:function(){var endPtr=this.text.indexOf('"',this.ptr+1);this.current.type=STRING,this.current.value=this.text.substring(this.ptr+1,endPtr-1),this.ptr=endPtr+1},next:function(){this.skipWhitespace();for(var c=this.text[this.ptr];"/"===c;)c=this.text[++this.ptr],"/"===c?(++this.ptr,this.skipLineComment()):"*"===c?(++this.ptr,this.skipBlockComment()):this.fail("Expecting // or /*",this.ptr-1),this.skipWhitespace(),c=this.text[this.ptr];return this.current.ptr=this.ptr,this.ptr>=this.text.length?(this.current.value="",this.current.type=EOF):-1!==singleCharTokens.indexOf(c)?(this.current.value=this.current.type=c,++this.ptr):'"'===c?this.extractString():this.extractWord(),this.current}};var fieldLabelMap={optional:"LABEL_OPTIONAL",required:"LABEL_REQUIRED",repeated:"LABEL_REPEATED"},nativeTypeMap={"double":"TYPE_DOUBLE","float":"TYPE_FLOAT",int64:"TYPE_INT64",uint64:"TYPE_UINT64",int32:"TYPE_INT32",fixed64:"TYPE_FIXED64",fixed32:"TYPE_FIXED32",bool:"TYPE_BOOL",string:"TYPE_STRING",bytes:"TYPE_BYTES",uint32:"TYPE_UINT32",sfixed32:"TYPE_SFIXED32",sfixed64:"TYPE_SFIXED64",sint32:"TYPE_SINT32",sint64:"TYPE_SINT64"};return exports.parseFileDescriptor=function(prototext){return parseFile(new Tokenizer(prototext))},exports.FieldDescriptorProto=FieldDescriptorProto,exports}(),Spotify.Protobuf.Serialization=function(){function exception(type){var Exception=function(msg){this.msg=msg};return Exception.prototype.toString=function(){return this.msg?type+": "+this.msg:type},Exception}function assert(c,msg){if(!c)throw msg||"Assert fail"}function OutputStream(){this._data=[]}function InputStream(data,offset,length){this._data=data,this._ptr=offset,this._end=this._ptr+length}function toZigZag(x){return x<<1^x>>31}function fromZigZag(x){return x>>>1^-(1&x)}function utf8Encode(str){for(var result=[],i=0;i<str.length;++i){var code=str.charCodeAt(i);if(128>code)result.push(code);else{if(55296===(64512&code)){var tmp=str.charCodeAt(++i);assert(56320===(64512&tmp),"Inproperly encoded surrogate pair"),code=((1023&code)<<10|1023&tmp)+65536}2048>code?(result.push(192|code>>6),result.push(128|63&code)):65536>code?(result.push(224|code>>12),result.push(128|code>>6&63),result.push(128|63&code)):(assert(1114112>code,"Invalid unicode"),result.push(240|code>>18),result.push(128|code>>12&63),result.push(128|code>>6&63),result.push(128|63&code))}}return result}function bytesEncode(str){for(var result=[],i=0;i<str.length;++i)result.push(str.charCodeAt(i));return result}function fieldOut(self,field,value,ostream){switch(field.type){case"int32":ostream.writeVarint(field.id<<3|0),ostream.writeVarint64(value>>31,value);break;case"uint32":ostream.writeVarint(field.id<<3|0),ostream.writeVarint(~~value);break;case"sint32":ostream.writeVarint(field.id<<3|0),ostream.writeVarint(toZigZag(value));break;case"fixed32":case"sfixed32":ostream.writeVarint(field.id<<3|5),ostream.writeFixed32(value);break;case"float":ostream.writeVarint(field.id<<3|5),ostream.writeFixed32(_ieee754.encodeFloat(value));break;case"int64":case"uint64":ostream.writeVarint(field.id<<3|0),ostream.writeVarint64(Math.floor(value/4294967296),~~value);break;case"sint64":ostream.writeVarint(field.id<<3|0);var abs=Math.abs(value)-(0>value);ostream.writeVarint64(Math.floor(abs/2147483648),(abs<<1)+(0>value));break;case"fixed64":case"sfixed64":ostream.writeVarint(field.id<<3|1),ostream.writeFixed64(Math.floor(value/4294967296),value);break;case"bool":ostream.writeVarint(field.id<<3|0),ostream.writeVarint(value?1:0);break;case"string":ostream.writeVarint(field.id<<3|2);var data=utf8Encode(value);ostream.writeVarint(data.length),ostream.writeAll(data);break;case"bytes":ostream.writeVarint(field.id<<3|2);var data=bytesEncode(value);ostream.writeVarint(data.length),ostream.writeAll(data);break;case"*":for(var i=0;i<value.length;++i)fieldOut(self,field.subField,value[i],ostream);break;case"#":assert(field.enumMap.toNumber.hasOwnProperty(value),"value "+value+" not in enum");var number=field.enumMap.toNumber[value];ostream.writeVarint(field.id<<3|0),ostream.writeVarint64(number>>31,number);break;default:if(self.hasOwnProperty(field.type)){var tmp=new OutputStream;self[field.type].serializeToStream(value,tmp),ostream.writeVarint(field.id<<3|2),ostream.writeVarint(tmp._data.length),ostream.writeAll(tmp._data)}else assert(!1,"Unsupported type "+field.type)}}function stringFromCharCode(data){if(data.length<STRING_CHUNK_SIZE)return String.fromCharCode.apply(String,data);var ptr=0,result=[];do result.push(String.fromCharCode.apply(String,data.slice(ptr,ptr+STRING_CHUNK_SIZE))),ptr+=STRING_CHUNK_SIZE;while(ptr<data.length);return result.join("")}function decodeUtf8Version1(data){for(var result=[],i=0;i<data.length;){var code=data.charCodeAt(i++);if(128>code)result.push(data[i-1]);else{if(128===(192&code))throw new BadDataError("Invalid utf-8");var bytes;if(224>code)code&=-225,bytes=2;else if(240>code)code&=-241,bytes=3;else{if(code>=248)throw new BadDataError("Invalid utf-8");code&=-249,bytes=4}for(;--bytes&&i<data.length;){var tmp=data.charCodeAt(i++);if(128!==(192&tmp))throw new BadDataError("Invalid utf-8");code=code<<6|-193&tmp}if(bytes)throw new BadDataError("Unexpected end of utf-8");if(65536>code)result.push(String.fromCharCode(code));else{if(code>=1114112)throw new BadDataError("Invalid utf-8");code-=65536,result.push(String.fromCharCode(55296|code>>10,56320|1023&code))}}}return result.join("")}function decodeUtf8Version2(data){return decodeURIComponent(escape(data))}function unsign(x){return 2*(x>>>1)+(1&x)}function fieldIn(self,field){var name=field.name;switch(field.type){case"int32":return function(wireType,istream,result,key){return 0===wireType?(result[name||key]=istream.readVarint(),!0):!1};case"uint32":return function(wireType,istream,result,key){return 0===wireType?(result[name||key]=unsign(istream.readVarint()),!0):!1};case"sint32":return function(wireType,istream,result,key){return 0===wireType?(result[name||key]=fromZigZag(istream.readVarint()),!0):!1};case"fixed32":return function(wireType,istream,result,key){return 5===wireType?(result[name||key]=istream.readFixed32(),!0):!1};case"sfixed32":return function(wireType,istream,result,key){return 5===wireType?(result[name||key]=~~istream.readFixed32(),!0):!1};case"float":return function(wireType,istream,result,key){return 5===wireType?(result[name||key]=_ieee754.decodeFloat(istream.readFixed32()),!0):!1};case"int64":return function(wireType,istream,result,key){if(0===wireType){var i=istream.readVarint64();return result[name||key]=4294967296*i.hi+unsign(i.lo),!0}return!1};case"uint64":return function(wireType,istream,result,key){if(0===wireType){var i=istream.readVarint64();return result[name||key]=4294967296*unsign(i.hi)+unsign(i.lo),!0}return!1};case"sint64":return function(wireType,istream,result,key){if(0===wireType){var i=istream.readVarint64(),abs=2147483648*unsign(i.hi)+(i.lo>>>1);return result[name||key]=1&i.lo?-1-abs:abs,!0}return!1};case"fixed64":return function(wireType,istream,result,key){
if(1===wireType){var i=istream.readFixed64();return result[name||key]=4294967296*i.hi+i.lo,!0}return!1};case"sfixed64":return function(wireType,istream,result,key){if(1===wireType){var i=istream.readFixed64();return result[name||key]=4294967296*~~i.hi+i.lo,!0}return!1};case"bool":return function(wireType,istream,result,key){return 0===wireType?(result[name||key]=0!==istream.readVarint(),!0):!1};case"string":return function(wireType,istream,result,key){if(2===wireType){var length=istream.readVarint();return result[name||key]=decodeUtf8(istream.bytes(length)),!0}return!1};case"bytes":return function(wireType,istream,result,key){if(2===wireType){var length=istream.readVarint();return result[name||key]=istream.bytes(length),!0}return!1};case"*":var subFieldIn=fieldIn(self,field.subField);return name?function(wireType,istream,result,key){var target;return target=result[name]?result[name]:result[name]=[],subFieldIn(wireType,istream,target,target.length)}:function(wireType,istream,result,key){var target;return target=result[key]?result[key]:result[key]=[],subFieldIn(wireType,istream,target,target.length)};case"#":var enumMap=field.enumMap.toName;return function(wireType,istream,result,key){if(0===wireType){var number=istream.readVarint64().lo;return enumMap.hasOwnProperty(number)?result[name||key]=enumMap[number]:result[name||key]=number,!0}return!1}}return function(wireType,istream,result,key){if(2===wireType){var length=istream.readVarint(),substream=istream.substream(length);return self[field.type].parseFromStream(substream,result[name||key]={}),!0}return!1}}function fieldSkip(wireType,istream){switch(wireType){case 0:istream.skipVarint();break;case 1:istream.skip(8);break;case 2:var length=istream.readVarint();istream.skip(length);break;case 3:case 4:throw new BadDataError("Deprecated wire type");case 5:istream.skip(4);break;default:throw new BadDataError("Unsupported wire type")}}function StreamSerializer(schema){for(var _self=this,i=0;i<schema.length;++i)!function(message){for(var fieldIdMap=[],fieldNameMap={},fields=message.fields,j=0;j<fields.length;++j){var field=fields[j];if("*"===field.type[0]){var subField={type:field.type.substr(1),id:field.id,enumMap:field.enumMap};field={type:"*",id:field.id,name:field.name,subField:subField}}fieldIdMap[field.id]=fieldIn(_self,field),fieldNameMap[field.name]=field}_self[message.name]={serializeToStream:function(data,ostream){for(var key in data)if(fieldNameMap.hasOwnProperty(key)){var field=fieldNameMap[key];fieldOut(_self,field,data[key],ostream)}},parseFromStream:function(istream,data){for(;!istream.empty();){var code=istream.readVarint(),id=code>>>3,wireType=7&code,field=fieldIdMap[id];try{field&&field(wireType,istream,data)||fieldSkip(wireType,istream)}catch(e){throw _debugger.error("Spotify.Protobuf.Serialization",["Error in",message,id,wireType],"corejs"),e}}},serializeToString:function(data,callback){callback(serializeToStringSync(data))},serializeToStringSync:function(data){var stream=new OutputStream;return _self[message.name].serializeToStream(data,stream),stream.toString()},parseFromString:function(str,callback){callback(parseFromStringSync(str))},parseFromStringSync:function(str){var stream=new InputStream(str,0,str.length),result={};return _self[message.name].parseFromStream(stream,result),result}}}(schema[i])}function resolveEnum(name,ns,enums){return enums.hasOwnProperty(ns+name)?enums[ns+name]:enums.hasOwnProperty(name)?enums[name]:null}function fieldDescriptorToJson(descriptor,enumIsInt,enums,ns){var type,enumMap=null;if(descriptor.type_name)enumMap=resolveEnum(descriptor.type_name,ns,enums),type=enumMap?enumIsInt?"int32":"#":descriptor.type_name;else if(type=nativeTypeMap[descriptor.type],!type)throw new UnsupportedError(descriptor.type);var r="LABEL_REPEATED"===descriptor.label?"*":"";return{id:descriptor.number,type:r+type,name:descriptor.name,typeName:descriptor.type_name,enumMap:enumMap}}function descriptorToJson(descriptor,enumIsInt,enums,ns){for(var result={name:descriptor.name,fields:[]},i=0;i<descriptor.field.length;++i)result.fields.push(fieldDescriptorToJson(descriptor.field[i],enumIsInt,enums,ns+descriptor.name+"."));return result}function enumToJson(name,enumValues){for(var toName={},toNumber={},i=0;i<enumValues.length;++i){var value=enumValues[i];toName[value.number]=value.name,toNumber[value.name]=value.number}return{name:name,toName:toName,toNumber:toNumber}}function gatherEnums(enumDescriptors,enums,ns){for(var i=0;i<enumDescriptors.length;++i){var name=ns+enumDescriptors[i].name;enums[name]=enumToJson(name,enumDescriptors[i].value)}}function gatherFlatenedEnums(descriptors,enums,ns){for(var i=0;i<descriptors.length;++i){var childNs=ns+descriptors[i].name+".";gatherFlatenedEnums(descriptors[i].nested_type,enums,childNs),gatherEnums(descriptors[i].enum_type,enums,childNs)}}function fileDescriptorToJson(fileDescriptor,enumIsInt){var schema=[],enums={};gatherEnums(fileDescriptor.enum_type,enums,""),gatherFlatenedEnums(fileDescriptor.message_type,enums,"");for(var i=0;i<fileDescriptor.message_type.length;++i)schema.push(descriptorToJson(fileDescriptor.message_type[i],enumIsInt,enums,""));return schema}var exports={},_debugger=Spotify.DebuggerJS,_ieee754=Spotify.Protobuf.Ieee754,BadDataError=exception("BadDataError"),OutOfDataError=exception("OutOfDataError"),UnsupportedError=exception("UnsupportedError");OutputStream.prototype.write=function(b){this._data.push(b)},OutputStream.prototype.writeAll=function(bytes){Array.prototype.push.apply(this._data,bytes)},OutputStream.prototype.writeVarint=function(x){for(assert(~~x===x,"Unexpected argument to OutputStream.writeVarint");-128&x;)this.write(127&x|128),x>>>=7;this.write(x)},OutputStream.prototype.writeVarint64=function(hi,lo){return hi?(this.write(127&lo|128),this.write(lo>>>7&127|128),this.write(lo>>>14&127|128),this.write(lo>>>21&127|128),void(-8&hi?(this.write(127&(hi<<4|lo>>>28)|128),this.writeVarint(hi>>>3)):this.write(127&(hi<<4|lo>>>28)))):void this.writeVarint(lo)},OutputStream.prototype.writeFixed32=function(x){this.write(255&x),this.write(x>>>8&255),this.write(x>>>16&255),this.write(x>>>24&255)},OutputStream.prototype.writeFixed64=function(hi,lo){this.writeFixed32(lo),this.writeFixed32(hi)},OutputStream.prototype.toString=function(){return stringFromCharCode(this._data)},InputStream.prototype.check=function(){if(this._ptr>this._data.length)throw new OutOfDataError;if(this._ptr>this._end)throw new BadDataError("Reading out of bounds")},InputStream.prototype.empty=function(){return this._ptr>=this._end},InputStream.prototype.skipVarint=function(skip){for(;this._data.charCodeAt(this._ptr++)>=128;);this.check()},InputStream.prototype.readVarint=function(){var result=0,shift=1;do{var b=this._data.charCodeAt(this._ptr++);result|=(127&b)*shift,shift*=128}while(b>=128);return this.check(),result};var Int64=function(){this.hi=0,this.lo=0};Int64.prototype={};var tmp64=new Int64;InputStream.prototype.readVarint64=function(){var hi=0,shiftHi=1/4294967296,lo=0,shiftLo=1;do{var b=this._data.charCodeAt(this._ptr++);hi|=(127&b)*shiftHi,lo|=(127&b)*shiftLo,shiftHi*=128,shiftLo*=128}while(b>=128);return this.check(),tmp64.hi=hi,tmp64.lo=lo,tmp64},InputStream.prototype.readFixed32=function(){var a=this._data.charCodeAt(this._ptr++),b=this._data.charCodeAt(this._ptr++),c=this._data.charCodeAt(this._ptr++),d=this._data.charCodeAt(this._ptr++);this.check();var result=a+256*b+65536*c+d*(1<<24);return result},InputStream.prototype.readFixed64=function(){return tmp64.lo=this.readFixed32(),tmp64.hi=this.readFixed32(),tmp64},InputStream.prototype.skip=function(length){this._ptr+=length,this.check()},InputStream.prototype.substream=function(length){var ptr=this._ptr;return this._ptr+=length,new InputStream(this._data,ptr,length)},InputStream.prototype.bytes=function(length){var ptr=this._ptr;return this._ptr+=length,this.check(),this._data.substr(ptr,length)};var STRING_CHUNK_SIZE=4096,decodeUtf8=decodeURIComponent&&escape?decodeUtf8Version2:decodeUtf8Version1,nativeTypeMap={TYPE_INT32:"int32",TYPE_SINT32:"sint32",TYPE_UINT32:"uint32",TYPE_FIXED32:"fixed32",TYPE_SFIXED32:"sfixed32",TYPE_FLOAT:"float",TYPE_STRING:"string",TYPE_BYTES:"bytes",TYPE_BOOL:"bool",TYPE_DOUBLE:"double",TYPE_INT64:"int64",TYPE_UINT64:"uint64",TYPE_SINT64:"sint64",TYPE_FIXED64:"fixed64",TYPE_SFIXED64:"sfixed64"};return exports.fileDescriptorToJson=fileDescriptorToJson,exports.createFromJson=function(schema){return new StreamSerializer(schema)},exports.createFromFileDescriptor=function(fileDescriptor,enumIsInt32){var schema=fileDescriptorToJson(fileDescriptor,void 0===enumIsInt32?!1:enumIsInt32);return new StreamSerializer(schema)},exports}(),Spotify.Heartbeat=function(){var _INTERVAL=3e4,_events=new Spotify.Events,_timeoutId=null,_self=this,CALL_TYPE="heartbeat";this.start=function(){this.stop(),_timeoutId=setInterval(_beat,_INTERVAL)},this.stop=function(){null!==_timeoutId&&(clearInterval(_timeoutId),_timeoutId=null)};var _onRPCSuccess=function(){},_onRPCError=function(){},_beat=function(){var req=new Spotify.Calls.Simple({method:"echo",payload:["h"],context:_self,persistent:!1,retries:0,type:CALL_TYPE},_onRPCSuccess,_onRPCError);_self.send(req)};this.onNotify=function(event){switch(event.type){case _events.DISCONNECTED:this.stop();break;case _events.CONNECTED:this.start()}}},Spotify.Gateway=function(br){Spotify.EventTarget.call(this);var _debugger=Spotify.DebuggerJS,_logger=new Spotify.Logging.Logger,_bridgeIsReady=!1,_events=new Spotify.Events,_self=this;this.isReady=!1,this.bridge=null;var _callsManager,_connectionManager,_rateLimiter,_firstTimeNotification=!1,_rateLimitReached=!1,RATE_LIMIT_WAIT=1e3,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL=90;this.isConnected=!1,this.rpc=function(method,params,callback,errback,context,persistent,retries,callType){var requestId;return requestId=_callsManager.addCall(method,params,callback,errback,context,persistent,retries,callType),_debugger.log("Spotify.Gateway",["Call with method",method,"calltype",callType,"params",params,"and request id",requestId,"was executed"],"corejs"),this.isConnected?void(_rateLimitReached?_rateLimiter.addToBucket(requestId):this.bridge.rpc(method,params,requestId)):(persistent?_callsManager.setPersistent(requestId,!0):_callsManager.setPersistent(requestId,!1),void _connectionManager.reset())},this.disconnect=function(){this.isConnected=!1,this.bridge.disconnect()},this.connect=function(ap,credentials){this.bridge.connect(credentials,ap)};var _onRPCConnected=function(event){this.isConnected=!0},_onTimeout=function(event){_debugger.log("Spotify.Gateway",["onTimeout",event],"corejs")},_onHermesB64Message=function(event){_self.trigger(_events.HERMES_B64_MESSAGE,event.params)},_onUserInfoChange=function(event){_self.trigger(_events.USER_INFO_CHANGE)},_onLoginComplete=function(args){_firstTimeNotification=!0;try{_logger.logWindowSize(window.innerWidth,window.innerHeight)}catch(e){}_runPersistentCalls(),_runOngoingCalls(),_self.trigger(_events.CONNECTED)},_runPersistentCalls=function(){for(var call,i=0,persistentCalls=_callsManager.getPersistentCalls(),length=persistentCalls.length;length>i;i++)call=persistentCalls[i],_self.rpc(call.method,call.params,call.callback,call.errback,call.context,call.persistent)},_runOngoingCalls=function(){for(var call,i=0,ongoingCalls=_callsManager.getCalls(),length=ongoingCalls.length;length>i;i++)call=ongoingCalls[i],"work_done"!==call.method&&_self.rpc(call.method,call.params,call.callback,call.errback,call.context,call.persistent,call.retries--)},_onRPCDisconnected=function(event){this.isConnected=!1,_self.trigger(_events.FAILED_CONNECTING,event.params)},_informForConnectionRetry=function(){this.isConnected===!0&&_self.trigger(_events.ON_TRY_TO_CONNECT)},_onNotifyOfDisconnection=function(event){_self.trigger(_events.DISCONNECTED,event.params)},_onConnectionError=function(){_self.trigger(_events.ON_TRY_TO_CONNECT)},_onRPCCallback=function(event){var latency,callbackObject=_callsManager.getCall(event.params.requestId);"undefined"!=typeof callbackObject&&(latency=(new Date).getTime()-callbackObject.timestamp,_debugger.log("Spotify.Gateway",["Latency of call with request id",event.params.requestId,"is",latency,"ms"],"corejs"),callbackObject.callback.call(callbackObject.context,event.params),"request_time"!==callbackObject.callType&&"aggregated_request_latencies"!==callbackObject.callType&&"userdata"!==callbackObject.callType&&"log_view"!==callbackObject.callType&&"track_end"!==callbackObject.callType&&"track_progress"!==callbackObject.callType&&"end_preview"!==callbackObject.callType&&"log_ad"!==callbackObject.callType&&"js_exceptions"!==callbackObject.callType&&"log"!==callbackObject.callType&&"log_ce"!==callbackObject.callType&&_logger.logAggregatedRequestTime(callbackObject.callType,latency))},_onRPCErrorCallback=function(event){var response=[],removeFromBucket=!0;_debugger.error("Spotify.Gateway",["Got an RPC Error",event],"corejs"),"undefined"!=typeof event.params.response&&(response=event.params.response),response.length>=3&&(response[0]!==Spotify.Errors.Domains.HERMES_ERROR&&response[0]!==Spotify.Errors.Domains.HERMES_SERVICE_ERROR||response[1]!==Spotify.Errors.Codes.HM_TOO_MANY_REQUESTS&&response[1]!==Spotify.Errors.Codes.HM_FAILED_TO_SEND_TO_BACKEND||(removeFromBucket=!1));var latency,callbackObject=_callsManager.getCall(event.params.requestId,removeFromBucket);"undefined"!=typeof callbackObject&&(latency=(new Date).getTime()-callbackObject.timestamp,_debugger.log("Spotify.Gateway",["Latency of call with request id",event.params.requestId,"is",latency,"ms"],"corejs"),response.length>=3?response[0]!==Spotify.Errors.Domains.HERMES_ERROR&&response[0]!==Spotify.Errors.Domains.HERMES_SERVICE_ERROR||response[1]!==Spotify.Errors.Codes.HM_TOO_MANY_REQUESTS?response[0]!==Spotify.Errors.Domains.HERMES_ERROR&&response[0]!==Spotify.Errors.Domains.HERMES_SERVICE_ERROR||response[1]!==Spotify.Errors.Codes.HM_TIMEOUT&&response[1]!==Spotify.Errors.Codes.HM_FAILED_TO_SEND_TO_BACKEND||!(callbackObject.retries>0)?(response.push(event.params.method),callbackObject.errback.call(callbackObject.context,new Spotify.Errors.Error(response))):_self.rpc(callbackObject.method,callbackObject.params,callbackObject.callback,callbackObject.errback,callbackObject.context,callbackObject.persistent,callbackObject.retries-1,callbackObject.callType):(_enableRateLimiting(),_rateLimiter.addToBucket(event.params.requestId)):(_debugger.log("Spotify.Gateway",["RPC Error callback for method with id:",callbackObject.callType,callbackObject.params],"corejs"),callbackObject.errback.call(callbackObject.context,new Spotify.Errors.Error([1,0,"",event.params]))),"request_time"!==callbackObject.callType&&"aggregated_request_latencies"!==callbackObject.callType&&"userdata"!==callbackObject.callType&&"log_view"!==callbackObject.callType&&"track_end"!==callbackObject.callType&&"track_progress"!==callbackObject.callType&&"end_preview"!==callbackObject.callType&&"log_ad"!==callbackObject.callType&&"js_exceptions"!==callbackObject.callType&&"log"!==callbackObject.callType&&"log_ce"!==callbackObject.callType&&_logger.logAggregatedRequestTime(callbackObject.callType,latency))},_checkAndTriggerIfReady=function(){_bridgeIsReady&&(_self.isReady=!0,_self.trigger(_events.READY))},_onBridgeReady=function(event){_bridgeIsReady=!0,_checkAndTriggerIfReady()},_onFlashEvent=function(event){this.trigger(event.type,event.params)},_onTokenLost=function(event){_self.trigger(_events.TOKEN_LOST)},_onAlbumArt=function(event){window.eval(event.params[1][1])},_enableRateLimiting=function(event){_rateLimitReached=!0,_rateLimiter.start()},_onRateLimitCall=function(event){var requestId=event.params,call=_callsManager.getCall(requestId,!1);_debugger.log("Spotify.Gateway",["onRateLimitCall Will try run the callback with id",requestId,call],"corejs"),call&&_self.bridge.rpc(call.method,call.params,requestId)},_onRateLimitCallDisabled=function(event){_rateLimitReached=!1},_onWork=function(event){_self.trigger(event.type,event.params)},_onPasswordChanged=function(event){this.dispose(),this.trigger(event.type,event)};this.dispose=function(){this.bridge.unbind(_events.CONNECTION_ESTABLISHED,_onRPCConnected,this),this.bridge.unbind(_events.FAILED_CONNECTING,_onRPCDisconnected,this),this.bridge.unbind(_events.RPC_CALLBACK,_onRPCCallback,this),this.bridge.unbind(_events.RPC_ERRBACK,_onRPCErrorCallback,this),this.bridge.unbind(_events.TOKEN_LOST,_onTokenLost,this),this.bridge.unbind(_events.HERMES_B64_MESSAGE,_onHermesB64Message,this),this.bridge.unbind(_events.USER_INFO_CHANGE,_onUserInfoChange,this),this.bridge.unbind(_events.LOGIN_COMPLETE,_onLoginComplete,this),this.bridge.unbind(_events.TIMEOUT,_onTimeout,this),this.bridge.unbind(_events.READY,_onBridgeReady,this),this.bridge.unbind(_events.FLASH_AVAILABLE,_onFlashEvent,this),this.bridge.unbind(_events.FLASH_UNAVAILABLE,_onFlashEvent,this),this.bridge.unbind(_events.FLASH_ERROR,_onFlashEvent,this),this.bridge.unbind(_events.WORK,_onWork,this),this.bridge.unbind(_events.PING_FLASH,_onWork,this),this.bridge.unbind(_events.PING_FLASH2,_onWork,this),this.bridge.unbind(_events.PASSWORD_CHANGED,_onPasswordChanged,this),this.bridge.unbind(_events.WEBSOCKET_ERROR,_onConnectionError,this),_connectionManager.unbind(_events.ON_TRY_TO_CONNECT,_informForConnectionRetry,this),_connectionManager.unbind(_events.NOTIFY_OF_DISCONNECT,_onNotifyOfDisconnection,this),this._bridge=null,_connectionManager=null},this.initialize=function(id,settings){_callsManager=new Spotify.CallsManager,_rateLimiter=new Spotify.RateLimiter(RATE_LIMIT_WAIT,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL),_rateLimiter.bind(_events.RATE_LIMIT_CALL,_onRateLimitCall,this),_rateLimiter.bind(_events.RATE_LIMIT_DISABLED,_onRateLimitCallDisabled,this),this.bridge=new Spotify.WebSockets.Bridge(id),this.bridge.bind(_events.CONNECTION_ESTABLISHED,_onRPCConnected,this),this.bridge.bind(_events.FAILED_CONNECTING,_onRPCDisconnected,this),this.bridge.bind(_events.RPC_CALLBACK,_onRPCCallback,this),this.bridge.bind(_events.RPC_ERRBACK,_onRPCErrorCallback,this),this.bridge.bind(_events.TOKEN_LOST,_onTokenLost,this),this.bridge.bind(_events.HERMES_B64_MESSAGE,_onHermesB64Message,this),this.bridge.bind(_events.USER_INFO_CHANGE,_onUserInfoChange,this),this.bridge.bind(_events.LOGIN_COMPLETE,_onLoginComplete,this),this.bridge.bind(_events.TIMEOUT,_onTimeout,this),this.bridge.bind(_events.READY,_onBridgeReady,this),this.bridge.bind(_events.FLASH_AVAILABLE,_onFlashEvent,_self),this.bridge.bind(_events.FLASH_UNAVAILABLE,_onFlashEvent,_self),this.bridge.bind(_events.FLASH_ERROR,_onFlashEvent,_self),this.bridge.bind(_events.WORK,_onWork,_self),this.bridge.bind(_events.PING_FLASH,_onWork,_self),this.bridge.bind(_events.PING_FLASH2,_onWork,_self),this.bridge.bind(_events.PASSWORD_CHANGED,_onPasswordChanged,_self),this.bridge.bind(_events.ALBUM_ART,_onAlbumArt,_self),this.bridge.bind(_events.WEBSOCKET_ERROR,_onConnectionError,this),_connectionManager=new Spotify.ConnectionManager,_connectionManager.bind(_events.ON_TRY_TO_CONNECT,_informForConnectionRetry,this),_connectionManager.bind(_events.NOTIFY_OF_DISCONNECT,_onNotifyOfDisconnection,this),_connectionManager.initialize(this.bridge),this.bridge.initialize()}},Spotify.Audio.TrackLoadParams={},Spotify.Audio.AudioStream=function(id,playerType,playerinterface){Spotify.EventTarget.call(this);var HEAD_FILE_CDN="http://dubdh08jn1h4j.cloudfront.net/mp3head/";this.id=id,this.lid="",this.isReady=!0,this.isAd=!1,this.isPreview=!1,this.trackUri="",this.trackUrl="",this.bitrate=160,this.audiocodec="mp3",this.isPlaying=!1,this.isPaused=!1,this.isStopped=!0,this.isLoaded=!1,this.isActive=!1,this.limit=-1;var _fileId,_trackingIntervalId,_timePlaying=0,_previousTrackingInterval=0,_howManyMSBeforeEndToNotify=-1,TRACKING_INTERVAL=500,_resolvers={},_masterVolume=1,_self=this,_interface=playerinterface,_unencryptedPlayer=new Spotify.HTML5.PlayerInterface,_debugger=Spotify.DebuggerJS,_logger=new Spotify.Logging.Logger,_events=new Spotify.Events,_tempTrackUri="",_whereToStartPlayFrom=0,_autoplay=!1,_volume=1,_duration=0,_position=0,_beforeEndHasBeenTriggeredOnce=!1,_onPlayerEvent=function(event){switch(_debugger.log("Spotify.Audio.AudioStream",["Player event:",_self.id,event],"corejs"),event.type){case _events.READY:_self.isReady=!0,_self.isLoaded&&_self.load(_self.trackUri,_fileId,_position,!_self.isPaused);break;case _events.NOT_READY:_self.isReady=!1,_stopStateTracking();break;case _events.DURATION:_duration=event.params,_debugger.log("Spotify.Audio.AudioStream",["Got duration",event.params],"corejs");break;case _events.STUTTER_DATA:var data=event.params;_debugger.log("Spotify.Audio.AudioStream",["STUTTER_DATA Event:"],"corejs"),data.fileId=_fileId,data.playbackId=[_fileId,Date.now()].join("_"),data.songId=_self.trackUri,_logger.logStutter(data);break;case _events.LOAD:_clearStateTracking(),_duration=0,_self.isPaused=!0,_self.isStopped=!1,_self.isPlaying=!1,_self.isLoaded=!0,_self.onLoad(event);break;case _events.TRACK_PLAY_REQUEST:break;case _events.PLAYING:_startStateTracking(),_self.isPaused=!1,_self.isStopped=!1,_self.isPlaying=!0,_self.isActive||_self.trigger(_events.ACTIVE_PLAYER_CHANGED,{id:_self.id}),_self.onPlay(event);break;case _events.PAUSED:_stopStateTracking(),_self.isPaused=!0,_self.isStopped=!1,_self.isPlaying=!1,_self.onPause(event);break;case _events.STOPPED:_self.isPaused=!1,_self.isStopped=!0,_self.isPlaying=!1,_self.isLoaded=!1,_self.onStop(event),_clearStateTracking();break;case _events.BEFORE_SEEK:_self.isPlaying&&_stopStateTracking();break;case _events.POSITION_CHANGED:_position=parseInt(event.params,10),_self.isPlaying&&_startStateTracking(),_self.onPositionChanged(event);break;case _events.TRACK_ENDED:_clearStateTracking(),_self.isPaused=!1,_self.isStopped=!0,_self.isPlaying=!1,_self.isLoaded=!0,_self.stop(),_self.onTrackEnded(event);break;case _events.SONG_LOADED:_self.onSongLoaded(event);break;case _events.PLAYBACK_FAILED:_clearStateTracking(),_self.isStopped=!0,_self.isPaused=!1,_self.isPlaying=!1,_self.isLoaded=!1,_self.onPlaybackFailed(event);break;case _events.INVALID_TRACK_URI:_clearStateTracking(),_self.onPlaybackFailed(event)}},_onHTML5PlayerEvents=function(event){event.extra===_self.id&&_self.trigger(event.type,event.params)},_onUnencryptedEvent=function(event){_onPlayerEvent(event),_self.trigger(event.type,event.params,event.extra)};this.loadFromParams=function(args){var trackUri=args.trackUri,fileId=args.opt_fileId,position=args.offset,autoplay=args.autoplay,limit=args.duration,crossfadeBuffer=args.crossfadeBuffer;_fileId=fileId,(_self.isPaused||_self.isPlaying)&&_self.stop(),_debugger.log("Spotify.Audio.AudioStream",["Load track",trackUri],"corejs");var resolver,link=new Spotify.Link.fromString(trackUri);"undefined"!=typeof limit?this.limit=limit:this.limit=-1,_howManyMSBeforeEndToNotify="undefined"!=typeof crossfadeBuffer?crossfadeBuffer:-1,this.isPreview=!1,this.isAd=!1,"audiofile"===link.type?(this.isPreview=!0,this.isAd=!1):"ad"===link.type&&(this.isPreview=!1,this.isAd=!0),this.trigger(_events.TRACK_PLAY_REQUEST,{timestamp:(new Date).getTime()}),position=position||0,_whereToStartPlayFrom=this.isAd?0:position,_autoplay="undefined"==typeof autoplay?!1:autoplay,_tempTrackUri=trackUri,resolver=this.isAd?_resolvers[Spotify.Resolvers.AD_RESOLVER]:this.isPreview?_resolvers[Spotify.Resolvers.PREVIEW_RESOLVER]:_resolvers[Spotify.Resolvers.STORAGE_RESOLVER],resolver.onReady(function(){try{resolver.list(trackUri,playerType===Spotify.PlayerTypes.FLASH_RTMPS?"rtmp":"",fileId||null,_onSongUriResults,_onSongUriError)}catch(err){_debugger.error("Spotify.Audio.AudioStream",[err.message,err.stack],"corejs")}},this)},this.load=function(trackUri,position,autoplay,limit,howManyMSBeforeEndToNotify){this.loadFromParams({trackUri:trackUri,offset:position,autoplay:autoplay,duration:limit,crossfadeBuffer:howManyMSBeforeEndToNotify})};var _onSongUriResults=function(event){function gotArt(path){Spotify.Utils.cb=null,extra.key=path,_interface.load(_self.id,_self.trackUrl,extra)}var file;_self.lid=event.lid,_self.trackUrl=event.uri,_self.trackUri=_tempTrackUri,Spotify.Utils.cb=null,_self.isPreview||_self.isAd?file=_self.trackUrl:(Spotify.Utils.cb=gotArt,file=HEAD_FILE_CDN+_fileId),_debugger.log("Spotify.Audio.AudioStream",["Got a result from the resolver",event],"corejs");var extra={autoplay:_autoplay,startFrom:_whereToStartPlayFrom,server:event.server,protocol:event.protocol};_self.isPreview?_interface.load(_self.id,file,extra):_self.isAd&&_unencryptedPlayer.load(_self.id,file,extra),_position=_whereToStartPlayFrom,_autoplay=!1,_whereToStartPlayFrom=0},_onSongUriError=function(event){_self.lid="",_self.trackUrl="",_self.trackUri="",_tempTrackUri="",_whereToStartPlayFrom=0,_debugger.error("Spotify.Audio.AudioStream",["Got an error from the storage resolver",event],"corejs"),_self.trigger(_events.INVALID_TRACK_URI,event)},_startStateTracking=function(){_stopStateTracking(),_trackingIntervalId=setInterval(_onStateTracking,TRACKING_INTERVAL)},_stopStateTracking=function(){_trackingIntervalId&&(clearInterval(_trackingIntervalId),_trackingIntervalId=null),_previousTrackingInterval=0},_clearStateTracking=function(){_stopStateTracking(),_timePlaying=0,_beforeEndHasBeenTriggeredOnce=!1},_onStateTracking=function(){var now=(new Date).getTime(),interval=now-(0===_previousTrackingInterval?now-TRACKING_INTERVAL:_previousTrackingInterval),state=_getPlayerStateFromInterface(),duration=state.duration;_previousTrackingInterval=now,_self.trigger(_events.PLAYER_STATE,{state:state,interval:interval}),_debugger.log("Spotify.Audio.AudioStream",["Tracking state:",state,interval],"corejs"),-1!==_self.limit&&(duration=_self.limit),_position>=duration-_howManyMSBeforeEndToNotify-TRACKING_INTERVAL&&-1!==_howManyMSBeforeEndToNotify&&(_beforeEndHasBeenTriggeredOnce||(_debugger.log("Spotify.Audio.AudioStream",["BEFORE_END event",state.position,state.duration],"corejs"),_beforeEndHasBeenTriggeredOnce=!0,_self.trigger(_events.BEFORE_END))),_timePlaying+=interval,_timePlaying>=_self.limit&&-1!==_self.limit&&(_self.trigger(_events.TRACK_ENDED,{},_self.id),_self.stop())},_getPlayerStateFromInterface=function(){var state;return state=_self.isAd?_unencryptedPlayer.getPlayerState(_self.id):_interface.getPlayerState(_self.id),_position=state.position,_duration=state.duration,state.isPlaying=_self.isPlaying,state.isStopped=_self.isStopped,state.isPaused=_self.isPaused,state};this.play=function(position,limit){"undefined"!=typeof limit&&-1!==limit&&(this.limit=limit),_self.isReady&&(_timePlaying=0,_self.isAd?_unencryptedPlayer.play(_self.id,position):_interface.play(this.id,position))},this.pause=function(){_self.isPlaying&&(_self.isAd?_unencryptedPlayer.pause(_self.id):_interface.pause(this.id))},this.resume=function(){!_self.isPlaying&&_self.isPaused&&_self.isLoaded&&(_self.isAd?_unencryptedPlayer.resume(_self.id):_interface.resume(this.id))},this.stop=function(){_self.isLoaded&&(this.limit=-1,_howManyMSBeforeEndToNotify=-1,_self.isAd?_unencryptedPlayer.stop(_self.id):_interface.stop(this.id),this.trigger(_events.STOPPED,{},this.id))},this.playpause=function(){_self.isPaused?_self.resume():_self.pause()},this.position=function(){return _self.isLoaded?_position=_self.isAd?_unencryptedPlayer.position(_self.id):_interface.position(this.id):0},this.getPlayerState=function(){var state={};return state.volume=_volume,state.position=_position,state.duration=_self.isLoaded?_duration:0,state.trackUri=this.trackUri,state.isPlaying=this.isPlaying,state.isStopped=this.isStopped,state.isPaused=this.isPaused,state},this.seek=function(pos){return _self.isLoaded?(_self.trigger(_events.BEFORE_SEEK),_position=pos,_self.isAd?_unencryptedPlayer.seek(_self.id,pos):_interface.seek(this.id,pos)):0},this.setVolume=function(volume){!isNaN(volume)&&volume>=0&&1>=volume&&(_volume=volume,_self.isAd?_unencryptedPlayer.setVolume(_self.id,volume*_masterVolume):_interface.setVolume(this.id,volume*_masterVolume))},this.setMasterVolume=function(volume){!isNaN(volume)&&volume>=0&&1>=volume&&(_masterVolume=volume,this.setVolume(_volume))},this.getVolume=function(){return _volume},this.getDuration=function(){return _duration},this.addFileResolver=function(type,resolver){_resolvers[type]=resolver},this.initialize=function(){playerType===Spotify.PlayerTypes.HTML5_HTTP&&(_interface.bind(_events.TRACK_ENDED,_onHTML5PlayerEvents),_interface.bind(_events.POSITION_CHANGED,_onHTML5PlayerEvents),_interface.bind(_events.PLAYING,_onHTML5PlayerEvents),_interface.bind(_events.PAUSED,_onHTML5PlayerEvents),_interface.bind(_events.STOPPED,_onHTML5PlayerEvents),_interface.bind(_events.LOAD,_onHTML5PlayerEvents),_interface.bind(_events.DURATION,_onHTML5PlayerEvents,this,10),_interface.bind(_events.PLAYBACK_FAILED,_onHTML5PlayerEvents,this,10)),_unencryptedPlayer&&(_unencryptedPlayer.addPlayer(0,_self.id),_unencryptedPlayer.bind(_events.FIRST_BYTES,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.TRACK_ENDED,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.POSITION_CHANGED,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.PLAYING,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.PAUSED,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.STOPPED,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.LOAD,_onUnencryptedEvent),_unencryptedPlayer.bind(_events.DURATION,_onUnencryptedEvent,this,10),_unencryptedPlayer.bind(_events.PLAYBACK_FAILED,_onUnencryptedEvent,this,10)),this.bind(_events.TRACK_ENDED,_onPlayerEvent,this,10),this.bind(_events.POSITION_CHANGED,_onPlayerEvent,this,10),this.bind(_events.PLAYING,_onPlayerEvent,this,10),this.bind(_events.PAUSED,_onPlayerEvent,this,10),this.bind(_events.STOPPED,_onPlayerEvent,this,10),this.bind(_events.PLAYBACK_FAILED,_onPlayerEvent,this,10),this.bind(_events.SONG_LOADED,_onPlayerEvent,this,10),this.bind(_events.INVALID_TRACK_URI,_onPlayerEvent,this,10),this.bind(_events.LOAD,_onPlayerEvent,this,10),this.bind(_events.READY,_onPlayerEvent,this,10),this.bind(_events.NOT_READY,_onPlayerEvent,this,10),this.bind(_events.TRACK_PLAY_REQUEST,_onPlayerEvent,this,10),this.bind(_events.DURATION,_onPlayerEvent,this,10),this.bind(_events.BEFORE_SEEK,_onPlayerEvent,this,10),this.bind(_events.FAILED_CONNECTING,_onPlayerEvent,this,10),this.bind(_events.STUTTER_DATA,_onPlayerEvent,this,10),_interface.initializePlayerById(this.id)},this.dispose=function(){playerType===Spotify.PlayerTypes.HTML5_HTTP&&(_interface.unbind(_events.TRACK_ENDED,_onHTML5PlayerEvents),_interface.unbind(_events.POSITION_CHANGED,_onHTML5PlayerEvents),_interface.unbind(_events.PLAYING,_onHTML5PlayerEvents),_interface.unbind(_events.PAUSED,_onHTML5PlayerEvents),_interface.unbind(_events.STOPPED,_onHTML5PlayerEvents),_interface.unbind(_events.LOAD,_onHTML5PlayerEvents)),_unencryptedPlayer&&(_unencryptedPlayer.unbind(_events.FIRST_BYTES,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.TRACK_ENDED,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.POSITION_CHANGED,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.PLAYING,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.PAUSED,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.STOPPED,_onUnencryptedEvent),_unencryptedPlayer.unbind(_events.LOAD,_onUnencryptedEvent)),this.unbind(_events.TRACK_ENDED,_onPlayerEvent,this),this.unbind(_events.POSITION_CHANGED,_onPlayerEvent,this),this.unbind(_events.PLAYING,_onPlayerEvent,this),this.unbind(_events.PAUSED,_onPlayerEvent,this),this.unbind(_events.STOPPED,_onPlayerEvent,this),this.unbind(_events.PLAYBACK_FAILED,_onPlayerEvent,this),this.unbind(_events.SONG_LOADED,_onPlayerEvent,this),this.unbind(_events.INVALID_TRACK_URI,_onPlayerEvent,this),this.unbind(_events.LOAD,_onPlayerEvent,this),this.unbind(_events.READY,_onPlayerEvent,this),this.unbind(_events.NOT_READY,_onPlayerEvent,this),this.unbind(_events.TRACK_PLAY_REQUEST,_onPlayerEvent,this),this.unbind(_events.DURATION,_onPlayerEvent,this),this.unbind(_events.BEFORE_SEEK,_onPlayerEvent,this),this.unbind(_events.FAILED_CONNECTING,_onPlayerEvent,this);
},this.onLoad=function(event){},this.onPlay=function(event){},this.onPause=function(event){},this.onStop=function(event){},this.onTrackEnded=function(event){},this.onSongLoaded=function(event){},this.onPositionChanged=function(event){},this.onInvalidTrackUri=function(event){},this.onPlaybackFailed=function(event){}},Spotify.Audio.AudioManager=function(id,settings,playerType){Spotify.EventTarget.call(this),this.isReady=!1,this.isInitialized=!1;var _crossfader,_activePlayer,_gateway,_interface,_user,MAIN_PLAYER_IDENTIFIER="Player0",_self=this,_masterVolume=1,_resolvers={},_debugger=Spotify.DebuggerJS,_events=new Spotify.Events,_loggingTypes=new Spotify.Logging.Types,_players=[],_trackers=[],_currentPlayerIndex=0,_username="",_onFlashEvent=function(event){this.trigger(event.type,event.params)},_onUserSuccess=function(response){_username=response.user,_self.addPlayer(MAIN_PLAYER_IDENTIFIER),_self.isReady=!0,_self.trigger(_events.READY)},_onUserFail=function(error){},_onInitialized=function(event){return this.hasSound()?(_self.isInitialized=!0,_self.trigger(_events.INITIALIZED),void _user.onReady(function(){_user.getUserInfo(_onUserSuccess,_onUserFail)})):void this.trigger(_events.NO_SOUND_CAPABILITIES)},_onPlayerEvent=function(event){switch(event.type){case _events.STOPPED:case _events.TRACK_END:_self.getTrackerForPlayerWithId(event.extra).stopTrackingAndLog();var index=_self.getTrackerIndexWithId(event.extra),oldData=_disposeTrackerAtIndex(index);_debugger.log("Spotify.Audio.AudioManager",["Stopped event capture",_trackers],"corejs");var newTracker=_createTracker(event.extra,index,_self.getPlayerAtIndex(index),_username);oldData&&(newTracker.setEndSongStartLog(oldData.tempLog),newTracker.setEndSongStopLog(oldData.tempEndLog))}_self.trigger(event.type,event.params,event.extra)},_onActivePlayerChanged=function(event){for(var l=0,len=_players.length;len>l;l+=1){var player=_players[l];player.id===event.params.id?(player.isActive=!0,_activePlayer=player,_self.trigger(event.type,event.params,event.extra)):player.isActive=!1}};this.onReady=function(callback,ctx){this.isReady?callback.call(ctx):_self.bind(_events.READY,callback,ctx)};var _onRecordAdEvent=function(event){_self.trigger(event.type,event.params)},_disposeTrackerAtIndex=function(index){var tracker=_trackers[index],oldData={tempLog:tracker.getTempData(),tempEndLog:tracker.getTempEndData()};return tracker.dispose(!0),tracker=null,_trackers[index]=null,oldData},_createTracker=function(id,index,player,username){var tracker,trackEndLogger=new Spotify.Logging.TrackEnd;trackEndLogger.init(_gateway);var previewEndLogger=new Spotify.Logging.PreviewEnd;previewEndLogger.init();var trackProgressLogger=new Spotify.Logging.TrackProgress;trackProgressLogger.init(_gateway);var trackEventLogger=new Spotify.Logging.TrackEvent;trackEventLogger.init(_gateway);var adEndLogger=new Spotify.Logging.AdEnd;return adEndLogger.init(_gateway),tracker=_trackers[index]=new Spotify.PlayerTracker(id,player,username),tracker.bind(_events.RECORD_AD_EVENT,_onRecordAdEvent,_self),trackEndLogger.setTrackEventLogger(trackEventLogger),tracker.addLogger(_loggingTypes.TRACK_EVENT,trackEventLogger),tracker.addLogger(_loggingTypes.TRACK_END,trackEndLogger),tracker.addLogger(_loggingTypes.PREVIEW_END,previewEndLogger),tracker.addLogger(_loggingTypes.AD_END,adEndLogger),tracker.addLogger(_loggingTypes.TRACK_PROGRESS,trackProgressLogger),tracker.initialize(),_debugger.log("Spotify.Audio.AudioManager",["Created a new tracker at index",index,_trackers],"corejs"),tracker};this.addPlayer=function(id,type){var player;if("string"!=typeof id)throw new Error("The id must be a string");"undefined"==typeof type&&(type=playerType);for(var l=0,len=_players.length;len>l;l+=1)if(_players[l].id===id)throw new Error("There is already a player with this id: "+id);return _interface.addPlayer(_currentPlayerIndex,id,type),player=_players[_currentPlayerIndex]=new Spotify.Audio.AudioStream(id,type,_interface),player.addFileResolver(Spotify.Resolvers.STORAGE_RESOLVER,_resolvers[Spotify.Resolvers.STORAGE_RESOLVER]),player.addFileResolver(Spotify.Resolvers.AD_RESOLVER,_resolvers[Spotify.Resolvers.AD_RESOLVER]),player.addFileResolver(Spotify.Resolvers.PREVIEW_RESOLVER,_resolvers[Spotify.Resolvers.PREVIEW_RESOLVER]),player.bind(_events.ACTIVE_PLAYER_CHANGED,_onActivePlayerChanged,_self),player.bind(_events.TRACK_ENDED,_onPlayerEvent,_self),player.bind(_events.POSITION_CHANGED,_onPlayerEvent,_self),player.bind(_events.PLAYING,_onPlayerEvent,_self),player.bind(_events.PAUSED,_onPlayerEvent,_self),player.bind(_events.STOPPED,_onPlayerEvent,_self),player.bind(_events.INVALID_TRACK_URI,_onPlayerEvent,_self),player.bind(_events.PLAYBACK_FAILED,_onPlayerEvent,_self),player.bind(_events.TRACK_PLAY_REQUEST,_onPlayerEvent,_self),player.bind(_events.SONG_LOADED,_onPlayerEvent,_self),player.bind(_events.LOAD,_onPlayerEvent,_self),player.bind(_events.FAILED_CONNECTING,_onPlayerEvent,_self),player.initialize(),_createTracker(id,_currentPlayerIndex,player,_username),_currentPlayerIndex++,this.trigger(_events.PLAYER_CREATED,{id:id}),player},this.getPlayers=function(){return _players},this.getActivePlayer=function(){return _activePlayer},this.getPlayerById=function(id){var player;if("string"==typeof id)for(var l=0,len=_players.length;len>l;l+=1)if(player=_players[l],player.id===id)return player},this.getTrackerIndexWithId=function(id){var tracker;if("string"==typeof id)for(var l=0,len=_trackers.length;len>l;l+=1)if(tracker=_trackers[l],tracker.id===id)return l},this.getTrackerForPlayerWithId=function(id){var tracker;if("string"==typeof id)for(var l=0,len=_trackers.length;len>l;l+=1)if(tracker=_trackers[l],tracker.id===id)return tracker},this.getPlayerAtIndex=function(index){return"number"==typeof index&&_players[index]?_players[index]:void 0},this.getTrackerForPlayerAtIndex=function(index){return"number"==typeof index&&_trackers[index]?_trackers[index]:void 0},this.removePlayerById=function(id){var player;if("string"==typeof id){if(id===MAIN_PLAYER_IDENTIFIER)return!1;for(var l=0,len=_players.length;len>l;l+=1)if(player=_players[l],player.id===id&&0!==l)return this.removePlayerAtIndex(l);return!1}},this.removePlayerAtIndex=function(index){return"number"!=typeof index?!1:0===index?!1:_players[index]?(_players[index].isActive&&(_activePlayer=_players[0]),_players[index].dispose(),_trackers[index].dispose(!0),delete _players[index],delete _trackers[index],_players[index]=null,_trackers[index]=null,_interface.removePlayerAtIndex(index)):!1},this.hasSound=function(){return _interface.hasSound()},this.setMasterVolume=function(volume){var player;_masterVolume=0>volume?0:volume>1?1:volume;for(var l=0,len=_players.length;len>l;l+=1)player=_players[l],player.setMasterVolume(_masterVolume)},this.getMasterVolume=function(){return _masterVolume},this.crossfade=function(playerId1,playerId2,duration,callback){_crossfader||(_crossfader=new Spotify.Audio.Crossfader),_crossfader.crossfade(this.getPlayerById(playerId1),this.getPlayerById(playerId2),duration,callback)},this.dispose=function(){for(var player,l=0,len=_players.length;len>l;l+=1)player=_players[l],null!==player&&void 0!==player&&(player.dispose(),player.isActive&&_trackers[l].dispose())},this.addFileResolver=function(type,resolver){_resolvers[type]=resolver},this.getInterface=function(){return _interface},this.initialize=function(gateway,userService){_user=userService,_gateway=gateway,playerType===Spotify.PlayerTypes.FLASH_HTTP||playerType===Spotify.PlayerTypes.FLASH_RTMPS||playerType===Spotify.PlayerTypes.FLASH_HTTP_ENCRYPTED||playerType===Spotify.PlayerTypes.FLASH_AAC?(_interface=new Spotify.Flash.PlayerInterface(id,settings),_interface.bind(_events.FLASH_AVAILABLE,_onFlashEvent,this),_interface.bind(_events.FLASH_UNAVAILABLE,_onFlashEvent,this)):playerType===Spotify.PlayerTypes.HTML5_HTTP&&(_interface=new Spotify.HTML5.PlayerInterface("html5audio")),_interface.bind(_events.READY,_onInitialized,this,10),_interface.initialize()}},Spotify.Audio.Crossfader=function(){var _currentCallback,_intervalId,_startTime,_endTime,CROSSFADE_INTERVAL=100,_self=this,_debugger=Spotify.DebuggerJS,_targetVolume=1,_isCrossfading=!1,_progress=0,_step=0;this.crossfade=function(player1,player2,duration,callback){_isCrossfading?(this.stop(),_currentCallback(),_currentCallback=null,_endTime=_startTime+(1-(1-_progress)+_progress)*duration):(player2.setVolume(0),_startTime=(new Date).getTime(),_endTime=_startTime+duration,_targetVolume=player1.getVolume(),_progress=0),_debugger.log("Spotify.Audio.Crossfader",["Target volume",_targetVolume],"corejs"),_isCrossfading=!0,_currentCallback=callback,_intervalId=setInterval(function(){var currentTime=(new Date).getTime();_step=(_endTime-currentTime)/duration,_progress=Math.floor(100*(1-_step))/100;var volume1=Math.floor(_targetVolume*(1-_progress)*100)/100,volume2=Math.floor(_targetVolume*_progress*100)/100;volume1=volume1>1?1:volume1,volume1=0>volume1?0:volume1,volume2=volume2>1?1:volume2,volume2=0>volume2?0:volume2,player1.setVolume(volume1),player2.setVolume(volume2),_debugger.log("Spotify.Audio.Crossfader",[player1.id,"will have volume",volume1,player2.id,"will have volume",volume2],"corejs"),_progress>=1&&(_isCrossfading=!1,_self.stop(),callback())},CROSSFADE_INTERVAL)},this.stop=function(){return _intervalId?(clearInterval(_intervalId),_intervalId=null,!0):!1}},Spotify.WebSockets.Bridge=function(id,args){Spotify.EventTarget.call(this);var _debugger=Spotify.DebuggerJS;this.id=id,args=args||{};var self=this,_events=new Spotify.Events,State={idle:0,connecting:1,authorizing:2,authorized:3},settings={connectionParams:args.connectionParams||""},client=null,getAuthObject=function(){var args=settings.connectionParams.split(":");if(parseInt(args[0],10)>200){var type=args.shift(),signature=args.shift(),message=args.join(":");args=[type,signature,message]}return{name:"connect",id:"0",args:args}},AbstractState=function(){this.activate=function(){},this.connect=function(){},this.disconnect=function(){},this.rpc=function(method,params,requestId){},this.onConnect=function(){},this.onDisconnect=function(){},this.onMessage=function(event){},this.onError=function(){}},activeState=null,currentState="",_intervalId=0,switchToState=function(state){currentState=state,activeState=states[state],activeState.activate()},states={};states[State.idle]=new function(){AbstractState.call(this),this.activate=function(){clearInterval(_intervalId)},this.connect=function(){switchToState(State.connecting)}},states[State.connecting]=new function(){AbstractState.call(this),this.activate=function(){clearInterval(_intervalId),client.connect(settings.connectionUri)},this.onConnect=function(){_debugger.log("Spotify.WebSockets.Bridge",["[State.connecting] Socket connected"],"corejs"),switchToState(State.authorizing)},this.onDisconnect=function(event){_debugger.log("Spotify.WebSockets.Bridge",["[State.connecting] Socket disconnected"],"corejs"),self.trigger(_events.FAILED_CONNECTING,event.params||[]),switchToState(State.idle)},this.disconnect=function(){client.disconnect()},this.onError=function(e){_debugger.error("Spotify.WebSockets.Bridge",["[State.connecting] Error",e],"corejs"),self.trigger(_events.FAILED_CONNECTING,{}),switchToState(State.idle)}},states[State.authorizing]=new function(){AbstractState.call(this),this.activate=function(){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorizing] Sending auth object"],"corejs"),clearInterval(_intervalId);var authorizeObject=getAuthObject();client.sendObject(authorizeObject)},this.disconnect=function(){client.disconnect(!1)},this.onDisconnect=function(event){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorizing] Socket disconnected"],"corejs"),self.trigger(_events.FAILED_CONNECTING,event.params||[]),switchToState(State.idle)},this.onMessage=function(event){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorizing] Got message",event],"corejs");try{var response=JSON.parse(event);"ok"===response.result?(self.trigger(_events.AUTHENTICATED,{}),self.trigger(_events.CONNECTION_ESTABLISHED,{}),switchToState(State.authorized)):response.error&&(self.trigger(_events.FAILED_CONNECTING,response.error),self.disconnect(),switchToState(State.idle))}catch(exception){}}},states[State.authorized]=new function(){AbstractState.call(this),this.activate=function(){clearInterval(_intervalId),_intervalId=setInterval(function(){client.isConnected()||(clearInterval(_intervalId),client.trigger("ondisconnect",[]))},1e3)},this.onMessage=function(event){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorized] Got message",event],"corejs");try{var response=JSON.parse(event)}catch(exception){return void self.trigger(_events.ERROR,{message:"Response not a JSON object"})}var message=response.message?response.message[0]:null;"token_lost"===message?self.trigger(_events.TOKEN_LOST,{}):"do_work"===message?self.trigger(_events.WORK,response.message[1]):"disconnect"===message?"password-changed"===response.message[1]&&self.trigger(_events.PASSWORD_CHANGED,response.message[1]):"ping_flash"===message?self.trigger(_events.PING_FLASH,response.message[1]):"ping_flash2"===message?self.trigger(_events.PING_FLASH2,response.message[1]):"login_complete"===message?self.trigger(_events.LOGIN_COMPLETE):"hm_b64"===message?self.trigger(_events.HERMES_B64_MESSAGE,response.message):"user_info_change"===message?self.trigger(_events.USER_INFO_CHANGE):"album_art"===message?self.trigger(_events.ALBUM_ART,response.message):response.id?response.error?self.trigger(_events.RPC_ERRBACK,{requestId:response.id,response:response.error}):self.trigger(_events.RPC_CALLBACK,{requestId:response.id,response:response.result}):self.trigger(_events.ERROR,{error:"Response object invalid"})},this.disconnect=function(){client.disconnect()},this.onDisconnect=function(){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorized] Socket disconnected"],"corejs"),self.trigger(_events.FAILED_CONNECTING,{}),switchToState(State.idle)},this.rpc=function(method,params,requestId){_debugger.log("Spotify.WebSockets.Bridge",["[State.authorized] Doing an RPC call",method,params],"corejs");var rpcObject={id:requestId,name:"sp/"+method,args:params};client.sendObject(rpcObject)},this.onError=function(error){_debugger.error("Spotify.WebSockets.Bridge",["[State.authorized] onerror",error],"corejs"),self.trigger(_events.WEBSOCKET_ERROR,{})}},this.rpc=function(method,params,requestId){activeState.rpc(method,params,requestId)},this.connect=function(connectionParams,connectionUri){connectionParams&&(settings.connectionParams=connectionParams),connectionUri&&(settings.connectionUri=connectionUri),activeState.connect()},this.disconnect=function(){activeState.disconnect()},this.initialize=function(){if(""===settings.connectionUri)throw new Error("Spotify.WebSockets.Bridge connectionUri cannot be empty");client=new Spotify.WebSockets.Client,client.bind("onconnect",function(event){activeState.onConnect()}),client.bind("ondisconnect",function(event){activeState.onDisconnect(event)}),client.bind("onmessage",function(event){activeState.onMessage(event.params.message)}),client.bind("onerror",function(event){activeState.onError(event.params.message)}),self.trigger(_events.READY,{}),switchToState(State.idle)}},Spotify.WebSockets.Client=function(){Spotify.EventTarget.call(this);var _debugger=Spotify.DebuggerJS,MAX_PACKET_SIZE=32768,_readyState={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},_socket=null,_self=this;this.connect=function(connectionUri){if(""===connectionUri)throw new Error("Spotify.WebSockets.Client connection Uri was not set");if(this.isConnected())return!1;if(void 0===WebSocket)throw new Error("Spotify.WebSockets.Client WebSocket interface not supported");this.currentConnection=(this.currentConnection||0)+1;var thisConnection=this.currentConnection;_socket=new WebSocket(connectionUri),_socket.onopen=function(){_debugger.log("Spotify.WebSockets.Client",["onopen",thisConnection],"corejs"),thisConnection==_self.currentConnection&&_self.trigger("onconnect",{})},_socket.onclose=function(event){_debugger.log("Spotify.WebSockets.Client",["onclose",thisConnection,event],"corejs"),thisConnection==_self.currentConnection&&_self.trigger("ondisconnect",[0,event.code,event.reason])},_socket.onmessage=function(event){_debugger.log("Spotify.WebSockets.Client",["onmessage",event,thisConnection],"corejs"),thisConnection==_self.currentConnection&&_self.trigger("onmessage",{message:event.data})},_socket.onerror=function(event){_debugger.error("Spotify.WebSockets.Client",["onerror",event,thisConnection],"corejs"),thisConnection==_self.currentConnection&&_self.trigger("onerror",{message:event})}},this.disconnect=function(notify){return"undefined"==typeof notify&&(notify=!0),this.isConnected()?(_socket.close(),_socket=null,void(notify&&_self.trigger("ondisconnect",[0,0,""]))):void _debugger.error("Spotify.WebSockets.Client",["Client not connected"],"corejs")},this.isConnected=function(){return _socket&&_socket.readyState===_readyState.OPEN},this.send=function(message){this.isConnected()?_socket.send(message):(_self.trigger("ondisconnect",[0,0,""]),_debugger.error("Spotify.WebSockets.Client",["Client not connected"],"corejs"))},this.sendObject=function(object){var serializedObject=JSON.stringify(object);if(serializedObject.length>MAX_PACKET_SIZE){var message={id:object.id,error:[16,1,"PACKET_SIZE_EXCEEDED"]};_self.trigger("onmessage",{message:JSON.stringify(message)})}else this.send(serializedObject)}},Spotify.EventTarget=function(){this._listeners={},this.bind=this.addEventListener=function(type,listener,ctx,priority){if("undefined"==typeof priority&&(priority=0),"undefined"!=typeof listener&&null!==listener){var events,obj={callback:listener,context:ctx,priority:priority},exists=!1;void 0===this._listeners[type]&&(this._listeners[type]=[]),events=this._listeners[type];for(var i=0;i<events.length;i++)if(events[i].callback===listener&&events[i].context===ctx){exists=!0;break}exists===!1&&(this._listeners[type].push(obj),this._listeners[type].sort(_sortByPriorityDesc))}},this.bindOnce=function(type,listener,ctx,priority){var callback,self=this;callback=function(){self.unbind(type,callback),listener.apply(ctx,arguments)},this.bind(type,callback,void 0,priority)};var _sortByPriorityDesc=function(a,b){return b.priority-a.priority};this.trigger=this.dispatchEvent=function(type,params,extra){var events=this._listeners[type];if(params=params||{},"undefined"!=typeof events){events=events.concat();for(var i=0,len=events.length;len>i;i++){var event=events[i];event.context?event.callback.call(event.context,{type:type,params:params,extra:extra||{}}):event.callback({type:type,params:params,extra:extra||{}})}}},this._triggerDeferred=function(type,params,extra){var events=this._listeners[type];if(params=params||{},"undefined"!=typeof events)for(var i=0;i<events.length;i++){var event=events[i];setTimeout(event.callback.bind(event.context,{type:type,params:params,extra:extra||{}}),0)}},this.unbind=this.removeEventListener=function(type,listener,ctx){var index=-1,events=this._listeners[type];if("undefined"!=typeof listener){if("undefined"!=typeof events){for(var i=0;i<events.length;i++)if(events[i].callback===listener&&events[i].context===ctx){index=i;break}-1!==index&&this._listeners[type].splice(index,1)}}else this._listeners[type]=[]}},Spotify.Protobuf.Schema=function(args,clb,errclb,ctx){Spotify.EventTarget.call(this);var _pbSchema,_callback=clb,_errorCallback=errclb,_callbackContext=ctx,_schemasLeftToLoad=0,_data=[];this.id="",this.PROTO="proto",this.JSON="json",this.type="json",this.load=function(){var i,dataType;if(this.type===this.JSON)dataType="json";else{if(this.type!==this.PROTO)throw new Error("Not a valid descriptor file for the protobuf schema");dataType="text"}for(_schemasLeftToLoad=0,i=0;i<args.length;i++)if("string"==typeof args[i]){_schemasLeftToLoad++;var service=new Spotify.Service;service.url=args[i],service.dataType=dataType,service.bind("onSuccess",this.done,this),service.bind("onError",this.error,this),service.fetch()}},this.reset=function(){_data=null},this.getSchema=function(){return _pbSchema},this.msg=function(msg){return _pbSchema[msg]},this.parse=function(schema){_data=null===_data?schema:_data.concat(schema)},this.encode=function(){var temp;this.type==this.JSON?_pbSchema=Spotify.Protobuf.Serialization.createFromJson(_data):(temp=Spotify.Protobuf.Parser.parseFileDescriptor(_data),_pbSchema=Spotify.Protobuf.Serialization.createFromFileDescriptor(temp))},this.done=function(data){this.parse(data.params.result),_schemasLeftToLoad--,0===_schemasLeftToLoad&&(this.encode(),"undefined"!=typeof _callbackContext?"undefined"!=typeof _callback&&_callback.call(_callbackContext,this.id,this):"undefined"!=typeof _callback&&_callback(this.id,this))},this.setData=function(dt){_data=dt},this.error=function(error){"undefined"!=typeof _callbackContext?"undefined"!=typeof _errorCallback&&_errorCallback.call(_callbackContext,error):"undefined"!=typeof _errorCallback&&_errorCallback(error)}},Spotify.Protobuf.Schemas={"ad-hermes-proxy":[{name:"Rule",fields:[{id:1,type:"string",name:"type",enumMap:null},{id:2,type:"uint32",name:"times",enumMap:null},{id:3,type:"uint64",name:"interval",enumMap:null}]},{name:"AdRequest",fields:[{id:1,type:"string",name:"client_language",enumMap:null},{id:2,type:"string",name:"product",enumMap:null},{id:3,type:"uint32",name:"version",enumMap:null},{id:4,type:"string",name:"type",enumMap:null},{id:5,type:"*string",name:"avoidAds",enumMap:null}]},{name:"AdQueueResponse",fields:[{id:1,type:"*AdQueueEntry",name:"adQueueEntry",typeName:"AdQueueEntry",enumMap:null}]},{name:"AdFile",fields:[{id:1,type:"string",name:"id",enumMap:null},{id:2,type:"string",name:"format",enumMap:null}]},{name:"AdQueueEntry",fields:[{id:1,type:"uint64",name:"start_time",enumMap:null},{id:2,type:"uint64",name:"end_time",enumMap:null},{id:3,type:"double",name:"priority",enumMap:null},{id:4,type:"string",name:"token",enumMap:null},{id:5,type:"uint32",name:"ad_version",enumMap:null},{id:6,type:"string",name:"id",enumMap:null},{id:7,type:"string",name:"type",enumMap:null},{id:8,type:"string",name:"campaign",enumMap:null},{id:9,type:"string",name:"advertiser",enumMap:null},{id:10,type:"string",name:"url",enumMap:null},{id:11,type:"uint64",name:"duration",enumMap:null},{id:12,type:"uint64",name:"expiry",enumMap:null},{id:13,type:"string",name:"tracking_url",enumMap:null},{id:14,type:"string",name:"banner_type",enumMap:null},{id:15,type:"string",name:"html",enumMap:null},{id:16,type:"string",name:"image",enumMap:null},{id:17,type:"string",name:"background_image",enumMap:null},{id:18,type:"string",name:"background_url",enumMap:null},{id:19,type:"string",name:"background_color",enumMap:null},{id:20,type:"string",name:"title",enumMap:null},{id:21,type:"string",name:"caption",enumMap:null},{id:22,type:"*AdFile",name:"file",typeName:"AdFile",enumMap:null},{id:23,type:"*Rule",name:"rule",typeName:"Rule",enumMap:null}]}],appstore:[{name:"AppInfo",fields:[{id:1,type:"string",name:"identifier",enumMap:null},{id:2,type:"int32",name:"version_int",enumMap:null}]},{name:"AppInfoList",fields:[{id:1,type:"*AppInfo",name:"items",typeName:"AppInfo",enumMap:null}]},{name:"SemanticVersion",fields:[{id:1,type:"int32",name:"major",enumMap:null},{id:2,type:"int32",name:"minor",enumMap:null},{id:3,type:"int32",name:"patch",enumMap:null}]},{name:"RequestHeader",fields:[{id:1,type:"string",name:"market",enumMap:null},{id:2,type:"#",name:"platform",typeName:"Platform",enumMap:{name:"RequestHeader.Platform",toName:{0:"WIN32_X86",1:"OSX_X86",2:"LINUX_X86",3:"IPHONE_ARM",4:"SYMBIANS60_ARM",5:"OSX_POWERPC",6:"ANDROID_ARM",7:"WINCE_ARM",8:"LINUX_X86_64",9:"OSX_X86_64",10:"PALM_ARM",11:"LINUX_SH",12:"FREEBSD_X86",13:"FREEBSD_X86_64",14:"BLACKBERRY_ARM",15:"SONOS_UNKNOWN",16:"LINUX_MIPS",17:"LINUX_ARM",18:"LOGITECH_ARM",19:"LINUX_BLACKFIN",21:"ONKYO_ARM",22:"QNXNTO_ARM",255:"BADPLATFORM"},toNumber:{WIN32_X86:0,OSX_X86:1,LINUX_X86:2,IPHONE_ARM:3,SYMBIANS60_ARM:4,OSX_POWERPC:5,ANDROID_ARM:6,WINCE_ARM:7,LINUX_X86_64:8,OSX_X86_64:9,PALM_ARM:10,LINUX_SH:11,FREEBSD_X86:12,FREEBSD_X86_64:13,BLACKBERRY_ARM:14,SONOS_UNKNOWN:15,LINUX_MIPS:16,LINUX_ARM:17,LOGITECH_ARM:18,LINUX_BLACKFIN:19,ONKYO_ARM:21,QNXNTO_ARM:22,BADPLATFORM:255}}},{id:6,type:"AppInfoList",name:"app_infos",typeName:"AppInfoList",enumMap:null},{id:7,type:"string",name:"bridge_identifier",enumMap:null},{id:8,type:"SemanticVersion",name:"bridge_version",typeName:"SemanticVersion",enumMap:null},{id:9,type:"#",name:"device_class",typeName:"DeviceClass",enumMap:{name:"RequestHeader.DeviceClass",toName:{1:"DESKTOP",2:"TABLET",3:"MOBILE",4:"WEB",5:"TV"},toNumber:{DESKTOP:1,TABLET:2,MOBILE:3,WEB:4,TV:5}}}]},{name:"AppItem",fields:[{id:1,type:"string",name:"identifier",enumMap:null},{id:2,type:"#",name:"requirement",typeName:"Requirement",enumMap:{name:"AppItem.Requirement",toName:{1:"REQUIRED_INSTALL",2:"LAZYLOAD",3:"OPTIONAL_INSTALL"},toNumber:{REQUIRED_INSTALL:1,LAZYLOAD:2,OPTIONAL_INSTALL:3}}},{id:4,type:"string",name:"manifest",enumMap:null},{id:5,type:"string",name:"checksum",enumMap:null},{id:6,type:"string",name:"bundle_uri",enumMap:null},{id:7,type:"string",name:"small_icon_uri",enumMap:null},{id:8,type:"string",name:"large_icon_uri",enumMap:null},{id:9,type:"string",name:"medium_icon_uri",enumMap:null},{id:10,type:"#",name:"bundle_type",typeName:"Type",enumMap:{name:"AppItem.Type",toName:{0:"APPLICATION",1:"FRAMEWORK",2:"BRIDGE"},toNumber:{APPLICATION:0,FRAMEWORK:1,BRIDGE:2}}},{id:11,type:"SemanticVersion",name:"version",typeName:"SemanticVersion",enumMap:null},{id:12,type:"uint32",name:"ttl_in_seconds",enumMap:null},{id:13,type:"IdentifierList",name:"categories",typeName:"IdentifierList",enumMap:null}]},{name:"AppList",fields:[{id:1,type:"*AppItem",name:"items",typeName:"AppItem",enumMap:null}]},{name:"IdentifierList",fields:[{id:1,type:"*string",name:"identifiers",enumMap:null}]},{name:"BannerConfig",fields:[{id:1,type:"string",name:"json",enumMap:null}]}],"facebook-publish":[{name:"EventReply",fields:[{id:1,type:"int32",name:"queued",enumMap:null},{id:2,type:"RetryInfo",name:"retry",typeName:"RetryInfo",enumMap:null}]},{name:"RetryInfo",fields:[{id:1,type:"int32",name:"retry_delay",enumMap:null},{id:2,type:"int32",name:"max_retry",enumMap:null}]},{name:"Id",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"int64",name:"start_time",enumMap:null}]},{name:"Start",fields:[{id:1,type:"int32",name:"length",enumMap:null},{id:2,type:"string",name:"context_uri",enumMap:null},{id:3,type:"int64",name:"end_time",enumMap:null}]},{name:"Seek",fields:[{id:1,type:"int64",name:"end_time",enumMap:null}]},{name:"Pause",fields:[{id:1,type:"int32",name:"seconds_played",enumMap:null},{id:2,type:"int64",name:"end_time",enumMap:null}]},{name:"Resume",fields:[{id:1,type:"int32",name:"seconds_played",enumMap:null},{id:2,type:"int64",name:"end_time",enumMap:null}]},{name:"End",fields:[{id:1,type:"int32",name:"seconds_played",enumMap:null},{id:2,type:"int64",name:"end_time",enumMap:null}]},{name:"Event",fields:[{id:1,type:"Id",name:"id",typeName:"Id",enumMap:null},{id:2,type:"Start",name:"start",typeName:"Start",enumMap:null},{id:3,type:"Seek",name:"seek",typeName:"Seek",enumMap:null},{id:4,type:"Pause",name:"pause",typeName:"Pause",enumMap:null},{id:5,type:"Resume",name:"resume",typeName:"Resume",enumMap:null},{id:6,type:"End",name:"end",typeName:"End",enumMap:null}]}],facebook:[{name:"Credential",fields:[{id:1,type:"string",name:"facebook_uid",enumMap:null},{id:2,type:"string",name:"access_token",enumMap:null}]},{name:"EnableRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"EnableReply",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"DisableRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"RevokeRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"InspectCredentialRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"InspectCredentialReply",fields:[{id:1,type:"Credential",name:"alternative_credential",typeName:"Credential",enumMap:null},{id:2,type:"bool",name:"app_user",enumMap:null},{id:3,type:"bool",name:"permanent_error",enumMap:null},{id:4,type:"bool",name:"transient_error",enumMap:null}]},{name:"UserState",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"UpdateUserStateRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null}]},{name:"OpenGraphError",fields:[{id:1,type:"*string",name:"permanent",enumMap:null},{id:2,type:"*string",name:"invalid_token",enumMap:null},{id:3,type:"*string",name:"retries",enumMap:null}]},{name:"OpenGraphScrobble",fields:[{id:1,type:"int32",name:"create_delay",enumMap:null}]},{name:"OpenGraphConfig",fields:[{id:1,type:"OpenGraphError",name:"error",typeName:"OpenGraphError",enumMap:null},{id:2,type:"OpenGraphScrobble",name:"scrobble",typeName:"OpenGraphScrobble",enumMap:null}]},{name:"AuthConfig",fields:[{id:1,type:"string",name:"url",enumMap:null},{id:2,type:"*string",name:"permissions",enumMap:null},{id:3,type:"*string",name:"blacklist",enumMap:null},{id:4,type:"*string",name:"whitelist",enumMap:null},{id:5,type:"*string",name:"cancel",enumMap:null}]},{name:"ConfigReply",fields:[{id:1,type:"string",name:"domain",enumMap:null},{id:2,type:"string",name:"app_id",enumMap:null},{id:3,type:"string",name:"app_namespace",enumMap:null},{id:4,type:"AuthConfig",name:"auth",typeName:"AuthConfig",enumMap:null},{id:5,type:"OpenGraphConfig",name:"og",typeName:"OpenGraphConfig",enumMap:null}]},{name:"UserFields",fields:[{id:1,type:"bool",name:"app_user",enumMap:null},{id:2,type:"bool",name:"display_name",enumMap:null},{id:3,type:"bool",name:"first_name",enumMap:null},{id:4,type:"bool",name:"middle_name",enumMap:null},{id:5,type:"bool",name:"last_name",enumMap:null},{id:6,type:"bool",name:"picture_large",enumMap:null},{id:7,type:"bool",name:"picture_square",enumMap:null},{id:8,type:"bool",name:"gender",enumMap:null},{id:9,type:"bool",name:"email",enumMap:null}]},{name:"UserOptions",fields:[{id:1,type:"bool",name:"cache_is_king",enumMap:null}]},{name:"UserRequest",fields:[{id:1,type:"UserOptions",name:"options",typeName:"UserOptions",enumMap:null},{id:2,type:"UserFields",name:"fields",typeName:"UserFields",enumMap:null}]},{name:"User",fields:[{id:1,type:"string",name:"spotify_username",enumMap:null},{id:2,type:"string",name:"facebook_uid",enumMap:null},{id:3,type:"bool",name:"app_user",enumMap:null},{id:4,type:"string",name:"display_name",enumMap:null},{id:5,type:"string",name:"first_name",enumMap:null},{id:6,type:"string",name:"middle_name",enumMap:null},{id:7,type:"string",name:"last_name",enumMap:null},{id:8,type:"string",name:"picture_large",enumMap:null},{id:9,type:"string",name:"picture_square",enumMap:null},{id:10,type:"string",name:"gender",enumMap:null},{id:11,type:"string",name:"email",enumMap:null}]},{name:"FriendsFields",fields:[{id:1,type:"bool",name:"app_user",enumMap:null},{id:2,type:"bool",name:"display_name",enumMap:null},{id:6,type:"bool",name:"picture_large",enumMap:null}]},{name:"FriendsOptions",fields:[{id:1,type:"int32",name:"limit",enumMap:null},{id:2,type:"int32",name:"offset",enumMap:null},{id:3,type:"bool",name:"cache_is_king",enumMap:null},{id:4,type:"bool",name:"app_friends",enumMap:null},{id:5,type:"bool",name:"non_app_friends",enumMap:null}]},{name:"FriendsRequest",fields:[{id:1,type:"FriendsOptions",name:"options",typeName:"FriendsOptions",enumMap:null},{id:2,type:"FriendsFields",name:"fields",typeName:"FriendsFields",enumMap:null}]},{name:"FriendsReply",fields:[{id:1,type:"*User",name:"friends",typeName:"User",enumMap:null},{id:2,type:"bool",name:"more",enumMap:null}]},{name:"ShareRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null
},{id:2,type:"string",name:"uri",enumMap:null},{id:3,type:"string",name:"message_text",enumMap:null}]},{name:"ShareReply",fields:[{id:1,type:"string",name:"post_id",enumMap:null}]},{name:"InboxRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null},{id:3,type:"*string",name:"facebook_uids",enumMap:null},{id:4,type:"string",name:"message_text",enumMap:null},{id:5,type:"string",name:"message_link",enumMap:null}]},{name:"InboxReply",fields:[{id:1,type:"string",name:"message_id",enumMap:null},{id:2,type:"string",name:"thread_id",enumMap:null}]},{name:"PermissionsOptions",fields:[{id:1,type:"bool",name:"cache_is_king",enumMap:null}]},{name:"PermissionsRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null},{id:2,type:"PermissionsOptions",name:"options",typeName:"PermissionsOptions",enumMap:null}]},{name:"PermissionsReply",fields:[{id:1,type:"*string",name:"permissions",enumMap:null}]},{name:"GrantPermissionsRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null},{id:2,type:"*string",name:"permissions",enumMap:null}]},{name:"GrantPermissionsReply",fields:[{id:1,type:"*string",name:"granted",enumMap:null},{id:2,type:"*string",name:"failed",enumMap:null}]},{name:"TransferRequest",fields:[{id:1,type:"Credential",name:"credential",typeName:"Credential",enumMap:null},{id:2,type:"string",name:"source_username",enumMap:null},{id:3,type:"string",name:"target_username",enumMap:null}]}],mercury:[{name:"MercuryMultiGetRequest",fields:[{id:1,type:"*MercuryRequest",name:"request",typeName:"MercuryRequest",enumMap:null}]},{name:"MercuryMultiGetReply",fields:[{id:1,type:"*MercuryReply",name:"reply",typeName:"MercuryReply",enumMap:null}]},{name:"MercuryRequest",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"content_type",enumMap:null},{id:3,type:"bytes",name:"body",enumMap:null},{id:4,type:"bytes",name:"etag",enumMap:null}]},{name:"MercuryReply",fields:[{id:1,type:"sint32",name:"status_code",enumMap:null},{id:2,type:"string",name:"status_message",enumMap:null},{id:3,type:"#",name:"cache_policy",typeName:"CachePolicy",enumMap:{name:"MercuryReply.CachePolicy",toName:{1:"CACHE_NO",2:"CACHE_PRIVATE",3:"CACHE_PUBLIC"},toNumber:{CACHE_NO:1,CACHE_PRIVATE:2,CACHE_PUBLIC:3}}},{id:4,type:"sint32",name:"ttl",enumMap:null},{id:5,type:"bytes",name:"etag",enumMap:null},{id:6,type:"string",name:"content_type",enumMap:null},{id:7,type:"bytes",name:"body",enumMap:null}]}],mergedprofile:[{name:"MergedProfileRequest",fields:[]},{name:"MergedProfileReply",fields:[{id:1,type:"string",name:"username",enumMap:null},{id:2,type:"string",name:"artistid",enumMap:null}]}],metadata:[{name:"TopTracks",fields:[{id:1,type:"string",name:"country",enumMap:null},{id:2,type:"*Track",name:"track",typeName:"Track",enumMap:null}]},{name:"ActivityPeriod",fields:[{id:1,type:"sint32",name:"start_year",enumMap:null},{id:2,type:"sint32",name:"end_year",enumMap:null},{id:3,type:"sint32",name:"decade",enumMap:null}]},{name:"Artist",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"sint32",name:"popularity",enumMap:null},{id:4,type:"*TopTracks",name:"top_track",typeName:"TopTracks",enumMap:null},{id:5,type:"*AlbumGroup",name:"album_group",typeName:"AlbumGroup",enumMap:null},{id:6,type:"*AlbumGroup",name:"single_group",typeName:"AlbumGroup",enumMap:null},{id:7,type:"*AlbumGroup",name:"compilation_group",typeName:"AlbumGroup",enumMap:null},{id:8,type:"*AlbumGroup",name:"appears_on_group",typeName:"AlbumGroup",enumMap:null},{id:9,type:"*string",name:"genre",enumMap:null},{id:10,type:"*ExternalId",name:"external_id",typeName:"ExternalId",enumMap:null},{id:11,type:"*Image",name:"portrait",typeName:"Image",enumMap:null},{id:12,type:"*Biography",name:"biography",typeName:"Biography",enumMap:null},{id:13,type:"*ActivityPeriod",name:"activity_period",typeName:"ActivityPeriod",enumMap:null},{id:14,type:"*Restriction",name:"restriction",typeName:"Restriction",enumMap:null},{id:15,type:"*Artist",name:"related",typeName:"Artist",enumMap:null},{id:16,type:"bool",name:"is_portrait_album_cover",enumMap:null},{id:17,type:"ImageGroup",name:"portrait_group",typeName:"ImageGroup",enumMap:null}]},{name:"AlbumGroup",fields:[{id:1,type:"*Album",name:"album",typeName:"Album",enumMap:null}]},{name:"Date",fields:[{id:1,type:"sint32",name:"year",enumMap:null},{id:2,type:"sint32",name:"month",enumMap:null},{id:3,type:"sint32",name:"day",enumMap:null}]},{name:"Album",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"*Artist",name:"artist",typeName:"Artist",enumMap:null},{id:4,type:"#",name:"type",typeName:"Type",enumMap:{name:"Album.Type",toName:{1:"ALBUM",2:"SINGLE",3:"COMPILATION"},toNumber:{ALBUM:1,SINGLE:2,COMPILATION:3}}},{id:5,type:"string",name:"label",enumMap:null},{id:6,type:"Date",name:"date",typeName:"Date",enumMap:null},{id:7,type:"sint32",name:"popularity",enumMap:null},{id:8,type:"*string",name:"genre",enumMap:null},{id:9,type:"*Image",name:"cover",typeName:"Image",enumMap:null},{id:10,type:"*ExternalId",name:"external_id",typeName:"ExternalId",enumMap:null},{id:11,type:"*Disc",name:"disc",typeName:"Disc",enumMap:null},{id:12,type:"*string",name:"review",enumMap:null},{id:13,type:"*Copyright",name:"copyright",typeName:"Copyright",enumMap:null},{id:14,type:"*Restriction",name:"restriction",typeName:"Restriction",enumMap:null},{id:15,type:"*Album",name:"related",typeName:"Album",enumMap:null},{id:16,type:"*SalePeriod",name:"sale_period",typeName:"SalePeriod",enumMap:null},{id:17,type:"ImageGroup",name:"cover_group",typeName:"ImageGroup",enumMap:null}]},{name:"Track",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"Album",name:"album",typeName:"Album",enumMap:null},{id:4,type:"*Artist",name:"artist",typeName:"Artist",enumMap:null},{id:5,type:"sint32",name:"number",enumMap:null},{id:6,type:"sint32",name:"disc_number",enumMap:null},{id:7,type:"sint32",name:"duration",enumMap:null},{id:8,type:"sint32",name:"popularity",enumMap:null},{id:9,type:"bool",name:"explicit",enumMap:null},{id:10,type:"*ExternalId",name:"external_id",typeName:"ExternalId",enumMap:null},{id:11,type:"*Restriction",name:"restriction",typeName:"Restriction",enumMap:null},{id:12,type:"*AudioFile",name:"file",typeName:"AudioFile",enumMap:null},{id:13,type:"*Track",name:"alternative",typeName:"Track",enumMap:null},{id:14,type:"*SalePeriod",name:"sale_period",typeName:"SalePeriod",enumMap:null},{id:15,type:"*AudioFile",name:"preview",typeName:"AudioFile",enumMap:null}]},{name:"Image",fields:[{id:1,type:"bytes",name:"file_id",enumMap:null},{id:2,type:"#",name:"size",typeName:"Size",enumMap:{name:"Image.Size",toName:{0:"DEFAULT",1:"SMALL",2:"LARGE",3:"XLARGE"},toNumber:{DEFAULT:0,SMALL:1,LARGE:2,XLARGE:3}}},{id:3,type:"sint32",name:"width",enumMap:null},{id:4,type:"sint32",name:"height",enumMap:null}]},{name:"ImageGroup",fields:[{id:1,type:"*Image",name:"image",typeName:"Image",enumMap:null}]},{name:"Biography",fields:[{id:1,type:"string",name:"text",enumMap:null},{id:2,type:"*Image",name:"portrait",typeName:"Image",enumMap:null},{id:3,type:"*ImageGroup",name:"portrait_group",typeName:"ImageGroup",enumMap:null}]},{name:"Disc",fields:[{id:1,type:"sint32",name:"number",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"*Track",name:"track",typeName:"Track",enumMap:null}]},{name:"Copyright",fields:[{id:1,type:"#",name:"type",typeName:"Type",enumMap:{name:"Copyright.Type",toName:{0:"P",1:"C"},toNumber:{P:0,C:1}}},{id:2,type:"string",name:"text",enumMap:null}]},{name:"Restriction",fields:[{id:2,type:"string",name:"countries_allowed",enumMap:null},{id:3,type:"string",name:"countries_forbidden",enumMap:null},{id:4,type:"#",name:"type",typeName:"Type",enumMap:{name:"Restriction.Type",toName:{0:"STREAMING"},toNumber:{STREAMING:0}}},{id:5,type:"*string",name:"catalogue_str",enumMap:null}]},{name:"SalePeriod",fields:[{id:1,type:"*Restriction",name:"restriction",typeName:"Restriction",enumMap:null},{id:2,type:"Date",name:"start",typeName:"Date",enumMap:null},{id:3,type:"Date",name:"end",typeName:"Date",enumMap:null}]},{name:"ExternalId",fields:[{id:1,type:"string",name:"type",enumMap:null},{id:2,type:"string",name:"id",enumMap:null}]},{name:"AudioFile",fields:[{id:1,type:"bytes",name:"file_id",enumMap:null},{id:2,type:"#",name:"format",typeName:"Format",enumMap:{name:"AudioFile.Format",toName:{0:"OGG_VORBIS_96",1:"OGG_VORBIS_160",2:"OGG_VORBIS_320",3:"MP3_256",4:"MP3_320",5:"MP3_160",6:"MP3_96",7:"MP3_160_ENC"},toNumber:{OGG_VORBIS_96:0,OGG_VORBIS_160:1,OGG_VORBIS_320:2,MP3_256:3,MP3_320:4,MP3_160:5,MP3_96:6,MP3_160_ENC:7}}}]}],playlist4changes:[{name:"ChangeInfo",fields:[{id:1,type:"string",name:"user",enumMap:null},{id:2,type:"int32",name:"timestamp",enumMap:null},{id:3,type:"bool",name:"admin",enumMap:null},{id:4,type:"bool",name:"undo",enumMap:null},{id:5,type:"bool",name:"redo",enumMap:null},{id:6,type:"bool",name:"merge",enumMap:null},{id:7,type:"bool",name:"compressed",enumMap:null},{id:8,type:"bool",name:"migration",enumMap:null}]},{name:"Delta",fields:[{id:1,type:"bytes",name:"base_version",enumMap:null},{id:2,type:"*Op",name:"ops",typeName:"Op",enumMap:null},{id:4,type:"ChangeInfo",name:"info",typeName:"ChangeInfo",enumMap:null}]},{name:"Merge",fields:[{id:1,type:"bytes",name:"base_version",enumMap:null},{id:2,type:"bytes",name:"merge_version",enumMap:null},{id:4,type:"ChangeInfo",name:"info",typeName:"ChangeInfo",enumMap:null}]},{name:"ChangeSet",fields:[{id:1,type:"#",name:"kind",typeName:"Kind",enumMap:{name:"ChangeSet.Kind",toName:{0:"KIND_UNKNOWN",2:"DELTA",3:"MERGE"},toNumber:{KIND_UNKNOWN:0,DELTA:2,MERGE:3}}},{id:2,type:"Delta",name:"delta",typeName:"Delta",enumMap:null},{id:3,type:"Merge",name:"merge",typeName:"Merge",enumMap:null}]},{name:"RevisionTaggedChangeSet",fields:[{id:1,type:"bytes",name:"revision",enumMap:null},{id:2,type:"ChangeSet",name:"change_set",typeName:"ChangeSet",enumMap:null}]},{name:"Diff",fields:[{id:1,type:"bytes",name:"from_revision",enumMap:null},{id:2,type:"*Op",name:"ops",typeName:"Op",enumMap:null},{id:3,type:"bytes",name:"to_revision",enumMap:null}]},{name:"ListDump",fields:[{id:1,type:"bytes",name:"latestRevision",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"ListAttributes",name:"attributes",typeName:"ListAttributes",enumMap:null},{id:4,type:"ListChecksum",name:"checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListItems",name:"contents",typeName:"ListItems",enumMap:null},{id:7,type:"*Delta",name:"pendingDeltas",typeName:"Delta",enumMap:null}]},{name:"ListChanges",fields:[{id:1,type:"bytes",name:"baseRevision",enumMap:null},{id:2,type:"*Delta",name:"deltas",typeName:"Delta",enumMap:null},{id:3,type:"bool",name:"wantResultingRevisions",enumMap:null},{id:4,type:"bool",name:"wantSyncResult",enumMap:null},{id:5,type:"ListDump",name:"dump",typeName:"ListDump",enumMap:null},{id:6,type:"*int32",name:"nonces",enumMap:null}]},{name:"SelectedListContent",fields:[{id:1,type:"bytes",name:"revision",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"ListAttributes",name:"attributes",typeName:"ListAttributes",enumMap:null},{id:4,type:"ListChecksum",name:"checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListItems",name:"contents",typeName:"ListItems",enumMap:null},{id:6,type:"Diff",name:"diff",typeName:"Diff",enumMap:null},{id:7,type:"Diff",name:"syncResult",typeName:"Diff",enumMap:null},{id:8,type:"*bytes",name:"resultingRevisions",enumMap:null},{id:9,type:"bool",name:"multipleHeads",enumMap:null},{id:10,type:"bool",name:"upToDate",enumMap:null},{id:12,type:"*ClientResolveAction",name:"resolveAction",typeName:"ClientResolveAction",enumMap:null},{id:13,type:"*ClientIssue",name:"issues",typeName:"ClientIssue",enumMap:null},{id:14,type:"*int32",name:"nonces",enumMap:null}]}],playlist4content:[{name:"Item",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"ItemAttributes",name:"attributes",typeName:"ItemAttributes",enumMap:null}]},{name:"ListItems",fields:[{id:1,type:"int32",name:"pos",enumMap:null},{id:2,type:"bool",name:"truncated",enumMap:null},{id:3,type:"*Item",name:"items",typeName:"Item",enumMap:null}]},{name:"ContentRange",fields:[{id:1,type:"int32",name:"pos",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null}]},{name:"ListContentSelection",fields:[{id:1,type:"bool",name:"wantRevision",enumMap:null},{id:2,type:"bool",name:"wantLength",enumMap:null},{id:3,type:"bool",name:"wantAttributes",enumMap:null},{id:4,type:"bool",name:"wantChecksum",enumMap:null},{id:5,type:"bool",name:"wantContent",enumMap:null},{id:6,type:"ContentRange",name:"contentRange",typeName:"ContentRange",enumMap:null},{id:7,type:"bool",name:"wantDiff",enumMap:null},{id:8,type:"bytes",name:"baseRevision",enumMap:null},{id:9,type:"bytes",name:"hintRevision",enumMap:null},{id:10,type:"bool",name:"wantNothingIfUpToDate",enumMap:null},{id:12,type:"bool",name:"wantResolveAction",enumMap:null},{id:13,type:"*ClientIssue",name:"issues",typeName:"ClientIssue",enumMap:null},{id:14,type:"*ClientResolveAction",name:"resolveAction",typeName:"ClientResolveAction",enumMap:null}]}],playlist4issues:[{name:"ClientIssue",fields:[{id:1,type:"#",name:"level",typeName:"Level",enumMap:{name:"ClientIssue.Level",toName:{0:"LEVEL_UNKNOWN",1:"LEVEL_DEBUG",2:"LEVEL_INFO",3:"LEVEL_NOTICE",4:"LEVEL_WARNING",5:"LEVEL_ERROR"},toNumber:{LEVEL_UNKNOWN:0,LEVEL_DEBUG:1,LEVEL_INFO:2,LEVEL_NOTICE:3,LEVEL_WARNING:4,LEVEL_ERROR:5}}},{id:2,type:"#",name:"code",typeName:"Code",enumMap:{name:"ClientIssue.Code",toName:{0:"CODE_UNKNOWN",1:"CODE_INDEX_OUT_OF_BOUNDS",2:"CODE_VERSION_MISMATCH",3:"CODE_CACHED_CHANGE",4:"CODE_OFFLINE_CHANGE",5:"CODE_CONCURRENT_CHANGE"},toNumber:{CODE_UNKNOWN:0,CODE_INDEX_OUT_OF_BOUNDS:1,CODE_VERSION_MISMATCH:2,CODE_CACHED_CHANGE:3,CODE_OFFLINE_CHANGE:4,CODE_CONCURRENT_CHANGE:5}}},{id:3,type:"int32",name:"repeatCount",enumMap:null}]},{name:"ClientResolveAction",fields:[{id:1,type:"#",name:"code",typeName:"Code",enumMap:{name:"ClientResolveAction.Code",toName:{0:"CODE_UNKNOWN",1:"CODE_NO_ACTION",2:"CODE_RETRY",3:"CODE_RELOAD",4:"CODE_DISCARD_LOCAL_CHANGES",5:"CODE_SEND_DUMP",6:"CODE_DISPLAY_ERROR_MESSAGE"},toNumber:{CODE_UNKNOWN:0,CODE_NO_ACTION:1,CODE_RETRY:2,CODE_RELOAD:3,CODE_DISCARD_LOCAL_CHANGES:4,CODE_SEND_DUMP:5,CODE_DISPLAY_ERROR_MESSAGE:6}}},{id:2,type:"#",name:"initiator",typeName:"Initiator",enumMap:{name:"ClientResolveAction.Initiator",toName:{0:"INITIATOR_UNKNOWN",1:"INITIATOR_SERVER",2:"INITIATOR_CLIENT"},toNumber:{INITIATOR_UNKNOWN:0,INITIATOR_SERVER:1,INITIATOR_CLIENT:2}}}]}],playlist4meta:[{name:"ListChecksum",fields:[{id:1,type:"int32",name:"version",enumMap:null},{id:4,type:"bytes",name:"sha1",enumMap:null}]},{name:"DownloadFormat",fields:[{id:1,type:"#",name:"codec",typeName:"Codec",enumMap:{name:"DownloadFormat.Codec",toName:{0:"CODEC_UNKNOWN",1:"OGG_VORBIS",2:"FLAC",3:"MPEG_1_LAYER_3"},toNumber:{CODEC_UNKNOWN:0,OGG_VORBIS:1,FLAC:2,MPEG_1_LAYER_3:3}}}]},{name:"ListAttributes",fields:[{id:1,type:"string",name:"name",enumMap:null},{id:2,type:"string",name:"description",enumMap:null},{id:3,type:"bytes",name:"picture",enumMap:null},{id:4,type:"bool",name:"collaborative",enumMap:null},{id:5,type:"string",name:"pl3_version",enumMap:null},{id:6,type:"bool",name:"deleted_by_owner",enumMap:null},{id:7,type:"bool",name:"restricted_collaborative",enumMap:null},{id:8,type:"int64",name:"deprecated_client_id",enumMap:null},{id:9,type:"bool",name:"public_starred",enumMap:null},{id:10,type:"string",name:"client_id",enumMap:null}]},{name:"ItemAttributes",fields:[{id:1,type:"string",name:"added_by",enumMap:null},{id:2,type:"int64",name:"timestamp",enumMap:null},{id:3,type:"string",name:"message",enumMap:null},{id:4,type:"bool",name:"seen",enumMap:null},{id:5,type:"int64",name:"download_count",enumMap:null},{id:6,type:"DownloadFormat",name:"download_format",typeName:"DownloadFormat",enumMap:null},{id:7,type:"string",name:"sevendigital_id",enumMap:null},{id:8,type:"int64",name:"sevendigital_left",enumMap:null},{id:9,type:"int64",name:"seen_at",enumMap:null},{id:10,type:"bool",name:"public",enumMap:null}]},{name:"StringAttribute",fields:[{id:1,type:"string",name:"key",enumMap:null},{id:2,type:"string",name:"value",enumMap:null}]},{name:"StringAttributes",fields:[{id:1,type:"*StringAttribute",name:"attribute",typeName:"StringAttribute",enumMap:null}]}],playlist4ops:[{name:"Add",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"*Item",name:"items",typeName:"Item",enumMap:null},{id:3,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:4,type:"bool",name:"addLast",enumMap:null},{id:5,type:"bool",name:"addFirst",enumMap:null}]},{name:"Rem",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"*Item",name:"items",typeName:"Item",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"items_checksum",typeName:"ListChecksum",enumMap:null},{id:6,type:"ListChecksum",name:"uris_checksum",typeName:"ListChecksum",enumMap:null},{id:7,type:"bool",name:"itemsAsKey",enumMap:null}]},{name:"Mov",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"int32",name:"toIndex",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"items_checksum",typeName:"ListChecksum",enumMap:null},{id:6,type:"ListChecksum",name:"uris_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"ItemAttributesPartialState",fields:[{id:1,type:"ItemAttributes",name:"values",typeName:"ItemAttributes",enumMap:null},{id:2,type:"*ItemAttributeKind",name:"no_value",typeName:"ItemAttributeKind",enumMap:null}]},{name:"ListAttributesPartialState",fields:[{id:1,type:"ListAttributes",name:"values",typeName:"ListAttributes",enumMap:null},{id:2,type:"*ListAttributeKind",name:"no_value",typeName:"ListAttributeKind",enumMap:null}]},{name:"UpdateItemAttributes",fields:[{id:1,type:"int32",name:"index",enumMap:null},{id:2,type:"ItemAttributesPartialState",name:"new_attributes",typeName:"ItemAttributesPartialState",enumMap:null},{id:3,type:"ItemAttributesPartialState",name:"old_attributes",typeName:"ItemAttributesPartialState",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"old_attributes_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"UpdateListAttributes",fields:[{id:1,type:"ListAttributesPartialState",name:"new_attributes",typeName:"ListAttributesPartialState",enumMap:null},{id:2,type:"ListAttributesPartialState",name:"old_attributes",typeName:"ListAttributesPartialState",enumMap:null},{id:3,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:4,type:"ListChecksum",name:"old_attributes_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"Op",fields:[{id:1,type:"#",name:"kind",typeName:"Kind",enumMap:{name:"Op.Kind",toName:{0:"KIND_UNKNOWN",2:"ADD",3:"REM",4:"MOV",5:"UPDATE_ITEM_ATTRIBUTES",6:"UPDATE_LIST_ATTRIBUTES"},toNumber:{KIND_UNKNOWN:0,ADD:2,REM:3,MOV:4,UPDATE_ITEM_ATTRIBUTES:5,UPDATE_LIST_ATTRIBUTES:6}}},{id:2,type:"Add",name:"add",typeName:"Add",enumMap:null},{id:3,type:"Rem",name:"rem",typeName:"Rem",enumMap:null},{id:4,type:"Mov",name:"mov",typeName:"Mov",enumMap:null},{id:5,type:"UpdateItemAttributes",name:"update_item_attributes",typeName:"UpdateItemAttributes",enumMap:null},{id:6,type:"UpdateListAttributes",name:"update_list_attributes",typeName:"UpdateListAttributes",enumMap:null}]},{name:"OpList",fields:[{id:1,type:"*Op",name:"ops",typeName:"Op",enumMap:null}]}],playlist4service:[{name:"RequestContext",fields:[{id:2,type:"bool",name:"administrative",enumMap:null},{id:4,type:"bool",name:"migration",enumMap:null},{id:7,type:"string",name:"tag",enumMap:null},{id:8,type:"bool",name:"useStarredView",enumMap:null},{id:9,type:"bool",name:"syncWithPublished",enumMap:null}]},{name:"GetCurrentRevisionArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null}]},{name:"GetChangesInSequenceRangeArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null},{id:3,type:"int32",name:"fromSequenceNumber",enumMap:null},{id:4,type:"int32",name:"toSequenceNumber",enumMap:null}]},{name:"GetChangesInSequenceRangeMatchingPl3VersionArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null},{id:3,type:"int32",name:"fromSequenceNumber",enumMap:null},{id:4,type:"int32",name:"toSequenceNumber",enumMap:null},{id:5,type:"string",name:"pl3Version",enumMap:null}]},{name:"GetChangesInSequenceRangeReturn",fields:[{id:1,type:"*RevisionTaggedChangeSet",name:"result",typeName:"RevisionTaggedChangeSet",enumMap:null}]},{name:"ObliterateListArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null}]},{name:"UpdatePublishedArgs",fields:[{id:1,type:"bytes",name:"publishedUri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null},{id:3,type:"bytes",name:"uri",enumMap:null},{id:4,type:"bool",name:"isPublished",enumMap:null}]},{name:"SynchronizeArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null},{id:3,type:"ListContentSelection",name:"selection",typeName:"ListContentSelection",enumMap:null},{id:4,type:"ListChanges",name:"changes",typeName:"ListChanges",enumMap:null}]},{name:"GetSnapshotAtRevisionArgs",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"RequestContext",name:"context",typeName:"RequestContext",enumMap:null},{id:3,type:"bytes",name:"revision",enumMap:null}]},{name:"SubscribeRequest",fields:[{id:1,type:"*bytes",name:"uris",enumMap:null}]},{name:"UnsubscribeRequest",fields:[{id:1,type:"*bytes",name:"uris",enumMap:null}]},{name:"Playlist4ServiceException",fields:[{id:1,type:"string",name:"why",enumMap:null},{id:2,type:"string",name:"symbol",enumMap:null},{id:3,type:"bool",name:"permanent",enumMap:null},{id:4,type:"string",name:"serviceErrorClass",enumMap:null},{id:5,type:"#",name:"inboxErrorKind",typeName:"Playlist4InboxErrorKind",enumMap:{name:"Playlist4InboxErrorKind",toName:{2:"INBOX_NOT_ALLOWED",3:"INBOX_INVALID_USER",4:"INBOX_INVALID_URI",5:"INBOX_LIST_TOO_LONG"},toNumber:{INBOX_NOT_ALLOWED:2,INBOX_INVALID_USER:3,INBOX_INVALID_URI:4,INBOX_LIST_TOO_LONG:5}}}]},{name:"SynchronizeReturn",fields:[{id:1,type:"SelectedListContent",name:"result",typeName:"SelectedListContent",enumMap:null},{id:4,type:"Playlist4ServiceException",name:"exception",typeName:"Playlist4ServiceException",enumMap:null}]},{name:"Playlist4ServiceCall",fields:[{id:1,type:"#",name:"kind",typeName:"Playlist4ServiceMethodKind",enumMap:{name:"Playlist4ServiceMethodKind",toName:{0:"METHOD_UNKNOWN",2:"METHOD_GET_CURRENT_REVISION",3:"METHOD_GET_CHANGES_IN_SEQUENCE_RANGE",4:"METHOD_OBLITERATE_LIST",5:"METHOD_SYNCHRONIZE",6:"METHOD_UPDATE_PUBLISHED",7:"METHOD_GET_CHANGES_IN_SEQUENCE_RANGE_MATCHING_PL3_VERSION",8:"METHOD_GET_SNAPSHOT_AT_REVISION"},toNumber:{METHOD_UNKNOWN:0,METHOD_GET_CURRENT_REVISION:2,METHOD_GET_CHANGES_IN_SEQUENCE_RANGE:3,METHOD_OBLITERATE_LIST:4,METHOD_SYNCHRONIZE:5,METHOD_UPDATE_PUBLISHED:6,METHOD_GET_CHANGES_IN_SEQUENCE_RANGE_MATCHING_PL3_VERSION:7,METHOD_GET_SNAPSHOT_AT_REVISION:8}}},{id:2,type:"GetCurrentRevisionArgs",name:"getCurrentRevisionArgs",typeName:"GetCurrentRevisionArgs",enumMap:null},{id:3,type:"GetChangesInSequenceRangeArgs",name:"getChangesInSequenceRangeArgs",typeName:"GetChangesInSequenceRangeArgs",enumMap:null},{id:4,type:"ObliterateListArgs",name:"obliterateListArgs",typeName:"ObliterateListArgs",enumMap:null},{id:5,type:"SynchronizeArgs",name:"synchronizeArgs",typeName:"SynchronizeArgs",enumMap:null},{id:6,type:"UpdatePublishedArgs",name:"updatePublishedArgs",typeName:"UpdatePublishedArgs",enumMap:null},{id:7,type:"GetChangesInSequenceRangeMatchingPl3VersionArgs",name:"getChangesInSequenceRangeMatchingPl3VersionArgs",typeName:"GetChangesInSequenceRangeMatchingPl3VersionArgs",enumMap:null},{id:8,type:"GetSnapshotAtRevisionArgs",name:"getSnapshotAtRevisionArgs",typeName:"GetSnapshotAtRevisionArgs",enumMap:null}]},{name:"Playlist4ServiceReturn",fields:[{id:1,type:"#",name:"kind",typeName:"Playlist4ServiceMethodKind",enumMap:{name:"Playlist4ServiceMethodKind",toName:{0:"METHOD_UNKNOWN",2:"METHOD_GET_CURRENT_REVISION",3:"METHOD_GET_CHANGES_IN_SEQUENCE_RANGE",4:"METHOD_OBLITERATE_LIST",5:"METHOD_SYNCHRONIZE",6:"METHOD_UPDATE_PUBLISHED",7:"METHOD_GET_CHANGES_IN_SEQUENCE_RANGE_MATCHING_PL3_VERSION",8:"METHOD_GET_SNAPSHOT_AT_REVISION"},toNumber:{METHOD_UNKNOWN:0,METHOD_GET_CURRENT_REVISION:2,METHOD_GET_CHANGES_IN_SEQUENCE_RANGE:3,METHOD_OBLITERATE_LIST:4,METHOD_SYNCHRONIZE:5,METHOD_UPDATE_PUBLISHED:6,METHOD_GET_CHANGES_IN_SEQUENCE_RANGE_MATCHING_PL3_VERSION:7,METHOD_GET_SNAPSHOT_AT_REVISION:8}}},{id:2,type:"Playlist4ServiceException",name:"exception",typeName:"Playlist4ServiceException",enumMap:null},{id:3,type:"bytes",name:"getCurrentRevisionReturn",enumMap:null},{id:4,type:"GetChangesInSequenceRangeReturn",name:"getChangesInSequenceRangeReturn",typeName:"GetChangesInSequenceRangeReturn",enumMap:null},{id:5,type:"bool",name:"obliterateListReturn",enumMap:null},{id:6,type:"SynchronizeReturn",name:"synchronizeReturn",typeName:"SynchronizeReturn",enumMap:null},{id:7,type:"bool",name:"updatePublishedReturn",enumMap:null},{id:8,type:"GetChangesInSequenceRangeReturn",name:"getChangesInSequenceRangeMatchingPl3VersionReturn",typeName:"GetChangesInSequenceRangeReturn",enumMap:null},{id:9,type:"RevisionTaggedListSnapshot",name:"getSnapshotAtRevisionReturn",typeName:"RevisionTaggedListSnapshot",enumMap:null}]},{name:"CreateListReply",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"bytes",name:"revision",enumMap:null}]},{name:"ModifyReply",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"bytes",name:"revision",enumMap:null}]},{name:"ListChecksum",fields:[{id:1,type:"int32",name:"version",enumMap:null},{id:4,type:"bytes",name:"sha1",enumMap:null}]},{name:"DownloadFormat",fields:[{id:1,type:"#",name:"codec",typeName:"Codec",enumMap:{name:"DownloadFormat.Codec",toName:{0:"CODEC_UNKNOWN",1:"OGG_VORBIS",2:"FLAC",3:"MPEG_1_LAYER_3"},toNumber:{CODEC_UNKNOWN:0,OGG_VORBIS:1,FLAC:2,MPEG_1_LAYER_3:3}}}]},{name:"ListAttributes",fields:[{id:1,type:"string",name:"name",enumMap:null},{id:2,type:"string",name:"description",enumMap:null},{id:3,type:"bytes",name:"picture",enumMap:null},{id:4,type:"bool",name:"collaborative",enumMap:null},{id:5,type:"string",name:"pl3_version",enumMap:null},{id:6,type:"bool",name:"deleted_by_owner",enumMap:null},{id:7,type:"bool",name:"restricted_collaborative",enumMap:null},{id:8,type:"int64",name:"deprecated_client_id",enumMap:null},{id:9,type:"bool",name:"public_starred",enumMap:null},{id:10,type:"string",name:"client_id",enumMap:null}]},{name:"ItemAttributes",fields:[{id:1,type:"string",name:"added_by",enumMap:null},{id:2,type:"int64",name:"timestamp",enumMap:null},{id:3,type:"string",name:"message",enumMap:null},{id:4,type:"bool",name:"seen",enumMap:null},{id:5,type:"int64",name:"download_count",enumMap:null},{id:6,type:"DownloadFormat",name:"download_format",typeName:"DownloadFormat",enumMap:null},{id:7,type:"string",name:"sevendigital_id",enumMap:null},{id:8,type:"int64",name:"sevendigital_left",enumMap:null},{id:9,type:"int64",name:"seen_at",enumMap:null},{id:10,type:"bool",name:"public",enumMap:null}]},{name:"StringAttribute",fields:[{id:1,type:"string",name:"key",enumMap:null},{id:2,type:"string",name:"value",enumMap:null}]},{name:"StringAttributes",fields:[{id:1,type:"*StringAttribute",name:"attribute",typeName:"StringAttribute",enumMap:null}]},{name:"Item",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"ItemAttributes",name:"attributes",typeName:"ItemAttributes",enumMap:null}]},{name:"ListItems",fields:[{id:1,type:"int32",name:"pos",enumMap:null},{id:2,type:"bool",name:"truncated",enumMap:null},{id:3,type:"*Item",name:"items",typeName:"Item",enumMap:null}]},{name:"ContentRange",fields:[{id:1,type:"int32",name:"pos",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null}]},{name:"ListContentSelection",fields:[{id:1,type:"bool",name:"wantRevision",enumMap:null},{id:2,type:"bool",name:"wantLength",enumMap:null},{id:3,type:"bool",name:"wantAttributes",enumMap:null},{id:4,type:"bool",name:"wantChecksum",enumMap:null},{id:5,type:"bool",name:"wantContent",enumMap:null},{id:6,type:"ContentRange",name:"contentRange",typeName:"ContentRange",enumMap:null},{id:7,type:"bool",name:"wantDiff",enumMap:null},{id:8,type:"bytes",name:"baseRevision",enumMap:null},{id:9,type:"bytes",name:"hintRevision",enumMap:null},{id:10,type:"bool",name:"wantNothingIfUpToDate",enumMap:null},{id:12,type:"bool",name:"wantResolveAction",enumMap:null},{id:13,type:"*ClientIssue",name:"issues",typeName:"ClientIssue",enumMap:null},{id:14,type:"*ClientResolveAction",name:"resolveAction",typeName:"ClientResolveAction",enumMap:null}]},{name:"Add",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"*Item",name:"items",typeName:"Item",enumMap:null},{id:3,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:4,type:"bool",name:"addLast",enumMap:null},{id:5,type:"bool",name:"addFirst",enumMap:null}]},{name:"Rem",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"*Item",name:"items",typeName:"Item",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"items_checksum",typeName:"ListChecksum",enumMap:null},{id:6,type:"ListChecksum",name:"uris_checksum",typeName:"ListChecksum",enumMap:null},{id:7,type:"bool",name:"itemsAsKey",enumMap:null}]},{name:"Mov",fields:[{id:1,type:"int32",name:"fromIndex",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null},{id:3,type:"int32",name:"toIndex",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"items_checksum",typeName:"ListChecksum",enumMap:null},{id:6,type:"ListChecksum",name:"uris_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"ItemAttributesPartialState",fields:[{id:1,type:"ItemAttributes",name:"values",typeName:"ItemAttributes",enumMap:null},{id:2,type:"*#",name:"no_value",typeName:"ItemAttributeKind",enumMap:{name:"ItemAttributeKind",toName:{0:"ITEM_UNKNOWN",1:"ITEM_ADDED_BY",2:"ITEM_TIMESTAMP",3:"ITEM_MESSAGE",4:"ITEM_SEEN",5:"ITEM_DOWNLOAD_COUNT",6:"ITEM_DOWNLOAD_FORMAT",7:"ITEM_SEVENDIGITAL_ID",8:"ITEM_SEVENDIGITAL_LEFT",9:"ITEM_SEEN_AT",10:"ITEM_PUBLIC"},toNumber:{ITEM_UNKNOWN:0,ITEM_ADDED_BY:1,ITEM_TIMESTAMP:2,ITEM_MESSAGE:3,ITEM_SEEN:4,ITEM_DOWNLOAD_COUNT:5,ITEM_DOWNLOAD_FORMAT:6,ITEM_SEVENDIGITAL_ID:7,ITEM_SEVENDIGITAL_LEFT:8,ITEM_SEEN_AT:9,ITEM_PUBLIC:10}}}]},{name:"ListAttributesPartialState",fields:[{id:1,type:"ListAttributes",name:"values",typeName:"ListAttributes",enumMap:null},{id:2,type:"*#",name:"no_value",typeName:"ListAttributeKind",enumMap:{name:"ListAttributeKind",toName:{0:"LIST_UNKNOWN",1:"LIST_NAME",2:"LIST_DESCRIPTION",3:"LIST_PICTURE",4:"LIST_COLLABORATIVE",5:"LIST_PL3_VERSION",6:"LIST_DELETED_BY_OWNER",7:"LIST_RESTRICTED_COLLABORATIVE"},toNumber:{LIST_UNKNOWN:0,LIST_NAME:1,LIST_DESCRIPTION:2,LIST_PICTURE:3,LIST_COLLABORATIVE:4,LIST_PL3_VERSION:5,LIST_DELETED_BY_OWNER:6,LIST_RESTRICTED_COLLABORATIVE:7}}}]},{name:"UpdateItemAttributes",
fields:[{id:1,type:"int32",name:"index",enumMap:null},{id:2,type:"ItemAttributesPartialState",name:"new_attributes",typeName:"ItemAttributesPartialState",enumMap:null},{id:3,type:"ItemAttributesPartialState",name:"old_attributes",typeName:"ItemAttributesPartialState",enumMap:null},{id:4,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:5,type:"ListChecksum",name:"old_attributes_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"UpdateListAttributes",fields:[{id:1,type:"ListAttributesPartialState",name:"new_attributes",typeName:"ListAttributesPartialState",enumMap:null},{id:2,type:"ListAttributesPartialState",name:"old_attributes",typeName:"ListAttributesPartialState",enumMap:null},{id:3,type:"ListChecksum",name:"list_checksum",typeName:"ListChecksum",enumMap:null},{id:4,type:"ListChecksum",name:"old_attributes_checksum",typeName:"ListChecksum",enumMap:null}]},{name:"Op",fields:[{id:1,type:"#",name:"kind",typeName:"Kind",enumMap:{name:"Op.Kind",toName:{0:"KIND_UNKNOWN",2:"ADD",3:"REM",4:"MOV",5:"UPDATE_ITEM_ATTRIBUTES",6:"UPDATE_LIST_ATTRIBUTES"},toNumber:{KIND_UNKNOWN:0,ADD:2,REM:3,MOV:4,UPDATE_ITEM_ATTRIBUTES:5,UPDATE_LIST_ATTRIBUTES:6}}},{id:2,type:"Add",name:"add",typeName:"Add",enumMap:null},{id:3,type:"Rem",name:"rem",typeName:"Rem",enumMap:null},{id:4,type:"Mov",name:"mov",typeName:"Mov",enumMap:null},{id:5,type:"UpdateItemAttributes",name:"update_item_attributes",typeName:"UpdateItemAttributes",enumMap:null},{id:6,type:"UpdateListAttributes",name:"update_list_attributes",typeName:"UpdateListAttributes",enumMap:null}]},{name:"PlaylistModificationInfo",fields:[{id:1,type:"bytes",name:"uri",enumMap:null},{id:2,type:"bytes",name:"new_revision",enumMap:null},{id:3,type:"bytes",name:"parent_revision",enumMap:null},{id:4,type:"*Op",name:"ops",typeName:"Op",enumMap:null}]}],popcount:[{name:"PopcountRequest",fields:[]},{name:"PopcountResult",fields:[{id:1,type:"sint64",name:"count",enumMap:null},{id:2,type:"bool",name:"truncated",enumMap:null},{id:3,type:"*string",name:"user",enumMap:null},{id:4,type:"*sint64",name:"subscriptionTimestamps",enumMap:null},{id:5,type:"*sint64",name:"insertionTimestamps",enumMap:null}]}],presence:[{name:"PlaylistPublishedState",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"int64",name:"timestamp",enumMap:null}]},{name:"PlaylistTrackAddedState",fields:[{id:1,type:"string",name:"playlist_uri",enumMap:null},{id:2,type:"string",name:"track_uri",enumMap:null},{id:3,type:"int64",name:"timestamp",enumMap:null}]},{name:"TrackFinishedPlayingState",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"context_uri",enumMap:null},{id:3,type:"int64",name:"timestamp",enumMap:null},{id:4,type:"string",name:"referrer_uri",enumMap:null}]},{name:"FavoriteAppAddedState",fields:[{id:1,type:"string",name:"app_uri",enumMap:null},{id:2,type:"int64",name:"timestamp",enumMap:null}]},{name:"TrackStartedPlayingState",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"context_uri",enumMap:null},{id:3,type:"int64",name:"timestamp",enumMap:null},{id:4,type:"string",name:"referrer_uri",enumMap:null}]},{name:"UriSharedState",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"message",enumMap:null},{id:3,type:"int64",name:"timestamp",enumMap:null}]},{name:"ArtistFollowedState",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"artist_name",enumMap:null},{id:3,type:"string",name:"artist_cover_uri",enumMap:null},{id:4,type:"int64",name:"timestamp",enumMap:null}]},{name:"DeviceInformation",fields:[{id:1,type:"string",name:"os",enumMap:null},{id:2,type:"string",name:"type",enumMap:null}]},{name:"GenericPresenceState",fields:[{id:1,type:"int32",name:"type",enumMap:null},{id:2,type:"int64",name:"timestamp",enumMap:null},{id:3,type:"string",name:"item_uri",enumMap:null},{id:4,type:"string",name:"item_name",enumMap:null},{id:5,type:"string",name:"item_image",enumMap:null},{id:6,type:"string",name:"context_uri",enumMap:null},{id:7,type:"string",name:"context_name",enumMap:null},{id:8,type:"string",name:"context_image",enumMap:null},{id:9,type:"string",name:"referrer_uri",enumMap:null},{id:10,type:"string",name:"referrer_name",enumMap:null},{id:11,type:"string",name:"referrer_image",enumMap:null},{id:12,type:"string",name:"message",enumMap:null},{id:13,type:"DeviceInformation",name:"device_information",typeName:"DeviceInformation",enumMap:null}]},{name:"State",fields:[{id:1,type:"int64",name:"timestamp",enumMap:null},{id:2,type:"#",name:"type",typeName:"Type",enumMap:{name:"State.Type",toName:{1:"PLAYLIST_PUBLISHED",2:"PLAYLIST_TRACK_ADDED",3:"TRACK_FINISHED_PLAYING",4:"FAVORITE_APP_ADDED",5:"TRACK_STARTED_PLAYING",6:"URI_SHARED",7:"ARTIST_FOLLOWED",11:"GENERIC"},toNumber:{PLAYLIST_PUBLISHED:1,PLAYLIST_TRACK_ADDED:2,TRACK_FINISHED_PLAYING:3,FAVORITE_APP_ADDED:4,TRACK_STARTED_PLAYING:5,URI_SHARED:6,ARTIST_FOLLOWED:7,GENERIC:11}}},{id:3,type:"string",name:"uri",enumMap:null},{id:4,type:"PlaylistPublishedState",name:"playlist_published",typeName:"PlaylistPublishedState",enumMap:null},{id:5,type:"PlaylistTrackAddedState",name:"playlist_track_added",typeName:"PlaylistTrackAddedState",enumMap:null},{id:6,type:"TrackFinishedPlayingState",name:"track_finished_playing",typeName:"TrackFinishedPlayingState",enumMap:null},{id:7,type:"FavoriteAppAddedState",name:"favorite_app_added",typeName:"FavoriteAppAddedState",enumMap:null},{id:8,type:"TrackStartedPlayingState",name:"track_started_playing",typeName:"TrackStartedPlayingState",enumMap:null},{id:9,type:"UriSharedState",name:"uri_shared",typeName:"UriSharedState",enumMap:null},{id:10,type:"ArtistFollowedState",name:"artist_followed",typeName:"ArtistFollowedState",enumMap:null},{id:11,type:"GenericPresenceState",name:"generic",typeName:"GenericPresenceState",enumMap:null}]},{name:"StateList",fields:[{id:1,type:"*State",name:"states",typeName:"State",enumMap:null}]}],pubsub:[{name:"Subscription",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"int32",name:"expiry",enumMap:null},{id:3,type:"int32",name:"status_code",enumMap:null}]}],radio:[{name:"RadioRequest",fields:[{id:1,type:"*string",name:"uris",enumMap:null},{id:2,type:"int32",name:"salt",enumMap:null},{id:4,type:"int32",name:"length",enumMap:null},{id:5,type:"string",name:"stationId",enumMap:null},{id:6,type:"*string",name:"lastTracks",enumMap:null}]},{name:"MultiSeedRequest",fields:[{id:1,type:"*string",name:"uris",enumMap:null}]},{name:"Feedback",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"type",enumMap:null},{id:3,type:"double",name:"timestamp",enumMap:null}]},{name:"Tracks",fields:[{id:1,type:"*string",name:"gids",enumMap:null},{id:2,type:"string",name:"source",enumMap:null},{id:3,type:"string",name:"identity",enumMap:null},{id:4,type:"*string",name:"tokens",enumMap:null},{id:5,type:"*Feedback",name:"feedback",typeName:"Feedback",enumMap:null}]},{name:"Station",fields:[{id:1,type:"string",name:"id",enumMap:null},{id:2,type:"string",name:"title",enumMap:null},{id:3,type:"string",name:"titleUri",enumMap:null},{id:4,type:"string",name:"subtitle",enumMap:null},{id:5,type:"string",name:"subtitleUri",enumMap:null},{id:6,type:"string",name:"imageUri",enumMap:null},{id:7,type:"double",name:"lastListen",enumMap:null},{id:8,type:"*string",name:"seeds",enumMap:null},{id:9,type:"int32",name:"thumbsUp",enumMap:null},{id:10,type:"int32",name:"thumbsDown",enumMap:null}]},{name:"Rules",fields:[{id:1,type:"string",name:"js",enumMap:null}]},{name:"StationResponse",fields:[{id:1,type:"Station",name:"station",typeName:"Station",enumMap:null},{id:2,type:"*Feedback",name:"feedback",typeName:"Feedback",enumMap:null}]},{name:"StationList",fields:[{id:1,type:"*Station",name:"stations",typeName:"Station",enumMap:null}]},{name:"LikedPlaylist",fields:[{id:1,type:"string",name:"uri",enumMap:null}]}],search:[{name:"SearchRequest",fields:[{id:1,type:"string",name:"query",enumMap:null},{id:2,type:"#",name:"type",typeName:"Type",enumMap:{name:"SearchRequest.Type",toName:{0:"TRACK",1:"ALBUM",2:"ARTIST",3:"PLAYLIST",4:"USER"},toNumber:{TRACK:0,ALBUM:1,ARTIST:2,PLAYLIST:3,USER:4}}},{id:3,type:"int32",name:"limit",enumMap:null},{id:4,type:"int32",name:"offset",enumMap:null},{id:5,type:"bool",name:"did_you_mean",enumMap:null},{id:2,type:"string",name:"spotify_uri",enumMap:null},{id:3,type:"*bytes",name:"file_id",enumMap:null},{id:4,type:"string",name:"url",enumMap:null},{id:5,type:"string",name:"slask_id",enumMap:null}]},{name:"Playlist",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"*Image",name:"image",typeName:"Image",enumMap:null}]},{name:"User",fields:[{id:1,type:"string",name:"username",enumMap:null},{id:2,type:"string",name:"full_name",enumMap:null},{id:3,type:"*Image",name:"image",typeName:"Image",enumMap:null},{id:4,type:"sint32",name:"followers",enumMap:null}]},{name:"SearchReply",fields:[{id:1,type:"sint32",name:"hits",enumMap:null},{id:2,type:"*Track",name:"track",typeName:"Track",enumMap:null},{id:3,type:"*Album",name:"album",typeName:"Album",enumMap:null},{id:4,type:"*Artist",name:"artist",typeName:"Artist",enumMap:null},{id:5,type:"*Playlist",name:"playlist",typeName:"Playlist",enumMap:null},{id:6,type:"string",name:"did_you_mean",enumMap:null},{id:7,type:"*User",name:"user",typeName:"User",enumMap:null}]}],social:[{name:"DecorationData",fields:[{id:1,type:"string",name:"username",enumMap:null},{id:2,type:"string",name:"full_name",enumMap:null},{id:3,type:"string",name:"image_url",enumMap:null},{id:5,type:"string",name:"large_image_url",enumMap:null},{id:6,type:"string",name:"first_name",enumMap:null},{id:7,type:"string",name:"last_name",enumMap:null},{id:8,type:"string",name:"facebook_uid",enumMap:null}]}],socialgraph:[{name:"CountReply",fields:[{id:1,type:"*int32",name:"counts",enumMap:null}]},{name:"UserListRequest",fields:[{id:1,type:"string",name:"last_result",enumMap:null},{id:2,type:"int32",name:"count",enumMap:null},{id:3,type:"bool",name:"include_length",enumMap:null}]},{name:"UserListReply",fields:[{id:1,type:"*User",name:"users",typeName:"User",enumMap:null},{id:2,type:"int32",name:"length",enumMap:null}]},{name:"User",fields:[{id:1,type:"string",name:"username",enumMap:null},{id:2,type:"int32",name:"subscriber_count",enumMap:null},{id:3,type:"int32",name:"subscription_count",enumMap:null}]},{name:"ArtistListReply",fields:[{id:1,type:"*Artist",name:"artists",typeName:"Artist",enumMap:null}]},{name:"Artist",fields:[{id:1,type:"string",name:"artistid",enumMap:null},{id:2,type:"int32",name:"subscriber_count",enumMap:null}]},{name:"StringListRequest",fields:[{id:1,type:"*string",name:"args",enumMap:null}]},{name:"StringListReply",fields:[{id:1,type:"*string",name:"reply",enumMap:null}]},{name:"TopPlaylistsRequest",fields:[{id:1,type:"string",name:"username",enumMap:null},{id:2,type:"int32",name:"count",enumMap:null}]},{name:"TopPlaylistsReply",fields:[{id:1,type:"*string",name:"uris",enumMap:null}]}],spirc:[{name:"Goodbye",fields:[{id:1,type:"string",name:"reason",enumMap:null}]},{name:"TrackRef",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"uri",enumMap:null},{id:3,type:"bool",name:"queued",enumMap:null},{id:4,type:"string",name:"context",enumMap:null}]},{name:"State",fields:[{id:2,type:"string",name:"context_uri",enumMap:null},{id:3,type:"uint32",name:"index",enumMap:null},{id:4,type:"uint32",name:"position_ms",enumMap:null},{id:5,type:"#",name:"status",typeName:"PlayStatus",enumMap:{name:"PlayStatus",toName:{0:"kPlayStatusStop",1:"kPlayStatusPlay",2:"kPlayStatusPause",3:"kPlayStatusLoading"},toNumber:{kPlayStatusStop:0,kPlayStatusPlay:1,kPlayStatusPause:2,kPlayStatusLoading:3}}},{id:7,type:"uint64",name:"position_measured_at",enumMap:null},{id:13,type:"bool",name:"shuffle",enumMap:null},{id:14,type:"bool",name:"repeat",enumMap:null},{id:20,type:"string",name:"last_command_ident",enumMap:null},{id:21,type:"uint32",name:"last_command_msgid",enumMap:null},{id:24,type:"bool",name:"playing_from_fallback",enumMap:null},{id:25,type:"uint32",name:"row",enumMap:null},{id:26,type:"uint32",name:"playing_track_index",enumMap:null},{id:27,type:"*TrackRef",name:"track",typeName:"TrackRef",enumMap:null}]},{name:"Capability",fields:[{id:1,type:"#",name:"type",typeName:"CapabilityType",enumMap:{name:"CapabilityType",toName:{1:"kSupportedContexts",2:"kCanBePlayer",3:"kRestrictToLocal",4:"kDeviceType"},toNumber:{kSupportedContexts:1,kCanBePlayer:2,kRestrictToLocal:3,kDeviceType:4}}},{id:2,type:"*int64",name:"intValue",enumMap:null},{id:3,type:"*string",name:"stringValue",enumMap:null}]},{name:"DeviceState",fields:[{id:10,type:"bool",name:"is_active",enumMap:null},{id:11,type:"bool",name:"can_play",enumMap:null},{id:12,type:"uint32",name:"volume",enumMap:null},{id:13,type:"string",name:"name",enumMap:null},{id:14,type:"uint32",name:"error_code",enumMap:null},{id:15,type:"int64",name:"became_active_at",enumMap:null},{id:16,type:"string",name:"error_message",enumMap:null},{id:17,type:"*Capability",name:"capabilities",typeName:"Capability",enumMap:null}]},{name:"Frame",fields:[{id:1,type:"uint32",name:"version",enumMap:null},{id:2,type:"string",name:"ident",enumMap:null},{id:3,type:"string",name:"protocol_version",enumMap:null},{id:4,type:"uint32",name:"seq_nr",enumMap:null},{id:5,type:"#",name:"type",typeName:"MessageType",enumMap:{name:"MessageType",toName:{1:"kMessageTypeHello",2:"kMessageTypeGoodbye",3:"kMessageTypeProbe",10:"kMessageTypeNotify",20:"kMessageTypeLoad",21:"kMessageTypePlay",22:"kMessageTypePause",23:"kMessageTypePlayPause",24:"kMessageTypeSeek",25:"kMessageTypePrev",26:"kMessageTypeNext",27:"kMessageTypeVolume",28:"kMessageTypeShuffle",29:"kMessageTypeRepeat",31:"kMessageTypeVolumeDown",32:"kMessageTypeVolumeUp",33:"kMessageTypeReplace"},toNumber:{kMessageTypeHello:1,kMessageTypeGoodbye:2,kMessageTypeProbe:3,kMessageTypeNotify:10,kMessageTypeLoad:20,kMessageTypePlay:21,kMessageTypePause:22,kMessageTypePlayPause:23,kMessageTypeSeek:24,kMessageTypePrev:25,kMessageTypeNext:26,kMessageTypeVolume:27,kMessageTypeShuffle:28,kMessageTypeRepeat:29,kMessageTypeVolumeDown:31,kMessageTypeVolumeUp:32,kMessageTypeReplace:33}}},{id:7,type:"DeviceState",name:"device_state",typeName:"DeviceState",enumMap:null},{id:11,type:"Goodbye",name:"goodbye",typeName:"Goodbye",enumMap:null},{id:12,type:"State",name:"state",typeName:"State",enumMap:null},{id:13,type:"uint32",name:"position",enumMap:null},{id:14,type:"uint32",name:"volume",enumMap:null},{id:17,type:"int64",name:"state_update_id",enumMap:null},{id:18,type:"*string",name:"recipient",enumMap:null}]}],suggest:[{name:"Track",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"bytes",name:"image",enumMap:null},{id:4,type:"*string",name:"artist_name",enumMap:null},{id:5,type:"*bytes",name:"artist_gid",enumMap:null},{id:6,type:"uint32",name:"rank",enumMap:null}]},{name:"Artist",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"bytes",name:"image",enumMap:null},{id:6,type:"uint32",name:"rank",enumMap:null}]},{name:"Album",fields:[{id:1,type:"bytes",name:"gid",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"bytes",name:"image",enumMap:null},{id:4,type:"*string",name:"artist_name",enumMap:null},{id:5,type:"*bytes",name:"artist_gid",enumMap:null},{id:6,type:"uint32",name:"rank",enumMap:null}]},{name:"Playlist",fields:[{id:1,type:"string",name:"uri",enumMap:null},{id:2,type:"string",name:"name",enumMap:null},{id:3,type:"string",name:"image_uri",enumMap:null},{id:4,type:"string",name:"owner_name",enumMap:null},{id:5,type:"string",name:"owner_uri",enumMap:null},{id:6,type:"uint32",name:"rank",enumMap:null}]},{name:"Suggestions",fields:[{id:1,type:"*Track",name:"track",typeName:"Track",enumMap:null},{id:2,type:"*Album",name:"album",typeName:"Album",enumMap:null},{id:3,type:"*Artist",name:"artist",typeName:"Artist",enumMap:null},{id:4,type:"*Playlist",name:"playlist",typeName:"Playlist",enumMap:null}]}],toplist:[{name:"Toplist",fields:[{id:1,type:"*string",name:"items",enumMap:null}]}]},Spotify.HermesCache=function(){var Cache=Spotify.Cache.Default,CACHE_POLICY_PRIVATE="CACHE_PRIVATE",CACHE_POLICY_PUBLIC="CACHE_PUBLIC",CACHE_TEMPORARY_LIMIT=500,CACHE_PERSISTENT_LIMIT=5e3,CACHE_NAME="Spotify.Mercury.Cache",CACHE_VERSION=5,CACHE_INDEXEDDB_KEY="indexeddb",CACHABLE_METHODS=["GET","HEAD"],_self=this,_caches=[null,null],_events=new Spotify.Events,_isUsingIndexedDB=function(){var data=!1;try{data=JSON.parse(localStorage.getItem(CACHE_INDEXEDDB_KEY)||!1)}catch(err){}return data},_setIsUsingIndexedDB=function(){return localStorage.setItem(CACHE_INDEXEDDB_KEY,"true")},_getVersion=function(key){return parseInt(localStorage.getItem(key))},_setVersion=function(key,version){return localStorage.setItem(key,version.toString())},_isReady=function(){return null!=_caches[Spotify.Cache.Types.TEMPORARY]&&null!=_caches[Spotify.Cache.Types.PERSISTENT]},_maybeTriggerReady=function(){_isReady()&&_self.trigger(_events.READY)},_makeOnCacheSuccess=function(type){return function(cache){var key="com.spotify.cache."+(type||"generic")+".version",_onSuccess=function(){_setVersion(key,CACHE_VERSION),_caches[type]=cache,_maybeTriggerReady()};_getVersion(key)!=CACHE_VERSION?cache.clear(_onSuccess):_onSuccess()}},_onError=function(){throw new Error("Failed creating caches!")},_getCacheForKey=function(key){return key.indexOf("hm://playlist/")>=0?_caches[Spotify.Cache.Types.PERSISTENT]:_caches[Spotify.Cache.Types.TEMPORARY]},_migrateToIndexedDB=function(fnSuccess,fnError,ctx){if(_isUsingIndexedDB())return void fnSuccess.call(ctx);var cacheOld=_caches[Spotify.Cache.Types.PERSISTENT],cacheNew=new Cache(CACHE_PERSISTENT_LIMIT,new Spotify.Cache.IndexedDBStorage(CACHE_NAME));delete _caches[Spotify.Cache.Types.PERSISTENT];var _onItem=function(key,value){cacheNew.put(key,value)},_onDone=function(){_caches[Spotify.Cache.Types.PERSISTENT]=cacheNew,cacheOld.clear(),_setIsUsingIndexedDB(),fnSuccess.call(ctx,this)},_onCache=function(){cacheOld._storage.each(_onItem,_onDone,this)};cacheNew.initialize(_onCache,fnError,ctx)},_initialize=function(){Spotify.EventTarget.call(_self);var cache=new Cache(CACHE_TEMPORARY_LIMIT,new Spotify.Cache.MemoryStorage(CACHE_NAME));cache.initialize(_makeOnCacheSuccess(Spotify.Cache.Types.TEMPORARY),_onError),cache=_isUsingIndexedDB()?new Cache(CACHE_PERSISTENT_LIMIT,new Spotify.Cache.IndexedDBStorage(CACHE_NAME)):new Cache(CACHE_PERSISTENT_LIMIT,new Spotify.Cache.LocalStorage(CACHE_NAME)),cache.initialize(_makeOnCacheSuccess(Spotify.Cache.Types.PERSISTENT),_onError)},_currentTime=function(){return(new Date).getTime()},_put=function(uri,key,frames,ttl,etag){var value={frames:frames,expires:_currentTime()+1e3*ttl};etag&&(value.etag=etag);var cache=_getCacheForKey(uri);cache.put(key,value,null,null,_self.onfull)},_get=function(uri,key,fnHit,fnMiss,fnExpired,ctx){var cache=_getCacheForKey(uri),_onCacheItem=function(key,value){null==value?fnMiss.call(ctx):value.expires<_currentTime()?value.etag?fnExpired.call(ctx,value.frames,value.etag):(cache.remove(key),fnMiss.call(ctx)):fnHit.call(ctx,value.frames)};cache.get(key,_onCacheItem)};_self.onReady=function(fn,ctx){_isReady()?fn.call(ctx):_self.bind(_events.READY,fn,ctx)},_self.isRequestCacheable=function(request){return-1!=CACHABLE_METHODS.indexOf(request.getMethod())},_self.getCacheKey=function(request){for(var key=[request.getMethod(),request.getURI()],i=0,len=request.getRequestFrameCount();len>i;++i)key.push(request.getRequestFrame(i));return key.join("")},_self.getCachedFrames=function(uri,key,fnHit,fnMiss,fnExpired,ctx){_isReady()?_get(uri,key,fnHit,fnMiss,fnExpired,ctx):_self.onReady(function(){_get(uri,key,fnHit,fnMiss,fnExpired,ctx)})},_self.setCachedFrames=function(uri,key,policy,ttl,etag,frames){if(!_isReady()){var args=arguments;return void _self.onReady(function(){_self.setCachedFrames.apply(_self,args)})}!ttl||policy!=CACHE_POLICY_PRIVATE&&policy!=CACHE_POLICY_PUBLIC||_put(uri,key,frames,ttl,etag)},_self.removeAllContaining=function(key,callback){var cache=_getCacheForKey(key);cache.removeAllContaining(key,callback)},_self.onfull=function(){},_self.migrateToIndexedDB=_migrateToIndexedDB,_initialize()},function(){"function"!=typeof window.btoa&&(window.btoa=Spotify.Utils.Base64.encode),"function"!=typeof window.atob&&(window.atob=Spotify.Utils.Base64.decode);var _debugger=Spotify.DebuggerJS,HEADER_SCHEMA=Spotify.Protobuf.Serialization.createFromJson([{name:"Header",fields:[{id:1,type:"string",name:"uri"},{id:2,type:"string",name:"content_type"},{id:3,type:"string",name:"method"},{id:4,type:"sint32",name:"status_code"},{id:5,type:"string",name:"source"},{id:6,type:"*UserField",name:"user_fields"}]},{name:"UserField",fields:[{id:1,type:"string",name:"name"},{id:2,type:"bytes",name:"value"}]}]).Header,HERMES_STATUS_OK=200,HERMES_STATUS_OK_MAX_RANGE=299,HERMES_STATUS_NOT_MODIFIED=304,CACHE_POLICY_PRIVATE="CACHE_PRIVATE",CACHE_POLICY_PUBLIC="CACHE_PUBLIC",USER_FIELD_CACHE_POLICY="MC-Cache-Policy",USER_FIELD_TTL="MC-TTL",USER_FIELD_ETAG="MC-ETag",MERCURY_MGET_REQUEST_CONTENT_TYPE="vnd.spotify/mercury-mget-request",MERCURY_MGET_REPLY_CONTENT_TYPE="vnd.spotify/mercury-mget-reply",HERMES_MESSAGE_REQUEST=0,HERMES_MESSAGE_SUB=1,HERMES_MESSAGE_UNSUB=2;Spotify.Hermes.Header=HEADER_SCHEMA,Spotify.Hermes.Request=function(params){if(void 0==params.uri)throw new Error("URI not specified!");var _cache=Spotify.Hermes.Cache;this.getMethod=function(){return params.method},this.getURI=function(){return params.uri},this.getRequestFrameCount=function(){return 0},this.getRequestFrameData=function(index){return null},this.setRequestFrameData=function(index,data){},this.getRequestFrame=function(index){return null},this.parseResponseFrame=function(index,data){return data};var _parseFrames=function(frames){for(var data=[],parseStartTime=(new Date).getTime(),i=1,len=frames.length;len>i;++i)data.push(this.parseResponseFrame(i-1,frames[i]));return _debugger.log("Spotify.Hermes.Request",["It took",(new Date).getTime()-parseStartTime,"ms to parse the frames"],"parsing_times"),data},_arrayAtob=function(a){for(var b=[],i=0,len=a.length;len>i;++i)b.push(window.atob(a[i]));return b},_getUserFields=function(header){var userFields={};if(header.user_fields)for(var i=0,len=header.user_fields.length;len>i;++i){var field=header.user_fields[i];switch(field.name){case USER_FIELD_CACHE_POLICY:"private"==field.value?userFields.cache_policy=CACHE_POLICY_PRIVATE:"public"==field.value&&(userFields.cache_policy=CACHE_POLICY_PUBLIC);break;case USER_FIELD_TTL:userFields.ttl=field.value;break;case USER_FIELD_ETAG:userFields.etag=field.value}}return userFields},_addUserField=function(header,name,value){header.user_fields=header.user_fields||[],header.user_fields.push({name:name,value:value})},_hermesRequestType=function(method){switch(method){case"SUB":return HERMES_MESSAGE_SUB;case"UNSUB":return HERMES_MESSAGE_UNSUB}return HERMES_MESSAGE_REQUEST},_sendInternal=function(bridge,onSuccess,onError,cachedFrames,etag,persistent,callType){var _onSuccess=function(result){var frames=_arrayAtob(result.response),header=HEADER_SCHEMA.parseFromStringSync(frames[0]),status=header.status_code;if(status>=HERMES_STATUS_OK&&HERMES_STATUS_OK_MAX_RANGE>=status){var userFields=_getUserFields(header);_cache.setCachedFrames(this.getURI(),_cache.getCacheKey(this),userFields.cache_policy,userFields.ttl,userFields.etag,frames),onSuccess(_parseFrames.call(this,frames),status,header)}else status==HERMES_STATUS_NOT_MODIFIED?onSuccess(_parseFrames.call(this,cachedFrames),status,header):onError(new Spotify.Errors.Error([13,status,null,header]))};null!=cachedFrames&&null!=etag?params.user_fields=[{name:USER_FIELD_ETAG,value:etag}]:delete params.user_fields;for(var messageType=_hermesRequestType(this.getMethod()),parseStartTime=(new Date).getTime(),requestFrames=[messageType,window.btoa(HEADER_SCHEMA.serializeToStringSync(params))],i=0,len=this.getRequestFrameCount();len>i;++i)requestFrames.push(window.btoa(this.getRequestFrame(i)));_debugger.log("Spotify.Hermes.Request",["It took",(new Date).getTime()-parseStartTime,"ms to serialize the request"],"parsing_times"),bridge.rpc("hm_b64",requestFrames,_onSuccess,onError,this,persistent||!1,2,callType)},_framesToMercuryReply=function(frames){if(2!=frames.length)throw new Error("Invalid number of frames!");var header=HEADER_SCHEMA.parseFromStringSync(frames[0]),reply={content_type:header.content_type,status_code:header.status_code,body:frames[1]},userFields=_getUserFields(header);for(var key in userFields)reply[key]=userFields[key];return reply},_mercuryReplyToFrames=function(reply,uri){var header={uri:uri,content_type:reply.content_type,status_code:reply.status_code};return reply.cache_policy==CACHE_POLICY_PUBLIC?_addUserField(header,USER_FIELD_CACHE_POLICY,"public"):reply.cache_policy==CACHE_POLICY_PRIVATE&&_addUserField(header,USER_FIELD_CACHE_POLICY,"private"),void 0!==reply.ttl&&_addUserField(header,USER_FIELD_TTL,reply.ttl),void 0!==reply.etag&&_addUserField(header,USER_FIELD_ETAG,reply.etag),[HEADER_SCHEMA.serializeToStringSync(header),reply.body]},_sendInternalMultiGet=function(bridge,onSuccess,onError,persistent,bypassCache,callType){if(bypassCache="undefined"!=typeof bypassCache?bypassCache:!1,1!=this.getRequestFrameCount())throw new Error("Invalid number of request frames!");var frame=this.getRequestFrameData(0),requests=frame.request,requestCount=requests.length,requestsToSend=[],requestIndices=[],responses=new Array(requestCount),_getCacheKey=function(request){return"GET"+request.uri+(request.body||"")},_onSuccess=function(result){var frames=_arrayAtob(result.response),header=HEADER_SCHEMA.parseFromStringSync(frames[0]),status=header.status_code;if(!Spotify.Hermes.Request.isSuccess(status))return void onError(new Spotify.Errors.Error([Spotify.Errors.Domains.HERMES_ERROR,status]));if(header.content_type!=MERCURY_MGET_REPLY_CONTENT_TYPE)return void onError(new Spotify.Errors.Error([Spotify.Errors.Domains.HERMES_ERROR,500,"Server didn't send a multi-GET reply!"]));if(2!=frames.length)return void onError(new Spotify.Errors.Error([Spotify.Errors.Domains.HERMES_ERROR,500,"Invalid number of frames in multi-GET reply!"]));for(var response=this.parseResponseFrame(0,frames[1]),replies=response.reply,parseStartTime=(new Date).getTime(),i=0,len=replies.length;len>i;++i){var request=requestsToSend[i],reply=replies[i],index=requestIndices.shift();reply.status_code==HERMES_STATUS_NOT_MODIFIED?(responses[index]=_framesToMercuryReply(request.cachedFrames),responses[index].status_code=HERMES_STATUS_OK):Spotify.Hermes.Request.isSuccess(reply.status_code)?(responses[index]=reply,_cache.setCachedFrames(request.uri,_getCacheKey(request),reply.cache_policy,reply.ttl,reply.etag,_mercuryReplyToFrames(reply,request.uri))):delete responses[index]}_debugger.log("Spotify.Hermes.Request",["It took",(new Date).getTime()-parseStartTime,"ms to parse the frames"],"parsing_times"),onSuccess([{reply:responses}],status)},_onCacheLookupDone=function(){if(0==requestsToSend.length)onSuccess([{reply:responses}],HERMES_STATUS_OK);else{var parseStartTime=(new Date).getTime(),requestFrames=[HERMES_MESSAGE_REQUEST,window.btoa(HEADER_SCHEMA.serializeToStringSync(params))];this.setRequestFrameData(0,{request:requestsToSend}),requestFrames.push(window.btoa(this.getRequestFrame(0))),_debugger.log("Spotify.Hermes.Request",["It took",(new Date).getTime()-parseStartTime,"ms to serialize the request"],"parsing_times"),bridge.rpc("hm_b64",requestFrames,_onSuccess,onError,this,persistent||!1,2,callType)}},_maybeCacheLookupDone=function(){--requestCount<=0&&_onCacheLookupDone.call(this)},_makeOnCacheHit=function(index){return function(cachedFrames){responses[index]=_framesToMercuryReply(cachedFrames),_maybeCacheLookupDone.call(this)}},_makeOnCacheMiss=function(index){return function(){requestsToSend.push(requests[index]),requestIndices.push(index),_maybeCacheLookupDone.call(this)}},_makeOnCacheExpired=function(index){return function(cachedFrames,etag){requests[index].etag=etag,requests[index].cachedFrames=cachedFrames,requestsToSend.push(requests[index]),requestIndices.push(index),_maybeCacheLookupDone.call(this)}};if(bypassCache)for(var i=0,len=requests.length;len>i;++i)_makeOnCacheMiss(i).call(this);else for(var i=0,len=requests.length;len>i;++i){var request=requests[i];_cache.getCachedFrames(request.uri,_getCacheKey(request),_makeOnCacheHit(i),_makeOnCacheMiss(i),_makeOnCacheExpired(i),this)}};this.send=function(bridge,onSuccess,onError,persistent,bypassCache,callType){if(bypassCache="undefined"!=typeof bypassCache?bypassCache:!1,params.content_type==MERCURY_MGET_REQUEST_CONTENT_TYPE)_sendInternalMultiGet.call(this,bridge,onSuccess,onError,persistent,bypassCache,callType);else{var _onCacheHit=function(cachedFrames){var header=HEADER_SCHEMA.parseFromStringSync(cachedFrames[0]);onSuccess(_parseFrames.call(this,cachedFrames),HERMES_STATUS_OK,header)},_onCacheMiss=function(){_sendInternal.call(this,bridge,onSuccess,onError,null,null,persistent,callType)},_onCacheExpired=function(cachedFrames,etag){_sendInternal.call(this,bridge,onSuccess,onError,cachedFrames,etag,persistent,callType)};bypassCache||!_cache.isRequestCacheable(this)?_onCacheMiss.call(this):_cache.getCachedFrames(this.getURI(),_cache.getCacheKey(this),_onCacheHit,_onCacheMiss,_onCacheExpired,this)}}},Spotify.Hermes.Request.isSuccess=function(status){return status>=200&&300>status},Spotify.Hermes.Request.isRedirect=function(status){return status>=300&&400>status},Spotify.Hermes.Request.isClientError=function(status){return status>=400&&500>status},Spotify.Hermes.Request.isServerError=function(status){return status>=500&&600>status},Spotify.Hermes.StringRequest=function(params,requestData){var _self=new Spotify.Hermes.Request(params);return _self.getRequestFrameCount=function(){return requestData.length},_self.getRequestFrameData=function(index){return requestData[index]},_self.setRequestFrameData=function(index,data){requestData[index]=data},_self.getRequestFrame=function(index){return requestData[index]},_self.parseResponseFrame=function(index,data){return data},_self},Spotify.Hermes.ProtobufRequest=function(params,requestData,requestSchemas,responseSchemas){var _self=new Spotify.Hermes.Request(params);return _self.getRequestFrameCount=function(){return requestData.length},_self.getRequestFrameData=function(index){return requestData[index]},_self.setRequestFrameData=function(index,data){requestData[index]=data},_self.getRequestFrame=function(index){return requestSchemas[index]?requestSchemas[index].serializeToStringSync(requestData[index]):requestData[index]},_self.parseResponseFrame=function(index,data){return index<responseSchemas.length?responseSchemas[index].parseFromStringSync(data):data},_self}}(),Spotify.Hermes.Handler=function(protobufSchemasManager){Spotify.EventTarget.call(this);var _gateway=null,_schemas={},_protobufSchemasManager=protobufSchemasManager,CALL_TYPE="hermes",_getProtobufMessage=function(message){var segments,id,key;if(void 0!==typeof message&&(segments=message.split("#"),Spotify.Utils.isArray(segments)&&2==segments.length))return id=segments[0],key=segments[1],_protobufSchemasManager.getProtobufMsgParser(id,key);throw new Error("Not a valid message!")};this.send=function(uri,method,ass,rds,requestData,onSuccess,onError,persistent,bypassCache){persistent=persistent||!1;var requestSchemas=[],responseSchemas=[];if(!Spotify.Utils.isArray(ass)&&!Spotify.Utils.isArray(rds))throw"Hermes:send Wrong arguments";for(var i=0;i<ass.length;i++)requestSchemas.push(_getProtobufMessage(ass[i]));for(var i=0;i<rds.length;i++)responseSchemas.push(_getProtobufMessage(rds[i]));var req=new Spotify.Hermes.ProtobufRequest({uri:uri,method:method},requestData,requestSchemas,responseSchemas);req.send(_gateway,onSuccess,onError,persistent,bypassCache,CALL_TYPE);
},this.loadSchemas=function(schemas,type,callback,errorCallback){var uniqueid;if(!Spotify.Utils.isArray(schemas))return void errorCallback(new Error("Schemas is not an array"));var now=(new Date).getTime()+Math.floor(1e3*Math.random()),uniqueid=Spotify.Utils.Base64.encode(now.toString())+"_";if("undefined"!=typeof _schemas[uniqueid])return void callback(uniqueid);var onSchemaLoaded=function(id,sch){_protobufSchemasManager.registerSchema(id,sch),callback(id)};try{var schema=new Spotify.Protobuf.Schema(schemas,onSchemaLoaded,errorCallback,null);_schemas[uniqueid]=schema,type!==schema.PROTO&&type!==schema.JSON&&(type=schema.JSON),schema.id=uniqueid,schema.type=type,schema.reset(),schema.load()}catch(e){throw"undefined"!=typeof errorCallback&&errorCallback(e),e}},this.loadSchemaData=function(schemas,callback,errorCallback){var key,obj,schema,now=(new Date).getTime()+Math.floor(1e3*Math.random()),uniqueid=Spotify.Utils.Base64.encode(now.toString())+"_";if(!Spotify.Utils.isArray(schemas))return void errorCallback(new Error("Schemas is not an array"));schemas=schemas.join("\n");for(key in _schemas)obj=_schemas[key],obj===schemas[0]&&(schema=obj,uniqueid=key);"undefined"==typeof schema&&(schema=_protobufSchemasManager.registerSchema(uniqueid,schemas),_schemas[uniqueid]=schema),callback(uniqueid)},this.init=function(gateway){_gateway=gateway}},Spotify.GatewayTypes={WEBSOCKETS:"WEBSOCKETS"},Spotify.PlayerTypes={FLASH_RTMPS:"FLASH_RTMPS",FLASH_HTTP:"FLASH_HTTP",FLASH_HTTP_ENCRYPTED:"FLASH_HTTP_ENCRYPTED",FLASH_AAC:"FLASH_AAC",WEBSOCKETS_STREAMING:"WEBSOCKETS_STREAMING",HTML5_HTTP:"HTML5_HTTP"},Spotify.Protocols={RTMPS:"RTMPS",RTMP:"RTMP",HTTP:"HTTP",HTTPS:"HTTPS"},Spotify.Instances=function(){var _instances={},exports={add:function(instance){return instance.id="SPFBIn_"+Math.floor(1e4*Math.random()),_instances[instance.id]=instance,_instances[Spotify.Utils.Base64.encode(instance.id)]=instance,!0},get:function(id){return void 0!==typeof _instances[id]?_instances[id]:void 0}};return exports}(),Spotify.Features=function(features){var _features=features||{};this.isEnabled=function(feature){return!!_features[feature]},this.getNumber=function(feature){return Number(_features[feature])},this.getAll=function(){return _features}},Spotify.Flash.SWFObject=function(args){Spotify.EventTarget.call(this);var _debugger=Spotify.DebuggerJS,_self=this;this.isLoaded=!1;var _events=new Spotify.Events,_swfMinVersion="11.0.0";this.getSWF=function(){if(this.isLoaded){if(window.document[args.SWFFlashId])return window.document[args.SWFFlashId];if(-1!==navigator.appName.indexOf("Microsoft Internet"))return document.getElementById(args.SWFFlashId);if(document.embeds&&document.embeds[args.SWFFlashId])return document.embeds[args.SWFFlashId]}else _debugger.error("Spotify.Flash.SWFObject",["SWF Object is not loaded...."],"corejs")},this.initialize=function(){if(swfobject.hasFlashPlayerVersion(_swfMinVersion)){var flashvars={playerType:args.playerType||"",valid:0,id:args.SWFFlashId||"",length:0,instanceId:args.instanceId,logging:args.logging,analyticsLogging:args.analyticsLogging},params={quality:"high",allowscriptaccess:"always",wmode:"window",bgcolor:"#2c2c2d"},attributes={id:args.SWFFlashId,name:args.SWFFlashId,align:"middle"};swfobject.embedSWF(args.SWFUrl,args.SWFContainerId,"1","1",_swfMinVersion,"",flashvars,params,attributes,flashLoaded)}else _self.trigger(_events.FLASH_UNAVAILABLE),_debugger.error("Spotify.Flash.SWFObject",["Your Flash is not up to date: "+_swfMinVersion],"corejs")};var flashLoaded=function(event){!1===event.success?(_self.trigger(_events.FLASH_UNAVAILABLE),_debugger.error("Spotify.Flash.SWFObject",["Cannot load SWF object"],"corejs")):(_self.trigger(_events.FLASH_AVAILABLE),_self.isLoaded=!0)}},Spotify.Flash.PlayerInterface=function(id,settings){Spotify.EventTarget.call(this);var _flashObject,_self=(Spotify.DebuggerJS,this),_events=new Spotify.Events;this.hasSoundCapabilities=!0;var _onFlashEvent=function(event){this.trigger(event.type,event.params)};this.run=function(what){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded?_flashObject.getSWF().sp_run(what):!1},this.playpause=function(id){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities?_flashObject.getSWF().sp_playpause(id):!1},this.position=function(id){try{if("undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities)return _flashObject.getSWF().sp_time(id)}catch(e){return 0}},this.getPlayerState=function(id){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities&&(response=_flashObject.getSWF().sp_playerState(id)),response},this.seek=function(id,pos){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities?_flashObject.getSWF().sp_seek(id,pos):void 0},this.pause=function(id){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities&&_flashObject.getSWF().sp_pause(id)},this.resume=function(id){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities&&_flashObject.getSWF().sp_resume(id)},this.stop=function(id){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities&&_flashObject.getSWF().sp_stop(id)},this.load=function(id,trackUri,extra){extra=extra||{},"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities&&_flashObject.getSWF().sp_load(id,trackUri,extra)},this.play=function(id,position){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities&&_flashObject.getSWF().sp_play(id,position)},this.setVolume=function(id,volume){if("undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities)try{_flashObject.getSWF().sp_setVolume(id,volume)}catch(e){}},this.getVolume=function(id){if("undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities)try{return _flashObject.getSWF().sp_getVolume(id)}catch(e){}return 1},this.getDuration=function(id){if("undefined"!=typeof _flashObject&&_flashObject.isLoaded&&this.hasSoundCapabilities)try{return _flashObject.getSWF().sp_getDuration(id)}catch(e){}return 0},this.hasSound=function(){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded?(this.hasSoundCapabilities=_flashObject.getSWF().sp_hasSound(),this.hasSoundCapabilities):!1},this.addPlayer=function(index,identifier,type){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities?_flashObject.getSWF().sp_addPlayer(index,identifier,type):void 0},this.appendChunk=function(id,url,extra){extra=extra||{},"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities&&_flashObject.getSWF().sp_appendChunk(id,url,extra)},this.base62hex=function(id,str){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities&&_flashObject.getSWF().sp_base62hex(id,str)},this.removePlayerAtIndex=function(index){return"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities?(_flashObject.getSWF().sp_removePlayerAtIndex(index),!0):!1},this.initializePlayerById=function(id){"undefined"!=typeof _flashObject&&_flashObject.isLoaded&&_self.hasSoundCapabilities&&_flashObject.getSWF().sp_initializePlayerById(id)},this.initialize=function(){_flashObject=new Spotify.Flash.SWFObject({playerType:settings.playerType,SWFFlashId:id+"_player",SWFContainerId:settings.SWFPlayerContainerId,SWFUrl:settings.SWFPlayerUrl,SWFMinVersion:settings.SWFMinVersion,instanceId:id,logging:settings.logging,analyticsLogging:settings.analyticsLogging,length:settings.valid,valid:0}),_flashObject.bind(_events.FLASH_AVAILABLE,_onFlashEvent,this),_flashObject.bind(_events.FLASH_UNAVAILABLE,_onFlashEvent,this),_flashObject.initialize()},this.onLoad=function(event){},this.onPlay=function(event){},this.onPause=function(event){},this.onStop=function(event){},this.onTrackEnded=function(event){},this.onSongLoaded=function(event){},this.onPositionChanged=function(event){},this.onInvalidTrackUri=function(event){},this.onPlaybackFailed=function(event){}},Spotify.HTML5.PlayerInterface=function(){Spotify.EventTarget.call(this);var _pauseThrottle=(Spotify.DebuggerJS,null),_events=new Spotify.Events,_players={};this.hasSoundCapabilities=!0;var _convertSecondsToMS=function(seconds){return Math.floor(1e3*seconds)},_convertMSToSeconds=function(ms){return Math.floor(.001*ms)};this.run=function(what){return!1},this.playpause=function(id){var player=_players[id];player&&(player.paused?this.play(id):this.pause(id))},this.position=function(id){var player=_players[id];return player?_convertSecondsToMS(player.currentTime):0},this.getPlayerState=function(id){var player=_players[id],position=player?_convertSecondsToMS(player.currentTime):0,duration=player?_convertSecondsToMS(player.duration):0,isPaused=player?player.paused:!1,state={position:position,duration:duration,isPaused:isPaused,isPlaying:!isPaused,isStopped:!1};return state},this.seek=function(id,pos){var player=_players[id];if(player&&this._loaded){var posInSec=_convertMSToSeconds(pos);posInSec<=player.duration&&(player.currentTime=posInSec)}},this.pause=function(id){var player=_players[id];player&&player.pause()},this.resume=function(id){var player=_players[id];player&&player.play()},this.stop=function(id){var player=_players[id];player&&(player.removeAttribute("src"),this.trigger(_events.STOPPED,{},id))},this.load=function(id,trackUri,extra){var player=_players[id];if(player){if(this._loaded=!1,extra.startFrom>0){var seeker=function(){player.currentTime=_convertMSToSeconds(extra.startFrom),player.removeEventListener("canplay",seeker),extra.autoplay&&player.play()};player.addEventListener("canplay",seeker)}else player.autoplay=!!extra.autoplay;player.src=trackUri,player.load()}},this.play=function(id,position){var player=_players[id];player&&player.play()},this.setVolume=function(id,volume){var player=_players[id];player&&(player.volume=volume)},this.getVolume=function(id){var player=_players[id];return player?parseFloat(player.volume):0},this.getDuration=function(id){var player=_players[id];return player?_convertSecondsToMS(player.duration):0},this.hasSound=function(){return!0},this.addPlayer=function(index,identifier,type){var player=document.createElement("audio");player.loop=!1,player.preload="auto",player.volume=1,player.addEventListener("canplay",function(){this._loaded=!0,this.trigger(_events.FIRST_BYTES,{},{}),this.trigger(_events.LOAD,{},identifier)}.bind(this),!1),player.addEventListener("timeupdate",function(e){this.trigger(_events.PROGRESS,{position:_convertSecondsToMS(player.currentTime)},identifier)}.bind(this)),player.addEventListener("durationchange",function(e){var trigger=function(){this.trigger(_events.DURATION,_convertSecondsToMS(player.duration),identifier),this.unbind(_events.LOAD,trigger)}.bind(this);this._loaded?trigger():this.bind(_events.LOAD,trigger)}.bind(this)),player.addEventListener("playing",function(){this.trigger(_events.PLAYING,{},identifier)}.bind(this),!1),player.addEventListener("pause",function(){_pauseThrottle=setTimeout(function(){this.trigger(_events.PAUSED,{},identifier)}.bind(this),10)}.bind(this),!1),player.addEventListener("seeked",function(){this.trigger(_events.POSITION_CHANGED,_convertSecondsToMS(player.currentTime),identifier)}.bind(this),!1),player.addEventListener("ended",function(){clearTimeout(_pauseThrottle),this.trigger(_events.TRACK_ENDED,{},identifier)}.bind(this),!1),player.addEventListener("error",function(e){this.trigger(_events.PLAYBACK_FAILED,{},identifier)}.bind(this),!1),_players[identifier]=player},this.removePlayerAtIndex=function(index){},this.initializePlayerById=function(id){},this.initialize=function(){this.trigger(_events.READY)},this.onLoad=function(event){},this.onPlay=function(event){},this.onPause=function(event){},this.onStop=function(event){},this.onTrackEnded=function(event){},this.onSongLoaded=function(event){},this.onPositionChanged=function(event){},this.onInvalidTrackUri=function(event){},this.onPlaybackFailed=function(event){}},Spotify.Parsers.Facebook=function(){this.makeCredential=function(facebookUid,accessToken){var frame={};if(facebookUid||accessToken){var cred=frame.credential={};facebookUid&&(cred.facebook_uid=facebookUid),accessToken&&(cred.access_token=accessToken)}return frame},this.parseConfig=function(reply){var frame=reply[0];return frame},this.parseCredential=function(reply,opt_fieldName){var cred,facebookUid=null,accessToken=null;return opt_fieldName||(opt_fieldName="credential"),reply&&reply[0]&&(cred=reply[0][opt_fieldName]),cred&&(cred.facebook_uid&&(facebookUid=cred.facebook_uid),cred.access_token&&(accessToken=cred.access_token)),{facebookUid:facebookUid,accessToken:accessToken}},this.parseCredentialInspection=function(reply){var frame=reply[0],alternativeCredential=null;return frame.alternative_credential&&(alternativeCredential=this.parseCredential(reply,"alternative_credential")),{alternativeCredential:alternativeCredential,appUser:frame.app_user||null,permanentError:frame.permanent_error||!1,transientError:frame.transient_error||!1}},this.parseFriend=function(friendData){return{facebookUid:friendData.facebook_uid,appUser:friendData.app_user||null,username:friendData.spotify_username||null,name:friendData.display_name||null,picture:friendData.picture_large||null}},this.parseFriendList=function(reply){for(var friends=[],list=reply[0].friends,i=0;i<list.length;i++)friends.push(this.parseFriend(list[i]));return friends},this.parsePermissions=function(reply){var frame=reply[0];return frame.permissions},this.parsePostId=function(reply){var frame=reply[0];return frame.post_id}},Spotify.Parsers.Metadata=function(){var Utils=(Spotify.Link,Spotify.Utils),AVAILABILITY_AVAILABLE="available",AVAILABILITY_REGIONAL="regional",AVAILABILITY_PREMIUM="premium",AVAILABILITY_UNAVAILABLE="unavailable",CATALOGUE_PREMIUM="premium",CATALOGUE_ALL="all",_albumGroupNames=["album_group","single_group","compilation_group","appears_on_group"],_countryInList=function(country,countries){for(var i=0,len=countries.length;len>i;i+=2)if(country[0]==countries[i]&&country[1]==countries[i+1])return!0;return!1},_hasAnySuitableFile=function(track){if(void 0!=track.file){for(var i=0,len=track.file.length;len>i;++i)if("MP3_160_ENC"==track.file[i].format)return!0;delete track.file}return!1},_parseBiography=function(biography){return void 0!=biography.portrait&&delete biography.portrait,biography};this.isPlayable=function(availability,user){return availability==AVAILABILITY_PREMIUM&&user.catalogue==CATALOGUE_PREMIUM?!0:availability==AVAILABILITY_AVAILABLE},this.parseAlbum=function(album,user){if(void 0!=album.gid&&(album.id=Utils.str2hex(album.gid),delete album.gid),void 0!=album.artist)for(var i=0,len=album.artist.length;len>i;++i)album.artist[i]=this.parseArtist(album.artist[i],null);if(void 0!=album.disc)for(var i=0,len=album.disc.length;len>i;++i)album.disc[i]=this.parseDisc(album.disc[i]);if(null!=user&&(album.availability=this.parseRestrictions(album.restriction,user),album.playable=this.isPlayable(album.availability,user)),void 0!=album.restriction&&delete album.restriction,void 0!=album.related)for(var i=0,len=album.related.length;len>i;++i)album.related[i]=this.parseAlbum(album.related[i],null);return void 0!=album.cover&&delete album.cover,album},this.parseAlbumGroup=function(albumGroup,user){var albums=[];if(void 0!=albumGroup.album){albums=albumGroup.album;for(var i=0,len=albums.length;len>i;++i)albums[i]=this.parseAlbum(albums[i],user)}return albums},this.parseArtist=function(artist,user){void 0!=artist.gid&&(artist.id=Utils.str2hex(artist.gid),delete artist.gid),void 0!=artist.top_track&&(artist.top_track=this.parseTopTracks(artist.top_track,user));for(var i=0,ilen=_albumGroupNames.length;ilen>i;++i){var groupName=_albumGroupNames[i];if(void 0!=artist[groupName]){for(var albumGroups=artist[groupName],j=0,jlen=albumGroups.length;jlen>j;++j)albumGroups[j]=this.parseAlbumGroup(albumGroups[j],user);artist[groupName]=albumGroups}}if(void 0!=artist.biography)for(var i=0,len=artist.biography.length;len>i;++i)artist.biography[i]=_parseBiography(artist.biography[i]);if(null!=user&&(artist.availability=this.parseRestrictions(artist.restriction,user),artist.playable=this.isPlayable(artist.availability,user)),void 0!=artist.restriction&&delete artist.restriction,void 0!=artist.related)for(var i=0,len=artist.related.length;len>i;++i)artist.related[i]=this.parseArtist(artist.related[i],null);return void 0!=artist.portrait&&delete artist.portrait,artist},this.parseDisc=function(disc){if(void 0!=disc.track)for(var i=0,len=disc.track.length;len>i;++i)disc.track[i]=this.parseTrack(disc.track[i],null);return disc},this.parseRestrictions=function(restrictions,user){var catalogues={},anywhere=!1;if("undefined"==typeof restrictions||0==restrictions.length)return AVAILABILITY_AVAILABLE;for(var i=0,len=restrictions.length;len>i;++i){var isAllowed,r=restrictions[i],isAllowedAnywhere=!0;if(void 0!=r.countries_allowed?(isAllowedAnywhere=0!=r.countries_allowed.length,isAllowed=_countryInList(user.country,r.countries_allowed)):isAllowed=void 0!==r.countries_forbidden?!_countryInList(user.country,r.countries_forbidden):!0,isAllowed&&void 0!=r.catalogue_str)for(var j=0;j<r.catalogue_str.length;++j){var c=r.catalogue_str[j];catalogues[c]=!0}void 0!=r.type&&"streaming"!=r.type.toLowerCase()||(anywhere|=isAllowedAnywhere)}return anywhere&&user.catalogue==CATALOGUE_ALL?AVAILABILITY_AVAILABLE:catalogues[user.catalogue]?user.catalogue==CATALOGUE_PREMIUM?AVAILABILITY_PREMIUM:AVAILABILITY_AVAILABLE:catalogues[CATALOGUE_PREMIUM]?AVAILABILITY_PREMIUM:anywhere?AVAILABILITY_REGIONAL:AVAILABILITY_UNAVAILABLE},this.parseTopTracks=function(topTracks,user){for(var tracks=[],i=0,len=topTracks.length;len>i;++i){var current=topTracks[i];if(void 0!=current.country&&current.country==user.country){void 0!=current.track&&(tracks=topTracks[i].track);break}}for(var i=0,len=tracks.length;len>i;++i)tracks[i]=this.parseTrack(tracks[i],null);return tracks},this.parseTrack=function(track,user){if(void 0!=track.gid&&(track.id=Utils.str2hex(track.gid),delete track.gid),void 0!=track.album&&(track.album=this.parseAlbum(track.album,null)),void 0!=track.artist)for(var i=0,len=track.artist.length;len>i;++i)track.artist[i]=this.parseArtist(track.artist[i],null);if(null!=user){var availability=this.parseRestrictions(track.restriction,user),playable=this.isPlayable(availability,user);playable&&!_hasAnySuitableFile(track)&&(availability=AVAILABILITY_UNAVAILABLE,playable=!1),track.availability=availability,track.playable=playable}if(void 0!=track.restriction&&delete track.restriction,track.playable)track.playableId=track.id;else if(void 0!=track.alternative){for(var i=0,len=track.alternative.length;len>i;++i){var alternative=this.parseTrack(track.alternative[i],user);if(alternative.playable){track.availability=alternative.availability,track.playable=alternative.playable,track.playableId=alternative.id,track.file=alternative.file;break}}delete track.alternative}return track}},Spotify.Parsers.Search=function(){var _debugger=Spotify.DebuggerJS,_parser=new Spotify.Parsers.Metadata,_toArray=function(item){return item?Spotify.Utils.isArray(item)?item:[item]:[]},_fixAlbum=function(album,user){if(!album.id)return{};if(album["album-type"]&&(album.type=album["album-type"].toUpperCase()),album["artist-id"]&&album["artist-name"]){var artists=album.artists=[];if(Spotify.Utils.isArray(album["artist-id"])&&Spotify.Utils.isArray(album["artist-name"]))for(var len=Math.min(album["artist-id"].length,album["artist-name"].length),i=0;len>i;++i)artists.push({id:album["artist-id"][i],name:album["artist-name"][i]});else artists.push({id:album["artist-id"],name:album["artist-name"]})}return album.cover=_fixCover(album),album.popularity&&(album.popularity=Math.round(100*parseFloat(album.popularity))),album.restrictions&&(album.restrictions=_fixRestrictions(album.restrictions.restriction)),album.availability=_parser.parseRestrictions(album.restrictions,user),album.playable=_parser.isPlayable(album.availability,user),delete album.restrictions,delete album["album-type"],delete album["artist-id"],delete album["artist-name"],delete album["external-ids"],delete album["cover-small"],delete album["cover-large"],album},_fixArtist=function(artist,user){if(!artist.id)return{};if(artist.portrait){var portrait=artist.portrait,portraits=[];portrait.id&&portraits.push({size:"DEFAULT",file_id:portrait.id,width:parseInt(portrait.width),height:parseInt(portrait.height)}),portrait.small&&portraits.push({size:"SMALL",file_id:portrait.small}),portrait.large&&portraits.push({size:"LARGE",file_id:portrait.large}),artist.portrait=portraits}return artist.popularity&&(artist.popularity=Math.round(100*parseFloat(artist.popularity))),artist.restrictions&&(artist.restrictions=_fixRestrictions(artist.restrictions.restriction)),artist.availability=_parser.parseRestrictions(artist.restrictions,user),artist.playable=_parser.isPlayable(artist.availability,user),delete artist.restrictions,artist},_fixCover=function(item){var covers=[];return item.cover&&(covers.push({size:"DEFAULT",file_id:item.cover}),delete item.cover),item["cover-small"]&&(covers.push({size:"SMALL",file_id:item["cover-small"]}),delete item["cover-small"]),item["cover-large"]&&(covers.push({size:"LARGE",file_id:item["cover-large"]}),delete item["cover-large"]),covers},_fixPlaylist=function(playlist,user){return playlist.uri?playlist:{}},_fixRestrictions=function(restrictions){restrictions=_toArray(restrictions);for(var i=0,len=restrictions.length;len>i;++i){var attributes=restrictions[i]["@attributes"],restriction={};void 0!==attributes.allowed&&(restriction.countries_allowed=attributes.allowed.replace(/,/g,"")),void 0!==attributes.forbidden&&(restriction.countries_forbidden=attributes.forbidden.replace(/,/g,"")),void 0!==attributes.catalogues&&(restriction.catalogue=attributes.catalogues.split(",")),restrictions[i]=restriction}return restrictions},_fixTrack=function(track,user){if(!track.id)return{};if(track.album&&track["album-id"]&&(track.album={name:track.album,id:track["album-id"],artist:{name:track["album-artist"],id:track["album-artist-id"]},cover:_fixCover(track)}),track["album-artist"]&&track["album-artist-id"]){track.album=track.album||{};var artists=track.album.artists=[];if(Spotify.Utils.isArray(track["album-artist"])&&Spotify.Utils.isArray(track["album-artist-id"]))for(var len=Math.min(track["album-artist"].length,track["album-artist-id"].length),i=0;len>i;++i)artists.push({id:track["album-artist-id"][i],name:track["album-artist"][i]});else artists.push({id:track["album-artist-id"],name:track["album-artist"]})}if(track.artist&&track["artist-id"]){var artists=track.artists=[];if(Spotify.Utils.isArray(track.artist)&&Spotify.Utils.isArray(track["artist-id"]))for(var len=Math.min(track.artist.length,track["artist-id"].length),i=0;len>i;++i)artists.push({id:track["artist-id"][i],name:track.artist[i]});else artists.push({id:track["artist-id"],name:track.artist})}if(track.length&&(track.length=parseInt(track.length)),track.popularity&&(track.popularity=Math.round(100*parseFloat(track.popularity))),track.number&&(track.number=parseInt(track["track-number"])),track.year&&(track.year=parseInt(track.year)),track.title&&(track.name=track.title),track.restrictions&&(track.restrictions=_fixRestrictions(track.restrictions.restriction)),track.availability=_parser.parseRestrictions(track.restrictions,user),track.playable=_parser.isPlayable(track.availability,user),track.playable)track.playableId=track.id;else if(track.alternatives)for(var alternatives=_toArray(track.alternatives.track),i=0,len=alternatives.length;len>i;++i){var alternative=_fixTrack(alternatives[i],user);if(alternative.playable){track.availability=alternative.availability,track.playable=alternative.playable,track.playableId=alternative.id;break}}return delete track.alternatives,delete track.restrictions,delete track["album-id"],delete track["album-artist"],delete track["album-artist-id"],delete track.artist,delete track.cover,delete track["cover-small"],delete track["cover-large"],delete track["artist-id"],delete track["external-ids"],delete track.files,delete track["track-number"],delete track.title,track},_fix=function(items,user,func){for(var items=_toArray(items),i=0,len=items.length;len>i;++i)items[i]=func(items[i],user);return items};this.parse=function(str,user){var parseStartTime=(new Date).getTime(),xml=Spotify.Utils.convertStringToXML(str),result=Spotify.Utils.convertXMLToJSON(xml.documentElement);return result.albums&&(result.albums=_fix(result.albums.album,user,_fixAlbum)),result.artists&&(result.artists=_fix(result.artists.artist,user,_fixArtist)),result.tracks&&(result.tracks=_fix(result.tracks.track,user,_fixTrack)),result.playlists&&(result.playlists=_fix(result.playlists.playlist,user,_fixPlaylist)),result["did-you-mean"]&&(result.didYouMean=result["did-you-mean"],delete result["did-you-mean"]),result.total={albums:parseInt(result["total-albums"]),artists:parseInt(result["total-artists"]),tracks:parseInt(result["total-tracks"]),playlists:parseInt(result["total-playlists"])},delete result["total-albums"],delete result["total-artists"],delete result["total-tracks"],delete result["total-playlists"],delete result.version,_debugger.log("Spotify.Parsers.Search",["It took",(new Date).getTime()-parseStartTime,"ms to parse the search result"],"parsing_times"),result}},Spotify.Parsers.Suggest=function(){var Link=Spotify.Link,Utils=Spotify.Utils,_parseItems=function(items){for(var i=0,ilen=items.length;ilen>i;++i){var item=items[i];if(item.gid&&(item.id=Utils.str2hex(item.gid),delete item.gid),item.image&&(item.image=Utils.str2hex(item.image)),item.image_uri){var link=Link.fromString(item.image_uri);item.image=link.id||link.ids[0],delete item.image_uri}var artists=item.artists=[];if(Spotify.Utils.isArray(item.artist_gid)&&Spotify.Utils.isArray(item.artist_name))for(var jlen=Math.min(item.artist_name.length,item.artist_gid.length),j=0;jlen>j;++j)artists.push({id:Utils.str2hex(item.artist_gid[j]),name:item.artist_name[j]});delete item.artist_gid,delete item.artist_name,item.owner_uri&&item.owner_name&&(item.user={uri:item.owner_uri,name:item.owner_name}),delete item.owner_name,delete item.owner_uri,item.rank&&(item.popularity=Math.round(100*item.rank/2147483647),delete item.rank)}return items};this.parse=function(result){return{artists:_parseItems(result.artist||[]),albums:_parseItems(result.album||[]),tracks:_parseItems(result.track||[]),playlist:_parseItems(result.playlist||[])}}},Spotify.Parsers.Playlist=function(){var _parseContents=function(contents,username){var items=[],starredListsPerUser={};if("undefined"!=typeof contents&&"undefined"!=typeof contents.items)for(var i=0;i<contents.items.length;i++){var item=_parseItem(contents.items[i],username);if("starred"===item.link.type){if("undefined"!=typeof starredListsPerUser[item.link.username])continue;starredListsPerUser[item.link.username]=!0}null!==item&&items.push({uri:item.link,attributes:item.attributes})}return{contents:items}},_parseItem=function(item,username){var link=null,attributes={};if("undefined"!=typeof item&&"undefined"!=typeof item.uri)try{if(link=Spotify.Link.fromString(item.uri),"collectiontracklist"===link.type&&(link=Spotify.Link.starredLink(link.username)),item.attributes&&(attributes=item.attributes),"application"==link.type&&("start-group"==link.id||"end-group"==link.id)){var id=link.args[0],name=link.args[1],orig=link;link=Spotify.Link.folderLink(username,id),attributes.rawURI=item.uri,attributes.name=name,attributes.folder=!0,attributes.start="start-group"==orig.id}attributes.added_by||(attributes.added_by=decodeURIComponent(username)),attributes.timestamp||(attributes.timestamp=0),link.username&&encodeURIComponent(link.username)==link.username&&(link.username=decodeURIComponent(link.username))}catch(e){link=Spotify.Link.emptyLink()}return{link:link||Spotify.Link.emptyLink(),attributes:attributes}};this.parsePlaylist=function(selectedListContent,username){var result=selectedListContent;if("undefined"!=typeof result.contents){var parsedContents=_parseContents(result.contents,username);result.contents=parsedContents.contents}return"undefined"!=typeof result.revision&&(result.revision=Spotify.Utils.str2hex(result.revision)),result},this.parsePublishedPlaylist=function(selectedListContent,username){var result=selectedListContent;if("undefined"!=typeof result.contents){var parsedContents=_parseContents(result.contents,username);result.contents=parsedContents.contents,result.length=result.contents.length}return"undefined"!=typeof result.revision&&(result.revision=Spotify.Utils.str2hex(result.revision)),result},this.parseMetadata=function(serviceReturn){var attributes=serviceReturn.attributes;return attributes}},Spotify.Parsers.Social=function(){var _debugger=Spotify.DebuggerJS;this.parse=function(item){var parseStartTime=(new Date).getTime();return item.username||(item.username=""),item.full_name||(item.full_name=""),item.image_url||(item.image_url=""),item.large_image_url||(item.large_image_url=""),item.first_name||(item.first_name=""),item.last_name||(item.last_name=""),item.facebook_uid||(item.facebook_uid=""),_debugger.log("Spotify.Parsers.Social",["It took",(new Date).getTime()-parseStartTime,"ms to parse the social result"],"parsing_times"),item}},Spotify.Parsers.URL=function(){this.parseRTMPUrl=function(url){var result=Spotify.Utils.parseURL(url),port=""!==result.port?":"+result.port:"";return{server:result.protocol+"://"+result.host+port+"/cfx/st",protocol:result.protocol,url:url,file:"mp3:"+result.relative.replace("/cfx/st/","")}},this.parseHTTPUrl=function(url){var result=Spotify.Utils.parseURL(url),port=""!==result.port?":"+result.port:"";return{server:result.protocol+"://"+result.host+port,protocol:result.protocol,url:url,file:result.relative}}},Spotify.Services.Base=function(protobufSchemasManager){Spotify.EventTarget.call(this),this.id="",this.serviceIsReady=!1,this.services={},this._totalDependenciesReady=0,this._dependencies=[];var _events=new Spotify.Events;this._onServiceReady=function(){this._totalDependenciesReady++,this._totalDependenciesReady>=this._dependencies.length&&(delete this._dependencies,delete this._totalDependenciesReady,this.serviceIsReady=!0,this.setup(),this.trigger(_events.READY))},this.setup=function(){},this.onReady=function(callback,ctx){this.serviceIsReady?callback.call(ctx):this.bind(_events.READY,callback,ctx)},this._initialize=function(services){0===services.length&&this._onServiceReady();for(var n=0,len=services.length;len>n;n+=1)this.services[services[n].id]=services[n],services[n].onReady(this._onServiceReady,this)},this.send=function(req){req.calleeId=this.id,this.trigger(_events.REQUEST,req)},this.onNotify=function(event){},this.getProtobufMsgParser=protobufSchemasManager.getProtobufMsgParser,this.dispose=function(){}},Spotify.Services.Time=function(){var _serverTimeLocalTimeDiff,CALL_TYPE="time";this.getServerTime=function(onSuccess,onError,force){if(!this.serviceIsReady)return void onError(new Spotify.Errors.Error([503,0,"Time service not ready!"]));if("undefined"==typeof force&&(force=!1),"undefined"!=typeof _serverTimeLocalTimeDiff&&!force)return void onSuccess(Math.floor((new Date).getTime()/1e3)+_serverTimeLocalTimeDiff);var onTimeSuccess=function(result){var now=Math.floor((new Date).getTime()/1e3);_serverTimeLocalTimeDiff=result.response-now,onSuccess(result.response)},req=new Spotify.Calls.Simple({method:"time",payload:[],context:this,persistent:!1,retries:2,type:CALL_TYPE},onTimeSuccess,onError);this.send(req)}},Spotify.Services.Suggest=function(){var CALL_TYPE="searchsuggest",_self=this,_parser=new Spotify.Parsers.Suggest;this.suggest=function(query,onSuccess,onError){return this.serviceIsReady?void this.services.user.getUserInfo(function(response){var onSuggestSuccess=function(data,code){if(200==code){var result=_parser.parse(data[0]);onSuccess(result,code);
}else onError(new Spotify.Errors.Error([13,code,""]))},user=response,req=new Spotify.Calls.Hermes({header:{uri:"hm://searchsuggest/suggest/"+encodeURIComponent(query)+"?country="+user.country+"&catalogues="+user.catalogue,method:"GET"},responseSchemas:["suggest#Suggestions"],type:CALL_TYPE},onSuggestSuccess,onError);_self.send(req)},function(e){onError(e)}):void onError(new Spotify.Errors.Error([13,503,"Suggest service not ready!"]))}},Spotify.Services.AppStore=function(){var CALL_TYPE="appstore",_debugger=Spotify.DebuggerJS;this.list=function(values,callback,errback){if(!this.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Appstore service not ready!"]));var req=new Spotify.Calls.Hermes({header:{uri:"hm://appstore/app/list",method:"GET"},payload:values,payloadSchemas:["appstore#RequestHeader"],responseSchemas:["appstore#AppList"],type:CALL_TYPE},callback,errback);this.send(req)},this.getAppVersionsForCurrentUser=function(market,apps,bridgeVersion,callback,errback){if(!this.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Appstore service not ready!"]));for(var payload=[{market:market,bridge_identifier:"bridge-web",bridge_version:{major:bridgeVersion.major,minor:bridgeVersion.minor,patch:bridgeVersion.patch},device_class:"WEB"}],i=0;i<apps.length;i++)payload.push(apps[i]);var onSuccess=function(data){try{callback(JSON.parse(data))}catch(e){var msg="Malformed response from appstore.apps_deps",code=Spotify.Errors.Codes.MALFORMED_RESPONSE;_debugger.error("Spotify.Services.AppStore",[msg,data],"corejs"),errback(new Spotify.Errors.Error([13,code,msg,data]))}},req=new Spotify.Calls.Hermes({header:{uri:"hm://appstore/1.0/apps_deps",method:"GET"},payload:payload,payloadSchemas:["appstore#RequestHeader"],responseSchemas:[],type:CALL_TYPE},onSuccess,errback);this.send(req)}},Spotify.Services.PopCount=function(){var CALL_TYPE="PopCount";this.get=function(playlistUri,maxUsers,showFriendsFirst,afterUser,callback,errback){if(!this.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"PopCount service not ready!"]));maxUsers="number"==typeof maxUsers?maxUsers:100,showFriendsFirst="boolean"==typeof showFriendsFirst?"&friendsFirst="+showFriendsFirst:"",afterUser="string"==typeof afterUser?"&afterUser="+afterUser:"";var url=Spotify.Link.fromString(playlistUri).toURLPath(),req=new Spotify.Calls.Hermes({header:{uri:"hm://popcount/"+url+"?maxUsers="+maxUsers+showFriendsFirst+afterUser,method:"GET"},payload:[],payloadSchemas:[],responseSchemas:["popcount#PopcountResult"],type:CALL_TYPE},callback,errback);this.send(req)}},Spotify.Services.Metadata=function(){var METADATA_MAX_BATCH_SIZE=100,ERROR_UNSUPPORTED_LINK_TYPE="Unsupported link type!",Link=Spotify.Link,_self=this,_parser=new Spotify.Parsers.Metadata,CALL_TYPE="metadata",URL_PREFIX="hm://metadata/3/",_locale=(new Spotify.Events,""),_getQueryParams=function(cb){_self.services.user.getUserInfo(function(r){var locale=""!==r.preferred_locale?r.preferred_locale:_locale;cb("?country="+r.country+"&catalogue="+r.catalogue+"&locale="+locale)},function(e){cb("")})},_createGetURI=function(link){switch(link.type){case Link.Type.TRACK:return URL_PREFIX+"track/"+link.id;case Link.Type.ALBUM:return URL_PREFIX+"album/"+link.id;case Link.Type.ARTIST:return URL_PREFIX+"artist/"+link.id;default:throw new Error(ERROR_UNSUPPORTED_LINK_TYPE)}},_createMultiGetURI=function(type){switch(type){case Link.Type.TRACK:return URL_PREFIX+"tracks";case Link.Type.ALBUM:return URL_PREFIX+"albums";case Link.Type.ARTIST:return URL_PREFIX+"artists";default:throw new Error(ERROR_UNSUPPORTED_LINK_TYPE)}},_getSchemaForType=function(type){switch(type){case Link.Type.TRACK:return"metadata#Track";case Link.Type.ALBUM:return"metadata#Album";case Link.Type.ARTIST:return"metadata#Artist";default:throw new Error(ERROR_UNSUPPORTED_LINK_TYPE)}},_getParserForType=function(type){switch(type){case Link.Type.TRACK:return _parser.parseTrack.bind(_parser);case Link.Type.ALBUM:return _parser.parseAlbum.bind(_parser);case Link.Type.ARTIST:return _parser.parseArtist.bind(_parser);default:throw new Error(ERROR_UNSUPPORTED_LINK_TYPE)}},MetadataGetQuery=function(link,onSuccess,onError){var _onHermesSuccess=function(frames,code){if(Spotify.Hermes.Request.isSuccess(code)){var data=frames[0],parser=_getParserForType(link.type);_self.services.user.getUserInfo(function(response){data=parser(data,response),onSuccess(data,code)},function(e){onError(e)})}else onError(code)};this.send=function(){_getQueryParams(function(qs){var req=new Spotify.Calls.Hermes({header:{uri:_createGetURI(link)+qs,method:"GET"},payload:[],payloadSchemas:[],responseSchemas:[_getSchemaForType(link.type)],type:CALL_TYPE,persistent:!1,bypassCache:!1},_onHermesSuccess,onError);_self.send(req)})}},MetadataMultiGetQuery=function(links,onSuccess,onError){var type=links[0].type,parser=_getParserForType(type),_onHermesSuccess=function(frames,code){var data=[];_self.services.user.getUserInfo(function(response){for(var n=0,len=frames.length;len>n;n+=1)if(frames[n]){var item=parser(frames[n],response);data.push(item)}onSuccess(data,code)},function(e){onError(e)})};this.send=function(){var requests=[];_getQueryParams(function(qs){for(var i=0,len=links.length;len>i;++i)requests.push({uri:_createGetURI(links[i])+qs});var req=new Spotify.Calls.Hermes({header:{uri:_createMultiGetURI(type)+qs,method:"GET"},payload:[{request:requests}],payloadSchemas:[],responseSchemas:[_getSchemaForType(type)],type:CALL_TYPE,isMultiGet:!0,persistent:!1,bypassCache:!1},_onHermesSuccess,onError);_self.send(req)})}},_toLink=function(arg){if(arg instanceof Spotify.Link)return arg;if("string"==typeof arg||arg instanceof String)return Link.fromString(arg);throw new Error("Invalid argument!")};this.setLocale=function(locale){_locale=locale},this.lookup=function(args,onSuccess,onError){if(!_self.serviceIsReady)return void onError(new Error("Service not ready!"));if(Spotify.Utils.isArray(args))if(args.length>1){for(var numRequests=Math.ceil(args.length/METADATA_MAX_BATCH_SIZE),aborted=!1,links=[],results=new Array(numRequests),makeOnMetadataSuccess=function(index){return function(data,code){aborted||(results[index]=data,0==--numRequests&&onSuccess(Array.prototype.concat.apply([],results),200))}},onMetadataError=function(code){aborted=!0,onError(code)},i=0,len=args.length;len>i;++i)links.push(_toLink(args[i]));var index=0;do new MetadataMultiGetQuery(links.splice(0,METADATA_MAX_BATCH_SIZE),makeOnMetadataSuccess(index++),onMetadataError).send();while(links.length>0)}else if(1==args.length){var onMetadataSuccess=function(data,code){onSuccess([data],code)};new MetadataGetQuery(_toLink(args[0]),onMetadataSuccess,onError).send()}else onError(new Error("Array does not contain any items!"));else new MetadataGetQuery(_toLink(args),onSuccess,onError).send()}},Spotify.Services.Search=function(){var _self=this,_parser=new Spotify.Parsers.Search,CALL_TYPE="search";this.DEFAULT_TOTAL_RESULTS=50,this.TRACKS=1,this.ALBUMS=2,this.ARTISTS=4,this.PLAYLISTS=8,this.ALL=this.TRACKS|this.ALBUMS|this.ARTISTS|this.PLAYLISTS,this.search=function(query,options,onSuccess,onError){if(!this.serviceIsReady)return void onError(new Spotify.Errors.Error([503,0,"Search service not ready!"]));if("undefined"==typeof query||""===query)return void onError(new Spotify.Errors.Error([403,0,"You haven't provided a valid query"]));options=options||{},options.type=options.type||this.ALL,options.total=options.total||this.DEFAULT_TOTAL_RESULTS,options.offset=options.offset||0,options.total>this.DEFAULT_TOTAL_RESULTS&&(options.total=this.DEFAULT_TOTAL_RESULTS);var _onRPCSuccess=function(searchResults){_self.services.user.getUserInfo(function(response){var results=_parser.parse(searchResults.response,response);onSuccess(results)},function(e){onError(e)})},req=new Spotify.Calls.Simple({method:"search",payload:[query,options.type,options.total,options.offset],context:this,persistent:!1,retries:2,type:CALL_TYPE},_onRPCSuccess,onError);this.send(req)}},Spotify.Services.SearchHermes=function(){var CALL_TYPE="search_hermes";this.TRACKS="TRACK",this.ALBUMS="ALBUM",this.ARTISTS="ARTIST",this.PLAYLISTS="PLAYLIST",this.USERS="USER",this.DEFAULT_TOTAL_RESULTS=200,this.search=function(query,options,onSuccess,onError){if(!this.serviceIsReady)return void onError(new Spotify.Errors.Error([503,0,"Search service not ready!"]));if("undefined"==typeof query||""===query)return void onError(new Spotify.Errors.Error([403,0,"You haven't provided a valid query"]));options=options||{},options.query=query,options.type=options.type||this.TRACKS,options.limit=options.total||this.DEFAULT_TOTAL_RESULTS,delete options.total,options.offset=options.offset||0;var req=new Spotify.Calls.Hermes({header:{uri:"hm://search/search",method:"GET"},payload:[options],payloadSchemas:["searchHermes_FULL#SearchRequest"],responseSchemas:["searchHermes_FULL#SearchReply"],type:CALL_TYPE},onSuccess,onError);this.send(req)}},Spotify.Services.Toplist=function(){var _self=this,_cache={},CALL_TYPE="toplist";this.TRACK="track",this.ALBUM="album",this.ARTIST="artist",this.PLAYLIST="playlist",this.GLOBAL="global";var TYPE_TO_LINK={track:Spotify.Link.trackLink,album:Spotify.Link.albumLink,artist:Spotify.Link.artistLink,playlist:Spotify.Link.playlistLink},_toLinks=function(ids,type){for(var i=0,len=ids.length;len>i;++i)ids[i]=TYPE_TO_LINK[type](ids[i]);return ids},_toPlaylistLinks=function(uris,type){for(var i=0,len=uris.length;len>i;++i)uris[i]=Spotify.Link.fromString(uris[i]);return uris},_lookupToplist=function(cacheKey,uri,type,onSuccess,onError,force,username){var _onToplistResult=function(result,code){var data;void 0!=result[0].items?(data=_toLinks(result[0].items,type),_cache[cacheKey]=data,onSuccess(data,type,200)):void 0!=result[0].uris?(data=_toPlaylistLinks(result[0].uris,type),_cache[cacheKey]=data,onSuccess(data,type,200)):(_cache[cacheKey]=[],onSuccess([],type,200))},_sendRequest=function(){var requestSchemas=[],responseSchemas=[],frames=[];"playlist"===type?(requestSchemas=["socialgraph#TopPlaylistsRequest"],responseSchemas=["socialgraph#TopPlaylistsReply"],frames.push({username:username})):responseSchemas=["toplist#Toplist"];var req=new Spotify.Calls.Hermes({header:{uri:uri,method:"GET"},payload:frames,payloadSchemas:requestSchemas,responseSchemas:responseSchemas,type:CALL_TYPE},_onToplistResult,onError);_self.send(req)},_onToplistCache=function(key,data){null!=data?onSuccess(data,type,200):_sendRequest()};force?_onToplistCache(cacheKey,null):_onToplistCache(cacheKey,_cache[cacheKey])};this.lookupForUser=function(username,type,onSuccess,onError,force){return this.serviceIsReady?void this.services.user.getUserInfo(function(response){username=username?username:response.user;var cacheKey=Spotify.Link.userToplistLink(username,type).toURI(),uri="hm://toplist/toplist/user/"+encodeURIComponent(username)+"?type="+type;"playlist"===type&&(uri="hm://socialgraph/suggestions/topplaylists"),_lookupToplist(cacheKey,uri,type,onSuccess,onError,force,username)},onError):void onError(new Spotify.Errors.Error([13,503,"Toplist service not ready!"]))},this.lookupForRegion=function(country,type,onSuccess,onError,force){return this.serviceIsReady?void this.services.user.getUserInfo(function(response){country=country?country:response.country;var global="global"==country,cacheKey=Spotify.Link.toplistLink(type,global?null:country,global).toURI(),uri=global?"hm://toplist/toplist/region?type="+type:"hm://toplist/toplist/region/"+country+"?type="+type;_lookupToplist(cacheKey,uri,type,onSuccess,onError,force)},onError):void onError(new Spotify.Errors.Error([13,503,"Toplist service not ready!"]))}},Spotify.Services.Playlist=function(){this.DEFAULT_TOTAL_RESULTS=200;var isArray=Spotify.Utils.isArray,METHOD_TYPES={CHANGE:"CHANGE",MODIFY:"MODIFY",PUT:"PUT",ADD:"ADD",REMOVE:"REMOVE",POST:"POST",GET:"GET",HEAD:"HEAD",DIFF:"DIFF",CALL:"CALL",APPEND:"APPEND"},OPERATIONS={UPDATE_LIST_ATTRIBUTES:"UPDATE_LIST_ATTRIBUTES",UPDATE_ITEM_ATTRIBUTES:"UPDATE_ITEM_ATTRIBUTES",REM:"REM",METHOD_SYNCHRONIZE:"METHOD_SYNCHRONIZE",ADD:"ADD",MOV:"MOVE"},TOTAL_SUBSCRIBE_RETRIES=4,SUBSCRIBE_RETRY_INTERVAL=1e3,SUBSCRIBE_DEBOUNCE_INTERVAL=100,CALL_TYPE="playlist",_debugger=Spotify.DebuggerJS,_self=this,_events=new Spotify.Events,_parser=new Spotify.Parsers.Playlist,_subscribeQueue=[],_subscribeTimeout=null,_revisions={},_get_hm_uri=function(uri,querystring){return querystring="undefined"!=typeof querystring&&querystring.length?"?"+querystring.join("&"):"","hm://playlist/"+uri.split(":").join("/").substr(8)+querystring},_compose=function(fns){return function(){for(var i=0;i<fns.length;i++)"function"==typeof fns[i]&&fns[i].apply(this,arguments)}},_onListSuccess=function(uri,data,callback,errback){if("undefined"==typeof data||"undefined"==typeof data[0])return void errback(new Spotify.Errors.Error([13,404,"No results"]));var playlist;playlist="published-rootlist"===uri.type?_parser.parsePublishedPlaylist(data[0],uri.username):_parser.parsePlaylist(data[0],uri.username),_revisions[uri.toURI()]=Spotify.Utils.formatPlaylistRevision(data[0].revision)||"","starred"==uri.type&&playlist.contents.reverse(),callback(playlist,{revision:_revisions[uri.toURI()]})},_onMetadataSuccess=function(uri,data,callback,errback){if("undefined"==typeof data||"undefined"==typeof data[0])return void errback(new Spotify.Errors.Error([13,404,"No results",uri]));var metadata=_parser.parseMetadata(data[0]);metadata.owner=Spotify.Link.fromString(uri).username,metadata.uri=uri,metadata.revision=Spotify.Utils.formatPlaylistRevision(Spotify.Utils.str2hex(data[0].revision)),callback(metadata)},_trySubscribe=function(rootlistUri,originalRootlist,playlistUris,callback,errback){var i,urisForList=playlistUris.slice(0);for(i=0;i<originalRootlist.contents.length;i++){var content=originalRootlist.contents[i].uri;if("empty"!=content.type)for(var j=0;j<urisForList.length;j++)content.toURI()==urisForList[j]&&delete urisForList[j]}var rootlistItems=[];for(i=0;i<urisForList.length;i++)urisForList[i]&&rootlistItems.push(urisForList[i]);rootlistItems.length>0?(_makeRequestFuncForAdding(rootlistUri,rootlistItems,callback,errback)(),_self.trigger(_events.PLAYLIST_SUBSCRIBE,{uris:rootlistItems})):"function"==typeof callback&&callback(!0)},_makeRequestFuncForAppending=function(rootlistUri,items,callback,errback){return _makeRequestFunc(METHOD_TYPES.APPEND,rootlistUri,null,items.join(","),callback,errback)},_makeRequestFuncForAdding=function(rootlistUri,items,callback,errback){return _makeRequestFunc(METHOD_TYPES.ADD,rootlistUri,null,items.join(","),callback,errback)},_makeRequestFuncForAddingWithOps=function(rootlistUri,originalRootlist,items,callback,errback){for(var itemsToAdd=[],zx=0,zxLen=items.length;zxLen>zx;zx+=1){var item=items[zx];itemsToAdd.push({uri:item.uri,attributes:{added_by:item.addedBy||""}}),item.message&&(itemsToAdd[itemsToAdd.length-1].attributes.message=item.message)}var data={ops:[{kind:OPERATIONS.ADD,add:{addLast:!0,items:itemsToAdd}}]};return _makeRequestFunc(METHOD_TYPES.MODIFY,rootlistUri,originalRootlist,data,callback,errback)},_makeRequestFuncForRemovingWithOps=function(rootlistUri,originalRootlist,fromIndex,length,callback,errback){var data={ops:[{kind:OPERATIONS.REM,rem:{fromIndex:fromIndex,length:length}}]};return _makeRequestFunc(METHOD_TYPES.MODIFY,rootlistUri,originalRootlist,data,callback,errback)},_makeRequestFuncForRemoving=function(rootlistUri,items,callback,errback){return _makeRequestFunc(METHOD_TYPES.REMOVE,rootlistUri,null,items.join(","),callback,errback)},_makeRequestFunc=function(method,rootlistUri,originalRootlist,payload,callback,errback){var uriArgs=[],linkType=Spotify.Link.fromString(rootlistUri).type;method===METHOD_TYPES.ADD&&uriArgs.push("add_first=true"),method=METHOD_TYPES.APPEND===method?METHOD_TYPES.ADD:method,method!==METHOD_TYPES.REMOVE&&method!==METHOD_TYPES.MODIFY||"inbox"===linkType||uriArgs.push("syncpublished=true");var args=[];args=method===METHOD_TYPES.REMOVE||method===METHOD_TYPES.ADD||method===METHOD_TYPES.APPEND?[]:["playlist_FULL#OpList"];var responseSchema=[];method===METHOD_TYPES.MODIFY?responseSchema=["playlist_FULL#ModifyReply"]:method===METHOD_TYPES.PUT&&(responseSchema=["playlist_FULL#CreateListReply"]);var data=payload;if(originalRootlist&&method===METHOD_TYPES.MODIFY&&"published-rootlist"!=linkType){var revision=Spotify.Utils.formatPlaylistRevision(originalRootlist.revision);uriArgs.push("revision="+revision)}var interval=0,subscribeRetries=0,sendRequest=function(){var req=new Spotify.Calls.Hermes({header:{uri:_get_hm_uri(rootlistUri,uriArgs),method:method},payload:[data],payloadSchemas:args,responseSchemas:responseSchema,type:CALL_TYPE,persistent:!1,bypassCache:!1},function(response){_self.services.user.getUserInfo(function(userResponse){var newRevision=response[0].revision||response[0];_revisions[rootlistUri]=Spotify.Utils.formatPlaylistRevision(Spotify.Utils.str2hex(newRevision));var requestUris=[],urisForSubscribing=[];"string"==typeof data&&(requestUris=data.split(","));for(var z=0,len=requestUris.length;len>z;z+=1){var uriObject={uri:Spotify.Link.fromString(requestUris[z])};method===METHOD_TYPES.ADD&&rootlistUri!==Spotify.Link.publishedRootlistLink(userResponse.user).toURI()&&"playlist"===uriObject.uri.type&&urisForSubscribing.push(uriObject)}urisForSubscribing.length>0&&_subscribeToPlaylists(urisForSubscribing),"function"==typeof callback&&(method===METHOD_TYPES.PUT?callback(response,{revision:_revisions[rootlistUri]}):callback(!0,{revision:_revisions[rootlistUri]}));var keyToRemove=req.header.uri.split("?")[0],methodTypeOfCachedItem="GET";method===METHOD_TYPES.MODIFY&&data.ops.length&&(data.ops[0].kind!==OPERATIONS.UPDATE_LIST_ATTRIBUTES&&data.ops[0].kind!==OPERATIONS.UPDATE_ITEM_ATTRIBUTES||(methodTypeOfCachedItem="HEAD")),Spotify.Hermes.Cache.removeAllContaining(methodTypeOfCachedItem+keyToRemove)},errback)},handleError);_self.send(req)},handleError=function(){subscribeRetries>=TOTAL_SUBSCRIBE_RETRIES?"function"==typeof errback&&errback.apply(this,arguments):(interval=.5*Math.floor(2*subscribeRetries*Math.random())*SUBSCRIBE_RETRY_INTERVAL,subscribeRetries++,setTimeout(sendRequest,interval))};return sendRequest},_subscribeToPlaylistChangesForAll=function(){var userList;return _self.serviceIsReady?void _self.services.user.getUserInfo(function(user){userList=Spotify.Link.profileLink(user.user),_debugger.log("Spotify.Services.Playlist",["Will try to subscribe to",userList.username],"corejs"),_subscribeToPlaylists([{uri:userList}]),_self.rootlist({total:-1,offset:0},function(response){for(var urls=[],n=0,len=response.contents.length;len>n;n+=1){var item=response.contents[n];item.username!==user.user&&urls.push(item)}urls.length>0&&(_debugger.log("Spotify.Services.Playlist",["Will try to subscribe to",urls],"corejs"),_subscribeToPlaylists(urls))},_onPubsubSubscribeError)},_onPubsubSubscribeError):void _debugger.error("Spotify.Services.Playlist",["Playlist service not ready"],"corejs")},_subscribeToPlaylists=function(playlists){var url="hm://playlist/",playlistUrls=[];if(!Spotify.Utils.isArray(playlists))throw"Playlists argument must be an array";if(0!==playlists.length){for(var n=0,len=playlists.length;len>n;n+=1)if("undefined"!=typeof playlists[n]&&"undefined"!=typeof playlists[n].uri){if("folder"==playlists[n].uri.type)continue;playlistUrls.push("hm://playlist/"+playlists[n].uri.toURLPath())}playlistUrls.length&&_self.services.pubsub.subscribe(url,[{uris:playlistUrls}],["playlist_FULL#SubscribeRequest"],[],_onPubsubSubscribeSuccess,_onPubsubSubscribeError,_onMessage,_self)}},_onPubsubSubscribeSuccess=function(event){_debugger.log("Spotify.Services.Playlist",["Subscription was a success",event],"corejs")},_onPubsubSubscribeError=function(event){_debugger.error("Spotify.Services.Playlist",["Subscription failed",event],"corejs")},_onMessage=function(result,parsedResult){var message,args=result;if(args.length>0){var serializer=_self.getProtobufMsgParser("playlist4service","PlaylistModificationInfo");if(message=serializer.parseFromStringSync(Spotify.Utils.Base64.decode(args[3])),"undefined"!=typeof message.new_revision&&(message.new_revision=Spotify.Utils.formatPlaylistRevision(Spotify.Utils.str2hex(message.new_revision))),_debugger.log("Spotify.Services.Playlist",["Got a notification",message],"corejs"),"undefined"!=typeof message.uri){var localRevision=_revisions[message.uri];_self.trigger(_events.CHANGE,{localRevision:localRevision,revision:message.new_revision,ops:message.ops||[],uri:message.uri}),_debugger.log("Spotify.Services.Playlist",["Triggered change event for ",message.uri," with new revision: ",message.new_revision],"corejs")}}},_onConnected=function(event){_subscribeToPlaylistChangesForAll()};this.metadata=function(uri,callback,errback){if(!_self.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Playlist service not ready!"]));"string"==typeof uri&&(uri=Spotify.Link.fromString(uri));var req=new Spotify.Calls.Hermes({header:{uri:_get_hm_uri(uri.toURI()),method:METHOD_TYPES.GET},payload:[],payloadSchemas:[],responseSchemas:["playlist_FULL#SelectedListContent"],type:CALL_TYPE,persistent:!1,bypassCache:!1},function(data){_onMetadataSuccess(uri.toURI(),data,callback,errback)},function(error){error.data=uri.toURI(),errback(error)});this.send(req)},this.getChangesBetweenRevisionAndHead=function(playlistUri,revision,callback,errback){var req=new Spotify.Calls.Hermes({header:{uri:_get_hm_uri(playlistUri)+"?revision="+revision,method:METHOD_TYPES.DIFF},payload:[],payloadSchemas:[],responseSchemas:["playlist_FULL#SelectedListContent"],type:CALL_TYPE,persistent:!1,bypassCache:!1},function(response){var result={};result.operations=response[0].diff.ops,result.uri=playlistUri,result.revision=Spotify.Utils.formatPlaylistRevision(Spotify.Utils.str2hex(response[0].revision)),_revisions[playlistUri]=result.revision,callback(result)},errback);_self.send(req)},this.getChangesFromHead=function(playlistUri,callback,errback){var req=new Spotify.Calls.Hermes({header:{uri:_get_hm_uri(playlistUri)+"?revision="+_revisions[playlistUri],method:METHOD_TYPES.DIFF},payload:[],payloadSchemas:[],responseSchemas:["playlist_FULL#SelectedListContent"],type:CALL_TYPE,persistent:!1,bypassCache:!1},function(response){var result={};result.operations=response[0].diff.ops,result.uri=playlistUri,result.revision=Spotify.Utils.formatPlaylistRevision(Spotify.Utils.str2hex(response[0].revision)),_revisions[playlistUri]=result.revision,callback(result)},errback);_self.send(req)},this.subscribe=function(values,callback,errback){if(clearTimeout(_subscribeTimeout),!_self.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Playlist service not ready!"]));"undefined"==typeof values.publish&&(values.publish=!1);for(var uris=isArray(values.uri)?values.uri:[values.uri],len=uris.length;len--;){var uri=Spotify.Link.fromString(uris[len]);uris[len]=uri.toURI()}_subscribeQueue.push({username:values.username,uri:uris,callback:callback,errback:errback});var queue,that=this;_subscribeTimeout=setTimeout(function(){queue=_subscribeQueue.slice(0),_subscribeTimeout=null,_subscribeQueue=[];for(var urisByUser={},callbacksByUser={},errbacksByUser={},item={},index=0;index<queue.length;index++)item=queue[index],urisByUser[item.username]=urisByUser[item.username]||[],callbacksByUser[item.username]=callbacksByUser[item.username]||[],errbacksByUser[item.username]=errbacksByUser[item.username]||[],urisByUser[item.username]=urisByUser[item.username].concat(item.uri),callbacksByUser[item.username].push(item.callback),errbacksByUser[item.username].push(item.errback);for(var username in urisByUser){var uris=urisByUser[item.username],callback=_compose(callbacksByUser[item.username]),errback=_compose(errbacksByUser[item.username]),rootlistUri=Spotify.Link.rootlistLink(values.username).toURI();that.list({uri:rootlistUri,total:-1},function(rootlist){_trySubscribe(rootlistUri,rootlist,uris,callback,errback)},errback),values.publish&&setTimeout(function(){that.publishPlaylists(uris,function(){_debugger.log("Spotify.Services.Playlist",["Playlists were published too",uris],"corejs")},function(e){_debugger.error("Spotify.Services.Playlist",["Playlists couldn't be published",uris],"corejs")})},2e3)}},SUBSCRIBE_DEBOUNCE_INTERVAL)},this.list=function(values,callback,errback){if(!_self.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Playlist service not ready!"]));values.total>this.DEFAULT_TOTAL_RESULTS?values.total=this.DEFAULT_TOTAL_RESULTS:values.total||(values.total=-1),"undefined"==typeof values.offset&&(values.offset=0);var uri=Spotify.Link.fromString(values.uri),params={uri:_get_hm_uri(uri.toURI()),method:METHOD_TYPES.GET},hasRange="undefined"!=typeof values.offset&&"undefined"!=typeof values.total;hasRange&&(params.uri+="?from="+values.offset,-1!==values.total&&(params.uri+="&length="+values.total));var req=new Spotify.Calls.Hermes({header:params,payload:[],payloadSchemas:[],responseSchemas:["playlist_FULL#SelectedListContent"],type:CALL_TYPE,persistent:!1,bypassCache:!1},function(data){_onListSuccess(uri,data,callback,errback)},errback);this.send(req)},this.rootlist=function(values,callback,errback){this.services.user.getUserInfo(function(response){values.username=response.user,values.uri=Spotify.Link.rootlistLink(values.username).toURI(),_self.list(values,callback,errback)},errback)},this.publishedRootlist=function(values,callback,errback){values.offset&&delete values.offset,values.total=-1,values.uri=Spotify.Link.publishedRootlistLink(values.username).toURI(),this.list(values,callback,errback)},this.starredPlaylist=function(values,callback,errback){values.uri=Spotify.Link.starredLink(values.username).toURI(),this.list(values,callback,errback)},this.publishPlaylists=function(items,success,errback){this.services.user.getUserInfo(function(response){var publishedRootListUri=Spotify.Link.publishedRootlistLink(response.user).toURI();_makeRequestFuncForAdding(publishedRootListUri,items,success,errback)()},errback)},this.unpublishPlaylists=function(items,success,errback){this.services.user.getUserInfo(function(response){var publishedRootListUri=Spotify.Link.publishedRootlistLink(response.user).toURI();_self.removeFromPlaylistByUri(publishedRootListUri,items,success,errback)},errback)},this.addToPlaylist=function(playlistUri,trackUris,success,errback){_makeRequestFuncForAppending(playlistUri,trackUris,success,errback)()},this.addToPlaylistWithAttributes=function(playlistUri,trackUris,success,errback){_makeRequestFuncForAddingWithOps(playlistUri,null,trackUris,success,errback)()},this.modifyPlaylist=function(playlistUri,operations,success,errback){var data={ops:operations};this.list({uri:playlistUri,total:-1},function(thelist){_makeRequestFunc(METHOD_TYPES.MODIFY,playlistUri,thelist,data,success,errback)()})},this.addTracksInPlaylist=function(playlistUri,trackUris,success,errback){_self.addToPlaylist(playlistUri,trackUris,success,errback)},this.removeFromPlaylistByUri=function(playlistUri,items,success,errback){_makeRequestFuncForRemoving(playlistUri,items,success,errback)()},this.removeFromPlaylist=function(playlistUri,fromIndex,length,success,errback){this.list({uri:playlistUri,total:-1},function(thelist){_makeRequestFuncForRemovingWithOps(playlistUri,thelist,fromIndex,length,success,errback)()},function(error){errback(error)})},this.starTracks=function(trackUris,success,errback){this.services.user.getUserInfo(function(response){var starredListUri=Spotify.Link.starredLink(response.user).toURI();_self.addToPlaylist(starredListUri,trackUris,success,errback)},errback)},this.unstarTracks=function(trackUris,success,errback){this.services.user.getUserInfo(function(response){var starredListUri=Spotify.Link.starredLink(response.user).toURI();_self.removeFromPlaylistByUri(starredListUri,trackUris,success,errback)},errback)},this.createPlaylist=function(args,callback,errback){this.services.user.getUserInfo(function(response){var uri=Spotify.Link.profileLink(response.user).toURI(),subscribe="undefined"==typeof args.subscribe?!0:args.subscribe,data=("undefined"==typeof args.publish?!1:args.publish,{ops:[{kind:OPERATIONS.UPDATE_LIST_ATTRIBUTES,update_list_attributes:{new_attributes:{values:{name:args.name}}}}]});_makeRequestFunc(METHOD_TYPES.PUT,uri,null,data,function(res,options){subscribe?_self.subscribe({username:response.user,uri:res[0].uri,publish:args.publish},function(){callback(res[0].uri,{revision:Spotify.Utils.formatPlaylistRevision(options.revision)})},errback):callback(res[0].uri,{revision:Spotify.Utils.formatPlaylistRevision(options.revision)})},errback)()},errback)},this.renamePlaylist=function(playlistUri,name,callback,errback){var data={ops:[{kind:OPERATIONS.UPDATE_LIST_ATTRIBUTES,update_list_attributes:{new_attributes:{values:{name:name}}}}]};_makeRequestFunc(METHOD_TYPES.MODIFY,playlistUri,null,data,function(response,options){callback(!0,options)},errback)()},this.updateItemAttributes=function(playlistUri,itemIndex,attributes,callback,errback){var data={ops:[{kind:OPERATIONS.UPDATE_ITEM_ATTRIBUTES,update_item_attributes:{index:itemIndex,new_attributes:{values:attributes}}}]};this.list({uri:playlistUri,total:-1},function(thelist){_makeRequestFunc(METHOD_TYPES.MODIFY,playlistUri,thelist,data,function(response,options){callback(!0,options)},errback)()},errback)},this.synchronize=function(uri,selection,callback,errback){var req=([{kind:OPERATIONS.METHOD_SYNCHRONIZE,synchronizeArgs:{selection:selection}}],new Spotify.Calls.Hermes({header:{uri:_get_hm_uri(uri),method:METHOD_TYPES.CALL},payload:requestData,payloadSchemas:["playlist_FULL#Playlist4ServiceCall"],responseSchemas:["playlist_FULL#Playlist4ServiceReturn"],type:CALL_TYPE,persistent:!1,bypassCache:!1},callback,errback));this.send(req)},this.subscribeToPlaylists=_subscribeToPlaylists,this.onNotify=function(event){switch(event.type){case _events.CONNECTED:_onConnected(event)}}},Spotify.Services.User=function(){var _self=this,_events=new Spotify.Events,_user=null,_pending=!1,_pendingRequests=[],CALL_TYPE="userdata";this.getUserInfo=function(onSuccess,onError,force){if("undefined"==typeof force&&(force=!1),null===_user||force){if(_pendingRequests.push({onSuccess:onSuccess,onError:onError}),!_pending){_pending=!0;var _onUserInfo=function(results){_user=results.response,_pending=!1;for(var n=0,len=_pendingRequests.length;len>n;n+=1)_pendingRequests[n].onSuccess(_user);_pendingRequests=[]},_onUserError=function(event){_pending=!1;for(var n=0,len=_pendingRequests.length;len>n;n+=1)_pendingRequests[n].onError(event);_pendingRequests=[]},req=new Spotify.Calls.Simple({method:"user_info",payload:[],context:this,persistent:!1,retries:2,type:CALL_TYPE},_onUserInfo,_onUserError);this.send(req)}}else onSuccess(_user)},this.setUserAttribute=function(key,value,onSuccess,onError){var onUserAttributeSetSuccess=function(response){_user[key]=value,onSuccess(!0,200),_self.trigger(_events.USER_INFO_CHANGE)},req=new Spotify.Calls.Simple({method:"set_ua",payload:[key,value],context:this,persistent:!1,retries:2,type:CALL_TYPE},onUserAttributeSetSuccess,onError);this.send(req)},this.onNotify=function(event){switch(event.type){case _events.USER_INFO_CHANGE:this.trigger(_events.USER_INFO_CHANGE)}}},Spotify.Services.Social=function(){var TYPE_FAST="fast",TYPE_COMPLETE="complete",CALL_TYPE="social",_createGetUri=(Spotify.DebuggerJS,new Spotify.Parsers.Social,function(username){return"hm://social/decoration/user/"+encodeURIComponent(username)});this.getUsers=function(usernames,type,onSuccess,onError){var len=0,payloads=[],i=0;"undefined"==typeof type?type=TYPE_FAST:type!==TYPE_FAST&&type!==TYPE_COMPLETE&&(type=TYPE_FAST);for(len=usernames.length;len>i;++i)payloads.push({uri:_createGetUri(usernames[i])});var req=new Spotify.Calls.Hermes({header:{uri:"hm://social/decorations/"+type,method:"GET"},isMultiGet:!0,payload:[{request:payloads}],responseSchemas:["social#DecorationData"],type:CALL_TYPE},onSuccess,onError);this.send(req)}},Spotify.SourceURLs={normal:"https://d3rt1990lpmkn.cloudfront.net/300/",
original:"https://d3rt1990lpmkn.cloudfront.net/unbranded/"},Spotify.Services.SongUriResolver=function(){var _rateLimiter,RATE_LIMIT_WAIT=1e4,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL=1,CALL_TYPE="track_uri",MP3_160="mp3160",_debugger=Spotify.DebuggerJS,_events=new Spotify.Events,_self=this,_parser=new Spotify.Parsers.URL,_rateLimitReached=!1;this.IN_CDN=0,this.ONLY_ON_STORAGE=1,this.RATE_LIMIT_REACHED=2,this.TRACK_RESTRICTED=3;var _onRateLimitCall=function(event){var trackUri=event.params.trackUri,fileId=event.params.fileId,callback=event.params.callback,errback=event.params.errback,schema=event.params.schema;_debugger.log("Spotify.Services.SongUriResolver",["Rate limit is calling again:",trackUri],"corejs"),_self.list(trackUri,schema,fileId,callback,errback)},_onRateLimitCallDisabled=function(event){_debugger.log("Spotify.Services.SongUriResolver",["Rate limit is disabled"],"corejs"),_rateLimitReached=!1},_enableRateLimiting=function(event){_debugger.warn("Spotify.Services.SongUriResolver",["Rate limit is enabled"],"corejs"),_rateLimitReached=!0,_rateLimiter.start()};this.list=function(trackUri,schema,fileId,callback,errback){var _fileId=fileId,_trackUri=trackUri,link=Spotify.Link.fromString(trackUri);if(!this.serviceIsReady)return _debugger.error("Spotify.Services.SongUriResolver",["Service is not ready"],"corejs"),void errback(new Error("Services.SongUriResolver:list Service is not ready"));if(!(link instanceof Spotify.Link))return _debugger.error("Spotify.Services.SongUriResolver",["Invalid arguments"],"corejs"),errback(new Error("Services:SongUriResolver:list Invalid arguments")),!1;if(_rateLimitReached&&0!==_rateLimiter.totalPendingRequests()){var oldCall=_rateLimiter.getItemAtIndex(0);if(null!==oldCall&&"undefined"!=typeof oldCall){var error=new Spotify.Errors.Error([Spotify.Errors.Domains.TRACK_ERROR,Spotify.Errors.Codes.TRACK_REQUEST_RATE_LIMITED,""]);oldCall.errback(error)}return void _rateLimiter.addToBucket({trackUri:_trackUri,schema:schema,fileId:fileId,callback:callback,errback:errback},!1)}var onRPCSuccess=function(response){if(null!==response.response){var type=response.response.type;if(type===_self.IN_CDN){var urlObject;"rtmp"===schema?(urlObject=_parser.parseRTMPUrl(response.response.uri),response.response.uri=urlObject.file):urlObject=_parser.parseHTTPUrl(response.response.uri),response.response.server=urlObject.server,response.response.protocol=urlObject.protocol,callback(response.response,200),_debugger.log("Spotify.Services.SongUriResolver",["Song can be loaded",response.response],"corejs")}else{var errorEventObject=new Spotify.Errors.Error([Spotify.Errors.Domains.TRACK_ERROR,0,""]);errorEventObject.code=type,type===_self.ONLY_ON_STORAGE?errorEventObject.description="Song only on storage":type===_self.RATE_LIMIT_REACHED?errorEventObject.description="Rate limit reached":type===_self.TRACK_RESTRICTED&&(errorEventObject.description="Track restricted"),errorEventObject.data=_trackUri,errback(errorEventObject),_debugger.error("Spotify.Services.SongUriResolver",["I could not load the song",errorEventObject],"corejs")}}else{var errorEventObject=new Spotify.Errors.Error([Spotify.Errors.Domains.TRACK_ERROR,0,"Response was null"]);errorEventObject.data=_trackUri,errback(errorEventObject),_debugger.error("Spotify.Services.SongUriResolver",["I could not load the song",errorEventObject],"corejs")}},onRPCError=function(error){error.data=_trackUri,error.domain===Spotify.Errors.Domains.TRACK_ERROR&&error.code===Spotify.Errors.Codes.TRACK_REQUEST_RATE_LIMITED?(_enableRateLimiting(),_rateLimiter.addToBucket({trackUri:_trackUri,schema:schema,fileId:fileId,callback:callback,errback:errback},!1)):(error.domain===Spotify.Errors.Domains.TRACK_ERROR&&error.code===Spotify.Errors.Codes.TIME_CAP&&_self.trigger(_events.TIME_CAP,error),errback(error)),_debugger.error("Spotify.Services.SongUriResolver",["I could not load the song",error],"corejs")},reqParams={context:_self,persistent:!0,retries:2};_fileId?(reqParams.method="track_uri2",reqParams.payload=[link.id,fileId],reqParams.type="track_uri2"):(reqParams.method="track_uri",reqParams.payload=[MP3_160,link.id,schema],reqParams.type=CALL_TYPE),_self.send(new Spotify.Calls.Simple(reqParams,onRPCSuccess,onRPCError))},this.initialize=function(){_rateLimiter=new Spotify.RateLimiter(RATE_LIMIT_WAIT,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL),_rateLimiter.bind(_events.RATE_LIMIT_CALL,_onRateLimitCall,this),_rateLimiter.bind(_events.RATE_LIMIT_DISABLED,_onRateLimitCallDisabled,this)},this.initialize.call(this)},Spotify.Services.AdUriResolver=function(){var _debugger=Spotify.DebuggerJS,_parser=new Spotify.Parsers.URL,_AD_CDN_ENDPOINT="http://d7zatysqm84hv.cloudfront.net/mp3-ad/",RTMP_URL="rtmp://saa23rvd7l5c6.cloudfront.net/cfx/st/mp3-ad/",_ADS_ERROR_DOMAIN=15,_self=this;this.list=function(adUri,schema,fileId,callback,errback){var _adUri=adUri,link=Spotify.Link.fromString(adUri);if(!this.serviceIsReady)return void errback(new Spotify.Errors.Error([_ADS_ERROR_DOMAIN,503,"AdUriResolver service not ready!"]));if(!(link instanceof Spotify.Link))return errback(new Spotify.Errors.Error([_ADS_ERROR_DOMAIN,400,"Invalid arguments"])),!1;var onRPCSuccess=function(response){var type=response.response.type;if(0===type){var urlObject;"rtmp"===schema?(urlObject=_parser.parseRTMPUrl(response.response.uri),response.response.uri=urlObject.file):urlObject=_parser.parseHTTPUrl(response.response.uri),response.response.server=urlObject.server,response.response.protocol=urlObject.protocol,callback(response.response,200)}else{var errorEventObject={method:"ad_uri",response:response};type===_self.ONLY_ON_STORAGE?errorEventObject.response="Song only on storage":type===_self.RATE_LIMIT_REACHED?errorEventObject.response="Rate limit reached":type===_self.TRACK_RESTRICTED&&(errorEventObject.response="Track restricted"),errorEventObject.adUri=_adUri,_debugger.error("Spotify.Services.AdUriResolver",["Error with track",errorEventObject],"corejs"),errback(errorEventObject)}};onRPCSuccess({method:"ad_uri",response:{type:0,uri:"rtmp"===schema?RTMP_URL+link.id:_AD_CDN_ENDPOINT+link.id}})}},Spotify.Services.PreviewsUriResolver=function(){var CDN_URL="http://d318706lgtcm8e.cloudfront.net/mp3-preview/",RTMP_URL="rtmp://soamh0g9lumcr.cloudfront.net/cfx/st/mp3-preview/",_parser=(Spotify.DebuggerJS,new Spotify.Parsers.URL);new Spotify.Events;this.list=function(trackUri,schema,_,callback,errback){var urlObject,response={},fileId=Spotify.Link.fromString(trackUri).id;"rtmp"===schema?(urlObject=_parser.parseRTMPUrl(RTMP_URL+fileId),response.uri=urlObject.file):(urlObject=_parser.parseHTTPUrl(CDN_URL+fileId),response.uri=CDN_URL+fileId),response.server=urlObject.server,response.protocol=urlObject.protocol,response.lid="",response.type=0,callback(response)}},Spotify.Services.Pubsub=function(){var _self=(Spotify.DebuggerJS,this),CALL_TYPE="pubsub",_events=new Spotify.Events,_subscriptions={},_onMessage=function(event){var header=Spotify.Hermes.Header.parseFromStringSync(Spotify.Utils.Base64.decode(event.params[2]));if(header){var subscription,s,len,subscription_uri=header.uri,subscriptions=_subscriptions[subscription_uri],parsedResponse=[],i=0;if(200===header.status_code)for(s=0,len=subscriptions.length;len>s;s+=1){subscription=subscriptions[s];for(var z=3,zlen=event.params.length;zlen>z;z+=1)subscription.responseSchemas[i]&&parsedResponse.push(_self.getProtobufMsgParser.apply(_self,subscription.responseSchemas[i].split("#")).parseFromStringSync(Spotify.Utils.Base64.decode(event.params[z]))),i++;subscription.callback.call(subscription.context,event.params,parsedResponse)}else for(s=0,len=subscriptions.length;len>s;s+=1)subscription=subscriptions[s],subscription.errorCallback.call(subscription.context,header)}};this.subscribe=function(uri,requestData,ass,responseSchemas,subscriptionCallback,subscriptionErrorCallback,callback,ctx){function onSuccess(result){var serializer=_self.getProtobufMsgParser("pubsub","Subscription"),responses=[];if(result){for(var oneSuccessfull=!1,i=0;i<result.length;++i){var response=serializer.parseFromStringSync(result[i]);if(0!=response.uri.indexOf("hm://remote")||response.status_code||(response.status_code=200),200===response.status_code){var subscription_uri=response.uri;responses.push(subscription_uri),"undefined"==typeof _subscriptions[subscription_uri]&&(_subscriptions[subscription_uri]=[]),_subscriptions[subscription_uri].push({callback:callback,context:ctx,uri:subscription_uri,responseSchemas:responseSchemas,arguments:[]}),oneSuccessfull=!0}}if(!oneSuccessfull)return void onError()}subscriptionCallback.call(ctx,responses)}function onError(error){subscriptionErrorCallback.call(ctx,error)}if("undefined"==typeof uri||"undefined"==typeof callback||"undefined"==typeof subscriptionCallback||"undefined"==typeof subscriptionErrorCallback||"undefined"==typeof ctx)return void subscriptionErrorCallback.call(ctx,new Spotify.Errors.Error([0,16,"Not all argments are provided"]));if(Spotify.Utils.isArray(requestData)||(requestData=[]),Spotify.Utils.isArray(responseSchemas)||(responseSchemas=[]),Spotify.Utils.isArray(ass)||(ass=[]),!this.serviceIsReady)return void subscriptionErrorCallback.call(ctx,new Spotify.Errors.Error([13,503,"Pubsub service not ready!"]));var req=new Spotify.Calls.Hermes({header:{uri:uri,method:"SUB"},payload:requestData,payloadSchemas:ass,responseSchemas:[],type:CALL_TYPE,persistent:!1,bypassCache:!0},onSuccess,onError);this.send(req)},this.onNotify=function(event){switch(event.type){case _events.HERMES_B64_MESSAGE:_onMessage(event)}}},Spotify.Services.Presence=function(){var _debugger=Spotify.DebuggerJS,_self=this,_events=new Spotify.Events,CALL_TYPE="Presence",_playlistPublishedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.uri},_playlistTrackAddedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.playlist_uri,genericState.context_uri=stateObj.track_uri},_trackFinishedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.uri,genericState.context_uri=stateObj.context_uri,genericState.referrer_uri=stateObj.referrer_uri},_favAppAddedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.app_uri},_trackStartedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.uri,genericState.context_uri=stateObj.context_uri,genericState.referrer_uri=stateObj.referrer_uri},_uriSharedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.uri,genericState.message=stateObj.message},_artistFollowedDecorator=function(genericState,stateObj){genericState.item_uri=stateObj.uri,genericState.item_name=stateObj.artist_name,genericState.item_image=stateObj.artist_cover_uri},_genericDecorator=function(genericState,stateObj){genericState.type=stateObj.type,genericState.timestamp=stateObj.timestamp,genericState.item_uri=stateObj.item_uri,genericState.item_name=stateObj.item_name,genericState.item_image=stateObj.item_image,genericState.context_uri=stateObj.context_uri,genericState.context_name=stateObj.context_name,genericState.context_image=stateObj.context_image,genericState.referrer_uri=stateObj.referrer_uri,genericState.referrer_name=stateObj.referrer_name,genericState.referrer_image=stateObj.referrer_image,genericState.message=stateObj.message,genericState.device_information=stateObj.device_information},STATE_TYPES={PLAYLIST_PUBLISHED:{name:"playlist_published",id:1,decorator:_playlistPublishedDecorator},PLAYLIST_TRACK_ADDED:{name:"playlist_track_added",id:2,decorator:_playlistTrackAddedDecorator},TRACK_FINISHED_PLAYING:{name:"track_finished_playing",id:3,decorator:_trackFinishedDecorator},FAVORITE_APP_ADDED:{name:"favorite_app_added",id:4,decorator:_favAppAddedDecorator},TRACK_STARTED_PLAYING:{name:"track_started_playing",id:5,decorator:_trackStartedDecorator},URI_SHARED:{name:"uri_shared",id:6,decorator:_uriSharedDecorator},ARTIST_FOLLOWED:{name:"artist_followed",id:7,decorator:_artistFollowedDecorator},GENERIC:{name:"generic",id:11,decorator:_genericDecorator}},_createSubscribeUrl=function(){return"hm://presence/user/"},_createBroadcastUrl=function(user){return"hm://presence/user/"+encodeURIComponent(user)},_onMessage=function(result,parsedResult){var message,args=result;args.length>0&&(message=_self.getProtobufMsgParser("presence","State").parseFromStringSync(Spotify.Utils.Base64.decode(args[3])),_self.trigger(_events.NOTIFICATION,message))},_onBroadcastSuccess=function(res){_debugger.log("Spotify.Services.Presence",["Broadcast success",res],"corejs")},_onBroadcastError=function(e){_debugger.error("Spotify.Services.Presence",["Broadcast error",e],"corejs")},_onGetStatusesError=function(e){_debugger.error("Spotify.Services.Presence",["Statuses error",e],"corejs")},_broadcast=function(args,callback){_self.services.user.getUserInfo(function(response){var req=new Spotify.Calls.Hermes({header:{uri:_createBroadcastUrl(response.user),method:"SET"},payload:[args],payloadSchemas:["presence#State"],responseSchemas:[],type:CALL_TYPE,bypassCache:!1,persistent:!1},callback||_onBroadcastSuccess,_onBroadcastError);_self.send(req)},_onBroadcastError)},_getStatuses=function(user,callback,errback){var success=function(result,status){var statesToReturn=[],states=result[0];if(!states||"object"!=typeof states)return void callback([]);for(var key in states)if(states.hasOwnProperty(key)){var state=states[key],stateType=STATE_TYPES[key.toUpperCase()],genericState={timestamp:state.timestamp,type:stateType.id,username:user};stateType.decorator(genericState,state),genericState.device_information||statesToReturn.push(genericState)}callback(statesToReturn,status)},req=new Spotify.Calls.Hermes({header:{uri:_createSubscribeUrl(),method:"GET"},payload:[user],payloadSchemas:[],responseSchemas:["presence#State"],type:CALL_TYPE,bypassCache:!1,persistent:!1},success,_onGetStatusesError);_self.send(req)};this.subscribe=function(users,callback,errorCallback,ctx){return this.serviceIsReady?"undefined"==typeof users?void errorCallback.call(ctx,new Spotify.Errors.Error([0,16,"Not all argments are provided"])):Spotify.Utils.isArray(users)?void this.services.pubsub.subscribe(_createSubscribeUrl(),users,[],[],callback,errorCallback,_onMessage,_self):void errorCallback.call(ctx,new Spotify.Errors.Error([0,16,"Users arguments must be an array"])):void errorCallback.call(ctx,new Spotify.Errors.Error([13,503,"Presence service not ready!"]))},this.broadcastPlaylistPublished=function(uri,callback){var args={generic:{type:STATE_TYPES.PLAYLIST_PUBLISHED.id,item_uri:uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastTrackAdded=function(playlist_uri,track_uri,callback){var args={generic:{type:STATE_TYPES.PLAYLIST_TRACK_ADDED.id,context_uri:playlist_uri,item_uri:track_uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastTrackStartedPlaying=function(track_uri,context_uri,referrer_uri,callback){var args={generic:{type:STATE_TYPES.TRACK_STARTED_PLAYING.id,item_uri:track_uri,context_uri:context_uri,referrer_uri:referrer_uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastTrackFinishedPlaying=function(track_uri,context_uri,referrer_uri,callback){var args={generic:{type:STATE_TYPES.TRACK_FINISHED_PLAYING.id,item_uri:track_uri,context_uri:context_uri,referrer_uri:referrer_uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastFavoriteAppAdded=function(app_uri,callback){var args={generic:{type:STATE_TYPES.FAVORITE_APP_ADDED.id,item_uri:app_uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastUriShared=function(uri,message,callback){var args={generic:{type:STATE_TYPES.URI_SHARED.id,item_uri:uri,message:message,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.broadcastArtistFollowed=function(uri,artist_name,artist_cover_uri,callback){var args={generic:{type:STATE_TYPES.ARTIST_FOLLOWED.id,item_uri:uri,item_name:artist_name,item_image:artist_cover_uri,timestamp:(new Date).getTime()/1e3}};_broadcast(args,callback)},this.getStatuses=function(username,callback,errback){_getStatuses(username,callback,errback)}},Spotify.Services.SocialGraph=function(){var _debugger=Spotify.DebuggerJS,CALL_TYPE="socialgraph",_self=this,_spEvents=new Spotify.Events,_events={subscriptions:{add:_spEvents.RELATIONS_SUBSCRIBE,remove:_spEvents.RELATIONS_UNSUBSCRIBE},dismissed:{add:_spEvents.RELATIONS_DISMISS,remove:_spEvents.RELATIONS_UNDISMISS},blocked:{add:_spEvents.RELATIONS_BLOCK,remove:_spEvents.RELATIONS_UNBLOCK}},_MAXBATCH=1e3,_isCached={subscribers:!1,subscriptions:!1,dismissed:!1,blocked:!1},_cacheCurrentUserRelationsByType=function(type,offset){offset=offset||0;var success=function(result,code){var users=result[0].users;if(users){for(var i=0,l=users.length;l>i;i++)_relationsCache[type][users[i].username]=i;if(users.length===_MAXBATCH)return offset+=users.length,void _cacheCurrentUserRelationsByType(type,offset)}_isCached[type]=!0},error=function(){_debugger.error("Spotify.Services.SocialGraph",["We failed to cache the user's "+type,arguments],"corejs")};_self.services.user.getUserInfo(function(userInfo){_get(type,userInfo.user,_MAXBATCH,offset,success,error)},error)},_cacheCurrentUserRelations=function(){for(var type in _relationsCache)_cacheCurrentUserRelationsByType(type)},_lastResultCache={subscribers:{},subscriptions:{},dismissed:{},blocked:{}},_relationsCache={subscribers:{},subscriptions:{},dismissed:{},blocked:{}},_cacheLastResult=function(type,username,lastSub){var cache=_lastResultCache[type];cache[username]=cache[username]||{},cache[username].lastResult=lastSub},_getLast=function(type,username){var cache=_lastResultCache[type],ret="";return cache[username]&&cache[username].lastResult&&(ret=cache[username].lastResult),ret},_get=function(type,username,length,offset,callback,errback,relevant){_self.services.user.getUserInfo(function(userInfo){var payloadSchemas=[];username||(username=userInfo.user);var requestUri="hm://socialgraph/"+type+"/user/"+encodeURIComponent(username);relevant&&(requestUri+="/relevant");var data=[{count:length,include_length:!0}],success=function(frames,code){var users=frames[0].users;if(users){var lastUser=users[users.length-1].username;_cacheLastResult(type,username,lastUser)}callback(frames,code)};relevant?data=[]:(payloadSchemas=["socialgraph#UserListRequest"],data[0].last_result=0===offset?"":_getLast(type,username));var req=new Spotify.Calls.Hermes({header:{uri:requestUri,method:"GET"},payload:data,payloadSchemas:payloadSchemas,responseSchemas:["socialgraph#UserListReply"],type:CALL_TYPE},success,errback);_self.send(req)},errback)},_getCount=function(type,users,callback,errback){_self.services.user.getUserInfo(function(userInfo){users||(users=[userInfo.user]);var requestUri="hm://socialgraph/"+type+"/count/",data=[{args:users}],req=new Spotify.Calls.Hermes({header:{uri:requestUri,method:"GET"},payload:data,payloadSchemas:["socialgraph#StringListRequest"],responseSchemas:["socialgraph#CountReply"],type:CALL_TYPE},callback,errback);_self.send(req)},errback)},_updateRelationsCache=function(type,remove,users){for(var i=0,l=users.length;l>i;i++)remove?delete _relationsCache[type][users[i]]:_relationsCache[type][users[i]]=i},_modify=function(type,remove,users,callback,errback){var requestUri="hm://socialgraph/"+type,data=[{args:users}],success=function(frames,code){callback(frames,code);var events=_events[type],eventType=remove?events.remove:events.add;_self.trigger(eventType,{users:users}),_updateRelationsCache(type,remove,users)},req=new Spotify.Calls.Hermes({header:{uri:requestUri,method:remove?"DELETE":"POST"},payload:data,payloadSchemas:["socialgraph#StringListRequest"],responseSchemas:["socialgraph#StringListReply"],type:CALL_TYPE},success,errback);_self.send(req)},_exists=function(type,username,users,callback,errback){var requestUri="hm://socialgraph/"+type+"/user/"+encodeURIComponent(username)+"/exists",data=[{args:users}],req=new Spotify.Calls.Hermes({header:{uri:requestUri,method:"GET"},payload:data,payloadSchemas:["socialgraph#StringListRequest"],responseSchemas:["socialgraph#StringListReply"],type:CALL_TYPE},callback,errback);_self.send(req)};this.setup=function(){},this.getSubscribers=function(username,length,offset,callback,errback){_get("subscribers",username,length,offset,callback,errback)},this.getRelevantSubscribers=function(username,length,offset,callback,errback){_get("subscribers",username,length,offset,callback,errback,!0)},this.getSubscriptions=function(username,length,offset,callback,errback){_get("subscriptions",username,length,offset,callback,errback)},this.getRelevantSubscriptions=function(username,length,offset,callback,errback){_get("subscriptions",username,length,offset,callback,errback,!0)},this.getDismissed=function(username,length,offset,callback,errback){_get("dismissed",username,length,offset,callback,errback)},this.getBlocked=function(username,length,offset,callback,errback){_get("blocked",username,length,offset,callback,errback)},this.getSubscribersCount=function(users,callback,errback){_getCount("subscribers",users,callback,errback)},this.getSubscriptionsCount=function(users,callback,errback){_getCount("subscriptions",users,callback,errback)},this.subscribeTo=function(users,callback,errback){_modify("subscriptions",!1,users,callback,errback)},this.unsubscribeFrom=function(users,callback,errback){_modify("subscriptions",!0,users,callback,errback)},this.dismiss=function(users,callback,errback){_modify("dismissed",!1,users,callback,errback)},this.undismiss=function(users,callback,errback){_modify("dismissed",!0,users,callback,errback)},this.block=function(users,callback,errback){_modify("blocked",!1,users,callback,errback)},this.unblock=function(users,callback,errback){_modify("blocked",!0,users,callback,errback)},this.isSubscribed=function(users){for(var result=[],i=0,len=users.length;len>i;i++)result.push(users[i]in _relationsCache.subscriptions);return result},this.hasSubscribers=function(username,users,callback,errback){_exists("subscribers",username,users,callback,errback)},this.hasSubscriptions=function(username,users,callback,errback){_exists("subscriptions",username,users,callback,errback)},this.hasDismissed=function(username,users,callback,errback){_exists("dismissed",username,users,callback,errback)},this.hasBlocked=function(username,users,callback,errback){_exists("blocked",username,users,callback,errback)},this.hasHidden=function(username,users,callback,errback){_exists("hidden",username,users,callback,errback)},this.preloadCurrentUserRelations=_cacheCurrentUserRelations},Spotify.Services.MergedProfile=function(){var _self=this,CALL_TYPE="mergedprofile",_get=function(type,key,callback,errback){if(!_self.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"MergedProfile service not ready!"]));var onSuccess=function(response){for(var item,l=0,len=response.length;len>l;l+=1)item=response[l],"undefined"!=typeof item.artistid?item.artist="spotify:artist:"+item.artistid:item.artist=null,"undefined"!=typeof item.username?item.user=Spotify.Link.profileLink(item.username).toURI():item.user=null,delete item.artistid,delete item.username;callback(response,200)},req=new Spotify.Calls.Hermes({header:{uri:"hm://mergedprofile/mergedprofile/"+type+"/"+encodeURIComponent(key),method:"GET"},payload:[],payloadSchemas:[],responseSchemas:["mergedprofile#MergedProfileReply"],type:CALL_TYPE},onSuccess,errback);_self.send(req)};this.forUser=function(username,callback,errback){_get("user",username,callback,errback)},this.forArtist=function(artistid,callback,errback){_get("artist",artistid,callback,errback)}},Spotify.Services.Inbox=function(){this.getInbox=function(args,callback,errback){return this.serviceIsReady?void this.services.playlist.list({uri:Spotify.Link.inboxLink(args.username).toURI(),offset:args.offset,total:args.total},callback,errback):void errback(new Spotify.Errors.Error([13,503,"Inbox service not ready!"]))},this.addToInbox=function(args,callback,errback){if(!this.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Inbox service not ready!"]));if("undefined"==typeof args.items)return void errback(new Spotify.Errors.Error([13,503,"You need to provide at least one item to send"]));if(!args.recipient)return void errback(new Spotify.Errors.Error([13,503,"You need to provide a recipient"]));if(!args.sender)return void errback(new Spotify.Errors.Error([13,503,"You need to provide a sender"]));for(var n=0,len=args.items.length;len>n;n+=1)args.items[n].addedBy=args.sender||"";var inboxUri=Spotify.Link.inboxLink(args.recipient).toURI();this.services.playlist.addToPlaylistWithAttributes(inboxUri,args.items,callback,errback)},this.deleteFromInbox=function(args,callback,errback){if("undefined"==typeof args.username)return void errback(new Spotify.Errors.Error([13,503,"You need to provide a username"]));var offset=args.offset||0,total=args.total||1,inboxUri=Spotify.Link.inboxLink(args.username).toURI();this.services.playlist.removeFromPlaylist(inboxUri,offset,total,callback,errback)},this.markAsRead=function(args,callback,errback){if("undefined"==typeof args.username)return void errback(new Spotify.Errors.Error([13,503,"You need to provide a username"]));if("undefined"==typeof args.itemIndex)return void errback(new Spotify.Errors.Error([13,503,"You need to provide an index for the item you want to mark as read"]));var inboxUri=Spotify.Link.inboxLink(args.username).toURI(),attributes={seen:1};this.services.playlist.updateItemAttributes(inboxUri,args.itemIndex,attributes,callback,errback)}},Spotify.InstanceFactory=function(factoryArguments){this.createInstance=factoryArguments.createInstance,this.waitReady=factoryArguments.waitReady||function(instance,callback){instance.onReady?instance.onReady(callback.bind(void 0,instance)):callback(instance)},this.destroyInstance=factoryArguments.destroyInstance||function(){}},Spotify.InstanceFactory.fromService=function(service,opt_initArgs){return new Spotify.InstanceFactory({createInstance:function(extraInitArgs){var instance=new service;return instance.init&&instance.init.apply(instance,(opt_initArgs||[]).concat(extraInitArgs||[])),instance},waitReady:function(instance,callback){instance.onReady?instance.onReady(callback.bind(void 0,instance)):callback(instance)},destroyInstance:function(instance){instance.shutdown&&instance.shutdown()}})},Spotify.InstanceFactory.fromFactoryMethod=function(createInstance,destroyInstance,waitReady){return new Spotify.InstanceFactory({createInstance:createInstance,destroyInstance:destroyInstance,waitReady:waitReady})},Spotify.InstanceCache=function(opt_defaultInstanceFactory){var _cache={},_defaultInstanceFactory=opt_defaultInstanceFactory;this.reset=function(opt_defaultInstanceFactory,opt_keepCache){if(opt_defaultInstanceFactory&&(_defaultInstanceFactory=opt_defaultInstanceFactory),!opt_keepCache){for(var v in _cache){var item=_cache[v];item.factory.destroyInstance(item.instance)}_cache={}}},this.createAwaitReady=function(key,factory,callback,errback){var inst=factory.createInstance(key),item=_cache[key]={instance:inst,factory:factory};item.factory.waitReady(item.instance,callback.bind(void 0,item.instance))},this.get=function(key){var item=_cache[key];if(item)return item.instance;if(_defaultInstanceFactory){var inst=_defaultInstanceFactory.createInstance(key),item=_cache[key]={instance:inst,factory:_defaultInstanceFactory};return inst}throw"No such key and no default factory specified"},this.getAwaitReady=function(key,callback,errback){var item=_cache[key];if(item)item.factory.waitReady(item.instance,callback.bind(void 0,item.instance));else if(_defaultInstanceFactory)this.createAwaitReady(key,_defaultInstanceFactory,callback,errback);else{var err="No such key and no default factory specified";if(!errback)throw err;errback(err)}}},Spotify.DependencyObject=function(){Spotify.EventTarget.call(this);var _self=this,_events=new Spotify.Events;this.serviceIsReady=!1,this.onReady=function(callback,ctx){this.serviceIsReady?callback.call(ctx):this.bind(_events.READY,callback,ctx)},this.markReady=function(){_self.serviceIsReady=!0,_self.trigger(_events.READY)},this.dependsOn=function(dependencies,opt_doneCallback){if(!dependencies||0==dependencies.length)return _self.markReady();var nReady=0,_tryMarkReady=function(){nReady++,nReady==dependencies.length&&(opt_doneCallback?0==opt_doneCallback.length?(opt_doneCallback(),_self.markReady()):opt_doneCallback(function(){_self.markReady()}):_self.markReady())};dependencies.forEach(function(dependency){"function"==typeof dependency?dependency(_tryMarkReady):dependency.onReady(_tryMarkReady)})}},Spotify.Services.Facebook=function(){function _credentialCallback(callback){return function(reply){var credential=_parser.parseCredential(reply);callback(credential)}}var _self=this,_debugger=Spotify.DebuggerJS,_parser=new Spotify.Parsers.Facebook,CALL_TYPE="facebook";this.enable=function(accessToken,callback,errback){this.services.user.getUserInfo(function(response){var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user),method:"CREATE"},payload:[_parser.makeCredential(null,accessToken)],payloadSchemas:["facebook#EnableRequest"],responseSchemas:["facebook#EnableReply"],type:CALL_TYPE,bypassCache:!0,persistent:!1},_credentialCallback(callback),errback);_self._sendRetry(req)},errback)},this.disable=function(facebookUid,accessToken,callback,errback){this.services.user.getUserInfo(function(response){var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user),method:"DELETE"},payload:[_parser.makeCredential(facebookUid,accessToken)],payloadSchemas:["facebook#DisableRequest"],responseSchemas:[],type:CALL_TYPE,bypassCache:!0,persistent:!1},callback,errback);_self._sendRetry(req)},errback)},this.getState=function(facebookUid,accessToken,callback,errback){this.services.user.getUserInfo(function(response){var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user),method:"GET"},payload:[_parser.makeCredential(facebookUid,accessToken)],payloadSchemas:["facebook#UserState"],responseSchemas:["facebook#UserState"],type:CALL_TYPE,bypassCache:!0,persistent:!1},_credentialCallback(callback),errback);_self._sendRetry(req)},errback)},this.updateState=function(facebookUid,accessToken,callback,errback){this.services.user.getUserInfo(function(response){var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user),method:"GET"},payload:[_parser.makeCredential(facebookUid,accessToken)],payloadSchemas:["facebook#UpdateUserStateRequest"],responseSchemas:["facebook#UserState"],type:CALL_TYPE,bypassCache:!0,persistent:!1},_credentialCallback(callback),errback);_self._sendRetry(req)},errback)},this.getFriends=function(callback,errback){this.services.user.getUserInfo(function(response){function onSuccess(reply){var friends=_parser.parseFriendList(reply);callback(friends)}var friendsReq={fields:{app_user:!0,display_name:!0,picture_large:!0}},req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user)+"/friends",method:"GET"},payload:[friendsReq],payloadSchemas:["facebook#FriendsRequest"],responseSchemas:["facebook#FriendsReply"],type:CALL_TYPE},onSuccess,errback);_self._sendRetry(req)},errback)},this.getConfig=function(callback,errback){function onSuccess(reply){var config=_parser.parseConfig(reply);callback(config)}var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/config",method:"GET"},responseSchemas:["facebook#ConfigReply"],type:CALL_TYPE},onSuccess,errback);_self._sendRetry(req)},this.share=function(facebookUid,accessToken,uri,message,callback,errback){this.services.user.getUserInfo(function(response){function onSuccess(reply){var postId=_parser.parsePostId(reply);callback(postId)}var shareReq=_parser.makeCredential(facebookUid,accessToken);shareReq.uri=uri,message&&(shareReq.message_text=message);var req=new Spotify.Calls.Hermes({
header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user)+"/share",method:"POST"},payload:[shareReq],payloadSchemas:["facebook#ShareRequest"],responseSchemas:["facebook#ShareReply"],type:CALL_TYPE,bypassCache:!0},onSuccess,errback);_self._sendRetry(req)},errback)},this.getPermissions=function(facebookUid,accessToken,callback,errback){this.services.user.getUserInfo(function(response){function onSuccess(reply){var permissions=_parser.parsePermissions(reply);callback(permissions)}var permReq=_parser.makeCredential(facebookUid,accessToken);permReq.options={cache_is_king:!1};var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user)+"/permissions",method:"GET"},payload:[permReq],payloadSchemas:["facebook#PermissionsRequest"],responseSchemas:["facebook#PermissionsReply"],type:CALL_TYPE,bypassCache:!0},onSuccess,errback);_self._sendRetry(req)},errback)},this._sendRetry=function(request,opt_maxAttempts){var failures=0,errback=request.error,opt_maxAttempts=opt_maxAttempts||3,sendRequest=function(){_self.send(request)};request.error=function(error){var retryDelay;if(opt_maxAttempts>failures+1&&(statusCode=error.code||0,Spotify.Hermes.Request.isServerError(statusCode)&&(retryDelay=Math.pow(failures,2)+Math.random(),failures++)),void 0!==retryDelay){var msg=["Scheduling retry to request",request.header.method,request.header.uri,"in",retryDelay,"second(s) due to error",error];_debugger.log("Spotify.Services.Facebook",msg,"corejs"),setTimeout(sendRequest,1e3*retryDelay)}else errback(error)},sendRequest()},this.inspectCredential=function(facebookUid,accessToken,callback,errback){this.services.user.getUserInfo(function(response){function onSuccess(reply){var inspection=_parser.parseCredentialInspection(reply);callback(inspection)}var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook/user/"+encodeURIComponent(response.user)+"/inspect",method:"POST"},payload:[_parser.makeCredential(facebookUid,accessToken)],payloadSchemas:["facebook#InspectCredentialRequest"],responseSchemas:["facebook#InspectCredentialReply"],type:CALL_TYPE,bypassCache:!0},onSuccess,errback);_self._sendRetry(req)},errback)}},Spotify.Services.FacebookPublish=function(protoData){var _rateLimiter,CALL_TYPE="facebook-publish",RATE_LIMIT_WAIT=1e3,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL=25,_self=this,_events=new Spotify.Events,_rateLimiterBatch=[],_scrobble=function(uri,startTime,eventName,event,callback,errback){if(!_self.serviceIsReady)return void errback(new Spotify.Errors.Error([13,503,"Facebook-publish service not ready!"]));var item={uri:uri,startTime:startTime,eventName:eventName,event:event,callback:callback,errback:errback};_rateLimiter.addToBucket(item),_rateLimiter.isStarted()||_rateLimiter.start()},_scrobbleMultiple=function(items){_self.services.user.getUserInfo(function(response){for(var payload=[],payloadSchemas=[],responseSchemas=[],index=0;index<items.length;index++){var item=items[index],value={id:{uri:item.uri,startTime:item.startTime}};value[item.eventName]=item.event,payload.push(value),payloadSchemas.push("facebook-publish#Event"),responseSchemas.push("facebook-publish#EventReply")}var req=new Spotify.Calls.Hermes({header:{uri:"hm://facebook-publish/user/"+encodeURIComponent(response.user)+"/music/listen",method:"POST"},payload:payload,payloadSchemas:payloadSchemas,responseSchemas:responseSchemas,type:CALL_TYPE,bypassCache:!1,persistent:!1},function(){for(var index=0;index<items.length;index++)items[index].callback.apply(this,arguments)},function(){for(var index=0;index<items.length;index++)items[index].errback.apply(this,arguments)});_self.send(req)},function(){})},_onRateLimiterCall=function(event){var item=event.params;_rateLimiterBatch.push(item)},_onRateLimiterAfterInterval=function(event){_scrobbleMultiple(_rateLimiterBatch),_rateLimiterBatch=[]};this.scrobbleStart=function(uri,context,startTime,endTime,length,callback,errback){var event={length:length,end_time:endTime};context&&(event.context_uri=context),_scrobble(uri,startTime,"start",event,callback,errback)},this.scrobbleSeek=function(uri,startTime,endTime,callback,errback){var event={end_time:endTime};_scrobble(uri,startTime,"seek",event,callback,errback)},this.scrobblePause=function(uri,startTime,secondsPlayed,endTime,callback,errback){var event={seconds_played:secondsPlayed,end_time:endTime};_scrobble(uri,startTime,"pause",event,callback,errback)},this.scrobbleResume=function(uri,startTime,secondsPlayed,endTime,callback,errback){var event={seconds_played:secondsPlayed,end_time:endTime};_scrobble(uri,startTime,"resume",event,callback,errback)},this.scrobbleEnd=function(uri,startTime,secondsPlayed,endTime,callback,errback){var event={seconds_played:secondsPlayed,end_time:endTime};_scrobble(uri,startTime,"end",event,callback,errback)},this.setup=function(){_rateLimiter=new Spotify.RateLimiter(RATE_LIMIT_WAIT,RATE_LIMIT_NR_OF_CALLS_PER_INTERVAL),_rateLimiter.bind(_events.RATE_LIMIT_CALL,_onRateLimiterCall),_rateLimiter.bind(_events.RATE_LIMIT_AFTER_INTERVAL,_onRateLimiterAfterInterval)}},Spotify.Services.SPIRC=function(){var _currentState,_deviceState,_frameState,_self=this,_ready=!1,CALL_TYPE="spirc",HELLO_TIMEOUT=500,MESSAGE_TYPES={kMessageTypeHello:"kMessageTypeHello",kMessageTypeGoodbye:"kMessageTypeGoodbye",kMessageTypeProbe:"kMessageTypeProbe",kMessageTypeNotify:"kMessageTypeNotify",kMessageTypeLoad:"kMessageTypeLoad",kMessageTypePlay:"kMessageTypePlay",kMessageTypePause:"kMessageTypePause",kMessageTypePlayPause:"kMessageTypePlayPause",kMessageTypeSeek:"kMessageTypeSeek",kMessageTypePrev:"kMessageTypePrev",kMessageTypeNext:"kMessageTypeNext",kMessageTypeVolume:"kMessageTypeVolume",kMessageTypeShuffle:"kMessageTypeShuffle",kMessageTypeRepeat:"kMessageTypeRepeat",kMessageTypeQueue:"kMessageTypeQueue",kMessageTypeVolumeDown:"kMessageTypeVolumeDown",kMessageTypeVolumeUp:"kMessageTypeVolumeUp"},PLAYSTATUS_TYPES={kPlayStatusStop:"kPlayStatusStop",kPlayStatusPlay:"kPlayStatusPlay",kPlayStatusPause:"kPlayStatusPause",kPlayStatusLoading:"kPlayStatusLoading"},PROTOCOL_VERSION="2.0.0",SERVICE_NAME="Spotify.Services.SPIRC",STATES={subbing:"Subbing",running:"Running",playing:"Playing"},VERSION=1,_name="",_debugger=Spotify.DebuggerJS,_deviceConnectManager=function(){var connectedDevice,deviceList={},isConnecting=!1,self={};return self.addDevice=function(id){deviceList.hasOwnProperty(id)||(deviceList[id]=!0)},self.getConnectedDevice=function(){return connectedDevice},self.getDeviceList=function(){var arr=[];for(var key in deviceList)arr.push(key);return arr},self.isConnecting=function(){return isConnecting},self.setConnectedDevice=function(id){connectedDevice=id},self.startConnect=function(){isConnecting=!0,deviceList={}},self.stopConnect=function(){isConnecting=!1},self}(),_events=new Spotify.Events,_greetedAt={},_generateId=function(){return Spotify.Utils.Base62.fromBytes(String((new Date).getTime()).split(""))},_id=null;_id="undefined"!=typeof localStorage?localStorage["connect-id"]||(localStorage["connect-id"]=_generateId()):_generateId();var _stateUpdateId,_user=null,_becomeActive=function(){var now=(new Date).getTime();_deviceState.is_active=!0,_deviceState.became_active_at=now},_becomeInactive=function(){_deviceState.is_active=!1},_transitionToSubbing=function(){_deviceState={is_active:!1,can_play:!0,volume:null,name:_name||_user.user+" - Web Player",became_active_at:0},_stateUpdateId=0,_currentState=STATES.subbing,_debugger.log(SERVICE_NAME,["State -> Subscribing"],"corejs")},_transitionToRunning=function(){_becomeInactive(),_currentState=STATES.running,_debugger.log(SERVICE_NAME,["State -> Running"],"corejs")},_transitionToPlaying=function(){_becomeActive(),_currentState=STATES.playing,_debugger.log(SERVICE_NAME,["State -> Playing"],"corejs")},_createSubscribeUrl=function(){return"hm://remote/user/"+encodeURIComponent(_user.user)+"/r"+_id+"/"},_createBroadcastUrl=function(){return"hm://remote/user/"+encodeURIComponent(_user.user)},_onMessage=function(unparsedFrame,parsedFrame){if(0!==unparsedFrame.length){var message=parsedFrame[0],toBridge={message:message},notRecipient=message.recipient&&-1==message.recipient.indexOf(_id),oldMessage=message.state_update_id&&0!==message.state_update_id&&_stateUpdateId>message.state_update_id;if(message.ident!==_id&&!notRecipient&&!oldMessage)switch(_debugger.log(SERVICE_NAME,["Handling message",message.type],"corejs"),message.type){case MESSAGE_TYPES.kMessageTypeHello:_processHello(message);break;case MESSAGE_TYPES.kMessageTypeNotify:_processNotification(message,toBridge);break;case MESSAGE_TYPES.kMessageTypeLoad:_processLoad(message,toBridge);break;default:_debugger.log(SERVICE_NAME,["Sending",message.type,"to bridge"],"corejs"),_self.trigger(_events.NOTIFICATION,toBridge)}}},_processHello=function(message){if(message.type===MESSAGE_TYPES.kMessageTypeHello){var _processTime=(new Date).getTime();if(_greetedAt.hasOwnProperty(message.ident)&&_processTime-_greetedAt[message.ident]<HELLO_TIMEOUT)return void _debugger.log(SERVICE_NAME,["Ignoring hello from",message.ident],"corejs");_greetedAt[message.ident]=_processTime,_deviceConnectManager.isConnecting()&&_deviceConnectManager.addDevice(message.ident),_broadcast(MESSAGE_TYPES.kMessageTypeHello,[message.ident])}},_processNotification=function(message,toBridge){if(message.type===MESSAGE_TYPES.kMessageTypeNotify){var messageBecameActiveAt=message.device_state.became_active_at;_currentState===STATES.playing?messageBecameActiveAt&&messageBecameActiveAt>_deviceState.became_active_at&&_transitionToRunning():_currentState===STATES.running&&"undefined"!=typeof message.state&&(_debugger.log(SERVICE_NAME,["Sending",message.type,"to bridge"],"corejs"),_self.trigger(_events.NOTIFICATION,toBridge))}},_processLoad=function(message,toBridge){message.type===MESSAGE_TYPES.kMessageTypeLoad&&(_currentState!==STATES.playing&&_transitionToPlaying(),"undefined"!=typeof message.state&&(_debugger.log(SERVICE_NAME,["Sending",message.type,"to bridge"],"corejs"),_self.trigger(_events.NOTIFICATION,toBridge)))},_onUserSuccess=function(result){_user=result,_ready=!0,_transitionToSubbing(),_self.services.pubsub.subscribe(_createSubscribeUrl(),[],[],["spirc#Frame"],_onSubscriptionSuccess,_onSubscriptionError,_onMessage,_self)},_onUserError=function(error){_debugger.error(SERVICE_NAME,["User load failed",error],"corejs")},_onSubscriptionSuccess=function(){_transitionToRunning(),_broadcast(MESSAGE_TYPES.kMessageTypeHello)},_onSubscriptionError=function(error){_debugger.error(SERVICE_NAME,["SPIRC subscription failed",error],"corejs")},_broadcast=function(messageType,recipients,opt_stateUpdateId){recipients=recipients||[],_debugger.log(SERVICE_NAME,["Sending",messageType,"to",recipients.length>0?recipients.join():"everyone."],"corejs");var spircFrame={version:VERSION,ident:_id,protocol_version:PROTOCOL_VERSION,seq_nr:(new Date).getTime(),type:messageType,device_state:_deviceState,recipient:recipients,state:_frameState,state_update_id:void 0!==opt_stateUpdateId?opt_stateUpdateId:_stateUpdateId},req=new Spotify.Calls.Hermes({header:{uri:_createBroadcastUrl(),method:"SEND"},payload:[spircFrame],payloadSchemas:["spirc#Frame"],responseSchemas:["spirc#Frame"],type:CALL_TYPE,bypassCache:!1,persistent:!1},_onBroadcastSuccess,_onBroadcastError);_debugger.log(SERVICE_NAME,["Sending Hermes request",req],"corejs"),_self.send(req)},_onBroadcastSuccess=function(res){_debugger.log(SERVICE_NAME,["Broadcast success",res],"corejs")},_onBroadcastError=function(error){_debugger.error(SERVICE_NAME,["Broadcast error",error],"corejs")},_sendCommand=function(messageType){return _currentState!==STATES.running?void _debugger.error(SERVICE_NAME,["Send command error. Not in running state."],"corejs"):void _broadcast(messageType)};this.setName=function(name){_name=name,_deviceState&&(_deviceState.name=name)},this.getServiceState=function(){return _currentState},this.onTokenLost=function(){_ready&&_self.trigger(_events.TOKEN_LOST)},this.notify=function(){_debugger.log(SERVICE_NAME,["Notify being called"],"corejs"),_stateUpdateId=(new Date).getTime(),_broadcast(MESSAGE_TYPES.kMessageTypeNotify)},this.sendNext=function(){_sendCommand(MESSAGE_TYPES.kMessageTypeNext)},this.sendPause=function(){_sendCommand(MESSAGE_TYPES.kMessageTypePause)},this.sendPlay=function(){_sendCommand(MESSAGE_TYPES.kMessageTypePlay)},this.sendPrev=function(){_sendCommand(MESSAGE_TYPES.kMessageTypePrev)},this.sendSeek=function(){return"undefined"==typeof _frameState?void _debugger.error(SERVICE_NAME,["No frame state set"],"corejs"):void _sendCommand(MESSAGE_TYPES.kMessageTypeSeek)},this.setDeviceVolume=function(volume){_deviceState.volume=volume},this.setFrameState=function(state){_frameState=state,_currentState===STATES.running&&_frameState.status===PLAYSTATUS_TYPES.kPlayStatusPlay&&_transitionToPlaying()},this.subscribe=function(){var userService=_self.services.user;userService.onReady(function(){userService.getUserInfo(_onUserSuccess,_onUserError)})},this.broadcastWakeUp=function(){_broadcast(MESSAGE_TYPES.kMessageTypeHello,[],0)}},Spotify.Core=function(gatewayType,args){Spotify.EventTarget.call(this),Spotify.DebuggerJS.register("console",new Spotify.DebuggerJS.Loggers.Console,new Spotify.DebuggerJS.Parsers.Default),Spotify.Hermes.Cache=new Spotify.HermesCache;var _codeValidator,_flashBlockCheckTimeoutId,_self=this,_debugger=Spotify.DebuggerJS,FLASH_BLOCK_TIMEOUT=1e4,_initializedAndConnected=!1,_playerType="undefined"!=typeof swfobject?Spotify.PlayerTypes.FLASH_HTTP:Spotify.PlayerTypes.HTML5_HTTP,_settings={playerType:_playerType,SWFContainerId:args.SWFContainerId||"",SWFPlayerContainerId:args.SWFPlayerContainerId||"",SWFPlayerUrl:args.SWFPlayerUrl||"player.swf",SWFUrl:args.SWFUrl||"bridge.swf",SWFMinVersion:args.SWFMinVersion||"10.2.0",logging:args.logging||0,analyticsLogging:args.analyticsLogging||0,length:args.length||0,valid:args.valid||0,cdn:args.cdn||"",protoSchemasLocation:args.protoSchemasLocation||"proto/",protoSchemasLocationRandomizer:args.protoSchemasLocationRandomizer||"",services:args.services||{}};this.id="";var _gateway,_gatewayType=gatewayType||Spotify.GatewayTypes.WEBSOCKETS,_events=(args.protocol||Spotify.Protocols.RTMPS,new Spotify.Events),_protoData=Spotify.Protobuf.Schemas;if(!_protoData)throw new Error("Spotify.Protobuf.Schemas is not available. Make sure you run `make schemas` on your CoreJS dir.");var _schemasRegistered=!1,_servicesSchemasDepedencies={};this.protobufSchemasManager=new Spotify.Managers.ProtobufSchemasManager,this.services={},this.player=null,this.suggest=null,this.time=null,this.spirc=null,this.pubsub=null,this.metadata=null,this.playlist=null,this.appstore=null,this.popcount=null,this.search=null,this.user=null,this.toplist=null,this.social=null,this.socialGraph=null,this.facebook=null,this.hermes=null,this.presence=null,this.mergedProfile=null,this.facebookPublish=null,this._bridge=null,this.storageResolver=null,this.adUriResolver=null,this.previewUriResolver=null,this.logging={},this.audioManager,this.features,this.isReady=!1,this.onConnect=function(event){},this.onDisconnect=function(event){},this.onFailedConnecting=function(evet){},this.onTokenLost=function(event){},this.connect=function(ap,credentials){_gateway.connect(ap,credentials)},this.connectWithToken=function(ap,token){_gateway.connect(ap,token)},this.connectWithCredentials=function(ap,username,password){_gateway.connect(ap,"1:"+username+":"+password)},this.disconnect=function(){_gateway.disconnect()},this.migrateToIndexedDBStorage=function(fnSuccess,fnError,ctx){Spotify.Hermes.Cache.migrateToIndexedDB(fnSuccess,fnError,ctx)};var _onServiceCallRequest=function(event){var call=event.params;if(call instanceof Spotify.Calls.Hermes){var n,s,len,successCallback=call.success,pSchemas=call.isMultiGet?call.mercuryMultiGetPayloadSchemas:call.payloadSchemas,resSchemas=call.isMultiGet?call.mercuryMultiGetResponseSchemas:call.responseSchemas,plMsgs=[],resMsgs=[];for(n=0,len=pSchemas.length;len>n;n+=1)plMsgs.push(_self.protobufSchemasManager.getProtobufMsgParser.apply(_self,pSchemas[n].split("#")));for(s=0,len=resSchemas.length;len>s;s+=1)resMsgs.push(_self.protobufSchemasManager.getProtobufMsgParser.apply(_self,resSchemas[s].split("#")));call.isMultiGet&&(successCallback=function(frames,code){for(var l=0;l<frames.length;l+=1){var data=frames[l],response=[];if("undefined"==typeof data.reply)return void call.error(new Spotify.Errors.Error([13,400]));if(call.responseSchemas[l])var finalSchema=_self.protobufSchemasManager.getProtobufMsgParser.apply(_self,call.responseSchemas[l].split("#"));data=data.reply;for(var i=0,len=data.length;len>i;i+=1){var item=data[i];item=item&&item.status_code&&item.status_code>=200&&item.status_code<300?finalSchema&&204!=item.status_code?finalSchema.parseFromStringSync(item.body):item:null,response.push(item)}}call.success(response,code)});var req=new Spotify.Hermes.ProtobufRequest(call.header,call.payload,plMsgs,resMsgs);req.send(_gateway,successCallback,call.error,call.persistent,call.bypassCache,call.type)}else call instanceof Spotify.Calls.Simple&&_gateway.rpc(call.method,call.payload,call.success,call.error,call.context,call.persistent,call.retries,call.type)};this.registerService=function(id,dependencies,schemas,service,parentService){if("undefined"!=typeof this.services[id])return _debugger.error("Spotify.Core",["A service with id",id,"already exists"],"corejs"),null;if("undefined"==typeof parentService&&(parentService=Spotify.Services.Base),service=Spotify.Utils.inherit(parentService.bind(this,this.protobufSchemasManager),service),_servicesSchemasDepedencies[id]=schemas,_schemasRegistered)for(var i=0,l=schemas.length;l>i;++i){var schema=schemas[i];this.protobufSchemasManager.registerSchema(schema,_protoData[schema])}var n=new service;return this.services[id]=n,n._dependencies=dependencies,n.id=id,n.bind(_events.REQUEST,_onServiceCallRequest,this),this.services[id]},this.dispose=function(){for(var key in this.services){try{this.services[key].dispose()}catch(e){}this.services[key]=null}this.audioManager.dispose(),_gateway.dispose()},this.getGateway=function(){return _gateway},this.onReady=function(callback,ctx){this.isReady?callback.call(ctx):this.bind(_events.READY,callback,ctx)};var _onTokenLost=function(event){var activePlayer=_self.audioManager.getActivePlayer();activePlayer&&activePlayer.pause(),_self.onTokenLost(event)},_onMessage=function(event){_notifyServices(event)},_notifyServices=function(event){for(var key in _self.services)try{_self.services[key].onNotify(event)}catch(e){}},_onPlayerEvent=function(event){_notifyServices(event)};this.initialize=function(){Spotify.Instances.add(_self),this.protobufSchemasManager.registerSchema("mercury",_protoData.mercury),this.protobufSchemasManager.registerSchema("pubsub",_protoData.pubsub),_self.registerService("user",[],[],Spotify.Services.User),_self.user=_self.services.user,_self.registerService("logging_clientEvent",["logging_logger"],[],Spotify.Logging.ClientEvent),_self.logging.clientEvent=_self.services.logging_clientEvent,_self.registerService("logging_view",[],[],Spotify.Logging.View),_self.logging.view=_self.services.logging_view,_self.registerService("logging_logger",[],[],Spotify.Logging.Logger),_self.logging.logger=_self.services.logging_logger,_self.registerService("heartbeat",[],[],Spotify.Heartbeat),_self.registerService("storageResolver",[],[],Spotify.Services.SongUriResolver),_self.storageResolver=_self.services.storageResolver,_self.storageResolver.bind(_events.TIME_CAP,_onTimeCap,_self),_self.registerService("adResolver",[],[],Spotify.Services.AdUriResolver),_self.adUriResolver=_self.services.adResolver,_self.registerService("previewResolver",[],[],Spotify.Services.PreviewsUriResolver),_self.previewUriResolver=_self.services.previewResolver,_self.registerService("pubsub",[],["pubsub"],Spotify.Services.Pubsub),_self.pubsub=_self.services.pubsub,_gateway=new Spotify.Gateway(_gatewayType),_gateway.bind(_events.READY,_onGatewayReady,_self),_gateway.bind(_events.ON_TRY_TO_CONNECT,_informForConnectionRetry,_self),_gateway.bind(_events.CONNECTED,_onConnected,_self),_gateway.bind(_events.DISCONNECTED,_onDisconnected,_self),_gateway.bind(_events.FAILED_CONNECTING,_onFailedConnecting,_self),_gateway.bind(_events.TOKEN_LOST,_onTokenLost,_self),_gateway.bind(_events.FLASH_AVAILABLE,_onFlashEvent,_self),_gateway.bind(_events.FLASH_UNAVAILABLE,_onFlashEvent,_self),_gateway.bind(_events.FLASH_ERROR,_onFlashError,_self),_gateway.bind(_events.HERMES_B64_MESSAGE,_onMessage,_self),_gateway.bind(_events.USER_INFO_CHANGE,_onUserInfoChange,_self),_gateway.bind(_events.PASSWORD_CHANGED,_onPasswordChange,_self),Spotify.Hermes.Cache.onfull=_onStorageFull,_self.features=new Spotify.Features(args.features),_self.hermes=new Spotify.Hermes.Handler(this.protobufSchemasManager),_self.hermes.init(_gateway),_self.audioManager=new Spotify.Audio.AudioManager(_self.id,_settings,_playerType),_self.audioManager.bind(_events.FLASH_AVAILABLE,_onFlashEvent,_self),_self.audioManager.bind(_events.FLASH_UNAVAILABLE,_onFlashEvent,_self),_self.audioManager.bind(_events.NO_SOUND_CAPABILITIES,_onNoSoundCapabilities),_self.audioManager.bind(_events.INITIALIZED,_onAudioManagerReady,_self),_self.audioManager.bind(_events.TRACK_ENDED,_onPlayerEvent,_self),_self.audioManager.bind(_events.POSITION_CHANGED,_onPlayerEvent,_self),_self.audioManager.bind(_events.PLAYING,_onPlayerEvent,_self),_self.audioManager.bind(_events.PAUSED,_onPlayerEvent,_self),_self.audioManager.bind(_events.STOPPED,_onPlayerEvent,_self),_self.audioManager.bind(_events.LOAD,_onPlayerEvent,_self),_self.audioManager.addFileResolver(Spotify.Resolvers.STORAGE_RESOLVER,_self.services.storageResolver),_self.audioManager.addFileResolver(Spotify.Resolvers.AD_RESOLVER,_self.services.adResolver),_self.audioManager.addFileResolver(Spotify.Resolvers.PREVIEW_RESOLVER,_self.services.previewResolver),_self.audioManager.initialize(_gateway,_self.user),_codeValidator=new Spotify.Worker,_codeValidator.initialize(_gateway,_self.audioManager),_gateway.initialize(_self.id,_settings),_self._bridge=_gateway.bridge};var _onTimeCap=function(event){_self.trigger(_events.TIME_CAP,event.params)},_onUserInfoChange=function(event){_notifyServices(event)},_onPasswordChange=function(event){_self.trigger(event.type,event),_self.onDisconnect(event)},_onFlashEvent=function(event){return event.type===_events.UNAVAILABLE?void _self.trigger(_events.FLASH_UNAVAILABLE):(_flashBlockCheckTimeoutId&&clearTimeout(_flashBlockCheckTimeoutId),void(_flashBlockCheckTimeoutId=setTimeout(function(){return _gateway.isReady&&_self.audioManager.isInitialized?void _debugger.log("Spotify.Core",["Flash is available"],"corejs"):(_debugger.error("Spotify.Core",["Flash is NOT available"],"corejs"),void _self.trigger(_events.FLASH_UNAVAILABLE))},FLASH_BLOCK_TIMEOUT)))},_onFlashError=function(event){var error,data=event.params.error;throw error=new(window[data.name]||Error)(data.message),error.stack=data.stack,error.logs=data.logs,error},_onNoSoundCapabilities=function(event){_self.trigger(_events.NO_SOUND_CAPABILITIES)},_onStorageFull=function(exception){_self.trigger(_events.STORAGE_FULL)},_onConnected=function(event){if(!_initializedAndConnected){_initializedAndConnected=!0,_self.registerService("appstore",[],["appstore"],Spotify.Services.AppStore),_self.appstore=_self.services.appstore,_self.registerService("mergedProfile",[],["mergedprofile"],Spotify.Services.MergedProfile),_self.mergedProfile=_self.services.mergedProfile,_self.registerService("popcount",[],["popcount"],Spotify.Services.PopCount),_self.popcount=_self.services.popcount,_self.registerService("social",[],["social"],Spotify.Services.Social),_self.social=_self.services.social,_self.registerService("searchHermes",[],["metadata","search"],Spotify.Services.SearchHermes),_self.registerService("suggest",["user"],["suggest"],Spotify.Services.Suggest),_self.suggest=_self.services.suggest,_self.registerService("toplist",["user"],["toplist","socialgraph"],Spotify.Services.Toplist),_self.toplist=_self.services.toplist,_self.registerService("search",["user"],[],Spotify.Services.Search),_self.search=_self.services.search,_self.registerService("playlist",["user","toplist","pubsub"],["playlist4changes","playlist4content","playlist4issues","playlist4meta","playlist4ops","playlist4service"],Spotify.Services.Playlist),_self.playlist=_self.services.playlist,_self.registerService("presence",["pubsub","user"],["presence"],Spotify.Services.Presence),_self.presence=_self.services.presence,_self.registerService("socialGraph",["user","playlist"],["socialgraph"],Spotify.Services.SocialGraph),_self.socialGraph=_self.services.socialGraph,_self.registerService("facebook",["user"],["facebook"],Spotify.Services.Facebook),_self.facebook=_self.services.facebook,_self.registerService("facebookPublish",["user"],["facebook-publish"],Spotify.Services.FacebookPublish),_self.facebookPublish=_self.services.facebookPublish,_self.registerService("metadata",["user"],["metadata"],Spotify.Services.Metadata),_self.metadata=_self.services.metadata,_self.metadata.setLocale(args.locale||"en"),_self.registerService("time",[],[],Spotify.Services.Time),_self.time=_self.services.time,_self.registerService("inbox",["playlist"],[],Spotify.Services.Inbox),_self.registerService("spirc",["pubsub","user"],["spirc"],Spotify.Services.SPIRC),_self.spirc=_self.services.spirc,_gateway.bind(_events.TOKEN_LOST,_self.spirc.onTokenLost,_self);for(var key in _self.services){var problem=!1,dpServices=[];if(_self.services[key]._dependencies){var i=0,len=0,arr=_self.services[key]._dependencies;for(len=arr.length;len>i;i++){var service=_self.services[arr[i]];if("undefined"==typeof service){problem=!0;break}dpServices.push(service)}if(!problem){for(i=0,arr=_servicesSchemasDepedencies[key],len=arr.length;len>i;i+=1){var schema=_servicesSchemasDepedencies[key][i];this.protobufSchemasManager.registerSchema(schema,_protoData[schema])}arr.length>1&&this.protobufSchemasManager.registerSchema(key+"_FULL",arr.reduce(function(acc,schema){return acc.push.apply(acc,_protoData[schema]||[]),acc},[])),_self.services[key]._initialize.call(_self.services[key],dpServices),_schemasRegistered=!0}}}}_notifyServices(event),_self.onConnect(event),_self.trigger(_events.CONNECTION_ESTABLISHED)},_onDisconnected=function(event){_self.onDisconnect(event),_self.trigger(_events.DISCONNECTED)},_onFailedConnecting=function(event){_self.onFailedConnecting(event),_self.trigger(_events.FAILED_CONNECTING)},_maybeTriggerReady=function(){!_self.isReady&&_gateway.isReady&&_self.audioManager.isInitialized&&(_self.isReady=!0,_self.trigger(_events.READY))},_onGatewayReady=function(event){_maybeTriggerReady()},_onAudioManagerReady=function(event){_maybeTriggerReady()},_informForConnectionRetry=function(event){_notifyServices({type:_events.DISCONNECTED,params:{},extra:{}}),_self.trigger(event.type)};this.initialize.call(this)},function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";exports.message=require("./src/message"),exports.request=require("./src/request"),exports.response=require("./src/response"),exports.playerstate=require("./src/player_state")},{"./src/message":5,"./src/player_state":6,"./src/request":7,"./src/response":8}],2:[function(require,module,exports){"use strict";var extend=function(obj,args){for(var source,i=1;i<arguments.length;i++)if(source=arguments[i])for(var prop in source)source.hasOwnProperty(prop)&&(obj[prop]=source[prop]);return obj};module.exports=extend},{}],3:[function(require,module,exports){"use strict";module.exports={inherit:require("./inherit"),extend:require("./extend")}},{"./extend":2,"./inherit":4}],4:[function(require,module,exports){"use strict";var inherit=function(Sub,Super){function Superclass(){}var superProto=Super.prototype;Superclass.prototype=Sub._super=superProto,Superclass.prototype.constructor=Super,Sub.prototype=new Superclass};module.exports=inherit},{}],5:[function(require,module,exports){function Message(uri,opt_headers,opt_body){if(null==uri)throw new TypeError("Invalid `uri` argument for Message.");this._uri=uri,this._headers={},this._body=this._encodeBody(opt_body||""),opt_headers&&this._setHeaders(opt_headers)}exports.Headers,exports.Body,exports.SerializedMessage,exports.Message=Message,Message.fromObject=function(object){return object&&object.uri?new Message(object.uri,object.headers,object.body):null},Message.prototype._encodeBody=function(body){return"string"!=typeof body&&(body=JSON.stringify(body)),body},Message.prototype.getURI=function(){return this._uri},Message.prototype.getMimeType=function(){return this._headers.accept},Message.prototype.getHeader=function(name){return this._headers[name.toLowerCase()]||null},Message.prototype.getHeaders=function(){var _headers=this._headers,headers={};for(var name in _headers)_headers.hasOwnProperty(name)&&(headers[name]=_headers[name]);return headers},Message.prototype._setHeaders=function(headers){var _headers=this._headers;for(var name in headers)headers.hasOwnProperty(name)&&(_headers[name.toLowerCase()]=headers[name]);return this},Message.prototype.getBody=function(){return this._body},Message.prototype.getJSONBody=function(){try{return JSON.parse(this._body)}catch(e){return null}},Message.prototype.copy=function(opt_headers,opt_body){return new Message(this._uri,this._copyHeaders(opt_headers),"undefined"!=typeof opt_body?opt_body:this._body)},Message.prototype._copyHeaders=function(opt_headers){var headers;if(opt_headers){var name,_headers=this._headers;headers={};for(name in _headers)_headers.hasOwnProperty(name)&&(headers[name]=_headers[name]);for(name in opt_headers)opt_headers.hasOwnProperty(name)&&(headers[name.toLowerCase()]=opt_headers[name])}else headers=this._headers;return headers},Message.prototype.serialize=function(){return this.toJSON()},Message.prototype.toJSON=function(){return{uri:this._uri,headers:this._headers,body:this._body}}},{}],6:[function(require,module,exports){function PlayerState(stateData){Serializable.call(this,["action","context","tracks","index","playing","loading","track","position","duration","volume","options","play_origin","next_page_url","prev_page_url"]),stateData=stateData||{},this.action=stateData.action,this.context=stateData.context,this.tracks=stateData.tracks,this.index=stateData.index,this.playing=stateData.playing,this.loading=stateData.loading,this.track=stateData.track,this.position=stateData.position,this.volume=stateData.volume,this.duration=stateData.duration,this.options=new PlayOptions(stateData.options),this.play_origin=new PlayOrigin(stateData.play_origin),this.next_page_url=stateData.next_page_url,this.prev_page_url=stateData.prev_page_url}function PlayOrigin(data){Serializable.call(this,["source","reason","referrer","referrer_version","referrer_vendor"]),data=data||{},this.source=data.source||"unknown",this.reason=data.reason||"unknown",this.referrer=data.referrer||"unknown",this.referrer_version=data.referrer_version||"unknown",this.referrer_vendor=data.referrer_vendor||"unknown"}function PlayOptions(options){Serializable.call(this,["repeat","shuffle","can_repeat","can_shuffle","can_skip_prev","can_skip_next","can_seek","use_dmca_rules"]),options=options||{},this.repeat=void 0!==options.repeat?options.repeat:!1,this.shuffle=void 0!==options.shuffle?options.shuffle:!1,this.can_repeat=void 0!==options.can_repeat?options.can_repeat:!0,this.can_shuffle=void 0!==options.can_shuffle?options.can_shuffle:!0,this.can_skip_prev=void 0!==options.can_skip_prev?options.can_skip_prev:!0,this.can_skip_next=void 0!==options.can_skip_next?options.can_skip_next:!0,
this.can_seek=void 0!==options.can_seek?options.can_seek:!0,this.use_dmca_rules=void 0!==options.use_dmca_rules?options.use_dmca_rules:!1}function Serializable(allowedProps){this._props=allowedProps||[]}var inherit=require("spotify-inheritance").inherit;inherit(PlayerState,Serializable),PlayerState.prototype.serialize=function(){return!this.options||this.options instanceof PlayOptions||(this.options=new PlayOptions(this.options)),!this.play_origin||this.play_origin instanceof PlayOrigin||(this.play_origin=new PlayOrigin(this.play_origin)),this.constructor.prototype.serialize.call(this)},PlayerState.ACTIONS={UNKNOWN:"unknown",PLAY:"play",UPDATE:"update",STOP:"stop",RESUME:"resume",PAUSE:"pause",SKIP_PREV:"skip_prev",SKIP_NEXT:"skip_next"},inherit(PlayOrigin,Serializable),inherit(PlayOptions,Serializable),Serializable.prototype.serialize=function(){for(var prop,data={},i=0,l=this._props.length;l>i;i++)prop=this._props[i],void 0!==this[prop]&&(this[prop]instanceof Serializable?data[prop]=this[prop].serialize():data[prop]=this[prop]);return data},exports.PlayerState=PlayerState},{"spotify-inheritance":3}],7:[function(require,module,exports){function Request(action,uri,opt_headers,opt_body){if(!(this instanceof Request))return new Request(action,uri,opt_headers,opt_body);if(!action)throw new TypeError("Invalid `action` argument for Request.");Message.call(this,uri,opt_headers,opt_body),this._action=action}var inherit=require("spotify-inheritance").inherit,Message=require("./message").Message;exports.Action={DELETE:"DELETE",GET:"GET",HEAD:"HEAD",POST:"POST",PUT:"PUT",SUB:"SUB"},exports.SerializedRequest,inherit(Request,Message),exports.Request=Request,Request.fromObject=function(object){return object&&object.action&&object.uri?new Request(object.action,object.uri,object.headers,object.body):null},Request.prototype.getAction=function(){return this._action},Request.prototype.copy=function(opt_headers,opt_body){return new Request(this._action,this._uri,this._copyHeaders(opt_headers),"undefined"!=typeof opt_body?opt_body:this._body)},Request.prototype.toJSON=function(){return{action:this._action,uri:this._uri,headers:this._headers,body:this._body}}},{"./message":5,"spotify-inheritance":3}],8:[function(require,module,exports){function Response(uri,status,opt_headers,opt_body){if(!(this instanceof Response))return new Response(uri,status,opt_headers,opt_body,opt_requestURI);if("undefined"==typeof status||null==status)throw new TypeError("Invalid `status` argument for Response.");Message.call(this,uri,opt_headers,opt_body),this._status=status}var inherit=require("spotify-inheritance").inherit,Message=require("./message").Message;exports.StatusCode={OK:200,CREATED:201,ACCEPTED:202,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,TIMED_OUT:408,CONFLICT:409,GONE:410,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,ERROR_UNKNOWN:-100,ERROR_ALLOCATION_FAILED:-101,ERROR_INVALID_ENCODING:-102,ERROR_INFINITE_LOOP:-103,ERROR_RESOLVER_NOT_FOUND:-104},exports.SerializedResponse,inherit(Response,Message),exports.Response=Response,Response.fromObject=function(object){return object&&object.uri&&object.status?new Response(object.uri,object.status,object.headers,object.body):null},Response.prototype.getMimeType=function(){return this._headers["content-type"]},Response.prototype.getStatusCode=function(){return this._status},Response.prototype.copy=function(opt_headers,opt_body){return new Response(this._uri,this._status,this._copyHeaders(opt_headers),"undefined"!=typeof opt_body?opt_body:this._body)},Response.prototype.toJSON=function(){return{uri:this._uri,status:this._status,headers:this._headers,body:this._body}}},{"./message":5,"spotify-inheritance":3}],9:[function(require,module,exports){(function(){var Miuri,base_uri,build_query,extend,is_array,is_headless,is_object,parse,parse_str,parts,regex,__hasProp={}.hasOwnProperty;regex=/^(?:([A-Za-z-+\.]+):\/\/)?(?:(\w+)(?::(\w+))?@)?([^:\/]+)?(?::(\d+))?(\/[^?#]*)?(?:\?([^#]*))?(?:#(.+))?/,parts=["protocol","username","password","host","port","path","query","fragment"],is_headless="undefined"==typeof window||null===window,parse=function(uri){var key,matched,name,uri_parts,_i,_len;if(!regex.test(uri))throw"Invalid uri";for(matched=regex.exec(uri).slice(1),uri_parts={},key=_i=0,_len=parts.length;_len>_i;key=++_i)name=parts[key],uri_parts[name]=matched[key];return uri_parts},is_array=function(object){return"[object Array]"===Object.prototype.toString.call(object)},is_object=function(object){return"[object Object]"===Object.prototype.toString.call(object)},extend=function(extended,object){var key,value;for(key in object)__hasProp.call(object,key)&&(value=object[key],extended[key]=value)},parse_str=function(query){var data,key_regex,name,part,tmp,value,_i,_len,_ref,_ref1;for(key_regex=/\[([^\]]*)\]/,data={},_ref=query.split("&"),_i=0,_len=_ref.length;_len>_i;_i++)part=_ref[_i],_ref1=part.split("="),name=_ref1[0],value=_ref1[1],tmp=key_regex.exec(name),value=decodeURIComponent(value),tmp?(tmp[1]&&!is_object(data[name])?data[name]={}:is_array(data[name])||(data[name]=[]),tmp[1]?data[name][tmp[1]]=value:data[name].push(value)):data[name]=value;return data},build_query=function(name,value,parts){var item,key,_i,_len;if(null==parts&&(parts=[]),!is_array(value)&&!is_object(value))return""+name+"="+encodeURIComponent(value);if(is_array(value))for(_i=0,_len=value.length;_len>_i;_i++)item=value[_i],parts.push(""+name+"[]="+encodeURIComponent(item));if(is_object(value))for(key in value)__hasProp.call(value,key)&&(item=value[key],parts.push(""+name+"["+key+"]="+encodeURIComponent(item)));return parts.join("&")},base_uri="/","undefined"!=typeof window&&null!==window&&window.location.host&&(base_uri=window.location.href),Miuri=function(){function Miuri(uri){this.uri=null!=uri?uri:base_uri,this.parts=parse(this.uri),this.parts.query=this.parts.query?parse_str(this.parts.query):{},this.parts.path||(this.parts.path="/")}return Miuri.prototype.retrieve=function(name,value){return null==value&&(value=null),null===value?this.parts[name]:(this.parts[name]=value,this)},Miuri.prototype.protocol=function(protocol){return this.retrieve("protocol",protocol)},Miuri.prototype.username=function(username){return this.retrieve("username",username)},Miuri.prototype.password=function(password){return this.retrieve("password",password)},Miuri.prototype.host=function(host){return this.retrieve("host",host)},Miuri.prototype.hostname=function(host){return this.host(host)},Miuri.prototype.port=function(port){return this.retrieve("port",port)},Miuri.prototype.path=function(path){return path&&"/"!==path[0]&&(path="/"+path),this.retrieve("path",path)},Miuri.prototype.query=function(prop,value){return prop&&"string"==typeof prop?value?(this.parts.query[prop]=value,this):this.parts.query[prop]:is_object(prop)?(extend(this.parts.query,prop),this):this.parts.query},Miuri.prototype.fragment=function(fragment){return this.retrieve("fragment",fragment)},Miuri.prototype.pathinfo=function(){var basename,dirname,extension,filename,path;return path=this.path(),basename=path.split("/").pop(),dirname=path.replace(new RegExp("/?"+basename),""),extension=/\./.test(basename)?basename.split(".").pop():"",filename=basename.replace(new RegExp("\\."+extension+"$"),""),""===dirname&&(dirname="/"),{path:path,basename:basename,dirname:dirname,extension:extension,filename:filename}},Miuri.prototype.toString=function(){var key,query_parts,uri,value,_ref;uri="",this.parts.protocol&&this.parts.host&&(uri+=""+this.parts.protocol+"://",this.parts.username&&this.parts.password?uri+=""+this.parts.username+":"+this.parts.password+"@":this.parts.username&&(uri+=""+this.parts.username+"@"),uri+=this.parts.host,this.parts.port&&(uri+=":"+this.parts.port)),uri+=this.parts.path,query_parts=[],_ref=this.parts.query;for(key in _ref)__hasProp.call(_ref,key)&&(value=_ref[key],query_parts.push(build_query(key,value)));return query_parts.length>0&&(uri+="?"+query_parts.join("&")),this.parts.fragment&&(uri+="#"+this.parts.fragment),uri},Miuri}(),is_headless?module.exports=Miuri:this.miuri=Miuri}).call(this)},{}],10:[function(require,module,exports){!function(){"use strict";function executeDeferreds(){var fns=deferred.splice(0);if(fns.length)for(var i=0,l=fns.length;l>i;i++)try{fns[i]()}finally{}}var hasWindow="undefined"!=typeof window,hasDefineProperty="function"==typeof Object.defineProperty;if(hasWindow&&window.__modDefFn)return void(module.exports=window.__modDefFn);var send,origin,deferred=[];if(hasWindow&&window.postMessage){if(origin=window.location.origin||window.location.protocol+"//"+window.location.hostname,send=window.postMessage.bind(window,"@execute_deferreds",origin),!window.__hasDeferredHandler){hasDefineProperty?Object.defineProperty(window,"__hasDeferredHandler",{value:1}):window.__hasDeferredHandler=1;var handler=function(e){e.origin!=origin&&"@execute_deferreds"!=e.data||executeDeferreds()};window.addEventListener?window.addEventListener("message",handler):window.attachEvent("onmessage",handler)}}else send="undefined"!=typeof setImmediate?setImmediate.bind(null,executeDeferreds):setTimeout.bind(null,executeDeferreds,10);var defer=function(fn){var trigger=!deferred.length;deferred.push(fn),trigger&&send()};hasWindow&&!window.__modDefFn&&(hasDefineProperty?Object.defineProperty(window,"__modDefFn",{value:defer}):window.__modDefFn=defer),module.exports=defer}()},{}],11:[function(require,module,exports){"use strict";function handleImmediateMessage(data){var handler=handlers[data.type];handler&&handler.fn.call(this,data)}function handlePostMessage(event){var data=event.data;if("string"==typeof data)try{data=JSON.parse(data)}catch(e){return}var handler=handlers[data.type];!handler||"*"!=handler.origin&&event.origin!==handler.origin||handler.fn.call(this,data,event)}var setImmediate=setImmediate?setImmediate:setTimeout,CURRENT_WINDOW_ORIGIN=void 0;"undefined"!=typeof window&&(CURRENT_WINDOW_ORIGIN=window.location.origin||window.location.protocol+"//"+window.location.hostname);var handlers={},isListening=!1,startListening=function(){window.attachEvent&&!window.addEventListener?window.attachEvent("onmessage",handlePostMessage):window.addEventListener("message",handlePostMessage,!1)},addMessageHandler=function(type,fn,origin){if("undefined"==typeof window||isListening||(startListening(),isListening=!0),origin||(origin=CURRENT_WINDOW_ORIGIN),handlers[type])throw new Error('Rehandling of message "'+type+'" not allowed.');handlers[type]={fn:fn,origin:origin}},removeMessageHandler=function(type,fn){return!handlers[type]||fn&&handlers[type].fn!==fn?!1:(handlers[type]=null,!0)},sendMessage=function(type,data,destWindow,origin){return data=data||{},data.type=type,"undefined"==typeof window?setImmediate(handleImmediateMessage.bind(null,data)):(destWindow=destWindow||window,origin||(origin=CURRENT_WINDOW_ORIGIN),void destWindow.postMessage(JSON.stringify(data),origin))};module.exports={addMessageHandler:addMessageHandler,removeMessageHandler:removeMessageHandler,sendMessage:sendMessage,WINDOW_ORIGIN:CURRENT_WINDOW_ORIGIN}},{}],12:[function(require,module,exports){function HermesRouter(hermesProvider,hermesUtils,pubsubProvider){if(!(this instanceof HermesRouter))return new HermesRouter(hermesProvider,hermesUtils,pubsubProvider);if(!hermesProvider||"function"!=typeof hermesProvider.send)throw new TypeError("Invalid hermesProvider argument");if(!hermesUtils||!hermesUtils.Base64||!hermesUtils.HermesHeader)throw new TypeError("Missing hermes utils");if(!pubsubProvider||"function"!=typeof pubsubProvider.subscribe)throw new TypeError("Invalid pubsubProvider argument");this._subscribers=new Subscribers,this._pending=new List,this._open=new List,this._pubsubProvider=pubsubProvider,this._hermesProvider=hermesProvider,this._hermesUtils=hermesUtils}function List(){this._items=[]}function Subscribers(){this._subscribers={},this._token=0}var defer=require("spotify-deferred");exports.HermesRouter=HermesRouter,HermesRouter.prototype.send=function(uri,action,ass,rds,body,onSuccess,onError){this._hermesProvider.send(uri,action,ass,rds,body,onSuccess,onError)},HermesRouter.prototype.subscribe=function(uri,onSubscribe,onError,onMessage){var token=this._subscribers.add(uri,{onSubscribe:onSubscribe,onMessage:onMessage,onError:onError});return this._isOpen(uri)||this._isPending(uri)?this._isOpen(uri)&&defer(onSubscribe):this._openSubscription(uri),token},HermesRouter.prototype.unsubscribe=function(uri,token){this._subscribers.remove(uri,token),this._isOpen(uri)&&!this._subscribers.getAsList(uri)&&this._closeSubscription(uri)},HermesRouter.prototype._isPending=function(uri){return this._pending.contains(uri)},HermesRouter.prototype._isOpen=function(uri){return this._open.contains(uri)},HermesRouter.prototype._openSubscription=function(uri){this._pending.add(uri),this._pubsubProvider.subscribe(uri,[],[],[],function(responses){return this._pending.remove(uri),this._open.add(uri),this._subscribers.getAsList(uri)?void defer(function(){for(var subscribers=this._subscribers.getAsList(uri)||[],i=0,l=subscribers.length;l>i;i++)subscribers[i].onSubscribe()}.bind(this)):void this._closeSubscription(uri)},function(error){this._pending.remove(uri),defer(function(){for(var subscribers=this._subscribers.getAsList(uri)||[],i=0,l=subscribers.length;l>i;i++)subscribers[i].onError(error)}.bind(this))},function(unparsedFrames,parsedFrames){for(var Base64=this._hermesUtils.Base64,HermesHeader=this._hermesUtils.HermesHeader,header=HermesHeader.parseFromStringSync(Base64.decode(unparsedFrames[2])),body=[],z=3,zlen=unparsedFrames.length;zlen>z;z+=1)body.push(Base64.decode(unparsedFrames[z]));body=Array.isArray(body)&&1==body.length?body[0]:body,defer(function(){for(var subscribers=this._subscribers.getAsList(uri)||[],i=0,l=subscribers.length;l>i;i++)subscribers[i].onMessage(body,header.status_code,header)}.bind(this))},this)},HermesRouter.prototype._closeSubscription=function(uri){var self=this;this._hermesProvider.send(uri,"UNSUB",[],[],[],function(body,status,headers){self._open.remove(uri),self._subscribers.getAsList(uri)&&self._openSubscription(uri)},function(){})},List.prototype.add=function(element){return this._items.push(element),this.length()},List.prototype.remove=function(element){return this._items.splice(this._items.indexOf(element),1),this.length()},List.prototype.length=function(){return this._items.length},List.prototype.contains=function(element){return this._items.indexOf(element)>-1},Subscribers.prototype.add=function(uri,subscriber){return this._subscribers[uri]||(this._subscribers[uri]={}),this._token++,this._subscribers[uri][this._token]=subscriber,this._token},Subscribers.prototype.remove=function(uri,token){var subscribers=this._subscribers[uri];subscribers&&subscribers[token]&&(subscribers[token]=null,delete subscribers[token])},Subscribers.prototype.getAsList=function(uri){var subscribers=this._subscribers[uri],subscribersList=[];if(subscribers)for(var keys=Object.keys(subscribers),i=0,l=keys.length;l>i;i++)subscribersList.push(subscribers[keys[i]]);return subscribersList.length?subscribersList:null}},{"spotify-deferred":10}],13:[function(require,module,exports){function PlayerAdapter(shellContextPlayer,dispatcher,trackListResolver,ItemList){if(!(shellContextPlayer&&dispatcher&&trackListResolver&&ItemList))throw new TypeError("Missing arguments for PlayerAdapter");this._player=shellContextPlayer,this._dispatcher=dispatcher,this._trackListResolver=trackListResolver,this._ItemList=ItemList,this._currentState=null,this._requestSender=this._requestSenderWrapper(this._dispatcher.createRequestSender("GET","/tracks")),this._parseState=this._parseState.bind(this),this._onStateChange=this._onStateChange.bind(this),this._playerEvents={beforePlay:this._onStateChange,play:this._onStateChange,pause:this._onStateChange,stop:this._onStateChange,clear:this._onStateChange,trackLoaded:this._onStateChange,contextChange:this._onStateChange,contextEnd:this._onStateChange,shuffleChanged:this._onStateChange,repeatedChange:this._onStateChange,positionChanged:this._onStateChange,volumeChange:this._onStateChange,update:this._onStateChange},this._token=0,this._subCallbacks={},this._player.addEvents(this._playerEvents)}var Promise=require("spotify-promise"),Request=require("../cosmos").Request;PlayerAdapter.prototype._requestSender=function(){},PlayerAdapter.prototype._requestSenderWrapper=function(requestSender){return function(uris){return requestSender({flush:!0},{uris:uris}).then(function(response){return response.body.result})}},PlayerAdapter.prototype.getState=function(callback){this._promiseToCallback(this._player.getPlayerState().then(this._parseState),callback)},PlayerAdapter.prototype._parseState=function(state){var playbackState=state.playbackState,contextState=state.contextState,trackState=state.trackState,currentOriginInfo=this._currentState&&this._currentState.play_origin||{},parsed={},origin={},options={};origin.source=currentOriginInfo.source,origin.reason=currentOriginInfo.reason,origin.referrer=currentOriginInfo.referrer,origin.referrer_version=currentOriginInfo.referrer_version,origin.referrer_vendor=currentOriginInfo.referrer_vendor,options.repeat="context"==playbackState.repeatMode,options.shuffle=contextState.shuffled;var rules=contextState.ruleset||{};return options.can_repeat=rules.repeat,options.can_shuffle=rules.shuffle,options.can_skip_prev=rules.previous,options.can_skip_next=rules.next,options.can_seek=rules.seek,contextState.baseDescriptor&&(parsed.context=contextState.baseDescriptor.uri,parsed.index=contextState.listIndex),trackState.track&&(parsed.track=trackState.track.uri,parsed.duration=trackState.duration,parsed.position=trackState.position,trackState.track.advertisement&&(origin.source="pendad",origin.reason="ad")),parsed.playing=playbackState.playing,parsed.loading=playbackState.loading,parsed.volume=playbackState.volume,Object.keys(options).length&&(parsed.options=options),Object.keys(origin).length&&(parsed.play_origin=origin),parsed},PlayerAdapter.prototype._createTrackList=function(playerState,router){var promise=new Promise,tracks=playerState.tracks?playerState.tracks.slice(0):[],nextPageUrl=playerState.next_page_url;if(nextPageUrl){if(/spotify:user:[^:]+:(starred|(playlist:[^:]+))$/.test(nextPageUrl))return this._trackListResolver.resolve({type:"list",uri:nextPageUrl});router.resolve(new Request("GET",nextPageUrl)).consume(function(response){var body=response.getJSONBody();body&&body.tracks&&tracks.push.apply(tracks,body.tracks.map(function(trackRow){return trackRow.track})),promise.fulfill(tracks)})}else promise.fulfill(tracks);return promise.then(function(tracks){var base=new this._ItemList.Array(tracks),trackList=new this._ItemList.MetadataDecorator(base,this._requestSender);return trackList.setDescriptor(new this._ItemList.Descriptor.List(playerState.context)),new this._ItemList.Filtered(trackList,function(track){return track&&!!track.playable}).preload()}.bind(this))},PlayerAdapter.prototype._findPlayableIndex=function(list,start,length){var self=this;if(!length){var promise=new Promise;return promise.fulfill(0),promise}var OUT_OF_BOUNDS=this._ItemList.OUT_OF_BOUNDS;return list.translateIndexFromBase(start).then(function(index){return index==OUT_OF_BOUNDS?self._findPlayableIndex(list,start+1,length):index})},PlayerAdapter.prototype._preparePlayerOptions=function(playerState,list){var self=this,index=playerState.index&&-1!=playerState.index?playerState.index:0;return list.getLength().then(function(length){return self._findPlayableIndex(list,index,length)}).then(function(index){var options=playerState.options,origin=playerState.play_origin;this._currentState=playerState;var playerOptions={index:index,initialOffset:playerState.position,owner:origin.referrer,reason:origin.reason,rules:{skipCount:-1,volume:!0,seek:options.can_seek,indexing:!0,previous:options.can_skip_prev,next:options.can_skip_next,shuffle:options.can_shuffle,repeat:options.can_repeat}};return playerOptions}.bind(this))},PlayerAdapter.prototype.play=function(playerState,router,callback){var promise=this._createTrackList(playerState,router).then(function(trackList){return this._preparePlayerOptions(playerState,trackList).then(function(options){var context=new this._ItemList.Context(trackList,options.owner);return this._player.play(context,options)}.bind(this))}.bind(this));this._promiseToCallback(promise,callback)},PlayerAdapter.prototype.update=function(playerState,router,callback){var promise=this._createTrackList(playerState,router).then(function(trackList){return this._preparePlayerOptions(playerState,trackList).then(function(options){var context=new this._ItemList.Context(trackList,options.owner);return this._player.setContextList(context,options)}.bind(this))}.bind(this));this._promiseToCallback(promise,callback)},PlayerAdapter.prototype.stop=function(playerState,callback){this._player.clear(),callback(null)},PlayerAdapter.prototype.resume=function(playerState,callback){this._promiseToCallback(this._player.resume(),callback)},PlayerAdapter.prototype.pause=function(playerState,callback){this._promiseToCallback(this._player.pause(),callback)},PlayerAdapter.prototype.next=function(playerState,callback){this._promiseToCallback(this._player.next(playerState.play_origin.reason),callback)},PlayerAdapter.prototype.previous=function(playerState,callback){this._promiseToCallback(this._player.previous(playerState.play_origin.reason),callback)},PlayerAdapter.prototype.subscribe=function(callback){var token=this._token++;return this._subCallbacks[token]=callback,token},PlayerAdapter.prototype.unsubscribe=function(token){this._subCallbacks[token]&&(this._subCallbacks[token]=null,delete this._subCallbacks[token])},PlayerAdapter.prototype._onStateChange=function(evt){var subTokens=Object.keys(this._subCallbacks);subTokens.length&&this.getState(function(error,response){for(var i=0,l=subTokens.length;l>i;i++)this._subCallbacks[subTokens[i]](error,response)}.bind(this))},PlayerAdapter.prototype._promiseToCallback=function(promise,callback){promise.then(function(response){callback(null,response)},callback)},exports.PlayerAdapter=PlayerAdapter},{"../cosmos":17,"spotify-promise":133}],14:[function(require,module,exports){function Bridge(appManager,routerFactory){if(!(this instanceof Bridge))return new Bridge;if("function"!=typeof routerFactory)throw new TypeError("Parameter `routerFactory` needs to be a function");this._router=postrouter,this._appManager=appManager,this._routerFactory=routerFactory,this._requestHandlers=new WeakMap,this._handleMessage=this._handleMessage.bind(this),this.attach()}var cosmosCommon=require("cosmos-common-js"),postrouter=require("spotify-postrouter"),request=cosmosCommon.request,Request=request.Request,response=cosmosCommon.response,Response=response.Response,StatusCode=response.StatusCode,RequestHandler=require("./requesthandler").RequestHandler,WeakMap=require("spotify-weakmap");exports.Bridge=Bridge,Bridge.prototype.attach=function(){this._router.addMessageHandler("cosmos-request",this._handleMessage)},Bridge.prototype.detach=function(){this._router.removeMessageHandler("cosmos-request",this._handleMessage)},Bridge.prototype.registerApp=function(app,requestHandler){if(this._requestHandlers.get(app))throw new Error("Router for "+id+" already exists");return this._requestHandlers.set(app,requestHandler),requestHandler},Bridge.prototype.unregisterApp=function(app){var requestHandler=this._requestHandlers.get(app);return requestHandler?(requestHandler.closeAll(),this._requestHandlers.remove(app),!0):void 0},Bridge.prototype._handleMessage=function(data,message){var self=this,payload=data.payload,responder=this._createResponder(data.id,data.resolver,data.name,message.source),app=this._appManager.getFromWindow(message.source);if(!app)return void this._appManager.once("windowAssociated",function(e){e.window==message.source&&self._handleMessage(data,message)});var requestHandler=this._requestHandlers.get(app);if(!requestHandler){var router=this._routerFactory(app);if(!(requestHandler=this.registerApp(app,new RequestHandler(router))))return;var unregister=this.unregisterApp.bind(this,app);app.addEvent("destroy",unregister);try{message.source.addEventListener("unload",unregister)}catch(e){}}switch(data.name){case"cosmos_request_create":try{var request=Request.fromObject(payload);requestHandler.openRequest(data.id,request,responder)}catch(e){return void responder(new Response(e.message,StatusCode.BAD_REQUEST))}break;case"cosmos_request_cancel":try{requestHandler.closeRequest(data.id,responder)}catch(e){return void responder(new Response(e.message,StatusCode.BAD_REQUEST))}break;default:responder(new Response("Request type not implemented",StatusCode.NOT_FOUND))}},Bridge.prototype._createResponder=function(id,resolver,name,window){return function(data){data=data||{},window.postMessage(JSON.stringify({type:"cosmos-response",id:id,resolver:resolver,name:name,payload:data.serialize?data.serialize():data}),"*")}}},{"./requesthandler":21,"cosmos-common-js":1,"spotify-postrouter":11,"spotify-weakmap":134}],15:[function(require,module,exports){!function(global){function routerFactory(providers,app){var router=new Cosmos.Router;router.registerResolver(new Cosmos.ProtobufResolver),router.registerResolver(new Cosmos.EchoService),router.registerResolver(new Cosmos.HTTPService(providers.XMLHttpRequest)),router.registerResolver(new Cosmos.HermesService(providers.hermes)),router.registerResolver(new Cosmos.PlayerService.V1(providers.player)),router.registerResolver(new Cosmos.PlayerService.V2(providers.players)),router.registerResolver(new Cosmos.TrackResolverService(providers.trackListResolver)),router.registerResolver(new Cosmos.MessageResolver(app.getId(),providers.messageRouter));for(var generators=resolverGenerators.slice(0),i=0,l=generators.length;l>i;i++){var generator=generators[i];if(generator){var resolver=generator(app,providers);resolver&&router.registerResolver(resolver)}}return router}if(global.Spotify=global.Spotify||{},!Spotify.Utils||!Spotify.Utils.Base64)throw new TypeError("Missing Spotify.Utils.Base64 object");if(!Spotify.Hermes||!Spotify.Hermes.Header)throw new TypeError("Missing Spotify.Hermes.Header object");var Cosmos=require("./cosmos"),PlayerAdapter=require("./adapters/shell_player").PlayerAdapter,MessageRouter=require("./messagerouter").MessageRouter,HermesRouter=Cosmos.HermesRouter,hermesUtils={Base64:Spotify.Utils.Base64,HermesHeader:Spotify.Hermes.Header},resolverGenerators=[];Cosmos.registerResolverGenerator=function(generator){-1==resolverGenerators.indexOf(generator)&&resolverGenerators.push(generator)},Cosmos.unregisterResolverGenerator=function(generator){var index=resolverGenerators.indexOf(generator);-1!=index&&resolverGenerators.splice(index,1)},Cosmos.init=function(core,initContext){if(!(core&&initContext.applicationManager&&initContext.contextPlayer&&initContext.dispatcher&&initContext.ItemList))throw new TypeError("Invalid arguments for Cosmos");if(!global.__noCosmosBridge){var player=new PlayerAdapter(initContext.contextPlayer,initContext.dispatcher,initContext.trackListResolver,initContext.ItemList),providers={players:{main:initContext.contextPlayer},hermes:new HermesRouter(core.hermes,hermesUtils,core.pubsub),player:player,trackListResolver:initContext.trackListResolver,XMLHttpRequest:XMLHttpRequest,messageRouter:new MessageRouter},routerFactoryBound=routerFactory.bind(this,providers);new Cosmos.Bridge(initContext.applicationManager,routerFactoryBound)}},Spotify.Cosmos=Cosmos,exports.Cosmos=Cosmos}(window)},{"./adapters/shell_player":13,"./cosmos":17,"./messagerouter":18}],16:[function(require,module,exports){function Channel(opt_initialValue){return this instanceof Channel?(this._queue=[],this._open=Channel.Status.KEEP_OPEN,this._sink=new Sink(this),this._source=new Source(this),this._consumeCallback=null,this._closeCallbacks=[],void(opt_initialValue&&this._sink.push(opt_initialValue))):new Channel(opt_initialValue)}function Sink(channel){return this instanceof Sink?void(this._channel=channel):new Sink(channel)}function Source(channel){return this instanceof Source?void(this._channel=channel):new Source(channel)}exports.Channel=Channel,Channel.Sink=Sink,Channel.Source=Source,Channel.Status={CLOSE:"CLOSE",KEEP_OPEN:"KEEP_OPEN"},Channel.prototype.getSink=function(){return this._sink},Channel.prototype.getSource=function(){return this._source},Channel.prototype._onMessagePushed=function(message){return this._open===Channel.Status.KEEP_OPEN&&this._queue.push(message),this._invokeConsumeCallback(),this._open},Channel.prototype._onConsumeRequest=function(callback){this._consumeCallback=callback,this._open===Channel.Status.KEEP_OPEN&&this._invokeConsumeCallback()},Channel.prototype._onClose=function(){this._queue=[],this._open=Channel.Status.CLOSE,this._invokeCloseCallbacks()},Channel.prototype._invokeConsumeCallback=function(){if(this._consumeCallback&&"function"==typeof this._consumeCallback)for(var message;message=this._queue.shift();)this._consumeCallback.call(this,message)===Channel.Status.CLOSE&&this._source.close()},Channel.prototype._invokeCloseCallbacks=function(){for(var cb;cb=this._closeCallbacks.shift();)cb.call(this)},Channel.prototype._addCloseCallback=function(callback){callback&&"function"==typeof callback&&(this._closeCallbacks.push(callback),this._open===Channel.Status.CLOSE&&this._invokeCloseCallbacks())},Sink.prototype.push=function(message){return this._channel?this._channel._onMessagePushed(message):void 0},Sink.prototype.addCloseCallback=function(callback){this._channel&&this._channel._addCloseCallback(callback)},Source.prototype.consume=function(callback){this._channel&&this._channel._onConsumeRequest(callback)},Source.prototype.forward=function(sink){this.consume(function(message){return sink.push(message),!0})},Source.prototype.close=function(){this._channel&&this._channel._onClose()},Source.prototype.addCloseCallback=function(callback){this._channel&&this._channel._addCloseCallback(callback)}},{}],17:[function(require,module,exports){var cosmosCommon=require("cosmos-common-js"),bridge=require("./bridge"),message=cosmosCommon.message,pattern=require("./pattern"),request=cosmosCommon.request,requestFilter=require("./requestfilter"),response=cosmosCommon.response,resolver=require("./resolver"),router=require("./router"),channel=require("./channel"),requestHandler=require("./requesthandler"),messageRouter=require("./messagerouter"),echoService=require("./services/echo"),hermesService=require("./services/hermes"),httpService=require("./services/http"),protobufResolver=require("./services/protobuf"),playerService=require("./services/player"),trackResolverService=require("./services/trackresolver"),messageResolver=require("./services/messages"),hermesRouter=require("./adapters/core_hermes");exports.Bridge=bridge.Bridge,exports.Message=message.Message,exports.Action=request.Action,exports.Pattern=pattern.Pattern,exports.Response=response.Response,exports.Request=request.Request,exports.RequestFilter=requestFilter.RequestFilter,exports.RequestFilterPriority=requestFilter.RequestFilterPriority,exports.Router=router.Router,exports.Resolver=resolver.Resolver,exports.StatusCode=response.StatusCode,exports.Channel=channel.Channel,exports.RequestHandler=requestHandler.RequestHandler,exports.MessageRouter=messageRouter.MessageRouter,exports.HermesRouter=hermesRouter.HermesRouter,exports.EchoService=echoService.EchoService,exports.HermesService=hermesService.HermesService,exports.HTTPService=httpService.HTTPService,exports.ProtobufResolver=protobufResolver.ProtobufResolver,exports.PlayerService=playerService,exports.TrackResolverService=trackResolverService.TrackResolverService,exports.MessageResolver=messageResolver.MessageResolver},{"./adapters/core_hermes":12,"./bridge":14,"./channel":16,"./messagerouter":18,"./pattern":19,"./requestfilter":20,"./requesthandler":21,"./resolver":22,
"./router":23,"./services/echo":24,"./services/hermes":25,"./services/http":26,"./services/messages":27,"./services/player":28,"./services/protobuf":31,"./services/trackresolver":32,"cosmos-common-js":1}],18:[function(require,module,exports){function MessageRouter(){return this instanceof MessageRouter?(this._token=0,void(this._listeners={})):new MessageRouter}var Pattern=require("./pattern").Pattern;exports.MessageRouter=MessageRouter,MessageRouter.prototype.sendMessage=function(topic,realms,message){var listener,tokens=Object.keys(this._listeners);realms=realms||[];for(var i=0,l=tokens.length;l>i;i++)listener=this._listeners[tokens[i]],listener.topicPredicate(topic)&&this._realmsIntersect(listener.realms,realms)&&listener.callback(message)},MessageRouter.prototype.subscribe=function(topic,realms,callback){if(topic&&"function"==typeof callback){realms=realms||[];var topicPredicate=Pattern.createPredicate(topic),token=this._token++;return this._listeners[token]={topicPredicate:topicPredicate,realms:realms,callback:callback},token}},MessageRouter.prototype.unsubscribe=function(token){this._listeners[token]&&(this._listeners[token]=null,delete this._listeners[token])},MessageRouter.prototype._realmsIntersect=function(realm1,realm2){return!realm1.length||!realm2.length||realm1.filter(function(el){return realm2.indexOf(el)>-1}).length}},{"./pattern":19}],19:[function(require,module,exports){"use strict";exports.Predicate;var Pattern={},escapeRegExp=function(){var from=/(?=[\-\[\]{}()*+?.\\\^$|,#\s])/g,to="\\";return function(string){return string.replace(from,to)}}(),escapeChars={"*":"__STAR_ESCAPE__","?":"__QMARK_ESCAPE__","\\":"__ESCAPE_ESCAPE__"},escapeExp=/\\([^]?)/g,unescapeChars={__STAR_ESCAPE__:"*",__QMARK_ESCAPE__:"?",__ESCAPE_ESCAPE__:"\\"},unescapeExp=function(){var result=["__SEPARATOR_ESCAPE__"];for(var name in unescapeChars)result.push(name);return new RegExp("("+result.join("|")+")","g")}();Pattern.parse=function(pattern,opt_separator){opt_separator=opt_separator||"/";var escapedSeparator=escapeRegExp(opt_separator),allChars="[^]*",anyChars="[^"+opt_separator+"]*",anyChar="[^"+opt_separator+"]{1}";return pattern=pattern.replace(escapeExp,function(_,match){if(match==opt_separator)return"__SEPARATOR_ESCAPE__";var escapeChar=escapeChars[match];return escapeChar||match}),pattern=pattern.replace(/\*\*/g,"__ALL_CHARS_ESCAPE__").replace(/\*/g,"__ANY_CHARS_ESCAPE__").replace(/\?/g,"__ANY_CHAR_ESCAPE__"),pattern=pattern.replace(unescapeExp,function(_,match){if("__SEPARATOR_ESCAPE__"==match)return escapedSeparator;var unescapeChar=unescapeChars[match];return unescapeChar||match}),pattern=escapeRegExp(pattern),pattern=pattern.replace(/__ALL_CHARS_ESCAPE__/g,allChars).replace(/__ANY_CHARS_ESCAPE__/g,anyChars).replace(/__ANY_CHAR_ESCAPE__/g,anyChar),new RegExp("^"+pattern+"$")},Pattern.createPredicate=function(pattern,separator){var expression=Pattern.parse(pattern,separator);return function(str){return expression.test(str)}},exports.Pattern=Pattern},{}],20:[function(require,module,exports){function RequestFilter(options,opt_priority){options=options||{},this._actionPredicate="action"in options?Pattern.createPredicate(options.action):null,this._typePredicate="type"in options?Pattern.createPredicate(options.type):null,this._uriPredicate="uri"in options?Pattern.createPredicate(options.uri,options.uriSeparator):null,this._priority=Math.min(RequestFilterPriority.HIGHEST,Math.max(RequestFilterPriority.LOWEST,opt_priority||RequestFilterPriority.DEFAULT))}var Pattern=require("./pattern").Pattern;exports.RequestFilterOptions;var RequestFilterPriority={LOWEST:-1e3,LOW:-500,DEFAULT:0,HIGH:500,HIGHEST:1e3};exports.RequestFilterPriority=RequestFilterPriority,RequestFilter.prototype.getPriority=function(){return this._priority},RequestFilter.prototype.match=function(request){return this._actionPredicate&&!this._actionPredicate(request.getAction())?!1:this._typePredicate&&!this._typePredicate(request.getMimeType())?!1:!this._uriPredicate||this._uriPredicate(request.getURI())},exports.RequestFilter=RequestFilter},{"./pattern":19}],21:[function(require,module,exports){function RequestHandler(router){if(!(this instanceof RequestHandler))return new RequestHandler(router);if(!router)throw new TypeError("Missing `router` param");this._router=router,this._requests={}}exports.RequestHandler=RequestHandler,RequestHandler.prototype.openRequest=function(id,request,callback){if(!this._isValidId(id)||!request)throw new TypeError("Missing params for `openRequest`");if(this._requests[id])throw new Error("Request ID already in use");var source=this._router.resolve(request);if(!source)throw new Error("Could not open the request");return this._requests[id]=source,source.consume(callback),this},RequestHandler.prototype.closeRequest=function(id,callback){if(!this._isValidId(id))throw new TypeError("Missing id for `closeRequest`");var source=this._requests[id];if(!source)throw new Error("Request does not exist");return source.addCloseCallback(callback),source.close(),this._requests[id]=null,delete this._requests[id],this},RequestHandler.prototype._isValidId=function(id){return id&&"string"==typeof id||"number"==typeof id},RequestHandler.prototype.closeAll=function(){for(var ids=Object.keys(this._requests),i=0,l=ids.length;l>i;i++)this.closeRequest(ids[i])}},{}],22:[function(require,module,exports){function Resolver(opt_filter){this._filter=opt_filter||new RequestFilter({action:""})}var Channel=require("./channel").Channel,RequestFilter=require("./requestfilter").RequestFilter;exports.Filter,exports.Resolver=Resolver,Resolver.prototype._createChannel=function(){return new Channel},Resolver.prototype.resolve=function(request){var channel=this._createChannel();return channel.getSource()},Resolver.prototype.getRequestFilter=function(){return this._filter}},{"./channel":16,"./requestfilter":20}],23:[function(require,module,exports){function RouterProxy(resolver,level,opt_visited){return this instanceof RouterProxy?(this._resolver=resolver,this._level=level,this._visited=null,void this._createVisited(opt_visited)):new RouterProxy(resolver,level,opt_visited)}function Router(){return this instanceof Router?(Resolver.call(this),this._token=0,this._handlers={},void(this._handlersArray=[])):Router}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,Resolver=require("./resolver").Resolver,request=cosmosCommon.request,response=(request.Request,cosmosCommon.response),Response=response.Response,StatusCode=response.StatusCode;require("./channel").Channel;exports.Token,exports.Handler,exports.ResolversVisited,RouterProxy.prototype._createVisited=function(opt_visited){function F(){}opt_visited?(F.prototype=opt_visited,this._visited=new F):this._visited={}},RouterProxy.prototype.getLevel=function(){return this._level},RouterProxy.prototype.getVisited=function(){return this._visited},RouterProxy.prototype.resolve=function(request){return this._resolver.resolve(request,new RouterProxy(this._resolver,this._level+1),new RouterProxy(this._resolver,this._level+1,this._visited))},inherit(Router,Resolver),exports.Router=Router,Router.prototype.registerResolver=function(resolver,opt_filter){if(!resolver||"function"!=typeof resolver.resolve||"function"!=typeof resolver.getRequestFilter)throw new TypeError("Invalid arguments for registerResolver.");var filter=opt_filter&&"function"==typeof opt_filter.match?opt_filter:resolver.getRequestFilter(),token=this._token++,handler={filter:filter,priority:filter.getPriority(),resolver:resolver,token:token};return this._handlers[token]=handler,this._insertIntoHandlersArray(handler),token},Router.prototype._insertIntoHandlersArray=function(handler){for(var handlersArray=this._handlersArray,priority=handler.priority,i=0,l=handlersArray.length;l>i;i++)if(priority>handlersArray[i].priority)return void handlersArray.splice(i,0,handler);handlersArray.push(handler)},Router.prototype.unregisterResolver=function(token){if("number"!=typeof token)throw new TypeError("Invalid arguments for unregisterResolver.");var handlers=this._handlers,handlersArray=this._handlersArray,handler=handlers[token];if(!handler)return!1;handlers[token]=null;var index=handlersArray.indexOf(handler);return-1!=index&&handlersArray.splice(index,1),!0},Router.prototype._findMatchingResolver=function(request,visited){for(var handlers=this._handlersArray,i=0,l=handlers.length;l>i;i++){var handler=handlers[i];if(!(handler.token in visited)&&(visited[handler.token]=!0,handler.filter.match(request)))return handler}return null},Router.prototype._resolveUnmatchedRequest=function(request){var channel=this._createChannel(),response=new Response(request.getURI(),StatusCode.NOT_FOUND,{"content-type":request.getMimeType()},null);return channel.getSink().push(response),channel.getSource()},Router.prototype._resolveInfiniteRequest=function(request){var channel=this._createChannel(),response=new Response(request.getURI(),508,{"content-type":request.getMimeType()},null);return channel.getSink().push(response),channel.getSource()},Router.prototype.resolve=function(request,opt_router,opt_next){if(opt_router=opt_router||new RouterProxy(this,0),opt_next=opt_next||new RouterProxy(this,0),opt_router.getLevel()>=1e3)return this._resolveInfiniteRequest(request);var handler=this._findMatchingResolver(request,opt_next.getVisited());return handler?handler.resolver.resolve(request,opt_router,opt_next):this._resolveUnmatchedRequest(request)}},{"./channel":16,"./resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],24:[function(require,module,exports){function EchoService(){return this instanceof EchoService?(Resolver.call(this,new RequestFilter({uri:"sp://echo**"})),void(this._serviceURI="sp://echo")):new EchoService}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,Resolver=(require("spotify-postrouter"),require("./../resolver").Resolver),RequestFilter=require("./../requestfilter").RequestFilter,RequestAction=cosmosCommon.request.Action,response=cosmosCommon.response,Response=response.Response,StatusCode=response.StatusCode;inherit(EchoService,Resolver),exports.EchoService=EchoService,EchoService.prototype.resolve=function(request){var channel=this._createChannel(),sink=channel.getSink();return request.getURI()==this._serviceURI?request.getAction()==RequestAction.GET?sink.push(this._createEchoResponse(request)):sink.push(this._createFailResponse(StatusCode.METHOD_NOT_ALLOWED,request)):sink.push(this._createFailResponse(StatusCode.BAD_REQUEST,request)),channel.getSource()},EchoService.prototype._createEchoResponse=function(request){return new Response(this._serviceURI,StatusCode.OK,{"Content-Type":request.getMimeType()},request.getBody())},EchoService.prototype._createFailResponse=function(status,request){return new Response(request.getURI(),status,{"Content-Type":request.getMimeType()},null)}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130,"spotify-postrouter":11}],25:[function(require,module,exports){function HermesService(hermesProvider){if(!(this instanceof HermesService))return new HermesService(hermesProvider);if(!hermesProvider||"function"!=typeof hermesProvider.send||"function"!=typeof hermesProvider.subscribe||"function"!=typeof hermesProvider.unsubscribe)throw new TypeError("Invalid hermesProvider argument for HermesService.");Resolver.call(this,new RequestFilter({uri:"hm**"})),this._provider=hermesProvider}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,RequestFilter=require("./../requestfilter").RequestFilter,Resolver=require("./../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,request=(response.StatusCode,cosmosCommon.request),ActionCodes=request.Action;exports.HermesProvider,inherit(HermesService,Resolver),exports.HermesService=HermesService,HermesService.prototype._sendSingleRequest=function(request,sink){var body=request.getBody(),self=this;this._provider.send(request.getURI(),request.getAction(),[],[],body?[body]:[],function(body,status,headers){headers.content_type&&(headers["content-type"]=headers.content_type),body=Array.isArray(body)&&1==body.length?body[0]:body,self._isUTF8response(headers["content-type"])&&"string"==typeof body&&(body=decodeURIComponent(escape(body)));var response=new Response(headers.uri,status,headers,body);sink.push(response)},this._onError(request,sink))},HermesService.prototype._sendSubRequest=function(request,sink){var uri=request.getURI(),token=this._provider.subscribe(uri,function(){},this._onError(request,sink),function(body,status,header){var response=new Response(header.uri,status,header,body);sink.push(response)});sink.addCloseCallback(function(){this._provider.unsubscribe(uri,token)}.bind(this))},HermesService.prototype._onError=function(request,sink){return function(error){error.data&&"object"==typeof error.data?error.data["content-type"]=request.getMimeType():error.data={"content-type":request.getMimeType()};var response=new Response(request.getURI(),error.code,error.data,null);sink.push(response)}},HermesService.prototype.resolve=function(request){var channel=this._createChannel(),sink=channel.getSink(),action=request.getAction();switch(action){case ActionCodes.SUB:this._sendSubRequest(request,sink);break;default:this._sendSingleRequest(request,sink)}return channel.getSource()},HermesService.prototype._isUTF8response=function(contentType){return contentType&&(contentType=contentType.replace(/\s+/,""),contentType=contentType.toLowerCase(),contentType=contentType.split(";")),contentType&&contentType.indexOf("charset=utf-8")>-1}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],26:[function(require,module,exports){function XMLHttpRequestInterface(){}function HTTPService(XMLHttpRequestClass){if(!(this instanceof HTTPService))return new HTTPService(XMLHttpRequestClass);if(!XMLHttpRequestClass)throw new TypeError("Invalid XMLHttpRequestClass argument for HTTPService.");Resolver.call(this,new RequestFilter({uri:"http**"})),this._XMLHTTPRequestClass=XMLHttpRequestClass}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,RequestFilter=require("./../requestfilter").RequestFilter,Resolver=require("./../resolver").Resolver,response=cosmosCommon.response,request=cosmosCommon.request,Actions=request.Action,Response=response.Response,ResponseStatus=response.StatusCode;XMLHttpRequestInterface.prototype.open=function(method,uri,async){},XMLHttpRequestInterface.prototype.setRequestHeader=function(key,value){},XMLHttpRequestInterface.prototype.getResponseHeader=function(name){},XMLHttpRequestInterface.prototype.getAllResponseHeaders=function(){},XMLHttpRequestInterface.prototype.send=function(body){},XMLHttpRequestInterface.prototype.onreadystatechange=function(){},XMLHttpRequestInterface.prototype.onerror=function(){},inherit(HTTPService,Resolver),exports.HTTPService=HTTPService,HTTPService.prototype._createRequest=function(request){var httpRequest=new this._XMLHTTPRequestClass;httpRequest.open(request.getAction().toUpperCase(),request.getURI(),!0),request.getAction()===Actions.POST&&httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");var headers=request.getHeaders();for(var headerName in headers)httpRequest.setRequestHeader(headerName,headers[headerName]);return httpRequest.setRequestHeader("accept",request.getMimeType()),httpRequest},HTTPService.prototype._attachRequestEvents=function(request,httpRequest){var self=this,channel=this._createChannel(),sink=channel.getSink();return httpRequest.onreadystatechange=function(){if(4==httpRequest.readyState){var location=request.getURI();try{location=httpRequest.getResponseHeader("Location")||location}catch(e){}var response=new Response(location,httpRequest.status,self._parseResponseHeaders(httpRequest.getAllResponseHeaders()),httpRequest.responseText);sink.push(response)}},httpRequest.onerror=function(){var response=new Response(request.getURI(),ResponseStatus.BAD_GATEWAY,{"Content-Type":request.getMimeType()},null);sink.push(response)},channel.getSource()},HTTPService.prototype._parseResponseHeaders=function(headerStr){for(var headers=headerStr.split("\n"),processed={},i=0,l=headers.length;l>i;i++){var header=headers[i];if(header){var matches=header.match(/^([^:]+):\s(.*)$/);matches&&(processed[matches[1]]=matches[2])}}return processed},HTTPService.prototype.resolve=function(request){var httpRequest=this._createRequest(request),channelSource=this._attachRequestEvents(request,httpRequest);return httpRequest.send(request.getBody()),channelSource}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],27:[function(require,module,exports){function MessageResolver(senderId,messageRouter){if(!(this instanceof MessageResolver))return new MessageResolver(senderId,messageRouter);if(!senderId||!messageRouter)throw new TypeError("Missing arguments for MessageResolver");this._sender=senderId,this._messageRouter=messageRouter,Resolver.call(this,new RequestFilter({uri:MESSAGES_URI+"**"}))}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,Resolver=require("./../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,ResponseStatus=response.StatusCode,RequestFilter=require("./../requestfilter").RequestFilter,request=cosmosCommon.request,ActionCodes=request.Action,MESSAGES_URI="sp://messages/v1/";inherit(MessageResolver,Resolver),exports.MessageResolver=MessageResolver,MessageResolver.prototype.resolve=function(request){var channel=this._createChannel(),sink=channel.getSink(),action=request.getAction(),uri=request.getURI();switch(action){case ActionCodes.POST:this._postRequestHandler(request,sink);break;case ActionCodes.SUB:this._subRequestHandler(request,sink);break;default:var headers={allow:ActionCodes.POST+", "+ActionCodes.SUB};sink.push(new Response(uri,ResponseStatus.METHOD_NOT_ALLOWED,headers))}return channel.getSource()},MessageResolver.prototype._subRequestHandler=function(request,sink){var uri=request.getURI(),topic=this._extractTopic(uri),headers=request.getHeaders()||{},realms=this._parseRealmsField(headers.realms),token=this._messageRouter.subscribe(topic,realms,function(message){var headers={sender:this._sender,realms:realms.join(","),topic:topic};sink.push(new Response(uri,ResponseStatus.OK,headers,message))}.bind(this));sink.addCloseCallback(function(){this._messageRouter.unsubscribe(token)}.bind(this))},MessageResolver.prototype._postRequestHandler=function(request,sink){var uri=request.getURI(),topic=this._extractTopic(uri),realms=this._parseRealmsField(request.getHeaders().realms),message=request.getBody();topic?(this._messageRouter.sendMessage(topic,realms,message),sink.push(new Response(uri,ResponseStatus.ACCEPTED,request.getHeaders()))):sink.push(new Response(uri,ResponseStatus.BAD_REQUEST))},MessageResolver.prototype._extractTopic=function(uri){return uri.replace(MESSAGES_URI,"")},MessageResolver.prototype._parseRealmsField=function(realms){return"string"!=typeof realms?[]:(realms=realms.replace(/\s+/g,""),realms.split(",").filter(function(el,i,arr){return!!el&&arr.indexOf(el)===i}))}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],28:[function(require,module,exports){module.exports={V1:require("./v1/player"),V2:require("./v2/player")}},{"./v1/player":29,"./v2/player":30}],29:[function(require,module,exports){function PlayerInterface(){}function PlayerService(player){if(!(this instanceof PlayerService))return new PlayerService(player);if(!player)throw new TypeError("Missing player argument for player service");Resolver.call(this,new RequestFilter({uri:"sp://player/v1/main"})),this._player=player}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,RequestFilter=require("./../../../requestfilter").RequestFilter,Resolver=require("./../../../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,ResponseStatus=response.StatusCode,request=cosmosCommon.request,ActionCodes=request.Action,PlayerState=cosmosCommon.playerstate.PlayerState,PLAYER_URI="sp://player/v1/main";PlayerInterface.prototype.play=function(playerState){},PlayerInterface.prototype.update=function(playerState){},PlayerInterface.prototype.stop=function(playerState){},PlayerInterface.prototype.pause=function(playerState){},PlayerInterface.prototype.resume=function(playerState){},PlayerInterface.prototype.next=function(playerState){},PlayerInterface.prototype.previous=function(playerState){},PlayerInterface.prototype.getState=function(){},PlayerInterface.prototype.subscribe=function(){},PlayerInterface.prototype.unsubscribe=function(){},inherit(PlayerService,Resolver),module.exports=PlayerService,PlayerService.prototype.resolve=function(request,router){function onResult(error,response){error?sink.push(new Response(PLAYER_URI,ResponseStatus.BAD_REQUEST)):sink.push(new Response(PLAYER_URI,ResponseStatus.OK,request.getHeaders(),response))}var channel=this._createChannel(),sink=channel.getSink(),action=request.getAction(),body=request.getBody();switch(action){case ActionCodes.POST:this._postRequestHandler(body,router,function(error,response){onResult(error,"")});break;case ActionCodes.GET:this._getRequestHandler(onResult);break;case ActionCodes.SUB:var token=this._subRequestHandler(onResult);sink.addCloseCallback(this._subCloseRequestHandler.bind(this,token));break;default:sink.push(new Response(PLAYER_URI,ResponseStatus.METHOD_NOT_ALLOWED))}return channel.getSource()},PlayerService.prototype._subRequestHandler=function(callback){return this._player.subscribe(callback.bind(this))},PlayerService.prototype._subCloseRequestHandler=function(token){return this._player.unsubscribe(token)},PlayerService.prototype._postRequestHandler=function(requestBody,router,callback){var data=this._parseRequestBody(requestBody);switch(data.action){case"play":this._player.play(data,router,callback);break;case"update":this._player.update(data,router,callback);break;case"stop":this._player.stop(data,callback);break;case"pause":this._player.pause(data,callback);break;case"resume":this._player.resume(data,callback);break;case"skip_next":this._player.next(data,callback);break;case"skip_prev":this._player.previous(data,callback);break;default:callback(new Error("Unrecognized action"))}},PlayerService.prototype._getRequestHandler=function(callback){var self=this;this._player.getState(function(error,response){error||(response=self._parsePlayerState(response)),callback(error,response)})},PlayerService.prototype._parsePlayerState=function(playerState){return playerState instanceof PlayerState||(playerState=new PlayerState(playerState)),playerState.serialize()},PlayerService.prototype._parseRequestBody=function(bodyStr){var data;try{data=JSON.parse(bodyStr)}catch(e){}return data?new PlayerState(data).serialize():null}},{"./../../../requestfilter":20,"./../../../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],30:[function(require,module,exports){function PlayerV2Service(players){return this instanceof PlayerV2Service?(this._players=players,this._repeatingContext=!1,this._repeatingTrack=!1,void Resolver.call(this,new RequestFilter({uri:"sp://player/v2**"}))):new PlayerV2Service(players)}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,Promise=require("spotify-promise"),RequestFilter=require("./../../../requestfilter").RequestFilter,Resolver=require("./../../../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,ResponseStatus=response.StatusCode,request=cosmosCommon.request,ActionCodes=request.Action,URI=require("miuri.js").miuri;inherit(PlayerV2Service,Resolver),module.exports=PlayerV2Service,PlayerV2Service.prototype.resolve=function(request,router){var channel=this._createChannel(),sink=channel.getSink(),uri=new URI(request.getURI()),parts=uri.path().substring(1).split("/"),playerName=parts[1],playerAction=parts[2],player=this._players[playerName];if(!player)return sink.push(new Response(request.getURI(),ResponseStatus.NOT_FOUND)),channel.getSource();switch(request.getAction()){case ActionCodes.POST:try{this._handlePost(request,sink,player,playerAction)}catch(e){console.error(e)}break;case ActionCodes.SUB:this._handleSub(request,sink,player);break;default:sink.push(new Response(request.getURI(),ResponseStatus.METHOD_NOT_ALLOWED))}return channel.getSource()},PlayerV2Service.prototype._handlePost=function(request,sink,player,action){var body=request.getJSONBody();switch(action){case"stop":case"resume":case"pause":player[action]("cosmos");break;case"skip_prev":player.getPlayerState().then(function(playerState){var isFirstTrack="none"==playerState.playbackState.repeatMode&&0==playerState.contextState.rawIndex;isFirstTrack||playerState.trackState.position>=3e3?player.seek(0):player.previous("cosmos")});break;case"skip_next":player.next("cosmos");break;case"seek_to":if(!("value"in body))return void sink.push(new Response(request.getURI(),ResponseStatus.BAD_REQUEST));player.seek(body.value);break;case"set_shuffling_context":if(!("value"in body))return void sink.push(new Response(request.getURI(),ResponseStatus.BAD_REQUEST));player.setShuffle(body.value);break;case"set_repeating_context":if(!("value"in body))return void sink.push(new Response(request.getURI(),ResponseStatus.BAD_REQUEST));this._repeatingContext=body.value,this._updateRepeatMode(player);break;case"set_repeating_track":if(!("value"in body))return void sink.push(new Response(request.getURI(),ResponseStatus.BAD_REQUEST));this._repeatingTrack=body.value,this._updateRepeatMode(player);break;default:return void sink.push(new Response(request.getURI(),ResponseStatus.NOT_FOUND))}sink.push(new Response(request.getURI(),ResponseStatus.OK))},PlayerV2Service.prototype._updateRepeatMode=function(player){var mode="none";this._repeatingContext&&(mode="context"),this._repeatingTrack&&(mode="track"),player.setRepeatMode(mode)},PlayerV2Service.prototype._handleSub=function(request,sink,player){var sendState=this._sendState.bind(this,request.getURI(),sink,player);sendState();var events={beforePlay:sendState,play:sendState,pause:sendState,stop:sendState,clear:sendState,trackLoaded:sendState,contextChange:sendState,shuffleChanged:sendState,repeatedChange:sendState,positionChanged:sendState,volumeChange:sendState,update:sendState};player.addListeners(events),sink.addCloseCallback(function(){player.removeListeners(events)})},PlayerV2Service.prototype._sendState=function(uri,sink,player,e){this._getPlayerState(player).then(function(state){sink.push(new Response(uri,ResponseStatus.OK,{},state))})},PlayerV2Service.prototype._getPlayerState=function(player){return Promise.join(player.getPlayerState(),player.getContextList()).thenSpread(this._parsePlayerState.bind(this))},PlayerV2Service.prototype._parsePlayerState=function(playerState,contextList){var contextState=playerState.contextState,trackState=playerState.trackState,playbackState=playerState.playbackState,promise=new Promise,entityURI=contextState.baseDescriptor?contextState.baseDescriptor.uri:null,state={timestamp:(new Date).getTime(),context:{entity_uri:entityURI,metadata:null,restrictions:{},pages:[],fallback_pages:[]},entity_uri:entityURI,index:{page:0,track:contextState.index},track:this._parseTrack(trackState.track),playback_uid:playbackState.uid.toString(),playback_speed:1,position_as_of_timestamp:trackState.position,duration:trackState.duration,is_playing:playbackState.playing,is_paused:!playbackState.playing,is_buffering:!1,play_origin:{feature_identifier:"",feature_version:"",view_uri:contextState.owner,external_referrer:null},options:{shuffling_context:contextState.shuffled,repeating_context:"context"==playbackState.repeatMode,repeating_track:"track"==playbackState.repeatMode},restrictions:this._parseRestrictions(contextList,contextState.ruleset),suppressions:{},debug:{player_id:"contextplayer",log:[]},future:[],reverse:[]};return promise.fulfill(state),promise},PlayerV2Service.prototype._parseTrack=function(track){if(!track)return null;var trackMetadata={uri:track.uri,album_name:track.albumName,album_uri:track.albumUri,artist_name:track.artistName,artist_uri:track.artistUri,image_small_url:track.image,image_url:track.image,image_large_url:track.imageLargest,image_xlarge_url:track.imageLargest,title:track.name,is_explicit:track.explicit,is_advertisement:track.advertisement.toString()};return track.advertisement&&(trackMetadata.click_url=track.ad_metadata.target_url,trackMetadata.advertiser=track.ad_metadata.advertiser),{uri:track.uri,uid:null,metadata:trackMetadata}},PlayerV2Service.prototype._parseRestrictions=function(contextList,ruleset){var initialReason=contextList?null:["no-context"],restrictions={disallow_playing_reasons:initialReason,disallow_stopping_reasons:initialReason,disallow_peeking_prev_reasons:initialReason,disallow_peeking_next_reasons:initialReason,disallow_skipping_prev_reasons:initialReason,disallow_skipping_next_reasons:initialReason,disallow_pausing_reasons:initialReason,disallow_resuming_reasons:initialReason,disallow_toggling_repeat_context_reasons:initialReason,disallow_toggling_repeat_track_reasons:initialReason,disallow_toggling_shuffle_reasons:initialReason,disallow_seeking_reasons:initialReason};return ruleset?(ruleset.next||(restrictions.disallow_skipping_next_reasons=["context"],restrictions.disallow_peeking_next_reasons=["context"]),ruleset.previous||(restrictions.disallow_skipping_prev_reasons=["context"],restrictions.disallow_peeking_prev_reasons=["context"]),ruleset.playpause||(restrictions.disallow_resuming_reasons=["context"],restrictions.disallow_pausing_reasons=["context"]),ruleset.repeat||(restrictions.disallow_toggling_repeat_context_reasons=["context"]),ruleset.repeatTrack||(restrictions.disallow_toggling_repeat_track_reasons=["context"]),ruleset.shuffle||(restrictions.disallow_toggling_shuffle_reasons=["context"]),ruleset.seek||(restrictions.disallow_seeking_reasons=["context"]),restrictions):restrictions}},{"./../../../requestfilter":20,"./../../../resolver":22,"cosmos-common-js":1,"miuri.js":9,"spotify-inheritance":130,"spotify-promise":133}],31:[function(require,module,exports){function ProtobufResolver(){return this instanceof ProtobufResolver?(Resolver.call(this,new RequestFilter(null,RequestFilterPriority.HIGHEST)),this._uri="sp://protobuf/v1/schemas",this._uid=0,this._schemas={},this._filters=[],void(this._schemaRequestFilter=new RequestFilter({uri:this._uri+"**"}))):new ProtobufResolver}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,requestFilter=require("./../requestfilter"),RequestFilter=requestFilter.RequestFilter,RequestFilterPriority=requestFilter.RequestFilterPriority,Resolver=require("./../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,ResponseStatus=response.StatusCode;exports.ProtobufSchemaString,exports.ProtobufSchemaDescriptor,exports.ProtobufSchema,exports.ProtobufRequestFilter,inherit(ProtobufResolver,Resolver),exports.ProtobufResolver=ProtobufResolver,ProtobufResolver.prototype._processSchemaRequest=function(request){switch(request.getAction()){case"GET":return this._getSchemaRequest(request);case"POST":return this._postSchemaRequest(request);case"DELETE":return this._deleteSchemaRequest(request);default:return this._notAllowedSchemaRequest(request)}},ProtobufResolver.prototype._getSchemaRequest=function(request){var channel=this._createChannel(),sink=channel.getSink(),id=request.getURI().replace(this._uri+"/",""),schema=this._schemas[id];return schema?sink.push(new Response(request.getURI(),ResponseStatus.OK,{},schema.descriptor)):sink.push(new Response(request.getURI(),ResponseStatus.NOT_FOUND)),channel.getSource()},ProtobufResolver.prototype._postSchemaRequest=function(request){var channel=this._createChannel(),sink=channel.getSink(),descriptor=request.getJSONBody()||request.getBody();
if(!(descriptor&&descriptor.schema&&descriptor.mappings&&Array.isArray(descriptor.mappings)&&descriptor.mappings.length))return this._invalidSchemaRequest(request);var id=this._uid+1,schema=this._createSchema(descriptor.schema);if(!schema)return this._invalidSchemaRequest(request);var maps=this._createSchemaMappings(id,descriptor.mappings,schema);if(!maps)return this._invalidSchemaRequest(request);var locationURI=this._uri+"/"+id;return this._schemas[id]={id:id,schema:null,descriptor:descriptor},this._filters.push.apply(this._filters,maps),this._uid++,sink.push(new Response(request.getURI(),ResponseStatus.CREATED,{location:locationURI})),channel.getSource()},ProtobufResolver.prototype._createSchema=function(schemaStr){var schema;try{return schema=new Spotify.Protobuf.Schema([],null,null,null),schema.type="proto",schema.setData(schemaStr),schema.encode(),schema}catch(e){return null}},ProtobufResolver.prototype._createSchemaMappings=function(id,mapping,schema){for(var maps=[],i=0,l=mapping.length;l>i;i++){var map=mapping[i];if(!map.filter||map.request&&!schema.msg(map.request)||map.response&&!schema.msg(map.response))return null;maps.push({id:id,filter:new RequestFilter(map.filter),request:schema.msg(map.request)||null,response:schema.msg(map.response)||null})}return maps},ProtobufResolver.prototype._deleteSchemaRequest=function(request){var channel=this._createChannel(),sink=channel.getSink(),id=parseInt(request.getURI().replace(this._uri+"/",""),10),schemas=this._schemas,schema=schemas[id];if(schema){schemas[id]=null;for(var filters=this._filters,newFilters=[],i=0,l=filters.length;l>i;i++){var filter=filters[i];filter.id!=id&&newFilters.push(filter)}this._filters=newFilters,sink.push(new Response(request.getURI(),ResponseStatus.OK))}else sink.push(new Response(request.getURI(),ResponseStatus.NOT_FOUND));return channel.getSource()},ProtobufResolver.prototype._notAllowedSchemaRequest=function(request){var channel=this._createChannel(),response=new Response(request.getURI(),ResponseStatus.METHOD_NOT_ALLOWED);return channel.getSink().push(response),channel.getSource()},ProtobufResolver.prototype._invalidSchemaRequest=function(request){var channel=this._createChannel(),response=new Response(request.getURI(),ResponseStatus.BAD_REQUEST);return channel.getSink().push(response),channel.getSource()},ProtobufResolver.prototype._processProtoRequest=function(request,next){for(var filter=null,filters=this._filters,i=0,l=filters.length;l>i;i++){var _filter=filters[i];if(_filter.filter.match(request)){filter=_filter;break}}if(filter){var body,requestBody=request.getJSONBody()||request.getBody();if(filter.request)try{body=filter.request.serializeToStringSync(requestBody)}catch(e){return this._invalidSchemaRequest(request)}var nextSource=next.resolve(request.copy(null,body));if(filter.response){var channel=this._createChannel(),sink=channel.getSink(),parser=this._createResponseParser(filter.response);return sink.addCloseCallback(function(){nextSource.close()}),nextSource.consume(function(response){var parsed;try{parsed=parser(response)}catch(e){parsed=e}sink.push(parsed)}),channel.getSource()}return nextSource}return next.resolve(request)},ProtobufResolver.prototype._createResponseParser=function(responseFilter){return function(response){var body;try{body=responseFilter.parseFromStringSync(response.getBody())}catch(e){throw new Response(response.getURI(),ResponseStatus.INTERNAL_SERVER_ERROR)}return response.copy(null,body)}},ProtobufResolver.prototype.resolve=function(request,router,next){return this._schemaRequestFilter.match(request)?this._processSchemaRequest(request):this._processProtoRequest(request,next)}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],32:[function(require,module,exports){function TrackResolverService(trackListResolver){if(!(this instanceof TrackResolverService))return new TrackResolverService(trackListResolver);if(!trackListResolver)throw new TypeError("TrackListResolver is required.");Resolver.call(this,new RequestFilter({uri:TrackResolverService.TRACK_RESOLVER_URI+"*"},RequestFilterPriority.HIGH)),this._trackListResolver=trackListResolver}var cosmosCommon=require("cosmos-common-js"),inherit=require("spotify-inheritance").inherit,Resolver=require("./../resolver").Resolver,response=cosmosCommon.response,Response=response.Response,ResponseStatus=response.StatusCode,request=cosmosCommon.request,requestFilter=(request.Request,request.Action,require("./../requestfilter")),RequestFilter=requestFilter.RequestFilter,RequestFilterPriority=requestFilter.RequestFilterPriority;inherit(TrackResolverService,Resolver),exports.TrackResolverService=TrackResolverService,TrackResolverService.TRACK_RESOLVER_URI="hm://track-resolver/v1?uri=",TrackResolverService.prototype._prepareList=function(uri,trackList){for(var tracks=[],i=0,l=trackList.length;l>i;i++){var track=trackList[i];track&&track.uri&&tracks.push({track:track.uri,context:uri})}return{tracks:tracks}},TrackResolverService.prototype._prepareResponse=function(uri,tracks){var response=new Response(uri,ResponseStatus.OK,{"Content-Type":"application/json"},tracks);return response},TrackResolverService.prototype.resolve=function(request){var originalURI=request.getURI(),uri=originalURI.replace(TrackResolverService.TRACK_RESOLVER_URI,""),descriptor={type:"list",uri:uri},channel=this._createChannel(),sink=channel.getSink();return this._trackListResolver.resolveAll(descriptor).then(function(list){return list.toArray()}).then(this._prepareList.bind(this,uri)).catchError(this._prepareList.bind(this,uri,[])).then(this._prepareResponse.bind(this,originalURI)).then(sink.push.bind(sink)),channel.getSource()}},{"./../requestfilter":20,"./../resolver":22,"cosmos-common-js":1,"spotify-inheritance":130}],33:[function(require,module,exports){module.exports={Base62:require("./src/base62"),Base64:require("./src/base64"),Hex:require("./src/hex"),md5:require("./src/md5"),Lut:require("./src/lut")}},{"./src/base62":34,"./src/base64":35,"./src/hex":36,"./src/lut":37,"./src/md5":38}],34:[function(require,module,exports){"use strict";function mul(lhs,rhs,base){for(var rest=0,i=0;i<lhs.length;++i){var tmp=lhs[i]*rhs+rest;lhs[i]=tmp%base,rest=~~(tmp/base)}for(;rest;)lhs.push(rest%base),rest=~~(rest/base)}function madd(acc,lhs,rhs,base){for(var rest=0,i=0;i<lhs.length;++i){var tmp=~~acc[i]+lhs[i]*rhs+rest;acc[i]=tmp%base,rest=~~(tmp/base)}for(;rest;){var tmp=~~acc[i]+rest;acc[i]=tmp%base,rest=~~(tmp/base),++i}}function convert(data,fromBase,toBase){for(var r=[0],b=[1],i=0;i<data.length;++i)madd(r,b,data[i],toBase),mul(b,fromBase,toBase);return r}function mapr(data,mapping){for(var i=0,r=[];i<data.length;++i)r.push(mapping[data[i]]);return r.reverse()}function pad(data,length){for(;data.length<length;)data.push(0);return data}for(var digits="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",invHexDigits={},invDigits={},i=0;i<digits.length;++i)invDigits[digits[i]]=i;for(var i=0;16>i;++i)invHexDigits["0123456789abcdef"[i]]=i;for(var i=0;16>i;++i)invHexDigits["0123456789ABCDEF"[i]]=i;module.exports={fromBytes:function(data,length){var r=convert(data.slice(0).reverse(),256,62);return mapr(pad(r,length),digits).join("")},toBytes:function(str,length){var r=convert(mapr(str,invDigits),62,256);return pad(r,length).reverse()},toHex:function(str,length){var r=convert(mapr(str,invDigits),62,16);return mapr(pad(r,length),digits).join("")},fromHex:function(str,length){var r=convert(mapr(str,invHexDigits),16,62);return mapr(pad(r,length),digits).join("")}}},{}],35:[function(require,module,exports){"use strict";var Base64=function(){for(var inverseDigits=[],i=0;256>i;++i)inverseDigits[i]=255;for(var i=0;i<this.BASE64_DIGITS.length;++i)inverseDigits[this.BASE64_DIGITS.charCodeAt(i)]=i;this._inverseData=String.fromCharCode.apply(String,inverseDigits)};Base64.prototype.BASE64_DIGITS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Base64.prototype.STRING_CHUNK_SIZE=4096,Base64.prototype._stringFromCharCode=function(data){if(data.length<this.STRING_CHUNK_SIZE)return String.fromCharCode.apply(String,data);var ptr=0,result=[];do result.push(String.fromCharCode.apply(String,data.slice(ptr,ptr+this.STRING_CHUNK_SIZE))),ptr+=this.STRING_CHUNK_SIZE;while(ptr<data.length);return result.join("")},Base64.prototype.encode=function(str){if("undefined"!=typeof window&&"undefined"!=typeof window.btoa)return window.btoa(str);var out,i,len,c1,c2,c3;for(len=str.length,i=0,out="";len>i;){if(c1=255&str.charCodeAt(i++),i==len){out+=this.BASE64_DIGITS.charAt(c1>>2),out+=this.BASE64_DIGITS.charAt((3&c1)<<4),out+="==";break}if(c2=str.charCodeAt(i++),i==len){out+=this.BASE64_DIGITS.charAt(c1>>2),out+=this.BASE64_DIGITS.charAt((3&c1)<<4|(240&c2)>>4),out+=this.BASE64_DIGITS.charAt((15&c2)<<2),out+="=";break}c3=str.charCodeAt(i++),out+=this.BASE64_DIGITS.charAt(c1>>2),out+=this.BASE64_DIGITS.charAt((3&c1)<<4|(240&c2)>>4),out+=this.BASE64_DIGITS.charAt((15&c2)<<2|(192&c3)>>6),out+=this.BASE64_DIGITS.charAt(63&c3)}return out},Base64.prototype.decode=function(str){if("undefined"!=typeof window&&"undefined"!=typeof window.atob)return window.atob(str);for(var tmp0,tmp1,ret=[],len=str.length,j=0;;){do tmp0=this._inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp0&&len>j);do tmp1=this._inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp1&&len>j);ret.push(255&(tmp0<<2|tmp1>>4));do tmp0=this._inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp0&&len>j);if(255===tmp0)break;ret.push(255&(tmp1<<4|tmp0>>2));do tmp1=this._inverseData.charCodeAt(255&str.charCodeAt(j++));while(255===tmp1&&len>j);if(255===tmp1)break;ret.push(255&(tmp0<<6|tmp1))}return this._stringFromCharCode(ret)};var base64=new Base64;module.exports={fromString:base64.encode.bind(base64),toString:base64.decode.bind(base64)}},{}],36:[function(require,module,exports){"use strict";var hex2str=function(hex){for(var str=[],i=0,len=hex.length;len-1>i;i+=2)str.push(String.fromCharCode(parseInt(hex.substr(i,2),16)));return str.join("")},str2hex=function(str){for(var hex="",i=0,len=str.length;len>i;++i)hex+=(str.charCodeAt(i)+256).toString(16).slice(-2);return hex};module.exports={toString:hex2str,fromString:str2hex}},{}],37:[function(require,module,exports){"use strict";function get_lut(extraSalt){function lcg(){var m=2147483647,a=16807,x=a*seed%m;return seed=x}function knuth_shuffling(seq){for(var len=seq.length,i=len-1;i>=1;i--){var j=lcg()%(i+1),aux=seq[i];seq[i]=seq[j],seq[j]=aux}}var seed=0,lut=lut_cache[extraSalt];if(lut)return lut;seed=0,lut=new Array(1e4);for(var i=0;i<lut.length;i++)lut[i]=i;var digest=md5.encode(extraSalt);return seed=parseInt(digest.substring(0,8),16),knuth_shuffling(lut),lut_cache[extraSalt]=lut,lut}var md5=require("./md5"),lut_cache={};module.exports={calc:get_lut}},{"./md5":38}],38:[function(require,module,exports){"use strict";function hex_md5(s){return rstr2hex(rstr_md5(str2rstr_utf8(s)))}function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),8*s.length))}function rstr2hex(input){try{}catch(e){hexcase=0}for(var x,hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef",output="",i=0;i<input.length;i++)x=input.charCodeAt(i),output+=hex_tab.charAt(x>>>4&15)+hex_tab.charAt(15&x);return output}function str2rstr_utf8(input){for(var x,y,output="",i=-1;++i<input.length;)x=input.charCodeAt(i),y=i+1<input.length?input.charCodeAt(i+1):0,x>=55296&&56319>=x&&y>=56320&&57343>=y&&(x=65536+((1023&x)<<10)+(1023&y),i++),127>=x?output+=String.fromCharCode(x):2047>=x?output+=String.fromCharCode(192|x>>>6&31,128|63&x):65535>=x?output+=String.fromCharCode(224|x>>>12&15,128|x>>>6&63,128|63&x):2097151>=x&&(output+=String.fromCharCode(240|x>>>18&7,128|x>>>12&63,128|x>>>6&63,128|63&x));return output}function rstr2binl(input){var i,l,output=Array(input.length>>2);for(i=0,l=output.length;l>i;i++)output[i]=0;for(i=0,l=8*input.length;l>i;i+=8)output[i>>5]|=(255&input.charCodeAt(i/8))<<i%32;return output}function binl2rstr(input){for(var output="",i=0;i<32*input.length;i+=8)output+=String.fromCharCode(input[i>>5]>>>i%32&255);return output}function binl_md5(x,len){x[len>>5]|=128<<len%32,x[(len+64>>>9<<4)+14]=len;for(var a=1732584193,b=-271733879,c=-1732584194,d=271733878,i=0;i<x.length;i+=16){var olda=a,oldb=b,oldc=c,oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936),d=md5_ff(d,a,b,c,x[i+1],12,-389564586),c=md5_ff(c,d,a,b,x[i+2],17,606105819),b=md5_ff(b,c,d,a,x[i+3],22,-1044525330),a=md5_ff(a,b,c,d,x[i+4],7,-176418897),d=md5_ff(d,a,b,c,x[i+5],12,1200080426),c=md5_ff(c,d,a,b,x[i+6],17,-1473231341),b=md5_ff(b,c,d,a,x[i+7],22,-45705983),a=md5_ff(a,b,c,d,x[i+8],7,1770035416),d=md5_ff(d,a,b,c,x[i+9],12,-1958414417),c=md5_ff(c,d,a,b,x[i+10],17,-42063),b=md5_ff(b,c,d,a,x[i+11],22,-1990404162),a=md5_ff(a,b,c,d,x[i+12],7,1804603682),d=md5_ff(d,a,b,c,x[i+13],12,-40341101),c=md5_ff(c,d,a,b,x[i+14],17,-1502002290),b=md5_ff(b,c,d,a,x[i+15],22,1236535329),a=md5_gg(a,b,c,d,x[i+1],5,-165796510),d=md5_gg(d,a,b,c,x[i+6],9,-1069501632),c=md5_gg(c,d,a,b,x[i+11],14,643717713),b=md5_gg(b,c,d,a,x[i+0],20,-373897302),a=md5_gg(a,b,c,d,x[i+5],5,-701558691),d=md5_gg(d,a,b,c,x[i+10],9,38016083),c=md5_gg(c,d,a,b,x[i+15],14,-660478335),b=md5_gg(b,c,d,a,x[i+4],20,-405537848),a=md5_gg(a,b,c,d,x[i+9],5,568446438),d=md5_gg(d,a,b,c,x[i+14],9,-1019803690),c=md5_gg(c,d,a,b,x[i+3],14,-187363961),b=md5_gg(b,c,d,a,x[i+8],20,1163531501),a=md5_gg(a,b,c,d,x[i+13],5,-1444681467),d=md5_gg(d,a,b,c,x[i+2],9,-51403784),c=md5_gg(c,d,a,b,x[i+7],14,1735328473),b=md5_gg(b,c,d,a,x[i+12],20,-1926607734),a=md5_hh(a,b,c,d,x[i+5],4,-378558),d=md5_hh(d,a,b,c,x[i+8],11,-2022574463),c=md5_hh(c,d,a,b,x[i+11],16,1839030562),b=md5_hh(b,c,d,a,x[i+14],23,-35309556),a=md5_hh(a,b,c,d,x[i+1],4,-1530992060),d=md5_hh(d,a,b,c,x[i+4],11,1272893353),c=md5_hh(c,d,a,b,x[i+7],16,-155497632),b=md5_hh(b,c,d,a,x[i+10],23,-1094730640),a=md5_hh(a,b,c,d,x[i+13],4,681279174),d=md5_hh(d,a,b,c,x[i+0],11,-358537222),c=md5_hh(c,d,a,b,x[i+3],16,-722521979),b=md5_hh(b,c,d,a,x[i+6],23,76029189),a=md5_hh(a,b,c,d,x[i+9],4,-640364487),d=md5_hh(d,a,b,c,x[i+12],11,-421815835),c=md5_hh(c,d,a,b,x[i+15],16,530742520),b=md5_hh(b,c,d,a,x[i+2],23,-995338651),a=md5_ii(a,b,c,d,x[i+0],6,-198630844),d=md5_ii(d,a,b,c,x[i+7],10,1126891415),c=md5_ii(c,d,a,b,x[i+14],15,-1416354905),b=md5_ii(b,c,d,a,x[i+5],21,-57434055),a=md5_ii(a,b,c,d,x[i+12],6,1700485571),d=md5_ii(d,a,b,c,x[i+3],10,-1894986606),c=md5_ii(c,d,a,b,x[i+10],15,-1051523),b=md5_ii(b,c,d,a,x[i+1],21,-2054922799),a=md5_ii(a,b,c,d,x[i+8],6,1873313359),d=md5_ii(d,a,b,c,x[i+15],10,-30611744),c=md5_ii(c,d,a,b,x[i+6],15,-1560198380),b=md5_ii(b,c,d,a,x[i+13],21,1309151649),a=md5_ii(a,b,c,d,x[i+4],6,-145523070),d=md5_ii(d,a,b,c,x[i+11],10,-1120210379),c=md5_ii(c,d,a,b,x[i+2],15,718787259),b=md5_ii(b,c,d,a,x[i+9],21,-343485551),a=safe_add(a,olda),b=safe_add(b,oldb),c=safe_add(c,oldc),d=safe_add(d,oldd)}return Array(a,b,c,d)}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)}function safe_add(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function bit_rol(num,cnt){return num<<cnt|num>>>32-cnt}var hexcase=0;module.exports={encode:hex_md5}},{}],39:[function(require,module,exports){module.exports=require(10)},{"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/spotify-deferred/src/deferred.js":10}],40:[function(require,module,exports){"use strict";var Promise=require("spotify-promise"),_wrapPromise=function(method,args){var promise=new Promise;try{var result=method.apply(null,args);result&&"function"==typeof result.then?result.pipe(promise):promise.fulfill(result)}catch(e){promise.fail(e)}return promise},_queue=function(originalMethod,args){if(this._getReady())return _wrapPromise(originalMethod,args);var promise=new Promise;return this._requestQueue.push({fn:originalMethod,args:args,promise:promise}),promise},Queueable=function(methods,ready){methods=methods||[];for(var i=0,l=methods.length;l>i;i++)this._makeQueueable(methods[i]);this._isReady=!!ready,this._requestQueue=[]};Queueable.prototype._makeQueueable=function(methodName){var originalMethod=methodName,context=this;if("function"!=typeof originalMethod&&(originalMethod=this[methodName]),originalMethod){var queuedMethod=function(){return _queue.call(context,originalMethod.bind(this),arguments)};return this[methodName]&&(this[methodName]=queuedMethod),queuedMethod}},Queueable.prototype._setReady=function(ready){if("undefined"==typeof ready&&(ready=!0),this._isReady=ready,ready)for(this._requestQueue=this._requestQueue.splice(0);this._requestQueue.length;){var item=this._requestQueue.pop();_wrapPromise(item.fn,item.args).pipe(item.promise)}},Queueable.prototype._getReady=function(){return this._isReady},module.exports=Queueable},{"spotify-promise":133}],41:[function(require,module,exports){!function(){"use strict";function createTriggerFunction(messageHandler,globalApp){return function(message,args,done,error){var request={type:"bridge_request",name:message,origin:"https://play.spotify.com",source:window};if(Array.isArray(args))request.args=args;else for(var name in args)args.hasOwnProperty(name)&&"name"!=name&&(request[name]=args[name]);messageHandler.trigger(message,globalApp,request,new Reply.Internal(done,error)),defer(function(){Responder.flush()})}}function createAPIPolyfill(applicationManager,messageHandler,trigger){var noop=function(){};return{api:{request:function(name,args,caller,success,failed){success=success||noop,failed=failed||noop,trigger(name,args,success.bind(caller),failed.bind(caller))},requestAsApp:function(app,name,args,caller,success,failed){var request={type:"bridge_request",name:name,args:Array.isArray(args)?args:[args],origin:"https://play.spotify.com",source:window};success=success||noop,failed=failed||noop,messageHandler.trigger(name,applicationManager.createDecoy(LinkHelper.from(app),{}),request,new Reply.Internal(success.bind(caller),failed.bind(caller)))}}}}function setup(applicationManager,dispatcher,globalApp){var messageHandler=new AppMessageHandler(applicationManager);return messageHandler.addInterceptor("core_flush",function(app,request,reply){return dispatcher.flush("/resources"),Responder.flush(),reply.send(!0),!1}),messageHandler.attach(),trigger=createTriggerFunction(messageHandler,globalApp),window.SpotifyApi||(window.SpotifyApi=createAPIPolyfill(applicationManager,messageHandler,trigger)),{messageHandler:messageHandler}}function init(core,initContext){var dispatcher=initContext.dispatcher,publisher=initContext.publisher;initContext.contextPlayer;dispatcher.create("/resources/image",null,{sources:SourceURLs});for(var i=0,l=responders.length;l>i;i++){var responder=responders[i];publisher&&(publisher.dispatcher=dispatcher),responder.init&&(responder.setTrigger(trigger),responder.init(core,publisher||{dispatcher:dispatcher,publisher:{subscribe:function(){}}}))}return this}var trigger,defer=(require("spotify-promise"),require("spotify-deferred")),Responder=require("./responder"),AppMessageHandler=require("./messages"),SourceURLs=require("./sourceurls"),LinkHelper=require("../shell/extension").LinkHelper,Reply=require("./reply"),responders=[require("./responders/application").getInstance(),require("./responders/client").getInstance(),require("./responders/hermes").getInstance(),require("./responders/keyboard").getInstance(),require("./responders/metadata").getInstance(),require("./responders/player").getInstance(),require("./responders/playlist").getInstance(),require("./responders/relations").getInstance(),require("./responders/runtime").getInstance(),require("./responders/search").getInstance(),require("./responders/suggest").getInstance(),require("./responders/toplist").getInstance(),require("./responders/user").getInstance()];module.exports={init:init,setup:setup}}()},{"../shell/extension":73,"./messages":44,"./reply":45,"./responder":46,"./responders/application":47,"./responders/client":48,"./responders/hermes":49,"./responders/keyboard":50,"./responders/metadata":51,"./responders/player":52,"./responders/playlist":53,"./responders/relations":54,"./responders/runtime":55,"./responders/search":56,"./responders/suggest":57,"./responders/toplist":58,"./responders/user":59,"./sourceurls":61,"spotify-deferred":39,"spotify-promise":133}],42:[function(require,module,exports){!function(){"use strict";function BridgeError(message){Error.apply(this,arguments),this.message=message}function BridgeAbortedError(message){BridgeError.call(this,message)}function BridgeForbiddenError(message){BridgeError.call(this,message)}function BridgeHermesError(message){BridgeError.call(this,message)}function BridgeInvalidRequestError(message){BridgeError.call(this,message)}function BridgeInvalidURIError(message){BridgeError.call(this,message)}function BridgeNotConnectedError(message){BridgeError.call(this,message)}function BridgeNotFoundError(message){BridgeError.call(this,message)}function BridgeNotImplementedError(message){BridgeError.call(this,message)}function BridgeOutOfDateError(message){BridgeError.call(this,message)}function BridgePlayCappedError(message){BridgeError.call(this,message)}function BridgeRateLimitedError(message){BridgeError.call(this,message)}function BridgeTimeoutError(message){BridgeError.call(this,message)}function BridgeTransientError(message){BridgeError.call(this,message)}function BridgeUnknownError(message){BridgeError.call(this,message)}function BridgeUnplayableError(message){BridgeError.call(this,message)}var inherit=require("spotify-inheritance/inherit");inherit(BridgeError,Error),BridgeError.prototype.name="BridgeError",BridgeError.prototype.type="bridge-error",BridgeError.Aborted=BridgeAbortedError,BridgeError.Forbidden=BridgeForbiddenError,BridgeError.Hermes=BridgeHermesError,BridgeError.InvalidRequest=BridgeInvalidRequestError,BridgeError.InvalidURI=BridgeInvalidURIError,BridgeError.NotConnected=BridgeNotConnectedError,BridgeError.NotFound=BridgeNotFoundError,BridgeError.NotImplemented=BridgeNotImplementedError,BridgeError.OutOfDate=BridgeOutOfDateError,BridgeError.PlayCapped=BridgePlayCappedError,BridgeError.RateLimited=BridgeRateLimitedError,BridgeError.Timeout=BridgeTimeoutError,BridgeError.Transient=BridgeTransientError,BridgeError.Unknown=BridgeUnknownError,BridgeError.Unplayable=BridgeUnplayableError,inherit(BridgeAbortedError,BridgeError),BridgeAbortedError.prototype.name="BridgeAbortedError",BridgeAbortedError.prototype.type="aborted",inherit(BridgeForbiddenError,BridgeError),BridgeForbiddenError.prototype.name="BridgeForbiddenError",BridgeForbiddenError.prototype.type="forbidden",inherit(BridgeHermesError,BridgeError),BridgeHermesError.prototype.name="BridgeHermesError",BridgeHermesError.prototype.type="hermes",inherit(BridgeInvalidRequestError,BridgeError),BridgeInvalidRequestError.prototype.name="BridgeInvalidRequestError",BridgeInvalidRequestError.prototype.type="invalid-request",inherit(BridgeInvalidURIError,BridgeError),BridgeInvalidURIError.prototype.name="BridgeInvalidURIError",BridgeInvalidURIError.prototype.type="invalid-uri",inherit(BridgeNotConnectedError,BridgeError),BridgeNotConnectedError.prototype.name="BridgeNotConnectedError",BridgeNotConnectedError.prototype.type="not-connected",inherit(BridgeNotFoundError,BridgeError),BridgeNotFoundError.prototype.name="BridgeNotFoundError",BridgeNotFoundError.prototype.type="not-found",inherit(BridgeNotImplementedError,BridgeError),BridgeNotImplementedError.prototype.name="BridgeNotImplementedError",BridgeNotImplementedError.prototype.type="not-implemented",inherit(BridgeOutOfDateError,BridgeError),BridgeOutOfDateError.prototype.name="BridgeOutOfDateError",BridgeOutOfDateError.prototype.type="out-of-date",inherit(BridgePlayCappedError,BridgeError),BridgePlayCappedError.prototype.name="BridgePlayCappedError",BridgePlayCappedError.prototype.type="play-capped",inherit(BridgeRateLimitedError,BridgeError),BridgeRateLimitedError.prototype.name="BridgeRateLimitedError",BridgeRateLimitedError.prototype.type="rate-limited",inherit(BridgeTimeoutError,BridgeError),BridgeTimeoutError.prototype.name="BridgeTimeoutError",BridgeTimeoutError.prototype.type="timeout",inherit(BridgeTransientError,BridgeError),BridgeTransientError.prototype.name="BridgeTransientError",BridgeTransientError.prototype.type="transient",inherit(BridgeUnknownError,BridgeError),BridgeUnknownError.prototype.name="BridgeUnknownError",BridgeUnknownError.prototype.type="unknown",inherit(BridgeUnplayableError,BridgeError),BridgeUnplayableError.prototype.name="BridgeUnplayableError",BridgeUnplayableError.prototype.type="unplayable",module.exports=BridgeError}()},{"spotify-inheritance/inherit":131}],43:[function(require,module,exports){!function(){"use strict";var BridgeError=require("./errors"),ResponseStatus=require("../shell/dispatcher").ResponseStatus,translateShellError=function(response){if(response instanceof Error)error=new BridgeError.Transient("JavaScript operation errored while performing request. ["+response.message+"]");else{var error=response,status=response.status;switch(status){case ResponseStatus.BAD_GATEWAY:case ResponseStatus.CONFLICT:case ResponseStatus.INTERNAL_SERVER_ERROR:case ResponseStatus.SERVICE_UNAVAILABLE:error=new BridgeError.Transient("Operation errored while performing request. ["+status+"]");break;case ResponseStatus.BAD_REQUEST:error=new BridgeError.InvalidRequest("Request failed because of invalid arguments. ["+status+"]");break;case ResponseStatus.FORBIDDEN:case ResponseStatus.UNAUTHORIZED:error=new BridgeError.Forbidden("Request not allowed. ["+status+"]");break;case ResponseStatus.METHOD_NOT_ALLOWED:case ResponseStatus.NOT_IMPLEMENTED:error=new BridgeError.NotImplemented("Request is not implemented. ["+status+"]");break;case ResponseStatus.GONE:case ResponseStatus.NOT_FOUND:error=new BridgeError.NotFound("Resource not found. ["+status+"]");break;case ResponseStatus.TIMED_OUT:error=new BridgeError.Timeout("Request timed-out. ["+status+"]")}}throw error};module.exports=translateShellError}()},{"../shell/dispatcher":62,"./errors":42}],44:[function(require,module,exports){!function(){"use strict";function AppMessageHandler(applicationManager){return this instanceof AppMessageHandler?(EventEmitter.call(this),this._applicationManager=applicationManager,this._checkTimeoutID=null,this._interceptors={},this._queuedWindows=new WeakMap,this._replies=new LinkedList,this._timeout=3e4,this._handleMessage=this._handleMessage.bind(this),this._checkTimeout=this._checkTimeout.bind(this),this._unqueueMessages=this._unqueueMessages.bind(this),void this.attach()):new AppMessageHandler(applicationManager)}var LinkedList=Spotify.LinkedList,inherit=require("spotify-inheritance/inherit"),EventEmitter=require("spotify-eventemitter"),BridgeError=require("./errors"),translateShellError=require("./errortranslator"),Reply=require("./reply"),Responder=require("./responder"),WeakMap=require("spotify-weakmap"),defer=require("spotify-deferred");inherit(AppMessageHandler,EventEmitter),AppMessageHandler.prototype._checkTimeout=function(){var timeout=this._timeout,list=this._replies;if(list.length){var now=(new Date).getTime(),item=list.first;do{var reply=item.value,_temp=item.next;if(reply.timestamp){if(now-reply.timestamp<timeout)break;reply.timeout(),list.remove(item)}}while(item=_temp)}this._checkTimeoutID=setTimeout(this._checkTimeout,timeout)},AppMessageHandler.prototype._handleMessage=function(e){var request=e.data;if("string"==typeof request)try{request=JSON.parse(request)}catch(e){return this}if(request.type&&"bridge_request"==request.type){var name=request.name;if(name){request.origin=e.origin;var source=request.source=e.source,app=this._applicationManager.getFromWindow(source);if(!app){var queued=this._queuedWindows.get(source);return queued||this._queuedWindows.set(source,queued=[]),void queued.push(e)}var reply=new Reply(request.id,request.origin,request.source);this.trigger(name,app,request,reply)}}},AppMessageHandler.prototype.trigger=function(name,app,request,reply){var interceptor=this._interceptors[name];if(interceptor&&!interceptor(app,request,reply))return void this.emit("intercepted",{name:name,args:request.args});var handler=Responder.getHandler(name);if(!handler)return this.emit("unimplemented",{name:name,args:request.args}),reply.fail(new BridgeError.NotImplemented("Message not implemented. ["+name+"]"));if(reply.internal||(this._replies.append(new LinkedList.Node(reply)),/event_wait/.test(name)&&reply.persist()),handler.passApp){var result=handler.fn.call(handler.bound||{},app,request,reply);result&&(result.then?result.catchError(translateShellError).then(reply.send.bind(reply),reply.fail.bind(reply)):reply.send(result))}else handler.fn.call(handler.bound||{},request,reply);this.emit("handled",{name:name,args:request.args})},AppMessageHandler.prototype._unqueueMessages=function(e){var window=e.window,queue=this._queuedWindows.get(window);if(queue&&queue.length){for(var items=queue.splice(0),i=0,l=items.length;l>i;i++)defer(this._handleMessage.bind(this,items[i]));this._queuedWindows.remove(window)}},AppMessageHandler.prototype.addInterceptor=function(message,interceptor){var interceptors=this._interceptors;if(interceptors[message])throw new Error('Interceptor for message "'+message+'" already exists.');interceptors[message]=interceptor},AppMessageHandler.prototype.removeInterceptor=function(message,interceptor){var interceptors=this._interceptors,attached=interceptors[message];return attached&&attached==interceptor?(interceptors[message]=null,!0):!1},AppMessageHandler.prototype.attach=function(){return this._checkTimeoutID=setTimeout(this._checkTimeout,this._timeout),window.attachEvent&&!window.addEventListener?window.attachEvent("onmessage",this._handleMessage):window.addEventListener("message",this._handleMessage,!1),this._applicationManager.addListener("windowAssociated",this._unqueueMessages),this},AppMessageHandler.prototype.detach=function(){return clearTimeout(this._checkTimeoutID),window.attachEvent&&!window.addEventListener?window.detachEvent("onmessage",this._handleMessage):window.removeEventListener("message",this._handleMessage,!1),this._applicationManager.removeListener("windowAssociated",this._unqueueMessages),this},module.exports=AppMessageHandler}()},{"./errors":42,"./errortranslator":43,"./reply":45,"./responder":46,"spotify-deferred":39,"spotify-eventemitter":128,"spotify-inheritance/inherit":131,"spotify-weakmap":134}],45:[function(require,module,exports){!function(){"use strict";function merge(a,b){for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a}function Reply(id,origin,source){return this instanceof Reply?(this.timestamp=(new Date).getTime(),this.internal=!1,this._id=id,this._origin=origin,this._source=source,this._payload=null,this._success=!0,this._hasPartial=!1,this._persisted=!1,void(this._sent=!1)):new Reply(id,origin,source)}function InternalReply(done,error){return this instanceof InternalReply?(this.internal=!0,this._done=done,this._error=error,this._payload=null,this._success=!0,this._hasPartial=!1,this._persisted=!1,void(this._sent=!1)):new InternalReply(done,error)}var BridgeError=require("./errors"),defer=require("spotify-deferred"),inherit=require("spotify-inheritance/inherit");Reply.prototype.persist=function(){return this._persisted=!0,this},Reply.prototype.addPartial=function(payload){this._sent||"object"!=typeof payload||(this._hasPartial?this._payload=merge(this._payload,payload):(this._payload=merge({},payload),this._hasPartial=!0))},Reply.prototype.send=function(payload){if(this._sent)return null;if(this._sent=!0,this._hasPartial&&(payload=merge(this._payload,payload)),this._source){var data={id:this._id,success:this._success,payload:payload};payload.type&&(payload.data&&(payload.event=payload.type),
payload.receiver&&(payload.target=payload.receiver)),this._source!==window&&this._source.postMessage(JSON.stringify(data),this._origin),this._origin=null,this._source=null,this._payload=null}},Reply.prototype.fail=function(error,opt_msg,opt_code){if(this._sent)return null;error instanceof BridgeError&&(opt_code=error.code,opt_msg=error.message,error=error.type);var payload="string"==typeof error?{error:error,message:opt_msg,code:opt_code}:error;return this._success=!1,this.send(payload)},Reply.prototype.timeout=function(){return this._sent||this._persisted?!1:this.fail(new BridgeError.Timeout("Request timed-out."))},inherit(InternalReply,Reply),Reply.Internal=InternalReply,InternalReply.prototype.send=function(payload){return this._sent?null:(this._sent=!0,this._hasPartial&&(payload=merge(this._payload,payload)),void(this._success&&this._done?defer(this._done.bind(this,payload)):!this._success&&this._error&&defer(this._error.bind(this,payload))))},module.exports=Reply}()},{"./errors":42,"spotify-deferred":39,"spotify-inheritance/inherit":131}],46:[function(require,module,exports){!function(){"use strict";function addHandler(proto,prop,value,self){var matches;switch(!0){case"_ready"==prop:value===!0&&self._setReady();break;case"flushRequests"==prop:_batchers.push(value.bind(self));break;case!!(matches=prop.match(/^(\*|@)(\1)?([^*@]+)$/)):var passApp="*"==matches[1],handlers=matches[2]?_privateHandlers:_handlers;if(prop=matches[3],prop in handlers)throw new Error('Redefinition of message handler "'+prop+'".');if("string"==typeof value){if(value=handlers[value],!value)throw new Error('Aliasing of undefined message handler "'+prop+'".');return void(handlers[prop]=value)}handlers[prop]={bound:self,fn:self._makeQueueable(value),passApp:passApp};break;default:self[prop]=value}}function Responder(proto){Queueable.call(this);for(var prop in proto)proto.hasOwnProperty(prop)&&addHandler(proto,prop,proto[prop],this);return this.create&&this.create(),this}var Link=Spotify.Link,inherit=require("spotify-inheritance/inherit"),SimpleCache=Spotify.SimpleCache,Promise=require("spotify-promise"),Queueable=require("spotify-queueable"),translateShellError=(require("spotify-deferred"),require("./errortranslator")),BridgeError=require("./errors"),SourceURLs=(require("./reply"),require("./sourceurls")),CACHE_SIZE=1e3,_handlers={},_privateHandlers={},_batchers=[],_caches={},_blocked={},_publisher=null;inherit(Responder,Queueable),Responder.build=function(proto){var instance=null;return{getInstance:function(){return instance||(instance=new Responder(proto))}}},Responder.getHandler=function(name){return _handlers[name]||_privateHandlers[name]},Responder.respondsTo=function(message){return message in _handlers},Responder.setPublisher=function(publisher){return _publisher=publisher,this},Responder.block=function(name){return _blocked[name]=!0,this},Responder.blockAll=function(array){for(var l=array.length;l--;)_blocked[array[l]]=!0;return this},Responder.unblock=function(name){return _blocked[name]=null,this},Responder.unblockAll=function(){return _blocked={},this},Responder.hasBlocked=function(name){return!!_blocked[name]},Responder.handleBlocked=function(data,reply,name){return _publisher&&_publisher.notify("LIMITED_FEATURE_CALL",{origin:data.source,feature:name,callback:function(){}}),reply.fail("restricted","Cannot perform action in this session.")},Responder.prototype.traceOut=function(marker){return marker=marker||"Out: ",function(){console.warn(marker,arguments)}},Responder.prototype.traceError=function(marker){return marker=marker||"Err: ",function(){console.error(marker,arguments)}},Responder.flush=function(){for(var len=_batchers.length;len--;)_batchers[len]()},Responder.prototype._ensureDescriptor=function(value){return"string"==typeof value?{type:"list",uri:value}:value},Responder.prototype._extractListURI=function(descriptor){if("string"==typeof descriptor||descriptor instanceof Link)return descriptor.toString();for(;descriptor&&"list"!=descriptor.type;)descriptor=descriptor.list;return descriptor&&descriptor.uri?descriptor.uri:null},Responder.prototype.use=function(map){var counter=0,services=[];for(var name in map)this[name]=map[name],services.push(map[name]),counter++;for(var fn=function(){--counter||this.start()}.bind(this),i=counter;i--;){var service=services[i];service.onReady(fn,this)}return this},Responder.prototype._createPromise=function(){return new Promise},Responder.prototype.store=function(key,ns,value){var cache=_caches[ns]||(_caches[ns]=new SimpleCache(CACHE_SIZE));return cache.put(key,value),this},Responder.prototype.retrieve=function(key,ns){return _caches[ns]?_caches[ns].get(key)||null:null},Responder.prototype.trigger=function(){},Responder.prototype.setTrigger=function(triggerFn){this.trigger=triggerFn},Responder.prototype._request=function(message,request,app){var promise=this._createPromise(),handler=_handlers[message]||_privateHandlers[message];if(!handler||!handler.passApp)return promise.fail(new BridgeError.NotImplemented("Message not implemented.")),promise;var result=handler.fn.call(handler.bound||{},app,request);return result&&result.then?result.catchError(translateShellError).pipe(promise):promise.fulfill(result),promise},Responder.prototype.createImageSizes=function(id,mosaic){var images=[[60,SourceURLs.tiny+id],[120,SourceURLs.small+id],[300,SourceURLs.normal+id],[640,SourceURLs.large+id]];return mosaic&&(images.shift(),images.pop()),images},Responder.prototype.createUserImageSizes=function(url,largeUrl){var images=[];url&&images.push([50,url]),largeUrl&&images.push([180,largeUrl]);for(var i=0,l=images.length;l>i;i++){var match=images[i][1].match(/^spotify:image:(.+)/);match&&(images[i][1]=SourceURLs.avatar+match[1])}return images},Responder.prototype.createSnapshot=function(args,parsed,length,metadata){var offset=args[1]||0,total=args[2]||-1;total=-1==total?parsed.length:total;var snapshot={range:{offset:offset,length:total},length:length||parsed.length,array:parsed.slice(offset,offset+total),metadata:(metadata||[]).slice(offset,offset+total)};return snapshot},Responder.prototype.createDimensions=function(offset,length,max){offset=offset||0,max=max||500,length=-1==length?max:Math.min(length,max);var end=offset+length-1;return{start:offset,end:end,length:length}},module.exports=Responder}()},{"./errors":42,"./errortranslator":43,"./reply":45,"./sourceurls":61,"spotify-deferred":39,"spotify-inheritance/inherit":131,"spotify-promise":133,"spotify-queueable":40}],47:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,BridgeError=require("../errors"),Responder=require("../responder"),ApplicationResponder=Responder.build({_ready:!1,init:function(core,web){return web?(this.publisher=web.publisher,this._getAppUrl=web.getAppUrl,this.clientLogger=core.logging.clientEvent,this.logger=core.logging.logger,void this.setup()):this},setup:function(){this._setReady()},"*application_open_uri":function(app,request){var uri,promise=this._createPromise();try{uri=Link.fromString(request.args[0]).toAppLink()}catch(e){return promise.fail(new BridgeError.InvalidURI("Not a valid application URI.")),promise}var replace=!!request.args[1];return this.publisher.notify("APPLICATION_OPEN_URI",{link:uri,origin:app.getFrame(),replace:replace}),promise.fulfill(!0),promise},"*application_query":function(app,request){var promise=this._createPromise(),id=app.getId(),data={uri:app.getAppLink().toURI(),name:id,identifier:id,arguments:app.getArgsDecoded()};return promise.fulfill(data),promise},"*application_event_wait":function(app,request){var promise=this._createPromise();if(app.getData("hasEventWaitListeners")){var queued=app.getData("eventWaitQueue").shift();if(queued)return promise.fulfill(queued),promise;app.getData("eventWaitListeners").push(promise)}else{app.setData("hasEventWaitListeners",!0),app.setData("eventWaitQueue",[]),app.setData("eventWaitListeners",[promise]);var listener=function(type,data){var payload={type:type,data:data},listeners=this.getData("eventWaitListeners").splice(0);if(listeners.length)for(var i=0,l=listeners.length;l>i;i++)listeners[i].fulfill(payload);else this.getData("eventWaitQueue").push(payload)};app.addListener("argumentsChange",listener.bind(app,"arguments")),app.addListener("activate",listener.bind(app,"activate")),app.addListener("deactivate",listener.bind(app,"deactivate"))}return promise},"*application_client_event":function(app,request){var promise=this._createPromise(),uri=app.getURI(),args=request.args;try{var logEntry={source:uri,source_version:request.appVersion||"0.0.0",source_vendor:request.appVendor||"unknown",context:(args[0]||"").toString(),event:(args[1]||"").toString(),event_version:(args[2]||"").toString(),test_version:(args[3]||"").toString(),data:JSON.stringify(args[4]||{})};this.clientLogger.log(logEntry),promise.fulfill(!0)}catch(e){promise.fail(new BridgeError.InvalidRequest("Check your logging arguments."))}return promise},"*application_banner_shown_event":function(app,request){var promise=this._createPromise();return this.logger.logBannerShown(request.args),promise.fulfill(!0),promise},"*application_set_preferred_size":function(app,request){var promise=this._createPromise(),width=parseInt(request.args[0],10),height=parseInt(request.args[1],10);return isNaN(width)||isNaN(height)||0>=width||0>=height?(promise.fail(new BridgeError.InvalidRequest("Size arguments need to be positive integer values.")),promise):(this.publisher.notify("APPLICATION_SET_PREFERRED_SIZE",{origin:app.getFrame(),width:width,height:height,callback:function(width,height){0>=width||0>=height?promise.fail(new BridgeError.Forbidden("Cannot complete resizing request.")):promise.fulfill({width:width,height:height})}}),promise)},"*application_exit":function(app,request){var promise=this._createPromise(),status=request.args[0];return this.publisher.notify("APPLICATION_EXIT",{origin:app.getFrame(),status:status}),promise.fulfill(!0),promise},"*application_set_title":function(app,request){var promise=this._createPromise(),title=request.args[0];return title&&title.replace(/^\s+|\s+$/g,"")?document.title=title+" - Spotify":document.title="Spotify",promise.fulfill(!0),promise},"*happ_metarequest":function(app,request){var uri,promise=this._createPromise();try{uri=Link.fromString(request.args[0])}catch(e){return promise.fail(new BridgeError.InvalidRequest("The URI is not a valid Spotify URI.")),promise}var url=this._getAppUrl(uri.id);return promise.fulfill({url:url,frame:url}),promise},"*log_application_loaded":function(app,request){var promise=this._createPromise();return this.publisher.notify("APPLICATION_LOAD_TIME",{uri:app.getURI(),start:request.args[0]||"",end:request.args[1]||""}),promise.fulfill(!0),promise},"*application_notify_loaded":function(app,request){var promise=this._createPromise();return this.publisher.notify("APPLICATION_LOAD_COMPLETE",{uri:app.getURI(),complete:(new Date).getTime()}),promise.fulfill(!0),promise}});module.exports=ApplicationResponder}()},{"../errors":42,"../responder":46}],48:[function(require,module,exports){!function(){"use strict";var LinkHelper=require("../../shell/extension").LinkHelper,BridgeError=require("../errors"),Responder=require("../responder"),ClientResponder=Responder.build({_ready:!1,_broadcastListeners:[],init:function(_,context){this._publisher=context.publisher,this._setReady()},"*client_event_wait":function(app,request){var promise=this._createPromise();return this._broadcastListeners.push(promise),promise},"*client_broadcast":function(app,request){var listeners=this._broadcastListeners;this._broadcastListeners=[];for(var payload={type:"broadcast",message:request.args[0]},i=0,l=listeners.length;l>i;i++)listeners[i].fulfill(payload)},"*client_features":function(app,request){return app.get("/features").then(function(response){return{features:response.body.result}})},"*client_show_context_ui":function(app,request){var args=request.args,left=parseInt(args[1],10),top=parseInt(args[2],10);return left=isNaN(left)?0:left,top=isNaN(top)?0:top,this._publisher.notify("CLIENT_SHOW_CONTEXT_UI",{origin:app.getFrame(),items:args[0],left:left,top:top,itemContext:args[3],itemIndex:args[4]}),!0},"*client_show_limited_feature_ui":function(app,request){return this._publisher.notify("LIMITED_FEATURE_CALL",{origin:request.source,feature:request.args[0],callback:function(){}}),!0},"*client_show_share_ui":function(app,request){var promise=this._createPromise(),args=request.args,uri=LinkHelper.from(args[0]);if(!uri)return promise.fail(new BridgeError.InvalidURI("URI is not valid.")),promise;var left=(args[1],parseInt(args[2],10)),top=parseInt(args[3],10);return left=isNaN(left)?0:left,top=isNaN(top)?0:top,this._publisher.notify("CLIENT_SHOW_SHARE_UI",{origin:request.source,left:left,top:top,uri:uri,callback:function(success){success?promise.fulfill(!0):promise.fail(new BridgeError.Forbidden("Cannot show share UI."))}}),promise},"*client_show_collection_union_remove_ui":function(app,request){var promise=this._createPromise();return this._publisher.notify("CLIENT_SHOW_COLLECTION_UNION_REMOVE_UI",{origin:request.source,uri:request.args[1],callback:function(success){success?promise.fulfill(!0):promise.fail(new BridgeError.Forbidden("Cannot show collection-confirm-union-remove UI."))}}),promise}});module.exports=ClientResponder}()},{"../../shell/extension":73,"../errors":42,"../responder":46}],49:[function(require,module,exports){!function(){"use strict";var Responder=require("../responder"),HermesResponder=Responder.build({_nextSubscriptionId:1,_subscriptions:{},_ready:!1,hermes:null,init:function(core){this.hermes=core.hermes,this.use({pubsub:core.pubsub})},start:function(){this._setReady()},resolveSchemas:function(schemas,deps){if(!deps)return schemas;for(var staticDeps=deps["static"],rootDepsBare=staticDeps.replace(/\/([^\/]*)$/,""),resolved=[],i=0,l=schemas.length;l>i;i++){var schema=schemas[i];if(!/^\/static/.test(schema)){var path,match=schema.match(/^\$([a-z\-\_]+)(\/.*)/),framework=!1,leadingSlash=!1;match?(framework=match[1],path=match[2]):/^\//.exec(schema)&&(leadingSlash=!0),framework&&deps[framework]?schema=deps[framework]+path:(framework?schema="/"+framework+path:leadingSlash||(schema="/"+schema),schema=(framework?rootDepsBare:staticDeps)+schema)}resolved.push(schema)}return resolved},onPubsubMessage:function(reply,subscriptionId,rawFrames,parsedFrames){var subscriptions=this._subscriptions[subscriptionId];if(subscriptions&&!(rawFrames.length<4)){var i,l;for(i=0,l=subscriptions.length;l>i;i++)subscriptions[i].send({type:"message",frames:parsedFrames});delete this._subscriptions[subscriptionId]}},"@hermes_event_wait":function(data,reply){reply.persist();var subscriptionId=parseInt(data.args[0],10);if(isNaN(subscriptionId)||1>subscriptionId||subscriptionId>=this._nextSubscriptionId)return void reply.fail("hermes","Invalid subscription id");var subscriptions=this._subscriptions[subscriptionId];subscriptions?subscriptions.push(reply):this._subscriptions[subscriptionId]=[reply]},"@hermes_load_schema_data":function(data,reply){this.hermes.loadSchemaData(data.args,function(id){reply.send({id:id})},reply.fail.bind(reply,"hermes","Failed to load schema data"))},"@hermes_register_schema":function(data,reply){this.hermes.loadSchemas(this.resolveSchemas(data.args,data.deps),"proto",function(id){reply.send({id:id})},reply.fail.bind(reply,"hermes","Failed to register schema"))},"@hermes_send_request":function(data,reply){var args=data.args;this.hermes.send(args[0],args[1],args[3],args[2],args[4],function(response){reply.send({result:response})},reply.fail.bind(reply,"hermes","Hermes request failed"))},"@hermes_subscribe":function(data,reply){var subscriptionId=this._nextSubscriptionId++,args=data.args;this.pubsub.subscribe(args[0],args[3],args[2],args[1],reply.send.bind(reply,{subscription_id:subscriptionId}),reply.fail.bind(reply,"hermes","Error when trying to subscribe"),this.onPubsubMessage.bind(this,reply,subscriptionId),null)},"@hermes_unsubscribe":function(data,reply){var subscriptionId=parseInt(data.args[0],10);if(isNaN(subscriptionId)||1>subscriptionId||subscriptionId>=this._nextSubscriptionId)return void reply.fail("hermes","Invalid subscription id");var subscriptions=this._subscriptions[subscriptionId];if(subscriptions){for(var i=0,l=subscriptions.length;l>i;i++)subscriptions[i].send({type:"close"});delete this._subscriptions[subscriptionId]}reply.send()}});module.exports=HermesResponder}()},{"../responder":46}],50:[function(require,module,exports){!function(){"use strict";var Responder=require("../responder"),KeyboardResponder=Responder.build({_ready:!1,_modifiers:{alt:1,meta:2,shift:4,ctrl:8},_keymap:{32:16,37:32,38:64,39:128,40:256,83:512},_ignore:{input:1,button:1,textarea:1,select:1},_SEEK_WITH_KEYBOARD_MS:15e3,_enabled:!0,_bindings:{},_empty:function(){},init:function(){this._setupBindings(),this._setReady(),window.addEventListener("keydown",this.handleOwn.bind(this,!1)),window.addEventListener("keyup",this.handleOwn.bind(this,!0))},_setupBindings:function(){var bindings=this._bindings,modifiers=this._modifiers,keys=this._keymap;bindings[keys[32]]="player_play_toggle",bindings[keys[37]|modifiers.shift]="player_skip_to_prev",bindings[keys[39]|modifiers.shift]="player_skip_to_next",bindings[keys[37]|modifiers.ctrl|modifiers.shift]="player_seek_backward",bindings[keys[39]|modifiers.ctrl|modifiers.shift]="player_seek_forward",bindings[keys[38]|modifiers.ctrl|modifiers.alt]="player_volume_up",bindings[keys[40]|modifiers.ctrl|modifiers.alt]="player_volume_down",bindings[keys[83]|modifiers.ctrl|modifiers.alt]="navigation_show_search"},handleOwn:function(trigger,e){var target=e.target;if(this._ignore[target.tagName.toLowerCase()])return this;var key=this._keymap[e.which||e.keyCode];if(!key)return this;var modifiers=this._modifiers;e.altKey&&(key|=modifiers.alt),e.metaKey&&(key|=modifiers.meta),e.ctrlKey&&(key|=modifiers.ctrl),e.shiftKey&&(key|=modifiers.shift);var binding=this._bindings[key];if(!binding)return this;e.preventDefault(),e.stopPropagation();var extraArg=null;"player_seek_forward"!==binding&&"player_seek_backward"!==binding||(extraArg=this._SEEK_WITH_KEYBOARD_MS);var args=["main",extraArg];return trigger?void this.trigger(binding,args,this._empty,this._empty):this},"@keyboard_get_bindings":function(data,reply){var payload={_modifiers:this._modifiers,_keymap:this._keymap,_ignore:this._ignore,_bindings:this._bindings};return reply.send(payload)},"@keyboard_trigger_binding":function(data,reply){if(this._enabled){var binding=data.args[0],extraArg=null;"player_seek_forward"!==binding&&"player_seek_backward"!==binding||(extraArg=this._SEEK_WITH_KEYBOARD_MS);var args=["main",extraArg];this.trigger(binding,{args:args,origin:data.origin},this._empty,this._empty)}},"*keyboard_disable":function(){return this._enabled=!1,!0},"*keyboard_enable":function(){return this._enabled=!0,!0},"@navigation_show_search":function(data,reply){$("nav-search").onmousedown({preventDefault:this._empty})}});module.exports=KeyboardResponder}()},{"../responder":46}],51:[function(require,module,exports){!function(){var LinkHelper=require("../../shell/extension").LinkHelper,BridgeError=require("../errors"),Responder=require("../responder"),SnapshotHelper=require("../snapshothelper"),MetadataResponder=Responder.build({_ready:!0,"*artist_metadata":function(app,request){var promise=this._createPromise(),uri=LinkHelper.from(request.args[0]);return uri?app.get("/artist",{},{uri:uri}).then(function(response){return response.body.result}):(promise.fail(new BridgeError.InvalidURI("Not a valid Spotify URI.")),promise)},"*artist_profile":"artist_metadata","*album_metadata":function(app,request){var promise=this._createPromise(),uri=LinkHelper.from(request.args[0]);return uri?app.get("/album",{},{uri:uri}).then(function(response){return response.body.result}):(promise.fail(new BridgeError.InvalidURI("Not a valid Spotify URI.")),promise)},"*album_profile":"album_metadata","*track_metadata":function(app,request){var promise=this._createPromise(),uri=LinkHelper.from(request.args[0]);return uri?app.get("/track",{},{uri:uri}).then(function(response){return response.body.result}):(promise.fail(new BridgeError.InvalidURI("Not a valid Spotify URI.")),promise)},"**track_multi_metadata":function(app,request,reply){for(var len=request.args.length,payload={},send=function(uri,request){payload[uri]=request.error?null:data,len--,len||reply.send(payload)},i=0,l=request.args.length;l>i;i++){var uri=request.args[i].toString(),sender=send.bind(null,uri);this._request("track_metadata",{args:[uri]},app).then(sender,sender)}},"*album_tracks_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/album/tracks",{},{descriptor:descriptor}).then(SnapshotHelper.createBaseListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*album_disc_tracks_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/album/disc/tracks",{},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*artist_albums_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/artist/albums",{},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatMetadataSnapshot)},"*artist_appearances_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/artist/appearances",{},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatMetadataSnapshot)},"*artist_singles_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/artist/singles",{},{descriptor:descriptor}).then(SnapshotHelper.createBaseListSnapshotter(offset,length)).then(SnapshotHelper.formatMetadataSnapshot)},"*artist_top_tracks_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/artist/toptracks",{},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*artist_related_artists_snapshot":function(app,request){var descriptor=this._ensureDescriptor(request.args[0]),offset=request.args[1],length=request.args[2];return app.get("/artist/related",{},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)}});module.exports=MetadataResponder}()},{"../../shell/extension":73,"../errors":42,"../responder":46,"../snapshothelper":60}],52:[function(require,module,exports){!function(){"use strict";var Promise=require("spotify-promise"),ItemList=require("../../shell/lists"),MutationResult=ItemList.MutationResult,SubItemList=require("../../shell/sublists"),ContextOperationResult=require("spotify-contextplayer/types").OperationResult,RepeatMode=require("spotify-contextplayer/types").RepeatMode,LinkHelper=require("../../shell/extension").LinkHelper,BridgeError=require("../errors"),Responder=require("../responder"),SnapshotHelper=require("../snapshothelper"),PlayerResponder=Responder.build({init:function(core,web){this._setReady()},_translateState:function(playerState){var playbackState=playerState.playbackState,trackState=playerState.trackState,contextState=playerState.contextState,state={__uid:playbackState.uid,__rules:playbackState.ruleset,playing:playbackState.playing,volume:playbackState.volume,position:trackState.position,duration:trackState.duration,track:trackState.track,__owner:contextState.owner,__index:contextState.rawIndex,context:contextState.baseDescriptor?{uri:contextState.baseDescriptor.uri.toString()}:null,contexts:contextState.descriptorMap,index:contextState.listIndex,shuffle:contextState.shuffled,repeat:null};switch(playbackState.repeatMode){case RepeatMode.NONE:state.repeat=0;break;case RepeatMode.CONTEXT:state.repeat=1;break;case RepeatMode.TRACK:state.repeat=2}return state},_getPlayer:function(app,playerId){return app.get("/resources/playergroup").then(function(playerGroup){var player=playerGroup.get(playerId);if(!player)throw new BridgeError.InvalidRequest('No player for id "'+playerId+'"');return player})},"*player_map_track_identifiers":function(app,request){var promise=this._createPromise();return promise.fulfill(!0),promise},"*player_event_wait":function(app,request){var self=this,promise=this._createPromise(),playerId=request.args[0],flagKey="hasPlayerEventWaitListenersFor:"+playerId,listenersKey="playerEventWaitListenersFor:"+playerId;return app.getData(flagKey)?app.getData(listenersKey).push(promise):this._getPlayer(app,playerId).then(function(player){app.setData(flagKey,!0),app.setData(listenersKey,[promise]);var listener=function(){var listeners=this.getData(listenersKey).splice(0);player.getPlayerState().then(self._translateState).then(function(state){for(var i=0,l=listeners.length;l>i;i++)listeners[i].fulfill({type:"change",data:state})})}.bind(app),listeners={contextChange:listener,contextEnd:listener,beforePlay:listener,play:listener,pause:listener,stop:listener,clear:listener,trackLoaded:listener,shuffleChanged:listener,repeatModeChanged:listener,volumeChange:listener,update:listener};player.addListeners(listeners),app.addOnceListener("destroy",function(){player.removeListeners(listeners)})}).catchError(function(error){promise.fail(error)}),promise},"*player_event_wait_any":function(app,request){var promise=this._createPromise(),playerId=request.args[0],flagKey="hasPlayerEventWaitAnyListenersFor:"+playerId,listenersKey="playerEventWaitAnyListenersFor:"+playerId,queueKey="playerEventWaitAnyQueueFor:"+playerId;if(app.getData(flagKey)){var queued=app.getData(queueKey).shift();if(queued)return promise.fulfill(queued),promise;app.getData(listenersKey).push(promise)}else this._getPlayer(app,playerId).then(function(player){app.setData(flagKey,!0),app.setData(listenersKey,[promise]),app.setData(queueKey,[]);var listener=function(event){var payload={type:event.type};"repeatModeChanged"==event.type&&this.getData(queueKey).push({type:"repeatedChange"});var listeners=this.getData(listenersKey).splice(0);if(listeners.length)for(var i=0,l=listeners.length;l>i;i++)listeners[i].fulfill(payload);else this.getData(queueKey).push(payload)}.bind(app);player.addListeners({queueChange:listener,beforePlay:listener,play:listener,pause:listener,stop:listener,clear:listener,trackLoaded:listener,positionChanged:listener,shuffleChanged:listener,repeatModeChanged:listener,volumeChange:listener}),app.addOnceListener("destroy",function(){player.removeListeners({queueChange:listener,beforePlay:listener,play:listener,pause:listener,stop:listener,clear:listener,trackLoaded:listener,positionChanged:listener,shuffleChanged:listener,repeatModeChanged:listener,volumeChange:listener})})}).catchError(function(error){promise.fail(error)});return promise},"*player_play_toggle":function(app,request){return this._getPlayer(app,request.args[0]).then(function(player){return player.togglePlay()}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_query":function(app,request){return this._getPlayer(app,request.args[0]).then(function(player){return player.getPlayerState()}).then(this._translateState)},"*player_play":function(app,request){return this._getPlayer(app,request.args[0]).then(function(player){return player.resume()}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_pause":function(app,request){return this._getPlayer(app,request.args[0]).then(function(player){return player.pause()}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_stop":function(app,request){return this._getPlayer(app,request.args[0]).then(function(player){return player.stop()}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_seek":function(app,request){var args=request.args,amount=args[1];return this._getPlayer(app,args[0]).then(function(player){return player.seek(amount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_seek_forward":function(app,request){var args=request.args,offset=args[1];return this._getPlayer(app,args[0]).then(function(player){return Promise.join(player,player.getTrackState())}).thenSpread(function(player,state){var position=state.position,duration=state.duration,seekAmount=position+offset;return seekAmount>duration&&(seekAmount=duration),player.seek(seekAmount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_seek_backward":function(app,request){var args=request.args,offset=args[1];return this._getPlayer(app,args[0]).then(function(player){return Promise.join(player,player.getTrackState())}).thenSpread(function(player,state){var position=state.position,seekAmount=(state.duration,position-offset);return 0>seekAmount&&(seekAmount=0),player.seek(seekAmount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_set_shuffle":function(app,request){var args=request.args,mode=!!args[1];return this._getPlayer(app,args[0]).then(function(player){return player.setShuffle(mode)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_set_repeat":function(app,request){var args=request.args,value=args[1],mode=null;switch(typeof value){case"boolean":mode=value?RepeatMode.CONTEXT:RepeatMode.NONE;break;case"number":switch(value){case 1:mode=RepeatMode.CONTEXT;break;case 2:mode=RepeatMode.TRACK;break;default:mode=RepeatMode.NONE}}return this._getPlayer(app,args[0]).then(function(player){return player.setRepeatMode(mode)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_skip_to_next":function(app,request){var args=request.args,playerId=args[0],reason=args[1]||"fwdbtn";return this._getPlayer(app,playerId).then(function(player){return player.next(reason)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_skip_to_prev":function(app,request){var args=request.args,playerId=args[0],reason=args[1]||"backbtn";return Promise.join(this._getPlayer(app,playerId),app.get("/features").access("body","result")).thenSpread(function(player,features){return features.simplePlayer?player.getTrackState().then(function(trackState){return trackState.position>=3e3?player.seek(0):player.previous(reason)}):player.previous(reason)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_set_volume":function(app,request){var args=request.args,playerId=args[0],amount=args[1];return this._getPlayer(app,playerId).then(function(player){return player.setVolume(amount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_volume_up":function(app,request){var args=request.args;args[1];return this._getPlayer(app,args[0]).then(function(player){return Promise.join(player,player.getPlaybackState())}).thenSpread(function(player,state){var current=100*state.volume;if(100==current)return ContextOperationResult.SUCCESS;var amount=(current+10)/100;return player.setVolume(amount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_volume_down":function(app,request){var args=request.args;args[1];return this._getPlayer(app,args[0]).then(function(player){return Promise.join(player,player.getPlaybackState())}).thenSpread(function(player,state){var current=100*state.volume;if(0==current)return ContextOperationResult.SUCCESS;var amount=(current-10)/100;return player.setVolume(amount)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_event":function(){return this._createPromise()},"*player_play_track":function(app,request,reply){
var args=(this._createPromise(),request.args),playerId=args[0],track=args[1];return this._getPlayer(app,playerId).then(function(player){var list=new SubItemList.MetadataDecorator(new ItemList.Array([track]),function(uris){return app.get("/tracks",{flush:!0},{uris:uris}).then(function(r){return r.body.result})}),playbackOptions={index:0,offset:args[2],duration:args[3],pause:!1,reason:args[4]||"clickrow",rules:player.getRuleFor("default")};return list=new SubItemList.Context(list,app.getURI()),player.play(list,playbackOptions).then(function(e){return!0})})},"*player_play_context":function(app,request,reply){var promise=this._createPromise(),args=request.args,playerId=args[0],descriptor=ItemList.Descriptor.fromObject(args[1]);return descriptor?this._getPlayer(app,playerId).then(function(player){return Promise.join(player,app.get("/resources/tracklistresolver"))}).thenSpread(function(player,trackListResolver){return Promise.join(player,trackListResolver.resolve(descriptor))}).thenSpread(function(player,list){var index=args[2];return Promise.join(player,list,null==index||-1==index?0:list.translateIndexFromBase(args[2]))}).thenSpread(function(player,list,index){if(index==ItemList.OUT_OF_BOUNDS)return!1;var rule=null,ruleMap=app.getData("ruleMap"),baseList=ItemList.Descriptor.extractList(descriptor);ruleMap&&baseList&&(rule=ruleMap[baseList.uri]);var playbackOptions={index:index,offset:args[3],duration:args[4],pause:!1,reason:args[5]||"clickrow",rules:player.getRuleFor(rule||"default")};return list=new SubItemList.Context(list,app.getURI()),player.play(list,playbackOptions).then(function(e){return!0})}):(promise.fail(new BridgeError.InvalidRequest("Invalid list descriptor.")),promise)},"*player_play_context_group":function(app,request,reply){var promise=this._createPromise(),args=request.args,playerId=args[0],descriptor=ItemList.Descriptor.fromObject(args[1]);return descriptor?this._getPlayer(app,playerId).then(function(player){return Promise.join(player,app.get("/resources/tracklistresolver"))}).thenSpread(function(player,trackListResolver){return Promise.join(player,trackListResolver.resolve(descriptor))}).thenSpread(function(player,list){return Promise.join(player,list,list.getListAt(args[2]).translateIndexFromBase(args[3]).then(function(index){return index==ItemList.OUT_OF_BOUNDS?ItemList.OUT_OF_BOUNDS:list.offsetFromListIndex(args[2],index)}))}).thenSpread(function(player,list,index){if(index==ItemList.OUT_OF_BOUNDS)return!1;var playbackOptions={index:index,offset:args[4],duration:args[5],pause:!1,reason:args[6]||"clickrow",rules:player.getRuleFor("default")};return list=new SubItemList.Context(list,app.getURI()),player.play(list,playbackOptions).then(function(e){return!0})}):(promise.fail(new BridgeError.InvalidRequest("Invalid list descriptor.")),promise)},_fetchContextName:function(app,type,uri,infoObj){return app.get("/"+type,{flush:!0},{uri:uri}).then(function(response){var result=response.body.result;return infoObj.context.name=result.name,infoObj.context.uri=uri,infoObj.context.type=type,infoObj})},"*player_get_context_info":function(app,request){var self=this,args=request.args,playerId=args[0];return this._getPlayer(app,playerId).then(function(player){var info={app:{id:null,uri:null},context:{name:null,type:null,uri:null}},contextList=player.getContextList();return contextList?Promise.join(info,contextList,SubItemList.Context.getDescriptorMap(contextList,0)).thenSpread(function(info,contextList,map){var owner=LinkHelper.from(contextList.getOwner());info.app.id=owner.id||owner.type,info.app.uri=owner.toString();for(var i=0,l=map.length;l>i;i++){var current=map[i];if("list"==current.descriptor.type){var context=LinkHelper.from(current.descriptor.uri);break}}var type=context.type||context.id;switch(type){case"application":case"temp-playlist":if("radio"==owner.id){var args=owner.args,uri=["spotify"].concat(args).join(":");if("user"==args[0])return self._fetchContextName(app,"playlist",uri,info).then(function(info){return info.context.type="radio",info});if(args[0])return self._fetchContextName(app,args[0],uri,info).then(function(info){return info.context.type="radio",info});info.context.name="Radio",info.context.type="radio",info.context.uri="spotify:app:radio"}else info.context.name=owner.id,info.context.type="app",info.context.uri=owner.uri;return info;case"search":var query=LinkHelper.from(owner.toString().replace(":app",""));return info.context.name=query.query,info.context.type="search",info.context.uri=query.toString(),info;case"album":case"artist":case"track":return self._fetchContextName(app,type,context,info);case"playlist":case"starred":case"user-toplist":case"user-top-tracks":case"trackset":return self._fetchContextName(app,"playlist",context,info).then(function(info){return info.app.id||(info.app.id="playlist"),info});default:return info}}):info})},"*player_skip_to_index":function(app,request){var args=request.args,playerId=args[0],index=parseInt(args[1],10),reason=args[2]||"click-row";return this._getPlayer(app,playerId).then(function(player){var context=player.getContextList();return context?Promise.join(player,context.startAt(index)):ContextOperationResult.NO_CONTEXT}).thenSpread(function(player){return player.next(reason,!0)}).then(function(result){return result==ContextOperationResult.SUCCESS})},"*player_queue_tracks":function(app,request){var args=(this._createPromise(),request.args),playerId=args[0],tracks=args.slice(1);return this._getPlayer(app,playerId).then(function(player){var queue=player.getQueueList();return app.get("/tracks",{flush:!0},{uris:tracks}).then(function(response){for(var result=response.body.result,list=[],i=0,l=tracks.length;l>i;i++){var track=result[tracks[i]];track&&list.push(track)}var mutator=queue.createMutator();return mutator&&mutator.canAdd(list.length)==MutationResult.ALLOWED?(mutator.add(list),mutator.apply()):MutationResult.FORBIDDEN}).then(function(result){return result==MutationResult.SUCCESS})})},"*player_queue_tracks_append":"player_queue_tracks","*player_queue_tracks_remove":function(app,request){var args=request.args,playerId=args[0],index=parseInt(args[1],10),length=parseInt(args[2],10);return this._getPlayer(app,playerId).then(function(player){var queue=player.getQueueList(),mutator=queue.createMutator();return mutator&&mutator.canRemove(index,length)==MutationResult.ALLOWED?(mutator.remove(index,length),mutator.apply()):MutationResult.FORBIDDEN}).then(function(result){return result==MutationResult.SUCCESS})},"*player_queue_tracks_clear":function(app,request){var args=request.args,playerId=args[0];return this._getPlayer(app,playerId).then(function(player){var queue=player.getQueueList(),mutator=queue.createMutator();return mutator&&mutator.canClear()==MutationResult.ALLOWED?(mutator.clear(),mutator.apply()):MutationResult.FORBIDDEN}).then(function(result){return result==MutationResult.SUCCESS})},"*player_play_queue_track":function(app,request){var args=(this._createPromise(),request.args),playerId=args[0],index=parseInt(args[1],10),reason=args[2]||"click-row";return this._getPlayer(app,playerId).then(function(player){var queue=player.getQueueList(),mutator=queue.createMutator();return mutator&&mutator.canMove(index,0,1)==MutationResult.ALLOWED?(mutator.move(index,0,1),Promise.join(player,mutator.apply())):Promise.join(player,MutationResult.FORBIDDEN)}).thenSpread(function(player,result){return result==MutationResult.SUCCESS?player.next(reason):!1})},"*context_playable_snapshot":function(app,request){var promise=this._createPromise(),args=request.args,descriptor=ItemList.Descriptor.fromObject(args[0]),offset=args[1],length=args[2];return descriptor?app.get("/resources/tracklistresolver").then(function(tlr){return tlr.resolve(descriptor)}).then(function(list){return list.snapshot(offset,length)}).then(SnapshotHelper.formatSnapshot):(promise.fail(new BridgeError.InvalidRequest("Invalid list descriptor.")),promise)},"*player_future_snapshot":function(app,request){var args=request.args,playerId=args[0];return this._getPlayer(app,playerId).then(function(player){return Promise.join(player,player.getContextState())}).thenSpread(function(player,state){var promises=[],track=player.getCurrentTrack(),queue=player.getQueueList();promises.push(queue.toArray());var context=player.getContextList(),rules=state.ruleset||{},index=-1;return context&&rules.indexing?(index=context.getRawIndex()+1,promises.push(context.snapshot(index,100))):promises.push(null),Promise.join(promises).thenSpread(function(queue,context){var tracks=[];track&&tracks.push({rowType:"current",track:track,index:0});var i,l;for(i=0,l=queue.length;l>i;i++)tracks.push({rowType:"queue",track:queue[i],index:i});if(context){var contextLength=context.getListLength(),contextTracks=context.toArray();for(i=0,l=contextTracks.length;l>i;i++)tracks.push({rowType:"context",track:contextTracks[i],index:(index+i)%contextLength})}return{rows:tracks}})})},end:!0});module.exports=PlayerResponder}()},{"../../shell/extension":73,"../../shell/lists":76,"../../shell/sublists":109,"../errors":42,"../responder":46,"../snapshothelper":60,"spotify-contextplayer/types":126,"spotify-promise":133}],53:[function(require,module,exports){!function(){"use strict";function generateID(){for(var numbers=new Array(11),l=numbers.length;l--;)numbers[l]=Math.floor(8*Math.random());var id=Spotify.Utils.Base62.toHex(numbers.join(""),16);return id}function PlaylistObserver(queue,listeners,opt_receiver){this._list=null,this._listeners=listeners,this._receiver=opt_receiver||null,this._queue=queue}var Link=Spotify.Link,LinkHelper=require("../../shell/extension").LinkHelper,Promise=require("spotify-promise"),BridgeError=require("../errors"),SnapshotHelper=require("../snapshothelper"),Entities=require("../../shell/entities"),ItemList=require("../../shell/lists"),SubItemList=require("../../shell/sublists"),Descriptor=ItemList.Descriptor,MutationResult=ItemList.MutationResult,slice=Array.prototype.slice,Responder=require("../responder");PlaylistObserver.prototype.sendEvents=function(events){events=Array.isArray(events)?events:slice.call(arguments);for(var _listeners=this._listeners,i=0,l=events.length;l>i;i++){var listeners=_listeners.splice(0),length=listeners.length;if(!length){var queue=this._queue;queue.push.apply(queue,events.slice(i));break}for(var x=0;length>x;x++)listeners[x].fulfill(events[i])}},PlaylistObserver.prototype.onBeforeMutate=function(snapshot){this._list=snapshot.toArray()},PlaylistObserver.prototype.onInvalidate=function(){this.sendEvents([{type:"invalidated",receiver:this._receiver}])},PlaylistObserver.prototype.onMutate=function(mutations){var receiver=this._receiver,events=[],list=this._list;if(null==list)return this;for(var i=0,l=mutations.length;l>i;i++){var begin,length,items,indices,x,y,event,mutation=mutations[i];switch(mutation.type){case"insert":begin=mutation.begin,length=mutation.items.length,items=mutation.items.map(function(e){return e.uri}),event={type:"insert",receiver:receiver,data:{index:begin,length:length,array:items},index:begin,uris:items};break;case"remove":for(begin=mutation.begin,length=mutation.length,items=[],indices=[],x=begin,y=begin+length;y>x;x++)indices.push(x),items.push(list[x].uri);event={type:"remove",receiver:receiver,data:{index:begin,length:length,array:items},indices:indices,index:begin,uris:items};break;case"move":begin=mutation.begin,length=mutation.length;var end=mutation.translated?mutation.end+1:mutation.end;for(items=[],indices=[],x=begin,y=begin+length;y>x;x++)indices.push(x),items.push(list[x].uri);event={type:"move",receiver:receiver,data:{indexFrom:begin,indexTo:end,length:length+1,array:items},indices:indices,indexFrom:begin,indexTo:end,index:"playlists"==receiver?mutation.begin:end,new_index:end,uris:items}}event&&events.push(event)}events.length&&this.sendEvents(events),this._list=null};var PlaylistResponder=Responder.build({init:function(){this._setReady()},_attachLibraryObservers:function(app,promise){var eventQueue=[],eventListeners=[promise],playlistObserver=new PlaylistObserver(eventQueue,eventListeners,"playlists"),publishedObserver=new PlaylistObserver(eventQueue,eventListeners,"published");Promise.join(app.get("/rootlist",null,{descriptor:new Descriptor.List("spotify:user:@:rootlist")}),app.get("/publishedrootlist",null,{descriptor:new Descriptor.List("spotify:user:@:publishedrootlist")})).thenSpread(function(rootlist,published){rootlist=rootlist.body.list.getRootBaseList(),published=published.body.list.getRootBaseList(),rootlist.observe(playlistObserver),published.observe(publishedObserver),app.addOnceListener("destroy",function(){rootlist.unobserve(playlistObserver),published.unobserve(publishedObserver)})}),app.setData("hasLibraryEventListeners",!0),app.setData("libraryEventQueue",eventQueue),app.setData("libraryEventListeners",eventListeners)},_attachPlaylistListeners:function(uri,app,promise){var eventQueue=[],eventListeners=[promise],playlistObserver=new PlaylistObserver(eventQueue,eventListeners),changeObserver=function(data){var payload={type:"change",data:{},uris:[],receiver:null};payload.data[data.property]=data.newValue,playlistObserver.sendEvents(payload)};app.setData("hasPlaylistEventListeners:"+uri,!0),app.setData("playlistEventQueue:"+uri,eventQueue),app.setData("playlistEventListeners:"+uri,eventListeners),Promise.join(app.get("/playlist",null,{uri:uri}),app.get("/playlist/tracks",null,{descriptor:new Descriptor.List(uri)})).thenSpread(function(playlist,list){playlist=playlist.body.result,list=list.body.list,playlist.addListener("change",changeObserver),list.observe(playlistObserver),app.addOnceListener("destroy",function(){playlist.removeListener("change",changeObserver),list.unobserve(playlistObserver)})})},_groupURIs:function(uris){for(var buckets={albums:[],artists:[],playlists:[],profiles:[],tracks:[]},i=0,l=uris.length;l>i;i++){var uri=LinkHelper.from(uris[i]);if(uri)switch(uri.type){case"album":buckets.albums.push(uri);break;case"artist":buckets.artists.push(uri);break;case"profile":buckets.profiles.push(uri);break;case"playlist":case"starred":case"user-toplist":case"user-top-tracks":buckets.playlists.push(uri);break;case"track":buckets.tracks.push(uri);break;default:continue}}return buckets},_rootlistInsert:function(app,rootlist,property,user,uris,position){return position=position||0,app.get("/session").then(function(sessionResponse){var session=sessionResponse.body.result;if("@"==user.username)return user.username=session.user.username,user;if(user.username==session.user.username)return user;throw new BridgeError.Forbidden("Cannot publish as another user.")}).then(function(user){return Promise.join(user,app.get("/playlists",null,{uris:uris}))}).thenSpread(function(user,playlistResponse){for(var playlists=playlistResponse.body.result,addable=[],i=0,l=uris.length;l>i;i++){var playlist=playlists[uris[i]];playlist&&!playlist[property]&&addable.push(new Entities.RootlistRow(playlist.uri,{added_by:user.username}))}return Promise.join([addable,app.get("/"+rootlist,null,{descriptor:new Descriptor.List(user)})])}).thenSpread(function(items,rootlistResponse){var rootlist=rootlistResponse.body.list;return items.length?rootlist.preload().then(function(){var mutator=rootlist.createMutator();return mutator.canInsert(position,items.length)==MutationResult.ALLOWED&&(mutator.insert(position,items),mutator.apply()),!0}):!0})},_rootlistRemove:function(app,rootlist,property,user,uris){return app.get("/session").then(function(sessionResponse){var session=sessionResponse.body.result;if("@"==user.username)return user.username=session.user.username,user;if(user.username==session.user.username)return user;throw new BridgeError.Forbidden("Cannot publish as another user.")}).then(function(user){return Promise.join(user,app.get("/playlists",null,{uris:uris}))}).thenSpread(function(user,playlistResponse){for(var playlists=playlistResponse.body.result,items=[],i=0,l=uris.length;l>i;i++){var playlist=playlists[uris[i]];playlist&&playlist[property]&&items.push(playlist.uri)}return Promise.join([items,app.get("/"+rootlist,null,{descriptor:new Descriptor.List(user)})])}).thenSpread(function(items,rootlistResponse){var list=new ItemList.Filtered(rootlistResponse.body.list,function(item){return!(!item||-1==items.indexOf(item.uri))});return items.length?list.getLength().then(function(length){var mutator=list.createMutator();return mutator.canRemove(0,length)==MutationResult.ALLOWED?(mutator.remove(0,length),mutator.apply()):!0}).then(function(result){return result==MutationResult.SUCCESS}):!0})},_ensureDescriptor:function(value){return"string"==typeof value?{type:"list",uri:value}:value},"*library_publish":function(app,request){var args=request.args,uri=args[1];return app.update("/rootlist/row",null,{rowURI:uri,attributes:{"public":!0}}).then(function(response){return!0})},"*library_unpublish":function(app,request){var args=request.args,uri=args[1];return app.update("/rootlist/row",null,{rowURI:uri,attributes:{"public":!1}}).then(function(response){return!0})},"*library_star":function(app,request){var tracks=request.args.slice(1);return request.args=[new Descriptor.List("spotify:user:@:starred")].concat(tracks),this._request("playlist_tracks_append",request,app)},"*library_unstar":function(app,request){var self=this,args=request.args,user=LinkHelper.from(args[0]),uris=this._groupURIs(args.slice(1)).tracks;return user?app.get("/session").then(function(sessionResponse){var session=sessionResponse.body.result;if("@"==user.username)return user.username=session.user.username,user;if(user.username==session.user.username)return user;throw new BridgeError.Forbidden("Cannot publish as another user.")}).then(function(user){return Promise.join(user,app.get("/tracks",{flush:!0},{uris:uris}))}).thenSpread(function(user,trackResponse){for(var tracks=trackResponse.body.result,items=[],i=0,l=uris.length;l>i;i++){var track=tracks[uris[i]];track&&track.starred&&items.push(track.uri)}return Promise.join([items,user,app.get("/starredlist",null,{descriptor:new Descriptor.List(user)})])}).thenSpread(function(items,user,rootlistResponse){if(!items.length)return!0;var list=new ItemList.Filtered(rootlistResponse.body.list,function(item){return!(!item||-1==items.indexOf(item.uri))});return list.getLength().then(function(length){for(var promises=[],i=0;length>i;i++)promises.push(list.translateIndex(i));return Promise.join(user,Promise.join(promises))})}).thenSpread(function(user,indices){if(!Array.isArray(indices))return indices;for(var args=[],i=0,l=indices.length;l>i;i++)args.push(indices[i],"spotify:empty");return args.unshift(Link.starredLink(user.username).toString()),self._request("playlist_tracks_remove",{args:args},app)}):new BridgeError.InvalidRequest("Invalid user.")},"*library_subscribe":function(app,request){var self=this,args=request.args,user=LinkHelper.from(args[0]),uris=this._groupURIs(args.slice(1));return user?this._rootlistInsert(app,"rootlist","subscribed",user,uris.playlists).then(function(result){return Promise.join(result,app.get("/session").get("body").get("result"))}).thenSpread(function(result,session){return result&&session.publishPlaylists?self._request("library_publish",request,app).then(function(e){return e}):result}):new BridgeError.InvalidRequest("Invalid user.")},"*library_unsubscribe":function(app,request){var self=this,args=request.args,user=LinkHelper.from(args[0]),uris=this._groupURIs(args.slice(1));return user?this._rootlistRemove(app,"rootlist","subscribed",user,uris.playlists).then(function(result){return result?self._request("library_unpublish",request,app):result}):new BridgeError.InvalidRequest("Invalid user.")},"*library_event_wait":function(app,request){var promise=this._createPromise();if(app.getData("hasLibraryEventListeners")){var queue=app.getData("libraryEventQueue");if(queue.length)promise.fulfill(queue.shift());else{var listeners=app.getData("libraryEventListeners");listeners.push(promise)}}else this._attachLibraryObservers(app,promise);return promise},"*library_playlists_snapshot":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),offset=args[1]||0,length=void 0==args[2]?-1:args[2];return app.get("/rootlist",null,{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*library_playlists_insert":function(app,request){var args=request.args,user=LinkHelper.from(args[0]),index=args[1],uri=(args[2],args[3]);return user?this._rootlistInsert(app,"rootlist","subscribed",user,[uri],index).then(function(result){return result?app.get("/playlist",null,{uri:uri}):!1}).then(function(result){if(!result)return result;var playlist=result.body.result;return playlist.subscribed=!0,playlist.emit("change",{property:"subscribed",newValue:!0,oldValue:!1}),!0}):new BridgeError.InvalidRequest("Invalid user.")},"*library_playlists_move":function(app,request){var args=request.args,user=this._ensureDescriptor(args[0]),toIndex=args[1],fromIndex=args[2];args[3];return app.get("/rootlist",null,{descriptor:user}).then(function(response){var list=response.body.list,mutator=list.createMutator();if(mutator.setTranslated(!0),mutator.canMove(fromIndex,toIndex,1)==MutationResult.ALLOWED)return mutator.move(fromIndex,toIndex,1),mutator.apply();throw new BridgeError.Forbidden("Cannot move playlist")}).then(function(result){return result==MutationResult.SUCCESS})},"*library_published_snapshot":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),offset=args[1]||0,length=void 0==args[2]?-1:args[2];return app.get("/publishedrootlist",null,{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*playlist_create":function(app,request){return app.create("/playlist",null,{name:request.args[0]}).then(function(response){return{uri:response.body.uri}})},"*playlist_create_temporary":function(app,request){var promise=this._createPromise(),appId=app.getId(),name=request.args[0],uri=Link.temporaryPlaylistLink(appId,encodeURIComponent(name));return app.getData(uri)?(promise.fail(new BridgeError.InvalidRequest("Playlist already created.")),promise):app.create("/playlist/temporary",null,{name:name,uri:uri.toString()}).then(function(response){var metadata=response.body.result;return app.setData(uri,response.body.list),app.setData("playlist-metadata:"+uri.toString(),metadata),metadata})},"*playlist_enforce_rules":function(app,request){var args=request.args,uri=args[0],map=app.getData("ruleMap",{});return map||(map={},app.setData("ruleMap",map)),map[uri]=args[1],!0},"*playlist_event_wait":function(app,request){var self=this,promise=this._createPromise(),uri=request.args[0];return app.get("/playlist/uri",null,{uri:uri}).then(function(response){var uri=response.body.result;if(app.getData("hasPlaylistEventListeners:"+uri)){var queue=app.getData("playlistEventQueue:"+uri);if(queue.length)promise.fulfill(queue.shift());else{var listeners=app.getData("playlistEventListeners:"+uri);listeners.push(promise)}}else self._attachPlaylistListeners(uri,app,promise)}),promise},"*playlist_metadata":function(app,request){var args=request.args,uri=args[0];return app.get("/playlist",null,{uri:uri}).then(function(response){var playlist=response.body.result;return playlist})},"*playlist_popularity":function(app,request){var uri=request.args[0];return app.get("/playlist/popularity",null,{uri:uri}).then(function(response){return{popularity:response.body.result}})},"*playlist_profile":function(app,request){var uri=request.args[0];return app.get("/playlist/mosaic",{},{uri:uri}).then(function(response){return response.body})},"*playlist_remove_temporary":function(app,request){var promise=this._createPromise(),appId=app.getId(),name=request.args[0],uri=Link.temporaryPlaylistLink(appId,encodeURIComponent(name));return app.getData(uri)?app.remove("/playlist/temporary",null,{name:name,uri:uri.toString()}).then(function(response){return app.setData(uri,null),app.setData("playlist-metadata:"+uri.toString(),null),!0}):(promise.fail(new BridgeError.InvalidRequest("Playlist does not exist.")),promise)},"*playlist_restricted":function(app,request){var args=request.args,uri=args[0];return app.get("/playlist",null,{uri:uri}).then(function(response){return{ownedByCurrentUser:!!response.body.result.ownedByCurrentUser}})},"*playlist_set_name":function(app,request){var args=request.args,uri=args[0],name=args[1];return app.update("/playlist",null,{uri:uri,attributes:{name:name}}).then(function(){return!0})},"*playlist_set_collaborative":function(app,request){var args=request.args,uri=args[0],value=args[1];return app.update("/playlist",null,{uri:uri,attributes:{collaborative:value}}).then(function(){return!0})},"*playlist_subscribers_snapshot":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),offset=args[1]||0,length=void 0==args[2]?-1:args[2];return app.get("/playlist/subscribers",null,{uri:descriptor.uri}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*playlist_tracks_append":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]);return app.get("/session").then(function(response){for(var session=response.body.result,tracks=[],timestamp=(new Date).getTime(),i=1,l=args.length;l>i;i++){var track=args[i];tracks.push(new Entities.PlaylistRow(track,{added_by:session.user.username,timestamp:timestamp,track:track}))}return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return list instanceof SubItemList.Mappable&&(list=list.getBaseList()),Promise.join(list,list.ensureMutated(),list.preload())}).thenSpread(function(list){var trackList=list.getBaseListType(SubItemList.PlaylistTrackDecorator),mutator=trackList.getBatchedMutator();if(mutator&&mutator.canAdd(tracks.length)==MutationResult.ALLOWED)return mutator.add(tracks),trackList.applyBatchedMutator();throw new BridgeError.Forbidden("Cannot add tracks to playlist.")}).then(function(result){return result==MutationResult.SUCCESS})})},"*playlist_tracks_clear":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]);return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return Promise.join(list,list.preload())}).thenSpread(function(list){return Promise.join(list,list.getLength())}).thenSpread(function(list,length){var mutator=list.createMutator();if(mutator&&mutator.canRemove(0,length)==MutationResult.ALLOWED)return mutator.remove(0,length),mutator.apply();throw new BridgeError.Forbidden("Cannot clear playlist.")}).then(function(result){return result==MutationResult.SUCCESS})},"*playlist_tracks_insert":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),index=args[1];args[2];return app.get("/session").then(function(response){for(var session=response.body.result,tracks=[],timestamp=(new Date).getTime(),i=3,l=args.length;l>i;i++){var track=args[i];tracks.push(new Entities.PlaylistRow(track,{added_by:session.user.username,timestamp:timestamp,track:track}))}return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return Promise.join(list,list.preload())}).thenSpread(function(list){var mutator=list.createMutator();if(mutator&&mutator.canInsert(index,tracks.length)==MutationResult.ALLOWED)return mutator.insert(index,tracks),mutator.apply();throw new BridgeError.Forbidden("Cannot insert into playlist.")}).then(function(result){return result==MutationResult.SUCCESS})})},"*playlist_tracks_move":function(app,request){var promise=this._createPromise(),args=request.args,descriptor=this._ensureDescriptor(args[0]),indexTo=args[1],indices=args.slice(3);return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return list instanceof SubItemList.Mappable&&(list=list.getBaseList()),Promise.join(list,list.ensureMutated(),list.preload())}).thenSpread(function(list){var mutator=list.getBatchedMutator();if(!mutator)throw new BridgeError.Forbidden("Cannot move tracks in playlist.");mutator.setTranslated(!0);for(var i=0,l=indices.length;l>i;i++)if(!(i%2)){var indexFrom=indices[i];if(mutator.canMove(indexFrom,indexTo,1)!=MutationResult.ALLOWED)throw new BridgeError.Forbidden("Cannot move tracks in playlist.");mutator.move(indexFrom,indexTo,1),++indexTo}return list.applyBatchedMutator()}).then(function(result){promise.fulfill(result==MutationResult.SUCCESS)},function(error){promise.fulfill(!1)}),promise},"*playlist_tracks_remove":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),indices=args.slice(1);return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return list instanceof SubItemList.Mappable&&(list=list.getBaseList()),Promise.join(list,list.ensureMutated(),list.preload())}).thenSpread(function(list){var trackList=list.getBaseListType(SubItemList.PlaylistTrackDecorator),requiresIndexTranslation=trackList!=list,mutator=trackList.getBatchedMutator();if(!mutator)throw new BridgeError.Forbidden("Cannot move tracks in playlist.");mutator.setTranslated(!0);var i,l,g,indexFrom;if(requiresIndexTranslation){var promises=[];for(i=0,l=indices.length,g=0;l>i;i++)i%2||(indexFrom=indices[i]-g,promises.push(list.translateIndex(indexFrom).then(function(i){if(mutator.canRemove(i,1)!=MutationResult.ALLOWED)throw new BridgeError.Forbidden("Cannot remove tracks from playlist.");mutator.remove(i,1)})),g++);return Promise.join(promises).then(function(){return trackList.applyBatchedMutator()})}for(i=0,l=indices.length,g=0;l>i;i++)if(!(i%2)){if(indexFrom=indices[i]-g,mutator.canRemove(indexFrom,1)!=MutationResult.ALLOWED)throw new BridgeError.Forbidden("Cannot remove tracks from playlist.");mutator.remove(indexFrom,1),g++}return trackList.applyBatchedMutator()}).then(function(result){return result==MutationResult.SUCCESS})},"*playlist_tracks_trim":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),indexFrom=args[1];return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(function(serviceResponse){var list=serviceResponse.body.list;return Promise.join(list,list.preload())}).thenSpread(function(list){return Promise.join(list,list.getLength())}).thenSpread(function(list,length){var removeLength=length-indexFrom,mutator=list.createMutator();if(mutator&&mutator.canRemove(indexFrom,removeLength)==MutationResult.ALLOWED)return mutator.remove(indexFrom,removeLength),mutator.apply();throw new BridgeError.Forbidden("Cannot trim playlist.")}).then(function(result){return result==MutationResult.SUCCESS})},"*playlist_tracks_snapshot":function(app,request){var args=request.args,descriptor=this._ensureDescriptor(args[0]),offset=args[1]||0,length=void 0==args[2]?-1:args[2];return app.get("/playlist/tracks",null,{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatTrackRowSnapshot)},"*playlist_folder_set_name":function(app,request){var uri=request.args[0],name=request.args[1];if(!name)throw new BridgeError.InvalidRequest("Name cannot be blank.");return app.get("/rootlist",null,{descriptor:Descriptor.List("spotify:user:@")}).then(function(response){var originalList=response.body.list,list=new ItemList.Filtered(originalList,function(item){return item.uri.toString()==uri.toString()});return Promise.join(originalList,list,list.snapshot(0,-1))}).thenSpread(function(originalList,list,snapshot){return 2!=snapshot.getListLength()?!1:Promise.join(snapshot.get(0),originalList,list.translateIndex(0))}).thenSpread(function(item,list,index){if(!list)return!1;var encodedName=Spotify.Link.encodeComponent(name,Spotify.Link.Format.URI),parts=item.rawURI.split(":");parts.pop(),parts.push(encodedName);
var rawURI=parts.join(":"),mutator=list.createMutator();return mutator.canRemove(index,1)!=MutationResult.ALLOWED||mutator.canInsert(index,1)!=MutationResult.ALLOWED?!1:(mutator.remove(index,1),mutator.insert(index,[new Entities.RootlistRow(item.uri,{folder:!0,name:name,start:!0,rawURI:rawURI})]),mutator.apply())}).then(function(result){return result==MutationResult.SUCCESS})},"*playlist_folder_remove":function(app,request){var uri=request.args[0];return app.get("/rootlist",null,{descriptor:Descriptor.List("spotify:user:@")}).then(function(response){var originalList=response.body.list,list=new ItemList.Filtered(originalList,function(item){return item.uri.toString()==uri.toString()});return Promise.join(originalList,list,list.snapshot(0,-1))}).thenSpread(function(originalList,list,snapshot){return 2!=snapshot.getListLength()?!1:Promise.join(originalList,list.translateIndex(0),list.translateIndex(1))}).thenSpread(function(list,startIndex,endIndex){if(!list)return!1;var mutator=list.createMutator();return mutator.canRemove(endIndex,1)!=MutationResult.ALLOWED?!1:(mutator.remove(endIndex,1),mutator.canRemove(startIndex,1)!=MutationResult.ALLOWED?!1:(mutator.remove(startIndex,1),mutator.apply()))}).then(function(result){return result==MutationResult.SUCCESS})},"*playlist_folder_insert":function(app,request){var name=request.args[0],index=request.args[1]||0;if(!name)throw new BridgeError.InvalidRequest("Name cannot be blank.");return app.get("/session").then(function(sessionResponse){var session=sessionResponse.body.result;return Promise.join(session.user.username,app.get("/rootlist",{},{descriptor:new Descriptor.List("spotify:user:@")}).access("body","list"))}).thenSpread(function(user,list){var id=generateID(),encodedName=Spotify.Link.encodeComponent(name,Spotify.Link.Format.URI),folderURI=Spotify.Link.folderLink(user,id).toString(),items=[new Entities.RootlistRow(folderURI,{folder:!0,name:name,start:!0,rawURI:"spotify:start-group:"+id+":"+encodedName}),new Entities.RootlistRow(folderURI,{folder:!0,name:name,start:!0,rawURI:"spotify:end-group:"+id})],mutator=list.createMutator();return mutator.canInsert(index,2)==MutationResult.ALLOWED?(mutator.insert(index,items),Promise.join(mutator.apply(),list)):!1}).thenSpread(function(result,list){var success=result==MutationResult.SUCCESS;return success&&list.getRootBaseList().invalidate(),success})}});module.exports=PlaylistResponder}()},{"../../shell/entities":63,"../../shell/extension":73,"../../shell/lists":76,"../../shell/sublists":109,"../errors":42,"../responder":46,"../snapshothelper":60,"spotify-promise":133}],54:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,Events=Spotify.Events,Responder=require("../responder"),RelationsResponder=Responder.build({_ready:!1,_listeners:[],_events:new Events,init:function(core){var service=this.service=core.socialGraph;service.bind(this._events.RELATIONS_SUBSCRIBE,this.addSubscriptions,this,0),service.bind(this._events.RELATIONS_UNSUBSCRIBE,this.removeSubscriptions,this,0),service.bind(this._events.RELATIONS_DISMISS,this.addDismissed,this,0),service.bind(this._events.RELATIONS_UNDISMISS,this.removeDismissed,this,0),service.bind(this._events.RELATIONS_BLOCK,this.addBlocked,this,0),service.bind(this._events.RELATIONS_UNBLOCK,this.removeBlocked,this,0),service.onReady(this.start,this)},start:function(){this._setReady(),this.service.preloadCurrentUserRelations()},addSubscriptions:function(args){this.modifyRelations("add",args.params.users,"subscriptions",function(user){return user.subscribed=!0,user})},removeSubscriptions:function(args){this.modifyRelations("remove",args.params.users,"subscriptions",function(user){return user.subscribed=!1,user})},addDismissed:function(args){this.modifyRelations("add",args.params.users,"dismissed",function(user){return user.dismissed=!0,user})},removeDismissed:function(args){this.modifyRelations("remove",args.params.users,"dismissed",function(user){return user.dismissed=!1,user})},addBlocked:function(args){this.modifyRelations("add",args.params.users,"blocked",function(user){return user.blocked=!0,user})},removeBlocked:function(args){this.modifyRelations("remove",args.params.users,"blocked",function(user){return user.blocked=!1,user})},modifyRelations:function(type,users,receiver,modifyUser){for(var uris=[],i=0,max=users.length;max>i;i++){var profileLink=Link.profileLink(users[i]),user=this.retrieve(profileLink,"parsed.metadata");user&&(user=modifyUser(user),this.store(profileLink,"parsed.metadata",user)),uris.push(profileLink.toString())}this.notifyListeners(type,receiver,uris)},request:function(type,data,reply){var args=data.args,uri=this._extractListURI(data.args[0]),user=uri?Link.fromString(uri).username:null,offset=data.args[1],length=data.args[2];"@"===user&&(user=null),this.service[type](user,length,offset,this.reply.bind(this,reply,args),this.handleError.bind(this,reply))},modify:function(type,data,reply){for(var args=data.args,users=[],i=0,len=args.length;len>i;i++){var username=Link.fromString(args[i]).username;"@"!==username&&users.push(username)}this.service[type](users,this.modifyReply.bind(this,reply,args),this.handleError.bind(this,reply))},reply:function(reply,args,items){var uris=[],users=items[0].users,length=items[0].length;if(users)for(var i=0,l=users.length;l>i;i++)uris.push(Link.profileLink(users[i].username).toString());var payload=this.createSnapshot(args,uris,length);reply.send(payload)},modifyReply:function(reply,args,items){reply.send({})},handleError:function(reply,code){var type,message;switch(code.code){case 404:type="not-found",message="No relation found.";break;default:type="transient",message="Possible issues with the socialgraph service."}return reply.fail(type,message)},notifyListeners:function(type,receiver,uris){for(var payload={type:type,receiver:receiver,uris:uris};this._listeners.length>0;)this._listeners.pop().send(payload);return this},"@relations_event_wait":function(data,reply){this._listeners.push(reply.persist())},"@relations_subscribers_users_snapshot":function(data,reply){this.request("getSubscribers",data,reply)},"@relations_subscriptions_users_snapshot":function(data,reply){this.request("getSubscriptions",data,reply)},"@relations_blocked_users_snapshot":function(data,reply){this.request("getBlocked",data,reply)},"@relations_dismissed_users_snapshot":function(data,reply){this.request("getDismissed",data,reply)},"@relations_hidden_users_snapshot":function(data,reply){this.request("getHidden",data,reply)},"@relations_block":function(data,reply){this.modify("block",data,reply)},"@relations_unblock":function(data,reply){this.modify("unblock",data,reply)},"@relations_dismiss":function(data,reply){this.modify("dismiss",data,reply)},"@relations_undismiss":function(data,reply){this.modify("undismiss",data,reply)},"@relations_subscribe":function(data,reply){this.modify("subscribeTo",data,reply)},"@relations_unsubscribe":function(data,reply){this.modify("unsubscribeFrom",data,reply)}});module.exports=RelationsResponder}()},{"../responder":46}],55:[function(require,module,exports){!function(){"use strict";var Responder=require("../responder"),RuntimeResponder=Responder.build({_ready:!1,init:function(core,publisher){this.getAppUrl=publisher.getAppUrl,this.start()},start:function(){this._setReady()},"@core_request_lookup":function(data,reply){reply.send(Responder.respondsTo(data.args[0]))},"@application_require":function(data,reply){reply.send("http://origin.spapps.keeto.d.spotify.net/"+data.args[0]+"/")}});module.exports=RuntimeResponder}()},{"../responder":46}],56:[function(require,module,exports){!function(){"use strict";var BridgeError=require("../errors"),Responder=require("../responder"),SnapshotHelper=require("../snapshothelper"),SearchResponder=Responder.build({_ready:!1,init:function(){this.start()},start:function(){this._setReady()},_searchSnapshot:function(type,app,request){var args=request.args,descriptor=args[0],offset=args[1],length=args[2];return app.get("/search/"+type,{flush:!0},{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot).catchError(function(error){if(error.domain&&9==error.domain&&1==error.code)throw new BridgeError.RateLimited("Cannot perform search");throw new BridgeError.Transient("Search service issues")})},"*search_albums_snapshot":function(app,request){return this._searchSnapshot("albums",app,request)},"*search_artists_snapshot":function(app,request){return this._searchSnapshot("artists",app,request)},"*search_fuzzy_match":function(app,request){var query=request.args[0],parseFuzzy=function(response){return{fuzzyMatch:response.body.match}};return app.get("/search/fuzzymatch",{},{query:query}).then(parseFuzzy,parseFuzzy)},"*search_playlists_snapshot":function(app,request){return this._searchSnapshot("playlists",app,request)},"*search_tracks_snapshot":function(app,request){return this._searchSnapshot("tracks",app,request)}});module.exports=SearchResponder}()},{"../errors":42,"../responder":46,"../snapshothelper":60}],57:[function(require,module,exports){!function(){"use strict";var BridgeError=(require("../sourceurls"),require("../errors")),Responder=require("../responder"),SuggestResponder=Responder.build({_ready:!0,"*suggest_albums_snapshot":function(app,request){return this._handleSuggestRequest("albums",app,request)},"*suggest_tracks_snapshot":function(app,request){return this._handleSuggestRequest("tracks",app,request)},"*suggest_artists_snapshot":function(app,request){return this._handleSuggestRequest("artists",app,request)},"*suggest_playlists_snapshot":function(app,request){return this._handleSuggestRequest("playlists",app,request)},_handleSuggestRequest:function(type,app,request){var uri=this._extractListURI(request.args[0]),self=this;if(!uri)throw new BridgeError.InvalidRequest("Invalid URI");return uri=uri.toString().replace("suggest","search"),app.get("/suggest/"+type,{flush:!0},{uri:uri}).then(function(response){var parsed=self._addMetadata(response.body.list);return self.createSnapshot(request.args,parsed.array,parsed.total,parsed.metadata)}).catchError(function(err){throw new BridgeError.Transient("Search service issues")})},_addMetadata:function(result){for(var array=[],i=0;i<result.length;i++)array.push(result[i].uri);return{total:array.length,array:array,metadata:result}}});module.exports=SuggestResponder}()},{"../errors":42,"../responder":46,"../sourceurls":61}],58:[function(require,module,exports){!function(){"use strict";var SnapshotHelper=require("../snapshothelper"),Responder=require("../responder"),ToplistResponder=Responder.build({_ready:!0,"*toplist_user_snapshot":function(app,request){var descriptor=request.args[0],offset=request.args[1],length=request.args[2];return app.get("/toplist/user",null,{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*toplist_user_albums_snapshot":"toplist_user_snapshot","*toplist_user_artists_snapshot":"toplist_user_snapshot","*toplist_user_tracks_snapshot":"toplist_user_snapshot","*toplist_user_playlists_snapshot":"toplist_user_snapshot","*toplist_region_snapshot":function(app,request){var descriptor=request.args[0],offset=request.args[1],length=request.args[2];return app.get("/toplist/region",null,{descriptor:descriptor}).then(SnapshotHelper.createListSnapshotter(offset,length)).then(SnapshotHelper.formatSnapshot)},"*toplist_region_albums_snapshot":"toplist_region_snapshot","*toplist_region_artists_snapshot":"toplist_region_snapshot","*toplist_region_tracks_snapshot":"toplist_region_snapshot","*toplist_region_playlists_snapshot":"toplist_region_snapshot","*toplist_artist_tracks_snapshot":"artist_top_tracks_snapshot"});module.exports=ToplistResponder}()},{"../responder":46,"../snapshothelper":60}],59:[function(require,module,exports){!function(){"use strict";var Responder=require("../responder"),UserResponder=Responder.build({_ready:!0,"*session_query":function(app,request){return app.get("/session").then(function(response){var session=response.body.result;return session._username=session.user.username,session._publishPlaylists=session.publishPlaylists,session})},"**session_query_nocache":function(app,request){return app.get("/session").then(function(response){var session=response.body.result;return session._username=session.user.username,session._publishPlaylists=session.publishPlaylists,session})},"*session_test_group":function(app,request){return app.get("/session").then(function(response){var session=response.body.result;return app.get("/user/groupid",{},{username:session.user.username,salt:request.args[0]})}).then(function(response){var result={testGroup:response.body.id};return result})},"*user_set_attribute":function(app,request){var args=request.args;return app.update("/user/attribute",null,{key:args[0],value:args[1]}).then(function(response){return response.body})},"*session_event_wait":function(app,request){},"*user_metadata":function(app,request){return app.get("/profile",null,{uri:request.args[0]}).then(function(response){return response.body.result})},"*user_associated_artist":function(app,request){return app.get("/profile/associatedartist",null,{uri:request.args[0]}).then(function(response){return{artist:response.body.result}})},"*artist_associated_user":function(app,request){return app.get("/profile/associateduser",null,{uri:request.args[0]}).then(function(response){return{user:response.body.result}})}});module.exports=UserResponder}()},{"../responder":46}],60:[function(require,module,exports){!function(){"use strict";function clone(obj){var _tmp={};for(var name in obj)_tmp[name]=obj[name];return _tmp}var ItemList=require("../shell/lists"),SnapshotHelper={};SnapshotHelper.createListSnapshotter=function(offset,length){return function(response){return response.body.list.snapshot(offset,length)}},SnapshotHelper.createBaseListSnapshotter=function(offset,length){return function(response){return response.body.list.getRootBaseList().snapshot(offset,length)}},SnapshotHelper.formatSnapshot=function(snapshot){for(var uris=[],items=[],length=snapshot.getLength(),i=0;length>i;i++){var item=snapshot.get(i);item&&item!=ItemList.NULL_VALUE&&(uris.push(item.uri),items.push(item))}var result={range:{offset:snapshot.getOffset(),length:length},length:snapshot.getListLength(),array:uris,metadata:items};return result},SnapshotHelper.formatTrackRowSnapshot=function(snapshot){for(var uris=[],items=[],length=snapshot.getLength(),i=0;length>i;i++){var item=snapshot.get(i);if(item&&item!=ItemList.NULL_VALUE)if(uris.push(item.uri),item.track){var track=clone(item.track);track.dateAdded=Math.floor(item.addTime/1e3),track.addedBy=item.addedBy,items.push(track)}else items.push({uri:item.uri})}var result={range:{offset:snapshot.getOffset(),length:length},length:snapshot.getListLength(),array:uris,metadata:items};return result},SnapshotHelper.formatArraySnapshot=function(snapshot){var items=snapshot.toArray(),result={range:{offset:snapshot.getOffset(),length:snapshot.getLength()},length:snapshot.getListLength(),array:items};return result},SnapshotHelper.formatMetadataSnapshot=function(snapshot){var items=snapshot.toArray(),length=items.length,uris=new Array(length).join("|").split("|"),result={range:{offset:snapshot.getOffset(),length:snapshot.getLength()},length:snapshot.getListLength(),array:uris,metadata:items};return result},module.exports=SnapshotHelper}()},{"../shell/lists":76}],61:[function(require,module,exports){"use strict";module.exports={unbranded:"https://d3rt1990lpmkn.cloudfront.net/unbranded/",tiny:"https://d3rt1990lpmkn.cloudfront.net/60/",normal:"https://d3rt1990lpmkn.cloudfront.net/300/",small:"https://d3rt1990lpmkn.cloudfront.net/120/",large:"https://d3rt1990lpmkn.cloudfront.net/640/",avatar:"https://d3rt1990lpmkn.cloudfront.net/artist_image/"}},{}],62:[function(require,module,exports){!function(){"use strict";function MethodRequestMap(){this._handlers={}}function shallowCopy(obj){function F(){}return"object"!=typeof obj?obj:(F.prototype=obj,new F)}function DispatcherRequest(method,path,headers,body){if(!(this instanceof DispatcherRequest))return new DispatcherRequest(method,path,headers,body);if(!method)throw new TypeError("DispatcherRequest: Argument `method` missing.");if(!path)throw new TypeError("DispatcherRequest: Argument `path` missing.");this.method=method,this.path=path,this.headers=headers?shallowCopy(headers):{},this.body=body?shallowCopy(body):{}}function DispatcherResponse(status,headers,body){return this instanceof DispatcherResponse?(this.status=ResponseStatus.OK,this.statusText=ResponseStatusText[200],this.headers={},this.body={},void 0!=status&&this.setStatus(status),void 0!=headers&&this.setHeaders(headers),void(void 0!=body&&this.setBody(body))):new DispatcherResponse(status,header,body)}function Dispatcher(){return this instanceof Dispatcher?(this._handlers=new MethodRequestMap,this._requestSenders={},void Queueable.call(this,["request"])):new Dispatcher}var RequestResponseHeader,RequestResponseBody,RequestPath,RequestHandler,RequestHandlerMap,RequestSender,Promise=require("spotify-promise"),Queueable=require("spotify-queueable"),inherit=require("spotify-inheritance/inherit"),ResponseStatus={OK:200,CREATED:201,ACCEPTED:202,MULTIPLE_CHOICES:300,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,TIMED_OUT:408,CONFLICT:409,GONE:410,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503},ResponseStatusText={200:"Ok",201:"Created",202:"Accepted",400:"Bad Request",401:"Unauthorized",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",408:"Timed Out",409:"Conflict",410:"Gone",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable"},RequestMethod={CREATE:"CREATE",FLUSH:"FLUSH",GET:"GET",REMOVE:"REMOVE",UPDATE:"UPDATE"};MethodRequestMap.prototype.get=function(method,path){var handlers=this._handlers;method=method.toString().toUpperCase();var methodHandlers=handlers[method];return methodHandlers?methodHandlers[path]||null:null},MethodRequestMap.prototype.set=function(method,route,handler){var handlers=this._handlers;method=method.toString().toUpperCase();var methodHandlers=handlers[method]||(handlers[method]={});return methodHandlers[route]=handler,this},MethodRequestMap.prototype.remove=function(method,route,handler){var handlers=this._handlers;method=method.toString().toUpperCase();var methodHandlers=handlers[method];if(!methodHandlers)return null;var _handler=methodHandlers[route];return _handler?(_handler==handler&&(methodHandlers[route]=null),this):this},DispatcherResponse.prototype.setStatus=function(status){return this.status=status,this.statusText=ResponseStatusText[status],this},DispatcherResponse.prototype.setHeader=function(key,value){return this.headers[key]=value,this},DispatcherResponse.prototype.setHeaders=function(headers){for(var key in headers)this.headers[key]=headers[key];return this},DispatcherResponse.prototype.setBodyField=function(key,value){return this.body[key]=value,this},DispatcherResponse.prototype.setBodyFields=function(fields){var body=this.body;for(var key in fields)fields.hasOwnProperty(key)&&(body[key]=fields[key]);return this},DispatcherResponse.prototype.setBody=function(body){if(!body||"object"!=typeof body||Array.isArray(body))throw new Error("DispatcherResponse.setBody: `body` must be an object.");return this.body=body,this},inherit(Dispatcher,Queueable),Dispatcher.prototype.setReady=function(){return this._setReady(),this},Dispatcher.prototype.register=function(method,path,handler){return this._handlers.set(method,path,handler),this},Dispatcher.prototype.createRequestSender=function(method,path){var self=this,senders=this._requestSenders,key=method+" "+path;return senders[key]||(senders[key]=function(headers,body){return self.request(method,path,headers,body)})},Dispatcher.prototype.request=function(method,path,headers,body){var promise=new Promise;method=(method||"").toString().toUpperCase(),path=path||"/";var handler=this._handlers.get(method,path);if(handler){var request=new DispatcherRequest(method,path,headers,body);try{var maybePromise=handler.call(null,request,this);maybePromise.pipe?maybePromise.pipe(promise):maybePromise instanceof DispatcherResponse?maybePromise.status>=ResponseStatus.OK&&maybePromise.status<ResponseStatus.MULTIPLE_CHOICES?promise.fulfill(maybePromise):promise.fail(maybePromise):promise.fulfill(maybePromise)}catch(e){promise.fail(e)}}else promise.fail(new DispatcherResponse(ResponseStatus.NOT_IMPLEMENTED));return promise},Dispatcher.prototype.create=function(path,headers,body){return this.request(RequestMethod.CREATE,path,headers,body)},Dispatcher.prototype.get=function(path,headers,body){return this.request(RequestMethod.GET,path,headers,body)},Dispatcher.prototype.flush=function(path,headers,body){return this.request(RequestMethod.FLUSH,path,headers,body)},Dispatcher.prototype.remove=function(path,headers,body){return this.request(RequestMethod.REMOVE,path,headers,body)},Dispatcher.prototype.update=function(path,headers,body){return this.request(RequestMethod.UPDATE,path,headers,body)},module.exports={ResponseStatus:ResponseStatus,ResponseStatusText:ResponseStatusText,RequestMethod:RequestMethod,RequestResponseHeader:RequestResponseHeader,RequestResponseBody:RequestResponseBody,RequestPath:RequestPath,RequestHandler:RequestHandler,RequestHandlerMap:RequestHandlerMap,RequestSender:RequestSender,MethodRequestMap:MethodRequestMap,DispatcherRequest:DispatcherRequest,DispatcherResponse:DispatcherResponse,Dispatcher:Dispatcher}}()},{"spotify-inheritance/inherit":131,"spotify-promise":133,"spotify-queueable":40}],63:[function(require,module,exports){!function(){"use strict";var extend=require("spotify-inheritance/extend"),Entities=extend({},require("./entities/playlist"),require("./entities/search"),require("./entities/track"),{Base:require("./entities/base"),Album:require("./entities/album"),Artist:require("./entities/artist"),Profile:require("./entities/profile"),Session:require("./entities/session")});module.exports=Entities}()},{"./entities/album":64,"./entities/artist":65,"./entities/base":66,"./entities/playlist":68,"./entities/profile":69,"./entities/search":70,"./entities/session":71,"./entities/track":72,"spotify-inheritance/extend":129}],64:[function(require,module,exports){!function(){"use strict";function Album(uri,data){if(!(this instanceof Album))return new Album(uri,data);data=data||{},this.uri=uri.toString(),this.availability=data.availability,this.date=data.date||{},this.label=data.label,this.name=data.name,this.playable=data.playable,this.popularity=data.popularity,this.type=(data.type||"").toLowerCase();var artistData=this._parseArtists(data.artist);this.artists=artistData.entities,this.artistName=artistData.name;var covers=data.cover_group&&data.cover_group.image;if(covers){var generatedImage=ImageSet.create(covers,data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images,this.imageLargest=generatedImage.imageLargest}else this.image=null,this.images=[],this.imageLargest=null;this.discs=this._parseDiscs(data.disc),this.copyrights=this._parseCopyrights(data.copyright)}var Link=Spotify.Link,Promise=require("spotify-promise"),ImageSet=require("./image");Album.prototype._parseArtists=function(artistData){var artists=[],artistName=[];if(artistData&&artistData.length)for(var i=0,l=artistData.length;l>i;i++){var artist=artistData[i];artists.push({uri:Link.artistLink(artist.id).toString(),name:artist.name}),artistName.push(artist.name)}return{entities:artists,name:artistName.join(", ")}},Album.prototype._parseCopyrights=function(copyrightData){var copyrights=[];if(copyrightData)for(var i=0,l=copyrightData.length;l>i;i++){var copyright=copyrightData[i];copyrights[i]=copyright.text.replace(/^(\([A-Z]+\))?(.*)$/,function(match,copy,rest){return copy?match:"("+copyright.type+") "+rest})}return copyrights},Album.prototype._parseDiscs=function(discsData){var discs=[];if(discsData)for(var uri=Link.fromString(this.uri),i=0,l=discsData.length;l>i;i++){var disc=discsData[i];uri.disc=disc.number;for(var tracks=[],x=0,y=disc.track.length;y>x;x++)tracks.push(Link.trackLink(disc.track[x].id).toString());var discFormatted={album:this.uri,number:disc.number,trackURIs:tracks,uri:uri.toString()};discs.push(discFormatted)}return discs},Album.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new Album(uri,data))}catch(e){promise.fail(e)}return promise},Album.createComparator=function(field,order){return null},Album.createPredicate=function(field,operator,matcher){return null},module.exports=Album}()},{"./image":67,"spotify-promise":133}],65:[function(require,module,exports){!function(){"use strict";function Artist(uri,data){if(!(this instanceof Artist))return new Artist(uri,data);data=data||{},this.uri=uri.toString();this.name=data.name,this.popularity=data.popularity,this.genres=data.genre?data.genre.slice():[];var covers=data.portrait_group&&data.portrait_group.image;if(covers){var generatedImage=ImageSet.create(covers,data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images,this.imageLargest=generatedImage.imageLargest}else this.image=null,this.images=[],this.imageLargest=null;var biography=this._parseBiography(data.biography,data.resourceUrl);this.biography=biography.text,this.portraits=biography.portraits,this.years=this._parseYear(data.activity_period),this.getAlbumGroups=this.getAlbumGroups.bind(this,data),this.getAppearsOnGroups=this.getAppearsOnGroups.bind(this,data),this.getSingleGroups=this.getSingleGroups.bind(this,data),this.getRelatedArtists=this.getRelatedArtists.bind(this,data),this.getTopTracks=this.getTopTracks.bind(this,data)}var Link=Spotify.Link,Promise=require("spotify-promise"),ImageSet=require("./image");Artist.prototype._parseBiography=function(biographies,resourceUrl){var text="",portraitImages=[];if(biographies&&biographies.length)for(var len=biographies.length;len--;){var biography=biographies[len];if(biography.text&&(text=biography.text),biography.portrait_group)for(var portraits=biography.portrait_group,i=0,l=portraits.length;l>i;i++){var portrait=portraits[i]&&portraits[i].image;if(portrait){var image=ImageSet.create(portrait,resourceUrl);image.image&&portraitImages.push(image.image)}}}return{text:text,portraits:portraitImages}},Artist.prototype._parseYear=function(activityPeriod){var years=null;if(activityPeriod&&activityPeriod.length){for(var activity=[],x=0,y=activityPeriod.length;y>x;x++){var period=activityPeriod[x],start=period.start_year||period.decade,end=period.end_year||period.decade+9;isNaN(end)&&(end=(new Date).getFullYear()),activity.push({start:start,end:end})}activity.length&&(years={from:activity[0].start,to:activity[activity.length-1].end})}return years},Artist.prototype.getAlbumGroups=function(data){var group,albumGroups=[],albumGroupData=data.album_group;if(albumGroupData&&albumGroupData.length)for(var i=0,l=albumGroupData.length;l>i;i++){var albumGroup=albumGroupData[i];group=[];for(var x=0,y=albumGroup.length;y>x;x++)albumGroup[x].playable&&group.push({uri:Link.albumLink(albumGroup[x].id).toURI()});group.length&&albumGroups.push({albums:group})}return albumGroups},Artist.prototype.getAppearsOnGroups=function(data){var group,appearsOnGroups=[],appearsOnGroupData=data.appears_on_group;if(appearsOnGroupData&&appearsOnGroupData.length)for(var i=0,l=appearsOnGroupData.length;l>i;i++){var appearsOnGroup=appearsOnGroupData[i];group=[];for(var x=0,y=appearsOnGroup.length;y>x;x++)appearsOnGroup[x].playable&&group.push({uri:Link.albumLink(appearsOnGroup[x].id).toURI()});group.length&&appearsOnGroups.push({albums:group})}return appearsOnGroups},Artist.prototype.getSingleGroups=function(data){var group,singleGroups=[],singleGroupData=data.single_group;if(singleGroupData&&singleGroupData.length)for(var i=0,l=singleGroupData.length;l>i;i++){var singleGroup=singleGroupData[i];group=[];for(var x=0,y=singleGroup.length;y>x;x++)singleGroup[x].playable&&group.push({uri:Link.albumLink(singleGroup[x].id).toURI()});group.length&&singleGroups.push({albums:group})}return singleGroups},Artist.prototype.getRelatedArtists=function(data){var relatedArtistUris=[],relatedData=data.related;if(relatedData&&relatedData.length)for(var i=0,l=relatedData.length;l>i;i++)relatedArtistUris.push(Link.artistLink(relatedData[i].id).toURI());return relatedArtistUris},Artist.prototype.getTopTracks=function(data){var toptrackUris=[],toptracksData=data.top_track;if(toptracksData&&toptracksData.length)for(var i=0,l=toptracksData.length;l>i;i++)toptrackUris.push(Link.trackLink(toptracksData[i].id).toURI());return toptrackUris},Artist.create=function(uri,data){var promise=new Promise;return promise.fulfill(new Artist(uri,data)),promise},Artist.createComparator=function(field,order){},Artist.createPredicate=function(field,operator,matcher){},module.exports=Artist}()},{"./image":67,"spotify-promise":133}],66:[function(require,module,exports){!function(){"use strict";function BaseEntity(uri){return this instanceof BaseEntity?(EventEmitter.call(this),void(this.uri=uri.toString())):new BaseEntity(uri)}var inherit=require("spotify-inheritance/inherit"),EventEmitter=require("spotify-eventemitter");inherit(BaseEntity,EventEmitter),module.exports=BaseEntity}()},{"spotify-eventemitter":128,"spotify-inheritance/inherit":131}],67:[function(require,module,exports){!function(){"use strict";function ImageSet(mainImage,images){return this instanceof ImageSet?(this.image=mainImage,this.images=images,this.imageLargest=mainImage,void(images.length&&(this.imageLargest=images[images.length-1][1]))):new ImageSet(uri,data)}var Hex=require("spotify-crypto").Hex;ImageSet.create=function(resources,base){base=base||"";for(var image=null,images=[],i=0,l=resources.length;l>i;i++){var resource=resources[i];if(resource.file_id){var url=base+Hex.fromString(resource.file_id);images.push([Math.min(resource.width,resource.height),url]),image||"default"!=resource.size.toLowerCase()||(image=url)}}return!image&&images.length&&(image=images[0][1]),images.sort(function(a,b){return a[0]-b[0]}),new ImageSet(image,images)},ImageSet.createSearch=function(resources,base){base=base||"";for(var image=null,images=[],sizes={small:120,large:640,"default":300},i=0,l=resources.length;l>i;i++){var resource=resources[i];if(resource.file_id){var url=base+resource.file_id;images.push([sizes[resource.size.toLowerCase()],url]),image||"default"!=resource.size.toLowerCase()||(image=url)}}return!image&&images.length&&(image=images[0][1]),images.sort(function(a,b){return a[0]-b[0]}),new ImageSet(image,images)},ImageSet.createProfile=function(resources,base){base=base||"";var image=null,images=[];resources.image&&images.push([50,resources.image]),resources.imageLarge&&images.push([180,resources.imageLarge]);for(var i=0,l=images.length;l>i;i++){var match=images[i][1].match(/^spotify:image:(.+)/);match&&(images[i][1]=base+match[1])}return images.length&&(image=images[0][1]),new ImageSet(image,images)},module.exports=ImageSet}()},{"spotify-crypto":33}],68:[function(require,module,exports){!function(){"use strict";function Playlist(uri,data){if(!(this instanceof Playlist))return new Playlist(uri,data);BaseEntity.call(this,uri),data=data||{},this.allows={"delete":!1,editDescription:!1,insertTracks:!1,moveTracks:!1,removeTracks:!1,rename:!1},this.name=data.name,this.ownerName=data.owner,this.owner={uri:data.owner?Link.profileLink(data.owner).toString():null},this.folder=!1,this.collaborative=!!data.collaborative,this.description=data.description||"",this.subscribed=!1,this.published=!1;var picture=data.picture;if(picture){try{picture=decodeURIComponent(picture)}catch(e){}var covers=[{size:"default",width:300,height:300,file_id:picture}],generatedImage=ImageSet.create(covers,data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images}else this.image=null,this.images=null}function RootlistRow(uri,data){
return this instanceof RootlistRow?(data=data||{},this.uri=uri.toString(),this.addedBy={uri:Link.profileLink(data.added_by||"@").toString()},this["public"]=!!data["public"],this.folder=!!data.folder,void(this.folder?(this.rawURI=data.rawURI,this.start=!!data.start,this.name=data.name):(this.rawURI=null,this.start=!1,this.name=null))):new RootlistRow(uri,data)}function PlaylistRow(uri,data){return this instanceof PlaylistRow?(data=data||{},this.uri=uri.toString(),this.uid="uid"in data?data.uid.toString():"-1",this.addedBy={uri:Link.profileLink(data.added_by||"@").toString()},this.creator=data.added_by?Link.profileLink(data.added_by):null,this.addTime=data.timestamp,void(this.track=data.track||{uri:this.uri})):new PlaylistRow(uri,data)}var PlaylistData,PlaylistRowData,inherit=require("spotify-inheritance/inherit"),Link=Spotify.Link,Promise=require("spotify-promise"),ItemList=require("../lists"),Comparators=ItemList.Comparators,Predicates=ItemList.Predicates,ImageSet=require("./image"),BaseEntity=require("./base");inherit(Playlist,BaseEntity),Playlist.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new Playlist(uri,data))}catch(e){promise.fail(e)}return promise},Playlist.prototype.createComparator=function(field,order){return null},Playlist.prototype.createPredicate=function(field,operator,matcher){return null},PlaylistRow.prototype.setTrack=function(track){this.track=track},PlaylistRow.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new PlaylistRow(uri,data))}catch(e){promise.fail(e)}return promise},PlaylistRow.createComparator=function(field,order){switch(field){case"uri":case"creator":return"desc"==order?Comparators.forStringPropertyReversed(field):Comparators.forStringProperty(field);case"addTime":return"desc"==order?Comparators.forNumberPropertyReversed(field):Comparators.forNumberProperty(field);default:var comparator=Entities.Track.createComparator(field,order);if(comparator)return function(a,b){return comparator(a&&a.track,b&&b.track)}}return null},PlaylistRow.createPredicate=function(field,operator,matcher){switch(field){case"uri":case"creator":case"addTime":return Predicates.forPropertyOperator(field,operator,matcher);default:var predicate=Entities.Track.createPredicate(field,operator,matcher);if(predicate)return function(a){return predicate(a&&a.track)}}return null},module.exports={PlaylistData:PlaylistData,PlaylistRowData:PlaylistRowData,Playlist:Playlist,RootlistRow:RootlistRow,PlaylistRow:PlaylistRow}}()},{"../lists":76,"./base":66,"./image":67,"spotify-inheritance/inherit":131,"spotify-promise":133}],69:[function(require,module,exports){!function(){"use strict";function Profile(uri,data){if(!(this instanceof Profile))return new Profile(uri,data);if(data=data||{},this.uri=uri.toString(),this.username=data.username,this.name=data.full_name||data.username,this.currentUser=!1,this.subscribed=!1,this.image=null,this.images=null,this.identifier="",data.image_url||data.large_image_url){var generatedImage=ImageSet.createProfile({image:data.image_url,imageLarge:data.large_image_url},data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images,this.imageLargest=generatedImage.imageLargest}else this.image=null,this.images=[],this.imageLargest=null}var Promise=require("spotify-promise"),ImageSet=require("./image");Profile.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new Profile(uri,data))}catch(e){promise.fail(e)}return promise},module.exports=Profile}()},{"./image":67,"spotify-promise":133}],70:[function(require,module,exports){!function(){"use strict";function SearchAlbum(uri,data){return this instanceof SearchAlbum?(this.uri=uri.toString(),void(data&&this._fill(data))):new SearchAlbum(uri,data)}function SearchArtist(uri,data){return this instanceof SearchArtist?(this.uri=uri.toString(),void(data&&this._fill(data))):new SearchArtist(uri,data)}function SearchPlaylist(uri,data){return this instanceof SearchPlaylist?(this.uri=uri.toString(),void(data&&this._fill(data))):new SearchPlaylist(uri,data)}function SearchTrack(uri,data){return this instanceof SearchTrack?(this.uri=uri.toString(),void(data&&this._fill(data))):new SearchTrack(uri,data)}var Link=Spotify.Link,ImageSet=(require("spotify-promise"),require("./image"));SearchAlbum.prototype._fill=function(data){var i,l;this.artistName="",this.artists=[],this.availability=data.availability,this.image=void 0,this.images=[],this.name=data.name,this.playable=data.playable,this.popularity=data.popularity,this.type=(data.type||"").toLowerCase();var artistData=data.artists,artists=this.artists,artistName=[];if(this.artistName="",artistData&&artistData.length){for(i=0,l=artistData.length;l>i;i++){var artist=artistData[i];artists.push({uri:Link.artistLink(artist.id).toString(),name:artist.name}),artistName.push(artist.name)}this.artistName=artistName.join(";")}var cover=data.cover;if(cover){var generatedImage=ImageSet.createSearch(cover,data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images}},SearchArtist.prototype._fill=function(data){this.availability=data.availability,this.image=null,this.images=[],this.name=data.name,this.playable=data.playable,this.popularity=data.popularity;var cover=data.portrait;if(cover){var generatedImage=ImageSet.createSearch(cover,data.resourceUrl);this.image=generatedImage.image,this.images=generatedImage.images}},SearchPlaylist.prototype._fill=function(data){this.image=void 0,this.images=[],this.name=data.name,this.owner_name=data.owner,this.owner={uri:Link.profileLink(data.owner).toString()};var cover=data.image;if(cover){var id,images=this.images;id=cover.split(":").splice(2,cover.length-1).join("");var image=this.image=data.resourceUrls.normal+id;images.push([300,image]),cover=data["image-large"],cover&&(id=cover.split(":").splice(2,cover.length-1).join(""),images.push([640,data.resourceUrl.large+id])),cover=data["image-small"],cover&&(id=cover.split(":").splice(2,cover.length-1).join(""),images.push([120,data.resourceUrl.small+id]))}},SearchTrack.prototype._fill=function(data){this._pid=this.playableId=data.playableId,this.availability=data.availability,this.duration=data.length,this.explicit=!!data.explicit,this.local=!1,this.name=data.name,this.playable=data.playable,this.playableURI=Link.trackLink(this._pid),this.popularity=data.popularity;var albumData=data.album,album=this.album={};if(albumData){this.albumUri=album.uri=Link.albumLink(albumData.id).toString(),this.albumName=album.name=albumData.name;var albumArtists=album.artists=[],albumArtistsData=albumData.artists;if(albumArtistsData&&albumArtistsData.length)for(i=0,l=albumArtistsData.length;l>i;i++){var albumArtist=albumArtistsData[i];albumArtists.push({uri:Link.artistLink(albumArtist.id).toString(),name:albumArtist.name})}var cover=albumData.cover;if(cover){var generatedImage=ImageSet.createSearch(cover,data.resourceUrl);this.image=album.image=generatedImage.image,this.images=album.images=generatedImage.images}}var artistData=data.artist||data.artists,artists=this.artists=[],artistName=[];if(this.artistName="",artistData&&artistData.length){for(var i=0,l=artistData.length;l>i;i++){var artist=artistData[i];artists.push({uri:Link.artistLink(artist.id).toString(),name:artist.name}),artistName.push(artist.name)}this.artistName=artistName.join(";")}},module.exports={SearchAlbum:SearchAlbum,SearchArtist:SearchArtist,SearchPlaylist:SearchPlaylist,SearchTrack:SearchTrack}}()},{"./image":67,"spotify-promise":133}],71:[function(require,module,exports){!function(){"use strict";function Session(data){return this instanceof Session?(data=data||{},this.ads=data.ads,this.catalogue=data.catalogue,this.country=data.country,this.device="web",this.online=!0,this.preferredLocale=data.preferred_locale,this.product=data.product,this.testGroup=data.ab_test_group,Object.defineProperty(this,"user",{value:{uri:Link.profileLink(data.user).toString(),username:data.user}}),this.appDeveloper=this.developer="app_developer"in data&&"0"!=data.app_developer,this.postOpenGraph=data.post_open_graph,this.publicToplist="public_toplist"in data&&"0"!=data.public_toplist,this.publishActivity="publish_activity"in data&&"1"==data.publish_activity,this.publishFacebook="publish_facebook"in data&&"1"==data.publish_facebook,this.publishPlaylists="publish_playlist"in data&&"1"==data.publish_playlist,void(this.productState={"license-agreements":data.license_agreements,"wanted-licenses":data.wanted_licenses})):new Session(data)}var Link=Spotify.Link,Promise=require("spotify-promise");Session.create=function(data){var promise=new Promise;try{promise.fulfill(new Session(data))}catch(e){promise.fail(e)}return promise},module.exports=Session}()},{"spotify-promise":133}],72:[function(require,module,exports){!function(){"use strict";function Track(uri,data){if(!(this instanceof Track))return new Track(uri,data);data=data||{},this.uri=uri.toString(),this._pid=this.playableId=data.playableId,this.playableURI=Link.trackLink(this._pid),this.name=data.name,this.disc=void 0==data.disc_number?data.disc_number:parseInt(data.disc_number,10),this.duration=data.duration,this.local=!1,this.number=void 0==data.number?data.number:parseInt(data.number,10),this.popularity=data.popularity,this.availability=data.availability,this.playable=data.playable,this.starred=data.starred,this.explicit=!!data.explicit,this.advertisement=!!data.ad,this.fileId=this._parseFileId(data.file),this.seen=!0;var albumData=this._parseAlbum(data.album,data.resourceUrl);this.album=albumData.entity,this.albumUri=this.album.uri,this.albumName=this.album.name;var images=albumData.images;this.image=images.image,this.images=images.images,this.imageLargest=images.imageLargest;var artistData=this._parseArtist(data.artist);this.artists=artistData.entities,this.artistName=artistData.name,this.previewURI=this._parsePreview(data.preview)}function LocalTrack(uri){return this instanceof LocalTrack?(this.uri=uri.toString(),void this._parseData(uri)):new LocalTrack(uri)}function AdTrack(uri,data){return this instanceof AdTrack?(this.uri=uri.toString(),void(data&&this._parseData(data))):new AdTrack(uri)}var TrackData,inherit=require("spotify-inheritance/inherit"),Link=Spotify.Link,Promise=require("spotify-promise"),ItemList=require("../lists"),Comparators=ItemList.Comparators,Predicates=ItemList.Predicates,ImageSet=require("./image"),Hex=require("spotify-crypto").Hex;Track.prototype._parseFileId=function(file){var fileId=null;if(file)for(var i=0,l=file.length;l>i;i++){var c=file[i];if("MP3_160_ENC"===c.format){fileId=Hex.fromString(c.file_id);break}}return fileId},Track.prototype._parseAlbum=function(albumData,resourceUrl){var album={},images={image:null,images:[],imageLargest:null};if(albumData){album.uri=Link.albumLink(albumData.id).toString(),album.name=albumData.name;var covers=albumData.cover_group&&albumData.cover_group.image;if(covers){var generatedImage=ImageSet.create(covers,resourceUrl);images.image=generatedImage.image,images.images=generatedImage.images,images.imageLargest=generatedImage.imageLargest}}return{entity:album,images:images}},Track.prototype._parsePreview=function(previews){var uri=null;if(previews&&previews.length)for(var x=0,y=previews.length;y>x;x++){var preview=previews[x];preview&&"MP3_96"==preview.format&&(uri=Link.audioFileLink("mp3",Hex.fromString(preview.file_id)))}return uri},Track.prototype._parseArtist=function(artistData){var artists=[],artistName=[];if(artistData&&artistData.length)for(var i=0,l=artistData.length;l>i;i++){var artist=artistData[i];artists.push({uri:Link.artistLink(artist.id).toString(),name:artist.name}),artistName.push(artist.name)}return{entities:artists,name:artistName.join(", ")}},Track.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new Track(uri,data))}catch(e){promise.fail(e)}return promise},Track.createComparator=function(field,order){switch(field){case"uri":case"name":return"desc"!=order?Comparators.forStringProperty(field):Comparators.forStringPropertyReversed(field);case"disc":case"duration":case"number":case"popularity":case"seen":case"starred":return"desc"!=order?Comparators.forNumberProperty(field):Comparators.forNumberPropertyReversed(field);case"artists.name":return"desc"!=order?Comparators.forStringProperty("artistName"):Comparators.forStringPropertyReversed("artistName");case"album.name":return"desc"!=order?Comparators.forStringProperty("albumName"):Comparators.forStringPropertyReversed("albumName")}return null},Track.createPredicate=function(field,operator,matcher){switch(field){case"uri":case"name":case"disc":case"duration":case"number":case"popularity":case"seen":case"starred":return Predicates.forPropertyOperator(field,operator,matcher);case"artists.name":return Predicates.forPropertyOperator("artistName",operator,matcher);case"album.name":return Predicates.forPropertyOperator("albumName",operator,matcher)}return null},inherit(LocalTrack,Track),LocalTrack.prototype._parseData=function(uri){var albumUri=Link.localAlbumLink(uri.artist,uri.album).toURI(),artistUri=Link.localArtistLink(uri.artist).toURI();this.name=uri.track||"",this.duration=isNaN(uri.duration)?-1:1e3*(uri.duration||0),this.cover="",this.local=!0,this.playable=!1,this.album={uri:albumUri,artists:[{uri:artistUri,name:uri.artist||""}],name:uri.album||""},this.artists=[{uri:artistUri,name:uri.artist||""}]},inherit(AdTrack,Track),AdTrack.create=function(uri,data){var promise=new Promise;try{promise.fulfill(new AdTrack(uri,data))}catch(e){promise.fail(e)}return promise},AdTrack.prototype._parseData=function(data){for(var name in data)this[name]=data[name];this._pid=this.playableId=data.__pid,this.playableURI=Link.adLink(this._pid)},module.exports={TrackData:TrackData,Track:Track,LocalTrack:LocalTrack,AdTrack:AdTrack}}()},{"../lists":76,"./image":67,"spotify-crypto":33,"spotify-inheritance/inherit":131,"spotify-promise":133}],73:[function(require,module,exports){!function(){"use strict";var toString=Object.prototype.toString,Link=Spotify.Link;Array.isArray||(Array.isArray=function(obj){return"[object Array]"==toString.call(obj)}),Array.prototype.spliceWith||Object.defineProperty(Array.prototype,"spliceWith",{configurable:!0,enumerable:!1,writeable:!0,value:function(index,howMany,array){var hasArray=void 0!=array;return hasArray?(Array.isArray(array)||(array=[array]),this.splice.apply(this,[index,howMany].concat(array))):this.splice(index,howMany)}}),Array.prototype.insertFrom||Object.defineProperty(Array.prototype,"insertFrom",{configurable:!0,enumerable:!1,writeable:!0,value:function(index,array){if(void 0==array)return this;Array.isArray(array)||(array=[array]);for(var len=array.length;len--;)this[len+index]=array[len];return this}});var ClassLike,LinkHelper={};LinkHelper.LinkLike,LinkHelper.from=function(value){try{return value instanceof Link?value:"object"==typeof value&&value.type?new Link(null,value):Link.fromString(value.toString())}catch(e){return null}},LinkHelper.clone=function(link){return link instanceof Link?new Spotify.Link(null,link):null},module.exports={LinkHelper:LinkHelper,ClassLike:ClassLike}}()},{}],74:[function(require,module,exports){"use strict";var extend=require("spotify-inheritance/extend");module.exports={Reactors:require("./reactors"),ItemList:extend({},require("spotify-bridge/src/shell/lists"),require("spotify-bridge/src/shell/sublists")),Spirc:require("./spirc"),TrackListResolver:require("./tracklistresolver"),ItemListManager:require("./listmanager"),Dispatcher:require("./dispatcher")}},{"./dispatcher":62,"./listmanager":75,"./reactors":96,"./spirc":108,"./tracklistresolver":119,"spotify-bridge/src/shell/lists":76,"spotify-bridge/src/shell/sublists":109,"spotify-inheritance/extend":129}],75:[function(require,module,exports){!function(){"use strict";function ItemListManager(){this._baseLists={},this._cache=new SimpleCache(100)}var SimpleCache=(require("./extension").LinkHelper,Spotify.SimpleCache),ItemList=require("./lists"),Descriptor=ItemList.Descriptor;ItemListManager.prototype._retrieveList=function(descriptor){var result=null,list=null,cache=this._cache,serialized=descriptor.serialize(),cached=cache.get(serialized);if(cached)return cached;try{switch(descriptor.type){case"list":return this._baseLists[descriptor.uri]||null;case"concatenate":for(var lists=[],i=0,l=descriptor.lists.length;l>i;i++){if(list=this._retrieveList(descriptor.lists[i]),!list)return null;lists.push(list)}result=new ItemList.Concatenated(lists),result.setDescriptor(descriptor),cache.put(serialized,result);break;case"sort":if(list=this._retrieveList(descriptor.list),!list)return null;for(var comparators=[],i=0;i<descriptor.params.length;++i){var param=descriptor.params[i],comparator=list.createComparator(param.field,param.order);if(!comparator)return null;comparators.push(comparator)}if(0==comparators.length)return null;var comparator=Comparators.forComparators(comparators);result=new ItemList.Sorted(list,comparator),result.setDescriptor(descriptor),cache.put(serialized,result);break;case"filter":if(list=this._retrieveList(descriptor.list),!list)return null;var predicate=list.createPredicate(descriptor.field,descriptor.operator,descriptor.matcher);if(!predicate)return null;result=new ItemList.Filtered(list,predicate),result.setDescriptor(descriptor),cache.put(serialized,result);break;case"range":if(list=this._retrieveList(descriptor.list),!list)return null;result=new ItemList.Ranged(list,descriptor.offset,descriptor.length),result.setDescriptor(descriptor),cache.put(serialized,result)}return result}catch(e){return result}},ItemListManager.prototype.get=function(descriptor){return descriptor=Descriptor.fromObject(descriptor),descriptor?this._retrieveList(descriptor):null},ItemListManager.prototype.set=function(descriptor,list){return null==list?this.unset(descriptor):(descriptor=Descriptor.extractList(descriptor))?(list.setDescriptor(descriptor),this._baseLists[descriptor.uri]=list,!0):!1},ItemListManager.prototype.unset=function(descriptor){return(descriptor=Descriptor.extractList(descriptor))?(this._baseLists[descriptor.uri]=void 0,!0):!1},module.exports=ItemListManager}()},{"./extension":73,"./lists":76}],76:[function(require,module,exports){!function(){"use strict";var extend=require("spotify-inheritance/extend"),ItemList=extend({},require("./lists/core"),require("./lists/comparators"),require("./lists/predicates"),require("./lists/mutator"),{Snapshot:require("./lists/snapshot"),Descriptor:require("./lists/descriptor"),Base:require("./lists/base"),Array:require("./lists/array"),Concatenated:require("./lists/concatenated"),Layered:require("./lists/layered"),Ranged:require("./lists/ranged"),Sorted:require("./lists/sorted"),Filtered:require("./lists/filtered"),Iterable:require("./lists/iterable"),Property:require("./lists/property")});module.exports=ItemList}()},{"./lists/array":77,"./lists/base":78,"./lists/comparators":79,"./lists/concatenated":80,"./lists/core":81,"./lists/descriptor":82,"./lists/filtered":83,"./lists/iterable":84,"./lists/layered":85,"./lists/mutator":86,"./lists/predicates":87,"./lists/property":88,"./lists/ranged":89,"./lists/snapshot":90,"./lists/sorted":91,"spotify-inheritance/extend":129}],77:[function(require,module,exports){!function(){"use strict";function ArrayItemList(array,base){return this instanceof ArrayItemList?(BaseItemList.call(this,base),void this.fillFullFromArray(array||[])):new ArrayItemList(array,base)}var inherit=require("spotify-inheritance/inherit"),BaseItemList=require("./base");inherit(ArrayItemList,BaseItemList),module.exports=ArrayItemList}()},{"./base":78,"spotify-inheritance/inherit":131}],78:[function(require,module,exports){!function(){"use strict";function BaseItemList(base){return this instanceof BaseItemList?(this._base=base||null,this._descriptor=null,this._list=[],this._length=null,this._loadLimit=200,this._loadedRanges=[],this._loadedState=LoadedState.UNLOADED,this._observers=[],this._ruleset=new MutationRuleset,this._snapshotLimit=1e3,this._snapshotQueue=[],this._waiting=[],this._isMutating=!1,void(this._version=0)):new BaseItemList(base)}var Promise=require("spotify-promise"),Range=require("../range"),Comparators=require("./comparators").Comparators,Predicates=require("./predicates").Predicates,ItemList=require("./core"),LoadedState=require("./core").LoadedState,MutatorModule=require("./mutator"),MutationRuleset=MutatorModule.MutationRuleset,MutationResult=MutatorModule.MutationResult,Mutator=MutatorModule.Mutator,Snapshot=require("./snapshot");BaseItemList.prototype.setDescriptor=function(descriptor){return this._descriptor=descriptor,this},BaseItemList.prototype.getDescriptor=function(){return this._descriptor},BaseItemList.prototype.setRuleset=function(ruleset){return this._ruleset=ruleset,this},BaseItemList.prototype.makeMutable=function(){this._ruleset=new MutationRuleset},BaseItemList.prototype.makeImmutable=function(){return this._ruleset=new MutationRuleset.Immutable,this},BaseItemList.prototype.getVersion=function(){return this._version},BaseItemList.prototype.getBaseList=function(){return this._base||null},BaseItemList.prototype.getRootBaseList=function(){if(!this._base)return this;for(var base=this,value=this;base=base._base;)value=base;return value},BaseItemList.prototype.getBaseListType=function(Type){if(!this._base)return this instanceof Type?this:null;var base=this;do if(base instanceof Type)return base;while(base=base._base);return null},BaseItemList.prototype.layersList=function(list){if(!this._base)return this==list;var base=this;do if(base==list)return!0;while(base=base._base);return!1},BaseItemList.prototype.layersListType=function(Type){if(!this._base)return this instanceof Type;var base=this;do if(base instanceof Type)return!0;while(base=base._base);return!1},BaseItemList.prototype.translateIndex=function(index){return this.getLength().then(function(length){return 0>index||index>length?ItemList.OUT_OF_BOUNDS:index})},BaseItemList.prototype.translateIndexFromBase=function(index){return this.getLength().then(function(length){return 0>index||index>length?ItemList.OUT_OF_BOUNDS:index})},BaseItemList.prototype.createComparator=function(field,order){return"asc"==order?Comparators.forString():Comparators.forStringReversed()},BaseItemList.prototype.createPredicate=function(field,operator,opt_matcher){return Predicates.forNotNull()},BaseItemList.prototype.observe=function(itemlist){return this._observers.push(itemlist),this},BaseItemList.prototype.unobserve=function(itemlist){var index=this._observers.indexOf(itemlist);return-1!=index&&this._observers.splice(index,1),this},BaseItemList.prototype.notify=function(type,data){for(var observers=this._observers.slice(0),i=0,l=observers.length;l>i;i++){var observer=observers[i],fn=observer[type];fn&&fn.call(observer,data,this)}for(var waiting=this._waiting.splice(0),len=waiting.length;len--;)waiting[len].fulfill(this);return this},BaseItemList.prototype.onBeforeMutate=function(){},BaseItemList.prototype.onMutate=function(){},BaseItemList.prototype.onInvalidate=function(){},BaseItemList.prototype.ensureMutated=function(){var promise=new Promise;return this._isMutating?(this._waiting.push(promise),promise):(promise.fulfill(this),promise)},BaseItemList.prototype.invalidate=function(){this.notify("onInvalidate")},BaseItemList.prototype.createMutator=function(){if(this._loadedState!=LoadedState.COMPLETE)return null;var applicator=this._createMutationApplicator(),comparator=this._createVersionComparator(),ruleset=this._ruleset;return new Mutator(applicator,comparator,ruleset,this._version,this._length)},BaseItemList.prototype._createMutationApplicator=function(){var self=this;return function(version,mutations){var promise=new Promise;if(self._version!=version)return promise.fulfill(MutationResult.EXPIRED),promise;self.notify("onBeforeMutate",new Snapshot(self._version,self._createVersionedAccessor(),new Range(0,self._length),self._length)),self._isMutating=!0;for(var bubbledMutations=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i],mutationApplied=null;switch(mutation.type){case"insert":mutationApplied=self._applyInsertMutation(mutation);break;case"remove":mutationApplied=self._applyRemoveMutation(mutation);break;case"move":mutationApplied=self._applyMoveMutation(mutation)}mutationApplied&&bubbledMutations.push(mutationApplied)}return self._version++,self._isMutating=!1,self.notify("onMutate",bubbledMutations),promise.fulfill(MutationResult.SUCCESS),promise}},BaseItemList.prototype._applyInsertMutation=function(mutation){var begin=mutation.begin,items=mutation.items,list=this._list;return list.spliceWith(begin,0,items),this._length+=items.length,mutation},BaseItemList.prototype._applyRemoveMutation=function(mutation){var begin=mutation.begin,length=mutation.length,list=this._list;list.splice(begin,length);return this._length-=length,mutation},BaseItemList.prototype._applyMoveMutation=function(mutation){var begin=mutation.begin,end=mutation.end,length=mutation.length,list=this._list,items=list.splice(begin,length);return list.spliceWith(end,0,items),mutation},BaseItemList.prototype._unqueueSnapshots=function(){for(var queue=this._snapshotQueue.splice(0),i=0,l=queue.length;l>i;i++){var queued=queue[i];this.snapshot(queued[0],queued[1]).pipe(queued[2])}},BaseItemList.prototype._queueSnapshot=function(offset,length,promise){return this._snapshotQueue.push([offset,length,promise]),this},BaseItemList.prototype._fill=function(range){var state=this._loadedState,loadLimit=this._loadLimit,promise=new Promise;if(state==LoadedState.COMPLETE)promise.fulfill(this);else{var flooredBegin=Math.floor(range.begin*(1/loadLimit))*loadLimit,flooredEnd=Math.ceil(range.last*(1/loadLimit))*loadLimit;range=new Range(flooredBegin,flooredEnd-flooredBegin);for(var ranges=range.subtractMany(this._loadedRanges),chunks=[],x=0,y=ranges.length;y>x;x++)chunks.push.apply(chunks,ranges[x].split(loadLimit));if(!chunks.length)return promise.fulfill(this),promise;for(var promises=[],i=0,l=chunks.length;l>i;i++)promises.push(this._load(chunks[i]).then(this._insertLoadedData.bind(this)));Promise.join(promises).pipe(promise)}return promise},BaseItemList.prototype._insertLoadedData=function(loadedData){var list=this._list,range=loadedData.range;return list.insertFrom(range.begin,loadedData.items),this._updateRanges(range),this._updateState(),loadedData},BaseItemList.prototype._updateRanges=function(range){var loadedRanges=this._loadedRanges;loadedRanges.push(range),this._loadedRanges=loadedRanges=Range.simplify(loadedRanges)},BaseItemList.prototype._updateRemovedRanges=function(range){this._loadedRanges=Range.splice(range,this._loadedRanges)},BaseItemList.prototype._updateState=function(){var loadedRanges=this._loadedRanges;1==loadedRanges.length&&loadedRanges[0].length>=this._length?this._loadedState=LoadedState.COMPLETE:this._loadedState=LoadedState.PARTIAL},BaseItemList.prototype._load=function(range){var promise=new Promise;return promise.fulfill({state:LoadedState.COMPLETE,range:new Range(0,0),items:[]}),promise},BaseItemList.prototype._loadLength=function(){var promise=new Promise,listLength=this._length=0;return promise.fulfill({length:listLength}),promise},BaseItemList.prototype.fillFromArray=function(items,fullLength,range){this._list.spliceWith(range.begin,range.length,items),this._length=fullLength;var loadedRanges=this._loadedRanges;loadedRanges.push(range),this._loadedRanges=loadedRanges=Range.simplify(loadedRanges),1==loadedRanges.length&&loadedRanges[0].length==fullLength?this._loadedState=LoadedState.COMPLETE:this._loadedState=LoadedState.PARTIAL},BaseItemList.prototype.fillFullFromArray=function(items){this._list.spliceWith(0,0,items),this._length=items.length,this._loadedRanges=[new Range(0,items.length)],this._loadedState=LoadedState.COMPLETE},BaseItemList.prototype._createVersionComparator=function(){var self=this;return function(expectedVersion){return self._version==expectedVersion}},BaseItemList.prototype._createVersionedAccessor=function(){var self=this,list=this._list;return function(expectedVersion,index,originalIndex){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return index in list?list[index]:ItemList.NULL_VALUE}},BaseItemList.prototype.snapshot=function(offset,length){var range,self=this,version=(this._list,this._version),promise=new Promise;if(0==length&&null!=this._length)return promise.fulfill(new Snapshot(version,this._createVersionedAccessor(),new Range(offset,0),this._length)),promise;switch(this._loadedState){case LoadedState.COMPLETE:range=new Range(offset,length,Math.max(this._length-offset,0)),promise.fulfill(new Snapshot(version,this._createVersionedAccessor(),range,this._length));break;case LoadedState.PARTIAL:range=new Range(offset,length,Math.max(this._length-offset,0)),range.findContainer(this._loadedRanges)?promise.fulfill(new Snapshot(version,this._createVersionedAccessor(),range,this._length)):this._fill(range).then(function(list){self.snapshot(offset,length).pipe(promise)}).catchError(function(error){promise.fail(error)});break;case LoadedState.UNLOADED:this._loadLength().then(function(result){result.length?this._fill(new Range(offset,length,Math.min(this._snapshotLimit,this._length))).then(function(list){self.snapshot(offset,length).pipe(promise)}).catchError(function(error){promise.fail(error)}):(this._loadedState=LoadedState.COMPLETE,this.snapshot(offset,length).pipe(promise))}.bind(this))}return promise},BaseItemList.prototype.snapshotRange=function(range){return this.snapshot(range.begin,range.length)},BaseItemList.prototype.getLength=function(){return this.snapshot(0,0).call("getListLength")},BaseItemList.prototype.toArray=function(opt_index,opt_length){return opt_index=opt_index||0,opt_length=void 0==opt_length?-1:opt_length,this.snapshot(0,-1).call("toArray")},BaseItemList.prototype.preload=function(){var self=this;return this.snapshot(0,-1).then(function(e){return self})},module.exports=BaseItemList}()},{"../range":93,"./comparators":79,"./core":81,"./mutator":86,"./predicates":87,"./snapshot":90,"spotify-promise":133}],79:[function(require,module,exports){!function(){"use strict";function _numberComparator(a,b){return a-b}function _reverseNumberComparator(a,b){return b-a}function _stringComparator(a,b){return a>b?1:a==b?0:-1}function _reverseStringComparator(a,b){return a>b?-1:a==b?0:1}var Comparator,ComparatorMap,SortingOrder={ASC:"asc",DESC:"desc"},ComparisonResult={GREATER:1,EQUAL:0,LESS:-1},Comparators={};Comparators.forNumber=function(){return _numberComparator},Comparators.forNumberReversed=function(){return _reverseNumberComparator},Comparators.forString=function(){return _stringComparator},Comparators.forStringReversed=function(){return _reverseStringComparator};var NumberPropComparators={},StringPropComparators={};Comparators.forNumberProperty=function(prop){var comps=NumberPropComparators;return comps[prop]||(comps[prop]=function(a,b){return a=a[prop],b=b[prop],a-b})},Comparators.forNumberPropertyReversed=function(prop){var comps=NumberPropComparators,propName=prop+"_reverse";return comps[propName]||(comps[propName]=function(a,b){return a=a[prop],b=b[prop],b-a})},Comparators.forStringProperty=function(prop){var comps=StringPropComparators;return comps[prop]||(comps[prop]=function(a,b){return a=(a[prop]||"").toString(),b=(b[prop]||"").toString(),a>b?1:a==b?0:-1})},Comparators.forStringPropertyReversed=function(prop){var comps=StringPropComparators,propName=prop+"_reverse";return comps[propName]||(comps[propName]=function(a,b){return a=(a[prop]||"").toString(),b=(b[prop]||"").toString(),a>b?-1:a==b?0:1})},Comparators.forProperty=function(prop,comparator){return function(a,b){return comparator(a[prop],b[prop])}},Comparators.forComparators=function(comparators){return 1==comparators.length?comparators[0]:function(a,b){for(var r=0,i=0;0==r&&i<comparators.length;)r=comparators[i](a,b),++i;return r}},module.exports={SortingOrder:SortingOrder,ComparisonResult:ComparisonResult,Comparators:Comparators,
Comparator:Comparator,ComparatorMap:ComparatorMap}}()},{}],80:[function(require,module,exports){!function(){"use strict";function ConcatenatedItemList(lists){if(!(this instanceof ConcatenatedItemList))return new ConcatenatedItemList(list);if(!lists||!lists.length)throw new TypeError("ConcatenatedItemList: Argument `lists` cannot be empty.");BaseItemList.call(this),this._sublists=lists.slice(0),this._offsets=[],this._ruleset=new MutationRuleset.Immutable}var Promise=require("spotify-promise"),Range=require("../range"),inherit=require("spotify-inheritance/inherit"),BaseItemList=require("./base"),Snapshot=(require("./core").LoadedState,require("./snapshot")),MutationRuleset=require("./mutator").MutationRuleset;inherit(ConcatenatedItemList,BaseItemList),ConcatenatedItemList.prototype._load=function(range){for(var sublists=this._sublists,offsets=this._offsets,promises=[],i=0,l=offsets.length;l>i;i++){var offset=offsets[i],nextOffset=i+1 in offsets?offsets[i+1]:this._length,offsetRange=new Range(offset,nextOffset-offset);if(offsetRange.intersects(range)){var requestedRange=offsetRange.intersect(range);promises.push(sublists[i].snapshot(requestedRange.begin,requestedRange.length))}}return Promise.join(promises).then(function(snapshots){for(var list=[],i=0,l=snapshots.length;l>i;i++)list.push.apply(list,snapshots[i].toArray());return{range:range,items:list}})},ConcatenatedItemList.prototype._loadLength=function(){for(var lists=this._sublists,promises=[],i=0,l=lists.length;l>i;i++){var list=lists[i];list.observe(this),promises.push(list.snapshot(0,-1))}return Promise.join(promises).then(this._processInitialSnapshots.bind(this))},ConcatenatedItemList.prototype._processInitialSnapshots=function(snapshots){var list=this._list,offsets=this._offsets;this._length=0;for(var i=0,l=snapshots.length;l>i;i++){var snapshot=snapshots[i],array=snapshot.toFullArray(),range=new Range(snapshot.getOffset()+this._length,array.length);list.insertFrom(range.begin,array),offsets[i]=this._length,this._length+=snapshot.getListLength(),this._updateRanges(range),this._updateState()}return{length:this._length}},ConcatenatedItemList.prototype.onMutate=function(mutations,list){mutations.length&&this._applyMutations(mutations,list)},ConcatenatedItemList.prototype._applyMutations=function(mutations,list){this.notify("onBeforeMutate",new Snapshot(this._version,this._createVersionedAccessor(),new Range(0,this._length),this._length));var sublistIndex=this._sublists.indexOf(list);if(-1!=sublistIndex){var offset=this._offsets[sublistIndex];if(null!=offset){for(var applied=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i],mutationApplied=null;switch(mutation.type){case"insert":mutationApplied=this._applyInsertMutation({type:"insert",begin:offset+mutation.begin,items:mutation.items}),mutationApplied&&(this._incrementOffsets(sublistIndex+1,mutationApplied.items.length),applied.push(mutationApplied));break;case"remove":mutationApplied=this._applyRemoveMutation({type:"remove",begin:offset+mutation.begin,length:mutation.length}),mutationApplied&&(this._decrementOffsets(sublistIndex+1,mutationApplied.length),applied.push(mutationApplied));break;case"move":mutationApplied=this._applyMoveMutation({type:"move",begin:offset+mutation.begin,end:offset+mutation.end,length:mutation.length}),mutationApplied&&applied.push(mutationApplied)}}return this._version++,this.notify("onMutate",applied),applied}}},ConcatenatedItemList.prototype._incrementOffsets=function(fromIndex,howMany){for(var offsets=this._offsets,i=fromIndex,l=offsets.length;l>i;i++)offsets[i]+=howMany;return this},ConcatenatedItemList.prototype._decrementOffsets=function(fromIndex,howMany){for(var offsets=this._offsets,i=fromIndex,l=offsets.length;l>i;i++)offsets[i]-=howMany;return this},ConcatenatedItemList.prototype.offsetFromListIndex=function(listIndex,index){var self=this;return this.getLength().then(function(length){return index>=length||listIndex>=self._offsets.length?null:(0>index&&(index=0),self._offsets[listIndex]+index)})},ConcatenatedItemList.prototype.getListAt=function(index){return this._sublists[index]||null},ConcatenatedItemList.prototype.getListForIndex=function(index){return this.getLength().then(function(length){if(index>length)return null;for(var lists=this._sublists,offsets=this._offsets,i=0,l=offsets.length;l>i;i++){var offset=offsets[i];if(index==offset)return lists[i];if(offset>index)return lists[i-1]}return lists[i-1]}.bind(this))},ConcatenatedItemList.prototype.translateIndex=function(index){return this.getLength().then(function(length){if(index>length)return null;for(var offsets=(this._sublists,this._offsets),i=0,l=offsets.length;l>i;i++){var offset=offsets[i];if(index==offset)return 0;if(offset>index)return index-offsets[i-1]}return index-offset}.bind(this))},module.exports=ConcatenatedItemList}()},{"../range":93,"./base":78,"./core":81,"./mutator":86,"./snapshot":90,"spotify-inheritance/inherit":131,"spotify-promise":133}],81:[function(require,module,exports){!function(){"use strict";var ItemList={};ItemList.LIST_START=new function(){},ItemList.LIST_END=new function(){},ItemList.NULL_VALUE=new function(){},ItemList.OUT_OF_BOUNDS=new function(){},ItemList.LoadResponse,ItemList.LoadedState={UNLOADED:"unloaded",LOADING:"loading",PARTIAL:"partial",COMPLETE:"complete"},ItemList.ListIndex,ItemList.ListLength,ItemList.IndexResolver,ItemList.VersionNumber,ItemList.VersionComparator,ItemList.VersionedAccessor,module.exports=ItemList}()},{}],82:[function(require,module,exports){!function(){"use strict";function Descriptor(){this.type=null}function ListDescriptor(uri){if(!(this instanceof ListDescriptor))return new ListDescriptor(uri);if(!uri)throw new Error("Invalid arguments.");this.type="list",this.uri=uri.toString()}function ConcatenatedListDescriptor(lists){if(!(this instanceof ConcatenatedListDescriptor))return new ConcatenatedListDescriptor(uri);if(!lists)throw new Error("Invalid arguments.");this.lists=lists,this.type="lists"}function SortedListDescriptor(list,args,version){if(!(this instanceof SortedListDescriptor))return new SortedListDescriptor(uri);if(void 0==args||void 0==list||void 0==version)throw new Error("Invalid arguments.");this.args=args,this.list=list,this.type="sort",this.version=version,this.params=[];for(var i=0;i<args.length;i+=2)this.params.push({field:args[i],order:args[i+1]})}function FilteredListDescriptor(list,args,version){if(!(this instanceof FilteredListDescriptor))return new FilteredListDescriptor(uri);if(void 0==args||void 0==list||void 0==version)throw new Error("Invalid arguments.");this.args=args,this.list=list,this.type="filter",this.version=version,this.operator=args[0],this.field=args[1],this.matcher=args[2]}function RangedListDescriptor(list,args,version){if(!(this instanceof RangedListDescriptor))return new RangedListDescriptor(uri);if(void 0==args||void 0==list||void 0==version)throw new Error("Invalid arguments.");this.args=args,this.list=list,this.type="range",this.version=version,this.offset=args[0],this.length=args[1]}function ShuffledListDescriptor(list,args,version){if(!(this instanceof ShuffledListDescriptor))return new ShuffledListDescriptor(uri);if(void 0==args||void 0==list||void 0==version)throw new Error("Invalid arguments.");this.args=args,this.list=list,this.type="shuffle",this.version=version,this.seed=args[0]}var from=function(item){return item?"string"==typeof descriptor?this.fromString(item):this.fromObject(item):null},fromString=function(str){try{var object=this.fromObject(JSON.parse(str));return object instanceof Descriptor?object:null}catch(e){return null}},fromObject=function(obj){if(!obj)return null;if(obj instanceof Descriptor)return obj;try{switch(obj.type){case"list":return new ListDescriptor(obj.uri);case"lists":for(var lists=[],i=0,l=obj.lists.length;l>i;i++){var list=this.fromObject(obj.lists[i]);if(!list)return null;lists.push(list)}return new ConcatenatedListDescriptor(lists);case"sort":return new SortedListDescriptor(this.fromObject(obj.list),obj.args,obj.version);case"filter":return new FilteredListDescriptor(this.fromObject(obj.list),obj.args,obj.version);case"range":return new RangedListDescriptor(this.fromObject(obj.list),obj.args,obj.version);case"shuffle":return new ShuffledListDescriptor(this.fromObject(obj.list),obj.args,obj.version);default:return null}}catch(e){return null}},occlude=function(key,value){return"operator"!=key&&"field"!=key&&"matcher"!=key&&"offset"!=key&&"length"!=key&&"seed"!=key&&"order"!=key&&"params"!=key?value:void 0},extractList=function(descriptor){if(!descriptor)return null;if("string"==typeof descriptor)return new Spotify.ItemList.Descriptor.List(descriptor);for(;descriptor&&"list"!=descriptor.type;)descriptor=descriptor.list;return descriptor&&"list"==descriptor.type?descriptor:null};Descriptor.prototype.serialize=function(){return JSON.stringify(this,occlude)},ListDescriptor.prototype=new Descriptor,ConcatenatedListDescriptor.prototype=new Descriptor,SortedListDescriptor.prototype=new Descriptor,FilteredListDescriptor.prototype=new Descriptor,RangedListDescriptor.prototype=new Descriptor,ShuffledListDescriptor.prototype=new Descriptor,module.exports={from:from,fromString:fromString,fromObject:fromObject,occludeFields:occlude,extractList:extractList,Base:Descriptor,List:ListDescriptor,Concatenated:ConcatenatedListDescriptor,Sorted:SortedListDescriptor,Filtered:FilteredListDescriptor,Ranged:RangedListDescriptor,Shuffled:ShuffledListDescriptor}}()},{}],83:[function(require,module,exports){!function(){"use strict";function FilteredItemList(base,predicate){LayeredItemList.call(this,base),this._baseList=[],this._loadedBaseRanges=[],this._predicate=predicate}function FilteredMutationMock(baseList,filteredList,length,predicate){this._baseList=baseList.slice(0),this._list=filteredList.slice(0),this._length=length,this._predicate=predicate,this._version=0}function FilteredMutator(baseMutator,mutationMock,resolveIndex,checkVersion,ruleset,version,length){return this instanceof FilteredMutator?(Mutator.call(this,null,checkVersion,ruleset,version,length),this._baseMutator=baseMutator,this._resolveIndex=resolveIndex,void(this._mutationMock=mutationMock)):new FilteredMutator(baseMutator)}var inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Range=require("../range"),ItemList=require("./core"),LayeredItemList=require("./layered"),LoadedState=ItemList.LoadedState,MutationModule=require("./mutator"),MutationResult=MutationModule.MutationResult,Mutator=MutationModule.Mutator,Snapshot=require("./snapshot");inherit(FilteredItemList,LayeredItemList),FilteredItemList.prototype._buildList=function(range,items){for(var list=this._list,initialIndex=list.length,inserted=0,predicate=this._predicate,i=0,l=items.length;l>i;i++){var item=items[i];item!=ItemList.NULL_VALUE&&predicate(item)&&(list.push(range.begin+i),inserted++)}inserted&&this._updateRanges(new Range(initialIndex,inserted)),this._baseList.insertFrom(range.begin,items);var loadedBaseRanges=this._loadedBaseRanges;return loadedBaseRanges.push(range),this._loadedBaseRanges=loadedBaseRanges=Range.simplify(loadedBaseRanges),1==loadedBaseRanges.length&&loadedBaseRanges[0].length>=this._baseLength?(this._length=list.length,this._loadedState=LoadedState.COMPLETE):this._loadedState=LoadedState.PARTIAL,this},FilteredItemList.prototype._createVersionedAccessor=function(offset,baseList){var self=this,list=this._list;return function(expectedVersion,index){return self._version!=expectedVersion?ItemList.NULL_VALUE:index in list?baseList[list[index]-offset]:ItemList.NULL_VALUE}},FilteredItemList.prototype._snapshot=function(offset,length,tries){var indices,baseRange,self=this,promise=new Promise,range=new Range(offset,length);if(0==range.length&&this._loadedState!=LoadedState.UNLOADED){var snapshot=new Snapshot(this._version,this._createVersionedAccessor(0,[]),range,this._length);return promise.fulfill(snapshot),promise}switch(this._loadedState){case LoadedState.COMPLETE:-1==length&&(length=this._length),indices=this._list.slice(offset,offset+length),baseRange=new Range(indices[0],0).add(new Range(indices[indices.length-1],1)),this._base.snapshotRange(baseRange).then(function(snapshot){var _snapshot=new Snapshot(self._version,self._createVersionedAccessor(baseRange.begin,snapshot.toFullArray()),new Range(offset,indices.length),self._length);promise.fulfill(_snapshot)});break;case LoadedState.PARTIAL:if(range.findContainer(this._loadedRanges))-1==length&&(length=this._length),indices=this._list.slice(offset,offset+length),baseRange=new Range(indices[0],0).add(new Range(indices[indices.length-1],1)),this._base.snapshotRange(baseRange).then(function(snapshot){var _snapshot=new Snapshot(self._version,self._createVersionedAccessor(baseRange.begin,snapshot.toFullArray()),new Range(offset,indices.length),indices.length);promise.fulfill(_snapshot)});else{var loadedBaseRanges=this._loadedBaseRanges,unloadedRange=new Range(loadedBaseRanges[loadedBaseRanges.length-1].last,10*tries);this._base.snapshotRange(unloadedRange).then(function(snapshot){self._buildList(new Range(snapshot.getOffset(),snapshot.getLength()),snapshot.toFullArray()),self._snapshot(range.begin,range.length,++tries).pipe(promise)})}break;case LoadedState.UNLOADED:var newRange=new Range(0,range.last-range.begin+10*tries);this._base.snapshotRange(newRange).then(function(snapshot){self._length=self._baseLength=snapshot.getListLength(),self._buildList(new Range(snapshot.getOffset(),snapshot.getLength()),snapshot.toFullArray()),self._snapshot(range.begin,range.length,++tries).pipe(promise)})}return promise},FilteredItemList.prototype.snapshot=function(offset,length){return this._snapshot(offset,length,1)},FilteredItemList.prototype.translateIndex=function(index){return this.getLength().then(function(length){return 0>index||index>length?ItemList.OUT_OF_BOUNDS:this._list[index]}.bind(this))},FilteredItemList.prototype.translateIndexFromBase=function(index){return this.getLength().then(function(length){var translated=this._list.indexOf(index);return-1==translated?ItemList.OUT_OF_BOUNDS:translated}.bind(this))},FilteredItemList.prototype.onBeforeMutate=function(snapshot){this._baseList=snapshot.toFullArray()},FilteredItemList.prototype.onMutate=function(mutations){mutations.length&&this._applyMutations(mutations)},FilteredItemList.prototype._applyMutations=function(mutations){this.notify("onBeforeMutate",new Snapshot(this._version,this._createVersionedAccessor(0,this._baseList),new Range(0,this._length),this._length));for(var applied=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i],mutationApplied=null;switch(mutation.type){case"insert":mutationApplied=this._applyInsertMutation(mutation);break;case"remove":mutationApplied=this._applyRemoveMutation(mutation);break;case"move":mutationApplied=this._applyMoveMutation(mutation)}mutationApplied&&applied.push(mutationApplied)}return this._version++,this.notify("onMutate",applied),applied},FilteredItemList.prototype._applyInsertMutation=function(mutation){var list=this._list,begin=mutation.begin,items=mutation.items;if(!items.length)return null;var filtered=this._filterMutationItems(items),filteredItems=filtered.items,filteredIndices=filtered.indices,toIndex=this._findInsertionIndex(begin);this._updateIndices(toIndex,list.length,items.length);for(var i=0,l=filteredIndices.length;l>i;i++){var index=toIndex+i,originalIndex=begin+filteredIndices[i];list.splice(index,0,originalIndex)}return this._length+=filteredIndices.length,{type:"insert",begin:toIndex,items:filteredItems}},FilteredItemList.prototype._applyRemoveMutation=function(mutation){var list=this._list,begin=mutation.begin,length=mutation.length,end=begin+length;if(!length)return null;for(var fromIndex=-1,removed=0,i=0,l=list.length;l>i;i++){var index=list[i];index>=end?list[i]-=length:index>=begin&&(-1==fromIndex&&(fromIndex=i),removed++)}return list.splice(fromIndex,removed),this._length-=removed,{type:"remove",begin:fromIndex,length:removed}},FilteredItemList.prototype._applyMoveMutation=function(mutation){var list=this._list,begin=mutation.begin,end=mutation.end,length=mutation.length;if(begin==end)return null;var offset,indices=this._getIndicesInRange(new Range(begin,length)),fromIndex=this._findInsertionIndex(begin),toIndex=this._findInsertionIndex(end);end>begin?(offset=end-begin-length,this._updateIndices(fromIndex+indices.length,toIndex,-length),list.spliceWith(toIndex,0,indices),list.splice(fromIndex,indices.length),this._updateIndices(toIndex-indices.length,toIndex,offset)):(offset=end-begin,this._updateIndices(toIndex,fromIndex,length),list.splice(fromIndex,indices.length),list.spliceWith(toIndex,0,indices),this._updateIndices(toIndex,toIndex+indices.length,offset));var baseList=this._baseList,items=baseList.splice(begin,length);return baseList.spliceWith(end,0,items),fromIndex==toIndex?null:{type:"move",begin:fromIndex,end:toIndex,length:indices.length}},FilteredItemList.prototype._filterMutationItems=function(items){for(var into=[],indices=[],predicate=this._predicate,i=0,l=items.length;l>i;i++){var item=items[i];predicate(item)&&(into.push(item),indices.push(i))}return{items:into,indices:indices}},FilteredItemList.prototype._findInsertionIndex=function(index){for(var list=this._list,i=0,l=list.length;l>i;i++)if(list[i]>=index)return i;return l},FilteredItemList.prototype._getIndicesInRange=function(range){for(var list=this._list,result=[],i=0,l=list.length;l>i;i++){var index=list[i];range.has(index)&&result.push(index)}return result},FilteredItemList.prototype._createMutationMock=function(){return new FilteredMutationMock(this._baseList,this._list,this._length,this._predicate)},FilteredItemList.prototype.createMutator=function(){var baseMutator=this._base.createMutator();if(!baseMutator)return null;var mutationMock=this._createMutationMock(),resolver=this._createIndexResolver(),comparator=this._createVersionComparator(),ruleset=this._ruleset;return new FilteredMutator(baseMutator,mutationMock,resolver,comparator,ruleset,this._version,this._length)},FilteredItemList.prototype._createIndexResolver=function(){var list=this._list;return function(index){return index in list?list[index]:ItemList.NULL_VALUE}},FilteredItemList.prototype._updateIndices=function(from,to,amount){for(var list=this._list;to>from;from++)list[from]+=amount},FilteredMutationMock.prototype.applyMutations=function(mutations){return mutations=Array.isArray(mutations)?mutations:slice.call(arguments),this._applyMutations(mutations)},FilteredMutationMock.prototype.notify=function(){},FilteredMutationMock.prototype._createVersionedAccessor=function(){},FilteredMutationMock.prototype._applyMutations=FilteredItemList.prototype._applyMutations,FilteredMutationMock.prototype._applyInsertMutation=FilteredItemList.prototype._applyInsertMutation,FilteredMutationMock.prototype._applyRemoveMutation=FilteredItemList.prototype._applyRemoveMutation,FilteredMutationMock.prototype._applyMoveMutation=FilteredItemList.prototype._applyMoveMutation,FilteredMutationMock.prototype._filterMutationItems=FilteredItemList.prototype._filterMutationItems,FilteredMutationMock.prototype._findInsertionIndex=FilteredItemList.prototype._findInsertionIndex,FilteredMutationMock.prototype._getIndicesInRange=FilteredItemList.prototype._getIndicesInRange,FilteredMutationMock.prototype._updateIndices=FilteredItemList.prototype._updateIndices,inherit(FilteredMutator,Mutator),FilteredMutator.prototype.apply=function(){return this._baseMutator.apply()},FilteredMutator.prototype.add=function(items,accumulator){var allowed=this.canAdd(items.length);if(allowed!=MutationResult.ALLOWED)return allowed;if(!items.length)return MutationResult.SUCCESS;var baseMutator=this._baseMutator,result=baseMutator.canAdd(items.length);if(result!=MutationResult.ALLOWED)return result;var operations=[];baseMutator.add(items,operations);var mutations=this._mutationMock.applyMutations(operations);return accumulator&&accumulator.push.apply(accumulator,mutations),MutationResult.SUCCESS},FilteredMutator.prototype.insert=function(begin,items,accumulator){var allowed=this.canInsert(begin,items.length);if(allowed!=MutationResult.ALLOWED)return allowed;if(!items.length)return MutationResult.SUCCESS;var index=this._resolveIndex(begin),baseMutator=this._baseMutator,result=baseMutator.canInsert(index,items.length);if(result!=MutationResult.ALLOWED)return result;var operations=[];baseMutator.insert(index,items,operations);var mutations=this._mutationMock.applyMutations(operations);return this._length=this._mutationMock._length,accumulator&&accumulator.push.apply(accumulator,mutations),MutationResult.SUCCESS},FilteredMutator.prototype.remove=function(begin,length,accumulator){var allowed=this.canRemove(begin,length);if(allowed!=MutationResult.ALLOWED)return allowed;if(0==length)return MutationResult.SUCCESS;for(var baseMutator=this._baseMutator,indices=[],i=0,l=length;l>i;i++){var index=this._resolveIndex(begin+i),result=baseMutator.canRemove(index,1);if(result!=MutationResult.ALLOWED)return result;indices.push(index)}indices.sort(function(a,b){return a-b});for(var operations=[],x=0,y=length;y>x;x++)baseMutator.remove(indices[x]-x,1,operations);this._length-=length,this._mutationMock.applyMutations(operations);var mutation={type:"remove",begin:begin,length:length};return accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},FilteredMutator.prototype.move=function(begin,end,length,accumulator){var allowed=this.canMove(begin,end,length);if(allowed!=MutationResult.ALLOWED)return allowed;if(begin==end||0==length)return MutationResult.SUCCESS;for(var baseMutator=this._baseMutator,indices=[],i=0,l=length;l>i;i++){var index=this._resolveIndex(begin+i),result=baseMutator.canMove(index,begin,1);if(result!=MutationResult.ALLOWED)return result;indices.push(index)}for(var toIndex=this._resolveIndex(end),operations=[],x=0,y=indices.length;y>x;x++)baseMutator.move(indices[x]-x,toIndex,1,operations);this._mutationMock.applyMutations(operations);var mutation={type:"move",begin:begin,end:end,length:length};return accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},module.exports=FilteredItemList}()},{"../range":93,"./core":81,"./layered":85,"./mutator":86,"./snapshot":90,"spotify-inheritance/inherit":131,"spotify-promise":133}],84:[function(require,module,exports){!function(){"use strict";function IterableItemList(base,padding){LayeredItemList.call(this,base),Queueable.call(this,["snapshot","pop","previous","next","hasPrevious","hasNext","preload","startAt"]),this._index=-1,this._loadLimit=padding||10,this._infinite=!1,this._hasIterated=!1,this._currentIndexRemoved=!1,this._init()}var inherit=require("spotify-inheritance/inherit"),extend=require("spotify-inheritance/extend"),Promise=require("spotify-promise"),Range=require("../range"),ItemList=require("./core"),Queueable=require("spotify-queueable"),LayeredItemList=require("./layered"),LoadedState=ItemList.LoadedState,MutationResult=require("./mutator").MutationResult,Snapshot=require("./snapshot");inherit(IterableItemList,LayeredItemList),extend(IterableItemList.prototype,Queueable.prototype),IterableItemList.prototype._init=function(){this._loadLength().then(this._setReady.bind(this))},IterableItemList.prototype._load=function(range){return this._base.snapshotRange(range).then(function(snapshot){return{range:new Range(snapshot.getOffset(),snapshot.getLength()),items:snapshot.toArray()}})},IterableItemList.prototype._loadLength=function(){var self=this;return this._base.getLength().then(function(length){return self._length=length,self._loadedState=LoadedState.PARTIAL,{length:length}})},IterableItemList.prototype.makeInfinite=function(){var promise=new Promise;return promise.fulfill(!0),this._infinite=!0,promise},IterableItemList.prototype.isInfinite=function(){return!!this._infinite},IterableItemList.prototype.makeFinite=function(){var promise=new Promise;return promise.fulfill(!0),this._infinite=!1,promise},IterableItemList.prototype.startAt=function(index){var promise=new Promise;return-1==index||index>this._length?(index=this._length+1,this._index=this._length):0>index?(index=0,this._index=-1):this._index=index-1,this._currentIndexRemoved=!1,this._hasIterated=!1,promise.fulfill(!0),promise},IterableItemList.prototype.rewind=function(){return this._index=-1,this._currentIndexRemoved=!1,this},IterableItemList.prototype.wasCurrentIndexRemoved=function(){return!!this._currentIndexRemoved},IterableItemList.prototype.getIndex=function(){var index=this._index;return 0>index?ItemList.LIST_START:index>=this._length?ItemList.LIST_END:index},IterableItemList.prototype.preload=function(index){index=void 0==index?0:index;var padding=this._loadLimit,range=new Range(index-padding,2*(padding||1));if(range.begin<0){var tempRange=range.subtract(new Range(0,0));range=tempRange[1].add(new Range(tempRange[1].last,tempRange[0].length))}return this._fill(range).then(function(){return!0},function(){return!1})},IterableItemList.prototype.hasNext=function(){var self=this,index=this._index,promise=new Promise;return this._infinite?(promise.fulfill(!0),promise):index+1>=self.length?(promise.fulfill(!1),promise):this.snapshot(index+1,1).then(function(snapshot){return snapshot.get(0)!==ItemList.NULL_VALUE},function(){return!1})},IterableItemList.prototype.hasPrevious=function(){var index=this._index,promise=new Promise;return this._infinite?(promise.fulfill(!0),promise):0>index-1?(promise.fulfill(!1),promise):this.snapshot(index-1,1).then(function(snapshot){return snapshot.get(0)!==ItemList.NULL_VALUE},function(){return!1})},IterableItemList.prototype.next=function(){var self=this,index=this._index;if(this._hasIterated=!0,this._infinite&&index+1==this._length)this._index=index=0;else{if(index+1>this._length-1){this._index=index=this._length;var promise=new Promise;return promise.fulfill(ItemList.LIST_END),promise}this._index=index+=1}return this._currentIndexRemoved=!1,this.snapshot(index,1).then(function(snapshot){var item=snapshot.get(0);return Promise.defer(function(){self.preload(index+1)}),item==ItemList.NULL_VALUE?ItemList.LIST_END:item},function(){return ItemList.LIST_END})},IterableItemList.prototype.previous=function(){var self=this,index=this._index;if(this._hasIterated=!0,this._infinite&&index-1==-1)this._index=index=this._length-1;else{if(0>index-1){this._index=index=-1;var promise=new Promise;return promise.fulfill(ItemList.LIST_START),promise}this._index=index-=1}return this._currentIndexRemoved=!1,this.snapshot(index,1).then(function(snapshot){var item=snapshot.get(0);return Promise.defer(function(){self.preload(index-1-self._loadLimit)}),item==ItemList.NULL_VALUE?ItemList.LIST_START:item},function(){return ItemList.LIST_START})},IterableItemList.prototype.pop=function(){var self=this,promise=new Promise;return this.snapshot(0,1).then(function(snapshot){var mutator=self._base.createMutator(),item=snapshot.get(0);item==ItemList.NULL_VALUE||mutator.canRemove(0,1)!=MutationResult.ALLOWED?promise.fulfill(ItemList.NULL_VALUE):(mutator.remove(0,1),mutator.apply().then(function(result){result==MutationResult.SUCCESS?promise.fulfill(item):promise.fulfill(ItemList.NULL_VALUE)},function(){promise.fulfill(ItemList.NULL_VALUE)}))},function(){promise.fulfill(ItemList.NULL_VALUE)}),promise},IterableItemList.prototype._snapshot=function(offset,length,useRoot){var self=this,listLength=this._length,base=useRoot?this._base.getRootBaseList():this._base,originalOffset=offset;if(this._infinite&&-1!=length&&offset+length>listLength){offset>listLength&&(offset%=listLength);var promises=[],firstLength=listLength-offset;promises.push(base.snapshot(offset,firstLength));for(var totalLength=offset+length-firstLength;totalLength>0;)totalLength>=listLength?(promises.push(base.snapshot(0,listLength)),totalLength-=listLength):(promises.push(base.snapshot(0,totalLength)),totalLength=0);return Promise.join(promises).then(function(snapshots){for(var list=[],i=0,l=snapshots.length;l>i;i++)list=list.concat(snapshots[i].toArray());return new Snapshot(self._version,function(version,offsetIndex,index){if(self._version!=version)throw new Error("Cannot access item with an expired snapshot.");return index in list?list[index]:ItemList.NULL_VALUE},new Range(originalOffset,length),self._length)})}return base.snapshot(offset,length)},IterableItemList.prototype.snapshot=function(offset,length){return this._snapshot(offset,length,!1)},IterableItemList.prototype.snapshotRoot=function(offset,length){return this._snapshot(offset,length,!0)},IterableItemList.prototype.onMutate=function(mutations){mutations.length&&this._applyMutations(mutations)},IterableItemList.prototype._applyMutations=function(mutations){if(this.notify("onBeforeMutate",new Snapshot(this._version,this._createVersionedAccessor(),new Range(0,this._length),this._length)),-1!=this._index)for(var i=0,l=mutations.length;l>i;i++){var mutation=mutations[i];switch(mutation.type){case"insert":this._applyInsertMutation(mutation);break;case"remove":this._applyRemoveMutation(mutation);break;case"move":this._applyMoveMutation(mutation)}}return this._version++,this.notify("onMutate",mutations),mutations},IterableItemList.prototype._applyInsertMutation=function(mutation){var begin=mutation.begin,length=mutation.items.length;if(!length)return mutation;var originalLength=this._length;return this._length+=length,this._hasIterated||this._index++,originalLength==begin?(this._hasIterated||this._index--,mutation):(begin<=this._index&&(this._index+=length),this._hasIterated||this._index--,mutation)},IterableItemList.prototype._applyRemoveMutation=function(mutation){var begin=mutation.begin,length=mutation.length;if(!length)return mutation;this._hasIterated||this._index++;var range=new Range(begin,length);return this._length-=length,begin==this._index?(this._index--,this._currentIndexRemoved=!0):range.has(this._index)?(this._index=begin,this._currentIndexRemoved=!0):begin<this._index&&(this._index-=length),this._hasIterated||this._index--,mutation},IterableItemList.prototype._applyMoveMutation=function(mutation){var begin=mutation.begin,end=mutation.end,length=mutation.length;if(!length||this._index<0||this._index>this._length)return mutation;this._hasIterated||this._index++;var finder={},mock=new Array(this._length);mock[this._index]=finder;var items=mock.splice(begin,length);return mock.spliceWith(end,0,items),this._index=mock.indexOf(finder),this._hasIterated||this._index--,mutation},module.exports=IterableItemList}()},{"../range":93,"./core":81,"./layered":85,"./mutator":86,"./snapshot":90,"spotify-inheritance/extend":129,"spotify-inheritance/inherit":131,"spotify-promise":133,"spotify-queueable":40}],85:[function(require,module,exports){!function(){"use strict";function LayeredItemList(base){if(!(this instanceof LayeredItemList))return new LayeredItemList(base);if(!base)throw new Error("Required base argument must not be undefined");BaseItemList.call(this,base),this._base.observe(this)}var inherit=require("spotify-inheritance/inherit"),BaseItemList=require("./base");inherit(LayeredItemList,BaseItemList),LayeredItemList.prototype.createComparator=function(field,order){return this._base.createComparator(field,order)},LayeredItemList.prototype.createPredicate=function(field,operator,opt_matcher){return this._base.createPredicate(field,operator,opt_matcher)},LayeredItemList.prototype.onBeforeMutate=function(snapshot){this.notify("onBeforeMutate",snapshot)},LayeredItemList.prototype.onMutate=function(mutations){this._isMutating=!0;for(var i=0,l=mutations.length;l>i;i++){var mutation=mutations[i];switch(mutation.type){case"insert":this._length+=mutation.items.length;break;case"remove":this._length-=mutation.length;break;case"move":}}return this._version++,this._isMutating=!1,this.notify("onMutate",mutations),mutations},LayeredItemList.prototype.createMutator=function(){return this._base.createMutator()},LayeredItemList.prototype.snapshot=function(offset,length){return this._base.snapshot(offset,length);
},LayeredItemList.prototype.getLength=function(){var self=this;return this.snapshot(0,1).call("getListLength").then(function(length){return self._length=length,length})},module.exports=LayeredItemList}()},{"./base":78,"spotify-inheritance/inherit":131}],86:[function(require,module,exports){!function(){"use strict";function MutationRuleset(overrides){if(!(this instanceof MutationRuleset))return new MutationRuleset(overrides);if(!overrides)return this;for(var rule in overrides)this[rule]=overrides[rule]}function ImmutableMutationRuleset(overrides){return this instanceof ImmutableMutationRuleset?void MutationRuleset.call(this,overrides):new ImmutableMutationRuleset(overrides)}function Mutator(applyMutation,checkVersion,ruleset,version,length){return this instanceof Mutator?(this._applied=!1,this._applyMutation=applyMutation,this._checkVersion=checkVersion,this._ruleset=ruleset,this._version=version,this._length=length,this._changes=[],this._internal=!1,void(this._translated=!1)):new Mutator(applyMutation,checkVersion,ruleset,version,length)}var MutationApplicator,Mutation,MutationSet,Promise=require("spotify-promise"),inherit=require("spotify-inheritance/inherit"),MutationResult={SUCCESS:"success",ALLOWED:"allowed",FORBIDDEN:"forbidden",LIST_FULL:"listFull",OUT_OF_BOUNDS:"outOfBounds",EXPIRED:"expired"};MutationRuleset.prototype.add=MutationResult.ALLOWED,MutationRuleset.prototype.insert=MutationResult.ALLOWED,MutationRuleset.prototype.remove=MutationResult.ALLOWED,MutationRuleset.prototype.move=MutationResult.ALLOWED,inherit(ImmutableMutationRuleset,MutationRuleset),MutationRuleset.Immutable=ImmutableMutationRuleset,ImmutableMutationRuleset.prototype.add=MutationResult.FORBIDDEN,ImmutableMutationRuleset.prototype.insert=MutationResult.FORBIDDEN,ImmutableMutationRuleset.prototype.remove=MutationResult.FORBIDDEN,ImmutableMutationRuleset.prototype.move=MutationResult.FORBIDDEN,Mutator.prototype.isApplied=function(){return!!this._applied},Mutator.prototype.isExpired=function(){return!this._checkVersion(this._version)},Mutator.prototype.canInsert=function(begin,length){return this._ruleset.insert==MutationResult.FORBIDDEN?MutationResult.FORBIDDEN:this._applied||!this._checkVersion(this._version)?MutationResult.EXPIRED:0>begin||begin>this._length?MutationResult.OUT_OF_BOUNDS:MutationResult.ALLOWED},Mutator.prototype.canAdd=function(length){return this._ruleset.add==MutationResult.FORBIDDEN?MutationResult.FORBIDDEN:this._applied||!this._checkVersion(this._version)?MutationResult.EXPIRED:MutationResult.ALLOWED},Mutator.prototype.canRemove=function(begin,length){return this._ruleset.remove==MutationResult.FORBIDDEN?MutationResult.FORBIDDEN:this._applied||!this._checkVersion(this._version)?MutationResult.EXPIRED:0>begin||begin>this._length?MutationResult.OUT_OF_BOUNDS:begin+length>this._length?MutationResult.OUT_OF_BOUNDS:MutationResult.ALLOWED},Mutator.prototype.canClear=function(){return this.canRemove(0,this._length)},Mutator.prototype.canMove=function(begin,end,length){var listLength=this._length;return this._translated&&end>begin&&(listLength=1/0),this._ruleset.move==MutationResult.FORBIDDEN?MutationResult.FORBIDDEN:this._applied||!this._checkVersion(this._version)?MutationResult.EXPIRED:0>begin||begin>listLength?MutationResult.OUT_OF_BOUNDS:0>end||end>listLength?MutationResult.OUT_OF_BOUNDS:begin+length>listLength?MutationResult.OUT_OF_BOUNDS:MutationResult.ALLOWED},Mutator.prototype.apply=function(){var promise=new Promise;return this._applied?(promise.fulfill(MutationResult.EXPIRED),promise):(this._applied=!0,this._applyMutation(this._version,this._changes).pipe(promise),promise)},Mutator.prototype.isEmpty=function(){return!this._changes.length},Mutator.prototype.setInternal=function(internal){this._internal=!!internal},Mutator.prototype.setTranslated=function(translated){this._translated=!!translated},Mutator.prototype.insert=function(begin,items,accumulator){var allowed=this.canInsert(begin,items.length);if(allowed!=MutationResult.ALLOWED)return allowed;if(!items.length)return MutationResult.SUCCESS;this._length+=items.length;var mutation={type:"insert",begin:begin,items:items.slice(0),internal:this._internal};return this._changes.push(mutation),accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},Mutator.prototype.add=function(items,accumulator){var allowed=this.canAdd(items.length);return allowed!=MutationResult.ALLOWED?allowed:items.length?this.insert(this._length,items,accumulator):MutationResult.SUCCESS},Mutator.prototype.remove=function(begin,length,accumulator){var allowed=this.canRemove(begin,length);if(allowed!=MutationResult.ALLOWED)return allowed;if(0==length)return MutationResult.SUCCESS;this._length-=length;var mutation={type:"remove",begin:begin,length:length,internal:this._internal};return this._changes.push(mutation),accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},Mutator.prototype.clear=function(accumulator){return this.remove(0,this._length,accumulator)},Mutator.prototype.move=function(begin,end,length,accumulator){var allowed=this.canMove(begin,end,length);if(allowed!=MutationResult.ALLOWED)return allowed;if(begin==end||0==length)return MutationResult.SUCCESS;var translated=!1;this._translated&&end>begin&&(translated=!0,end-=1);var mutation={type:"move",begin:begin,end:end,length:length,internal:this._internal,translated:translated};return this._changes.push(mutation),accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},module.exports={Mutation:Mutation,MutationResult:MutationResult,MutationSet:MutationSet,MutationRuleset:MutationRuleset,Mutator:Mutator,MutationApplicator:MutationApplicator}}()},{"spotify-inheritance/inherit":131,"spotify-promise":133}],87:[function(require,module,exports){!function(){"use strict";var Predicate,PredicateMap,PredicateOperator={EQUAL:"=",NOT_EQUAL:"!=",GREATER_THAN:">",LESS_THAN:"<",GREATER_THAN_OR_EQUAL:">=",LESS_THAN_OR_EQUAL:"<=",STARTS_WITH:"startswith",CONTAINS:"contains"},Predicates={};Predicates.forOperator=function(operator,matcher){switch(operator){case"=":return this.forEqual(matcher);case"!=":return this.forNotEqual(matcher);case">":return this.forGreaterThan(matcher);case"<":return this.forLessThan(matcher);case">=":return this.forGreaterThanOrEqual(matcher);case"<=":return this.forLessThanOrEqual(matcher);case"startswith":return this.forBeginsWith(matcher);case"contains":return this.forContains(matcher);default:return null}},Predicates.forPropertyOperator=function(property,operator,matcher){switch(operator){case"=":return this.forPropertyEqual(property,matcher);case"!=":return this.forPropertyNotEqual(property,matcher);case">":return this.forPropertyGreaterThan(property,matcher);case"<":return this.forPropertyLessThan(property,matcher);case">=":return this.forPropertyGreaterThanOrEqual(property,matcher);case"<=":return this.forPropertyLessThanOrEqual(property,matcher);case"startswith":return this.forPropertyBeginsWith(property,matcher);case"contains":return this.forPropertyContains(property,matcher);default:return null}},Predicates.forNotNull=function(){return function(value){return null!=value}},Predicates.forEqual=function(matcher){return function(value){return value===matcher}},Predicates.forGreaterThan=function(matcher){return function(value){return value>matcher}},Predicates.forLessThan=function(matcher){return function(value){return matcher>value}},Predicates.forGreaterThanOrEqual=function(matcher){return function(value){return value>=matcher}},Predicates.forLessThanOrEqual=function(matcher){return function(value){return matcher>=value}},Predicates.forNotEqual=function(matcher){return function(value){return value!=matcher}},Predicates.forBeginsWith=function(matcher){return function(value){return value?0==value.toString().indexOf(matcher):!1}},Predicates.forContains=function(matcher){return function(value){return value?-1!=value.toString().indexOf(matcher):!1}},Predicates.forPropertyNotNull=function(property){return function(value){return null!=value[property]}},Predicates.forPropertyEqual=function(property,matcher){return function(value){return value[property]==matcher}},Predicates.forPropertyGreaterThan=function(property,matcher){return function(value){return value[property]>matcher}},Predicates.forPropertyLessThan=function(property,matcher){return function(value){return value[property]<matcher}},Predicates.forPropertyGreaterThanOrEqual=function(property,matcher){return function(value){return value[property]>=matcher}},Predicates.forPropertyLessThanOrEqual=function(property,matcher){return function(value){return value[property]<=matcher}},Predicates.forPropertyNotEqual=function(property,matcher){return function(value){return value[property]!=matcher}},Predicates.forPropertyBeginsWith=function(property,matcher){return function(value){return value&&value[property]?0==value[property].toString().indexOf(matcher):!1}},Predicates.forPropertyContains=function(property,matcher){return function(value){return value&&value[property]?-1!=value[property].toString().indexOf(matcher):!1}},module.exports={Predicate:Predicate,PredicateMap:PredicateMap,PredicateOperator:PredicateOperator,Predicates:Predicates}}()},{}],88:[function(require,module,exports){!function(){"use strict";function PropertySnapshot(property,baseSnapshot){this._property=property,this._baseSnapshot=baseSnapshot,this._range=new Range(baseSnapshot.getOffset(),baseSnapshot.getLength()),this._version=baseSnapshot.getVersion(),this._listLength=baseSnapshot.getListLength()}function PropertyItemList(base,property){if(!(this instanceof PropertyItemList))return new PropertyItemList(base,property);if(!property)throw new TypeError("PropertyItemList: Argument property must not be undefined.");LayeredItemList.call(this,base),this._property=property}var inherit=require("spotify-inheritance/inherit"),ItemList=require("./core"),LayeredItemList=require("./layered"),Snapshot=require("./snapshot"),Range=require("../range");inherit(PropertySnapshot,Snapshot),PropertySnapshot.prototype.get=function(index){var property=this._property,result=this._baseSnapshot.get(index);return result!=ItemList.NULL_VALUE&&(result=property in result?result[property]:ItemList.NULL_VALUE),result},inherit(PropertyItemList,LayeredItemList),PropertyItemList.prototype.onBeforeMutate=function(snapshot){this.notify("onBeforeMutate",new PropertySnapshot(this._property,snapshot))},PropertyItemList.prototype.onMutate=function(mutations){mutations.length&&this._applyMutations(mutations)},PropertyItemList.prototype._applyMutations=function(mutations){for(var applied=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i];switch(mutation.type){case"insert":for(var property=this._property,items=mutation.items,len=items.length,properties=new Array(len);len--;)properties[len]=property in items[len]?items[len][property]:ItemList.NULL_VALUE;this._length+=len,applied.push({type:"insert",begin:mutation.begin,items:properties});break;case"remove":this._length-=mutation.length,applied.push(mutation);break;case"move":applied.push(mutation)}}return this._version++,this.notify("onMutate",applied),applied},PropertyItemList.prototype.snapshot=function(offset,length){var property=this._property;return this._base.snapshot(offset,length).then(function(snapshot){return new PropertySnapshot(property,snapshot)})},module.exports=PropertyItemList}()},{"../range":93,"./core":81,"./layered":85,"./snapshot":90,"spotify-inheritance/inherit":131}],89:[function(require,module,exports){!function(){"use strict";function RangedItemList(base,offset,length){LayeredItemList.call(this,base),this._range=new Range(offset,length),this._baseListLength=0,this.makeImmutable()}var inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Range=require("../range"),LayeredItemList=require("./layered"),ItemList=require("./core"),Snapshot=require("./snapshot");inherit(RangedItemList,LayeredItemList),RangedItemList.prototype.translateIndex=function(index){var range=this._range,promise=new Promise;return index>range.length?(promise.fulfill(ItemList.OUT_OF_BOUNDS),promise):this.getLength().then(function(length){return 0>index||index>length?ItemList.OUT_OF_BOUNDS:range.begin+index})},RangedItemList.prototype.onBeforeMutate=function(snapshot){this._list=snapshot.toArray()},RangedItemList.prototype.onMutate=function(mutations){var self=this;this.snapshot(0,-1).then(function(snapshot){self._applyMutations(mutations,snapshot)})},RangedItemList.prototype._applyMutations=function(mutations,snapshot){var version=this._version;this.notify("onBeforeMutate",new Snapshot(version,this._createVersionedAccessor(version,0,snapshot),new Range(0,this._range.length),this._range.length));for(var applied=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i],mutationApplied=null;switch(mutation.type){case"insert":mutationApplied=this._applyInsertMutation(mutation);break;case"remove":mutationApplied=this._applyRemoveMutation(mutation);break;case"move":mutationApplied=this._applyMoveMutation(mutation)}mutationApplied.length&&applied.push.apply(applied,mutationApplied)}return this._version++,this.notify("onMutate",applied),applied},RangedItemList.prototype._applyInsertMutation=function(mutation){var range=this._range,applied=[];if(mutation.begin>=range.last)return this._list.spliceWith(mutation.begin,0,mutation.items),applied;var opRange=new Range(mutation.begin,mutation.items.length),oldLength=this._list.length,emptyIndices=Math.max(0,Math.min(range.length,range.last-oldLength)),insertedBeforeRangeEnd=new Range(0,range.last).intersect(opRange).length,freeSlotsBeforeRange=Math.max(0,range.begin-oldLength),inserted=Math.min(range.length,insertedBeforeRangeEnd-freeSlotsBeforeRange),removed=Math.max(0,inserted-emptyIndices),removeIndex=range.last-removed-emptyIndices;if(removed>0&&applied.push({type:"remove",begin:removeIndex-range.begin,length:removed}),this._list.spliceWith(mutation.begin,0,mutation.items),inserted>0){var beginIndex=Math.max(0,mutation.begin-range.begin),sliceIndex=beginIndex+range.begin;applied.push({type:"insert",begin:beginIndex,items:this._list.slice(sliceIndex,sliceIndex+inserted)})}return applied},RangedItemList.prototype._applyRemoveMutation=function(mutation){var range=this._range,operation=null,applied=[];if(mutation.begin>=mutation.last)return this._list.spliceWith(mutation.begin,mutation.length),applied;var oldLength=this._list.length,newLength=oldLength-mutation.length,oldOverlap=Math.max(0,oldLength-range.begin),newOverlap=Math.max(0,newLength-range.begin),rangedPos=Math.max(0,mutation.begin-range.begin),removed=Math.min(oldOverlap-newOverlap,range.length-rangedPos),oldRangedLength=Math.min(range.length,oldOverlap),newRangedLength=oldRangedLength-removed,emptyIndices=range.length-newRangedLength,inserted=Math.min(emptyIndices,newOverlap-newRangedLength);if(removed>0&&(operation={type:"remove",begin:Math.max(0,mutation.begin-range.begin),length:removed},applied.push(operation)),this._list.spliceWith(mutation.begin,mutation.length),inserted>0){var beginIndex=range.length-emptyIndices,sliceIndex=beginIndex+range.begin;operation={type:"insert",begin:beginIndex,items:this._list.slice(sliceIndex,sliceIndex+inserted)},applied.push(operation)}return applied},RangedItemList.prototype._applyMoveMutation=function(mutation){var applied=(this._range,[]),removeMutation={type:"remove",begin:mutation.begin,length:mutation.length},insertIndex=mutation.end;insertIndex>mutation.begin&&(insertIndex-=mutation.length);var insertMutation={type:"insert",begin:insertIndex,items:this._list.slice(mutation.begin,mutation.begin+mutation.length)},mutationApplied=null;return mutationApplied=this._applyRemoveMutation(removeMutation),mutationApplied.length&&applied.push.apply(applied,mutationApplied),mutationApplied=this._applyInsertMutation(insertMutation),mutationApplied.length&&applied.push.apply(applied,mutationApplied),applied},RangedItemList.prototype.snapshot=function(offset,length){var self=this,base=this._base,range=this._range,version=this._version,translated=new Range(range.begin+(offset||0),length,range.length-offset);return base.snapshot(translated.begin,translated.length).then(function(snapshot){var accessor=self._createVersionedAccessor(version,offset,snapshot),snapshotRange=new Range(offset,length,Math.min(range.length,snapshot.getLength())),snapshotLength=Math.min(snapshot.getListLength(),range.length);return new Snapshot(version,accessor,snapshotRange,snapshotLength)})},RangedItemList.prototype._createVersionedAccessor=function(version,offset,snapshot){var self=this;return function(expectedVersion,index){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return snapshot.get(index-offset)}},module.exports=RangedItemList}()},{"../range":93,"./core":81,"./layered":85,"./snapshot":90,"spotify-inheritance/inherit":131,"spotify-promise":133}],90:[function(require,module,exports){!function(){"use strict";function Snapshot(version,versionedAccessor,range,listLength){return this instanceof Snapshot?(this._version=version,this._versionedAccessor=versionedAccessor,this._range=range,void(this._listLength=listLength)):new Snapshot(version,versionedAccessor,range)}var ItemList=require("./core");Snapshot.prototype.getOffset=function(){return this._range.begin},Snapshot.prototype.getLength=function(){return this._range.length},Snapshot.prototype.getListLength=function(){return this._listLength},Snapshot.prototype.getVersion=function(){return this._version},Snapshot.prototype.get=function(index){var range=this._range,offsettedIndex=range.begin+index;return 0>offsettedIndex||offsettedIndex<range.begin||offsettedIndex>range.end?ItemList.NULL_VALUE:this._versionedAccessor(this._version,offsettedIndex,index)},Snapshot.prototype.toArray=function(){for(var range=this._range,result=(range.length,[]),i=0,l=range.length;l>i;i++){var value=this.get(i);value!=ItemList.NULL_VALUE&&result.push(value)}return result},Snapshot.prototype.toFullArray=function(){for(var range=this._range,result=(range.length,[]),i=0,l=range.length;l>i;i++){var value=this.get(i);result.push(value)}return result},module.exports=Snapshot}()},{"./core":81}],91:[function(require,module,exports){!function(){"use strict";function SortedItemList(base,comparator){LayeredItemList.call(this,base),this._baseList=[],this._sortedList=null,this._rawComparator=comparator||Comparators.forString(),this._comparator=this._wrapComparator(this._rawComparator),this._ruleset=new MutationRuleset({insert:MutationResult.FORBIDDEN,move:MutationResult.FORBIDDEN}),this._init()}function SortedMutationMock(baseList,sortedList,comparator){this._baseList=baseList.slice(0),this._sortedList=sortedList.slice(0),this._length=baseList.length,this._rawComparator=this._comparator=comparator,this._version=0}function SortedMutator(baseMutator,mutationMock,resolveIndex,checkVersion,ruleset,version,length){return this instanceof SortedMutator?(Mutator.call(this,null,checkVersion,ruleset,version,length),this._baseMutator=baseMutator,this._resolveIndex=resolveIndex,void(this._mutationMock=mutationMock)):new SortedMutator(baseMutator)}var inherit=require("spotify-inheritance/inherit"),slice=Array.prototype.slice,Promise=require("spotify-promise"),Range=require("../range"),ItemList=require("./core"),Comparators=require("./comparators").Comparators,LayeredItemList=require("./layered"),MutationModule=require("./mutator"),MutationRuleset=MutationModule.MutationRuleset,MutationResult=MutationModule.MutationResult,Mutator=MutationModule.Mutator,Snapshot=require("./snapshot");inherit(SortedItemList,LayeredItemList),SortedItemList.prototype._init=function(){this._base.snapshot(0,-1).then(this._buildInitial.bind(this)).catchError(function(e){})},SortedItemList.prototype._wrapComparator=function(fn){var base=this._baseList;return function(indexA,indexB){var result=fn(base[indexA],base[indexB],indexA,indexB);return 0==result?indexA-indexB:result}},SortedItemList.prototype._buildInitial=function(snapshot){this._length=snapshot.getListLength(),this._baseList.spliceWith(0,0,snapshot.toArray()),this._sortInitial(),this._unqueueSnapshots()},SortedItemList.prototype._sortInitial=function(){for(var base=this._baseList,length=base.length,sorted=this._sortedList=new Array(length);length--;)sorted[length]=length;sorted.sort(this._comparator),this._loadedState=ItemList.LoadedState.COMPLETE},SortedItemList.prototype.snapshot=function(offset,length){var snapshot,promise=new Promise,range=new Range(offset,length,Math.max(this._length-offset,0));return 0==range.length&&this._loadedState!=ItemList.LoadedState.UNLOADED?(snapshot=new Snapshot(this._version,this._createVersionedAccessor([]),range,this._length),promise.fulfill(snapshot),promise):(this._loadedState!=ItemList.LoadedState.COMPLETE?this._queueSnapshot(offset,length,promise):(snapshot=new Snapshot(this._version,this._createVersionedAccessor(),range,this._length),promise.fulfill(snapshot)),promise)},SortedItemList.prototype._createVersionedAccessor=function(){var self=this,baseList=this._baseList,sortedList=this._sortedList;return function(expectedVersion,index){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return index in sortedList?baseList[sortedList[index]]:ItemList.NULL_VALUE}},SortedItemList.prototype._createIndexResolver=function(){var sortedList=this._sortedList;return function(index){return index in sortedList?sortedList[index]:ItemList.NULL_VALUE}},SortedItemList.prototype._createMutationMock=function(){return new SortedMutationMock(this._baseList,this._sortedList,this._rawComparator)},SortedItemList.prototype.translateIndex=function(index){return this.getLength().then(function(length){return 0>index||index>length?ItemList.OUT_OF_BOUNDS:this._sortedList[index]}.bind(this))},SortedItemList.prototype.translateIndexFromBase=function(index){return this.getLength().then(function(length){var translated=this._sortedList.indexOf(index);return-1==translated?ItemList.OUT_OF_BOUNDS:translated}.bind(this))},SortedItemList.prototype.createMutator=function(){var baseMutator=this._base.createMutator();if(!baseMutator)return null;var mutationMock=this._createMutationMock(),resolver=this._createIndexResolver(),comparator=this._createVersionComparator(),ruleset=this._ruleset;return new SortedMutator(baseMutator,mutationMock,resolver,comparator,ruleset,this._version,this._length)},SortedItemList.prototype.onMutate=function(mutations){mutations.length&&this._applyMutations(mutations)},SortedItemList.prototype._applyMutations=function(mutations){this.notify("onBeforeMutate",new Snapshot(this._version,this._createVersionedAccessor(),new Range(0,this._length),this._length));for(var applied=[],i=0,l=mutations.length;l>i;i++){var begin,length,items,offsetBegin,tempMutation,x,y,mutation=mutations[i],mutationApplied=null;switch(mutation.type){case"remove":for(begin=mutation.begin,length=mutation.length,x=0,y=length;y>x;x++)tempMutation={type:"remove",begin:begin,length:1},mutationApplied=this._applyRemoveMutation(tempMutation),mutationApplied&&applied.push(mutationApplied);break;case"move":mutationApplied=this._applyMoveMutation(mutation),mutationApplied.length&&applied.push.apply(applied,mutationApplied);break;case"insert":for(begin=mutation.begin,items=mutation.items,x=0,y=items.length;y>x;x++)offsetBegin=begin+x,tempMutation={type:"insert",begin:offsetBegin,items:[items[x]]},mutationApplied=this._applyInsertMutation(tempMutation),mutationApplied&&applied.push(mutationApplied)}}return this._version++,this.notify("onMutate",applied),applied},SortedItemList.prototype._getInsertionIndex=function(index,item){var comparisonResult,baseList=this._baseList,sortedList=this._sortedList,length=this._length,comparator=this._rawComparator,start=0,end=length-1,mid=index,state=0;if(0==length)return 0;if(1==length)return comparisonResult=comparator(item,baseList[0]),0==comparisonResult?index>0?1:-1:comparisonResult>0?1:0;for(;end>=start;)if(mid=Math.floor((start+end)/2),comparisonResult=comparator(item,baseList[sortedList[mid]]),comparisonResult>0)start=mid+1,state=1;else{if(!(0>comparisonResult)){if(index==sortedList[mid])break;index>sortedList[mid]?(mid+=1,state=1):(mid-=1,state=1);break}end=mid-1,state=0}return mid+state},SortedItemList.prototype._applyInsertMutation=function(mutation){var index=mutation.begin,item=mutation.items[0],baseList=this._baseList,sortedList=this._sortedList,applied=(this._length,this._comparator,{type:"insert",begin:index,items:[item]}),finalIndex=this._getInsertionIndex(index,item);return this._incrementSortedIndices(index),sortedList.splice(finalIndex,0,index),applied.begin=finalIndex,baseList.splice(index,0,item),this._length++,applied},SortedItemList.prototype._incrementSortedIndices=function(after){after=after||0;for(var sortedList=this._sortedList,i=0,l=sortedList.length;l>i;i++)sortedList[i]>=after&&sortedList[i]++},SortedItemList.prototype._decrementSortedIndices=function(after){after=after||0;for(var sortedList=this._sortedList,i=0,l=sortedList.length;l>i;i++)sortedList[i]>=after&&sortedList[i]--},SortedItemList.prototype._applyRemoveMutation=function(mutation){var begin=mutation.begin,baseList=this._baseList,sortedList=this._sortedList,sortedIndex=sortedList.indexOf(begin);return sortedList.splice(sortedList.indexOf(begin),1),this._decrementSortedIndices(begin),baseList.splice(begin,1),this._length--,{type:"remove",begin:sortedIndex,length:1}},SortedItemList.prototype._applyMoveMutation=function(mutation){for(var baseList=this._baseList,sortedList=this._sortedList,removeIndex=mutation.begin,insertIndex=mutation.end,length=mutation.length,operations=[],i=0,l=length;l>i;i++){var oldSortedIndex=sortedList.indexOf(removeIndex),item=baseList[removeIndex],newSortedIndex=oldSortedIndex;removeIndex>insertIndex?(baseList.splice(removeIndex,1),baseList.splice(insertIndex,0,item),this._decrementSortedIndices(removeIndex),this._incrementSortedIndices(insertIndex),sortedList.splice(oldSortedIndex,1),newSortedIndex=this._getInsertionIndex(insertIndex,item),sortedList.splice(newSortedIndex,0,insertIndex),insertIndex++,removeIndex++):insertIndex>removeIndex&&(baseList.splice(insertIndex,0,item),baseList.splice(removeIndex,1),this._incrementSortedIndices(insertIndex),this._decrementSortedIndices(removeIndex),sortedList.splice(oldSortedIndex,1),newSortedIndex=this._getInsertionIndex(insertIndex-1,item),sortedList.splice(newSortedIndex,0,insertIndex-1)),newSortedIndex>oldSortedIndex&&newSortedIndex++,oldSortedIndex!=newSortedIndex&&operations.push({type:"move",begin:oldSortedIndex,end:newSortedIndex,length:1})}return operations},SortedMutationMock.prototype.applyMutations=function(mutations){return mutations=Array.isArray(mutations)?mutations:slice.call(arguments),this._applyMutations(mutations)},SortedMutationMock.prototype.notify=function(){},SortedMutationMock.prototype._createVersionedAccessor=function(){},SortedMutationMock.prototype._applyMutations=SortedItemList.prototype._applyMutations,SortedMutationMock.prototype._getInsertionIndex=SortedItemList.prototype._getInsertionIndex,SortedMutationMock.prototype._incrementSortedIndices=SortedItemList.prototype._incrementSortedIndices,SortedMutationMock.prototype._decrementSortedIndices=SortedItemList.prototype._decrementSortedIndices,SortedMutationMock.prototype._applyInsertMutation=SortedItemList.prototype._applyInsertMutation,SortedMutationMock.prototype._applyRemoveMutation=SortedItemList.prototype._applyRemoveMutation,inherit(SortedMutator,Mutator),SortedMutator.prototype.apply=function(){return this._baseMutator.apply()},SortedMutator.prototype.add=function(items,accumulator){var allowed=this.canAdd(items.length);if(allowed!=MutationResult.ALLOWED)return allowed;if(!items.length)return MutationResult.SUCCESS;var baseMutator=this._baseMutator,result=baseMutator.canAdd(items.length);if(result!=MutationResult.ALLOWED)return result;var operations=[];baseMutator.add(items,operations);var mutations=this._mutationMock.applyMutations(operations);return accumulator&&accumulator.push.apply(accumulator,mutations),MutationResult.SUCCESS},SortedMutator.prototype.remove=function(begin,length,accumulator){var allowed=this.canRemove(begin,length);if(allowed!=MutationResult.ALLOWED)return allowed;if(0==length)return MutationResult.SUCCESS;for(var baseMutator=this._baseMutator,indices=[],i=0,l=length;l>i;i++){var index=this._resolveIndex(begin+i),result=baseMutator.canRemove(index,1);if(result!=MutationResult.ALLOWED)return result;indices.push(index)}indices.sort(Comparators.forNumber());for(var operations=[],x=0,y=length;y>x;x++)baseMutator.remove(indices[x]-x,1,operations);this._length-=length,this._mutationMock.applyMutations(operations);var mutation={type:"remove",begin:begin,length:length};return accumulator&&accumulator.push(mutation),MutationResult.SUCCESS},module.exports=SortedItemList}()},{"../range":93,"./comparators":79,"./core":81,"./layered":85,"./mutator":86,"./snapshot":90,"spotify-inheritance/inherit":131,"spotify-promise":133}],92:[function(require,module,exports){!function(){"use strict";function RootlistObserver(itemLoader,property,opt_suppressEvents){this._itemLoader=itemLoader,this._list=null,this._property=property,this._suppressEvents=!!opt_suppressEvents}RootlistObserver.prototype.onBeforeMutate=function(snapshot){this._list=snapshot.toFullArray()},RootlistObserver.prototype.onInvalidate=function(){this.emit("invalidated")},RootlistObserver.prototype.onMutate=function(mutations){for(var i=0,l=mutations.length;l>i;i++)this._applyMutation(mutations[i])},RootlistObserver.prototype._applyMutation=function(mutation){if("move"!=mutation.type){var items=mutation.items;"remove"==mutation.type&&(items=this._list.splice(mutation.begin,mutation.length));for(var uris=[],length=items.length;length--;)uris[length]=items[length].uri;var property=this._property,suppressEvents=this._suppressEvents;this._itemLoader(uris).then(function(items){for(var i=0,l=uris.length;l>i;i++){var item=items[uris[i]];if(item){var newValue="insert"==mutation.type;item[property]!=newValue&&(item[property]="insert"==mutation.type,suppressEvents||item.emit("change",{property:property,oldValue:!newValue,newValue:newValue}))}}})}},module.exports=RootlistObserver}()},{}],93:[function(require,module,exports){!function(){"use strict";function Range(offset,length,max){if(!(this instanceof Range))return new Range(offset,length,max);offset=null!=offset?offset:0,length=null!=length?length:-1,max=null!=max?max:1/0;var expectedLength=-1==length?max:length;length=-1==length?max:Math.min(length,max),this.length=length,this.expectedLength=expectedLength,this.begin=offset,this.last=offset+length,this.end=offset+length-1}var slice=Array.prototype.slice;Range.prototype.contains=function(range){return!(range.begin<this.begin||range.begin>this.end||range.end>this.end||range.end<this.begin)},Range.prototype.has=function(value){return value>=this.begin&&value<=this.end},Range.prototype.equals=function(range){return this.begin==range.begin&&this.end==range.end},Range.prototype.intersects=function(range){return this.begin<=range.end&&range.begin<=this.end},Range.prototype.contiguous=function(range){return this.last==range.begin||range.last==this.begin},Range.prototype.intersect=function(range){if(this.end<range.begin||range.end<this.begin)return new Range(NaN,0);var begin=Math.max(range.begin,this.begin),end=Math.min(range.end,this.end),length=end-begin+1;return new Range(begin,length)},Range.prototype.add=function(range){var begin=Math.min(range.begin,this.begin),end=Math.max(range.end,this.end),length=end-begin+1;return new Range(begin,length)},Range.prototype.subtract=function(range){if(this.equals(range))return[];if(this.contains(range)){var differences=[],beginDifference=new Range(this.begin,range.begin-this.begin),endDifference=new Range(range.end+1,this.end-range.end);return beginDifference.length&&differences.push(beginDifference),endDifference.length&&differences.push(endDifference),
differences}return range.contains(this)?range.subtract(this):this.intersects(range)?this.add(range).subtract(this.intersect(range)):[this,range]},Range.prototype.subtractMany=function(ranges){ranges=Array.isArray(ranges)?ranges:slice.call(arguments);for(var differences=[],result=this,i=0,l=ranges.length;l>i;i++){var range=ranges[i];if(!result.intersects(range))break;switch(result=result.subtract(result.intersect(range)),result.length){case 2:differences.push(result[0]),result=result[1];break;case 1:result=result[0];break;default:return[]}}return differences.push(result),differences},Range.prototype.fill=function(range){if(this.intersects(range))return new Range(NaN,0);var first,second;Math.min(this.begin,range.begin)==this.begin?(first=this,second=range):(first=range,second=this);var offset=first.end+1,length=second.begin-first.end-1;return new Range(offset,length)},Range.prototype.splice=function(range){if(!this.intersects(range))return this;var difference=this.subtract(range);if(difference.length){if(1==difference.length)return new Range(0,difference[0].length);var first=difference[0];return first.add(new Range(first.last,difference[1].length))}return Range(NaN,0)},Range.prototype.split=function(chunk){if(chunk>=this.length)return[new Range(this.begin,this.length)];for(var result=[],offset=this.begin,length=this.length;length;){if(chunk>length){result.push(new Range(offset,length));break}result.push(new Range(offset,chunk)),length-=chunk,offset+=chunk}return result},Range.prototype.findContainer=function(ranges){ranges=Array.isArray(ranges)?ranges:slice.call(arguments);for(var i=0,l=ranges.length;l>i;i++)if(ranges[i].contains(this))return ranges[i];return null},Range.simplify=function(ranges){ranges=Array.isArray(ranges)?ranges:slice.call(arguments);var result=[],previous=null;ranges.sort(function(a,b){return a.begin-b.begin});for(var i=0,l=ranges.length;l>i;i++){var range=ranges[i];if(!isNaN(range.begin)&&!isNaN(range.length)&&range.length){if(previous){if(previous.equals(range))continue;previous.intersects(range)||previous.contiguous(range)?range=previous.add(range):result.push(previous)}previous=range}}return previous&&result.push(previous),result},Range.splice=function(rangeToSplice,ranges){ranges=Array.isArray(ranges)?ranges:slice.call(arguments,1);var result=[],previous=null;ranges.sort(function(a,b){return a.begin-b.begin});for(var i=0,l=ranges.length;l>i;i++){var range=ranges[i].splice(rangeToSplice);isNaN(range.begin)||isNaN(range.length)||!range.length||(previous&&(previous.intersects(range)||previous.contiguous(range)?range=previous.add(range):result.push(previous)),previous=range)}return previous&&result.push(previous),result},module.exports=Range}()},{}],94:[function(require,module,exports){!function(){"use strict";function ReactorSet(){return this instanceof ReactorSet?(this._mediator=new EventEmitter,void(this._reactors=[])):new ReactorSet}function Reactor(proto){function ReactorConstructor(mediator,opt_dispatcher){this._mediator=mediator;var result=constructorFn.call(this);return opt_dispatcher&&this.attach(opt_dispatcher),void 0===result?this:result}if(!(this instanceof Reactor))return new Reactor(proto);Queueable.call(this),this._mediator,this._registry=[],proto=proto||{};var constructorFn=proto._construct||function(){};ReactorConstructor.prototype=this,ReactorConstructor.prototype.constructor=Reactor;var matcher=/([A-Z]+)\s+(.+)/;for(var key in proto)if(proto.hasOwnProperty(key)){var property=proto[key],matches=key.match(matcher);matches&&"function"==typeof property?this._createHandler(matches[1],matches[2],property):this[key]=property}return ReactorConstructor}var HandlerDescriptor,HandlerDescriptorList,slice=Array.prototype.slice,inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Queueable=require("spotify-queueable"),DispatcherResponse=require("./dispatcher").DispatcherResponse,EventEmitter=require("spotify-eventemitter");ReactorSet.prototype.create=function(proto){var reactor=new Reactor(proto);return this._reactors.push(reactor),reactor},ReactorSet.prototype.remove=function(reactor){var reactors=this._reactors,index=reactors.indexOf(reactor);return-1!=reactors.indexOf(reactor)&&reactors.splice(index,1),this},ReactorSet.prototype.add=function(reactor){if("function"!=typeof reactor||!(reactor.prototype instanceof Reactor))throw new TypeError("Argument `reactor` must be a reactor.");var reactors=this._reactors;return-1==reactors.indexOf(reactor)&&reactors.push(reactor),this},ReactorSet.prototype.attach=function(dispatcher){for(var reactors=this._reactors,i=0,l=reactors.length;l>i;i++){var reactor=new reactors[i](this._mediator);reactor.attach(dispatcher)}return this},ReactorSet.prototype.getMediator=function(){return this._mediator},inherit(Reactor,Queueable),Reactor.prototype._createHandler=function(method,path,fn){var pathSections,fnName=fn.name;if(!fnName||"anonymous"==fnName){var methodLower=method.toLowerCase();pathSections=path.split("/");var finalPathSections=[methodLower];if(2!=pathSections.length||pathSections[0]||pathSections[1])for(var toUpperCase=function(str){return str.toUpperCase()},i=0,l=pathSections.length;l>i;i++){var section=pathSections[i];section&&finalPathSections.push(section.replace(/^[a-z]/,toUpperCase))}else finalPathSections.push("Root");fnName=finalPathSections.join("")}this[fnName]=fn,this._registry.push({method:method,path:path,handler:fnName})},Reactor.prototype._subscribe=function(type,handler){var wrapper=function(event){return handler.call(this,event.payload)}.bind(this);return handler._subscribeWrapper=wrapper,this._mediator.addListener(type,wrapper),wrapper},Reactor.prototype._subscribeAll=function(handlers){var wrappers={};for(var type in handlers)wrappers[type]=this._subscribe(type,handlers[type]);return wrappers},Reactor.prototype._unsubscribe=function(type,handler){return"object"==typeof type?this._mediator.removeListeners(type):handler._subscribeWrapper&&this._mediator.removeListener(type,handler._subscribeWrapper),this},Reactor.prototype._broadcast=function(type,payload){return this._mediator.emit(type,{payload:payload}),this},Reactor.prototype._broadcastFlush=function(){this._broadcast("resources.flush")},Reactor.prototype._waitForServices=function(serviceMap){var counter=0,services=[];for(var name in serviceMap)services.push(this[name]=serviceMap[name]),counter++;for(var fn=function(){!--counter&&this._onServicesReady&&this._onServicesReady()}.bind(this),i=counter;i--;)services[i].onReady(fn,this);return this},Reactor.prototype._onServicesReady=function(){this._setReady()},Reactor.prototype._waitForCalls=function(var_args){var self=this,fns=slice.call(arguments),hasBeenCalled={},counter=fns.length;fns.forEach(function(name){var fn=self[name];if(!name||!fn||"function"!=typeof fn)throw new Error('No such method "'+name+'" in Reactor.');self[name]=function(){fn.apply(this,arguments);hasBeenCalled[name]||(counter--,hasBeenCalled[name]=!0,counter||self._onWaitedCallsDone())}})},Reactor.prototype._onWaitedCallsDone=function(){},Reactor.prototype._createResponse=function(status,headers,body){return new DispatcherResponse(status,headers,body)},Reactor.prototype._createPromise=function(){return new Promise},Reactor.prototype._wrapDecoratorRequest=function(requestSender){return function(uris){return requestSender({flush:!0},{uris:uris}).then(function(response){return response.body.result})}},Reactor.prototype.attach=function(dispatcher){if(!dispatcher||"function"!=typeof dispatcher.register)throw new TypeError("Reactor.attach: Argument `dispatcher` must be a Dispatcher object.");for(var registry=this._registry,attached=[],i=0,l=registry.length;l>i;i++){var item=registry[i],method=item.method,path=item.path,handler=this._makeQueueable(this[item.handler].bind(this));dispatcher.register(method,path,handler),attached.push({method:method,path:path,handler:handler})}return attached},module.exports={HandlerDescriptor:HandlerDescriptor,HandlerDescriptorList:HandlerDescriptorList,ReactorSet:ReactorSet,Reactor:Reactor}}()},{"./dispatcher":62,"spotify-eventemitter":128,"spotify-inheritance/inherit":131,"spotify-promise":133,"spotify-queueable":40}],95:[function(require,module,exports){!function(){"use strict";function getGroupId(username,extraSalt){if(extraSalt&&"NTX_"==extraSalt.substring(0,4)){var lut=Crypto.Lut.calc(extraSalt),sp="spotify:test:"+username,dgt=parseInt(Crypto.md5.encode(sp).substring(0,8),16),bucket=Math.floor(1e4*dgt*Math.pow(2,-32)),internalGroup=lut[bucket],externalGroup=Math.floor(internalGroup/10);return externalGroup}var st="spotify:test:";extraSalt&&(st+=extraSalt+":"),st+=username;var digest=parseInt(Crypto.md5.encode(st).substring(0,8),16);return Math.floor(1e3*digest*Math.pow(2,-32))}var Reactor=require("../reactor"),Crypto=require("spotify-crypto"),ResponseStatus=require("../dispatcher").ResponseStatus,ABTestsReactor=new Reactor.Reactor({_construct:function(){this._setReady()},"GET /user/groupid":function(request,dispatcher){var body=request.body,promise=this._createPromise(),response=this._createResponse();if(body.username&&body.salt&&"string"==typeof body.salt){var result=getGroupId(body.username,body.salt);response.setBodyField("id",result),promise.fulfill(response)}else response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response);return promise}});module.exports=ABTestsReactor}()},{"../dispatcher":62,"../reactor":94,"spotify-crypto":33}],96:[function(require,module,exports){"use strict";var Reactors={ABTests:require("./abtests"),List:require("./lists"),Metadata:require("./metadata"),Playlist:require("./playlist"),Profile:require("./profile"),Resources:require("./resources"),Search:require("./search"),Session:require("./session"),Toplist:require("./toplist"),PersistedPlay:require("./persistedplay"),Suggest:require("./suggest")};module.exports=Reactors},{"./abtests":95,"./lists":97,"./metadata":98,"./persistedplay":99,"./playlist":100,"./profile":101,"./resources":102,"./search":103,"./session":104,"./suggest":105,"./toplist":106}],97:[function(require,module,exports){!function(){"use strict";var Descriptor=require("../lists").Descriptor,ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,ListReactor=new Reactor({_construct:function(){this._listManager=null,this._subscribeAll({"resources.listmanager":this._onListManager}),this._setReady()},_onListManager:function(listManager){this._listManager=listManager},"GET /list":function(request,dispatcher){var promise=this._createPromise(),response=this._createResponse(),descriptor=request.body.descriptor;if(!descriptor||descriptor instanceof Descriptor.Base||(descriptor=Descriptor.from(descriptor)),response.setBodyField("descriptor",descriptor),!descriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var list=this._listManager.get(descriptor);return list?(response.setStatus(ResponseStatus.OK).setBodyField("list",list),promise.fulfill(response)):(response.setStatus(ResponseStatus.NOT_FOUND),promise.fail(response)),promise},"UPDATE /list":function(request,dispatcher){var promise=this._createPromise(),response=this._createResponse(),descriptor=Descriptor.extractList(request.body.descriptor),list=request.body.list;return this._listManager.set(descriptor,list)?(response.setStatus(ResponseStatus.OK).setBodyField("descriptor",descriptor),promise.fulfill(response)):(response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response)),promise}});module.exports=ListReactor}()},{"../dispatcher":62,"../lists":76,"../reactor":94}],98:[function(require,module,exports){!function(){"use strict";var SimpleCache=Spotify.SimpleCache,Link=Spotify.Link,LinkHelper=require("../extension").LinkHelper,Promise=require("spotify-promise"),RequestQueue=require("../requestqueue"),Entities=require("../entities"),ItemList=require("../lists"),SubItemList=require("../sublists"),Descriptor=ItemList.Descriptor,ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,MetadataReactor=(Array.prototype.slice,new Reactor({_construct:function(){this._cdnUrls=null,this._listManager=null,this._metadataService=null,this._albumCache=new SimpleCache(1e3),this._artistCache=new SimpleCache(1e3),this._trackCache=new SimpleCache(1e3),this._adQueue=new RequestQueue,this._albumQueue=new RequestQueue,this._artistQueue=new RequestQueue,this._trackQueue=new RequestQueue,this._processAd=this._createProcessor(Entities.AdTrack,this._trackCache),this._processAlbum=this._createProcessor(Entities.Album,this._albumCache),this._processArtist=this._createProcessor(Entities.Artist,this._artistCache),this._processTrack=this._createProcessor(Entities.Track,this._trackCache),this._handleAdError=this._createErrorHandler(this._trackCache),this._handleAlbumError=this._createErrorHandler(this._albumCache),this._handleArtistError=this._createErrorHandler(this._artistCache),this._handleTrackError=this._createErrorHandler(this._trackCache),this._waitForCalls("_onServicesReady","_onImageResources","_onAdChooser","_onListManager"),this._subscribeAll({"resources.core":this._onCore,"resources.flush":this._onFlush,"resources.image":this._onImageResources,"resources.listmanager":this._onListManager,"resources.tracklistresolver":this._onTrackListResolver,"resources.adchooser":this._onAdChooser})},_onWaitedCallsDone:function(){this._setReady()},_onCore:function(core){this._waitForServices({_metadataService:core.metadata})},_onFlush:function(){this._queryMetadataService(this._albumQueue,this._processAlbum,this._handleAlbumError),this._queryMetadataService(this._artistQueue,this._processArtist,this._handleArtistError),this._queryMetadataService(this._trackQueue,this._processTrack,this._handleTrackError),this._queryAdChooserService(this._adQueue,this._processAd,this._handleAdError)},_onImageResources:function(cdnUrls){this._cdnUrls=cdnUrls},_onAdChooser:function(adChooser){this._adChooserService=adChooser},_onListManager:function(listManager){this._listManager=listManager},_onServicesReady:function(){},_onTrackListResolver:function(trackListResolver){trackListResolver.register("album",function(uri,descriptor,dispatcher,listManager){return dispatcher.get("/album/tracks",null,{descriptor:descriptor}).access("body","list")}),trackListResolver.register("artist",function(uri,descriptor,dispatcher){return descriptor=Descriptor.fromObject(descriptor),descriptor=new Descriptor.Ranged(descriptor,[0,10],1),dispatcher.get("/artist/toptracks",null,{descriptor:descriptor}).access("body","list")}),trackListResolver.register("artist-toplist",function(uri,descriptor,dispatcher){if("tracks"==uri.toplist)return dispatcher.get("/artist/toptracks",null,{descriptor:descriptor}).access("body","list");var promise=new Promise;return promise.fail(new Error("Not Found")),promise})},_queryMetadataService:function(queue,processor,errorHandler){var uris=queue.takeIds();uris.length&&this._metadataService.lookup(uris,processor.bind(this,uris,queue),errorHandler.bind(this,uris,queue))},_queryAdChooserService:function(queue,processor,errorHandler){var uris=queue.takeIds();uris.length&&this._adChooserService.lookup(uris,processor.bind(this,uris,queue),errorHandler.bind(this,uris,queue))},_createProcessor:function(Type,cache){return function(uris,queue,serviceResponse,serviceStatus){Array.isArray(uris)||(uris=[uris]);for(var i=0,l=uris.length;l>i;i++){var promise=this._processServiceItem(Type,queue,uris[i],serviceResponse[i]);promise.then(cache.put.bind(cache,uris[i]))}}},_processServiceItem:function(Type,queue,uri,metadata){var response=this._createResponse(),promises=queue.takeValues(uri),promise=Promise.group(promises),resourceUrl=this._cdnUrls.unbranded;return response.setBodyField("uri",uri),metadata?(metadata.resourceUrl||(metadata.resourceUrl=resourceUrl),Type.create(uri,metadata).then(function(type){promise.fulfill(response.setBodyField("result",type))},function(parsingError){promise.fail(response.setStatus(ResponseStatus.BAD_GATEWAY))})):promise.fail(response.setStatus(ResponseStatus.NOT_FOUND)),promise},_createErrorHandler:function(cache){return function(uris,queue,error){Array.isArray(uris)||(uris=[uris]);for(var i=0,l=uris.length;l>i;i++){var uri=uris[i],response=this._createResponse().setBodyField("uri",uri),promises=queue.takeValues(uri),promise=Promise.group(promises);promise.then(cache.put.bind(cache,uri)),promise.fail(response.setStatus(error.code))}}},_multiplexMetadataRequest:function(request,dispatcher,path){var headers=request.headers,body=request.body,promise=this._createPromise(),response=this._createResponse(),uris=body.uris,len=uris.length,result={};if(!uris.length)return response.setBodyFields({uris:uris,result:result}),response;for(var aggregator=function(serviceResponse){var body=serviceResponse.body;result[body.uri]=serviceResponse.status==ResponseStatus.OK?body.result:null,--len||promise.fulfill(response.setBodyFields({uris:uris,result:result}))},i=0,l=uris.length;l>i;i++)dispatcher.get(path,{bypassDecoration:headers.bypassDecoration,forceStarred:headers.forceStarred},{uri:uris[i]}).then(aggregator,aggregator);return headers.flush&&this._broadcastFlush(),promise},_getArtistSublist:function(request,dispatcher,suffix,listCreator){var self=this,listManager=this._listManager,promise=this._createPromise(),response=this._createResponse(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var artistURI=Link.artistLink(uri.id);baseDescriptor.uri=artistURI.toURI()+":"+suffix;var list=listManager.get(descriptor);return list?(response.setBodyField("list",list),promise.fulfill(response),promise):dispatcher.get("/artist",{flush:!0},{uri:uri}).then(function(serviceResponse){var list=listCreator.call(self,uri.toURI(),dispatcher,serviceResponse);if(listManager.set(descriptor,list))return response.setBodyField("list",listManager.get(descriptor)),response;throw response.setStatus(ResponseStatus.BAD_REQUEST),response})},_processAlbum:function(Album,albumTrack,uris,requestQueue,serviceResponse,serviceStatus){},_processArtist:function(Artist,artistCache,uris,requestQueue,serviceResponse,serviceStatus){},_processTrack:function(Track,trackCache,uris,requestQueue,serviceResponse,serviceStatus){},_createAlbumDecorator:function(request,dispatcher,original){var self=this,promise=this._createPromise(),listManager=this._listManager;return promise.then(function(response){var album=response.body&&response.body.result;if(album){for(var discs=album.discs,lists=[],i=0,l=discs.length;l>i;i++){var disc=discs[i],requestSender=self._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/tracks")),list=new SubItemList.DiscTrack(disc.uri,disc.trackURIs);list=new SubItemList.MetadataDecorator(list,requestSender),listManager.set(new Descriptor.List(disc.uri),list),lists.push(list)}var albumList=new SubItemList.AlbumTrack(album.uri,lists);listManager.set(new Descriptor.List(album.uri),albumList)}return response}).pipe(original),promise},_createArtistDecorator:function(){var promise=this._createPromise();return promise.then(function(artist){return artist}),promise},_createTrackDecorator:function(dispatcher,promise){return promise.then(function(track){return Promise.join(track,dispatcher.get("/starredlist",null,{descriptor:new Descriptor.List("spotify:user:@")})).catchError(function(response){if(response.status==ResponseStatus.NOT_FOUND)return[track,null];throw response})}).thenSpread(function(track,serviceResponse){if(!serviceResponse)return[track,!1];var list=serviceResponse.body.list.getBaseListType(SubItemList.Mappable);return Promise.join(track,list.contains(track.body.result.uri))}).thenSpread(function(track,isStarred){return track.body.result.starred=!!isStarred,track})},_createStarredTrackDecorator:function(promise){return promise.then(function(track){return track.body.result.starred=!0,track})},_createAlbumGroupList:function(uri,dispatcher,serviceResponse){var artist=serviceResponse.body.result,list=new ItemList.Array(artist.getAlbumGroups());return list},_createAppearsOnGroupList:function(uri,dispatcher,serviceResponse){var artist=serviceResponse.body.result,list=new ItemList.Array(artist.getAppearsOnGroups());return list},_createSingleGroupList:function(uri,dispatcher,serviceResponse){var artist=serviceResponse.body.result,list=new ItemList.Array(artist.getSingleGroups());return list},_createRelatedList:function(uri,dispatcher,serviceResponse){var artist=serviceResponse.body.result,related=new ItemList.Array(artist.getRelatedArtists()),decorator=this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/artists")),list=new SubItemList.MetadataDecorator(related,decorator);return list},_createToptracksList:function(uri,dispatcher,serviceResponse){var artist=serviceResponse.body.result,toptracks=new ItemList.Array(artist.getTopTracks()),decorator=this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/tracks")),list=new SubItemList.MetadataDecorator(toptracks,decorator);return list},"GET /track":function(request,dispatcher){var response,headers=request.headers,body=request.body,promise=this._createPromise(),uri=LinkHelper.from(body.uri);if(!uri||"track"!=uri.type&&"local"!=uri.type&&"ad"!=uri.type)return response=this._createResponse(),response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var cached=this._trackCache.get(uri);if(cached)cached.status!=ResponseStatus.OK?promise.fail(cached):promise.fulfill(cached);else if("local"==uri.type)response=this._createResponse(),response.setBodyField("uri",uri.toString()),response.setBodyField("result",new Entities.LocalTrack(uri)),promise.fulfill(response);else{if("ad"!=uri.type){var trackDecorator;return headers.forceStarred?trackDecorator=this._createStarredTrackDecorator(promise):headers.bypassDecoration||(trackDecorator=this._createTrackDecorator(dispatcher,promise)),this._trackQueue.push(uri,promise),headers.flush&&this._broadcastFlush(),trackDecorator||promise}this._adQueue.push(uri,promise),headers.flush&&this._broadcastFlush()}return promise},"GET /tracks":function(request,dispatcher){return this._multiplexMetadataRequest(request,dispatcher,"/track")},"GET /album":function(request,dispatcher){var headers=request.headers,body=request.body,promise=this._createPromise(),uri=LinkHelper.from(body.uri);if(!uri||"album"!=uri.type){var response=this._createResponse();return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise}var cached=this._albumCache.get(uri);if(cached)cached.status!=ResponseStatus.OK?promise.fail(cached):promise.fulfill(cached);else{var albumDecorator=this._createAlbumDecorator(request,dispatcher,promise);this._albumQueue.push(uri,albumDecorator),headers.flush&&this._broadcastFlush()}return promise},"GET /albums":function(request,dispatcher){return this._multiplexMetadataRequest(request,dispatcher,"/album")},"GET /album/tracks":function(request,dispatcher){var listManager=this._listManager,response=this._createResponse(),promise=this._createPromise(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri||"album"!=uri.type)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var list=listManager.get(descriptor);return list?(response.setBodyField("list",list),promise.fulfill(response),promise):dispatcher.get("/album",{flush:!0},{uri:uri.toString()}).then(function(){var list=listManager.get(descriptor);return response.setBodyField("list",list),response})},"GET /album/disc/tracks":function(request,dispatcher){var listManager=this._listManager,promise=this._createPromise(),response=this._createResponse(),body=request.body,descriptor=Descriptor.fromObject(body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri||"album"!=uri.type||isNaN(uri.disc))return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var albumUri=LinkHelper.clone(uri);albumUri.disc=NaN;var list=listManager.get(descriptor);return list?(response.setBodyField("list",list),promise.fulfill(response),promise):dispatcher.get("/album",{flush:!0},{uri:albumUri.toString()}).then(function(){var list=listManager.get(descriptor);return response.setBodyField("list",list),response})},"GET /artist":function(request,dispatcher){var headers=request.headers,body=request.body,promise=this._createPromise(),uri=LinkHelper.from(body.uri);if(!uri||"artist"!=uri.type){var response=this._createResponse();return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise}var cached=this._artistCache.get(uri);if(cached)cached.status!=ResponseStatus.OK?promise.fail(cached):promise.fulfill(cached);else{var artistDecorator=this._createArtistDecorator();artistDecorator.pipe(promise),this._artistQueue.push(uri,artistDecorator),headers.flush&&this._broadcastFlush()}return promise},"GET /artists":function(request,dispatcher){return this._multiplexMetadataRequest(request,dispatcher,"/artist")},"GET /artist/albums":function(request,dispatcher){return this._getArtistSublist(request,dispatcher,"albums",this._createAlbumGroupList)},"GET /artist/appearances":function(request,dispatcher){return this._getArtistSublist(request,dispatcher,"appearances",this._createAppearsOnGroupList)},"GET /artist/singles":function(request,dispatcher){return this._getArtistSublist(request,dispatcher,"singles",this._createSingleGroupList)},"GET /artist/related":function(request,dispatcher){return this._getArtistSublist(request,dispatcher,"related",this._createRelatedList)},"GET /artist/toptracks":function(request,dispatcher){var descriptor=Descriptor.extractList(request.body.descriptor);if(descriptor){var link=LinkHelper.from(descriptor.uri);"artist"!=link.type&&link.id&&(request.body.descriptor.uri=Link.artistLink(link.id).toURI())}return this._getArtistSublist(request,dispatcher,"top:tracks",this._createToptracksList)}}));module.exports=MetadataReactor}()},{"../dispatcher":62,"../entities":63,"../extension":73,"../lists":76,"../reactor":94,"../requestqueue":107,"../sublists":109,"spotify-promise":133}],99:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,Promise=require("spotify-promise"),ItemList=require("../lists"),MutationResult=ItemList.MutationResult,SubItemList=require("../sublists"),Descriptor=ItemList.Descriptor,Reactor=require("../reactor").Reactor,ResponseStatus=require("../dispatcher").ResponseStatus,PersistedPlayReactor=new Reactor({_construct:function(){this._contextPlayer=null,this._storage=null,this._storageKey=null,this._waitForCalls("_onContextPlayerGroup","_onSessionChange","_onStorage"),this._subscribeAll({"resources.playergroup":this._onContextPlayerGroup,"resources.storage":this._onStorage,"session.change":this._onSessionChange})},_onContextPlayerGroup:function(playerGroup){this._contextPlayer=playerGroup.get("main")},_onSessionChange:function(session){this._storageKey="persistedplay:"+encodeURIComponent(session.user.username)},_onStorage:function(storage){this._storage=storage},_onWaitedCallsDone:function(){this._setReady()},"UPDATE /persistedplay":function(request,dispatcher){var self=this,response=this._createResponse(),contextPlayer=this._contextPlayer;return Promise.join(contextPlayer.getPlayerState(),contextPlayer.getQueueList().toArray(),(contextPlayer.getContextList()||{next:function(){return{}}}).next()).thenSpread(function(state,queuedTracks,nextTrack){var playbackState=state.playbackState,trackState=state.trackState,contextState=state.contextState,track=trackState.track,intercept=null;if(track){if(track.advertisement){if(intercept=track,!nextTrack.uri)return;track=nextTrack}var persistedState={intercept:intercept,track:track.uri,album:track.album.uri,position:trackState.position,repeat:playbackState.repeatMode,shuffle:contextState.shuffle,volume:playbackState.volume},len=queuedTracks.length;if(len){for(var queued=new Array(len);len--;)queued[len]=queuedTracks[len].uri;persistedState.queued=queued}else persistedState.queued=[];self._storage.set(self._storageKey,JSON.stringify(persistedState))}}),response.setStatus(ResponseStatus.ACCEPTED),response},"GET /persistedplay":function(request,dispatcher){var contextPlayer=this._contextPlayer;return this._storage.get(this._storageKey).then(function(persistedState){if(persistedState){try{persistedState=JSON.parse(persistedState)}catch(e){return}return contextPlayer.setRepeatMode(persistedState.repeat),contextPlayer.setShuffle(persistedState.shuffle),contextPlayer.setVolume(persistedState.volume),dispatcher.get("/album/tracks",null,{descriptor:new Descriptor.List(persistedState.album)}).access("body","list").then(function(albumList){return Promise.join(albumList,albumList.snapshot(0,-1).call("toArray"))}).thenSpread(function(albumList,snapshotArray){for(var index=snapshotArray.length;index--&&snapshotArray[index].uri!=persistedState.track;);if(-1!=index){if(persistedState.intercept){var intercept=contextPlayer.getInterceptList(),mutator=intercept.createMutator();mutator&&mutator.canAdd(1)&&(mutator.add([persistedState.intercept]),mutator.apply())}albumList=new SubItemList.Context(albumList,Link.fromString(persistedState.album).toAppURI());var returned=contextPlayer.play(albumList,{index:index,offset:0,initialOffset:persistedState.position,duration:-1,pause:!0,reason:"persisted",rules:contextPlayer.getRuleFor("default")}),queued=persistedState.queued;return queued&&queued.length&&dispatcher.get("/tracks",{flush:!0},{uris:queued}).then(function(response){for(var results=response.body.result,tracks=[],i=0,l=queued.length;l>i;i++){var track=results[queued[i]];track&&tracks.push(track)}var queue=contextPlayer.getQueueList(),mutator=queue.createMutator();mutator&&mutator.canAdd(tracks.length)==MutationResult.ALLOWED&&(mutator.add(tracks),mutator.apply())}),returned}})}}),this._createPromise()}});module.exports=PersistedPlayReactor}()},{"../dispatcher":62,"../lists":76,"../reactor":94,"../sublists":109,"spotify-promise":133}],100:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,LinkHelper=require("../extension").LinkHelper,Promise=require("spotify-promise"),SimpleCache=Spotify.SimpleCache,ItemList=require("../lists"),SubItemList=require("../sublists"),Descriptor=ItemList.Descriptor,MutationRuleset=ItemList.MutationRuleset,MutationResult=ItemList.MutationResult,Entities=require("../entities"),Reactor=require("../reactor").Reactor,ResponseStatus=require("../dispatcher").ResponseStatus,RootlistObserver=require("../observers/rootlist"),PlaylistReactor=new Reactor({_construct:function(){this._cdnUrls=null,this._currentSession=null,this._listManager=null,this._metadataCache=new SimpleCache(1e3),this._metadataService=null,this._metadataWaiters={},this._popcountService=null,this._rootlistObserver=null,this._publishedRootlistObserver=null,this._sessionRootlist=null,this._sessionPublishedRootlist=null,this._sessionStarredList=null,this._subscriberListCache=new SimpleCache(100),this._starredListObserver=null,this._waitForCalls("_onServicesReady","_onImageResources","_onListManager","_onSessionChange"),this._subscribeAll({"resources.core":this._onCore,"resources.image":this._onImageResources,"resources.listmanager":this._onListManager,"resources.tracklistresolver":this._onTrackListResolver,"session.change":this._onSessionChange})},_onCore:function(core){this._featuresService=core.features,this._waitForServices({
_playlistService:core.playlist,_popcountService:core.popcount})},_onImageResources:function(cdnUrls){this._cdnUrls=cdnUrls},_onListManager:function(listManager){this._listManager=listManager},_onServicesReady:function(){if(this._featuresService.isEnabled("playlistPubSub")){var service=this._playlistService;service.bind("CHANGE",this._updatePlaylistState.bind(this))}},_onSessionChange:function(session){this._currentSession=session,this._sessionRootlist&&this._sessionRootlist.unobserve(this._rootlistObserver),this._sessionPublishedRootlist&&this._sessionPublishedRootlist.unobserve(this._publishedRootlistObserver),this._sessionStarredList&&this._sessionStarredList.unobserve(this._starredListObserver),this._sessionRootlist=null,this._sessionPublishedRootlist=null,this._sessionStarredList=null},_onTrackListResolver:function(trackListResolver){var resolver=function(uri,descriptor,dispatcher,listManager){return dispatcher.get("/playlist/tracks",null,{descriptor:descriptor}).access("body","list").then(function(list){return new ItemList.Property(list,"track")})};trackListResolver.register("playlist",resolver),trackListResolver.register("starred",resolver),trackListResolver.register("trackset",resolver)},_onWaitedCallsDone:function(){this._setReady()},_updatePlaylistState:function(e){var self=this,params=e.params;if(!params.ops||!params.ops.length)return void this._playlistService.getChangesFromHead(params.uri,function(r){r.operations&&r.operations.length&&(e.params.ops=r.operations,self._updatePlaylistState(e))});var listManager=this._listManager;if(listManager){var list=listManager.get(new Descriptor.List(params.uri));return list&&(list=list.getBaseList())?void list.ensureMutated().then(this._mutatePlaylist.bind(this,e.params,list)).catchError(function(e){console.error(e.stack)}):null}},_mutatePlaylist:function(params,list){var self=this,rev=params.revision,uri=params.uri,ops=params.ops,hasRevision=list.hasRevision(rev),isRoot=list.constructor==SubItemList.PlaylistRoot,mutator=list.createMutator();if(mutator){mutator.setInternal(!0),mutator.setTranslated(!0);for(var i=0,l=ops.length;l>i;i++){var operation,len,op=ops[i];switch(op.kind){case"UPDATE_ITEM_ATTRIBUTES":if(hasRevision||!isRoot)break;this._updateRootItemAttribute(list,op);break;case"UPDATE_LIST_ATTRIBUTES":this._updateListAttributes(uri,op);break;case"ADD":if(hasRevision)break;operation=op.add;var items=operation.items;if(len=items.length,mutator.canInsert(operation.fromIndex,len)==MutationResult.ALLOWED){for(var rows=new Array(len);len--;){var entity,item=items[len];if(isRoot){var itemURI=LinkHelper.from(item.uri);if(itemURI&&"application"==itemURI.type&&("start-group"==itemURI.id||"end-group"==item.uri.id)){var rawURI=item.uri;item.uri=Link.folderLink(self._currentSession.user.username,itemURI.args[0]),item.attributes=item.attributes||{},item.attributes.folder=!0,item.attributes.name=itemURI.args[1]||null,item.attributes.start="start-group"==itemURI.id,item.attributes.rawURI=rawURI}entity=new Entities.RootlistRow(item.uri,item.attributes)}else entity=new Entities.PlaylistRow(item.uri,item.attributes);rows[len]=entity}mutator.insert(operation.fromIndex,rows)}break;case"REM":if(hasRevision)break;operation=op.rem,mutator.canRemove(operation.fromIndex,operation.length)==MutationResult.ALLOWED&&mutator.remove(operation.fromIndex,operation.length);break;case"MOV":if(hasRevision)break;operation=op.mov,mutator.canMove(operation.fromIndex,operation.toIndex,operation.length)==MutationResult.ALLOWED&&mutator.move(operation.fromIndex,operation.toIndex,operation.length)}}mutator.isEmpty()||mutator.apply(),hasRevision||list.setRevision(rev)}},_updateRootItemAttribute:function(list,op){var self=this,update=op.update_item_attributes,index=update.index,attributes=update.new_attributes.values;return list.snapshot(index,1).then(function(snapshot){var item=snapshot.get(0);if(item!=ItemList.NULL_VALUE){for(var attr in attributes){var value=attributes[attr];item[attr]=value;var newAttributes={};"public"==attr?newAttributes.published=value:newAttributes[attr]=value,self._updateListAttributes(item.uri,{update_list_attributes:{new_attributes:{values:newAttributes}}})}var mutator=list.createMutator();return mutator.setInternal(!0),mutator.remove(index,1),mutator.insert(index,[item]),mutator.apply()}})},_updateListAttributes:function(uri,op){var playlistMetadata=this._metadataCache.get(uri);if(playlistMetadata&&playlistMetadata.body&&playlistMetadata.body.result&&playlistMetadata.status==ResponseStatus.OK){var playlist=playlistMetadata.body.result,updatedAttributes=op.update_list_attributes,attributes=updatedAttributes.new_attributes.values;for(var attribute in attributes){var oldAttr=playlist[attribute];playlist[attribute]=attributes[attribute],playlist.emit("change",{property:attribute,oldValue:oldAttr,newValue:attributes[attribute]})}}},_queryPlaylistMetadataService:function(uri,dispatcher){var self=this,promise=this._createPromise();return this._playlistService.metadata(uri.toString(),function(response){self._processPlaylistMetadata(uri,dispatcher,response).pipe(promise)},function(error){self._handleMetadataError(uri,error).pipe(promise)}),promise},_processPlaylistMetadata:function(uri,dispatcher,metadata){var self=this,promise=this._createPromise(),resourceUrl=this._cdnUrls.unbranded,response=this._createResponse();return response.setBodyField("uri",uri),this._metadataCache.put(uri,response),metadata.resourceUrl||(metadata.resourceUrl=resourceUrl),Entities.Playlist.create(uri,metadata).then(function(playlist){"starred"==uri.type&&(playlist.name="Starred"),self._decorateAllows(uri,playlist),promise.fulfill(response.setBodyField("result",playlist))},function(parsingError){promise.fail(response.setStatus(ResponseStatus.BAD_GATEWAY))}),promise},_handleMetadataError:function(uri,error){var promise=this._createPromise(),response=this._createResponse();return response.setStatus(error.code).setBodyField("uri",uri),404==error.code&&this._metadataCache.put(uri,response),promise.fail(response),promise},_createTracksetList:function(uri,dispatcher){for(var tracks=uri.tracks,len=tracks.length,rows=[],addedBy=this._currentSession.user.username,timestamp=(new Date).getTime();len--;){var track=tracks[len].toString();rows[len]=new Entities.PlaylistRow(track,{added_by:addedBy,timestamp:timestamp,track:track})}var list=new SubItemList.PlaylistTrackDecorator(new ItemList.Array(rows),this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/tracks")));return list},_getRootlist:function(dispatcher){var self=this,promise=this._createPromise();return this._sessionRootlist?(promise.fulfill(this._sessionRootlist),promise):dispatcher.get("/rootlist",null,{descriptor:new Descriptor.List("spotify:user:@:rootlist")}).then(function(response){var list=response.body.list;if(null==list)return self._getRootlist();self._sessionRootlist&&self._sessionRootlist.unobserve(self._rootlistObserver),self._sessionRootlist=list;var observer=self._rootlistObserver=new RootlistObserver(self._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/playlists")),"subscribed");return list.observe(observer),list.observe({onMutate:function(mutations){for(var i=0,l=mutations.length;l>i;i++){var mutation=mutations[i];if("insert"==mutation.type){var items=mutation.items.map(function(e){return e.uri});self._playlistService.subscribeToPlaylists(items)}}}}),list.preload()})},_getPublishedRootlist:function(dispatcher,rootlist){try{if(this._sessionPublishedRootlist){var promise=this._createPromise();return promise.fulfill(this._sessionPublishedRootlist),promise}var user=this._currentSession.user.username,uri=Link.publishedRootlistLink(user),list=new ItemList.Filtered(rootlist,function(item){return item&&!!item["public"]}),mappedList=new SubItemList.Mappable(list,"uri");mappedList.setDescriptor(new Descriptor.List(uri)),this._sessionPublishedRootlist=mappedList;var observer=this._publishedRootlistObserver=new RootlistObserver(this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/playlists")),"published");return list.observe(observer),this._sessionPublishedRootlist.preload()}catch(e){console.error(e.stack)}},_createPlaylistItemsLoader:function(){var service=this._playlistService;return function(uri,range){var promise=new Promise;return service.list({uri:uri,offset:range.begin,total:range.length},promise.fulfill.bind(promise),promise.fail.bind(promise)),promise}},_performStarredPlaylistOperations:function(uri,operations){var playlistService=this._playlistService,promise=this._createPromise();promise.fulfill(!0);for(var i=0,l=operations.length;l>i;i++){var operation=operations[i];"ADD"==operation.kind?promise=promise.then(function(operation,result){var opPromise=new Promise;return playlistService.starTracks(operation.items,opPromise.fulfill.bind(opPromise,!0),opPromise.fail.bind(opPromise)),opPromise}.bind(this,operation)):"REM"==operation.kind&&(promise=promise.then(function(operation,result){var opPromise=new Promise;return playlistService.unstarTracks(operation.items,opPromise.fulfill.bind(opPromise,!0),opPromise.fail.bind(opPromise)),opPromise}.bind(this,operation)))}return promise},_performPlaylistServiceOperations:function(uri,operations){var promise=this._createPromise();return this._playlistService.modifyPlaylist(uri.toString(),operations,function(success,params){promise.fulfill(params.revision)},promise.fail.bind(promise)),promise},_createPlaylistOperationApplicator:function(){return this._performPlaylistServiceOperations.bind(this)},_createPlaylistSubscribersLoader:function(){var service=this._popcountService;return function(uri,range){var promise=new Promise;return service.get(uri.toString(),range.last,!1,null,function(serviceResponse){if(serviceResponse=serviceResponse[0],serviceResponse&&serviceResponse.user&&serviceResponse.user.length){var result={length:serviceResponse.count,contents:serviceResponse.user.slice(range.begin,range.last)};promise.fulfill(result)}else promise.fulfill({length:0,contents:[]})},promise.fail.bind(promise)),promise}},_createRootlist:function(uri){var descriptor=new Descriptor.List(uri),list=new SubItemList.Mappable(new SubItemList.PlaylistRoot(uri,this._createPlaylistItemsLoader(),this._createPlaylistOperationApplicator()),"uri");return this._listManager.set(descriptor,list),list},_createPlaylist:function(uri,response,dispatcher){var list,requestSender=this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/tracks"));if("starred"==uri.type){if(list=new ItemList.Sorted(new SubItemList.PlaylistTrackDecorator(new SubItemList.PlaylistStarred(uri,this._createPlaylistItemsLoader(),this._performStarredPlaylistOperations.bind(this)),function(uris){return dispatcher.get("/tracks",{flush:!0,forceStarred:!0},{uris:uris}).then(function(response){return response.body.result})}),function(a,b,indexA,indexB){var timeA=a.addTime||indexA,timeB=b.addTime||indexB,result=timeB-timeA;return 0==result?indexB-indexA:result}),uri.username==this._currentSession.user.username){list=new SubItemList.Mappable(list,"uri"),this._sessionStarredList=list;var starredListObserver=new RootlistObserver(requestSender,"starred",!0);this._starredListObserver=starredListObserver,list.observe(starredListObserver)}}else list=new SubItemList.PlaylistTrackDecorator(new SubItemList.PlaylistRow(uri,this._createPlaylistItemsLoader(),this._performPlaylistServiceOperations.bind(this)),requestSender);return this._listManager.set(new Descriptor.List(uri),list),this._decoratePermissions(response,list),list},_createSubscriberList:function(uri){var list=new SubItemList.PlaylistSubscribers(uri,this._createPlaylistSubscribersLoader());return this._subscriberListCache.put(uri,list),list},_calculatePlaylistPopularity:function(list){return list.getLength().then(function(length){var popularity=Math.round(Math.min(Math.log(length+1)/Math.LN10*25,100));return popularity})},_createPlaylistDecorator:function(dispatcher){var self=this,promise=(this._listManager,this._createPromise()),decoratedPromise=promise.then(function(response){return self._getRootlist(dispatcher).then(function(rootlist){return Promise.join(response,rootlist,self._getPublishedRootlist(dispatcher,rootlist))}).thenSpread(self._checkSubscribedAndPublished).thenSpread(self._decorateSubscribedAndPublished.bind(self))},function(e){throw e});return{promise:promise,decorated:decoratedPromise}},_checkSubscribedAndPublished:function(response,rootlist,published){var uri=response.body.uri;return Promise.join(response,rootlist.contains(uri),published.contains(uri))},_decorateSubscribedAndPublished:function(response,subscribed,published){var body=response.body;if(body){var result=body.result;if(result){result.subscribed=subscribed,result.published=published;var uri=LinkHelper.from(body.uri);"starred"==uri.type&&result.ownerName==this._currentSession.user.username&&(result.subscribed=!0)}}return response},_decorateAllows:function(uri,playlist){playlist.ownedByCurrentUser=!1;var allows=playlist.allows;switch(playlist.ownerName&&playlist.ownerName==this._currentSession.user.username&&(allows["delete"]=!0,allows.editDescription=!0,allows.insertTracks=!0,allows.moveTracks=!0,allows.removeTracks=!0,allows.rename=!0,playlist.ownedByCurrentUser=!0),playlist.collaborative&&(allows.insertTracks=!0,allows.moveTracks=!0,allows.removeTracks=!0),uri.type){case"temp-playlist":allows["delete"]=!0,allows.editDescription=!0,allows.insertTracks=!0,allows.moveTracks=!0,allows.removeTracks=!0,allows.rename=!1;break;case"user-toplist":case"user-top-tracks":case"starred":allows["delete"]=!1,allows.editDescription=!1,allows.rename=!1}return playlist},_decoratePermissions:function(response,list){var body=response.body,metadata=(LinkHelper.from(body.uri),body.result),allows=metadata.allows,ruleset=new MutationRuleset({add:allows.insertTracks?MutationResult.ALLOWED:MutationResult.FORBIDDEN,insert:allows.insertTracks?MutationResult.ALLOWED:MutationResult.FORBIDDEN,move:allows.moveTracks?MutationResult.ALLOWED:MutationResult.FORBIDDEN,remove:allows.removeTracks?MutationResult.ALLOWED:MutationResult.FORBIDDEN});return list.getRootBaseList().setRuleset(ruleset),response},_processMosaicImages:function(response,uris){var img,cdnUrls=this._cdnUrls;if(img=uris.length<4?uris[0]:uris.slice(0,4).join("")){var mainImage=cdnUrls.normal+img;response.setBodyField("image",mainImage),response.setBodyField("images",[[120,cdnUrls.small+img],[300,mainImage],[120,cdnUrls.large+img]])}else response.setBodyField("image",null),response.setBodyField("images",[]);return response},_getListMosaicImages:function(list){var MOSAIC_INITIAL_NUM_ROWS=20,MOSAIC_MAX_NUM_ROWS=200,self=this,promise=this._createPromise();return list.snapshot(0,MOSAIC_INITIAL_NUM_ROWS).then(function(smallSnapshot){var imageUris=self._getSnapshotMosaicImages(smallSnapshot);4==imageUris.length?promise.fulfill(imageUris):smallSnapshot.getListLength()>MOSAIC_INITIAL_NUM_ROWS?list.snapshot(0,MOSAIC_MAX_NUM_ROWS).then(function(largeSnapshot){imageUris=self._getSnapshotMosaicImages(largeSnapshot),promise.fulfill(imageUris)}):promise.fulfill(imageUris)}),promise},_getSnapshotMosaicImages:function(snapshot){for(var rows=snapshot.toArray(),images={},uris=[],i=0,l=rows.length;l>i&&4!=uris.length;i++){var track=rows[i].track;if(track){var image=track.image;image&&!images[image]&&(images[image]=!0,uris.push(image.split("/").pop()))}}return uris},"CREATE /playlist":function(request,dispatcher){var self=this,currentSession=this._currentSession,response=this._createResponse(),promise=this._createPromise(),name=request.body.name||"New Playlist";return this._playlistService.createPlaylist({name:name,publish:!1,subscribe:!1},function(uri){self._getRootlist(dispatcher).then(function(rootlist){var rootlistMutator=rootlist.createMutator();if(rootlistMutator.canInsert(0,1)!=MutationResult.ALLOWED)throw Error();var item={uri:uri,addedBy:currentSession.user.username};return currentSession.publishPlaylists&&(item["public"]=!0),rootlistMutator.insert(0,[item]),rootlistMutator.apply()}).then(function(rootlistResult){if(rootlistResult!=MutationResult.SUCCESS)throw Error();self._playlistService.subscribeToPlaylists([uri]),response.setBodyField("uri",uri),promise.fulfill(response)}).catchError(function(){response.setStatus(ResponseStatus.BAD_GATEWAY),promise.fail(response)})},function(error){response.setStatus(error.code),promise.fail(response)}),promise},"CREATE /playlist/temporary":function(request,dispatcher){var response=this._createResponse(),promise=this._createPromise(),body=request.body,name=body.name,uri=LinkHelper.from(body.uri);if(!name||!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var requestSender=this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/tracks")),list=new ItemList.Array([]);list=new SubItemList.PlaylistTrackDecorator(list,requestSender);var descriptor=new Descriptor.List(uri);this._listManager.set(descriptor,list);var metadata=new Entities.Playlist(uri,{uri:uri.toString(),name:name,owner:"",collaborative:!1,description:"",published:!1,subscribed:!1});return response.setBodyFields({uri:uri,result:metadata,descriptor:descriptor,list:list}),this._metadataCache.put(uri,response),promise.fulfill(response),this._decorateAllows(uri,metadata),this._decoratePermissions(response,list),promise},"REMOVE /playlist/temporary":function(request,dispatcher){var response=this._createResponse(),promise=this._createPromise(),body=request.body,name=body.name,uri=LinkHelper.from(body.uri);if(!name||!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var descriptor=new Descriptor.List(uri);return this._listManager.set(descriptor,null),this._metadataCache.put(uri,null),response.setStatus(ResponseStatus.ACCEPTED),promise.fulfill(response),promise},"GET /playlist":function(request,dispatcher){var body=(request.headers,request.body),promise=this._createPromise(),response=this._createResponse(),uri=LinkHelper.from(body.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;"@"==uri.username&&(uri.username=this._currentSession.user.username);var metadataWaiter,metadataWaiters=this._metadataWaiters,decorator=null,cached=this._metadataCache.get(uri);return cached?(cached.status!=ResponseStatus.OK?promise.fail(cached):promise.fulfill(cached),promise):"playlist"==uri.type||"starred"==uri.type?(metadataWaiter=metadataWaiters[uri])?(metadataWaiter.pipe(promise),promise):(decorator=this._createPlaylistDecorator(dispatcher),decorator.decorated.pipe(promise),promise.then(function(result){return metadataWaiters[uri]=null,result}),this._queryPlaylistMetadataService(uri,dispatcher).pipe(decorator.promise),metadataWaiters[uri]=promise,promise):"rootlist"==uri.type||"published-rootlist"==uri.type?(metadataWaiter=metadataWaiters[uri])?(metadataWaiter.pipe(promise),promise):(promise.then(function(result){return metadataWaiters[uri]=null,result}),this._queryPlaylistMetadataService(uri,dispatcher).pipe(promise),metadataWaiters[uri]=promise,promise):"user-toplist"==uri.type||"user-top-tracks"==uri.type?(response.setBodyFields({uri:uri.toString(),result:new Entities.Playlist(uri,{name:"Top Tracks",owner:uri.username})}),promise.fulfill(response),promise):"trackset"==uri.type?(response.setBodyFields({uri:uri.toString(),result:new Entities.Playlist(uri,{name:uri.name||"Trackset"})}),promise.fulfill(response),promise):(response.setBodyField("uri",uri),response.setStatus(ResponseStatus.NOT_FOUND),promise.fail(response),promise)},"GET /playlist/mosaic":function(request,dispatcher){var self=this,body=request.body,uri=LinkHelper.from(body.uri),list=body.list,response=this._createResponse();return list?this._getListMosaicImages(list).then(this._processMosaicImages.bind(this,response)):dispatcher.get("/playlist/tracks",request.headers,{descriptor:new Descriptor.List(uri)}).then(function(serviceResponse){return self._getListMosaicImages(serviceResponse.body.list)},function(e){throw e}).then(this._processMosaicImages.bind(this,response))},"UPDATE /playlist":function(request,dispatcher){var self=this,response=this._createResponse(),uri=LinkHelper.from(request.body.uri),attributes=request.body.attributes;return uri&&attributes?dispatcher.get("/playlist",request.headers,{uri:uri}).then(function(serviceResponse){return Promise.join(serviceResponse.body.result,"temp-playlist"==uri.type?!0:self._performPlaylistServiceOperations(uri.toString(),[{kind:"UPDATE_LIST_ATTRIBUTES",update_list_attributes:{new_attributes:{values:attributes}}}]))}).thenSpread(function(playlist,result){for(var attribute in attributes){var oldAttr=playlist[attribute];playlist[attribute]=attributes[attribute],playlist.emit("change",{property:attribute,oldValue:oldAttr,newValue:attributes[attribute]})}return response.setStatus(ResponseStatus.ACCEPTED),response},function(e){if(e.code)return self._handleMetadataError(uri,e);throw e}):(response.setStatus(ResponseStatus.BAD_REQUEST),response)},"UPDATE /rootlist/row":function(request,dispatcher){var self=this,response=this._createResponse(),rowURI=LinkHelper.from(request.body.rowURI).toString(),attributes=request.body.attributes;return rowURI&&attributes?this._getRootlist(dispatcher).then(function(rootlist){var filtered=new ItemList.Filtered(rootlist,function(item){return item&&item.uri==rowURI});return Promise.join(rootlist,filtered,filtered.snapshot(0,-1))}).thenSpread(function(rootlist,filtered,snapshot){return 0==snapshot.getListLength()?(response.setStatus(ResponseStatus.NOT_FOUND),response):Promise.join(rootlist,filtered.translateIndex(0))}).thenSpread(function(rootlist,index){if(rootlist==response)return response;var uri=rootlist.getDescriptor().uri.toString(),op={kind:"UPDATE_ITEM_ATTRIBUTES",update_item_attributes:{index:index,new_attributes:{values:attributes}}};return Promise.join(rootlist,op,self._performPlaylistServiceOperations(uri,[op]))}).thenSpread(function(rootlist,op,revision){return rootlist==response?response:self._updateRootItemAttribute(rootlist,op).then(function(){return rootlist.getRootBaseList().setRevision(revision),!0})}).then(function(res){return res!=response&&response.setStatus(ResponseStatus.OK),response}).catchError(function(e){console.error(e.stack)}):(response.setStatus(ResponseStatus.BAD_REQUEST),response)},"GET /playlist/popularity":function(request,dispatcher){var response=this._createResponse(),body=request.body,uri=LinkHelper.from(body.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username);var subscriberListCache=this._subscriberListCache,list=subscriberListCache.get(uri);return list?this._calculatePlaylistPopularity(list).then(function(popularity){return response.setBodyField("result",popularity),response}):dispatcher.get("/playlist/subscribers",null,{uri:uri}).access("body","list").then(this._calculatePlaylistPopularity.bind(this)).then(function(popularity){return response.setBodyField("result",popularity),response})},"GET /playlist/subscribers":function(request,dispatcher){var self=this,response=this._createResponse(),body=request.body,uri=LinkHelper.from(body.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username);var subscriberListCache=this._subscriberListCache,cached=subscriberListCache.get(uri);return cached?(response.setBodyField("list",cached),response):dispatcher.get("/playlist",null,{uri:uri}).then(function(playlistResponse){var list=subscriberListCache.get(uri);return list||(list=self._createSubscriberList(uri)),response.setBodyField("list",list),response})},"GET /playlist/tracks":function(request,dispatcher){var self=this,listManager=this._listManager,response=this._createResponse(),headers=request.headers,descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),response;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username,baseDescriptor.uri=uri);var list=listManager.get(descriptor);return list?(response.setBodyField("list",list),response):"trackset"==uri.type?(list=this._createTracksetList(uri,dispatcher),listManager.set(descriptor,list),"list"!=descriptor.type&&(list=listManager.get(descriptor)||list),response.setBodyField("list",list),response):dispatcher.get("/playlist",headers,{uri:uri}).then(function(response){var list=listManager.get(descriptor);return list?(response.setBodyField("list",list),response):(list="rootlist"==uri.type||"published-rootlist"==uri.type?self._createRootlist(uri):self._createPlaylist(uri,response,dispatcher),response.setBodyField("list",list),response)})},"GET /playlist/uri":function(request,dispatcher){var response=this._createResponse(),uri=LinkHelper.from(request.body.uri);return uri?("@"==uri.username&&(uri.username=this._currentSession.user.username),response.setBodyFields({uri:request.body.uri,result:uri.toString()}),response):(response.setStatus(ResponseStatus.BAD_REQUEST),response)},"GET /playlists":function(request,dispatcher){for(var headers=request.headers,body=request.body,promise=this._createPromise(),playlists=body.uris,len=playlists.length,result={},response=this._createResponse(),aggregator=function(playlistResponse){var body=playlistResponse.body;result[body.uri]=playlistResponse.status==ResponseStatus.OK?body.result:null,--len||promise.fulfill(response.setBodyFields({uris:playlists,result:result}))},i=0,l=playlists.length;l>i;i++)dispatcher.get("/playlist",{},{uri:playlists[i]}).then(aggregator,aggregator);return headers.flush&&this._broadcastFlush(),promise},"GET /rootlist":function(request,dispatcher){var response=this._createResponse(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),response;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;if("@"!=uri.username&&uri.username!=this._currentSession.user.username)return response.setStatus(ResponseStatus.FORBIDDEN),response;"@"==uri.username&&(uri.username=this._currentSession.user.username),baseDescriptor.uri=Link.rootlistLink(uri.username);var headers=request.headers||{};return headers.rootlist=!0,dispatcher.get("/playlist/tracks",headers,{descriptor:descriptor}).then(function(response){return null==response.body.list?dispatcher.get("/rootlist",request.headers,request.body):response})},"GET /publishedrootlist":function(request,dispatcher){var response=this._createResponse(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),response;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username),baseDescriptor.uri=Link.publishedRootlistLink(uri.username);var headers=request.headers||{};return headers.rootlist=!0,dispatcher.get("/playlist/tracks",headers,{descriptor:descriptor}).then(function(response){return null==response.body.list?dispatcher.get("/publishedrootlist",request.headers,request.body):response})},"GET /starredlist":function(request,dispatcher){var response=this._createResponse(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),response;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username),baseDescriptor.uri=Link.starredLink(uri.username);var headers=request.headers||{};return headers.rootlist=!0,dispatcher.get("/playlist/tracks",headers,{descriptor:descriptor})}});module.exports=PlaylistReactor}()},{"../dispatcher":62,"../entities":63,"../extension":73,"../lists":76,"../observers/rootlist":92,"../reactor":94,"../sublists":109,"spotify-promise":133}],101:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,LinkHelper=require("../extension").LinkHelper,Promise=require("spotify-promise"),SimpleCache=Spotify.SimpleCache,Entities=require("../entities"),RequestQueue=require("../requestqueue"),ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,Base62=require("spotify-crypto").Base62,ProfileReactor=new Reactor({_construct:function(){this._associatedUserCache=new SimpleCache(200),this._associatedArtistCache=new SimpleCache(200),this._cdnUrls=null,this._currentSession=null,this._profileCache=new SimpleCache(200),this._profileQueue=new RequestQueue,this._waitForCalls("_onServicesReady","_onImageResources","_onSessionChange"),this._subscribeAll({"resources.core":this._onCore,"resources.image":this._onImageResources,"resources.flush":this._onFlush,"session.change":this._onSessionChange})},_onCore:function(core){this._waitForServices({_socialService:core.social,_socialGraphService:core.socialGraph,_mergedProfileService:core.mergedProfile})},_onImageResources:function(cdnUrls){this._cdnUrls=cdnUrls},_onFlush:function(){this._queryProfileService()},_onServicesReady:function(){},_onSessionChange:function(session){this._currentSession=session},_onWaitedCallsDone:function(){this._setReady()},_queryProfileService:function(){var users=this._profileQueue.takeIds();users.length&&this._socialService.getUsers(users,"complete",this._processProfiles.bind(this,users),this._handleProfileError.bind(this,users))},_processProfiles:function(users,serviceResponse){var cache=this._profileCache;Array.isArray(users)||(users=[users]);for(var i=0,l=users.length;l>i;i++){var promise=this._processProfile(users[i],serviceResponse[i]);promise.then(cache.put.bind(cache,users[i]))}},_processProfile:function(user,metadata){var response=this._createResponse(),promises=this._profileQueue.takeValues(user),promise=Promise.group(promises),resourceUrl=this._cdnUrls.avatar,uri=Link.profileLink(user);return response.setBodyField("uri",uri),metadata?(metadata.resourceUrl||(metadata.resourceUrl=resourceUrl),Entities.Profile.create(uri,metadata).then(function(profile){response.setBodyField("result",profile),promise.fulfill(response)},function(parsingError){promise.fail(response.setStatus(ResponseStatus.BAD_GATEWAY))})):promise.fail(response.setStatus(ResponseStatus.NOT_FOUND)),promise},_handleProfileError:function(users){var response=this._createResponse();if(response.setStatus(ResponseStatus.BAD_GATEWAY),users.length)for(var queue=this._profileQueue,cache=this._profileCache,i=0,l=users.length;l>i;i++){var user=users[i],promises=queue.takeValues(user),promise=Promise.group(promises);promise.fail(response),cache.put(Link.profileLink(user),response)}},_createProfileDecorator:function(){var self=this,socialGraphService=this._socialGraphService,promise=this._createPromise();return promise.then(function(response){var profile=response.body.result,subscribed=socialGraphService.isSubscribed([profile.username]);return profile.subscribed=!!subscribed[0],profile.currentUser=profile.username==self._currentSession.user.username,response}),promise},"GET /profile":function(request,dispatcher){var currentSession=this._currentSession,headers=request.headers,body=request.body,promise=this._createPromise(),response=this._createResponse(),uri=LinkHelper.from(body.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"!=uri.username&&"%40"!=uri.username||(uri.username=currentSession.user.username);var cached=this._profileCache.get(uri.username);if(cached){if(cached.status==ResponseStatus.OK){var socialGraphService=this._socialGraphService,profile=cached.body.result,subscribed=socialGraphService.isSubscribed([profile.username]);
return profile.subscribed=!!subscribed[0],profile.currentUser=profile.username==currentSession.user.username,promise.fulfill(cached),promise}promise.fail(cached)}else{var decoratorPromise=this._createProfileDecorator();decoratorPromise.pipe(promise),this._profileQueue.push(uri.username,decoratorPromise),headers.flush&&this._broadcastFlush()}return promise},"GET /profile/associatedartist":function(request,dispatcher){var response=this._createResponse(),promise=this._createPromise(),uri=LinkHelper.from(request.body.uri);if(!uri||!uri.username)return response.setStatus(ResponseStatus.BAD_REQUEST),response;"@"==uri.username&&(uri.username=this._currentSession.user.username);var cache=this._associatedArtistCache,cached=cache.get(uri);return cached?cached:(this._mergedProfileService.forUser(uri.username,function(serviceResponse){response.setBodyFields({uri:uri,result:serviceResponse[0]&&serviceResponse[0].artist}),promise.fulfill(response),cache.put(uri,response)},function(){response.setStatus(ResponseStatus.BAD_GATEWAY)}),promise)},"GET /profile/associateduser":function(request,dispatcher){var response=this._createResponse(),promise=this._createPromise(),uri=LinkHelper.from(request.body.uri);if(!uri||!uri.id)return response.setStatus(ResponseStatus.BAD_REQUEST),response;var cache=this._associatedUserCache,cached=cache.get(uri);return cached?cached:(this._mergedProfileService.forArtist(Base62.fromHex(uri.id),function(serviceResponse){response.setBodyFields({uri:uri,result:serviceResponse[0]&&serviceResponse[0].user}),promise.fulfill(response),cache.put(uri,response)},function(){response.setStatus(ResponseStatus.BAD_GATEWAY)}),promise)}});module.exports=ProfileReactor}()},{"../dispatcher":62,"../entities":63,"../extension":73,"../reactor":94,"../requestqueue":107,"spotify-crypto":33,"spotify-promise":133}],102:[function(require,module,exports){!function(){"use strict";var Reactor=require("../reactor").Reactor,ResourcesReactor=new Reactor({_construct:function(){this._core=null,this._CDNUrls=null,this._listManager=null,this._playerGroup=null,this._storage=null,this._trackListResolver=null,this._adChooser=null,this._coreRequestPromise=this._createPromise(),this._sourceRequestPromise=this._createPromise(),this._listManagerRequestPromise=this._createPromise(),this._playerGroupPromise=this._createPromise(),this._storageRequestPromise=this._createPromise(),this._trackListResolverPromise=this._createPromise(),this._adChooserRequestPromise=this._createPromise(),this._setReady()},"FLUSH /resources":function(request,dispatcher){var promise=this._createPromise();return promise.fulfill(!0),this._broadcastFlush(),promise},"CREATE /resources/core":function(request,dispatcher){var promise=this._createPromise();return this._core||(this._core=request.body.core,this._broadcast("resources.core",this._core),this._coreRequestPromise.fulfill(this._core),promise.fulfill(!0)),promise},"GET /resources/core":function(request,dispatcher){var promise=this._createPromise();return this._core?promise.fulfill(this._core):this._coreRequestPromise.pipe(promise),promise},"CREATE /resources/image":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.sources?(this._CDNUrls=body.sources,this._broadcast("resources.image",this._CDNUrls),this._sourceRequestPromise.fulfill(this._CDNUrls),promise.fulfill(!0)):promise.fulfill(!1),promise},"GET /resources/image":function(request,dispatcher){var promise=this._createPromise();return this._CDNUrls?promise.fulfill(this._CDNUrls):this._sourceRequestPromise.pipe(promise),promise},"CREATE /resources/listmanager":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.listManager?(this._listManager=body.listManager,this._broadcast("resources.listmanager",this._listManager),this._listManagerRequestPromise.fulfill(this._listManager),promise.fulfill(!0)):promise.fulfill(!1),promise},"GET /resources/listmanager":function(request,dispatcher){var promise=this._createPromise();return this._listManager?promise.fulfill(this._listManager):this._listManagerRequestPromise.pipe(promise),promise},"CREATE /resources/playergroup":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.playerGroup?(this._playerGroup=body.playerGroup,this._broadcast("resources.playergroup",this._playerGroup),this._playerGroupPromise.fulfill(this._playerGroup),promise.fulfill(!0)):promise.fulfill(!1),promise},"GET /resources/playergroup":function(request,dispatcher){var promise=this._createPromise();return this._playerGroup?promise.fulfill(this._playerGroup):this._playerGroupPromise.pipe(promise),promise},"CREATE /resources/storage":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.storage?(this._storage=body.storage,this._broadcast("resources.storage",this._storage),this._storageRequestPromise.fulfill(this._storage),promise.fulfill(!0)):promise.fulfill(!1),promise},"GET /resources/storage":function(request,dispatcher){var promise=this._createPromise();return this._storage?promise.fulfill(this._storage):this._storageRequestPromise.pipe(promise),promise},"CREATE /resources/tracklistresolver":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.trackListResolver?(this._trackListResolver=body.trackListResolver,this._broadcast("resources.tracklistresolver",this._trackListResolver),this._trackListResolverPromise.fulfill(this._trackListResolver),promise.fulfill(!0)):promise.fulfill(!1),promise},"CREATE /resources/adchooser":function(request,dispatcher){var body=request.body,promise=this._createPromise();return body.adChooser?(this._adChooser=body.adChooser,this._broadcast("resources.adchooser",this._adChooser),this._adChooserRequestPromise.fulfill(this._adChooser),promise.fulfill(!0)):promise.fulfill(!1),promise},"GET /resources/tracklistresolver":function(request,dispatcher){var promise=this._createPromise();return this._trackListResolver?promise.fulfill(this._trackListResolver):this._trackListResolverPromise.pipe(promise),promise},"GET /resources/adchooser":function(request,dispatcher){var promise=this._createPromise();return this._adChooser?promise.fulfill(this._adChooser):this._adChooserRequestPromise.pipe(promise),promise}});module.exports=ResourcesReactor}()},{"../reactor":94}],103:[function(require,module,exports){!function(){"use strict";var LinkHelper=require("../extension").LinkHelper,ItemList=require("../lists"),Descriptor=ItemList.Descriptor,SubItemList=require("../sublists"),SearchTypes=SubItemList.SearchTypes,ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,SearchReactor=new Reactor({_construct:function(){this._fuzzyMatches={},this._searchTTL=36e5,this._cdnUrls=null,this._listManager=null,this._searchService=null,this._waitForCalls("_onImageResources","_onListManager","_onServicesReady"),this._subscribeAll({"resources.core":this._onCore,"resources.flush":this._onFlush,"resources.image":this._onImageResources,"resources.listmanager":this._onListManager,"resources.tracklistresolver":this._onTrackListResolver})},_onCore:function(core){this._waitForServices({_searchService:core.search})},_onFlush:function(){},_onImageResources:function(cdnUrls){this._cdnUrls=cdnUrls},_onWaitedCallsDone:function(){this._setReady()},_onListManager:function(listManager){this._listManager=listManager},_onServicesReady:function(){},_onTrackListResolver:function(trackListResolver){var resolver=function(uri,descriptor,dispatcher,listManager){return dispatcher.get("/search/tracks",null,{descriptor:descriptor}).access("body","list")};trackListResolver.register("search",resolver)},_createSearchItemsLoader:function(query,type){var self=this,fuzzyMatches=this._fuzzyMatches,service=this._searchService,serviceType=null,cdnUrls=this._cdnUrls;switch(type){case SearchTypes.ALBUMS:serviceType=service.ALBUMS;break;case SearchTypes.ARTISTS:serviceType=service.ARTISTS;break;case SearchTypes.PLAYLISTS:serviceType=service.PLAYLISTS;break;case SearchTypes.TRACKS:default:serviceType=service.TRACKS}return function(range){var promise=self._createPromise();return service.search(query,{type:serviceType,offset:range.begin,length:range.length},function(response){response.didYouMean&&(fuzzyMatches[query]=response.didYouMean);for(var array=response[type].slice(0),i=0,l=array.length;l>i;i++)array[i]&&(array[i].resourceUrl=cdnUrls.unbranded,array[i].resourceUrls=cdnUrls);promise.fulfill({length:response.total[type],items:array})},function(error){promise.fail(error)}),promise}},_getSearchSublist:function(type,request,dispatcher){var listManager=this._listManager,promise=this._createPromise(),response=this._createResponse(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var typeURI=uri.toString()+":"+type;baseDescriptor.uri=typeURI;var list=listManager.get(descriptor);if(list&&!list.getRootBaseList().isOlderThan(this._searchTTL))return response.setBodyField("list",list),promise.fulfill(response),promise;var loader=this._createSearchItemsLoader(uri.query,type);return list=new SubItemList.MetadataDecorator(new ItemList.Property(SubItemList.Search.create(type,uri,loader),"uri"),this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/"+type))),listManager.set(descriptor,list)?(response.setBodyField("list",listManager.get(descriptor)),promise.fulfill(response)):(response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response)),promise},"GET /search/tracks":function(request,dispatcher){return this._getSearchSublist("tracks",request,dispatcher)},"GET /search/artists":function(request,dispatcher){return this._getSearchSublist("artists",request,dispatcher)},"GET /search/albums":function(request,dispatcher){return this._getSearchSublist("albums",request,dispatcher)},"GET /search/playlists":function(request,dispatcher){return this._getSearchSublist("playlists",request,dispatcher)},"GET /search/fuzzymatch":function(request,dispatcher){var promise=this._createPromise(),service=this._searchService,fuzzyMatches=this._fuzzyMatches,query=request.body.query,response=this._createResponse();return query in fuzzyMatches?(response.setBodyField("match",fuzzyMatches[query]),promise.fulfill(response)):service.search(query,{type:service.TRACKS,offset:0,total:20},function(serviceResponse){var match=serviceResponse.didYouMean||null;fuzzyMatches[query]=match,response.setBodyField("match",match),promise.fulfill(response)},function(serviceResponse){fuzzyMatches[query]=null,response.setBodyField("match",null),promise.fulfill(response)}),promise}});module.exports=SearchReactor}()},{"../dispatcher":62,"../extension":73,"../lists":76,"../reactor":94,"../sublists":109}],104:[function(require,module,exports){!function(){"use strict";var Entities=require("../entities"),ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,SessionReactor=new Reactor({_construct:function(){this._currentSession=null,this._sessionFailed=!1,this._subscribeAll({"resources.core":this._onCore})},_onCore:function(core){this._featuresService=core.features,this._waitForServices({_sessionService:core.user})},_onServicesReady:function(){this._sessionService.bind("USER_INFO_CHANGE",this._getSession.bind(this)),this._getSession()},_getSession:function(){var self=this;this._querySessionService().then(function(session){self._processSession(session)},function(error){self._sessionFailed=!0,self._setReady()})},_querySessionService:function(){var promise=this._createPromise();return this._sessionService.getUserInfo(promise.fulfill.bind(promise),promise.fail.bind(promise)),promise},_processSession:function(session){var self=this;Entities.Session.create(session).then(function(session){self._currentSession=session,self._sessionFailed=!1,self._broadcast("session.change",session),self._setReady()},function(){self._sessionFailed=!0,self._setReady()})},"GET /features":function(request,dispatcher){var response=this._createResponse(),features=this._featuresService.getAll();return response.setBodyField("result",features),response},"GET /session":function(request,dispatcher){var promise=this._createPromise(),response=this._createResponse();return this._sessionFailed?(response.setStatus(ResponseStatus.SERVICE_UNAVAILABLE),promise.fail(response)):(response.setBodyField("result",this._currentSession),promise.fulfill(response)),promise},"UPDATE /user/attribute":function(request,dispatcher){var promise=this._createPromise(),response=this._createResponse(),body=request.body,key=body.key,value=body.value;return key&&value?(this._sessionService.setUserAttribute(key,value,function(success,code){response.setBodyFields({success:success,code:code}),promise.fulfill(response)},function(){response.setStatus(ResponseStatus.BAD_GATEWAY),promise.fail(response)}),promise):(response.setStatus(ResponseStatus.BAD_REQUEST),response)}});module.exports=SessionReactor}()},{"../dispatcher":62,"../entities":63,"../reactor":94}],105:[function(require,module,exports){!function(){"use strict";var Link=Spotify.Link,LinkHelper=require("../extension").LinkHelper,ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,SuggestReactor=new Reactor({_construct:function(){this._suggestService=null,this._cdnUrls=null,this._waitForCalls("_onImageResources","_onServicesReady"),this._subscribeAll({"resources.core":this._onCore,"resources.image":this._onImageResources})},_onCore:function(core){this._waitForServices({_suggestService:core.suggest})},_onImageResources:function(cdnUrls){this._cdnUrls=cdnUrls},_onServicesReady:function(){},_onWaitedCallsDone:function(){this._setReady()},_querySuggestions:function(query){var promise=this._createPromise();return this._suggestService.suggest(query,function(result){promise.fulfill(result)},function(response){promise.fail(response)}),promise},_getSuggestByType:function(type,request,dispatcher){var response=this._createResponse(),uri=LinkHelper.from(request.body.uri);return uri&&this._responseParsers[type]?this._querySuggestions(uri.query).then(this._responseParsers[type].bind(this)).then(function(serviceResponse){return response.setBodyField("list",serviceResponse)}).catchError(function(){return response.setStatus(ResponseStatus.BAD_REQUEST)}):response.setStatus(ResponseStatus.BAD_REQUEST)},_createImageLink:function(id){return this._cdnUrls.small+id},_responseParsers:{albums:function(result){var albums=result.albums,metadata=[];if(albums)for(var i=0,l=albums.length;l>i;i++){for(var album=albums[i],artists=[],j=0,lj=album.artists.length;lj>j;j++){var artist=album.artists[j];artists.push({uri:Link.artistLink(artist.id).toString(),name:artist.name})}metadata.push({uri:Link.albumLink(album.id).toString(),name:album.name,image:this._createImageLink(album.image),artists:artists,popularity:album.popularity})}return metadata},artists:function(result){var artists=result.artists,metadata=[];if(artists)for(var i=0,l=artists.length;l>i;i++){var artist=artists[i];metadata.push({uri:Link.artistLink(artist.id).toString(),name:artist.name,image:this._createImageLink(artist.image),popularity:artist.popularity})}return metadata},tracks:function(result){var tracks=result.tracks,metadata=[];if(tracks)for(var i=0,l=tracks.length;l>i;i++){for(var track=tracks[i],artists=[],j=0,lj=track.artists.length;lj>j;j++)artists.push({uri:Link.artistLink(track.artists[j].id).toString(),name:track.artists[j].name});metadata.push({uri:Link.trackLink(track.id).toString(),name:track.name,image:this._createImageLink(track.image),artists:artists,popularity:track.popularity})}return metadata},playlists:function(result){var playlists=result.playlist,metadata=[];if(playlists)for(var i=0,l=playlists.length;l>i;i++){var playlist=playlists[i];metadata.push({uri:playlist.uri,image:this._createImageLink(playlist.image),name:playlist.name,popularity:playlist.popularity})}return metadata}},"GET /suggest/albums":function(request,dispatcher){return this._getSuggestByType("albums",request,dispatcher)},"GET /suggest/artists":function(request,dispatcher){return this._getSuggestByType("artists",request,dispatcher)},"GET /suggest/tracks":function(request,dispatcher){return this._getSuggestByType("tracks",request,dispatcher)},"GET /suggest/playlists":function(request,dispatcher){return this._getSuggestByType("playlists",request,dispatcher)}});module.exports=SuggestReactor}()},{"../dispatcher":62,"../extension":73,"../reactor":94}],106:[function(require,module,exports){!function(){"use strict";var LinkHelper=require("../extension").LinkHelper,ItemList=require("../lists"),SubItemList=require("../sublists"),Descriptor=ItemList.Descriptor,ResponseStatus=require("../dispatcher").ResponseStatus,Reactor=require("../reactor").Reactor,ToplistReactor=new Reactor({_construct:function(){this._currentSession=null,this._listManager=null,this._toplistService=null,this._waitForCalls("_onServicesReady","_onListManager","_onSessionChange"),this._subscribeAll({"resources.core":this._onCore,"resources.listmanager":this._onListManager,"resources.tracklistresolver":this._onTrackListResolver,"session.change":this._onSessionChange})},_onCore:function(core){this._waitForServices({_toplistService:core.toplist})},_onServicesReady:function(){},_onListManager:function(listManager){this._listManager=listManager},_onSessionChange:function(session){this._currentSession=session},_onTrackListResolver:function(trackListResolver){var resolver=function(uri,descriptor,dispatcher,listManager){return dispatcher.get("/toplist/user",null,{descriptor:descriptor}).access("body","list")};trackListResolver.register("user-toplist",resolver),trackListResolver.register("user-top-tracks",resolver)},_onWaitedCallsDone:function(){this._setReady()},_handleServiceError:function(error){var promise=this._createPromise(),response=this._createResponse();return response.setStatus(error.code),promise.fail(response),promise},_queryToplistForUser:function(user,type){var self=this,promise=this._createPromise();return this._toplistService.lookupForUser(user,type,function(result,type,types){promise.fulfill({type:type,array:result})},function(error){self._handleServiceError(error).pipe(promise)}),promise},_queryToplistForRegion:function(region,type){var self=this,promise=this._createPromise();return this._toplistService.lookupForRegion(region,type,function(result,type,types){promise.fulfill({type:type,array:result})},function(error){self._handleServiceError(error).pipe(promise)}),promise},_getToplistType:function(uri){var service=this._toplistService;switch(uri.toplist){case"albums":return service.ALBUM;case"artists":return service.ARTIST;case"playlists":return service.PLAYLIST;case"tracks":default:return service.TRACK}},_createToplist:function(uri,dispatcher,serviceResponse){var type=serviceResponse.type,list=SubItemList.Toplist.create(type,uri,serviceResponse.array),requestSender=this._wrapDecoratorRequest(dispatcher.createRequestSender("GET","/"+type+"s"));return list=new SubItemList.MetadataDecorator(list,requestSender)},"GET /toplist/user":function(request,dispatcher){var self=this,listManager=this._listManager,response=this._createResponse(),promise=this._createPromise(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;"@"==uri.username&&(uri.username=this._currentSession.user.name,baseDescriptor.uri=uri);var type=this._getToplistType(uri),list=listManager.get(descriptor);return list?(response.setBodyField("list",list),promise.fulfill(response),promise):this._queryToplistForUser(uri.username,type).then(function(serviceResponse){var list=self._createToplist(uri,dispatcher,serviceResponse);if(listManager.set(descriptor,list))return response.setBodyField("list",listManager.get(descriptor)),response;throw response.setStatus(ResponseStatus.BAD_REQUEST),response},function(){throw response.setStatus(ResponseStatus.BAD_REQUEST),response})},"GET /toplist/region":function(request,dispatcher){var self=this,listManager=this._listManager,response=this._createResponse(),promise=this._createPromise(),descriptor=Descriptor.fromObject(request.body.descriptor),baseDescriptor=Descriptor.extractList(descriptor);if(!descriptor||!baseDescriptor)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var uri=LinkHelper.from(baseDescriptor.uri);if(!uri)return response.setStatus(ResponseStatus.BAD_REQUEST),promise.fail(response),promise;var type=this._getToplistType(uri),list=listManager.get(descriptor);return list?(response.setBodyField("list",list),promise.fulfill(response),promise):this._queryToplistForRegion(uri.country||null,type).then(function(serviceResponse){var list=self._createToplist(uri,dispatcher,serviceResponse);if(listManager.set(descriptor,list))return response.setBodyField("list",listManager.get(descriptor)),response;throw response.setStatus(ResponseStatus.BAD_REQUEST),response},function(){throw response.setStatus(ResponseStatus.BAD_REQUEST),response})}});module.exports=ToplistReactor}()},{"../dispatcher":62,"../extension":73,"../lists":76,"../reactor":94,"../sublists":109}],107:[function(require,module,exports){!function(){"use strict";function RequestQueue(){this._ids=[],this._values={}}RequestQueue.prototype.push=function(id,value){var ids=this._ids,values=this._values;return id=id.toString(),values[id]||ids.push(id),(values[id]||(values[id]=[])).push(value),this},RequestQueue.prototype.takeIds=function(length){var ids=this._ids;return length=void 0!=length?length:ids.length,ids.splice(0,length)},RequestQueue.prototype.takeValues=function(id,length){var values=this._values[id];if(!values)return[];length=void 0!=length?length:values.length;var result=values.splice(0,length);return values.length||(this._values[id]=null),result},module.exports=RequestQueue}()},{}],108:[function(require,module,exports){!function(){function Spirc(spircService,contextPlayer,itemLoaderFn){EventEmitter.call(this),this._loadPosition=void 0,this._contextPlayer=contextPlayer,this._spircService=spircService,this._itemLoaderFn=itemLoaderFn,this._init()}var inherit=require("spotify-inheritance/inherit"),Link=Spotify.Link,Base62=require("spotify-crypto").Base62,ItemList=(require("./extension").LinkHelper,require("./lists")),SubItemList=require("./sublists"),Promise=require("spotify-promise"),EventEmitter=require("spotify-eventemitter"),Events=Spotify.Events(),MessageTypes={HELLO:"kMessageTypeHello",GOODBYE:"kMessageTypeGoodbye",NOTIFY:"kMessageTypeNotify",PROBE:"kMessageTypeProbe",LOAD:"kMessageTypeLoad",PLAY:"kMessageTypePlay",PAUSE:"kMessageTypePause",PLAY_PAUSE:"kMessageTypePlayPause",SEEK:"kMessageTypeSeek",PREV:"kMessageTypePrev",NEXT:"kMessageTypeNext",VOLUME:"kMessageTypeVolume",SHUFFLE:"kMessageTypeShuffle",REPEAT:"kMessageTypeRepeat",VOLUME_DOWN:"kMessageTypeVolumeDown",VOLUME_UP:"kMessageTypeVolumeUp",REPLACE:"kMessageTypeReplace"},PlayStatus={STOP:"kPlayStatusStop",PLAY:"kPlayStatusPlay",PAUSE:"kPlayStatusPause",LOADING:"kPlayStatusLoading"};inherit(Spirc,EventEmitter),Spirc.MessageTypes=MessageTypes,Spirc.PlayStatus=PlayStatus,Spirc.prototype.setName=function(name){var service=this._spircService;return service.setName?(service.setName(name),!0):!1},Spirc.prototype.broadcastWakeUp=function(){this._spircService.broadcastWakeUp()},Spirc.prototype._init=function(){var service=this._spircService;service.bind(Events.NOTIFICATION,this._handleMessage.bind(this)),service.subscribe();var contextPlayer=this._contextPlayer;this._stateChangeListener=stateChangeListener=this._handleStateChange.bind(this);var hasBroadcastWakeUp=!!service.broadcastWakeUp;service.bind(Events.TOKEN_LOST,function(){hasBroadcastWakeUp&&service.broadcastWakeUp(),contextPlayer.removeListener("pause",stateChangeListener)}),contextPlayer.addListeners({play:stateChangeListener,positionChanged:stateChangeListener,volumeChange:stateChangeListener})},Spirc.prototype._handleMessage=function(eventObject){var contextPlayer=this._contextPlayer,spircMessage=eventObject.params.message;switch(spircMessage.type){case MessageTypes.PLAY:contextPlayer.resume();break;case MessageTypes.PAUSE:contextPlayer.pause();break;case MessageTypes.PLAY_PAUSE:contextPlayer.togglePlay();break;case MessageTypes.PREV:contextPlayer.previous(spircMessage.type);break;case MessageTypes.NEXT:contextPlayer.next(spircMessage.type);break;case MessageTypes.VOLUME_DOWN:case MessageTypes.VOLUME_UP:break;case MessageTypes.LOAD:this._handleLoad(spircMessage.state);break;case MessageTypes.REPLACE:this._handleReplace(spircMessage.state);break;case MessageTypes.SEEK:contextPlayer.seek(spircMessage.position);break;case MessageTypes.VOLUME:contextPlayer.setVolume(spircMessage.volume/65535)}this.emit("rawmessage",{message:spircMessage})},Spirc.prototype._handleLoad=function(stateObject){this._spircService.setFrameState({status:PlayStatus.LOADING}),this._spircService.notify();for(var contextURI=stateObject.context_uri,seekPosition=this._loadPosition=stateObject.position_ms,trackPosition=stateObject.playing_track_index,playStatus=stateObject.status,gids=stateObject.track,tracks=[],i=0;i<gids.length;i++)tracks.push(Link.fromByteString("track",gids[i].gid).toURI());var list=new SubItemList.Context(new SubItemList.MetadataDecorator(new ItemList.Array(tracks),this._itemLoaderFn),contextURI);list.setDescriptor(new ItemList.Descriptor.List(contextURI));var playbackOptions={index:trackPosition,initialOffset:seekPosition,offset:0,duration:-1,pause:playStatus==PlayStatus.PAUSE,reason:"spirc",rules:this._contextPlayer.getRuleFor("default")};this._contextPlayer.play(list,playbackOptions)},Spirc.prototype._handleReplace=function(stateObject){for(var contextURI=this._contextPlayer.getContextList().getOwner(),trackPosition=stateObject.playing_track_index,gids=stateObject.track,tracks=[],i=0;i<gids.length;i++)tracks.push(Link.fromByteString("track",gids[i].gid).toURI());var list=new SubItemList.MetadataDecorator(new ItemList.Array(tracks),this._itemLoaderFn);list.setDescriptor(new ItemList.Descriptor.List(contextURI));var playbackOptions={index:trackPosition+1,offset:0,duration:-1,pause:!1,reason:"spirc",rules:this._contextPlayer.getRuleFor("default")};list=new SubItemList.Context(list,contextURI),this._contextPlayer.setContextList(list,playbackOptions)},Spirc.prototype._notifyStateChange=function(context){var service=this._spircService,self=this;Promise.join(this._contextPlayer.getPlaybackState(),this._contextPlayer.getTrackState(),context.getBaseList().toArray()).thenSpread(function(playbackState,trackState,currentContextList){var updatedState={};updatedState.context_uri=context.getOwner();for(var gidTracks=[],i=0,l=currentContextList.length;l>i;i++){var hexId=currentContextList[i].uri.split(":")[2];gidTracks.push({gid:Link.trackLink(Base62.toHex(hexId)).idToByteString()})}updatedState.track=gidTracks,updatedState.playing_from_fallback=!0,updatedState.playing_track_index=context.getIndex(),updatedState.position_measured_at=(new Date).getTime(),updatedState.position_ms="undefined"==typeof self._loadPosition?trackState.position:self._loadPosition,self._loadPosition=void 0,updatedState.status=playbackState.playing?PlayStatus.PLAY:PlayStatus.PAUSE,service.setFrameState(updatedState),service.notify()})},Spirc.prototype._notifyVolumeChange=function(volume){var service=this._spircService;service.setDeviceVolume(Math.round(65535*volume)),service.notify()},Spirc.prototype._handleStateChange=function(eventObject){var eventType=eventObject.type;switch(eventType){case"play":this._contextPlayer.addListener("pause",this._stateChangeListener);case"pause":case"positionChanged":this._notifyStateChange(eventObject.context);break;case"volumeChange":this._notifyVolumeChange(eventObject.volume)}},module.exports=Spirc}()},{"./extension":73,"./lists":76,"./sublists":109,"spotify-crypto":33,"spotify-eventemitter":128,"spotify-inheritance/inherit":131,"spotify-promise":133}],109:[function(require,module,exports){!function(){"use strict";var extend=require("spotify-inheritance/extend"),SubItemList=extend({},require("./sublists/album"),require("./sublists/playlist"),require("./sublists/search"),require("./sublists/toplist"),{Context:require("./sublists/context"),Decorator:require("./sublists/decorator"),MetadataDecorator:require("./sublists/metadatadecorator"),PlaylistTrackDecorator:require("./sublists/playlistdecorator"),Mappable:require("./sublists/mappable")});module.exports=SubItemList}()},{"./sublists/album":110,"./sublists/context":111,"./sublists/decorator":112,"./sublists/mappable":113,"./sublists/metadatadecorator":114,"./sublists/playlist":115,"./sublists/playlistdecorator":116,"./sublists/search":117,"./sublists/toplist":118,"spotify-inheritance/extend":129}],110:[function(require,module,exports){!function(){"use strict";function DiscTrackItemList(uri,array){return this instanceof DiscTrackItemList?(ArrayItemList.call(this,array),this._uri=uri.toString(),void(this._loadLimit=500)):new DiscTrackItemList(uri,array)}function AlbumTrackItemList(uri,discs){return this instanceof AlbumTrackItemList?(ConcatenatedItemList.call(this,discs),void(this._uri=uri.toString())):new AlbumTrackItemList(uri,discs)}var inherit=require("spotify-inheritance/inherit"),Entities=require("../entities"),ItemList=require("../lists"),ArrayItemList=ItemList.Array,ConcatenatedItemList=ItemList.Concatenated;inherit(DiscTrackItemList,ArrayItemList),inherit(AlbumTrackItemList,ConcatenatedItemList),AlbumTrackItemList.prototype.createComparator=function(field,order){return Entities.Track.createComparator(field,order)},AlbumTrackItemList.prototype.createPredicate=function(field,operation,matcher){return Entities.Track.createPredicate(field,operation,matcher)},module.exports={DiscTrack:DiscTrackItemList,AlbumTrack:AlbumTrackItemList}}()},{"../entities":63,"../lists":76,"spotify-inheritance/inherit":131}],111:[function(require,module,exports){!function(){"use strict";function _getRandomInt(max){return Math.floor(Math.random()*(max+1))}function ContextItemList(base,owner,preload){if(!(this instanceof ContextItemList))return new ContextItemList(base,owner,preload);if(!owner)throw new TypeError("ContextItemList: Constructor argument `owner` cannot be undefined.");IterableItemList.call(this,base,preload||10),this._owner=owner,this._shuffled=!1,this._shuffledList=null,this._shuffleMode=ShuffleMode.SIMPLE}var inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Range=require("../range"),ItemList=require("../lists"),IterableItemList=ItemList.Iterable,LoadedState=ItemList.LoadedState,Snapshot=require("../lists/snapshot"),ShuffleMode={BALANCED:"balanced",SIMPLE:"simple"};inherit(ContextItemList,IterableItemList),ContextItemList.prototype.getOwner=function(){return this._owner},ContextItemList.prototype.setOwner=function(owner){return this._owner=owner,this},ContextItemList.prototype.setShuffleMode=function(mode){switch(mode){case ShuffleMode.SIMPLE:this._shuffleMode=ShuffleMode.SIMPLE;break;default:this._shuffleMode=ShuffleMode.BALANCED}return!0},ContextItemList.prototype.getRawIndex=function(){var index=this._index;return 0>index?ItemList.LIST_START:index>=this._length?ItemList.LIST_END:index},ContextItemList.prototype.getIndex=function(){var index=this._index;return 0>index?ItemList.LIST_START:index>=this._length?ItemList.LIST_END:(this.isShuffled()&&(index=this._shuffledList[index]),index)},ContextItemList.getDescriptorMap=function(context,index){var self=this,promise=new Promise;
if(!context)return promise.fulfill([]),promise;index=index==ItemList.OUT_OF_BOUNDS?-1:index;var descriptor=context.getDescriptor(),contextDescriptor=descriptor?[{descriptor:descriptor,index:index}]:[];if(!context.getBaseList)return contextDescriptor;var baseList=context.getBaseList();return baseList&&baseList!=context?context.translateIndex(index).then(function(translated){return self.getDescriptorMap(baseList,translated)}).then(function(array){return contextDescriptor.concat(array)}):context instanceof ItemList.Concatenated?context.getListForIndex(index).then(function(sublist){return Promise.join(sublist,context.translateIndex(index))}).thenSpread(function(sublist,index){return self.getDescriptorMap(sublist,index)}).then(function(array){return contextDescriptor.concat(array)}):(promise.fulfill(contextDescriptor),promise)},ContextItemList.prototype.isShuffled=function(){return!!(this._shuffled&&this._shuffledList&&this._shuffledList.length)},ContextItemList.prototype.shuffle=function(skipFirst){switch(this._shuffleMode){case ShuffleMode.SIMPLE:return this._shuffleSimple(skipFirst);case ShuffleMode.BALANCED:return this._shuffleBalanced(skipFirst)}},ContextItemList.prototype._shuffleSimple=function(skipFirst){if(this._loadedState==LoadedState.UNLOADED)return this._queueCall();var promise=new Promise;if(promise.fulfill(!0),this.isShuffled())return promise;this._shuffled=!0;for(var length=this._length,list=new Array(length);length--;)list[length]=length;var currentIndex=this.getRawIndex();currentIndex==ItemList.LIST_START?currentIndex=-1:currentIndex==ItemList.LIST_END&&(currentIndex=this._list.length-2),currentIndex=skipFirst?list.splice(currentIndex,1).pop():list.splice(currentIndex+1,1).pop();for(var len=list.length;len;){var index=Math.floor(Math.random()*len--),item=list[len];list[len]=list[index],list[index]=item}return null!=currentIndex&&(list.unshift(currentIndex),skipFirst?this._index=0:this._index=-1),this._shuffledList=list,promise},ContextItemList.prototype._shuffleBalanced=function(skipFirst){var self=this;if(this._loadedState==LoadedState.UNLOADED)return this._queueCall();if(this.isShuffled())return promise;var currentIndex=this.getRawIndex();return currentIndex==ItemList.LIST_START?currentIndex=-1:currentIndex==ItemList.LIST_END&&(currentIndex=this._list.length-2),this._base.snapshot(0,-1).then(function(snapshot){var tracks=snapshot.toFullArray();return skipFirst||(currentIndex+=1),tracks.splice(currentIndex,1),tracks}).then(this._groupItems).then(this._balancedShuffle).then(function(tracks){return null!=currentIndex&&(tracks.unshift(currentIndex),skipFirst?self._index=0:self._index=-1),self._shuffled=!0,self._shuffledList=tracks,!0}).catchError(function(e){console.error(e)})},ContextItemList.prototype._groupItems=function(tracks){for(var map={},groups=[[]],len=tracks.length,push=function(key,value){var index=map[key]||(map[key]=groups.length),array=groups[index]||(groups[index]=[]);array.push(value)};len--;){var track=tracks[len];track!=ItemList.NULL_VALUE&&(track.artists&&track.artists[0]&&track.artists[0].uri?track.album&&track.album.uri?push(track.artists[0].uri+track.album.uri,len):push(track.artists[0].uri,len):groups[0].push(len))}return groups},ContextItemList.prototype._balancedShuffle=function(groups){for(var maximum=1<<30,modmax=maximum-1,resp=[],k=0,l=groups.length;l>k;k++)for(var group=groups[k],n=group.length,offset=maximum/(3*n),rot=_getRandomInt(maximum),i=0;n>i;i++){var center=maximum*(2*i+1)/(2*n)+rot,position=_getRandomInt(2*offset+1)-offset+center&modmax;resp.push([position,group[i]])}resp.sort(function(a,b){return a[0]-b[0]});for(var len=resp.length;len--;)resp[len]=resp[len][1];return resp},ContextItemList.prototype.unshuffle=function(){if(this._loadedState==LoadedState.UNLOADED)return this._queueCall();var promise=new Promise;if(promise.fulfill(!0),!this._shuffled)return promise;if(this._shuffled=!1,this._shuffledList){var currentIndex=this.getRawIndex();return 0==currentIndex&&currentIndex==ItemList.LIST_START&&currentIndex==ItemList.LIST_END||(this._index=this._shuffledList[currentIndex]),promise}};var iterableSnapshot=IterableItemList.prototype._snapshot;ContextItemList.prototype._snapshot=function(offset,length,useRoot){var self=this;if(this.isShuffled()){var shuffledList=this._shuffledList,currentLength=shuffledList.length,promises=[];!this._infinite&&offset>currentLength&&(offset%=currentLength),(-1==length||!this._infinite&&offset+length>currentLength)&&(length=currentLength-offset);for(var i=0;length>i;i++){var realOffset=(offset+i)%currentLength,currentOffset=shuffledList[realOffset];promises.push(iterableSnapshot.call(this,currentOffset,1,useRoot))}return Promise.join(promises).then(function(snapshots){for(var tracks=[],i=0,l=snapshots.length;l>i;i++)tracks=tracks.concat(snapshots[i].toArray());return new Snapshot(self._version,function(version,offsetIndex,index){if(self._version!=version)throw new Error("Cannot access item with an expired snapshot.");return index in tracks?tracks[index]:ItemList.NULL_VALUE},new Range(offset,length),self._length)})}return iterableSnapshot.call(this,offset,length,useRoot)},ContextItemList.prototype.snapshot=function(offset,length){return this._snapshot(offset,length,!1)},ContextItemList.prototype.snapshotRoot=function(offset,length){return this._snapshot(offset,length,!0)},module.exports=ContextItemList}()},{"../lists":76,"../lists/snapshot":90,"../range":93,"spotify-inheritance/inherit":131,"spotify-promise":133}],112:[function(require,module,exports){!function(){"use strict";function DecoratorItemList(base,requestSender){if(LayeredItemList.call(this,base),!requestSender)throw new TypeError("Argument requestSender is null.");this._requestSender=requestSender,this._decoratedMap={},this._init()}var inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Range=require("../range"),ItemList=require("../lists"),LayeredItemList=ItemList.Layered,LoadedState=ItemList.LoadedState,Snapshot=ItemList.Snapshot;inherit(DecoratorItemList,LayeredItemList),DecoratorItemList.prototype._init=function(){this._base.getLength().then(function(length){this._length=length,0==length?this._loadedState=LoadedState.COMPLETE:this._loadedState=LoadedState.PARTIAL,this._unqueueSnapshots()}.bind(this)).catchError(function(e){})},DecoratorItemList.prototype._buildList=function(snapshot){var list=this._list,range=new Range(snapshot.getOffset(),snapshot.getLength()),items=snapshot.toArray();return list.insertFrom(range.begin,items),this._decorateItems(items,range)},DecoratorItemList.prototype._decorateItems=function(items,range){var self=this,promise=new Promise,map=this._decoratedMap;return this._requestSender(items).then(function(response){for(var i=0,l=items.length;l>i;i++){var item=items[i];map[item]=response[item]}self._updateRanges(range),self._updateState(),promise.fulfill(items)}),promise},DecoratorItemList.prototype._undecorateItems=function(items,range){for(var map=this._decoratedMap,promise=new Promise,i=0,l=items.length;l>i;i++){var item=items[i];delete map[item]}return promise.fulfill(items),promise},DecoratorItemList.prototype.snapshot=function(offset,length){var self=this,promise=new Promise,range=new Range(offset,length,Math.max(this._length-offset,0));if(0==range.length&&this._loadedState!=LoadedState.UNLOADED){var snapshot=new Snapshot(this._version,this._createVersionedAccessor([]),range,this._length);return promise.fulfill(snapshot),promise}switch(this._loadedState){case LoadedState.COMPLETE:this._base.snapshot(offset,length).then(function(snapshot){var _snapshot=new Snapshot(self._version,self._createVersionedAccessor(snapshot.toArray()),new Range(snapshot.getOffset(),snapshot.getLength(),snapshot.getListLength()),snapshot.getListLength());promise.fulfill(_snapshot)},promise.fail.bind(promise));break;case LoadedState.PARTIAL:range.findContainer(this._loadedRanges)?this._base.snapshot(offset,length).then(function(snapshot){var _snapshot=new Snapshot(self._version,self._createVersionedAccessor(snapshot.toArray()),new Range(snapshot.getOffset(),snapshot.getLength(),snapshot.getListLength()),snapshot.getListLength());promise.fulfill(_snapshot)},promise.fail.bind(promise)):this._base.snapshot(offset,length).then(function(snapshot){return self._buildList(snapshot)}).then(function(){return self.snapshot(offset,length).pipe(promise)}).catchError(function(e){promise.fail(e)});break;case LoadedState.UNLOADED:this._queueSnapshot(offset,length,promise)}return promise},DecoratorItemList.prototype._createVersionedAccessor=function(listSnap){var self=this,decorated=this._decoratedMap;return function(expectedVersion,index,originalIndex){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return decorated[listSnap[originalIndex]].metadata}},DecoratorItemList.prototype.onMutate=function(mutations){this.notify("onBeforeMutate",new Snapshot(this._version,this._createVersionedAccessor(this._list),new Range(0,this._length),this._length));for(var promises=[],i=0,l=mutations.length;l>i;i++){var mutation=mutations[i];switch(mutation.type){case"insert":promises.push(this._applyInsertMutation(mutation));break;case"remove":promises.push(this._applyRemoveMutation(mutation));break;case"move":promises.push(this._applyMoveMutation(mutation))}}promises.length&&Promise.join(promises).then(function(applied){this._version++,this.notify("onMutate",applied)}.bind(this))},DecoratorItemList.prototype._applyInsertMutation=function(mutation){var begin=mutation.begin,items=mutation.items,list=this._list;return list.spliceWith(begin,0,items),this._length+=items.length,this._decorateItems(items,new Range(begin,items.length)).then(function(tracks){return{type:"insert",begin:begin,items:tracks}})},DecoratorItemList.prototype._applyRemoveMutation=function(mutation){var promise=new Promise,begin=mutation.begin,length=mutation.length,list=this._list,items=list.splice(begin,length);return this._length-=length,promise.fulfill(mutation),this._undecorateItems(items,new Range(begin,length)).then(function(){return promise})},DecoratorItemList.prototype._applyMoveMutation=function(mutation){var promise=new Promise,begin=mutation.begin,end=mutation.end,length=mutation.length,list=this._list,items=list.splice(begin,length);return list.spliceWith(end,0,items),promise.fulfill(mutation),promise},module.exports=DecoratorItemList}()},{"../lists":76,"../range":93,"spotify-inheritance/inherit":131,"spotify-promise":133}],113:[function(require,module,exports){!function(){"use strict";function MappableItemList(base,property){this._property=property,DecoratorItemList.call(this,base,{})}var inherit=require("spotify-inheritance/inherit"),ItemList=require("../lists"),DecoratorItemList=require("./decorator"),LoadedState=ItemList.LoadedState,Promise=require("spotify-promise");inherit(MappableItemList,DecoratorItemList),MappableItemList.prototype._init=function(){this._base.getLength().then(function(length){this._length=length,this._loadedState=LoadedState.PARTIAL,this._unqueueSnapshots()}.bind(this)).catchError(function(e){})},MappableItemList.prototype._decorateItems=function(items,range){for(var map=this._decoratedMap,property=this._property,l=items.length;l--;){var key=items[l]&&items[l][property];if(key){var counter=map[key]||(map[key]={counter:0});counter.counter++}}this._updateRanges(range),this._updateState();var promise=new Promise;return promise.fulfill(items),promise},MappableItemList.prototype._undecorateItems=function(items,range){for(var map=this._decoratedMap,property=this._property,l=items.length;l--;){var key=items[l]&&items[l][property];if(key){var counter=map[key];counter&&(counter.counter--,counter.counter<1&&delete map[key])}}var promise=new Promise;return promise.fulfill(items),promise},MappableItemList.prototype.contains=function(key){var map=this._decoratedMap,promise=new Promise;return this._loadedState!=LoadedState.COMPLETE?this.snapshot(0,-1).then(function(){key in map&&map[key].counter?promise.fulfill(!0):promise.fulfill(!1)}):key in map&&map[key].counter?promise.fulfill(!0):promise.fulfill(!1),promise},MappableItemList.prototype._createVersionedAccessor=ItemList.Base.prototype._createVersionedAccessor,module.exports=MappableItemList}()},{"../lists":76,"./decorator":112,"spotify-inheritance/inherit":131,"spotify-promise":133}],114:[function(require,module,exports){!function(){"use strict";function MetadataDecoratorItemList(base,requestSender){DecoratorItemList.call(this,base,requestSender)}var inherit=require("spotify-inheritance/inherit"),DecoratorItemList=require("./decorator");inherit(MetadataDecoratorItemList,DecoratorItemList),MetadataDecoratorItemList.prototype._decorateItems=function(items,range){var result=this._requestSender(items).then(this._processMetadata.bind(this,items,range),function(e){console.error(e),console.error(e.stack)});return result},MetadataDecoratorItemList.prototype._processMetadata=function(items,range,response){for(var tracks=this._decoratedMap,len=items.length,results=new Array(len);len--;){var item=items[len],ref=tracks[item];ref?ref.count++:ref=tracks[item]={count:1,metadata:response[item]},results[len]=ref.metadata}return this._updateRanges(range),this._updateState(),results},MetadataDecoratorItemList.prototype._createVersionedAccessor=function(snap){var self=this,decorated=this._decoratedMap;return function(expectedVersion,index,originalIndex){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return decorated[snap[originalIndex]].metadata}},module.exports=MetadataDecoratorItemList}()},{"./decorator":112,"spotify-inheritance/inherit":131}],115:[function(require,module,exports){!function(){"use strict";function PlaylistRootItemList(uri,itemLoader,operationApplicator){return this instanceof PlaylistRootItemList?(BaseItemList.call(this),this._uid=0,this._uri=uri.toString(),this._loadLimit=200,this._revision=null,this._appliedRevisions={},this._batchedMutator=null,this._batchingTimeout=null,this._batchingPromise=null,this._itemLoader=itemLoader,void(this._operationApplicator=operationApplicator)):new PlaylistRootItemList(uri,itemLoader,operationApplicator)}function PlaylistRowItemList(uri,itemLoader,operationApplicator){return this instanceof PlaylistRowItemList?void PlaylistRootItemList.call(this,uri,itemLoader,operationApplicator):new PlaylistRowItemList(uri,itemLoader,operationApplicator)}function PlaylistStarredItemList(uri,itemLoader,operationApplicator){return this instanceof PlaylistStarredItemList?(PlaylistRowItemList.call(this,uri,itemLoader,operationApplicator),void(this._uid=0)):new PlaylistStarredItemList(uri,itemLoader,operationApplicator)}function PlaylistSubscribersItemList(uri,itemLoader){return this instanceof PlaylistSubscribersItemList?void PlaylistRootItemList.call(this,uri,itemLoader):new PlaylistSubscribersItemList(uri,itemLoader)}var Link=Spotify.Link,inherit=require("spotify-inheritance/inherit"),Promise=require("spotify-promise"),Range=require("../range"),Entities=require("../entities"),ItemList=require("../lists"),BaseItemList=ItemList.Base,MutationResult=ItemList.MutationResult,Snapshot=ItemList.Snapshot,_applyInsertMutation=BaseItemList.prototype._applyInsertMutation,_applyRemoveMutation=BaseItemList.prototype._applyRemoveMutation,_applyMoveMutation=BaseItemList.prototype._applyMoveMutation;inherit(PlaylistRootItemList,BaseItemList),PlaylistRootItemList.prototype._load=function(range){var self=this,promise=new Promise;return this._itemLoader(this._uri,range).then(function(serviceResponse){self._revision=Spotify.Utils.formatPlaylistRevision(serviceResponse.revision),promise.fulfill({range:range,items:self._createRows(serviceResponse)})}),promise},PlaylistRootItemList.prototype._loadLength=function(){var self=this,promise=new Promise,range=new Range(0,this._loadLimit);return this._itemLoader(this._uri,range).then(function(serviceResponse){var length=self._length=serviceResponse.length;promise.fulfill({length:length})},function(){var length=self._length=0;promise.fulfill({length:length})}),promise},PlaylistRootItemList.prototype._createRows=function(serviceResponse){for(var contents=serviceResponse.contents,result=[],i=0,l=contents.length;l>i;i++){var content=contents[i];content.attributes=content.attributes||{},content.attributes.uid=this._uid++,result.push(new Entities.RootlistRow(content.uri,content.attributes))}return result},PlaylistRootItemList.prototype._createMutationApplicator=function(){var self=this;return function(version,mutations){var promise=new Promise;if(self._version!=version)return promise.fulfill(MutationResult.EXPIRED),promise;self.notify("onBeforeMutate",new Snapshot(self._version,self._createVersionedAccessor(),new Range(0,self._length),self._length)),self._isMutating=!0;for(var operations=[],i=0,l=mutations.length;l>i;i++){var translated,mutation=mutations[i];switch(mutation.type){case"insert":translated=self._applyInsertMutation(mutation);break;case"remove":translated=self._applyRemoveMutation(mutation);break;case"move":translated=self._applyMoveMutation(mutation)}translated&&!mutation.internal&&operations.push(translated)}return operations.length?self._operationApplicator(self._uri,operations).then(function(r){self.setRevision(r),self._version++,self._isMutating=!1,self.notify("onMutate",mutations),promise.fulfill(MutationResult.SUCCESS)},function(e){self._isMutating=!1,promise.fail(MutationResult.FORBIDDEN)}):mutations.length&&(self._version++,self._isMutating=!1,self.notify("onMutate",mutations),promise.fulfill(MutationResult.SUCCESS)),promise}},PlaylistRootItemList.prototype._applyInsertMutation=function(mutation){for(var mutationItems=(mutation.begin,mutation.items),items=[],i=0,l=mutationItems.length;l>i;i++){var attributes={},item=mutationItems[i],uri=item.uri.toString();item.uid=this._uid++,item.folder&&(uri=item.rawURI),item["public"]&&(attributes["public"]=!0),items.push({uri:uri,attributes:attributes})}return _applyInsertMutation.call(this,mutation),{kind:"ADD",add:{fromIndex:mutation.begin,items:items}}},PlaylistRootItemList.prototype._applyRemoveMutation=function(mutation){return _applyRemoveMutation.call(this,mutation),{kind:"REM",rem:{fromIndex:mutation.begin,length:mutation.length}}},PlaylistRootItemList.prototype._applyMoveMutation=function(mutation){return _applyMoveMutation.call(this,mutation),{kind:"MOV",mov:{fromIndex:mutation.begin,toIndex:mutation.translated?mutation.end+1:mutation.end,length:mutation.length}}},PlaylistRootItemList.prototype.getRevision=function(){return this._revision},PlaylistRootItemList.prototype.setRevision=function(revision){this._revision=revision,this._appliedRevisions[revision]=1},PlaylistRootItemList.prototype.hasRevision=function(revision){return revision in this._appliedRevisions},PlaylistRootItemList.prototype.getBatchedMutator=function(){return this._batchingPromise||(this._batchingPromise=new Promise),this._batchedMutator||(this._batchedMutator=this.createMutator())},PlaylistRootItemList.prototype.applyBatchedMutator=function(){var self=this,promise=this._batchingPromise,mutator=this._batchedMutator;return clearTimeout(this._batchingTimeout),this._batchingTimeout=setTimeout(function(){self._batchedMutator=null,self._batchingPromise=null,mutator.apply().then(function(result){promise.fulfill(result)},function(error){promise.fail(error)})},100),promise},inherit(PlaylistRowItemList,PlaylistRootItemList),PlaylistRowItemList.prototype._createRows=function(serviceResponse){for(var contents=serviceResponse.contents,result=[],i=0,l=contents.length;l>i;i++){var content=contents[i];content.attributes=content.attributes||{},content.attributes.uid=this._uid++,result.push(new Entities.PlaylistRow(content.uri,content.attributes))}return result},PlaylistRowItemList.prototype._applyInsertMutation=function(mutation){for(var mutationItems=(mutation.begin,mutation.items),items=[],i=0,l=mutationItems.length;l>i;i++){var item=mutationItems[i];item.uid=this._uid++,items.push({uri:item.uri.toString(),attributes:{added_by:item.addedBy}})}return _applyInsertMutation.call(this,mutation),{kind:"ADD",add:{fromIndex:mutation.begin,items:items}}},PlaylistRowItemList.prototype.createComparator=function(field,order){return Entities.PlaylistRow.createComparator(field,order)},PlaylistRowItemList.prototype.createPredicate=function(field,operation,matcher){return Entities.PlaylistRow.createPredicate(field,operation,matcher)},inherit(PlaylistStarredItemList,PlaylistRowItemList),PlaylistStarredItemList.prototype._applyInsertMutation=function(mutation){for(var begin=mutation.begin,items=mutation.items,i=0,l=items.length;l>i;i++)items[i]&&(items[i].uid=this._uid++);var len=items.length,list=this._list;list.spliceWith(begin,0,items),this._length+=len;for(var uris=new Array(len);len--;)uris[len]=items[len].uri.toString();return{kind:"ADD",items:uris}},PlaylistStarredItemList.prototype._applyRemoveMutation=function(mutation){var begin=mutation.begin,len=mutation.length,list=this._list,items=list.splice(begin,len);this._length-=len;for(var uris=new Array(len);len--;)uris[len]=items[len].uri.toString();return{kind:"REM",items:uris}},inherit(PlaylistSubscribersItemList,PlaylistRootItemList),PlaylistSubscribersItemList.prototype._load=function(range){var self=this,promise=new Promise;return this._itemLoader(this._uri,range).then(function(serviceResponse){promise.fulfill({range:range,items:self._createRows(serviceResponse)})}),promise},PlaylistSubscribersItemList.prototype._createRows=function(serviceResponse){for(var contents=serviceResponse.contents,result=[],i=0,l=contents.length;l>i;i++){var content=contents[i];result.push({uri:Link.profileLink(content).toString()})}return result},module.exports={PlaylistRoot:PlaylistRootItemList,PlaylistRow:PlaylistRowItemList,PlaylistStarred:PlaylistStarredItemList,PlaylistSubscribers:PlaylistSubscribersItemList}}()},{"../entities":63,"../lists":76,"../range":93,"spotify-inheritance/inherit":131,"spotify-promise":133}],116:[function(require,module,exports){!function(){"use strict";function PlaylistTrackDecoratorItemList(base,requestSender){DecoratorItemList.call(this,base,requestSender)}var inherit=require("spotify-inheritance/inherit"),DecoratorItemList=require("./decorator");inherit(PlaylistTrackDecoratorItemList,DecoratorItemList),PlaylistTrackDecoratorItemList.prototype._decorateItems=function(items,range){for(var len=items.length,uris=new Array(len);len--;)uris[len]=items[len].uri;return this._requestSender(uris).then(this._processMetadata.bind(this,items,range),function(e){console.error(e),console.error(e.stack)})},PlaylistTrackDecoratorItemList.prototype._processMetadata=function(items,range,response){for(var len=items.length,results=new Array(len);len--;){var item=items[len];item.setTrack(response[item.uri]),results[len]=item}return this._updateRanges(range),this._updateState(),results},PlaylistTrackDecoratorItemList.prototype._createVersionedAccessor=function(){var self=this,list=this._list;return function(expectedVersion,index){if(self._version!=expectedVersion)throw new Error("Cannot access item with an expired snapshot.");return list[index]}},PlaylistTrackDecoratorItemList.prototype.getRevision=function(){return this._base.getRevision()},PlaylistTrackDecoratorItemList.prototype.setRevision=function(revision){return this._base.setRevision(revision)},PlaylistTrackDecoratorItemList.prototype.hasRevision=function(revision){return this._base.hasRevision(revision)},PlaylistTrackDecoratorItemList.prototype.ensureMutated=function(){return this._base.ensureMutated()},PlaylistTrackDecoratorItemList.prototype.getBatchedMutator=function(){return this._base.getBatchedMutator()},PlaylistTrackDecoratorItemList.prototype.applyBatchedMutator=function(){return this._base.applyBatchedMutator()},module.exports=PlaylistTrackDecoratorItemList}()},{"./decorator":112,"spotify-inheritance/inherit":131}],117:[function(require,module,exports){!function(){"use strict";function SearchItemList(uri,itemLoader){BaseItemList.call(this),this._uri=uri.toString(),this._loadLimit=50,this._itemLoader=itemLoader,this._timestamp=(new Date).getTime()}function SearchAlbumsItemList(uri,itemLoader){return this instanceof SearchAlbumsItemList?void SearchItemList.call(this,uri,itemLoader):new SearchAlbumsItemList(uri,itemLoader)}function SearchArtistsItemList(uri,itemLoader){return this instanceof SearchArtistsItemList?void SearchItemList.call(this,uri,itemLoader):new SearchArtistsItemList(uri,itemLoader)}function SearchPlaylistsItemList(uri,itemLoader){return this instanceof SearchPlaylistsItemList?void SearchItemList.call(this,uri,itemLoader):new SearchPlaylistsItemList(uri,itemLoader)}function SearchTracksItemList(uri,itemLoader){return this instanceof SearchTracksItemList?void SearchItemList.call(this,uri,itemLoader):new SearchTracksItemList(uri,itemLoader)}var inherit=require("spotify-inheritance/inherit"),Link=Spotify.Link,Promise=require("spotify-promise"),Entities=require("../entities"),Range=require("../range"),BaseItemList=require("../lists").Base,SearchTypes={ALBUMS:"albums",ARTISTS:"artists",PLAYLISTS:"playlists",TRACKS:"tracks"};inherit(SearchItemList,BaseItemList),SearchItemList.create=function(type,uri,itemLoader){switch(type){case"albums":return new SearchAlbumsItemList(uri,itemLoader);case"artists":return new SearchArtistsItemList(uri,itemLoader);case"playlists":return new SearchPlaylistsItemList(uri,itemLoader);case"tracks":return new SearchTracksItemList(uri,itemLoader);default:return null}},SearchItemList.prototype._load=function(range){var self=this,promise=new Promise;return this._itemLoader(range).then(function(serviceResponse){promise.fulfill({range:range,items:self._createRows(serviceResponse.items)})},function(error){promise.fail(error)}),promise},SearchItemList.prototype._loadLength=function(){var self=this,promise=new Promise,range=new Range(0,this._loadLimit);return this._itemLoader(range).then(function(serviceResponse){var length=self._length=Math.min(serviceResponse.length,1e4);self._insertLoadedData({range:new Range(0,Math.min(length,self._loadLimit)),items:self._createRows(serviceResponse.items)}),promise.fulfill({length:length})},function(){var length=self._length=0;promise.fulfill({length:length})}),promise},SearchItemList.prototype._createRows=function(items){return items},SearchItemList.prototype.isOlderThan=function(time){return(new Date).getTime()-this._timestamp>=time},inherit(SearchAlbumsItemList,SearchItemList),SearchAlbumsItemList.prototype._createRows=function(items){for(var i=0,l=items.length;l>i;i++){var item=items[i];items[i]=new Entities.SearchAlbum(new Spotify.Link.albumLink(item.id),item)}return items},inherit(SearchArtistsItemList,SearchItemList),SearchArtistsItemList.prototype._createRows=function(items){for(var i=0,l=items.length;l>i;i++){var item=items[i];items[i]=new Entities.SearchArtist(new Spotify.Link.artistLink(item.id),item)}return items},inherit(SearchPlaylistsItemList,SearchItemList),SearchPlaylistsItemList.prototype._createRows=function(items){for(var i=0,l=items.length;l>i;i++){var item=items[i],uri=Link.fromString(item.uri);item.owner=uri.username,items[i]=new Entities.SearchPlaylist(uri,item)}return items},inherit(SearchTracksItemList,SearchItemList),SearchTracksItemList.prototype._createRows=function(items){for(var i=0,l=items.length;l>i;i++){var item=items[i];items[i]=new Entities.SearchTrack(new Spotify.Link.trackLink(item.id),item)}return items},module.exports={SearchTypes:SearchTypes,Search:SearchItemList,SearchAlbums:SearchAlbumsItemList,SearchArtists:SearchArtistsItemList,SearchPlaylists:SearchPlaylistsItemList,SearchTracks:SearchTracksItemList}}()},{"../entities":63,"../lists":76,"../range":93,"spotify-inheritance/inherit":131,"spotify-promise":133}],118:[function(require,module,exports){!function(){"use strict";function ToplistItemList(uri,array){if(!(this instanceof ToplistItemList))return new ToplistItemList(uri,array);if(!array||!Array.isArray(array))throw new TypeError("ToplistItemList: Argument `array` must be an array.");array=array.slice(0);for(var len=array.length;len--;)array[len]=array[len].toString();ArrayItemList.call(this,array),this._uri=uri.toString()}function ToplistAlbumItemList(uri,array){return this instanceof ToplistAlbumItemList?void ToplistItemList.call(this,uri,array):new ToplistAlbumItemList(uri,array)}function ToplistArtistItemList(uri,array){return this instanceof ToplistArtistItemList?void ToplistItemList.call(this,uri,array):new ToplistArtistItemList(uri,array)}function ToplistPlaylistItemList(uri,array){return this instanceof ToplistPlaylistItemList?void ToplistItemList.call(this,uri,array):new ToplistPlaylistItemList(uri,array)}function ToplistTrackItemList(uri,array){return this instanceof ToplistTrackItemList?void ToplistItemList.call(this,uri,array):new ToplistTrackItemList(uri,array)}var inherit=require("spotify-inheritance/inherit"),ArrayItemList=require("../lists").Array,ToplistTypes={ALBUM:"album",ARTIST:"artist",PLAYLIST:"playlist",TRACK:"track"};inherit(ToplistItemList,ArrayItemList),ToplistItemList.create=function(type,uri,array){switch(type){case"artist":return new ToplistArtistItemList(uri,array);case"album":return new ToplistAlbumItemList(uri,array);case"playlist":return new ToplistPlaylistItemList(uri,array);case"track":default:return new ToplistTrackItemList(uri,array)}},inherit(ToplistAlbumItemList,ToplistItemList),inherit(ToplistArtistItemList,ToplistItemList),inherit(ToplistPlaylistItemList,ToplistItemList),inherit(ToplistTrackItemList,ToplistItemList),module.exports={ToplistTypes:ToplistTypes,Toplist:ToplistItemList,ToplistAlbum:ToplistAlbumItemList,ToplistArtist:ToplistArtistItemList,ToplistPlaylist:ToplistPlaylistItemList,ToplistTrack:ToplistTrackItemList}}()},{"../lists":76,"spotify-inheritance/inherit":131}],119:[function(require,module,exports){!function(){"use strict";function TrackListResolver(dispatcher,listManager){return this instanceof TrackListResolver?(this._dispatcher=dispatcher,this._listManager=listManager,void(this._resolvers={})):new TrackListResolver(dispatcher,listManager)}var ItemList=require("./lists"),SubItemList=require("./sublists"),Descriptor=ItemList.Descriptor,LinkHelper=require("./extension").LinkHelper,Promise=require("spotify-promise");TrackListResolver.prototype._resolveSimpleList=function(descriptor){var promise=new Promise,list=this._listManager.get(descriptor);if(list)return list.layersListType(SubItemList.PlaylistTrackDecorator)&&(list=new ItemList.Property(list,"track")),promise.fulfill(list),promise;var baseDescriptor=Descriptor.extractList(descriptor);if(!baseDescriptor)return promise.fail(new Error("Invalid descriptor")),promise;var uri=LinkHelper.from(baseDescriptor.uri),resolver=this._resolvers[uri.type];return resolver?resolver(uri,descriptor,this._dispatcher,this._listManager):(promise.fail(new Error("Cannot create list.")),promise)},TrackListResolver.prototype._filterSimpleList=function(simpleList){if(simpleList.layersListType(SubItemList.SearchTracks))return simpleList;var list=new ItemList.Filtered(simpleList,function(track){return track&&!!track.playable});return list.snapshot(0,-1).then(function(e){return list})},TrackListResolver.prototype._resolve=function(descriptor,filter){var promise;if("lists"==descriptor.type){for(var promises=[],descriptors=descriptor.lists,i=0,l=descriptors.length;l>i;i++)promise=this._resolveSimpleList(descriptors[i]),filter&&(promise=promise.then(this._filterSimpleList)),promises.push(promise);return Promise.join(promises).then(function(lists){for(var result=[],i=0,l=lists.length;l>i;i++){var list=lists[i];list&&result.push(list)}var concatenated=new ItemList.Concatenated(result);return concatenated.setDescriptor(descriptor),concatenated})}return promise=this._resolveSimpleList(descriptor),filter&&(promise=promise.then(this._filterSimpleList)),promise},TrackListResolver.prototype.register=function(type,resolver){return this._resolvers[type]=resolver,this},TrackListResolver.prototype.resolve=function(descriptor){
return this._resolve(descriptor,!0)},TrackListResolver.prototype.resolveAll=function(descriptor){return this._resolve(descriptor,!1)},module.exports=TrackListResolver}()},{"./extension":73,"./lists":76,"./sublists":109,"spotify-promise":133}],120:[function(require,module,exports){function CorePlayerManager(audioManager){return this instanceof CorePlayerManager?void(this._audioManager=audioManager):new CorePlayerManager(audioManager)}function CorePlayer(player){this._player=player,this.setVolume=player.setVolume.bind(player),this.seek=player.seek.bind(player),this.togglePlay=player.playpause.bind(player),this.resume=player.resume.bind(player),this.pause=player.pause.bind(player),this.stop=player.stop.bind(player),this._initEvents(player)}var inherit=require("spotify-inheritance/inherit"),EventEmitter=require("spotify-eventemitter"),types=require("../types"),Reason=types.TrackPlayerErrorReason;module.exports=CorePlayerManager,CorePlayerManager.prototype.createPlayer=function(id){return new CorePlayer(this._audioManager.addPlayer(id))},CorePlayerManager.prototype.crossfade=function(fromId,toId,time,cb){this._audioManager.crossfade(fromId,toId,time,cb)},CorePlayerManager.prototype.getPlayerLogger=function(id){return this._audioManager.getTrackerForPlayerWithId(id)},inherit(CorePlayer,EventEmitter),CorePlayer.prototype._initEvents=function(player){var self=this;player.bind("FIRST_BYTES",function(e){self.emit("firstBytes")}),player.bind("PLAYING",function(event){var position="number"==typeof event.params?event.params:parseInt(event.params,10);isNaN(position)&&(position=0),self.emit("playing",{position:position})}),player.bind("PAUSED",function(event){var position="number"==typeof event.params?event.params:parseInt(event.params,10);isNaN(position)&&(position=0),self.emit("paused",{position:position})}),player.bind("TRACK_ENDED",function(){self.emit("ended")}),player.bind("BEFORE_END",function(){self.emit("beforeEnd")}),player.bind("POSITION_CHANGED",function(event){var position="number"==typeof event.params?event.params:parseInt(event.params,10);isNaN(position)&&(position=0),self.emit("positionChanged",{position:position})}),player.bind("DURATION",function(event){self.emit("durationChanged",{duration:event.params.duration})}),player.bind("PROGRESS",function(event){self.emit("progress",{position:event.params.position})}),player.bind("CANNOT_PLAY_TRACK",this._handleError.bind(this)),player.bind("PLAYBACK_FAILED",this._handleError.bind(this)),player.bind("INVALID_TRACK_URI",this._handleError.bind(this))},CorePlayer.prototype._handleError=function(event){var reason=Reason.UNKNOWN,canPlayNext=!0,params=event.params;if(12==params.domain)switch(params.code){case 8:reason=Reason.REQUEST_CAP,canPlayNext=!1;break;case 12:reason=Reason.PLAY_CAP,canPlayNext=!1;break;case 11:reason=Reason.TRACK_CAP,canPlayNext=!0}this.emit("error",{reason:reason,canPlayNext:canPlayNext})},CorePlayer.prototype.getId=function(){return this._player.id},CorePlayer.prototype.getPlayerState=function(){var state=this._player.getPlayerState();return{playing:!state.isPaused&&!state.isStopped,position:state.position,duration:state.duration,volume:state.volume}},CorePlayer.prototype.load=function(track,options,callback){var player=this._player;player.onLoad=callback,player.loadFromParams({trackUri:track[options.uriProperty].toString(),offset:options.position,autoplay:options.autoplay,duration:options.duration,crossfadeBuffer:options.endTimeAmount,opt_fileId:track.fileId})}},{"../types":126,"spotify-eventemitter":128,"spotify-inheritance/inherit":131}],121:[function(require,module,exports){function ContextPlayerLogger(trackPlayerManager,contextPlayer){return this instanceof ContextPlayerLogger?(this._trackPlayerManager=trackPlayerManager,this._hasStartLog=!1,this.createStartLog=this.createStartLog.bind(this),this.createEndLog=this.createEndLog.bind(this),void contextPlayer.addListeners({beforePlay:this.createStartLog,beforeNext:this.createEndLog,beforePrevious:this.createEndLog,contextEnd:this.createEndLog,stopped:this.createEndLog})):new ContextPlayerLogger(trackPlayerManager,contextPlayer)}var URI=require("spotify-liburi");ContextPlayerLogger.prototype.createStartLog=function(event){var self=this,player=event.player,logger=this._trackPlayerManager.getPlayerLogger(player.getPlayerId()),track=event.track,rawOwner=(event.options,event.context.getOwner()),owner=URI.from(rawOwner),reason=event.reason;return player.getDescriptorMap().then(function(map){var _temp=map[map.length-1];if(_temp){var descriptor=URI.from(_temp.descriptor.uri);if(rawOwner&&descriptor){var contextURI=descriptor.toString(),sourceStart=descriptor.type;owner?"search"!=owner.id&&"radio"!=owner.id||(contextURI=descriptor.toString(),sourceStart=owner.id):owner=rawOwner;var log={display_track:track.uri,play_context:contextURI,source_start:sourceStart,reason_start:reason,referrer:owner.toString(),referrer_version:"0.1.0",referrer_vendor:"com.spotify"};logger.setEndSongStartLog(log),self._hasStartLog=!0}}}),this},ContextPlayerLogger.prototype.createEndLog=function(event){if(!this._hasStartLog)return this;var self=this,player=event.player,logger=this._trackPlayerManager.getPlayerLogger(player.getPlayerId()),rawOwner=event.context.getOwner(),owner=URI.from(rawOwner),reason=event.reason;return player.getDescriptorMap().then(function(map){var _temp=map[map.length-1];if(_temp){var descriptor=URI.from(_temp.descriptor.uri);if(rawOwner&&descriptor){var contextURI=descriptor.toString(),sourceEnd=descriptor.type;!owner||"search"!=owner.id&&"radio"!=owner.id||(contextURI=descriptor.toString(),sourceEnd=owner.id);var log={source_end:sourceEnd,reason_end:reason};logger.setEndSongStopLog(log),self._hasStartLog=!1}}}),this},module.exports=ContextPlayerLogger},{"spotify-liburi":123}],122:[function(require,module,exports){module.exports=require(34)},{"/Users/felipe/src/shuttle/node_modules/spotify-bridge/node_modules/spotify-crypto/src/base62.js":34}],123:[function(require,module,exports){"use strict";function URI(type,props){this.type=type;for(var prop in props)"function"!=typeof props[prop]&&(this[prop]=props[prop])}var Base62=require("spotify-crypto/src/base62"),URI_PREFIX="spotify:",PLAY_HTTP_PREFIX="http://play.spotify.com/",PLAY_HTTPS_PREFIX="https://play.spotify.com/",OPEN_HTTP_PREFIX="http://open.spotify.com/",OPEN_HTTPS_PREFIX="https://open.spotify.com/",ERROR_INVALID=new TypeError("Invalid Spotify URI!"),Format=(new TypeError("Not implemented!"),{URI:0,URL:1}),_splitIntoComponents=function(str){var components,format=Format.URL;if(0==str.indexOf(URI_PREFIX))components=str.slice(URI_PREFIX.length).split(":"),format=Format.URI;else if(0==str.indexOf(PLAY_HTTP_PREFIX))components=str.slice(PLAY_HTTP_PREFIX.length).split("/");else if(0==str.indexOf(PLAY_HTTPS_PREFIX))components=str.slice(PLAY_HTTPS_PREFIX.length).split("/");else if(0==str.indexOf(OPEN_HTTP_PREFIX))components=str.slice(OPEN_HTTP_PREFIX.length).split("/");else{if(0!=str.indexOf(OPEN_HTTPS_PREFIX))throw ERROR_INVALID;components=str.slice(OPEN_HTTPS_PREFIX.length).split("/")}return{format:format,components:components}},_encodeComponent=function(component,format){return component=encodeURIComponent(component),format==Format.URI?component.replace(/%20/g,"+"):component},_decodeComponent=function(component,format){var part=format==Format.URI?component.replace(/\+/g,"%20"):component;return decodeURIComponent(part)},_getComponents=function(uri,format){var base62;uri.id&&(base62=Base62.fromHex(uri.id,22));var components,i,len;switch(uri.type){case URI.Type.ALBUM:return components=[URI.Type.ALBUM,base62],uri.disc&&components.push(uri.disc),components;case URI.Type.AD:return[URI.Type.AD,uri.id];case URI.Type.ARTIST:return[URI.Type.ARTIST,base62];case URI.Type.ARTIST_TOPLIST:return[URI.Type.ARTIST,base62,URI.Type.TOP,uri.toplist];case URI.Type.SEARCH:return[URI.Type.SEARCH,_encodeComponent(uri.query,format)];case URI.Type.TRACK:return[URI.Type.TRACK,base62];case URI.Type.TRACKSET:var trackIds=[];for(i=0,len=uri.tracks.length;len>i;i++)trackIds.push(Base62.fromHex(uri.tracks[i].id,22));return trackIds=[trackIds.join(",")],null!==uri.index&&trackIds.push("#",uri.index),[URI.Type.TRACKSET,_encodeComponent(uri.name)].concat(trackIds);case URI.Type.FACEBOOK:return[URI.Type.USER,URI.Type.FACEBOOK,uri.uid];case URI.Type.AUDIO_FILE:return[URI.Type.AUDIO_FILE,uri.extension,uri.id];case URI.Type.FOLLOWERS:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.FOLLOWERS];case URI.Type.FOLLOWING:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.FOLLOWING];case URI.Type.PLAYLIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.PLAYLIST,base62];case URI.Type.STARRED:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.STARRED];case URI.Type.TEMP_PLAYLIST:return[URI.Type.TEMP_PLAYLIST,uri.origin,uri.data];case URI.Type.CONTEXT_GROUP:return[URI.Type.CONTEXT_GROUP,uri.origin,uri.name];case URI.Type.USER_TOPLIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.TOP,uri.toplist];case URI.Type.USET_TOP_TRACKS:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.TOPLIST];case URI.Type.TOPLIST:return[URI.Type.TOP,uri.toplist].concat(uri.global?[URI.Type.GLOBAL]:["country",uri.country]);case URI.Type.INBOX:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.INBOX];case URI.Type.ROOTLIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.ROOTLIST];case URI.Type.PUBLISHED_ROOTLIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.PUBLISHED_ROOTLIST];case URI.Type.COLLECTION_TRACK_LIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.COLLECTION_TRACK_LIST,base62];case URI.Type.PROFILE:return uri.args&&uri.args.length>0?[URI.Type.USER,_encodeComponent(uri.username)].concat(uri.args):[URI.Type.USER,_encodeComponent(uri.username)];case URI.Type.LOCAL_ARTIST:return[URI.Type.LOCAL,_encodeComponent(uri.artist,format)];case URI.Type.LOCAL_ALBUM:return[URI.Type.LOCAL,_encodeComponent(uri.artist,format),_encodeComponent(uri.album,format)];case URI.Type.LOCAL:return[URI.Type.LOCAL,_encodeComponent(uri.artist,format),_encodeComponent(uri.album,format),_encodeComponent(uri.track,format),uri.duration];case URI.Type.LIBRARY:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.LIBRARY].concat(uri.category?[uri.category]:[]);case URI.Type.IMAGE:return[URI.Type.IMAGE,uri.id];case URI.Type.MOSAIC:return components=uri.ids.slice(0),components.unshift(URI.Type.MOSAIC),components;case URI.Type.RADIO:return[URI.Type.RADIO,uri.args];case URI.Type.APPLICATION:components=[URI.Type.APP,uri.id];var args=uri.args||[];for(i=0,len=args.length;len>i;++i)components.push(_encodeComponent(args[i],format));return components;case URI.Type.COLLECTION_ALBUM:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.COLLECTION,URI.Type.ALBUM,base62];case URI.Type.COLLECTION_MISSING_ALBUM:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.COLLECTION,URI.Type.ALBUM,base62,"missing"];case URI.Type.COLLECTION_ARTIST:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.COLLECTION,URI.Type.ARTIST,base62];case URI.Type.COLLECTION:return[URI.Type.USER,_encodeComponent(uri.username),URI.Type.COLLECTION].concat(uri.category?[uri.category]:[]);default:throw ERROR_INVALID}},_parseFromComponents=function(components,format){var id,i,len,_current=0,_getNextComponent=function(){return components[_current++]},_getIdComponent=function(){var id=_getNextComponent();return 22==id.length?Base62.toHex(id,32):id},_getRemainingComponents=function(){return components.slice(_current)},_getRemainingString=function(){var separator=format==Format.URI?":":"/";return components.slice(_current).join(separator)},part=_getNextComponent();switch(part){case URI.Type.ALBUM:return URI.albumURI(_getIdComponent(),parseInt(_getNextComponent(),10));case URI.Type.AD:return URI.adURI(_getIdComponent());case URI.Type.ARTIST:return id=_getIdComponent(),_getNextComponent()==URI.Type.TOP?URI.artistToplistURI(id,_getNextComponent()):URI.artistURI(id);case URI.Type.AUDIO_FILE:return URI.audioFileURI(_getNextComponent(),_getNextComponent());case URI.Type.TEMP_PLAYLIST:return URI.temporaryPlaylistURI(_getNextComponent(),_getRemainingString());case URI.Type.SEARCH:return URI.searchURI(_decodeComponent(_getRemainingString(),format));case URI.Type.TRACK:return URI.trackURI(_getIdComponent());case URI.Type.TRACKSET:var name=_decodeComponent(_getNextComponent()),tracksArray=_getNextComponent(),hashSign=_getNextComponent(),index=parseInt(_getNextComponent(),10);("%23"!==hashSign||isNaN(index))&&(index=null);var tracksetTracks=[];if(tracksArray)for(tracksArray=_decodeComponent(tracksArray).split(","),i=0,len=tracksArray.length;len>i;i++){var trackId=tracksArray[i];tracksetTracks.push(URI.trackURI(Base62.toHex(trackId,32)))}return URI.tracksetURI(tracksetTracks,name,index);case URI.Type.CONTEXT_GROUP:return URI.contextGroupURI(_getNextComponent(),_getNextComponent());case URI.Type.TOP:var type=_getNextComponent();return _getNextComponent()==URI.Type.GLOBAL?URI.toplistURI(type,null,!0):URI.toplistURI(type,_getNextComponent(),!1);case URI.Type.USER:var username=_decodeComponent(_getNextComponent(),format),text=_getNextComponent();if(username==URI.Type.FACEBOOK&&null!=text)return URI.facebookURI(parseInt(text,10));if(null!=text)switch(text){case URI.Type.PLAYLIST:return URI.playlistURI(username,_getIdComponent());case URI.Type.COLLECTION_TRACK_LIST:return URI.collectionTrackList(username,_getIdComponent());case URI.Type.COLLECTION:var collectionItemType=_getNextComponent();switch(collectionItemType){case URI.Type.ALBUM:return id=_getIdComponent(),"missing"===_getNextComponent()?URI.collectionMissingAlbumURI(username,id):URI.collectionAlbumURI(username,id);case URI.Type.ARTIST:return URI.collectionArtistURI(username,_getIdComponent());default:return URI.collectionURI(username,collectionItemType)}case URI.Type.STARRED:return URI.starredURI(username);case URI.Type.FOLLOWERS:return URI.followersURI(username);case URI.Type.FOLLOWING:return URI.followingURI(username);case URI.Type.TOP:return URI.userToplistURI(username,_getNextComponent());case URI.Type.INBOX:return URI.inboxURI(username);case URI.Type.ROOTLIST:return URI.rootlistURI(username);case URI.Type.PUBLISHED_ROOTLIST:return URI.publishedRootlistURI(username);case URI.Type.TOPLIST:return URI.userTopTracksURI(username);case URI.Type.LIBRARY:return URI.libraryURI(username,_getNextComponent())}var rem=_getRemainingComponents();return null!=text&&rem.length>0?URI.profileURI(username,[text].concat(rem)):null!=text?URI.profileURI(username,[text]):URI.profileURI(username);case URI.Type.LOCAL:var artistNameComponent=_getNextComponent(),artistName=artistNameComponent&&_decodeComponent(artistNameComponent,format),albumNameComponent=_getNextComponent(),albumName=albumNameComponent&&_decodeComponent(albumNameComponent,format),trackNameComponent=_getNextComponent(),trackName=trackNameComponent&&_decodeComponent(trackNameComponent,format),durationComponent=_getNextComponent(),duration=parseInt(durationComponent,10);return void 0!==trackNameComponent?URI.localURI(artistName,albumName,trackName,duration):void 0!==albumNameComponent?URI.localAlbumURI(artistName,albumName):URI.localArtistURI(artistName);case URI.Type.IMAGE:return URI.imageURI(_getIdComponent());case URI.Type.MOSAIC:return URI.mosaicURI(components.slice(_current));case URI.Type.RADIO:return URI.radioURI(_getRemainingString());default:id=part===URI.Type.APP?_getNextComponent():part;var args=_getRemainingComponents();for(i=0,len=args.length;len>i;++i)args[i]=_decodeComponent(args[i],format);return URI.applicationURI(id,args)}throw ERROR_INVALID};URI.prototype.toAppType=function(){if(this.type==URI.Type.APPLICATION)return URI.applicationURI(this.id,this.args);var components=_getComponents(this,Format.URL),id=components.shift(),len=components.length;if(len)for(;len--;)components[len]=_decodeComponent(components[len],Format.URL);this.type==URI.Type.RADIO&&(components=components.shift().split(":"));var result=URI.applicationURI(id,components);return result},URI.prototype.toRealType=function(){return this.type==URI.Type.APPLICATION?_parseFromComponents([this.id].concat(this.args),Format.URI):new URI(null,this)},URI.prototype.toURI=function(){return URI_PREFIX+_getComponents(this,Format.URI).join(":")},URI.prototype.toString=function(){return this.toURI()},URI.prototype.toURLPath=function(opt_leadingSlash){var components=_getComponents(this,Format.URL);if(components[0]===URI.Type.APP&&components.shift(),components[0]!=URI.Type.TRACKSET){for(var _temp=[],i=0,l=components.length;l>i;i++){var component=components[i];component&&_temp.push(component)}components=_temp}var path=components.join("/");return opt_leadingSlash?"/"+path:path},URI.prototype.toPlayURL=function(){return PLAY_HTTP_PREFIX+this.toURLPath()},URI.prototype.toURL=function(){return this.toPlayURL()},URI.prototype.toOpenURL=function(){return OPEN_HTTP_PREFIX+this.toURLPath()},URI.prototype.toSecurePlayURL=function(){return PLAY_HTTPS_PREFIX+this.toURLPath()},URI.prototype.toSecureURL=function(){return this.toSecurePlayURL()},URI.prototype.toSecureOpenURL=function(){return OPEN_HTTPS_PREFIX+this.toURLPath()},URI.prototype.idToByteString=function(){var id=Base62.fromHex(this.id),data=Base62.toBytes(id);for(data=data.map(function(i){return String.fromCharCode(i)}).join("");data.length<16;)data=String.fromCharCode(0)+data;return data},URI.Type={EMPTY:"empty",ALBUM:"album",AD:"ad",APP:"app",APPLICATION:"application",ARTIST:"artist",ARTIST_TOPLIST:"artist-toplist",AUDIO_FILE:"audiofile",COLLECTION:"collection",COLLECTION_ALBUM:"collection-album",COLLECTION_MISSING_ALBUM:"collection-missing-album",COLLECTION_ARTIST:"collection-artist",CONTEXT_GROUP:"context-group",FACEBOOK:"facebook",FOLLOWERS:"followers",FOLLOWING:"following",GLOBAL:"global",IMAGE:"image",INBOX:"inbox",LOCAL_ARTIST:"local-artist",LOCAL_ALBUM:"local-album",LOCAL:"local",LIBRARY:"library",MOSAIC:"mosaic",PLAYLIST:"playlist",PROFILE:"profile",PUBLISHED_ROOTLIST:"published-rootlist",RADIO:"radio",ROOTLIST:"rootlist",COLLECTION_TRACK_LIST:"collectiontracklist",SEARCH:"search",STARRED:"starred",TEMP_PLAYLIST:"temp-playlist",TOP:"top",TOPLIST:"toplist",TRACK:"track",TRACKSET:"trackset",USER:"user",USER_TOPLIST:"user-toplist",USET_TOP_TRACKS:"user-top-tracks"},URI.fromString=function(str){var splitted=_splitIntoComponents(str);return _parseFromComponents(splitted.components,splitted.format)},URI.from=function(value){try{return value instanceof URI?value:"object"==typeof value&&value.type?new URI(null,value):URI.fromString(value.toString())}catch(e){return null}},URI.fromByteString=function(type,idByteString,opt_args){for(var bytes=[],i=0;i<idByteString.length;i++)bytes.push(idByteString.charCodeAt(i));var id=Base62.fromBytes(bytes,22);id=Base62.toHex(id);var args=opt_args||{};return args.id=id,new URI(type,args)},URI.clone=function(uri){return uri instanceof URI?new URI(null,uri):null},URI.getCanonical=function(username){return this.getCanonical(username)},URI.getCanonicalUsername=function(username){return _encodeComponent(username,Format.URI)},URI.getDisplayUsername=function(username){return _decodeComponent(username,Format.URI)},URI.idToHex=function(id){return 22==id.length?Base62.toHex(id,32):id},URI.hexToId=function(hex){return 32==hex.length?Base62.fromHex(hex,22):hex},URI.emptyURI=function(){return new URI(URI.Type.EMPTY,{})},URI.albumURI=function(id,disc){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.ALBUM,{id:id,disc:disc})},URI.adURI=function(id){return new URI(URI.Type.AD,{id:id})},URI.audioFileURI=function(extension,id){return new URI(URI.Type.AUDIO_FILE,{id:id,extension:extension})},URI.artistURI=function(id){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.ARTIST,{id:id})},URI.artistToplistURI=function(id,toplist){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.ARTIST_TOPLIST,{id:id,toplist:toplist})},URI.searchURI=function(query){return new URI(URI.Type.SEARCH,{query:query})},URI.trackURI=function(id){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.TRACK,{id:id})},URI.tracksetURI=function(tracks,name,index){return new URI(URI.Type.TRACKSET,{tracks:tracks,name:name||"",index:isNaN(index)?null:index})},URI.facebookURI=function(uid){return new URI(URI.Type.FACEBOOK,{uid:uid})},URI.followersURI=function(username){return new URI(URI.Type.FOLLOWERS,{username:username})},URI.followingURI=function(username){return new URI(URI.Type.FOLLOWING,{username:username})},URI.playlistURI=function(username,id){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.PLAYLIST,{username:username,id:id})},URI.collectionTrackList=function(username,id){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.COLLECTION_TRACK_LIST,{username:username,id:id})},URI.starredURI=function(username){return new URI(URI.Type.STARRED,{username:username})},URI.userToplistURI=function(username,toplist){return new URI(URI.Type.USER_TOPLIST,{username:username,toplist:toplist})},URI.userTopTracksURI=function(username){return new URI(URI.Type.USET_TOP_TRACKS,{username:username})},URI.toplistURI=function(toplist,country,global){return new URI(URI.Type.TOPLIST,{toplist:toplist,country:country,global:!!global})},URI.inboxURI=function(username){return new URI(URI.Type.INBOX,{username:username})},URI.rootlistURI=function(username){return new URI(URI.Type.ROOTLIST,{username:username})},URI.publishedRootlistURI=function(username){return new URI(URI.Type.PUBLISHED_ROOTLIST,{username:username})},URI.localArtistURI=function(artist){return new URI(URI.Type.LOCAL_ARTIST,{artist:artist})},URI.localAlbumURI=function(artist,album){return new URI(URI.Type.LOCAL_ALBUM,{artist:artist,album:album})},URI.localURI=function(artist,album,track,duration){return new URI(URI.Type.LOCAL,{artist:artist,album:album,track:track,duration:duration})},URI.libraryURI=function(username,category){return new URI(URI.Type.LIBRARY,{username:username,category:category})},URI.collectionURI=function(username,category){return new URI(URI.Type.COLLECTION,{username:username,category:category})},URI.temporaryPlaylistURI=function(origin,data){return new URI(URI.Type.TEMP_PLAYLIST,{origin:origin,data:data})},URI.contextGroupURI=function(origin,name){return new URI(URI.Type.CONTEXT_GROUP,{origin:origin,name:name})},URI.profileURI=function(username,args){return new URI(URI.Type.PROFILE,{username:username,args:args})},URI.imageURI=function(id){return 22==id.length&&(id=Base62.toHex(id,32)),new URI(URI.Type.IMAGE,{id:id})},URI.mosaicURI=function(ids){return new URI(URI.Type.MOSAIC,{ids:ids})},URI.radioURI=function(args){return args="undefined"==typeof args?"":args,new URI(URI.Type.RADIO,{args:args})},URI.applicationURI=function(id,args){return args="undefined"==typeof args?[]:args,new URI(URI.Type.APPLICATION,{id:id,args:args})},URI.collectionAlbumURI=function(username,id){return new URI(URI.Type.COLLECTION_ALBUM,{username:username,id:id})},URI.collectionMissingAlbumURI=function(username,id){return new URI(URI.Type.COLLECTION_MISSING_ALBUM,{username:username,id:id})},URI.collectionArtistURI=function(username,id){return new URI(URI.Type.COLLECTION_ARTIST,{username:username,id:id})},module.exports=URI},{"spotify-crypto/src/base62":122}],124:[function(require,module,exports){"use strict";function MergedPlaybackOptions(options){options=options||{},this.index="index"in options?options.index:-1,this.offset="offset"in options?options.offset:0,this.initialOffset="initialOffset"in options?options.initialOffset:0,this.duration="duration"in options?options.duration:-1,this.pause="pause"in options?options.pause:!1,this.reason=options.reason||"unknown",this.rules=options.rules?new Ruleset(options.rules):DefaultRulesets.DEFAULT}function ContextPlayer(options){if(!(this instanceof ContextPlayer))return new ContextPlayer(options);if(!options.id)throw new TypeError("ContextPlayer: Argument `id` cannot be undefined.");if(!options.trackPlayerManager)throw new TypeError("ContextPlayer: Argument `trackPlayerManager` cannot be undefined.");EventEmitter.call(this),this._trackPlayerManager=options.trackPlayerManager,this._id=options.id,this._uriProperty=options.uriProperty||"playableURI",this._getDescriptorMap=options.descriptorMapper,this._uid=0,this._listPlayCount=0,this._player=null,this._alternatePlayer=null,this._interceptContextList=options.interceptList,this._queueContextList=options.queueList,this._listConstants=options.listConstants,this._loadedContextList=null,this._loadedPlaybackOptions=null,this._loadedRuleset=null,this._currentTrack=null,this._previousPlayToken=null,this._fakePlayingState=!1,this._repeatMode=RepeatMode.NONE,this._repeated=!1,this._trackRepeated=!1,this._shuffled=!1,this._playPreviousAfterIntercept=!1,this._stopped=!1,this._timeoutAmount=1e4,this._timeoutToken=null,this._preload=!1,this._crossfade=!1,this._crossfading=!1,this._crossfadeAmount=0,this._beforeEndBuffer=1e3,this._playingFromIntercept=!1,this._playingFromQueue=!1,this._overrideRules=null,this._contextObserver={onMutate:function(){this.emit("contextChange",{player:this,context:this._loadedContextList,options:this._loadedPlaybackOptions})}.bind(this)},this._delegate=null,this._setContextIndex=this._setContextIndex.bind(this),this._loadContext=this._loadContext.bind(this),this._handleTimeout=this._handleTimeout.bind(this),this._handleFirstBytes=this._handleFirstBytes.bind(this),this._handlePlay=this._handlePlay.bind(this),this._handlePause=this._handlePause.bind(this),this._handleEnded=this._handleEnded.bind(this),this._handleError=this._handleError.bind(this),this._handleBeforeEnded=this._handleBeforeEnded.bind(this),this._handlePositionChange=this._handlePositionChange.bind(this),this._handleDuration=this._handleDuration.bind(this),this._handleProgress=this._handleProgress.bind(this),this._handleUpdate=this._handleUpdate.bind(this),this._init()}var inherit=require("spotify-inheritance/inherit"),EventEmitter=(require("spotify-inheritance/extend"),require("spotify-eventemitter")),Promise=require("spotify-promise"),types=require("./types"),OperationResult=types.OperationResult,DefaultRulesets=types.DefaultRulesets,Ruleset=types.Ruleset,Reason=types.Reason,RepeatMode=types.RepeatMode,FAST_SWITCHING_THRESHOLD=250;inherit(ContextPlayer,EventEmitter),ContextPlayer.prototype.getRuleFor=function(name){var rule=DefaultRulesets[name.toUpperCase()];return rule?rule:DefaultRulesets.DEFAULT},ContextPlayer.prototype._init=function(){var trackPlayerManager=this._trackPlayerManager,id=this._id,playerPromise=trackPlayerManager.createPlayer(id+":A");if(!playerPromise.then){var player=playerPromise;playerPromise=new Promise,playerPromise.fulfill(player)}playerPromise.then(function(player){this._initEvents(player),this._player=player}.bind(this));var alternatePlayerPromise=trackPlayerManager.createPlayer(id+":B");if(!alternatePlayerPromise.then){var alternatePlayer=alternatePlayerPromise;alternatePlayerPromise=new Promise,alternatePlayerPromise.fulfill(alternatePlayer)}alternatePlayerPromise.then(function(alternatePlayer){this._initEvents(alternatePlayer),this._alternatePlayer=alternatePlayer}.bind(this)),this._initObserver(this._interceptContextList,"interceptChange"),this._initObserver(this._queueContextList,"queueChange")},ContextPlayer.prototype._initEvents=function(player){player.addListener("firstBytes",this._handleFirstBytes),player.addListener("playing",this._handlePlay),player.addListener("paused",this._handlePause),player.addListener("ended",this._handleEnded),player.addListener("error",this._handleError),player.addListener("beforeEnd",this._handleBeforeEnded),player.addListener("positionChanged",this._handlePositionChange),player.addListener("durationChanged",this._handleDuration),player.addListener("progress",this._handleProgress),player.addListener("update",this._handleUpdate)},ContextPlayer.prototype._removeEvents=function(player){player.removeListener("firstBytes",this._handleFirstBytes),player.removeListener("playing",this._handlePlay),player.removeListener("paused",this._handlePause),player.removeListener("ended",this._handleEnded),player.removeListener("error",this._handleError),player.removeListener("beforeEnd",this._handleBeforeEnded),player.removeListener("positionChanged",this._handlePositionChange),player.removeListener("durationChanged",this._handleDuration),player.removeListener("progress",this._handleProgress),player.removeListener("update",this._handleUpdate)},ContextPlayer.prototype._initObserver=function(list,eventName){list.observe({onMutate:this.emit.bind(this,eventName,null,null)})},ContextPlayer.prototype._handleFirstBytes=function(event){clearTimeout(this._timeoutToken)},ContextPlayer.prototype._handlePlay=function(event){this._fakePlayingState=!1,clearTimeout(this._timeoutToken),this.emit("play",{uid:this._uid,player:this,track:this._currentTrack,position:event.position,context:this._loadedContextList,options:this._loadedPlaybackOptions})},ContextPlayer.prototype._handlePause=function(event){this.emit("pause",{uid:this._uid,player:this,track:this._currentTrack,position:event.position,context:this._loadedContextList,options:this._loadedPlaybackOptions})},ContextPlayer.prototype._handleEnded=function(event){this.emit("playEnd",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions}),this._playingFromIntercept&&(this._playingFromIntercept=!1),this._crossfade||this._preload||(this._playPreviousAfterIntercept?this.previous(Reason.TRACK_DONE):this.next(Reason.TRACK_DONE))},ContextPlayer.prototype._handleBeforeEnded=function(event){this.emit("beforePlayEnd",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions}),(this._crossfade||this._preload)&&(this._playPreviousAfterIntercept?this.previous(Reason.TRACK_DONE):this.next(Reason.TRACK_DONE))},ContextPlayer.prototype._handleError=function(event){clearTimeout(this._timeoutToken),this._playingFromIntercept=!1,"unknown"!=event.reason&&this.emit(event.reason),event.canPlayNext&&this.next(Reason.TRACK_ERROR)},ContextPlayer.prototype._handleTimeout=function(){this._fakePlayingState=!1,this._playingFromIntercept=!1,this.emit("timeout",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions}),this._playPreviousAfterIntercept?this.previous(Reason.TRACK_ERROR):this.next(Reason.TRACK_ERROR)},ContextPlayer.prototype._handlePositionChange=function(event){this.emit("positionChanged",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions,position:event.position})},ContextPlayer.prototype._handleDuration=function(event){this.emit("durationChanged",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadContext,duration:event.duration})},ContextPlayer.prototype._handleProgress=function(event){this.emit("progress",{uid:this._uid,player:this,track:this._currentTrack,context:this._loadContext,position:event.position})},ContextPlayer.prototype._handleUpdate=function(event){this.emit("update",{player:this})},ContextPlayer.prototype._getRuleset=function(){return this._overrideRules?this._overrideRules:this._playingFromIntercept?DefaultRulesets.INTERCEPT:this._loadedRuleset||DefaultRulesets.DEFAULT},ContextPlayer.prototype._getLoadedRules=function(){return this._loadedRuleset},ContextPlayer.prototype._getRuleFor=function(key){var defaultRules=DefaultRulesets.DEFAULT,rules=this._getRuleset();return key in rules?rules[key]:defaultRules[key]||!0},ContextPlayer.prototype.getPlayerId=function(){return this._delegate?null:this._player.getId()},ContextPlayer.prototype.getInterceptList=function(){return this._delegate?this._delegate.getInterceptList():this._interceptContextList},ContextPlayer.prototype.isPlayingFromIntercept=function(){return this._delegate?this._delegate.isPlayingFromIntercept():!!this._playingFromIntercept;
},ContextPlayer.prototype.getQueueList=function(){return this._delegate?this._delegate.getQueueList():this._queueContextList},ContextPlayer.prototype.isPlayingFromQueue=function(){return this._delegate?this._delegate.isPlayingFromQueue():!!this._playingFromQueue},ContextPlayer.prototype.getContextList=function(){return this._delegate?this._delegate.getContextList():this._loadedContextList||null},ContextPlayer.prototype.getCurrentTrack=function(){return this._delegate?this._delegate.getCurrentTrack():this._currentTrack||null},ContextPlayer.prototype.getDescriptorMap=function(){if(this._delegate)return this._delegate.getDescriptorMap();var context=this._loadedContextList,index=0;return context&&(index=context.wasCurrentIndexRemoved()?-1:context.getIndex()),this._getDescriptorMap(context,index)},ContextPlayer.prototype.isCrossfading=function(){return this._crossfade?!1:!!this._crossfading},ContextPlayer.prototype.delegateTo=function(delegate){this._delegate=delegate,this._initEvents(delegate)},ContextPlayer.prototype.undelegate=function(){var oldDelegate=this._delegate;this._removeEvents(oldDelegate),this._delegate=null},ContextPlayer.prototype.isDelegatedTo=function(delegate){return this._delegate==delegate},ContextPlayer.prototype.getPlayerState=function(){if(this._delegate)return this._delegate.getPlayerState();var player=this._player,audioPlayerState=player.getPlayerState();return Promise.join(this.getPlaybackState(audioPlayerState),this.getTrackState(audioPlayerState),this.getContextState()).thenSpread(function(playbackState,trackState,contextState){var state={playbackState:playbackState,trackState:trackState,contextState:contextState};return state})},ContextPlayer.prototype.getPlaybackState=function(opt_audioPlayerState){if(this._delegate)return this._delegate.getPlaybackState(opt_audioPlayerState);var promise=new Promise,audioPlayerState=opt_audioPlayerState||this._player.getPlayerState(),state={uid:this._uid,ruleset:this._getRuleset(),playing:this._fakePlayingState?!0:audioPlayerState.playing,volume:audioPlayerState.volume,repeatMode:this._repeatMode};return promise.fulfill(state),promise},ContextPlayer.prototype.getTrackState=function(opt_audioPlayerState){if(this._delegate)return this._delegate.getTrackState(opt_audioPlayerState);var promise=new Promise,audioPlayerState=opt_audioPlayerState||this._player.getPlayerState(),state={position:audioPlayerState.position,duration:audioPlayerState.duration,repeated:this._repeatMode==RepeatMode.TRACK,track:this._currentTrack||null};return promise.fulfill(state),promise},ContextPlayer.prototype.getContextState=function(){if(this._delegate)return this._delegate.getContextState();var promise=new Promise,contextList=this._loadedContextList,state={baseDescriptor:null,descriptorMap:[],listIndex:-1,rawIndex:-1,owner:null,shuffled:!1,infinite:!1,ruleset:null};if(this._playingFromIntercept)return state.ruleset=DefaultRulesets.INTERCEPT,promise.fulfill(state),promise;if(this._playingFromQueue){state.ruleset=DefaultRulesets.DEFAULT,state.owner="spotify:app:queue";var descriptor={type:"list",uri:"spotify:queue"};return state.baseDescriptor=descriptor,state.descriptorMap=[{descriptor:descriptor,index:-1}],promise.fulfill(state),promise}if(contextList){state.ruleset=this._loadedRuleset,state.owner=contextList.getOwner(),state.shuffled=contextList.isShuffled(),state.infinite=contextList.isInfinite();var index,rawIndex;return contextList.wasCurrentIndexRemoved()?(index=-1,rawIndex=-1):(index=contextList.getIndex(),rawIndex=contextList.getRawIndex()),this._getDescriptorMap(contextList,index).then(function(map){state.descriptorMap=map;for(var i=0,l=map.length;l>i;i++){var current=map[i];if(current&&"list"==current.descriptor.type){state.baseDescriptor=current.descriptor,state.listIndex=current.index,state.rawIndex=rawIndex;break}}return state})}return promise.fulfill(state),promise},ContextPlayer.prototype.setOverrideRules=function(rules){if(this._delegate)return this._delegate.setOverrideRules(rules);var promise=new Promise;return this._overrideRules=rules,promise.fulfill(OperationResult.SUCCESS),promise},ContextPlayer.prototype.removeOverrideRules=function(){if(this._delegate)return this._delegate.removeOverrideRules();var promise=new Promise;return this._overrideRules=null,promise.fulfill(OperationResult.SUCCESS),promise},ContextPlayer.prototype.setCrossfade=function(amount){if(this._delegate)return this._delegate.setCrossfade(amount);var promise=new Promise;return"number"!=typeof amount?(promise.fail(OperationResult.INVALID),promise):(1e3>amount?(this._crossfade=!1,this._crossfadeAmount=0,this._beforeEndBuffer=1e3):(this._crossfade=!0,this._crossfadeAmount=amount,this._beforeEndBuffer=amount+3e3),promise.fulfill(OperationResult.SUCCESS),promise)},ContextPlayer.prototype.setPreload=function(amount){return this._delegate?this._delegate.setPreload(amount):void(500>amount?(this._preload=!1,this._beforeEndBuffer=1e3):(this._preload=!0,this._beforeEndBuffer=amount))},ContextPlayer.prototype.setVolume=function(amount){if(this._delegate)return this._delegate.setVolume(amount);var promise=new Promise;return"number"!=typeof amount?(promise.fail(OperationResult.INVALID),promise):this._getRuleFor("volume")?(this._player.setVolume(amount),this._alternatePlayer.setVolume(amount),this.emit("volumeChange",{player:this,volume:amount}),promise.fulfill(OperationResult.SUCCESS),promise):(promise.fail(OperationResult.FORBIDDEN),promise)},ContextPlayer.prototype.setPlayerVolume=function(amount){if(this._delegate)return this._delegate.setPlayerVolume(amount);var promise=new Promise;return"number"!=typeof amount?(promise.fail(OperationResult.INVALID),promise):this._getRuleFor("volume")?(this._player.setVolume(amount),this.emit("internalVolumeChange",{player:this}),promise.fulfill(OperationResult.SUCCESS),promise):(promise.fail(OperationResult.FORBIDDEN),promise)},ContextPlayer.prototype.setShuffle=function(value){if(this._delegate)return this._delegate.setShuffle(value);var promise=new Promise;if(!this._getRuleFor("shuffle"))return promise.fail(OperationResult.FORBIDDEN),promise;var success=function(){this.emit("shuffleChanged",{player:this,shuffle:value}),promise.fulfill(OperationResult.SUCCESS)}.bind(this);if(this._shuffled!=value){this._shuffled=value;var contextList=this._loadedContextList;contextList?value?this.getPlaybackState().then(function(state){return contextList.shuffle(state.playing)}).then(success,success):contextList.unshuffle().then(success,success):success()}else promise.fulfill(OperationResult.SUCCESS);return promise},ContextPlayer.prototype.setRepeatMode=function(repeatMode){if(this._delegate)return this._delegate.setRepeatMode(repeatMode);var promise=new Promise;if(!this._getRuleFor("repeat"))return promise.fail(OperationResult.FORBIDDEN),promise;var success=function(){this.emit("repeatModeChanged",{player:this,repeatMode:repeatMode}),promise.fulfill(OperationResult.SUCCESS)}.bind(this);if(repeatMode!=RepeatMode.NONE&&repeatMode!=RepeatMode.CONTEXT&&repeatMode!=RepeatMode.TRACK&&(repeatMode=repeatMode?RepeatMode.CONTEXT:RepeatMode.NONE),this._repeatMode!=repeatMode){this._repeatMode=repeatMode;var contextList=this._loadedContextList;contextList?this._repeatMode==RepeatMode.CONTEXT?contextList.makeInfinite().then(success,success):contextList.makeFinite().then(success,success):success()}else promise.fulfill(OperationResult.SUCCESS);return promise},ContextPlayer.prototype.switchRepeatMode=function(){if(this._delegate)return this._delegate.switchRepeatMode();switch(this._repeatMode){case RepeatMode.NONE:return this.setRepeatMode(RepeatMode.CONTEXT);case RepeatMode.CONTEXT:return this.setRepeatMode(RepeatMode.TRACK);case RepeatMode.TRACK:return this.setRepeatMode(RepeatMode.NONE)}},ContextPlayer.prototype.seek=function(amount){if(this._delegate)return this._delegate.seek(amount);var promise=new Promise;return this._getRuleFor("seek")?("number"!=typeof amount?promise.fail(OperationResult.INVALID):this._loadedContextList?(this._player.seek(amount),promise.fulfill(OperationResult.SUCCESS)):promise.fail(OperationResult.NO_CONTEXT),promise):(promise.fail(OperationResult.FORBIDDEN),promise)},ContextPlayer.prototype.togglePlay=function(){if(this._delegate)return this._delegate.togglePlay();var promise=new Promise;return this._getRuleFor("playpause")?this._loadedContextList?(this._player.togglePlay(),promise.fulfill(OperationResult.SUCCESS)):promise.fail(OperationResult.NO_CONTEXT):promise.fail(OperationResult.FORBIDDEN),promise},ContextPlayer.prototype.resume=function(){if(this._delegate)return this._delegate.resume();var promise=new Promise;return this._getRuleFor("playpause")?this._loadedContextList?(this._player.resume(),promise.fulfill(OperationResult.SUCCESS)):promise.fail(OperationResult.NO_CONTEXT):promise.fail(OperationResult.FORBIDDEN),promise},ContextPlayer.prototype.pause=function(){if(this._delegate)return this._delegate.pause();var promise=new Promise;return this._getRuleFor("playpause")?this._loadedContextList?(this._player.pause(),promise.fulfill(OperationResult.SUCCESS)):promise.fail(OperationResult.NO_CONTEXT):promise.fail(OperationResult.FORBIDDEN),promise},ContextPlayer.prototype.stop=function(){if(this._delegate)return this._delegate.stop();var promise=new Promise;return this._stopped=!0,this._player.stop(),this.emit("stop",{player:this,context:this._loadedContextList,options:this._loadedPlaybackOptions,reason:"stopped"}),promise.fulfill(OperationResult.SUCCESS),promise},ContextPlayer.prototype._setContextIndex=function(contextList,options,length){if(0==length){var promise=new Promise;return promise.fail(OperationResult.EMPTY),promise}var index=options.index&&-1!=options.index?options.index:0;return Promise.join(contextList,options,contextList.startAt(index))},ContextPlayer.prototype._loadContext=function(contextList,options){var promises=[],rules=options.rules;return this._shuffled&&rules.shuffle?promises.push(contextList.shuffle()):promises.push(contextList.unshuffle()),this._repeatMode==RepeatMode.CONTEXT&&rules.repeat?promises.push(contextList.makeInfinite()):promises.push(contextList.makeFinite()),Promise.join(promises).then(function(){return this.emitSync("beforeContextChange",{player:this,newContext:contextList,newOptions:options,oldContext:this._loadedContextList,oldOptions:this._loadedPlaybackOptions}),this._loadedContextList&&this._loadedContextList.unobserve&&this._loadedContextList.unobserve(this._contextObserver),this._loadedContextList=contextList,this._loadedPlaybackOptions=options,this._loadedRuleset=options.rules,contextList.observe&&contextList.observe(this._contextObserver),this._listPlayCount=0,this.emit("contextChange",{player:this,context:contextList,options:options}),OperationResult.SUCCESS}.bind(this))},ContextPlayer.prototype.load=function(contextList,opt_options){if(this._delegate)return this._delegate.load(contextList,opt_options);var userOptions=opt_options||this._loadedPlaybackOptions||{},options=new MergedPlaybackOptions(userOptions);return this._stopped=!1,Promise.join(contextList,options,contextList.getLength).thenSpread(this._setContextIndex).thenSpread(this._loadContext)},ContextPlayer.prototype.play=function(contextList,options){if(this._delegate)return this._delegate.play(contextList,options);return this.load(contextList,options).then(this.next.bind(this,options.reason))},ContextPlayer.prototype.clear=function(){if(this._delegate)return this._delegate.clear();var promise=new Promise;return this.stop(),this._currentTrack=null,this._loadedContextList=null,this._loadedPlaybackOptions=null,this.emit("clear",{player:this}),promise.fulfill(OperationResult.SUCCESS),promise},ContextPlayer.prototype.next=function(reason,skipQueue){if(this._delegate)return this._delegate.next(reason,skipQueue);var promise=new Promise;if(!this._getRuleFor("next"))return this._playingFromIntercept&&this.resume(),promise.fail(OperationResult.FORBIDDEN),promise;var self=this;if(!this._loadedContextList)return promise.fail(OperationResult.NO_CONTEXT),promise;if(!reason)return promise.fail(OperationResult.INVALID),promise;var event=this.emitSync("beforeNext",{player:this,context:this._loadedContextList,reason:reason});if(event.isDefaultPrevented())return promise.fail(OperationResult.CANCELLED),promise;var listConstants=this._listConstants;return this._interceptContextList.pop().then(function(item){return item!=listConstants.NULL_VALUE?(self._playPreviousAfterIntercept=!1,self._playingFromIntercept=!0,item):(self._playingFromIntercept=!1,skipQueue?listConstants.NULL_VALUE:self._queueContextList.pop())}).then(function(item){if(self._playingFromIntercept)return self._playingFromQueue=!1,item;if(item!=listConstants.NULL_VALUE)return self._playingFromQueue=!0,item;self._playingFromQueue=!1;var currentTrack=self._currentTrack;return currentTrack&&!currentTrack.advertisement&&self._repeatMode==RepeatMode.TRACK&&self._listPlayCount?currentTrack:self._loadedContextList.next()}).then(function(track){if(track==listConstants.LIST_END)return this.emit("contextEnd",{player:this,context:this._loadedContextList,options:this._loadedPlaybackOptions,reason:Reason.END_PLAY}),this.clear(),OperationResult.CONTEXT_END;if(!track.playable)return self.next(reason,skipQueue);this.emit("beforeNextTrack",{player:this,context:this._loadedContextList,newTrack:track,oldTrack:this._currentTrack,options:this._loadedPlaybackOptions,reason:reason});var result=this._playTrack(track,reason);return this.emit("nextTrack",{player:this,track:track,reason:reason}),result}.bind(this))},ContextPlayer.prototype.previous=function(reason){if(this._delegate)return this._delegate.previous(reason);var promise=new Promise;if(!this._getRuleFor("previous"))return promise.fail(OperationResult.FORBIDDEN),promise;var self=this;if(!this._loadedContextList)return promise.fail(OperationResult.NO_CONTEXT),promise;if(!reason)return promise.fail(OperationResult.INVALID),promise;var event=this.emitSync("beforePrevious",{player:this,context:this._loadedContextList,reason:reason});if(event.isDefaultPrevented())return promise.fail(OperationResult.CANCELLED),promise;var listConstants=this._listConstants;return this._interceptContextList.pop().then(function(item){return item!=listConstants.NULL_VALUE?(self._playPreviousAfterIntercept=!0,self._playingFromIntercept=!0,item):(self._playPreviousAfterIntercept=!1,self._playingFromIntercept=!1,self._repeatMode==RepeatMode.TRACK&&self._listPlayCount?self._currentTrack:self._loadedContextList.previous())}).then(function(track){if(track==listConstants.LIST_START)return this.emit("contextEnd",{player:this,context:this._loadedContextList,options:this._loadedPlaybackOptions,reason:Reason.END_PLAY}),this.clear(),OperationResult.CONTEXT_END;this.emit("beforePreviousTrack",{player:this,newTrack:track,oldTrack:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions,reason:reason});var result=this._playTrack(track,reason);return this.emit("previousTrack",{player:this,track:track,reason:reason}),result}.bind(this))},ContextPlayer.prototype._playTrack=function(track,reason){if(this._stopped)return OperationResult.SUCCESS;var options=this._loadedPlaybackOptions;return this.emitSync("beforePlay",{player:this,context:this._loadedContextList,options:options,track:track,reason:reason}),this._playingFromIntercept?this.emit("playIntercepted",{player:this,context:this._interceptContextList,options:options,track:track,reason:reason}):this._playingFromQueue&&this.emit("playQueued",{player:this,context:this._queueContextList,options:options,track:track,reason:reason}),this._uid++,this._listPlayCount++,this._fakePlayingState=1==this._listPlayCount?!options.pause:!0,this._currentTrack=track,this._previousPlayToken?(clearTimeout(this._previousPlayToken),this._previousPlayToken=setTimeout(this._loadTrack.bind(this,track,!0),FAST_SWITCHING_THRESHOLD)):(this._previousPlayToken=1,this._loadTrack(track,!1)),OperationResult.SUCCESS},ContextPlayer.prototype._loadTrack=function(track,clearPrevious){if(clearPrevious&&(this._previousPlayToken=null),!this._stopped){var player=this._player,alternate=this._alternatePlayer,options=this._loadedPlaybackOptions,autoPlay=!0,offset=0;1==this._listPlayCount?(autoPlay=!options.pause,offset=options.initialOffset||options.offset||0):offset=options.offset||0;var duration=-1;!isNaN(options.duration)&&options.duration>0&&(duration=offset+options.duration);var playerToLoad=null,callback=null;player.getPlayerState().isPlaying&&(this._crossfade||this._preload)?(playerToLoad=alternate,callback=this._alternateLoaded.bind(this,player,alternate,autoPlay)):(playerToLoad=player,callback=this._playerLoaded.bind(this,player,alternate,autoPlay)),this._timeoutToken&&clearTimeout(this._timeoutToken),this._timeoutToken=setTimeout(this._handleTimeout,this._timeoutAmount),playerToLoad.load(track,{uriProperty:this._uriProperty,autoplay:autoPlay,position:offset,duration:duration,endTimeAmount:this._beforeEndBuffer},callback)}},ContextPlayer.prototype._playerLoaded=function(player,alternate,play){this.emitSync("trackLoaded",{player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions,play:play,mainPlayer:player,alternatePlayer:alternate})},ContextPlayer.prototype._alternateLoaded=function(player,alternate,play){this.emitSync("trackLoaded",{player:this,track:this._currentTrack,context:this._loadedContextList,options:this._loadedPlaybackOptions,play:play,mainPlayer:alternate,alternatePlayer:player}),this._stopped||(this._crossfading=!0,this.emitSync("crossfadeStart",{player:this,mainPlayer:player,alternatePlayer:alternate}),this._trackPlayerManager.crossfade(player.getId(),alternate.getId(),this._crossfadeAmount,function(){this._crossfading=!1,this.emitSync("crossfadeEnd",{player:this,mainPlayer:player,alternatePlayer:alternate}),this._stopped||(player.pause(),alternate.setVolume(1),this._alternatePlayer=player,this._player=alternate)}.bind(this)))},ContextPlayer.prototype.setRepeat=function(value){var promise=new Promise;if(!this._getRuleFor("repeat"))return promise.fail(OperationResult.FORBIDDEN),promise;(function(){this.emit("repeatedChange",{player:this,repeat:value}),promise.fulfill(OperationResult.SUCCESS)}).bind(this);return this._repeated!=value?this._repeated=value:promise.fulfill(OperationResult.SUCCESS),promise},ContextPlayer.prototype.setRepeatTrack=function(value){var promise=new Promise;return this._getRuleFor("repeatTrack")?(this._trackRepeated!=value&&(this._trackRepeated=value,this.emit("repeatTrackChanged",{player:this,repeatTrack:value})),promise.fulfill(OperationResult.SUCCESS),promise):(promise.fail(OperationResult.FORBIDDEN),promise)},ContextPlayer.prototype.getBaseState=function(){var promise=new Promise,player=this._player,playerState=player.getPlayerState(),contextList=this._loadedContextList,track=this._currentTrack,state={__uid:this._uid,__owner:contextList?contextList.getOwner():null,playing:this._fakePlayingState?!0:playerState.playing,index:null,track:track||null,context:null,position:playerState.position,duration:playerState.duration,repeat:this._repeated,shuffle:this._shuffled,volume:playerState.volume};return contextList?(contextList.wasCurrentIndexRemoved&&contextList.wasCurrentIndexRemoved()?state.__index=-1:state.__index=contextList.getIndex(),this._playingFromIntercept?state.__rules=DefaultRulesets.INTERCEPT:state.__rules=this._loadedRuleset):(state.__index=null,state.__rules={}),promise.fulfill(state),promise},ContextPlayer.prototype.getState=function(){return this._playingFromIntercept?this.getBaseState().then(function(state){return state.context=null,state.contexts=[],state.index=-1,state}):this._playingFromQueue?this.getBaseState().then(function(state){return state.__owner="spotify:app:queue",state.context={uri:"spotify:queue"},state.contexts=[],state.index=-1,state}):Promise.join(this.getBaseState(),this.getDescriptorMap()).thenSpread(function(state,map){state.contexts=map;for(var i=0,l=map.length;l>i;i++){var current=map[i];if("list"==current.descriptor.type){state.context={uri:current.descriptor.uri.toString()},state.index=current.index;break}}return state})},ContextPlayer.prototype.setContextList=function(contextList,opt_options){return this.load(contextList,opt_options)},module.exports=ContextPlayer},{"./types":126,"spotify-eventemitter":128,"spotify-inheritance/extend":129,"spotify-inheritance/inherit":131,"spotify-promise":133}],125:[function(require,module,exports){function ContextPlayerGroup(trackPlayerManager,queueCreator,descriptorMapper,listConstants){return this instanceof ContextPlayerGroup?(this._trackPlayerManager=trackPlayerManager,this._createQueueList=queueCreator,this._descriptorMapper=descriptorMapper,this._listConstants=listConstants,this._stack=[],this._players={},this._loggers={},this._log=!0,this._onTrackLoaded=this._onTrackLoaded.bind(this),this._onPlayerPlay=this._onPlayerPlay.bind(this),void(this._onContextStop=this._onContextStop.bind(this))):new ContextPlayerGroup(trackPlayerManager,queueCreator,descriptorMapper,listConstants)}var ContextPlayer=require("./player"),ContextPlayerLogger=require("./logger");ContextPlayerGroup.prototype.disableLogging=function(){return this._log=!1,this},ContextPlayerGroup.prototype.enableLogging=function(){return this._log=!0,this},ContextPlayerGroup.prototype.create=function(id,opt_uriProperty){var players=this._players;if(players[id])throw new TypeError('A player with the id "'+id+'" already exists.');var player=new ContextPlayer({trackPlayerManager:this._trackPlayerManager,id:id,interceptList:this._createQueueList("intercept"),queueList:this._createQueueList("queue"),descriptorMapper:this._descriptorMapper,listConstants:this._listConstants,uriProperty:opt_uriProperty});return player.addListeners({trackLoaded:this._onTrackLoaded,play:this._onPlayerPlay,contextEnd:this._onContextStop,stop:this._onContextStop}),players[id]=player,this._log&&(this._loggers[id]=new ContextPlayerLogger(this._trackPlayerManager,player)),player},ContextPlayerGroup.prototype.get=function(id){return this._players[id]||null},ContextPlayerGroup.prototype._onTrackLoaded=function(event){var player=event.player,stack=this._stack;if(!stack.length)return this;var current=stack[0];if(current.player==player)return this;var trackPlayerManager=this._trackPlayerManager;current.player.getPlaybackState().then(function(state){current.state=state,trackPlayerManager.crossfade(current.player.getPlayerId(),player.getPlayerId(),800,function(){current.player.pause(),player.setVolume(state.volume)})})},ContextPlayerGroup.prototype._onPlayerPlay=function(event){var player=event.player,stack=this._stack;if(stack.length){var current=stack[0];if(current.player==player)return}stack.unshift({player:player,state:{}})},ContextPlayerGroup.prototype._onContextStop=function(event){var stack=this._stack,previous=stack.shift();if(stack.length){var current=stack[0];current.state.playing?(current.player.resume(),this._trackPlayerManager.crossfade(previous.player.getPlayerId(),current.player.getPlayerId(),800,function(){current.player.setVolume(current.state.volume)})):current.player.setVolume(current.state.volume)}},module.exports=ContextPlayerGroup},{"./logger":121,"./player":124}],126:[function(require,module,exports){"use strict";function Ruleset(overrides){return this instanceof Ruleset?overrides instanceof Ruleset?overrides:(overrides=overrides||{},this.skipCount="skipCount"in overrides?overrides.skipCount:-1,this.volume="volume"in overrides?overrides.volume:!0,this.seek="seek"in overrides?overrides.seek:!0,this.indexing="indexing"in overrides?overrides.indexing:!0,this.previous="previous"in overrides?overrides.previous:!0,this.playpause="playpause"in overrides?overrides.playpause:!0,this.next="next"in overrides?overrides.next:!0,this.shuffle="shuffle"in overrides?overrides.shuffle:!0,this.repeat="repeat"in overrides?overrides.repeat:!0,this.repeatTrack="repeatTrack"in overrides?overrides.repeatTrack:!0,void(Object.freeze&&Object.freeze(this))):new Ruleset(overrides)}function ContextList(){throw new TypeError("ContextList is an interface")}function QueueContextList(){throw new TypeError("QueueContextList is an interface")}function TrackPlayerManager(){}function TrackPlayer(){}function TrackPlayerLogger(){}function ContextPlayerDelegate(){}exports.NullValueConstant,exports.ListStartConstant,exports.ListEndConstant,exports.ListConstants,exports.OperationResult={CANCELLED:"cancelled",CONTEXT_END:"contextEnd",EMPTY:"empty",FORBIDDEN:"forbidden",INVALID:"invalid",NO_CONTEXT:"no-context",SUCCESS:"success"},Object.freeze&&Object.freeze(exports.OperationResult),exports.RepeatMode={NONE:"none",CONTEXT:"context",TRACK:"track"},Object.freeze&&Object.freeze(exports.RepeatMode),exports.RulesetOverrides,exports.Ruleset=Ruleset,exports.DefaultRulesets={DEFAULT:new Ruleset,INTERCEPT:new Ruleset({volume:!1,seek:!1,previous:!1,next:!1,shuffle:!1,repeat:!1,repeatTrack:!1}),RADIO:new Ruleset({indexing:!1,previous:!1,shuffle:!1,repeat:!1,repeatTrack:!1}),DMCA:new Ruleset({skipCount:6,indexing:!1,previous:!1,shuffle:!1,repeat:!1,repeatTrack:!1}),STREAM:new Ruleset({seek:!1,indexing:!1,previous:!1,next:!1,shuffle:!1,repeat:!1,repeatTrack:!1})},Object.freeze&&Object.freeze(exports.DefaultRulesets),exports.QueueCreator,exports.DescriptorMapper,exports.ContextListObserver,exports.ContextList=ContextList,ContextList.prototype.observe=function(observer){},ContextList.prototype.wasCurrentIndexRemoved=function(){},ContextList.prototype.getDescriptor=function(){},ContextList.prototype.getLength=function(){},ContextList.prototype.getOwner=function(){},ContextList.prototype.getIndex=function(){},ContextList.prototype.getRawIndex=function(){},ContextList.prototype.startAt=function(index){},ContextList.prototype.shuffle=function(skipFirst){},ContextList.prototype.isShuffled=function(){},ContextList.prototype.unshuffle=function(){},ContextList.prototype.makeInfinite=function(){},ContextList.prototype.isInfinite=function(){},ContextList.prototype.makeFinite=function(){},ContextList.prototype.next=function(){},ContextList.prototype.previous=function(){},ContextList.prototype.toArray=function(opt_index,opt_length){},QueueContextList.prototype.pop=function(){},exports.Reason={APPLOAD:"appload",BACK_BUTTON:"backbtn",CLICK_ROW:"clickrow",CLICK_SIDE:"clickside",END_PLAY:"endplay",FORWARD_BUTTON:"fwdbtn",LOGOUT:"logout",PLAY_BUTTON:"playbtn",POPUP:"popup",REMOTE:"remote",TRACK_DONE:"trackdone",TRACK_ERROR:"trackerror",UNKNOWN:"unknown",URI_OPEN:"uriopen"},exports.ContextPlaybackOptions,exports.Track,exports.TrackPlayerManager=TrackPlayerManager,TrackPlayerManager.prototype.createPlayer=function(id){},TrackPlayerManager.prototype.crossfade=function(fromId,toId,time,cb){},TrackPlayerManager.prototype.getPlayerLogger=function(playerId){},exports.TrackPlayerState,exports.TrackPlayerLoadOptions,exports.TrackPlayerErrorReason={REQUEST_CAP:"requestCap",PLAY_CAP:"playCap",TRACK_CAP:"trackCap",UNKNOWN:"unknown"},exports.TrackPlayer=TrackPlayer,TrackPlayer.prototype.addListener=function(type,listener){},TrackPlayer.prototype.removeListener=function(type,listener){},TrackPlayer.prototype.getId=function(){},TrackPlayer.prototype.getPlayerState=function(){},TrackPlayer.prototype.setVolume=function(amount){},TrackPlayer.prototype.seek=function(position){},TrackPlayer.prototype.togglePlay=function(){},TrackPlayer.prototype.resume=function(){},TrackPlayer.prototype.pause=function(){},TrackPlayer.prototype.stop=function(){},TrackPlayer.prototype.load=function(track,options,callback){},exports.EndSongStartLog,exports.EndSongStopLog,TrackPlayerLogger.prototype.setEndSongStartLog=function(log){},TrackPlayerLogger.setEndSongStopLog=function(log){},ContextPlayerDelegate.prototype.getInternalState=function(){},ContextPlayerDelegate.prototype.getPlayerId=function(){},ContextPlayerDelegate.prototype.getInterceptList=function(){},ContextPlayerDelegate.prototype.isPlayingFromIntercept=function(){},ContextPlayerDelegate.prototype.getQueueList=function(){},ContextPlayerDelegate.prototype.isPlayingFromQueue=function(){},ContextPlayerDelegate.prototype.getContextList=function(){},ContextPlayerDelegate.prototype.getCurrentTrack=function(){},ContextPlayerDelegate.prototype.getDescriptorMap=function(){},ContextPlayerDelegate.prototype.isCrossfading=function(){},ContextPlayerDelegate.prototype.getPlayerState=function(){},ContextPlayerDelegate.prototype.getPlaybackState=function(){},ContextPlayerDelegate.prototype.getTrackState=function(){},ContextPlayerDelegate.prototype.getContextState=function(){},ContextPlayerDelegate.prototype.setOverrideRules=function(){},ContextPlayerDelegate.prototype.removeOverrideRules=function(){},ContextPlayerDelegate.prototype.setCrossfade=function(){},ContextPlayerDelegate.prototype.setPreload=function(){},ContextPlayerDelegate.prototype.setVolume=function(){},ContextPlayerDelegate.prototype.setPlayerVolume=function(){},ContextPlayerDelegate.prototype.setShuffle=function(){},ContextPlayerDelegate.prototype.setRepeatMode=function(){},ContextPlayerDelegate.prototype.switchRepeatMode=function(){},ContextPlayerDelegate.prototype.seek=function(){},ContextPlayerDelegate.prototype.resume=function(){},ContextPlayerDelegate.prototype.pause=function(){},ContextPlayerDelegate.prototype.stop=function(){},ContextPlayerDelegate.prototype.togglePlay=function(){},ContextPlayerDelegate.prototype.load=function(){},ContextPlayerDelegate.prototype.play=function(){},ContextPlayerDelegate.prototype.clear=function(){},ContextPlayerDelegate.prototype.next=function(){},ContextPlayerDelegate.prototype.previous=function(){}},{}],127:[function(require,module,exports){module.exports=require(10)},{"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/spotify-deferred/src/deferred.js":10}],128:[function(require,module,exports){"use strict";function Event(type,props){if(this.type=type,this._prevented=!1,this._stopped=!1,this._immediateStopped=!1,props)for(var key in props)"type"!=key&&(this[key]=props[key])}function EventEmitter(){this._listenerMap}var _defer=require("spotify-deferred");Event.prototype.preventDefault=function(){this._prevented=!0},Event.prototype.isDefaultPrevented=function(){return this._prevented},Event.prototype.stopPropagation=function(){this._stopped=!0},Event.prototype.isPropagationStopped=function(){return this._stopped},Event.prototype.stopImmediatePropagation=function(){this._immediateStopped=!0},Event.prototype.isImmediatePropagationStopped=function(){return this._immediateStopped},EventEmitter.createEvent=function(type,opt_params){return new Event(type,opt_params)},EventEmitter.prototype.addListener=function(type,listener){var _listenerMap=this._listenerMap||(this._listenerMap={}),listeners=_listenerMap[type]||(_listenerMap[type]=[]);return-1!=listeners.indexOf(listener)?this:(listeners.push(listener),this)},EventEmitter.prototype.addListeners=function(eventListeners){for(var type in eventListeners)this.addListener(type,eventListeners[type]);return this},EventEmitter.prototype.addOnceListener=function(type,listener){var wrapper=function(){return this.removeListener(type,wrapper),listener.apply(this,arguments)};return this.addListener(type,wrapper),wrapper},EventEmitter.prototype.removeListener=function(type,listener){var _listenerMap=this._listenerMap,listeners=_listenerMap&&_listenerMap[type];if(!listeners)return this;var index=listeners.indexOf(listener);return-1==index?this:(listeners.splice(index,1),listeners.length||(_listenerMap[type]=null),this)},EventEmitter.prototype.removeAllListeners=function(type){var _listenerMap=this._listenerMap;return _listenerMap?(_listenerMap[type]=null,this):this},EventEmitter.prototype.removeListeners=function(eventListeners){for(var type in eventListeners)this.removeListener(type,eventListeners[type]);return this},EventEmitter.prototype.emit=function(type,opt_params){var event=new Event(type,opt_params);return _defer(function(){this.emitEventSync(event)}.bind(this)),
event},EventEmitter.prototype.emitEvent=function(event){return _defer(function(){this.emitEventSync(event)}.bind(this)),event},EventEmitter.prototype.emitSync=function(type,opt_params){var event=new Event(type,opt_params);return this.emitEventSync(event),event},EventEmitter.prototype.emitEventSync=function(event){var type=event.type,_listenerMap=this._listenerMap,listeners=_listenerMap&&_listenerMap[type];if(!listeners||!listeners.length)return event;listeners=listeners.slice(0);for(var i=0,l=listeners.length;l>i&&(listeners[i].call(this,event),!event.isImmediatePropagationStopped());i++);return event},EventEmitter.prototype.addEvent=function(type,listener){return this.addListener(type,listener)},EventEmitter.prototype.addEvents=function(eventListeners){return this.addListeners(eventListeners)},EventEmitter.prototype.addOnceEvent=function(type,listener){return this.addOnceListener(type,listener)},EventEmitter.prototype.removeEvent=function(type,listener){return this.removeListener(type,listener)},EventEmitter.prototype.removeEvents=function(eventListeners){return this.removeListeners(eventListeners)},EventEmitter.prototype.fireEvent=function(type,opt_args,opt_priority){if(opt_priority)this.fireEventSync(type,opt_args);else{var self=this;_defer(function(){self.fireEventSync(type,opt_args)})}return this},EventEmitter.prototype.fireEventSync=function(type,opt_args){var self=this,events=this._listenerMap&&this._listenerMap[type];if(!events||!events.length)return this;events=events.slice(0);var i,l;if(opt_args)for(Array.isArray(opt_args)||(opt_args=[opt_args]),i=0,l=events.length;l>i;i++)events[i].apply(self,opt_args);else for(i=0,l=events.length;l>i;i++)events[i].call(self);return this},EventEmitter.prototype.on=function(type,listener){return this.addEvent(type,listener)},EventEmitter.prototype.once=function(type,listener){return this.addOnceEvent(type,listener)},EventEmitter.prototype.off=function(type,opt_listener){return"function"==typeof opt_listener?this.removeEvent(type,opt_listener):(this._listenerMap[type]=null,this)},module.exports=EventEmitter},{"spotify-deferred":127}],129:[function(require,module,exports){module.exports=require(2)},{"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/cosmos-common-js/node_modules/spotify-inheritance/extend.js":2}],130:[function(require,module,exports){module.exports=require(3)},{"./extend":129,"./inherit":131,"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/cosmos-common-js/node_modules/spotify-inheritance/index.js":3}],131:[function(require,module,exports){module.exports=require(4)},{"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/cosmos-common-js/node_modules/spotify-inheritance/inherit.js":4}],132:[function(require,module,exports){module.exports=require(10)},{"/Users/felipe/src/shuttle/node_modules/cosmos-router-js/node_modules/spotify-deferred/src/deferred.js":10}],133:[function(require,module,exports){"use strict";function pipe(promiseA,promiseB){promiseA.then(function(object){promiseB.fulfill(object)},function(error){promiseB.fail(error)})}function Promise(){this._state=states.UNFULFILLED,this._value=null,this._handlers=[],this._deferred=!1}var slice=Array.prototype.slice,defer=require("spotify-deferred"),states={UNFULFILLED:0,FULFILLED:1,FAILED:2};Promise.defer="function"==typeof setImmediate?function(fn){setImmediate(fn)}:defer,Promise.prototype.isUnfulfilled=function(){return this._state==states.UNFULFILLED},Promise.prototype.isFulfilled=function(){return this._state==states.FULFILLED},Promise.prototype.isFailed=function(){return this._state==states.FAILED},Promise.prototype.fulfill=function(value){var self=this;this._state===states.UNFULFILLED&&(this._value=value,this._state=states.FULFILLED,this._deferred||(Promise.defer(function(){self._runHandlers()}),this._deferred=!0))},Promise.prototype.fail=function(error){var self=this;this._state===states.UNFULFILLED&&(this._value=error,this._state=states.FAILED,this._deferred||(Promise.defer(function(){self._runHandlers()}),this._deferred=!0))},Promise.prototype.then=function(fulfilledHandler,failedHandler){var self=this,promise=new Promise;return this._handlers.push({fulfilled:fulfilledHandler,failed:failedHandler,promise:promise}),this._state===states.UNFULFILLED||this._deferred||(Promise.defer(function(){self._runHandlers()}),this._deferred=!0),promise},Promise.prototype.pipe=function(promise){this.then(function(value){promise.fulfill(value)},function(error){promise.fail(error)})},Promise.prototype._runHandlers=function(){this._deferred=!1;var value=this._value;if(this._state!=states.UNFULFILLED)for(var fulfilled=this._state===states.FULFILLED,handlers=this._handlers.splice(0),callbackType=fulfilled?"fulfilled":"failed",i=0,l=handlers.length;l>i;i++){var handler=handlers[i],callback=handler[callbackType],promise=handler.promise;if(callback&&"function"==typeof callback){try{var returnValue=callback(value)}catch(e){promise.fail(e);continue}returnValue&&"function"==typeof returnValue.then?pipe(returnValue,promise):promise.fulfill(returnValue)}else{if(value&&"function"==typeof value.then){pipe(value,promise);continue}fulfilled?promise.fulfill(value):promise.fail(value)}}},Promise.prototype.catchError=function(failedHandler){return this.then(null,failedHandler)},Promise.prototype.get=function(property){var promise=new Promise;return this.then(function(object){property in object?promise.fulfill(object[property]):promise.fail(new TypeError('No property "'+property+'" in object.'))},function(error){promise.fail(error)}),promise},Promise.prototype.access=function(var_args){var_args=Array.isArray(var_args)?var_args:slice.call(arguments);for(var promise=this,i=0,l=var_args.length;l>i;i++)promise=promise.get(var_args[i]);return promise},Promise.prototype.call=function(method,var_args){var args=slice.call(arguments,1),promise=new Promise;return this.then(function(object){try{promise.fulfill(object[method].apply(object,args))}catch(e){promise.fail(e)}},function(error){promise.fail(error)}),promise},Promise.prototype.thenSpread=function(fulfilledHandler,failedHandler){return this.then(function(value){return Array.isArray(value)?fulfilledHandler.apply(this,value):fulfilledHandler.call(this,value)},failedHandler)},Promise.join=function(promises){promises=Array.isArray(promises)?promises:slice.call(arguments);for(var promise=new Promise,length=promises.length,result=[],failed=!1,aggregator=function(index,obj){failed||(result[index]=obj,length--,length||promise.fulfill(result))},failure=function(error){failed||(failed=!0,promise.fail(error))},i=0,l=length;l>i;i++){var p=promises[i];p&&p.then?p.then(aggregator.bind(null,i),failure):aggregator(i,p)}return promise},Promise.group=function(promises){promises=Array.isArray(promises)?promises:slice.call(arguments);for(var promise=new Promise,i=0,l=promises.length;l>i;i++)promise.pipe(promises[i]);return promise},module.exports=Promise},{"spotify-deferred":132}],134:[function(require,module,exports){"use strict";function WeakMap(){this._keys=[],this._values=[]}WeakMap.prototype.get=function(key){var index=this._keys.indexOf(key);return-1==index?null:this._values[index]},WeakMap.prototype.getKey=function(value){var index=this._values.indexOf(value);return-1==index?null:this._keys[index]},WeakMap.prototype.has=function(key){return-1!==this._keys.indexOf(key)},WeakMap.prototype.set=function(key,value){var keys=this._keys,values=this._values,index=keys.indexOf(key);return-1!=index?(values[index]=value,this):(keys.push(key),values.push(value),this)},WeakMap.prototype.remove=function(key){var keys=this._keys,values=this._values,index=keys.indexOf(key);return-1==index?this:(keys.splice(index,1),values.splice(index,1),this)},WeakMap.prototype.clear=function(){return this._keys.splice(0,this._keys.length),this._values.splice(0,this._values.length),this},module.exports=WeakMap},{}],135:[function(require,module,exports){function Application(frame,link,dispatcher){return this instanceof Application?(EventEmitter.call(this),this._frame=frame,this._id=link.id,this._uri=link,this._uriApp=Link.applicationLink(link.id),this._uriString=link.toURI(),this._args=Application.formatArgs(this._id,link.args.slice(0)),this._dispatcher=dispatcher,void(this._data={})):new Application(frame,link,dispatcher)}function ApplicationManager(dispatcher){EventEmitter.call(this),this._dispatcher=dispatcher,this._apps=new WeakMap,this._windows=new WeakMap,this._multiInstance={}}var Link=Spotify.Link,inherit=require("spotify-inheritance/inherit"),EventEmitter=require("spotify-eventemitter"),WeakMap=require("spotify-weakmap");inherit(Application,EventEmitter),exports.Application=Application,Application.formatArgs=function(id,args){if("user"==id||"playlist"==id)switch(args[1]){case"playlist":args=[args[0],args[2]];break;case"starred":args=[args[0],"starred"];break;case"toplist":args=[args[0],"toplist"];break;case"top":args=[args[0],"top",args[2]]}for(var len=args.length;len--;)args[len]=encodeURIComponent(args[len]);return args},Application.prototype.setInfo=function(link){this._id=link.id,this._uri=link,this._uriApp=Link.applicationLink(link.id),this._uriString=link.toURI()},Application.prototype.getFrame=function(){return this._frame},Application.prototype.getId=function(){return this._id},Application.prototype.getURI=function(){return this._uriString},Application.prototype.getLink=function(){return this._uri},Application.prototype.getAppLink=function(){return this._uriApp},Application.prototype.setArgs=function(args){var previousArgs=this._args,newArgs=this._args=Application.formatArgs(this._id,args.slice(0)),len=newArgs.length;if(len!=previousArgs.length)return void this.emitSync("argumentsChange",{arguments:this.getArgsDecoded()});for(;len--;)if(newArgs[len]!=previousArgs[len])return void this.emitSync("argumentsChange",{arguments:this.getArgsDecoded()})},Application.prototype.getArgs=function(){return this._args},Application.prototype.getArgsDecoded=function(){var args=this._args;if(!args.length)return[];for(var len=args.length,result=new Array(result);len--;)result[len]=decodeURIComponent(args[len]);return result},Application.prototype.getData=function(key){var data=this._data;return key in data?data[key]:null},Application.prototype.setData=function(key,value){return this._data[key]=value,this},Application.prototype.activate=function(){this._active||(this._active=!0,this.emitSync("activate"))},Application.prototype.deactivate=function(){this._active&&(this._active=!1,this.emitSync("deactivate"))},Application.prototype.destroy=function(){this.emitSync("destroy"),this._frame=null,this._data=null},Application.prototype.request=function(method,path,headers,body){return headers?headers.origin=this._uriString:headers={origin:this._uriString},this._dispatcher.request(method,path,headers,body)},Application.prototype.create=function(path,headers,body){return this.request("CREATE",path,headers,body)},Application.prototype.flush=function(path,headers,body){return this.request("FLUSH",path,headers,body)},Application.prototype.get=function(path,headers,body){return this.request("GET",path,headers,body)},Application.prototype.remove=function(path,headers,body){return this.request("REMOVE",path,headers,body)},Application.prototype.update=function(path,headers,body){return this.request("UPDATE",path,headers,body)},inherit(ApplicationManager,EventEmitter),exports.ApplicationManager=ApplicationManager,ApplicationManager.prototype.setMultiInstance=function(id){this._multiInstance[id]=!0},ApplicationManager.prototype.unsetMultiInstance=function(id){this._multiInstance[id]=null},ApplicationManager.prototype.create=function(link,frame){if(frame.contentWindow)this._windows.set(frame.contentWindow,frame);else{var self=this,loader=function(){self._windows.set(frame.contentWindow,frame),self.emit("windowAssociated",{frame:frame,window:frame.contentWindow}),this.removeEventListener("load",loader,!1)};frame.addEventListener("load",loader,!1)}var id=link.id,app=this._apps.get(frame);return!this._multiInstance[id]&&app?(app.setInfo(link),app.setArgs(link.args),this.emitSync("update",{link:link,app:app})):(app=new Application(frame,link,this._dispatcher),this._apps.set(frame,app),this.emitSync("create",{link:link,app:app})),app},ApplicationManager.prototype.createDecoy=function(link,frame){return new Application(frame,link,this._dispatcher)},ApplicationManager.prototype.destroy=function(frame){var apps=this._apps,app=this._apps.get(frame);this.deactivate(frame),app.destroy(),apps.remove(frame),this._windows.remove(frame.contentWindow),this.emitSync("destroy",{link:app.getLink(),app:app})},ApplicationManager.prototype.activate=function(frame){var app=this._apps.get(frame);return app?(this._currentApp&&this.deactivate(this._currentApp),app.activate(),this._currentApp=frame,!0):!1},Application.prototype.isActive=function(){return this._active},ApplicationManager.prototype.deactivate=function(frame){var app=this._apps.get(frame);return app?(app.deactivate(),!0):!1},ApplicationManager.prototype.getFromFrame=function(frame){return this._apps.get(frame)},ApplicationManager.prototype.getFromWindow=function(window){return this._apps.get(this._windows.get(window))}},{"spotify-eventemitter":128,"spotify-inheritance/inherit":131,"spotify-weakmap":134}],136:[function(require,module,exports){function ApplicationViewLogger(logger,applicationManager){return this instanceof ApplicationViewLogger?(this._logger=logger,this._applicationManager=applicationManager,this._previousEntry=null,this._log=this._log.bind(this),void this.attach()):new ApplicationViewLogger(logger,applicationManager)}exports.ApplicationViewLogger=ApplicationViewLogger,ApplicationViewLogger.prototype._log=function(app){var previousEntry=this._previousEntry,time=(new Date).getTime();if(previousEntry){var duration=time-previousEntry.timestamp;this._logger.log(previousEntry.uri,previousEntry.version,previousEntry.vendor,duration)}this._previousEntry={uri:app.link.toURI(),version:"0.1.0",vendor:"com.spotify",timestamp:time}},ApplicationViewLogger.prototype.attach=function(){this._applicationManager.addListeners({create:this._log,update:this._log})},ApplicationViewLogger.prototype.detach=function(){this._applicationManager.removeListeners({create:this._log,update:this._log})}},{}],137:[function(require,module,exports){(function(global){var Shuttle=require("./shuttle"),Promise=require("spotify-promise"),EventEmitter=require("spotify-eventemitter"),Spotify=global.Spotify||{},Cosmos=require("cosmos-router-js").Cosmos,Bridge=require("spotify-bridge"),Shell=require("spotify-bridge/src/shell"),Responder=require("spotify-bridge/src/bridge/responder"),Reactor=require("spotify-bridge/src/shell/reactor").Reactor,ContextPlayerGroup=require("spotify-contextplayer/playergroup"),CorePlayerManager=require("spotify-contextplayer/adapters/corejs"),Dispatcher=Shell.Dispatcher,ItemListManager=Shell.ItemListManager,TrackListResolver=Shell.TrackListResolver,Spirc=Shell.Spirc,ItemList=Shell.ItemList,Reactors=Shell.Reactors,dispatcher=new Dispatcher.Dispatcher,mediator=new EventEmitter,initpublisher=new EventEmitter;new Reactors.ABTests(mediator,dispatcher),new Reactors.List(mediator,dispatcher),new Reactors.Metadata(mediator,dispatcher),new Reactors.PersistedPlay(mediator,dispatcher),new Reactors.Playlist(mediator,dispatcher),new Reactors.Profile(mediator,dispatcher),new Reactors.Resources(mediator,dispatcher),new Reactors.Search(mediator,dispatcher),new Reactors.Session(mediator,dispatcher),new Reactors.Suggest(mediator,dispatcher),new Reactors.Toplist(mediator,dispatcher);var itemlistManager=new ItemListManager,trackListResolver=new TrackListResolver(dispatcher,itemlistManager),applicationManager=new Shuttle.ApplicationManager(dispatcher),globalApp=applicationManager.createDecoy(Spotify.Link.applicationLink("spotify-web-player"),{}),bridgeEnv=Bridge.setup(applicationManager,dispatcher,globalApp);Shuttle.init=function(core,publisher){var localStorage=window.localStorage;dispatcher.setReady(),dispatcher.create("/resources/core",null,{core:core}),dispatcher.create("/resources/listmanager",null,{listManager:itemlistManager}),dispatcher.create("/resources/tracklistresolver",null,{trackListResolver:trackListResolver}),dispatcher.create("/resources/storage",null,{storage:{get:function(key){var promise=new Promise;return promise.fulfill(localStorage.getItem(key)),promise},set:function(key,value){var promise=new Promise;try{localStorage.setItem(key,value),promise.fulfill(!0)}catch(e){promise.fail(!1)}return promise}}}),window.addEventListener&&window.addEventListener("beforeunload",function(){dispatcher.update("/persistedplay")}),publisher.shouldGetSavedState&&dispatcher.get("/persistedplay");var contextGroup=new ContextPlayerGroup(new CorePlayerManager(core.audioManager),function(id){return new ItemList.Context(new ItemList.Array([]),id)},ItemList.Context.getDescriptorMap.bind(ItemList.Context),{NULL_VALUE:ItemList.NULL_VALUE,LIST_END:ItemList.LIST_END,LIST_START:ItemList.LIST_START});dispatcher.create("/resources/playergroup",null,{playerGroup:contextGroup});var contextListPlayer=contextGroup.create("main"),previewListPlayer=contextGroup.create("preview","previewURI");global.ganon||contextListPlayer.addOnceEvent("trackLoaded",function(){document.body.addClass("started")});var trackRequestSender=dispatcher.createRequestSender("GET","/tracks"),itemLoaderFn=function(uris){return trackRequestSender({flush:!0},{uris:uris}).then(function(response){return response.body.result})};core.features.isEnabled("connect")&&core.user.getUserInfo(function(){new Spirc(core.spirc,contextListPlayer,itemLoaderFn)});var applicationManagerAdapter=(new Shuttle.ApplicationViewLogger(core.logging.view,applicationManager),{onNotify:function(e){var message=e.message;switch(e.messageType){case"APPLICATION_STATE_CHANGED":return applicationManager.create(message.link,message.iframe);case"APPLICATION_DISPOSED":return applicationManager.destroy(message.iframe);case"APPLICATION_ACTIVATED":return applicationManager.activate(message.node);case"APPLICATION_DEACTIVATED":return applicationManager.deactivate(message.node)}}});publisher.publisher.subscribe("APPLICATION_STATE_CHANGED",applicationManagerAdapter),publisher.publisher.subscribe("APPLICATION_DISPOSED",applicationManagerAdapter),publisher.publisher.subscribe("APPLICATION_ACTIVATED",applicationManagerAdapter),publisher.publisher.subscribe("APPLICATION_DEACTIVATED",applicationManagerAdapter);var initContext={core:core,publisher:publisher,applicationManager:applicationManager,bridgeMessageHandler:bridgeEnv.messageHandler,dispatcher:dispatcher,mediator:mediator,contextPlayer:contextListPlayer,previewPlayer:previewListPlayer,listManager:itemlistManager,trackListResolver:trackListResolver,ItemList:ItemList,classes:{Responder:Responder,Reactor:Reactor}};return Cosmos.init(core,initContext),Bridge.init(core,initContext),Shuttle._core=core,Shuttle._initContext=initContext,initpublisher.fireEvent("ready",[core,initContext]),this},Shuttle.onReady=function(fn){Shuttle._core?fn(Shuttle._core,Shuttle._initContext):initpublisher.addEvent("ready",fn)},Spotify.Shuttle=Shuttle}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./shuttle":138,"cosmos-router-js":15,"spotify-bridge":41,"spotify-bridge/src/bridge/responder":46,"spotify-bridge/src/shell":74,"spotify-bridge/src/shell/reactor":94,"spotify-contextplayer/adapters/corejs":120,"spotify-contextplayer/playergroup":125,"spotify-eventemitter":128,"spotify-promise":133}],138:[function(require,module,exports){exports.Application=require("./app-manager").Application,exports.ApplicationManager=require("./app-manager").ApplicationManager,exports.ApplicationViewLogger=require("./app-view-logger").ApplicationViewLogger},{"./app-manager":135,"./app-view-logger":136}]},{},[137]);
